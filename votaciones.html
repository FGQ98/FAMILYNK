<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Votaciones | FAMILYNK</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Nunito:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #E8F0E9;
      --sage-dark: #5C7D5F;
      --cream: #FDF8F3;
      --cream-dark: #F0E6D9;
      --terracotta: #C17757;
      --terracotta-light: #E8D4CC;
      --text-dark: #3D3D3D;
      --text-light: #6B7280;
      --white: #FFFFFF;
      --info: #4299E1;
      --warning: #ECC94B;
      --success: #48BB78;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.08);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text-dark); min-height: 100vh; }
    
    .header { background: var(--white); padding: 16px 20px; border-bottom: 1px solid var(--cream-dark); display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 100; }
    .back-btn { width: 36px; height: 36px; border-radius: var(--radius-md); border: none; background: var(--sage-light); color: var(--sage-dark); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .header-title { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.2rem; color: var(--sage-dark); }
    .header-subtitle { font-size: 0.8rem; color: var(--text-light); }
    
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab { flex: 1; padding: 10px; background: var(--white); border: none; border-radius: var(--radius-md); font-family: inherit; font-weight: 600; cursor: pointer; transition: all 0.2s; color: var(--text-light); }
    .tab.active { background: var(--sage); color: white; }
    
    .card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); margin-bottom: 16px; overflow: hidden; }
    .card-header { padding: 16px; border-bottom: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1rem; color: var(--text-dark); display: flex; align-items: center; gap: 8px; }
    .card-body { padding: 16px; }
    
    .votacion-card { border: 1px solid var(--cream-dark); border-radius: var(--radius-md); margin-bottom: 12px; overflow: hidden; }
    .votacion-card.cerrada { opacity: 0.7; }
    .votacion-header { padding: 12px; background: var(--cream); display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
    .votacion-titulo { font-weight: 700; font-size: 1rem; }
    .votacion-meta { font-size: 0.75rem; color: var(--text-light); margin-top: 4px; }
    .votacion-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; white-space: nowrap; }
    .votacion-badge.activa { background: var(--sage-light); color: var(--sage-dark); }
    .votacion-badge.cerrada { background: var(--cream-dark); color: var(--text-light); }
    .votacion-badge.urgente { background: var(--terracotta-light); color: var(--terracotta); }
    .votacion-body { padding: 12px; }
    
    .opcion { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: var(--radius-sm); margin-bottom: 8px; background: var(--cream); cursor: pointer; transition: all 0.2s; }
    .opcion:hover { background: var(--sage-light); }
    .opcion.selected { background: var(--sage-light); border: 2px solid var(--sage); }
    .opcion.winner { background: var(--sage-light); }
    .opcion-radio { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--cream-dark); display: flex; align-items: center; justify-content: center; }
    .opcion.selected .opcion-radio { border-color: var(--sage); background: var(--sage); }
    .opcion.selected .opcion-radio::after { content: '‚úì'; color: white; font-size: 0.8rem; }
    .opcion-text { flex: 1; font-weight: 500; }
    .opcion-votos { font-size: 0.85rem; color: var(--text-light); display: flex; align-items: center; gap: 4px; }
    .opcion-bar { height: 6px; background: var(--cream-dark); border-radius: 3px; margin-top: 6px; overflow: hidden; }
    .opcion-bar-fill { height: 100%; background: var(--sage); border-radius: 3px; transition: width 0.3s; }
    
    .votos-info { display: flex; justify-content: space-between; padding: 10px 12px; background: var(--cream); border-top: 1px solid var(--cream-dark); font-size: 0.8rem; color: var(--text-light); }
    
    .btn { padding: 12px 20px; border-radius: var(--radius-md); border: none; font-family: 'Nunito', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--sage); color: white; }
    .btn-primary:hover { background: var(--sage-dark); }
    .btn-secondary { background: var(--cream); color: var(--text-dark); }
    .btn-sm { padding: 8px 14px; font-size: 0.85rem; }
    .btn-block { width: 100%; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid var(--cream-dark); border-radius: var(--radius-md); font-family: inherit; font-size: 1rem; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--sage); }
    .form-textarea { resize: vertical; min-height: 80px; }
    
    .opciones-input { margin-bottom: 12px; }
    .opcion-input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .opcion-input-row input { flex: 1; }
    .opcion-remove { width: 40px; background: var(--terracotta-light); color: var(--terracotta); border: none; border-radius: var(--radius-sm); cursor: pointer; }
    
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-light); }
    .empty-state-icon { font-size: 3rem; margin-bottom: 12px; }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--white); border-radius: var(--radius-lg); width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 16px; border-bottom: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-family: 'Quicksand', sans-serif; font-weight: 700; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
    .modal-body { padding: 16px; }
    .modal-footer { padding: 16px; border-top: 1px solid var(--cream-dark); display: flex; gap: 12px; justify-content: flex-end; }
    
    .loading { text-align: center; padding: 40px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--sage); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .checkbox-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
    .checkbox-row input { width: 18px; height: 18px; }
  </style>
</head>
<body>
  <header class="header">
    <button class="back-btn" onclick="history.back()">‚Üê</button>
    <div>
      <h1 class="header-title">üó≥Ô∏è Votaciones</h1>
      <p class="header-subtitle">Decisiones democr√°ticas</p>
    </div>
  </header>

  <div class="container">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="cambiarTab('activas')">üî• Activas</button>
      <button class="tab" onclick="cambiarTab('cerradas')">üìä Cerradas</button>
    </div>

    <!-- Nueva votaci√≥n -->
    <button class="btn btn-primary btn-block" onclick="abrirModalNueva()" style="margin-bottom:16px;">+ Nueva votaci√≥n</button>

    <!-- Lista votaciones -->
    <div id="votaciones-lista">
      <div class="loading"><div class="spinner"></div></div>
    </div>
  </div>

  <!-- Modal Nueva Votaci√≥n -->
  <div class="modal-overlay" id="modal-nueva">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">‚ûï Nueva Votaci√≥n</span>
        <button class="modal-close" onclick="cerrarModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Pregunta</label>
          <input type="text" class="form-input" id="votacion-pregunta" placeholder="¬øQu√© decidimos?">
        </div>
        <div class="form-group">
          <label class="form-label">Descripci√≥n (opcional)</label>
          <textarea class="form-textarea" id="votacion-descripcion" placeholder="M√°s contexto..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Opciones</label>
          <div id="opciones-container">
            <div class="opcion-input-row">
              <input type="text" class="form-input" placeholder="Opci√≥n 1">
            </div>
            <div class="opcion-input-row">
              <input type="text" class="form-input" placeholder="Opci√≥n 2">
            </div>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="agregarOpcion()">+ A√±adir opci√≥n</button>
        </div>
        <div class="form-group">
          <label class="form-label">Cierre autom√°tico</label>
          <select class="form-select" id="votacion-cierre">
            <option value="0">Sin l√≠mite</option>
            <option value="1">En 1 d√≠a</option>
            <option value="3">En 3 d√≠as</option>
            <option value="7" selected>En 1 semana</option>
          </select>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" id="votacion-anonima">
          <label for="votacion-anonima">Votaci√≥n an√≥nima</label>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" id="votacion-multiple">
          <label for="votacion-multiple">Permitir m√∫ltiples opciones</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="crearVotacion()">Crear votaci√≥n</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script>
    let currentUser = null;
    let userData = null;
    let currentRamaId = null;
    let votacionesData = [];
    let miembrosRama = [];
    let tabActual = 'activas';

    auth.onAuthStateChanged(async user => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      const doc = await db.collection('usuarios').doc(user.uid).get();
      if (doc.exists) {
        userData = doc.data();
        currentRamaId = userData.ramaId;
        await cargarMiembros();
        await cargarVotaciones();
      }
    });

    async function cargarMiembros() {
      try {
        const snap = await db.collection('usuarios').where('ramaId', '==', currentRamaId).get();
        miembrosRama = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.error(e); }
    }

    async function cargarVotaciones() {
      try {
        const snap = await db.collection('votaciones')
          .where('ramaId', '==', currentRamaId)
          .orderBy('fechaCreacion', 'desc')
          .get();
        votacionesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Verificar cierres autom√°ticos
        const ahora = new Date();
        for (let v of votacionesData) {
          if (v.estado === 'activa' && v.fechaCierre && v.fechaCierre.toDate() < ahora) {
            await db.collection('votaciones').doc(v.id).update({ estado: 'cerrada' });
            v.estado = 'cerrada';
          }
        }
        
        renderVotaciones();
      } catch (e) {
        console.error(e);
        document.getElementById('votaciones-lista').innerHTML = '<div class="empty-state"><p>Error cargando votaciones</p></div>';
      }
    }

    function cambiarTab(tab) {
      tabActual = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      renderVotaciones();
    }

    function renderVotaciones() {
      const cont = document.getElementById('votaciones-lista');
      const filtradas = votacionesData.filter(v => 
        tabActual === 'activas' ? v.estado === 'activa' : v.estado === 'cerrada'
      );

      if (filtradas.length === 0) {
        cont.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üó≥Ô∏è</div>
            <p>${tabActual === 'activas' ? 'No hay votaciones activas' : 'No hay votaciones cerradas'}</p>
          </div>`;
        return;
      }

      cont.innerHTML = filtradas.map(v => {
        const totalVotos = Object.values(v.votos || {}).flat().length;
        const totalMiembros = miembrosRama.length;
        const yaVote = v.votos && Object.values(v.votos).flat().includes(currentUser.uid);
        const creador = miembrosRama.find(m => m.id === v.creadoPor);
        
        // Calcular votos por opci√≥n
        const votosPorOpcion = {};
        if (v.votos) {
          Object.entries(v.votos).forEach(([opcion, votantes]) => {
            votosPorOpcion[opcion] = votantes.length;
          });
        }
        const maxVotos = Math.max(...Object.values(votosPorOpcion), 1);

        return `
          <div class="votacion-card ${v.estado}">
            <div class="votacion-header">
              <div>
                <div class="votacion-titulo">${v.pregunta}</div>
                <div class="votacion-meta">Por ${creador?.nombre || 'An√≥nimo'} ¬∑ ${v.fechaCreacion?.toDate?.().toLocaleDateString('es') || '-'}</div>
              </div>
              <span class="votacion-badge ${v.estado}">${v.estado === 'activa' ? 'üî• Activa' : 'üìä Cerrada'}</span>
            </div>
            <div class="votacion-body">
              ${v.descripcion ? `<p style="color:var(--text-light);margin-bottom:12px;font-size:0.9rem;">${v.descripcion}</p>` : ''}
              ${v.opciones.map((op, i) => {
                const votos = votosPorOpcion[op] || 0;
                const pct = totalVotos > 0 ? Math.round((votos / totalVotos) * 100) : 0;
                const isWinner = v.estado === 'cerrada' && votos === maxVotos && votos > 0;
                const miVoto = v.votos && v.votos[op]?.includes(currentUser.uid);
                
                if (v.estado === 'activa' && !yaVote) {
                  return `
                    <div class="opcion" onclick="votar('${v.id}', '${op}')">
                      <div class="opcion-radio"></div>
                      <span class="opcion-text">${op}</span>
                    </div>`;
                } else {
                  return `
                    <div class="opcion ${isWinner ? 'winner' : ''} ${miVoto ? 'selected' : ''}" style="cursor:default;">
                      <span class="opcion-text">${op} ${isWinner ? 'üèÜ' : ''}</span>
                      <span class="opcion-votos">${votos} ${v.anonima && v.estado === 'activa' ? '' : `(${pct}%)`}</span>
                    </div>
                    <div class="opcion-bar"><div class="opcion-bar-fill" style="width:${pct}%"></div></div>`;
                }
              }).join('')}
            </div>
            <div class="votos-info">
              <span>${totalVotos} de ${totalMiembros} han votado</span>
              ${v.estado === 'activa' && v.fechaCierre ? `<span>Cierra: ${v.fechaCierre.toDate().toLocaleDateString('es')}</span>` : ''}
              ${v.estado === 'activa' && v.creadoPor === currentUser.uid ? `<button class="btn btn-sm btn-secondary" onclick="cerrarVotacion('${v.id}')">Cerrar</button>` : ''}
            </div>
          </div>`;
      }).join('');
    }

    function abrirModalNueva() {
      document.getElementById('votacion-pregunta').value = '';
      document.getElementById('votacion-descripcion').value = '';
      document.getElementById('votacion-cierre').value = '7';
      document.getElementById('votacion-anonima').checked = false;
      document.getElementById('votacion-multiple').checked = false;
      document.getElementById('opciones-container').innerHTML = `
        <div class="opcion-input-row"><input type="text" class="form-input" placeholder="Opci√≥n 1"></div>
        <div class="opcion-input-row"><input type="text" class="form-input" placeholder="Opci√≥n 2"></div>
      `;
      document.getElementById('modal-nueva').classList.add('active');
    }

    function agregarOpcion() {
      const cont = document.getElementById('opciones-container');
      const num = cont.children.length + 1;
      const row = document.createElement('div');
      row.className = 'opcion-input-row';
      row.innerHTML = `
        <input type="text" class="form-input" placeholder="Opci√≥n ${num}">
        <button class="opcion-remove" onclick="this.parentElement.remove()">‚úï</button>
      `;
      cont.appendChild(row);
    }

    async function crearVotacion() {
      const pregunta = document.getElementById('votacion-pregunta').value.trim();
      if (!pregunta) return alert('Escribe una pregunta');

      const inputs = document.querySelectorAll('#opciones-container input');
      const opciones = Array.from(inputs).map(i => i.value.trim()).filter(o => o);
      if (opciones.length < 2) return alert('Necesitas al menos 2 opciones');

      const diasCierre = parseInt(document.getElementById('votacion-cierre').value);
      let fechaCierre = null;
      if (diasCierre > 0) {
        fechaCierre = new Date();
        fechaCierre.setDate(fechaCierre.getDate() + diasCierre);
      }

      try {
        await db.collection('votaciones').add({
          pregunta,
          descripcion: document.getElementById('votacion-descripcion').value.trim(),
          opciones,
          votos: {},
          estado: 'activa',
          anonima: document.getElementById('votacion-anonima').checked,
          multiple: document.getElementById('votacion-multiple').checked,
          fechaCierre: fechaCierre ? firebase.firestore.Timestamp.fromDate(fechaCierre) : null,
          ramaId: currentRamaId,
          creadoPor: currentUser.uid,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        cerrarModal();
        await cargarVotaciones();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function votar(votacionId, opcion) {
      const v = votacionesData.find(x => x.id === votacionId);
      if (!v || v.estado !== 'activa') return;

      // Verificar si ya vot√≥ (en caso de no ser m√∫ltiple)
      if (!v.multiple) {
        const yaVoto = v.votos && Object.values(v.votos).flat().includes(currentUser.uid);
        if (yaVoto) return alert('Ya has votado');
      }

      try {
        const votos = v.votos || {};
        if (!votos[opcion]) votos[opcion] = [];
        
        // Si m√∫ltiple, toggle; si no, solo a√±adir
        if (v.multiple && votos[opcion].includes(currentUser.uid)) {
          votos[opcion] = votos[opcion].filter(id => id !== currentUser.uid);
        } else {
          votos[opcion].push(currentUser.uid);
        }

        await db.collection('votaciones').doc(votacionId).update({ votos });
        await cargarVotaciones();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function cerrarVotacion(id) {
      if (!confirm('¬øCerrar esta votaci√≥n? No se podr√° reabrir.')) return;
      try {
        await db.collection('votaciones').doc(id).update({ estado: 'cerrada' });
        await cargarVotaciones();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    function cerrarModal() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    }

    document.addEventListener('keydown', e => { if (e.key === 'Escape') cerrarModal(); });
  </script>
</body>
</html>
