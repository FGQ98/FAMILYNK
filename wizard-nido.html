<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Crear tu primer nido</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(135deg, var(--cream) 0%, var(--cream-dark) 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      padding: 20px 24px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .logo {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--sage-dark);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .wizard-container {
      width: 100%;
      max-width: 580px;
    }

    /* Progress */
    .progress-bar {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }

    .progress-step {
      width: 40px;
      height: 6px;
      background: var(--cream-dark);
      border-radius: 3px;
      transition: all 0.3s ease;
    }

    .progress-step.active {
      background: var(--sage);
    }

    .progress-step.completed {
      background: var(--sage-dark);
    }

    /* Card */
    .wizard-card {
      background: var(--white);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-float);
      overflow: hidden;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-header {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      padding: 32px;
      text-align: center;
      color: white;
    }

    .card-header-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .card-header h1 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .card-header p {
      font-size: 0.95rem;
      opacity: 0.9;
      line-height: 1.5;
    }

    .card-body {
      padding: 32px;
    }

    /* Form elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .form-input, .form-select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      transition: all 0.2s;
      background: var(--white);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--sage);
      box-shadow: 0 0 0 3px var(--sage-muted);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 500px) {
      .form-row { grid-template-columns: 1fr; }
    }

    /* Radio options */
    .radio-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .radio-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .radio-option:hover {
      border-color: var(--sage-light);
    }

    .radio-option.selected {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .radio-option input {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      accent-color: var(--sage);
    }

    .radio-option-content {
      flex: 1;
    }

    .radio-option-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .radio-option-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .radio-option-fields {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--cream-dark);
      display: none;
    }

    .radio-option.selected .radio-option-fields {
      display: block;
    }

    /* Hijos list */
    .hijos-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .hijo-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .hijo-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-light) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .hijo-info {
      flex: 1;
    }

    .hijo-nombre {
      font-weight: 600;
    }

    .hijo-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .hijo-badge {
      font-size: 0.7rem;
      padding: 3px 8px;
      background: var(--terracotta-muted);
      color: var(--terracotta);
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    .hijo-delete {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--white);
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .hijo-delete:hover {
      background: var(--error);
      color: white;
    }

    /* Add hijo form */
    .add-hijo-form {
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 16px;
      display: none;
    }

    .add-hijo-form.active {
      display: block;
      animation: slideIn 0.3s ease;
    }

    .add-hijo-form .form-group:last-of-type {
      margin-bottom: 16px;
    }

    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }

    .checkbox-inline input {
      width: 18px;
      height: 18px;
      accent-color: var(--sage);
    }

    .checkbox-inline label {
      font-size: 0.9rem;
      color: var(--text);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-float);
    }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--cream-dark);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--sage);
      color: var(--sage-dark);
    }

    .btn-outline:hover {
      background: var(--sage-muted);
    }

    .btn-sm {
      padding: 10px 16px;
      font-size: 0.9rem;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn-group .btn {
      flex: 1;
    }

    /* Resumen */
    .resumen-section {
      margin-bottom: 20px;
    }

    .resumen-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .resumen-content {
      background: var(--cream);
      border-radius: var(--radius-md);
      padding: 16px;
    }

    .resumen-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }

    .resumen-item:not(:last-child) {
      border-bottom: 1px solid var(--cream-dark);
    }

    .resumen-icon {
      width: 36px;
      height: 36px;
      background: var(--sage-muted);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .resumen-label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .resumen-value {
      font-weight: 600;
    }

    .resumen-badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      margin-left: 8px;
    }

    .resumen-badge.admin {
      background: var(--terracotta-muted);
      color: var(--terracotta);
    }

    .resumen-badge.invitado {
      background: var(--sage-muted);
      color: var(--sage-dark);
    }

    /* Success */
    .success-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      margin: 0 auto 24px;
      animation: bounceIn 0.5s ease;
    }

    @keyframes bounceIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .success-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 12px;
      color: var(--sage-dark);
    }

    .success-text {
      text-align: center;
      color: var(--text-light);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    /* Utilities */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-16 { margin-top: 16px; }
  </style>
</head>
<body>
  <header class="header">
    <a href="index.html" class="logo">
      <div class="logo-icon">ü™∫</div>
      <span>FAMILYNK</span>
    </a>
  </header>

  <main class="main">
    <div class="wizard-container">
      <!-- Progress Bar -->
      <div class="progress-bar">
        <div class="progress-step" id="prog-1"></div>
        <div class="progress-step" id="prog-2"></div>
        <div class="progress-step" id="prog-3"></div>
        <div class="progress-step" id="prog-4"></div>
        <div class="progress-step" id="prog-5"></div>
        <div class="progress-step" id="prog-6"></div>
        <div class="progress-step" id="prog-7"></div>
      </div>

      <!-- PASO 1: Bienvenida -->
      <div class="wizard-card" id="step-1">
        <div class="card-header">
          <div class="card-header-icon">üëã</div>
          <h1>¬°Bienvenido/a a FAMILYNK!</h1>
          <p>Vamos a crear tu primer nido familiar en unos sencillos pasos.</p>
        </div>
        <div class="card-body">
          <div style="text-align: center; margin-bottom: 24px;">
            <p style="color: var(--text-light); line-height: 1.7;">
              Un <strong>nido</strong> es el espacio donde vive tu n√∫cleo familiar: 
              los progenitores y sus hijos. Es el coraz√≥n de tu rama en FAMILYNK.
            </p>
          </div>
          
          <div style="background: var(--sage-muted); border-radius: var(--radius-md); padding: 20px; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 1.5rem;">ü™∫</span>
              <strong>¬øQu√© podr√°s hacer?</strong>
            </div>
            <ul style="list-style: none; color: var(--text-light); font-size: 0.95rem;">
              <li style="padding: 6px 0;">‚úì Organizar a tu familia</li>
              <li style="padding: 6px 0;">‚úì Invitar a tus seres queridos</li>
              <li style="padding: 6px 0;">‚úì Compartir calendarios y tareas</li>
              <li style="padding: 6px 0;">‚úì Construir tu √°rbol geneal√≥gico</li>
            </ul>
          </div>

          <button class="btn btn-primary" style="width: 100%;" onclick="irAPaso(2)">
            Empezar ‚Üí
          </button>
        </div>
      </div>

      <!-- PASO 2: Datos del nido -->
      <div class="wizard-card hidden" id="step-2">
        <div class="card-header">
          <div class="card-header-icon">üè†</div>
          <h1>Datos de tu nido</h1>
          <p>Define c√≥mo se llamar√° tu n√∫cleo familiar</p>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">Nombre del nido *</label>
            <input type="text" class="form-input" id="nido-nombre" placeholder="Ej: Familia Garc√≠a-L√≥pez">
            <div class="form-hint">Normalmente se usa el apellido o apellidos de los progenitores</div>
          </div>

          <div class="form-group">
            <label class="form-label">Generaci√≥n *</label>
            <select class="form-select" id="nido-generacion">
              <option value="1-bisabuelos">Generaci√≥n 1 ‚Äî Bisabuelos</option>
              <option value="2-abuelos">Generaci√≥n 2 ‚Äî Abuelos</option>
              <option value="3-padres" selected>Generaci√≥n 3 ‚Äî Padres</option>
              <option value="4-hijos">Generaci√≥n 4 ‚Äî Hijos</option>
            </select>
            <div class="form-hint">Indica qu√© generaci√≥n representa este nido en tu √°rbol familiar</div>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="irAPaso(1)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" onclick="validarPaso2()">Siguiente ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- PASO 3: Tu perfil -->
      <div class="wizard-card hidden" id="step-3">
        <div class="card-header">
          <div class="card-header-icon">üë§</div>
          <h1>Tu perfil en el nido</h1>
          <p>Ser√°s el administrador de este nido</p>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Iniciales *</label>
              <input type="text" class="form-input" id="perfil-iniciales" placeholder="JG" maxlength="3" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
              <label class="form-label">Fecha de nacimiento</label>
              <input type="date" class="form-input" id="perfil-nacimiento">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Nombre completo *</label>
            <input type="text" class="form-input" id="perfil-nombre" placeholder="Tu nombre completo">
          </div>

          <div style="background: var(--terracotta-muted); border-radius: var(--radius-md); padding: 14px; display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 1.3rem;">üëë</span>
            <div>
              <div style="font-weight: 600; font-size: 0.9rem;">Administrador del nido</div>
              <div style="font-size: 0.8rem; color: var(--text-light);">Podr√°s gestionar miembros y configuraci√≥n</div>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="irAPaso(2)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" onclick="validarPaso3()">Siguiente ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- PASO 4: Pareja -->
      <div class="wizard-card hidden" id="step-4">
        <div class="card-header">
          <div class="card-header-icon">üíë</div>
          <h1>¬øA√±adir pareja?</h1>
          <p>Puedes invitar a tu pareja ahora o hacerlo despu√©s</p>
        </div>
        <div class="card-body">
          <div class="radio-options">
            <label class="radio-option" id="opt-pareja-no">
              <input type="radio" name="pareja" value="no" checked onchange="toggleParejaForm(false)">
              <div class="radio-option-content">
                <div class="radio-option-title">No, lo har√© despu√©s</div>
                <div class="radio-option-desc">Podr√°s a√±adir a tu pareja en cualquier momento</div>
              </div>
            </label>

            <label class="radio-option" id="opt-pareja-si">
              <input type="radio" name="pareja" value="si" onchange="toggleParejaForm(true)">
              <div class="radio-option-content">
                <div class="radio-option-title">S√≠, a√±adir ahora</div>
                <div class="radio-option-desc">Le enviaremos una invitaci√≥n por email</div>
                <div class="radio-option-fields" id="pareja-fields">
                  <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-input" id="pareja-nombre" placeholder="Nombre de tu pareja">
                  </div>
                  <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="pareja-email" placeholder="email@ejemplo.com">
                  </div>
                </div>
              </div>
            </label>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="irAPaso(3)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" onclick="validarPaso4()">Siguiente ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- PASO 5: Hijos -->
      <div class="wizard-card hidden" id="step-5">
        <div class="card-header">
          <div class="card-header-icon">üë∂</div>
          <h1>¬øA√±adir hijos?</h1>
          <p>Puedes registrar a tus hijos ahora o hacerlo despu√©s</p>
        </div>
        <div class="card-body">
          <!-- Lista de hijos a√±adidos -->
          <div class="hijos-list" id="hijos-list"></div>

          <!-- Formulario para a√±adir hijo -->
          <div class="add-hijo-form" id="add-hijo-form">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nombre *</label>
                <input type="text" class="form-input" id="hijo-nombre" placeholder="Nombre">
              </div>
              <div class="form-group">
                <label class="form-label">Fecha nacimiento</label>
                <input type="date" class="form-input" id="hijo-nacimiento">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Email (si es mayor)</label>
              <input type="email" class="form-input" id="hijo-email" placeholder="email@ejemplo.com">
              <div class="form-hint">D√©jalo vac√≠o si es menor y no tiene email</div>
            </div>
            <div class="checkbox-inline">
              <input type="checkbox" id="hijo-crea-nido">
              <label for="hijo-crea-nido">Crea su propio nido (si ya tiene pareja/familia)</label>
            </div>
            <div class="btn-group" style="margin-top: 16px;">
              <button class="btn btn-secondary btn-sm" onclick="cancelarHijo()">Cancelar</button>
              <button class="btn btn-primary btn-sm" onclick="guardarHijo()">A√±adir hijo/a</button>
            </div>
          </div>

          <!-- Bot√≥n para mostrar formulario -->
          <button class="btn btn-outline" style="width: 100%;" id="btn-add-hijo" onclick="mostrarFormHijo()">
            + A√±adir hijo/a
          </button>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="irAPaso(4)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" onclick="irAPaso(6)">Siguiente ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- PASO 6: Confirmaci√≥n -->
      <div class="wizard-card hidden" id="step-6">
        <div class="card-header">
          <div class="card-header-icon">üìã</div>
          <h1>Confirma tu nido</h1>
          <p>Revisa que todo est√© correcto</p>
        </div>
        <div class="card-body">
          <!-- Resumen nido -->
          <div class="resumen-section">
            <div class="resumen-title">Tu nido</div>
            <div class="resumen-content">
              <div class="resumen-item">
                <div class="resumen-icon">ü™∫</div>
                <div>
                  <div class="resumen-label">Nombre</div>
                  <div class="resumen-value" id="resumen-nido-nombre">‚Äî</div>
                </div>
              </div>
              <div class="resumen-item">
                <div class="resumen-icon">üå≥</div>
                <div>
                  <div class="resumen-label">Generaci√≥n</div>
                  <div class="resumen-value" id="resumen-nido-gen">‚Äî</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Resumen miembros -->
          <div class="resumen-section">
            <div class="resumen-title">Miembros</div>
            <div class="resumen-content" id="resumen-miembros">
              <!-- Se llena din√°micamente -->
            </div>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="irAPaso(5)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" id="btn-crear" onclick="crearNido()">
              ü™∫ Crear mi nido
            </button>
          </div>
        </div>
      </div>

      <!-- PASO 7: √âxito -->
      <div class="wizard-card hidden" id="step-7">
        <div class="card-body" style="padding: 48px 32px;">
          <div class="success-icon">ü™∫</div>
          <h2 class="success-title">¬°Tu nido est√° listo!</h2>
          <p class="success-text">
            Has creado tu primer nido familiar.<br>
            Ya puedes empezar a organizar tu familia en FAMILYNK.
          </p>
          
          <div id="invitaciones-enviadas" class="hidden" style="background: var(--sage-muted); border-radius: var(--radius-md); padding: 16px; margin-bottom: 24px; text-align: center;">
            <span style="font-size: 1.2rem;">üìß</span>
            <div style="margin-top: 8px; font-size: 0.9rem; color: var(--text-light);">
              Se han enviado invitaciones a los miembros con email
            </div>
          </div>

          <button class="btn btn-primary" style="width: 100%;" onclick="window.location.href='mi-nido.html'">
            Ir a mi nido ‚Üí
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ============================================
    // ESTADO
    // ============================================
    let currentUser = null;
    let userData = null;
    let currentStep = 1;

    // Datos del wizard
    const wizardData = {
      nido: {
        nombre: '',
        generacion: '3-padres'
      },
      fundador: {
        iniciales: '',
        nombre: '',
        fechaNacimiento: null
      },
      pareja: null,
      hijos: []
    };

    // ============================================
    // AUTH
    // ============================================
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;

      // Cargar datos del usuario
      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists) {
        window.location.href = 'login.html';
        return;
      }
      userData = userDoc.data();

      // Si ya tiene nido, redirigir
      if (userData.nidoId) {
        window.location.href = 'mi-nido.html';
        return;
      }

      // Prellenar datos del perfil
      document.getElementById('perfil-nombre').value = userData.nombreCompleto || `${userData.nombre || ''} ${userData.apellidos || ''}`.trim();
      
      // Generar iniciales autom√°ticas
      const nombre = userData.nombre || '';
      const apellidos = userData.apellidos || '';
      let iniciales = '';
      if (nombre) iniciales += nombre.charAt(0).toUpperCase();
      if (apellidos) iniciales += apellidos.charAt(0).toUpperCase();
      document.getElementById('perfil-iniciales').value = iniciales;

      // Iniciar wizard
      irAPaso(1);
    });

    // ============================================
    // NAVEGACI√ìN
    // ============================================
    function irAPaso(paso) {
      // Ocultar todos los pasos
      for (let i = 1; i <= 7; i++) {
        document.getElementById(`step-${i}`).classList.add('hidden');
        document.getElementById(`prog-${i}`).classList.remove('active', 'completed');
      }

      // Mostrar paso actual
      document.getElementById(`step-${paso}`).classList.remove('hidden');
      
      // Actualizar progress bar
      for (let i = 1; i <= 7; i++) {
        if (i < paso) {
          document.getElementById(`prog-${i}`).classList.add('completed');
        } else if (i === paso) {
          document.getElementById(`prog-${i}`).classList.add('active');
        }
      }

      currentStep = paso;

      // Si es el paso 6, actualizar resumen
      if (paso === 6) {
        actualizarResumen();
      }

      // Scroll arriba
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ============================================
    // VALIDACIONES
    // ============================================
    function validarPaso2() {
      const nombre = document.getElementById('nido-nombre').value.trim();
      const generacion = document.getElementById('nido-generacion').value;

      if (!nombre) {
        alert('Por favor, introduce un nombre para tu nido');
        document.getElementById('nido-nombre').focus();
        return;
      }

      wizardData.nido.nombre = nombre;
      wizardData.nido.generacion = generacion;

      irAPaso(3);
    }

    function validarPaso3() {
      const iniciales = document.getElementById('perfil-iniciales').value.trim().toUpperCase();
      const nombre = document.getElementById('perfil-nombre').value.trim();
      const nacimiento = document.getElementById('perfil-nacimiento').value;

      if (!iniciales) {
        alert('Por favor, introduce tus iniciales');
        document.getElementById('perfil-iniciales').focus();
        return;
      }

      if (!nombre) {
        alert('Por favor, introduce tu nombre');
        document.getElementById('perfil-nombre').focus();
        return;
      }

      wizardData.fundador.iniciales = iniciales;
      wizardData.fundador.nombre = nombre;
      wizardData.fundador.fechaNacimiento = nacimiento || null;

      irAPaso(4);
    }

    function validarPaso4() {
      const tienePareja = document.querySelector('input[name="pareja"]:checked').value === 'si';

      if (tienePareja) {
        const nombre = document.getElementById('pareja-nombre').value.trim();
        const email = document.getElementById('pareja-email').value.trim().toLowerCase();

        if (!nombre) {
          alert('Por favor, introduce el nombre de tu pareja');
          document.getElementById('pareja-nombre').focus();
          return;
        }

        wizardData.pareja = {
          nombre: nombre,
          email: email || null,
          iniciales: generarIniciales(nombre)
        };
      } else {
        wizardData.pareja = null;
      }

      irAPaso(5);
    }

    // ============================================
    // PAREJA
    // ============================================
    function toggleParejaForm(mostrar) {
      document.getElementById('opt-pareja-no').classList.toggle('selected', !mostrar);
      document.getElementById('opt-pareja-si').classList.toggle('selected', mostrar);
      
      if (mostrar) {
        setTimeout(() => document.getElementById('pareja-nombre').focus(), 100);
      }
    }

    // ============================================
    // HIJOS
    // ============================================
    function mostrarFormHijo() {
      document.getElementById('add-hijo-form').classList.add('active');
      document.getElementById('btn-add-hijo').classList.add('hidden');
      document.getElementById('hijo-nombre').focus();
    }

    function cancelarHijo() {
      document.getElementById('add-hijo-form').classList.remove('active');
      document.getElementById('btn-add-hijo').classList.remove('hidden');
      limpiarFormHijo();
    }

    function limpiarFormHijo() {
      document.getElementById('hijo-nombre').value = '';
      document.getElementById('hijo-nacimiento').value = '';
      document.getElementById('hijo-email').value = '';
      document.getElementById('hijo-crea-nido').checked = false;
    }

    function guardarHijo() {
      const nombre = document.getElementById('hijo-nombre').value.trim();
      const nacimiento = document.getElementById('hijo-nacimiento').value;
      const email = document.getElementById('hijo-email').value.trim().toLowerCase();
      const creaNido = document.getElementById('hijo-crea-nido').checked;

      if (!nombre) {
        alert('Por favor, introduce el nombre');
        document.getElementById('hijo-nombre').focus();
        return;
      }

      wizardData.hijos.push({
        nombre: nombre,
        iniciales: generarIniciales(nombre),
        fechaNacimiento: nacimiento || null,
        email: email || null,
        creaNido: creaNido
      });

      renderHijos();
      cancelarHijo();
    }

    function eliminarHijo(index) {
      wizardData.hijos.splice(index, 1);
      renderHijos();
    }

    function renderHijos() {
      const container = document.getElementById('hijos-list');
      
      if (wizardData.hijos.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = wizardData.hijos.map((hijo, index) => {
        const edad = hijo.fechaNacimiento ? calcularEdad(hijo.fechaNacimiento) : null;
        return `
          <div class="hijo-card">
            <div class="hijo-avatar">${hijo.iniciales}</div>
            <div class="hijo-info">
              <div class="hijo-nombre">${hijo.nombre}</div>
              <div class="hijo-meta">
                ${edad !== null ? `${edad} a√±os` : 'Sin fecha'}
                ${hijo.email ? ` ¬∑ ${hijo.email}` : ''}
              </div>
            </div>
            ${hijo.creaNido ? '<span class="hijo-badge">Crea nido</span>' : ''}
            <button class="hijo-delete" onclick="eliminarHijo(${index})">‚úï</button>
          </div>
        `;
      }).join('');
    }

    // ============================================
    // RESUMEN
    // ============================================
    function actualizarResumen() {
      const genLabels = {
        '1-bisabuelos': 'Generaci√≥n 1 ‚Äî Bisabuelos',
        '2-abuelos': 'Generaci√≥n 2 ‚Äî Abuelos',
        '3-padres': 'Generaci√≥n 3 ‚Äî Padres',
        '4-hijos': 'Generaci√≥n 4 ‚Äî Hijos'
      };

      document.getElementById('resumen-nido-nombre').textContent = wizardData.nido.nombre;
      document.getElementById('resumen-nido-gen').textContent = genLabels[wizardData.nido.generacion];

      // Miembros
      let miembrosHTML = '';

      // Fundador
      miembrosHTML += `
        <div class="resumen-item">
          <div class="resumen-icon">üë§</div>
          <div style="flex:1;">
            <div class="resumen-value">${wizardData.fundador.nombre}</div>
            <div class="resumen-label">T√∫ ¬∑ Progenitor</div>
          </div>
          <span class="resumen-badge admin">Admin</span>
        </div>
      `;

      // Pareja
      if (wizardData.pareja) {
        miembrosHTML += `
          <div class="resumen-item">
            <div class="resumen-icon">üíë</div>
            <div style="flex:1;">
              <div class="resumen-value">${wizardData.pareja.nombre}</div>
              <div class="resumen-label">Pareja ¬∑ Progenitor</div>
            </div>
            ${wizardData.pareja.email ? '<span class="resumen-badge invitado">Invitaci√≥n</span>' : ''}
          </div>
        `;
      }

      // Hijos
      wizardData.hijos.forEach(hijo => {
        miembrosHTML += `
          <div class="resumen-item">
            <div class="resumen-icon">üë∂</div>
            <div style="flex:1;">
              <div class="resumen-value">${hijo.nombre}</div>
              <div class="resumen-label">Hijo/a${hijo.creaNido ? ' ¬∑ Crea nido propio' : ''}</div>
            </div>
            ${hijo.email ? '<span class="resumen-badge invitado">Invitaci√≥n</span>' : ''}
          </div>
        `;
      });

      document.getElementById('resumen-miembros').innerHTML = miembrosHTML;
    }

    // ============================================
    // CREAR NIDO
    // ============================================
    async function crearNido() {
      const btn = document.getElementById('btn-crear');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Creando...';

      try {
        // 1. Construir array de miembros
        const miembrosData = [];
        let hayInvitaciones = false;

        // Fundador
        miembrosData.push({
          iniciales: wizardData.fundador.iniciales,
          nombre: wizardData.fundador.nombre,
          fechaNacimiento: wizardData.fundador.fechaNacimiento,
          email: currentUser.email,
          uid: currentUser.uid,
          relacion: 'progenitor',
          esAdmin: true,
          estadoCuenta: 'validado',
          fechaValidacion: new Date().toISOString()
        });

        // Pareja
        if (wizardData.pareja) {
          miembrosData.push({
            iniciales: wizardData.pareja.iniciales,
            nombre: wizardData.pareja.nombre,
            fechaNacimiento: null,
            email: wizardData.pareja.email,
            uid: null,
            relacion: 'progenitor',
            esAdmin: false,
            estadoCuenta: wizardData.pareja.email ? 'invitado' : 'validado',
            fechaInvitacion: wizardData.pareja.email ? new Date().toISOString() : null
          });
          if (wizardData.pareja.email) hayInvitaciones = true;
        }

        // Hijos
        for (const hijo of wizardData.hijos) {
          miembrosData.push({
            iniciales: hijo.iniciales,
            nombre: hijo.nombre,
            fechaNacimiento: hijo.fechaNacimiento,
            email: hijo.email,
            uid: null,
            relacion: 'descendiente',
            esAdmin: false,
            estadoCuenta: hijo.email ? 'invitado' : 'validado',
            fechaInvitacion: hijo.email ? new Date().toISOString() : null,
            creaNido: hijo.creaNido || false
          });
          if (hijo.email) hayInvitaciones = true;
        }

        // 2. Crear el nido
        const nidoRef = await db.collection('nidos').add({
          nombre: wizardData.nido.nombre,
          generacion: wizardData.nido.generacion,
          familiaId: userData.familiaId,
          creador: currentUser.uid,
          admins: [currentUser.uid],
          miembrosData: miembrosData,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
          seccionesActivas: {
            calendario: true,
            tareas: true,
            mensajes: true,
            tablon: true,
            menus: true,
            tienda: true
          }
        });

        const nidoId = nidoRef.id;

        // 3. Actualizar usuario con nidoId
        await db.collection('usuarios').doc(currentUser.uid).update({
          nidoId: nidoId,
          nidosAdmin: firebase.firestore.FieldValue.arrayUnion(nidoId)
        });

        // 4. Crear nidos para hijos que "crean su propio nido"
        for (const hijo of wizardData.hijos) {
          if (hijo.creaNido) {
            await db.collection('nidos').add({
              nombre: `Nido de ${hijo.nombre}`,
              generacion: siguienteGeneracion(wizardData.nido.generacion),
              familiaId: userData.familiaId,
              nidoPadreId: nidoId,
              creador: currentUser.uid,
              admins: [],
              miembrosData: [{
                iniciales: hijo.iniciales,
                nombre: hijo.nombre,
                fechaNacimiento: hijo.fechaNacimiento,
                email: hijo.email,
                uid: null,
                relacion: 'progenitor',
                esAdmin: true,
                estadoCuenta: hijo.email ? 'invitado' : 'validado'
              }],
              fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }

        // 5. Crear invitaciones pendientes
        if (wizardData.pareja && wizardData.pareja.email) {
          await db.collection('invitaciones').add({
            email: wizardData.pareja.email,
            nombre: wizardData.pareja.nombre,
            familiaId: userData.familiaId,
            nidoId: nidoId,
            rol: 'progenitor',
            invitadoPor: currentUser.uid,
            invitadoPorNombre: wizardData.fundador.nombre,
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            estado: 'pendiente'
          });
        }

        for (const hijo of wizardData.hijos) {
          if (hijo.email) {
            await db.collection('invitaciones').add({
              email: hijo.email,
              nombre: hijo.nombre,
              familiaId: userData.familiaId,
              nidoId: nidoId,
              rol: 'descendiente',
              invitadoPor: currentUser.uid,
              invitadoPorNombre: wizardData.fundador.nombre,
              fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
              estado: 'pendiente'
            });
          }
        }

        // Mostrar √©xito
        if (hayInvitaciones) {
          document.getElementById('invitaciones-enviadas').classList.remove('hidden');
        }
        irAPaso(7);

      } catch (error) {
        console.error('Error creando nido:', error);
        alert('Error al crear el nido: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = 'ü™∫ Crear mi nido';
      }
    }

    // ============================================
    // UTILIDADES
    // ============================================
    function generarIniciales(nombre) {
      const partes = nombre.trim().split(' ').filter(p => p.length > 0);
      if (partes.length === 0) return '??';
      if (partes.length === 1) return partes[0].substring(0, 2).toUpperCase();
      return (partes[0].charAt(0) + partes[partes.length - 1].charAt(0)).toUpperCase();
    }

    function calcularEdad(fecha) {
      if (!fecha) return null;
      const hoy = new Date();
      const nac = new Date(fecha);
      let edad = hoy.getFullYear() - nac.getFullYear();
      const m = hoy.getMonth() - nac.getMonth();
      if (m < 0 || (m === 0 && hoy.getDate() < nac.getDate())) edad--;
      return edad;
    }

    function siguienteGeneracion(gen) {
      const orden = ['1-bisabuelos', '2-abuelos', '3-padres', '4-hijos'];
      const idx = orden.indexOf(gen);
      if (idx === -1 || idx === orden.length - 1) return '4-hijos';
      return orden[idx + 1];
    }

    // Inicializar radio options
    document.querySelectorAll('.radio-option').forEach(opt => {
      opt.addEventListener('click', () => {
        opt.querySelector('input').checked = true;
      });
    });
  </script>
</body>
</html>
