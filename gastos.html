<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Gastos</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E; --cream: #FDF8F3; --cream-dark: #F5EDE4; --cream-medium: #FAF5EF;
      --terracotta: #C17757; --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A; --white: #FFFFFF;
      --mayordomo: #8B7355; --mayordomo-light: #A69076; --mayordomo-dark: #6B5A42; --mayordomo-muted: rgba(139,115,85,0.15);
      --addon-color: var(--mayordomo); --addon-light: var(--mayordomo-light);
      --addon-dark: var(--mayordomo-dark); --addon-muted: var(--mayordomo-muted);
      --success: #7DB59A; --success-muted: rgba(125,181,154,0.15);
      --warning: #E8B44D; --warning-muted: rgba(232,180,77,0.15);
      --error: #D4695A; --error-muted: rgba(212,105,90,0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06); --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-full: 50px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header {
      background: linear-gradient(135deg, var(--addon-color) 0%, var(--addon-dark) 100%);
      padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-medium); position: sticky; top: 0; z-index: 100;
    }
    .header a, .header span { color: white; text-decoration: none; font-family: 'Quicksand'; font-weight: 600; font-size: 0.9rem; }
    .header-title { font-family: 'Quicksand'; font-weight: 700; font-size: 1.1rem; color: white; }
    .header-bien { font-size: 0.8rem; color: rgba(255,255,255,0.75); }

    .container { max-width: 900px; margin: 0 auto; padding: 20px; }

    /* Summary cards */
    .summary-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
    .summary-card { background: var(--white); border-radius: var(--radius-md); padding: 16px; text-align: center; box-shadow: var(--shadow-soft); }
    .summary-num { font-family: 'Quicksand'; font-weight: 700; font-size: 1.5rem; color: var(--addon-color); }
    .summary-label { font-size: 0.78rem; color: var(--text-muted); }

    /* Filtros */
    .filtros { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; align-items: center; }
    .filtros select { flex: 1; min-width: 120px; font-size: 0.82rem; padding: 8px 10px; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm); background: var(--white); font-family: 'Nunito'; }

    /* Lista */
    .lista-gastos { display: flex; flex-direction: column; gap: 2px; }
    .gasto-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 14px;
      background: var(--white); border-radius: var(--radius-sm); cursor: pointer;
      border-left: 3px solid var(--terracotta); transition: transform 0.15s;
    }
    .gasto-item:hover { transform: translateX(4px); }
    .gasto-fecha { font-size: 0.75rem; color: var(--text-muted); min-width: 70px; font-family: 'Quicksand'; font-weight: 600; }
    .gasto-concepto { flex: 1; font-size: 0.88rem; }
    .gasto-detalle { font-size: 0.7rem; color: var(--text-muted); }
    .gasto-importe { font-family: 'Quicksand'; font-weight: 700; font-size: 0.92rem; white-space: nowrap; }
    .gasto-mes-header {
      display: flex; justify-content: space-between; padding: 8px 12px;
      background: var(--cream-medium); border-radius: var(--radius-sm); margin-bottom: 6px;
    }
    .gasto-mes-header span { font-weight: 700; font-size: 0.88rem; }
    .total-bar {
      display: flex; justify-content: space-between; padding: 12px;
      background: var(--addon-color); color: white; border-radius: var(--radius-sm); font-weight: 700;
      margin-top: 12px;
    }

    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state div:first-child { font-size: 2.5rem; margin-bottom: 8px; }

    /* FAB */
    .fab {
      position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px;
      background: var(--addon-color); color: white; border: none; border-radius: 50%;
      font-size: 1.8rem; cursor: pointer; box-shadow: var(--shadow-medium);
      display: flex; align-items: center; justify-content: center; z-index: 90;
    }
    .fab:hover { background: var(--addon-dark); transform: scale(1.05); }

    /* Modal */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 200; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--white); border-radius: var(--radius-lg); width: 100%; max-width: 520px;
      max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 16px 48px rgba(0,0,0,0.15);
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 20px; border-bottom: 1px solid var(--cream-dark);
    }
    .modal-title { font-family: 'Quicksand'; font-weight: 700; font-size: 1rem; }
    .modal-close { background: none; border: none; font-size: 1.3rem; cursor: pointer; color: var(--text-muted); padding: 4px; }
    .modal-body { padding: 20px; overflow-y: auto; }
    .modal-footer { padding: 12px 20px; border-top: 1px solid var(--cream-dark); display: flex; justify-content: flex-end; gap: 8px; }

    .form-group { margin-bottom: 14px; }
    .form-label { display: block; font-size: 0.82rem; font-weight: 600; margin-bottom: 4px; color: var(--text-light); }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 10px 12px; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm);
      font-family: 'Nunito'; font-size: 0.9rem; background: var(--cream-medium);
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--addon-color); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .subgrupo-input-wrap { display: flex; align-items: center; gap: 8px; }
    .subgrupo-input-wrap .form-group { flex: 1; margin-bottom: 0; }
    .subgrupo-toggle { font-size: 0.78rem; color: var(--addon-color); cursor: pointer; white-space: nowrap; font-weight: 600; }

    .btn { padding: 10px 20px; border: none; border-radius: var(--radius-sm); font-family: 'Nunito'; font-weight: 600; font-size: 0.88rem; cursor: pointer; }
    .btn-addon { background: var(--addon-color); color: white; }
    .btn-addon:hover { background: var(--addon-dark); }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-danger { background: var(--error); color: white; font-size: 0.8rem; padding: 8px 14px; }

    @media (max-width: 600px) {
      .summary-row { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .filtros { flex-direction: column; }
    }

    .btn-pdf {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 14px; background: white; color: #5C7D5F;
      border: 2px solid #7A9E7E; border-radius: 8px;
      font-family: 'Nunito', sans-serif; font-size: 0.82rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; text-decoration: none;
    }
    .btn-pdf:hover { background: #7A9E7E; color: white; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <a id="btn-volver" href="#">‚Üê Volver</a>
    <div style="text-align:center;">
      <div class="header-title">üí∂ Gastos</div>
      <div class="header-bien" id="bien-nombre">Cargando...</div>
    </div>
    <button class="btn-pdf" onclick="generarPDF()">üìÑ PDF</button>
  </div>

  <div class="container">
    <!-- Summary -->
    <div class="summary-row" id="summary-row">
      <div class="summary-card"><div class="summary-num" id="sum-total">‚Äî</div><div class="summary-label">Total gastado</div></div>
      <div class="summary-card"><div class="summary-num" id="sum-count">‚Äî</div><div class="summary-label">Registros</div></div>
      <div class="summary-card"><div class="summary-num" id="sum-media">‚Äî</div><div class="summary-label">Media / gasto</div></div>
    </div>

    <!-- Filtros -->
    <div class="filtros">
      <select id="filtro-cat" onchange="renderLista()">
        <option value="">üìÅ Todas las categor√≠as</option>
      </select>
      <select id="filtro-medio" onchange="renderLista()">
        <option value="">üí≥ Todos los medios</option>
        <option value="efectivo">üíµ Efectivo</option>
        <option value="transferencia">üè¶ Transferencia</option>
        <option value="tarjeta">üí≥ Tarjeta</option>
        <option value="domiciliacion">üìã Domiciliaci√≥n</option>
      </select>
      <select id="filtro-anotador" onchange="renderLista()">
        <option value="">üë§ Todos los que apuntan</option>
      </select>
    </div>

    <!-- Lista -->
    <div class="lista-gastos" id="lista-gastos"></div>
    <div class="empty-state" id="empty-state" style="display:none;">
      <div>üí∂</div>
      <div style="font-weight:600;">Sin gastos registrados</div>
      <div style="font-size:0.85rem;">Pulsa + para a√±adir el primer gasto</div>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" onclick="abrirModal()">+</button>

  <!-- Modal -->
  <div class="modal-overlay" id="modal-gasto">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="modal-title">üí∂ Nuevo gasto</span>
        <button class="modal-close" onclick="cerrarModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Fecha *</label><input type="date" class="form-input" id="g-fecha"></div>
        <div class="form-group"><label class="form-label">Concepto *</label><input type="text" class="form-input" id="g-concepto" placeholder="Ej: Factura de luz, Reparaci√≥n puerta..."></div>
        <div class="form-group">
          <label class="form-label">Categor√≠a *</label>
          <select class="form-select" id="g-categoria">
            <option value="">‚Äî Selecciona ‚Äî</option>
            <option value="suministros">üí° Suministros (luz, agua, gas)</option>
            <option value="limpieza">üßπ Limpieza</option>
            <option value="mantenimiento">üîß Mantenimiento</option>
            <option value="alimentacion">üõí Alimentaci√≥n</option>
            <option value="seguros">üõ°Ô∏è Seguros</option>
            <option value="personal">üë∑ Personal</option>
            <option value="jardineria">üåø Jardiner√≠a</option>
            <option value="comunidad">üè¢ Comunidad</option>
            <option value="impuestos">üìã Impuestos / tasas</option>
            <option value="otros">üì¶ Otros</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Importe (‚Ç¨) *</label><input type="number" class="form-input" id="g-importe" min="0" step="0.01" placeholder="0.00"></div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Medio de pago</label>
            <select class="form-select" id="g-medio">
              <option value="">‚Äî Sin especificar ‚Äî</option>
              <option value="efectivo">üíµ Efectivo</option>
              <option value="transferencia">üè¶ Transferencia</option>
              <option value="tarjeta">üí≥ Tarjeta</option>
              <option value="domiciliacion">üìã Domiciliaci√≥n</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Cuenta</label>
            <div class="subgrupo-input-wrap">
              <div class="form-group">
                <select class="form-select" id="g-cuenta">
                  <option value="">‚Äî Sin especificar ‚Äî</option>
                </select>
              </div>
              <span class="subgrupo-toggle" onclick="toggleNuevaCuenta()">+ Nueva</span>
            </div>
            <input type="text" class="form-input" id="g-cuenta-new" placeholder="Ej: CaixaBank, Caja chica..." style="display:none;margin-top:6px;">
          </div>
        </div>
        <div class="form-group"><label class="form-label">Nota</label><textarea class="form-textarea" id="g-notas" rows="2" placeholder="Observaciones..."></textarea></div>
        <div class="form-group">
          <label class="form-label">Qui√©n anota</label>
          <div class="subgrupo-input-wrap">
            <div class="form-group">
              <select class="form-select" id="g-anotador">
                <option value="">‚Äî Yo mismo ‚Äî</option>
              </select>
            </div>
            <span class="subgrupo-toggle" onclick="toggleNuevoAnotador()">+ Otro</span>
          </div>
          <input type="text" class="form-input" id="g-anotador-new" placeholder="Ej: Casero, Guarda..." style="display:none;margin-top:6px;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
        <button class="btn btn-danger" id="btn-eliminar" onclick="eliminarGasto()" style="display:none;">Eliminar</button>
        <button class="btn btn-addon" onclick="guardarGasto()">Guardar</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script>
    let bienId = null, bienData = null, currentUser = null;
    let gastos = [];
    let externosNombres = [];
    let editandoId = null;

    const CAT_LABELS = {
      suministros: 'üí° Suministros', limpieza: 'üßπ Limpieza', mantenimiento: 'üîß Mantenimiento',
      alimentacion: 'üõí Alimentaci√≥n', seguros: 'üõ°Ô∏è Seguros', personal: 'üë∑ Personal',
      jardineria: 'üåø Jardiner√≠a', comunidad: 'üè¢ Comunidad', impuestos: 'üìã Impuestos',
      otros: 'üì¶ Otros'
    };
    const MEDIO_ICONS = { efectivo: 'üíµ', transferencia: 'üè¶', tarjeta: 'üí≥', domiciliacion: 'üìã' };

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');
      if (!bienId) { alert('No se ha especificado el bien'); window.location.href = 'lo-comun.html'; return; }

      document.getElementById('btn-volver').href = `bien.html?id=${bienId}`;

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await cargarBien();
          await cargarExternos();
          await cargarGastos();
          renderLista();
        } else {
          window.location.href = 'login.html';
        }
      });
    });

    // ===== CARGAR DATOS =====
    async function cargarBien() {
      const doc = await db.collection('bienes').doc(bienId).get();
      if (!doc.exists) { alert('Bien no encontrado'); return; }
      bienData = doc.data();
      document.getElementById('bien-nombre').textContent = bienData.nombre || '';

      // Cargar cuentas
      const sel = document.getElementById('g-cuenta');
      sel.innerHTML = '<option value="">‚Äî Sin especificar ‚Äî</option>';
      (bienData.cuentas || []).forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });
    }

    async function cargarExternos() {
      externosNombres = [];
      console.log('[DEBUG] cargarExternos: bienId=', bienId);
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('externos').get();
        console.log('[DEBUG] externos encontrados:', snap.size);
        const rolIcons = { casero: 'üè†', hoster: 'üè®', guarda: 'üåæ', oficina: 'üè¢', otro: 'üë§' };
        snap.docs.forEach(d => {
          const data = d.data();
          console.log('[DEBUG] externo:', d.id, data.nombre, 'activo:', data.activo, 'rol:', data.rol);
          if (data.activo === false) return;
          const nombre = data.nombre || data.email || '';
          const rol = data.rol || 'otro';
          if (nombre) externosNombres.push({ nombre, rol: `${rolIcons[rol] || 'üë§'} ${rol.charAt(0).toUpperCase() + rol.slice(1)}`, email: data.email || '' });
        });
        console.log('[DEBUG] externosNombres final:', externosNombres.length, externosNombres);
      } catch(e) { console.warn('[DEBUG] ERROR cargarExternos:', e); }
    }

    async function cargarGastos() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('gastos').orderBy('fecha', 'desc').get();
        gastos = snap.docs.map(d => {
          const data = d.data();
          let fecha = data.fecha;
          if (fecha?.toDate) fecha = fecha.toDate().toISOString().split('T')[0];
          else if (fecha instanceof Date) fecha = fecha.toISOString().split('T')[0];
          return { id: d.id, ...data, fecha };
        });
      } catch(e) {
        console.error('Error cargando gastos:', e);
        // Fallback: sin orderBy (puede faltar √≠ndice)
        try {
          const snap = await db.collection('bienes').doc(bienId).collection('gastos').get();
          gastos = snap.docs.map(d => {
            const data = d.data();
            let fecha = data.fecha;
            if (fecha?.toDate) fecha = fecha.toDate().toISOString().split('T')[0];
            else if (fecha instanceof Date) fecha = fecha.toISOString().split('T')[0];
            return { id: d.id, ...data, fecha };
          }).sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));
        } catch(e2) { console.error(e2); gastos = []; }
      }
    }

    // ===== RENDER =====
    function renderLista() {
      const lista = document.getElementById('lista-gastos');
      const empty = document.getElementById('empty-state');

      let items = [...gastos];

      // Aplicar filtros
      const filtCat = document.getElementById('filtro-cat').value;
      const filtMed = document.getElementById('filtro-medio').value;
      const filtAnot = document.getElementById('filtro-anotador').value;
      if (filtCat) items = items.filter(g => g.categoria === filtCat);
      if (filtMed) items = items.filter(g => g.medio === filtMed || g.medioPago === filtMed);
      if (filtAnot) items = items.filter(g => (g.anotador || g.pagadorNombre || '') === filtAnot);

      // Poblar filtro categor√≠as din√°micamente
      const selCat = document.getElementById('filtro-cat');
      const prevCat = selCat.value;
      const cats = new Set();
      gastos.forEach(g => { if (g.categoria) cats.add(g.categoria); });
      selCat.innerHTML = '<option value="">üìÅ Todas las categor√≠as</option>' +
        Array.from(cats).sort().map(c => `<option value="${c}">${CAT_LABELS[c] || c}</option>`).join('');
      selCat.value = prevCat;

      // Poblar filtro anotadores din√°micamente
      const selAnot = document.getElementById('filtro-anotador');
      const prevAnot = selAnot.value;
      const anots = new Set();
      gastos.forEach(g => { const a = g.anotador || g.pagadorNombre; if (a) anots.add(a); });
      selAnot.innerHTML = '<option value="">üë§ Todos los que apuntan</option>' +
        Array.from(anots).sort().map(a => `<option value="${a}">${a}</option>`).join('');
      selAnot.value = prevAnot;

      if (!items.length) {
        lista.innerHTML = '';
        empty.style.display = '';
        updateSummary(items);
        return;
      }
      empty.style.display = 'none';

      // Agrupar por mes
      const meses = {};
      items.forEach(g => {
        const mes = g.fecha ? g.fecha.substring(0, 7) : 'sin-fecha';
        if (!meses[mes]) meses[mes] = [];
        meses[mes].push(g);
      });

      let html = '';
      let totalGeneral = 0;

      Object.keys(meses).sort().reverse().forEach(mes => {
        const regs = meses[mes];
        const totalMes = regs.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
        totalGeneral += totalMes;
        const mesLabel = mes === 'sin-fecha' ? 'Sin fecha' :
          new Date(mes + '-01').toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

        html += `<div style="margin-bottom:16px;">
          <div class="gasto-mes-header">
            <span style="text-transform:capitalize;">${mesLabel}</span>
            <span>${fN(totalMes)} ‚Ç¨</span>
          </div>`;

        regs.forEach(g => {
          const catLabel = CAT_LABELS[g.categoria] || g.categoria || '';
          const medioIcon = MEDIO_ICONS[g.medio || g.medioPago] || '';
          const anotador = g.anotador || g.pagadorNombre || '';
          const cuenta = g.cuenta || '';
          const imp = parseFloat(g.importe) || 0;

          html += `<div class="gasto-item" onclick="editarGasto('${g.id}')">
            <span class="gasto-fecha">${fD(g.fecha)}</span>
            <span class="gasto-concepto">
              ${g.concepto || '‚Äî'}
              <div class="gasto-detalle">${catLabel}${cuenta ? ' ¬∑ üè¶' + cuenta : ''}${anotador ? ' ¬∑ üë§' + anotador : ''}</div>
            </span>
            <span style="display:flex;align-items:center;gap:4px;">
              ${medioIcon ? `<span style="font-size:0.75rem;">${medioIcon}</span>` : ''}
              <span class="gasto-importe">${fN(imp)} ‚Ç¨</span>
            </span>
          </div>`;
        });

        html += '</div>';
      });

      html += `<div class="total-bar">
        <span>Total (${items.length} gastos)</span>
        <span>${fN(totalGeneral)} ‚Ç¨</span>
      </div>`;

      lista.innerHTML = html;
      updateSummary(items);
    }

    function updateSummary(items) {
      const total = items.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
      document.getElementById('sum-total').textContent = fN(total) + ' ‚Ç¨';
      document.getElementById('sum-count').textContent = items.length;
      document.getElementById('sum-media').textContent = items.length > 0 ? fN(total / items.length) + ' ‚Ç¨' : '‚Äî';
    }

    // ===== MODAL =====
    function abrirModal() {
      editandoId = null;
      document.getElementById('modal-title').textContent = 'üí∂ Nuevo gasto';
      document.getElementById('btn-eliminar').style.display = 'none';
      document.getElementById('g-fecha').value = new Date().toISOString().split('T')[0];
      document.getElementById('g-concepto').value = '';
      document.getElementById('g-categoria').value = '';
      document.getElementById('g-importe').value = '';
      document.getElementById('g-medio').value = '';
      document.getElementById('g-cuenta').value = '';
      document.getElementById('g-cuenta-new').value = '';
      document.getElementById('g-cuenta-new').style.display = 'none';
      document.getElementById('g-notas').value = '';
      document.getElementById('g-anotador').value = '';
      document.getElementById('g-anotador-new').value = '';
      document.getElementById('g-anotador-new').style.display = 'none';
      cargarAnotadores();
      document.getElementById('modal-gasto').classList.add('open');
    }

    function editarGasto(id) {
      const g = gastos.find(x => x.id === id);
      if (!g) return;
      editandoId = id;
      document.getElementById('modal-title').textContent = '‚úèÔ∏è Editar gasto';
      document.getElementById('btn-eliminar').style.display = '';
      document.getElementById('g-fecha').value = g.fecha || '';
      document.getElementById('g-concepto').value = g.concepto || '';
      document.getElementById('g-categoria').value = g.categoria || '';
      document.getElementById('g-importe').value = g.importe || '';
      document.getElementById('g-medio').value = g.medio || g.medioPago || '';
      document.getElementById('g-cuenta').value = g.cuenta || '';
      document.getElementById('g-cuenta-new').value = '';
      document.getElementById('g-cuenta-new').style.display = 'none';
      document.getElementById('g-notas').value = g.notas || '';
      cargarAnotadores();
      document.getElementById('g-anotador').value = g.anotador || g.pagadorNombre || '';
      document.getElementById('g-anotador-new').value = '';
      document.getElementById('g-anotador-new').style.display = 'none';
      document.getElementById('modal-gasto').classList.add('open');
    }

    function cerrarModal() {
      document.getElementById('modal-gasto').classList.remove('open');
    }

    function cargarAnotadores() {
      console.log('[DEBUG] cargarAnotadores llamada. externosNombres:', externosNombres.length);
      const sel = document.getElementById('g-anotador');
      sel.innerHTML = '<option value="">‚Äî Yo mismo ‚Äî</option>';

      if (externosNombres.length) {
        let html = '<optgroup label="Externos del bien">';
        externosNombres.forEach(e => { html += `<option value="${e.nombre}">${e.rol} ${e.nombre}</option>`; });
        html += '</optgroup>';
        sel.innerHTML += html;
      }

      // A√±adir anteriores que no est√©n en externos
      const extNames = new Set(externosNombres.map(e => e.nombre));
      const anteriores = new Set();
      gastos.forEach(g => {
        const a = g.anotador || g.pagadorNombre;
        if (a && !extNames.has(a)) anteriores.add(a);
      });
      if (anteriores.size) {
        let html = '<optgroup label="Anteriores">';
        anteriores.forEach(a => { html += `<option value="${a}">${a}</option>`; });
        html += '</optgroup>';
        sel.innerHTML += html;
      }
    }

    function toggleNuevaCuenta() {
      const inp = document.getElementById('g-cuenta-new');
      inp.style.display = inp.style.display === 'none' ? '' : 'none';
      if (inp.style.display !== 'none') inp.focus();
    }

    function toggleNuevoAnotador() {
      const inp = document.getElementById('g-anotador-new');
      inp.style.display = inp.style.display === 'none' ? '' : 'none';
      if (inp.style.display !== 'none') inp.focus();
    }

    // ===== GUARDAR =====
    async function guardarGasto() {
      const fecha = document.getElementById('g-fecha').value;
      const concepto = document.getElementById('g-concepto').value.trim();
      const categoria = document.getElementById('g-categoria').value;
      const importe = parseFloat(document.getElementById('g-importe').value);

      if (!fecha || !concepto || !categoria || isNaN(importe) || importe <= 0) {
        alert('Completa los campos obligatorios: Fecha, Concepto, Categor√≠a e Importe');
        return;
      }

      const medio = document.getElementById('g-medio').value;
      const cuentaNew = document.getElementById('g-cuenta-new').value.trim();
      const cuenta = cuentaNew || document.getElementById('g-cuenta').value;
      const notas = document.getElementById('g-notas').value.trim();
      const anotadorNew = document.getElementById('g-anotador-new').value.trim();
      const anotador = anotadorNew || document.getElementById('g-anotador').value;

      // Si hay cuenta nueva, guardarla en el bien
      if (cuentaNew && !(bienData.cuentas || []).includes(cuentaNew)) {
        const cuentas = [...(bienData.cuentas || []), cuentaNew];
        await db.collection('bienes').doc(bienId).update({ cuentas });
        bienData.cuentas = cuentas;
        const sel = document.getElementById('g-cuenta');
        sel.innerHTML = '<option value="">‚Äî Sin especificar ‚Äî</option>';
        cuentas.forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });
      }

      const data = {
        fecha,
        concepto,
        categoria,
        importe,
        medio: medio || null,
        cuenta: cuenta || null,
        notas: notas || null,
        anotador: anotador || null,
        fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        const ref = db.collection('bienes').doc(bienId).collection('gastos');
        if (editandoId) {
          await ref.doc(editandoId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        cerrarModal();
        await cargarGastos();
        renderLista();
      } catch(e) {
        console.error(e);
        alert('Error al guardar: ' + e.message);
      }
    }

    async function eliminarGasto() {
      if (!editandoId) return;
      if (!confirm('¬øEliminar este gasto?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('gastos').doc(editandoId).delete();
        cerrarModal();
        await cargarGastos();
        renderLista();
      } catch(e) {
        alert('Error: ' + e.message);
      }
    }

    // ===== HELPERS =====
    function fN(n) { return (n || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function fD(d) {
      if (!d) return '‚Äî';
      const p = d.split('-');
      return p.length === 3 ? `${p[2]}/${p[1]}` : d;
    }

    // ========== PDF DESCARGA DIRECTA ==========
    function generarPDF() {
      const bienNombre = document.getElementById('bien-nombre')?.textContent || 'Bien';
      
      let items = [...gastos];
      const filtCat = document.getElementById('filtro-cat').value;
      const filtMed = document.getElementById('filtro-medio').value;
      const filtAnot = document.getElementById('filtro-anotador').value;
      if (filtCat) items = items.filter(g => g.categoria === filtCat);
      if (filtMed) items = items.filter(g => g.medio === filtMed || g.medioPago === filtMed);
      if (filtAnot) items = items.filter(g => (g.anotador || g.pagadorNombre || '') === filtAnot);
      
      const total = items.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
      const media = items.length > 0 ? total / items.length : 0;
      
      // Agrupar por mes
      const meses = {};
      items.forEach(g => {
        const mes = g.fecha ? g.fecha.substring(0, 7) : 'sin-fecha';
        if (!meses[mes]) meses[mes] = [];
        meses[mes].push(g);
      });
      
      let tablas = '';
      Object.keys(meses).sort().reverse().forEach(mes => {
        const regs = meses[mes];
        const totalMes = regs.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
        const mesLabel = mes === 'sin-fecha' ? 'Sin fecha' :
          new Date(mes + '-01').toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        
        let filas = regs.map(g => `<tr>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;font-size:11px;">${g.fecha || '-'}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;">${g.concepto || '-'}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;font-size:11px;">${CAT_LABELS[g.categoria] || g.categoria || '-'}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;font-size:11px;">${g.anotador || g.pagadorNombre || '-'}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;text-align:right;font-weight:600;">${(parseFloat(g.importe) || 0).toFixed(2)} ‚Ç¨</td>
        </tr>`).join('');
        
        tablas += `
          <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;padding:8px 12px;background:#F5F0E8;border-radius:6px;margin-bottom:8px;font-weight:700;font-size:13px;text-transform:capitalize;">
              <span>${mesLabel}</span><span>${totalMes.toFixed(2)} ‚Ç¨</span>
            </div>
            <table style="width:100%;border-collapse:collapse;font-size:12px;">
              <thead><tr style="background:#7A9E7E;color:white;">
                <th style="padding:6px 8px;text-align:left;">Fecha</th>
                <th style="padding:6px 8px;text-align:left;">Concepto</th>
                <th style="padding:6px 8px;text-align:left;">Categor√≠a</th>
                <th style="padding:6px 8px;text-align:left;">Anotador</th>
                <th style="padding:6px 8px;text-align:right;">Importe</th>
              </tr></thead>
              <tbody>${filas}</tbody>
            </table>
          </div>`;
      });
      
      const div = document.createElement('div');
      div.innerHTML = `
        <div style="font-family:Helvetica,Arial,sans-serif;padding:10px;color:#333;">
          <div style="text-align:center;margin-bottom:20px;">
            <h2 style="margin:0;color:#5C7D5F;">üí∂ Gastos</h2>
            <p style="margin:4px 0;color:#888;">${bienNombre}</p>
            <p style="margin:2px 0;font-size:11px;color:#aaa;">${new Date().toLocaleDateString('es-ES')}</p>
          </div>
          <div style="display:flex;gap:30px;justify-content:center;margin-bottom:20px;font-size:13px;">
            <span>Total: <b>${total.toFixed(2)} ‚Ç¨</b></span>
            <span>Registros: <b>${items.length}</b></span>
            <span>Media: <b>${media.toFixed(2)} ‚Ç¨</b></span>
          </div>
          ${tablas || '<p style="text-align:center;color:#aaa;">Sin gastos registrados</p>'}
          <div style="text-align:center;margin-top:30px;font-size:10px;color:#bbb;">FAMILYNK ¬∑ Gastos</div>
        </div>
      `;
      
      html2pdf().set({
        margin: [10, 10, 15, 10],
        filename: 'gastos-' + bienNombre.replace(/[^a-zA-Z0-9]/g, '_') + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).from(div).save();
    }
  </script>
</body>
</html>
