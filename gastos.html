<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Gastos</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E; --cream: #FDF8F3; --cream-dark: #F5EDE4; --cream-medium: #FAF5EF;
      --terracotta: #C17757; --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A; --white: #FFFFFF;
      --mayordomo: #8B7355; --mayordomo-light: #A69076; --mayordomo-dark: #6B5A42; --mayordomo-muted: rgba(139,115,85,0.15);
      --addon-color: var(--mayordomo); --addon-light: var(--mayordomo-light);
      --addon-dark: var(--mayordomo-dark); --addon-muted: var(--mayordomo-muted);
      --success: #7DB59A; --success-muted: rgba(125,181,154,0.15);
      --warning: #E8B44D; --warning-muted: rgba(232,180,77,0.15);
      --error: #D4695A; --error-muted: rgba(212,105,90,0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06); --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-full: 50px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header {
      background: linear-gradient(135deg, var(--addon-color) 0%, var(--addon-dark) 100%);
      padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-medium); position: sticky; top: 0; z-index: 100;
    }
    .header a, .header span { color: white; text-decoration: none; font-family: 'Quicksand'; font-weight: 600; font-size: 0.9rem; }
    .header-title { font-family: 'Quicksand'; font-weight: 700; font-size: 1.1rem; color: white; }
    .header-bien { font-size: 0.8rem; color: rgba(255,255,255,0.75); }

    .container { max-width: 900px; margin: 0 auto; padding: 20px; }

    /* Summary cards */
    .summary-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
    .summary-card { background: var(--white); border-radius: var(--radius-md); padding: 16px; text-align: center; box-shadow: var(--shadow-soft); }
    .summary-num { font-family: 'Quicksand'; font-weight: 700; font-size: 1.5rem; color: var(--addon-color); }
    .summary-label { font-size: 0.78rem; color: var(--text-muted); }

    /* Filtros */
    .filtros { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; align-items: center; }
    .filtros select { flex: 1; min-width: 120px; font-size: 0.82rem; padding: 8px 10px; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm); background: var(--white); font-family: 'Nunito'; }

    /* Lista */
    .lista-gastos { display: flex; flex-direction: column; gap: 2px; }
    .gasto-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 14px;
      background: var(--white); border-radius: var(--radius-sm); cursor: pointer;
      border-left: 3px solid var(--terracotta); transition: transform 0.15s;
    }
    .gasto-item:hover { transform: translateX(4px); }
    .gasto-fecha { font-size: 0.75rem; color: var(--text-muted); min-width: 70px; font-family: 'Quicksand'; font-weight: 600; }
    .gasto-concepto { flex: 1; font-size: 0.88rem; }
    .gasto-detalle { font-size: 0.7rem; color: var(--text-muted); }
    .gasto-importe { font-family: 'Quicksand'; font-weight: 700; font-size: 0.92rem; white-space: nowrap; }
    .gasto-mes-header {
      display: flex; justify-content: space-between; padding: 8px 12px;
      background: var(--cream-medium); border-radius: var(--radius-sm); margin-bottom: 6px;
    }
    .gasto-mes-header span { font-weight: 700; font-size: 0.88rem; }
    .total-bar {
      display: flex; justify-content: space-between; padding: 12px;
      background: var(--addon-color); color: white; border-radius: var(--radius-sm); font-weight: 700;
      margin-top: 12px;
    }

    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state div:first-child { font-size: 2.5rem; margin-bottom: 8px; }

    /* FAB */
    .fab {
      position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px;
      background: var(--addon-color); color: white; border: none; border-radius: 50%;
      font-size: 1.8rem; cursor: pointer; box-shadow: var(--shadow-medium);
      display: flex; align-items: center; justify-content: center; z-index: 90;
    }
    .fab:hover { background: var(--addon-dark); transform: scale(1.05); }

    /* Modal */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 200; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--white); border-radius: var(--radius-lg); width: 100%; max-width: 520px;
      max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 16px 48px rgba(0,0,0,0.15);
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 20px; border-bottom: 1px solid var(--cream-dark);
    }
    .modal-title { font-family: 'Quicksand'; font-weight: 700; font-size: 1rem; }
    .modal-close { background: none; border: none; font-size: 1.3rem; cursor: pointer; color: var(--text-muted); padding: 4px; }
    .modal-body { padding: 20px; overflow-y: auto; }
    .modal-footer { padding: 12px 20px; border-top: 1px solid var(--cream-dark); display: flex; justify-content: flex-end; gap: 8px; }

    .form-group { margin-bottom: 14px; }
    .form-label { display: block; font-size: 0.82rem; font-weight: 600; margin-bottom: 4px; color: var(--text-light); }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 10px 12px; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm);
      font-family: 'Nunito'; font-size: 0.9rem; background: var(--cream-medium);
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--addon-color); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .subgrupo-input-wrap { display: flex; align-items: center; gap: 8px; }
    .subgrupo-input-wrap .form-group { flex: 1; margin-bottom: 0; }
    .subgrupo-toggle { font-size: 0.78rem; color: var(--addon-color); cursor: pointer; white-space: nowrap; font-weight: 600; }

    .btn { padding: 10px 20px; border: none; border-radius: var(--radius-sm); font-family: 'Nunito'; font-weight: 600; font-size: 0.88rem; cursor: pointer; }
    .btn-addon { background: var(--addon-color); color: white; }
    .btn-addon:hover { background: var(--addon-dark); }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-danger { background: var(--error); color: white; font-size: 0.8rem; padding: 8px 14px; }

    @media (max-width: 600px) {
      .summary-row { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .filtros { flex-direction: column; }
    }

    .btn-pdf {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 14px; background: white; color: #5C7D5F;
      border: 2px solid #7A9E7E; border-radius: 8px;
      font-family: 'Nunito', sans-serif; font-size: 0.82rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; text-decoration: none;
    }
    .btn-pdf:hover { background: #7A9E7E; color: white; }

    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 2px solid var(--cream-dark); }
    .tab-btn {
      flex: 1; padding: 12px 16px; font-family: 'Quicksand'; font-weight: 700; font-size: 0.92rem;
      background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-muted);
      cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--addon-color); border-bottom-color: var(--addon-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Reparto */
    .reparto-gastos-list { display: flex; flex-direction: column; gap: 2px; margin-bottom: 16px; }
    .reparto-gasto-row {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px;
      background: var(--white); border-radius: var(--radius-sm); cursor: pointer; transition: background 0.15s;
    }
    .reparto-gasto-row:hover { background: var(--cream-medium); }
    .reparto-gasto-row.selected { background: var(--success-muted); border-left: 3px solid var(--success); }
    .reparto-gasto-check { width: 18px; height: 18px; accent-color: var(--success); cursor: pointer; }
    .reparto-gasto-info { flex: 1; }
    .reparto-gasto-concepto { font-size: 0.88rem; font-weight: 600; }
    .reparto-gasto-meta { font-size: 0.72rem; color: var(--text-muted); }
    .reparto-gasto-importe { font-family: 'Quicksand'; font-weight: 700; font-size: 0.9rem; }

    .reparto-total-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 16px; background: var(--addon-color); color: white;
      border-radius: var(--radius-sm); font-weight: 700; margin-bottom: 16px;
    }
    .reparto-total-bar .reparto-total-num { font-family: 'Quicksand'; font-size: 1.2rem; }

    .reparto-acciones { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }

    .reparto-historial { margin-top: 24px; }
    .reparto-historial-title { font-family: 'Quicksand'; font-weight: 700; font-size: 0.95rem; margin-bottom: 12px; color: var(--text-light); }
    .reparto-card {
      background: var(--white); border-radius: var(--radius-md); padding: 14px 16px;
      margin-bottom: 10px; box-shadow: var(--shadow-soft); cursor: pointer;
    }
    .reparto-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .reparto-card-nombre { font-weight: 700; font-size: 0.9rem; }
    .reparto-card-total { font-family: 'Quicksand'; font-weight: 700; color: var(--addon-color); }
    .reparto-card-fecha { font-size: 0.72rem; color: var(--text-muted); }
    .reparto-card-participantes { display: flex; flex-wrap: wrap; gap: 6px; }
    .reparto-chip {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 10px; background: var(--cream); border-radius: var(--radius-full);
      font-size: 0.78rem; font-weight: 600;
    }
    .reparto-chip-pct { color: var(--addon-color); }

    /* Modal reparto */
    .reparto-participante-row {
      display: flex; align-items: center; gap: 10px; padding: 10px 0;
      border-bottom: 1px solid var(--cream-dark);
    }
    .reparto-participante-row:last-child { border-bottom: none; }
    .reparto-participante-nombre { flex: 1; font-weight: 600; font-size: 0.88rem; }
    .reparto-participante-pct {
      width: 70px; padding: 6px 8px; border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm); text-align: right; font-size: 0.88rem; font-family: 'Quicksand'; font-weight: 700;
    }
    .reparto-participante-pct:focus { outline: none; border-color: var(--addon-color); }
    .reparto-participante-remove { background: none; border: none; font-size: 1.1rem; cursor: pointer; color: var(--error); padding: 4px; }
    .reparto-sum-bar {
      display: flex; justify-content: space-between; padding: 12px 0; margin-top: 8px;
      border-top: 2px solid var(--cream-dark); font-weight: 700;
    }
    .reparto-sum-valor { font-family: 'Quicksand'; font-size: 1.1rem; }
    .reparto-sum-valor.ok { color: var(--success); }
    .reparto-sum-valor.error { color: var(--error); }
    .reparto-add-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .reparto-add-row select { flex: 1; }
    .btn-sm { padding: 6px 12px; font-size: 0.82rem; }
    .reparto-nombre-input { margin-top: 8px; }
    .select-all-bar { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--cream-medium); border-radius: var(--radius-sm); margin-bottom: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
    .select-all-bar:hover { background: var(--cream-dark); }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <a id="btn-volver" href="#">‚Üê Volver</a>
    <div style="text-align:center;">
      <div class="header-title">üí∂ Gastos</div>
      <div class="header-bien" id="bien-nombre">Cargando...</div>
    </div>
    <button class="btn-pdf" onclick="generarPDF()">üìÑ PDF</button>
  </div>

  <div class="container">
    <!-- Summary -->
    <div class="summary-row" id="summary-row">
      <div class="summary-card"><div class="summary-num" id="sum-total">‚Äî</div><div class="summary-label">Total gastado</div></div>
      <div class="summary-card"><div class="summary-num" id="sum-count">‚Äî</div><div class="summary-label">Registros</div></div>
      <div class="summary-card"><div class="summary-num" id="sum-media">‚Äî</div><div class="summary-label">Media / gasto</div></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="cambiarTab('registro')">üìã Registro</button>
      <button class="tab-btn" onclick="cambiarTab('reparto')">üìä Reparto</button>
    </div>

    <!-- TAB: Registro -->
    <div class="tab-content active" id="tab-registro">
      <!-- Filtros -->
      <div class="filtros">
        <select id="filtro-cat" onchange="renderLista()">
          <option value="">üìÅ Todas las categor√≠as</option>
        </select>
        <select id="filtro-medio" onchange="renderLista()">
          <option value="">üí≥ Todos los medios</option>
          <option value="efectivo">üíµ Efectivo</option>
          <option value="transferencia">üè¶ Transferencia</option>
          <option value="tarjeta">üí≥ Tarjeta</option>
          <option value="domiciliacion">üìã Domiciliaci√≥n</option>
        </select>
        <select id="filtro-anotador" onchange="renderLista()">
          <option value="">üë§ Todos los que apuntan</option>
        </select>
      </div>

      <!-- Lista -->
      <div class="lista-gastos" id="lista-gastos"></div>
      <div class="empty-state" id="empty-state" style="display:none;">
        <div>üí∂</div>
        <div style="font-weight:600;">Sin gastos registrados</div>
        <div style="font-size:0.85rem;">Pulsa + para a√±adir el primer gasto</div>
      </div>
    </div>

    <!-- TAB: Reparto -->
    <div class="tab-content" id="tab-reparto">
      <div class="select-all-bar" onclick="toggleSelectAll()">
        <input type="checkbox" id="select-all-check" style="accent-color:var(--success);width:18px;height:18px;">
        <span id="select-all-label">Seleccionar todos</span>
      </div>
      <div class="reparto-gastos-list" id="reparto-gastos-list"></div>
      <div class="reparto-total-bar">
        <span><span id="reparto-sel-count">0</span> gastos seleccionados</span>
        <span class="reparto-total-num" id="reparto-sel-total">0,00 ‚Ç¨</span>
      </div>
      <div class="reparto-acciones">
        <button class="btn btn-addon" id="btn-crear-reparto" onclick="abrirModalReparto()" disabled>üìä Configurar reparto</button>
      </div>

      <!-- Historial de repartos -->
      <div class="reparto-historial">
        <div class="reparto-historial-title">üìú Repartos guardados</div>
        <div id="reparto-historial-list"></div>
      </div>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" onclick="abrirModal()">+</button>

  <!-- Modal -->
  <div class="modal-overlay" id="modal-gasto">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="modal-title">üí∂ Nuevo gasto</span>
        <button class="modal-close" onclick="cerrarModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Fecha *</label><input type="date" class="form-input" id="g-fecha"></div>
        <div class="form-group"><label class="form-label">Concepto *</label><input type="text" class="form-input" id="g-concepto" placeholder="Ej: Factura de luz, Reparaci√≥n puerta..."></div>
        <div class="form-group">
          <label class="form-label">Categor√≠a *</label>
          <select class="form-select" id="g-categoria">
            <option value="">‚Äî Selecciona ‚Äî</option>
            <option value="suministros">üí° Suministros (luz, agua, gas)</option>
            <option value="limpieza">üßπ Limpieza</option>
            <option value="mantenimiento">üîß Mantenimiento</option>
            <option value="alimentacion">üõí Alimentaci√≥n</option>
            <option value="seguros">üõ°Ô∏è Seguros</option>
            <option value="personal">üë∑ Personal</option>
            <option value="jardineria">üåø Jardiner√≠a</option>
            <option value="comunidad">üè¢ Comunidad</option>
            <option value="impuestos">üìã Impuestos / tasas</option>
            <option value="otros">üì¶ Otros</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Importe (‚Ç¨) *</label><input type="number" class="form-input" id="g-importe" min="0" step="0.01" placeholder="0.00"></div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Medio de pago</label>
            <select class="form-select" id="g-medio">
              <option value="">‚Äî Sin especificar ‚Äî</option>
              <option value="efectivo">üíµ Efectivo</option>
              <option value="transferencia">üè¶ Transferencia</option>
              <option value="tarjeta">üí≥ Tarjeta</option>
              <option value="domiciliacion">üìã Domiciliaci√≥n</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Cuenta</label>
            <div class="subgrupo-input-wrap">
              <div class="form-group">
                <select class="form-select" id="g-cuenta">
                  <option value="">‚Äî Sin especificar ‚Äî</option>
                </select>
              </div>
              <span class="subgrupo-toggle" onclick="toggleNuevaCuenta()">+ Nueva</span>
            </div>
            <input type="text" class="form-input" id="g-cuenta-new" placeholder="Ej: CaixaBank, Caja chica..." style="display:none;margin-top:6px;">
          </div>
        </div>
        <div class="form-group"><label class="form-label">Nota</label><textarea class="form-textarea" id="g-notas" rows="2" placeholder="Observaciones..."></textarea></div>
        <div class="form-group">
          <label class="form-label">Qui√©n anota</label>
          <div class="subgrupo-input-wrap">
            <div class="form-group">
              <select class="form-select" id="g-anotador">
                <option value="">‚Äî Yo mismo ‚Äî</option>
              </select>
            </div>
            <span class="subgrupo-toggle" onclick="toggleNuevoAnotador()">+ Otro</span>
          </div>
          <input type="text" class="form-input" id="g-anotador-new" placeholder="Ej: Casero, Guarda..." style="display:none;margin-top:6px;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
        <button class="btn btn-danger" id="btn-eliminar" onclick="eliminarGasto()" style="display:none;">Eliminar</button>
        <button class="btn btn-addon" onclick="guardarGasto()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Reparto -->
  <div class="modal-overlay" id="modal-reparto">
    <div class="modal" style="max-width:560px;">
      <div class="modal-header">
        <span class="modal-title" id="modal-reparto-title">üìä Configurar reparto</span>
        <button class="modal-close" onclick="cerrarModalReparto()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nombre del reparto</label>
          <input type="text" class="form-input" id="reparto-nombre" placeholder="Ej: Gastos enero 2026, Suministros Q1...">
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--cream-dark);margin-bottom:12px;">
          <span style="font-size:0.85rem;color:var(--text-muted);" id="reparto-resumen-gastos">0 gastos</span>
          <span style="font-family:'Quicksand';font-weight:700;font-size:1.1rem;color:var(--addon-color);" id="reparto-modal-total">0,00 ‚Ç¨</span>
        </div>

        <label class="form-label">A√±adir participante</label>
        <div class="reparto-add-row">
          <select class="form-select" id="reparto-add-select">
            <option value="">‚Äî Selecciona ‚Äî</option>
          </select>
          <button class="btn btn-addon btn-sm" onclick="addParticipante()">+ A√±adir</button>
        </div>
        <div class="reparto-add-row">
          <input type="text" class="form-input" id="reparto-add-custom" placeholder="O escribe un nombre..." style="flex:1;">
          <button class="btn btn-secondary btn-sm" onclick="addParticipanteCustom()">+ Otro</button>
        </div>

        <div id="reparto-participantes-list"></div>

        <div class="reparto-sum-bar">
          <span>Total asignado</span>
          <span class="reparto-sum-valor" id="reparto-sum-pct">0%</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm hidden" id="btn-eliminar-reparto" onclick="eliminarReparto()">üóëÔ∏è Eliminar</button>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary" onclick="cerrarModalReparto()">Cancelar</button>
          <button class="btn btn-addon" id="btn-guardar-reparto" onclick="guardarReparto()">üíæ Guardar reparto</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script>
    let bienId = null, bienData = null, currentUser = null;
    let gastos = [];
    let externosNombres = [];
    let editandoId = null;
    // Reparto
    let nidosData = [];
    let miembrosLista = []; // {nombre, nido, uid?}
    let repartoSeleccionados = new Set(); // IDs de gastos seleccionados
    let repartoParticipantes = []; // {nombre, porcentaje}
    let repartosGuardados = [];
    let editandoRepartoId = null;
    let tabActual = 'registro';

    const CAT_LABELS = {
      suministros: 'üí° Suministros', limpieza: 'üßπ Limpieza', mantenimiento: 'üîß Mantenimiento',
      alimentacion: 'üõí Alimentaci√≥n', seguros: 'üõ°Ô∏è Seguros', personal: 'üë∑ Personal',
      jardineria: 'üåø Jardiner√≠a', comunidad: 'üè¢ Comunidad', impuestos: 'üìã Impuestos',
      otros: 'üì¶ Otros'
    };
    const MEDIO_ICONS = { efectivo: 'üíµ', transferencia: 'üè¶', tarjeta: 'üí≥', domiciliacion: 'üìã' };

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');
      const origen = params.get('origen') || 'mayordomo';
      if (!bienId) { alert('No se ha especificado el bien'); window.location.href = 'lo-comun.html'; return; }

      // Adaptar colores al add-on de origen
      if (origen === 'gerente') {
        document.documentElement.style.setProperty('--addon-color', '#2D4A5C');
        document.documentElement.style.setProperty('--addon-light', '#3D6A7C');
        document.documentElement.style.setProperty('--addon-dark', '#1D3A4C');
        document.documentElement.style.setProperty('--addon-muted', 'rgba(45,74,92,0.15)');
      } else if (origen === 'capataz') {
        document.documentElement.style.setProperty('--addon-color', '#2D5A3F');
        document.documentElement.style.setProperty('--addon-light', '#3D7A5F');
        document.documentElement.style.setProperty('--addon-dark', '#1D4A2F');
        document.documentElement.style.setProperty('--addon-muted', 'rgba(45,90,63,0.15)');
      }

      document.getElementById('btn-volver').href = `bien.html?id=${bienId}`;

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await cargarBien();
          await cargarExternos();
          await cargarGastos();
          await cargarNidosMiembros();
          await cargarRepartos();
          renderLista();
        } else {
          window.location.href = 'login.html';
        }
      });
    });

    // ===== CARGAR DATOS =====
    async function cargarBien() {
      const doc = await db.collection('bienes').doc(bienId).get();
      if (!doc.exists) { alert('Bien no encontrado'); return; }
      bienData = doc.data();
      document.getElementById('bien-nombre').textContent = bienData.nombre || '';

      // Cargar cuentas
      const sel = document.getElementById('g-cuenta');
      sel.innerHTML = '<option value="">‚Äî Sin especificar ‚Äî</option>';
      (bienData.cuentas || []).forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });
    }

    async function cargarExternos() {
      externosNombres = [];
      const rolIcons = { casero: 'üè†', hoster: 'üè®', guarda: 'üåæ' };
      const subcolecciones = ['caseros', 'hosters', 'guardas'];

      for (const sub of subcolecciones) {
        try {
          const snap = await db.collection('bienes').doc(bienId).collection(sub).get();
          const rolKey = sub.slice(0, -1); // caseros ‚Üí casero
          snap.docs.forEach(d => {
            const data = d.data();
            if (data.activo === false) return;
            const nombre = data.nombre || data.email || '';
            if (nombre) externosNombres.push({
              nombre,
              rol: `${rolIcons[rolKey] || 'üë§'} ${rolKey.charAt(0).toUpperCase() + rolKey.slice(1)}`,
              email: data.email || ''
            });
          });
        } catch(e) { console.warn('Error cargando ' + sub + ':', e); }
      }
    }

    async function cargarGastos() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('gastos').orderBy('fecha', 'desc').get();
        gastos = snap.docs.map(d => {
          const data = d.data();
          let fecha = data.fecha;
          if (fecha?.toDate) fecha = fecha.toDate().toISOString().split('T')[0];
          else if (fecha instanceof Date) fecha = fecha.toISOString().split('T')[0];
          return { id: d.id, ...data, fecha };
        });
      } catch(e) {
        console.error('Error cargando gastos:', e);
        // Fallback: sin orderBy (puede faltar √≠ndice)
        try {
          const snap = await db.collection('bienes').doc(bienId).collection('gastos').get();
          gastos = snap.docs.map(d => {
            const data = d.data();
            let fecha = data.fecha;
            if (fecha?.toDate) fecha = fecha.toDate().toISOString().split('T')[0];
            else if (fecha instanceof Date) fecha = fecha.toISOString().split('T')[0];
            return { id: d.id, ...data, fecha };
          }).sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));
        } catch(e2) { console.error(e2); gastos = []; }
      }
    }

    // ===== RENDER =====
    function renderLista() {
      const lista = document.getElementById('lista-gastos');
      const empty = document.getElementById('empty-state');

      let items = [...gastos];

      // Aplicar filtros
      const filtCat = document.getElementById('filtro-cat').value;
      const filtMed = document.getElementById('filtro-medio').value;
      const filtAnot = document.getElementById('filtro-anotador').value;
      if (filtCat) items = items.filter(g => g.categoria === filtCat);
      if (filtMed) items = items.filter(g => g.medio === filtMed || g.medioPago === filtMed);
      if (filtAnot) items = items.filter(g => (g.anotador || g.pagadorNombre || '') === filtAnot);

      // Poblar filtro categor√≠as din√°micamente
      const selCat = document.getElementById('filtro-cat');
      const prevCat = selCat.value;
      const cats = new Set();
      gastos.forEach(g => { if (g.categoria) cats.add(g.categoria); });
      selCat.innerHTML = '<option value="">üìÅ Todas las categor√≠as</option>' +
        Array.from(cats).sort().map(c => `<option value="${c}">${CAT_LABELS[c] || c}</option>`).join('');
      selCat.value = prevCat;

      // Poblar filtro anotadores din√°micamente
      const selAnot = document.getElementById('filtro-anotador');
      const prevAnot = selAnot.value;
      const anots = new Set();
      gastos.forEach(g => { const a = g.anotador || g.pagadorNombre; if (a) anots.add(a); });
      selAnot.innerHTML = '<option value="">üë§ Todos los que apuntan</option>' +
        Array.from(anots).sort().map(a => `<option value="${a}">${a}</option>`).join('');
      selAnot.value = prevAnot;

      if (!items.length) {
        lista.innerHTML = '';
        empty.style.display = '';
        updateSummary(items);
        return;
      }
      empty.style.display = 'none';

      // Agrupar por mes
      const meses = {};
      items.forEach(g => {
        const mes = g.fecha ? g.fecha.substring(0, 7) : 'sin-fecha';
        if (!meses[mes]) meses[mes] = [];
        meses[mes].push(g);
      });

      let html = '';
      let totalGeneral = 0;

      Object.keys(meses).sort().reverse().forEach(mes => {
        const regs = meses[mes];
        const totalMes = regs.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
        totalGeneral += totalMes;
        const mesLabel = mes === 'sin-fecha' ? 'Sin fecha' :
          new Date(mes + '-01').toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

        html += `<div style="margin-bottom:16px;">
          <div class="gasto-mes-header">
            <span style="text-transform:capitalize;">${mesLabel}</span>
            <span>${fN(totalMes)} ‚Ç¨</span>
          </div>`;

        regs.forEach(g => {
          const catLabel = CAT_LABELS[g.categoria] || g.categoria || '';
          const medioIcon = MEDIO_ICONS[g.medio || g.medioPago] || '';
          const anotador = g.anotador || g.pagadorNombre || '';
          const cuenta = g.cuenta || '';
          const imp = parseFloat(g.importe) || 0;

          html += `<div class="gasto-item" onclick="editarGasto('${g.id}')">
            <span class="gasto-fecha">${fD(g.fecha)}</span>
            <span class="gasto-concepto">
              ${g.concepto || '‚Äî'}
              <div class="gasto-detalle">${catLabel}${cuenta ? ' ¬∑ üè¶' + cuenta : ''}${anotador ? ' ¬∑ üë§' + anotador : ''}</div>
            </span>
            <span style="display:flex;align-items:center;gap:4px;">
              ${medioIcon ? `<span style="font-size:0.75rem;">${medioIcon}</span>` : ''}
              <span class="gasto-importe">${fN(imp)} ‚Ç¨</span>
            </span>
          </div>`;
        });

        html += '</div>';
      });

      html += `<div class="total-bar">
        <span>Total (${items.length} gastos)</span>
        <span>${fN(totalGeneral)} ‚Ç¨</span>
      </div>`;

      lista.innerHTML = html;
      updateSummary(items);
    }

    function updateSummary(items) {
      const total = items.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
      document.getElementById('sum-total').textContent = fN(total) + ' ‚Ç¨';
      document.getElementById('sum-count').textContent = items.length;
      document.getElementById('sum-media').textContent = items.length > 0 ? fN(total / items.length) + ' ‚Ç¨' : '‚Äî';
    }

    // ===== MODAL =====
    function abrirModal() {
      editandoId = null;
      document.getElementById('modal-title').textContent = 'üí∂ Nuevo gasto';
      document.getElementById('btn-eliminar').style.display = 'none';
      document.getElementById('g-fecha').value = new Date().toISOString().split('T')[0];
      document.getElementById('g-concepto').value = '';
      document.getElementById('g-categoria').value = '';
      document.getElementById('g-importe').value = '';
      document.getElementById('g-medio').value = '';
      document.getElementById('g-cuenta').value = '';
      document.getElementById('g-cuenta-new').value = '';
      document.getElementById('g-cuenta-new').style.display = 'none';
      document.getElementById('g-notas').value = '';
      document.getElementById('g-anotador').value = '';
      document.getElementById('g-anotador-new').value = '';
      document.getElementById('g-anotador-new').style.display = 'none';
      cargarAnotadores();
      document.getElementById('modal-gasto').classList.add('open');
    }

    function editarGasto(id) {
      const g = gastos.find(x => x.id === id);
      if (!g) return;
      editandoId = id;
      document.getElementById('modal-title').textContent = '‚úèÔ∏è Editar gasto';
      document.getElementById('btn-eliminar').style.display = '';
      document.getElementById('g-fecha').value = g.fecha || '';
      document.getElementById('g-concepto').value = g.concepto || '';
      document.getElementById('g-categoria').value = g.categoria || '';
      document.getElementById('g-importe').value = g.importe || '';
      document.getElementById('g-medio').value = g.medio || g.medioPago || '';
      document.getElementById('g-cuenta').value = g.cuenta || '';
      document.getElementById('g-cuenta-new').value = '';
      document.getElementById('g-cuenta-new').style.display = 'none';
      document.getElementById('g-notas').value = g.notas || '';
      cargarAnotadores();
      document.getElementById('g-anotador').value = g.anotador || g.pagadorNombre || '';
      document.getElementById('g-anotador-new').value = '';
      document.getElementById('g-anotador-new').style.display = 'none';
      document.getElementById('modal-gasto').classList.add('open');
    }

    function cerrarModal() {
      document.getElementById('modal-gasto').classList.remove('open');
    }

    function cargarAnotadores() {
      const sel = document.getElementById('g-anotador');
      sel.innerHTML = '<option value="">‚Äî Yo mismo ‚Äî</option>';

      if (externosNombres.length) {
        let html = '<optgroup label="Externos del bien">';
        externosNombres.forEach(e => { html += `<option value="${e.nombre}">${e.rol} ${e.nombre}</option>`; });
        html += '</optgroup>';
        sel.innerHTML += html;
      }

      // A√±adir anteriores que no est√©n en externos
      const extNames = new Set(externosNombres.map(e => e.nombre));
      const anteriores = new Set();
      gastos.forEach(g => {
        const a = g.anotador || g.pagadorNombre;
        if (a && !extNames.has(a)) anteriores.add(a);
      });
      if (anteriores.size) {
        let html = '<optgroup label="Anteriores">';
        anteriores.forEach(a => { html += `<option value="${a}">${a}</option>`; });
        html += '</optgroup>';
        sel.innerHTML += html;
      }
    }

    function toggleNuevaCuenta() {
      const inp = document.getElementById('g-cuenta-new');
      inp.style.display = inp.style.display === 'none' ? '' : 'none';
      if (inp.style.display !== 'none') inp.focus();
    }

    function toggleNuevoAnotador() {
      const inp = document.getElementById('g-anotador-new');
      inp.style.display = inp.style.display === 'none' ? '' : 'none';
      if (inp.style.display !== 'none') inp.focus();
    }

    // ===== GUARDAR =====
    async function guardarGasto() {
      const fecha = document.getElementById('g-fecha').value;
      const concepto = document.getElementById('g-concepto').value.trim();
      const categoria = document.getElementById('g-categoria').value;
      const importe = parseFloat(document.getElementById('g-importe').value);

      if (!fecha || !concepto || !categoria || isNaN(importe) || importe <= 0) {
        alert('Completa los campos obligatorios: Fecha, Concepto, Categor√≠a e Importe');
        return;
      }

      const medio = document.getElementById('g-medio').value;
      const cuentaNew = document.getElementById('g-cuenta-new').value.trim();
      const cuenta = cuentaNew || document.getElementById('g-cuenta').value;
      const notas = document.getElementById('g-notas').value.trim();
      const anotadorNew = document.getElementById('g-anotador-new').value.trim();
      const anotador = anotadorNew || document.getElementById('g-anotador').value;

      // Si hay cuenta nueva, guardarla en el bien
      if (cuentaNew && !(bienData.cuentas || []).includes(cuentaNew)) {
        const cuentas = [...(bienData.cuentas || []), cuentaNew];
        await db.collection('bienes').doc(bienId).update({ cuentas });
        bienData.cuentas = cuentas;
        const sel = document.getElementById('g-cuenta');
        sel.innerHTML = '<option value="">‚Äî Sin especificar ‚Äî</option>';
        cuentas.forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });
      }

      const data = {
        fecha,
        concepto,
        categoria,
        importe,
        medio: medio || null,
        cuenta: cuenta || null,
        notas: notas || null,
        anotador: anotador || null,
        fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        const ref = db.collection('bienes').doc(bienId).collection('gastos');
        if (editandoId) {
          await ref.doc(editandoId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        cerrarModal();
        await cargarGastos();
        renderLista();
      } catch(e) {
        console.error(e);
        alert('Error al guardar: ' + e.message);
      }
    }

    async function eliminarGasto() {
      if (!editandoId) return;
      if (!confirm('¬øEliminar este gasto?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('gastos').doc(editandoId).delete();
        cerrarModal();
        await cargarGastos();
        renderLista();
      } catch(e) {
        alert('Error: ' + e.message);
      }
    }

    // ===== HELPERS =====
    function fN(n) { return (n || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function fD(d) {
      if (!d) return '‚Äî';
      const p = d.split('-');
      return p.length === 3 ? `${p[2]}/${p[1]}` : d;
    }

    // ===== CARGAR NIDOS Y MIEMBROS =====
    async function cargarNidosMiembros() {
      miembrosLista = [];
      if (!bienData?.familiaId) return;

      try {
        const nidosSnap = await db.collection('nidos').where('familiaId', '==', bienData.familiaId).get();
        nidosData = nidosSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        for (const nido of nidosData) {
          try {
            const miembrosSnap = await db.collection('nidos').doc(nido.id).collection('miembrosData').get();
            miembrosSnap.docs.forEach(m => {
              const data = m.data();
              const nombre = data.nombre || data.nombreCompleto || '';
              if (nombre) {
                miembrosLista.push({ nombre, nido: nido.nombre || '', uid: data.uid || m.id });
              }
            });
          } catch(e) { /* nido sin miembrosData */ }
        }

        // Si no hay miembrosData, usar nombres de nido como participantes
        if (miembrosLista.length === 0) {
          nidosData.forEach(n => {
            miembrosLista.push({ nombre: n.nombre || 'Nido', nido: '', uid: n.id });
          });
        }
      } catch(e) { console.warn('Error cargando nidos:', e); }
    }

    async function cargarRepartos() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('repartos').orderBy('fechaCreacion', 'desc').get();
        repartosGuardados = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch(e) {
        // Sin √≠ndice, fallback
        try {
          const snap = await db.collection('bienes').doc(bienId).collection('repartos').get();
          repartosGuardados = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a, b) => (b.fechaCreacion?.seconds || 0) - (a.fechaCreacion?.seconds || 0));
        } catch(e2) { repartosGuardados = []; }
      }
    }

    // ===== TABS =====
    function cambiarTab(tab) {
      tabActual = tab;
      document.querySelectorAll('.tab-btn').forEach((b, i) => {
        b.classList.toggle('active', (i === 0 && tab === 'registro') || (i === 1 && tab === 'reparto'));
      });
      document.getElementById('tab-registro').classList.toggle('active', tab === 'registro');
      document.getElementById('tab-reparto').classList.toggle('active', tab === 'reparto');

      // FAB solo visible en registro
      document.querySelector('.fab').style.display = tab === 'registro' ? '' : 'none';

      if (tab === 'reparto') {
        renderRepartoGastos();
        renderRepartoHistorial();
      }
    }

    // ===== REPARTO: LISTA DE GASTOS CON CHECKBOX =====
    function renderRepartoGastos() {
      const container = document.getElementById('reparto-gastos-list');
      if (!gastos.length) {
        container.innerHTML = '<div class="empty-state" style="padding:20px;"><div>üìä</div><div style="font-weight:600;">Sin gastos para repartir</div><div style="font-size:0.85rem;">Primero registra gastos en la pesta√±a Registro</div></div>';
        return;
      }

      container.innerHTML = gastos.map(g => {
        const checked = repartoSeleccionados.has(g.id);
        const catLabel = CAT_LABELS[g.categoria] || g.categoria || '';
        const imp = parseFloat(g.importe) || 0;
        return `<div class="reparto-gasto-row ${checked ? 'selected' : ''}" onclick="toggleGastoReparto('${g.id}')">
          <input type="checkbox" class="reparto-gasto-check" ${checked ? 'checked' : ''} onclick="event.stopPropagation(); toggleGastoReparto('${g.id}')">
          <div class="reparto-gasto-info">
            <div class="reparto-gasto-concepto">${g.concepto || '‚Äî'}</div>
            <div class="reparto-gasto-meta">${fD(g.fecha)} ¬∑ ${catLabel}</div>
          </div>
          <span class="reparto-gasto-importe">${fN(imp)} ‚Ç¨</span>
        </div>`;
      }).join('');

      actualizarTotalReparto();
    }

    function toggleGastoReparto(id) {
      if (repartoSeleccionados.has(id)) {
        repartoSeleccionados.delete(id);
      } else {
        repartoSeleccionados.add(id);
      }
      renderRepartoGastos();
    }

    function toggleSelectAll() {
      const allSelected = repartoSeleccionados.size === gastos.length;
      if (allSelected) {
        repartoSeleccionados.clear();
      } else {
        gastos.forEach(g => repartoSeleccionados.add(g.id));
      }
      document.getElementById('select-all-check').checked = !allSelected;
      document.getElementById('select-all-label').textContent = !allSelected ? 'Deseleccionar todos' : 'Seleccionar todos';
      renderRepartoGastos();
    }

    function actualizarTotalReparto() {
      const selGastos = gastos.filter(g => repartoSeleccionados.has(g.id));
      const total = selGastos.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
      document.getElementById('reparto-sel-count').textContent = selGastos.length;
      document.getElementById('reparto-sel-total').textContent = fN(total) + ' ‚Ç¨';
      document.getElementById('btn-crear-reparto').disabled = selGastos.length === 0;

      // Actualizar select-all
      const check = document.getElementById('select-all-check');
      if (check) {
        check.checked = gastos.length > 0 && repartoSeleccionados.size === gastos.length;
        document.getElementById('select-all-label').textContent = check.checked ? 'Deseleccionar todos' : 'Seleccionar todos';
      }
    }

    // ===== REPARTO: HISTORIAL =====
    function renderRepartoHistorial() {
      const container = document.getElementById('reparto-historial-list');
      if (!repartosGuardados.length) {
        container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:0.85rem;">Sin repartos guardados</div>';
        return;
      }

      container.innerHTML = repartosGuardados.map(r => {
        const fecha = r.fechaCreacion?.toDate ? r.fechaCreacion.toDate().toLocaleDateString('es-ES') : '';
        const participantes = (r.participantes || []).map(p =>
          `<span class="reparto-chip">${p.nombre} <span class="reparto-chip-pct">${p.porcentaje}%</span></span>`
        ).join('');

        return `<div class="reparto-card" onclick="editarReparto('${r.id}')">
          <div class="reparto-card-header">
            <span class="reparto-card-nombre">${r.nombre || 'Reparto'}</span>
            <span class="reparto-card-total">${fN(r.totalImporte || 0)} ‚Ç¨</span>
          </div>
          <div class="reparto-card-fecha">${fecha} ¬∑ ${(r.gastosIds || []).length} gastos</div>
          <div class="reparto-card-participantes" style="margin-top:6px;">${participantes}</div>
        </div>`;
      }).join('');
    }

    // ===== REPARTO: MODAL =====
    function abrirModalReparto() {
      if (repartoSeleccionados.size === 0) return;

      editandoRepartoId = null;
      repartoParticipantes = [];
      document.getElementById('modal-reparto-title').textContent = 'üìä Configurar reparto';
      document.getElementById('reparto-nombre').value = '';
      document.getElementById('btn-eliminar-reparto').classList.add('hidden');

      const selGastos = gastos.filter(g => repartoSeleccionados.has(g.id));
      const total = selGastos.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
      document.getElementById('reparto-resumen-gastos').textContent = selGastos.length + ' gastos seleccionados';
      document.getElementById('reparto-modal-total').textContent = fN(total) + ' ‚Ç¨';

      poblarSelectParticipantes();
      renderParticipantesModal();
      document.getElementById('modal-reparto').classList.add('open');
    }

    function editarReparto(id) {
      const r = repartosGuardados.find(x => x.id === id);
      if (!r) return;

      editandoRepartoId = id;
      repartoParticipantes = (r.participantes || []).map(p => ({ ...p }));

      // Seleccionar los gastos del reparto
      repartoSeleccionados.clear();
      (r.gastosIds || []).forEach(gid => repartoSeleccionados.add(gid));
      renderRepartoGastos();

      document.getElementById('modal-reparto-title').textContent = '‚úèÔ∏è Editar reparto';
      document.getElementById('reparto-nombre').value = r.nombre || '';
      document.getElementById('btn-eliminar-reparto').classList.remove('hidden');

      const selGastos = gastos.filter(g => repartoSeleccionados.has(g.id));
      const total = selGastos.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
      document.getElementById('reparto-resumen-gastos').textContent = selGastos.length + ' gastos';
      document.getElementById('reparto-modal-total').textContent = fN(total) + ' ‚Ç¨';

      poblarSelectParticipantes();
      renderParticipantesModal();
      document.getElementById('modal-reparto').classList.add('open');
    }

    function cerrarModalReparto() {
      document.getElementById('modal-reparto').classList.remove('open');
    }

    function poblarSelectParticipantes() {
      const sel = document.getElementById('reparto-add-select');
      const yaIncluidos = new Set(repartoParticipantes.map(p => p.nombre));
      sel.innerHTML = '<option value="">‚Äî Selecciona miembro ‚Äî</option>';

      // Agrupar por nido
      const porNido = {};
      miembrosLista.forEach(m => {
        const nido = m.nido || 'Familia';
        if (!porNido[nido]) porNido[nido] = [];
        porNido[nido].push(m);
      });

      Object.entries(porNido).forEach(([nido, miembros]) => {
        let html = `<optgroup label="üè† ${nido}">`;
        miembros.forEach(m => {
          const disabled = yaIncluidos.has(m.nombre) ? 'disabled' : '';
          html += `<option value="${m.nombre}" ${disabled}>${m.nombre}${disabled ? ' (ya incluido)' : ''}</option>`;
        });
        html += '</optgroup>';
        sel.innerHTML += html;
      });

      // Externos
      if (externosNombres.length) {
        let html = '<optgroup label="üë§ Externos">';
        externosNombres.forEach(e => {
          const disabled = yaIncluidos.has(e.nombre) ? 'disabled' : '';
          html += `<option value="${e.nombre}" ${disabled}>${e.rol} ${e.nombre}${disabled ? ' (ya incluido)' : ''}</option>`;
        });
        html += '</optgroup>';
        sel.innerHTML += html;
      }
    }

    function addParticipante() {
      const sel = document.getElementById('reparto-add-select');
      const nombre = sel.value;
      if (!nombre) return;
      if (repartoParticipantes.find(p => p.nombre === nombre)) return;
      repartoParticipantes.push({ nombre, porcentaje: 0 });
      sel.value = '';
      poblarSelectParticipantes();
      renderParticipantesModal();
    }

    function addParticipanteCustom() {
      const inp = document.getElementById('reparto-add-custom');
      const nombre = inp.value.trim();
      if (!nombre) return;
      if (repartoParticipantes.find(p => p.nombre === nombre)) { alert('Ya est√° a√±adido'); return; }
      repartoParticipantes.push({ nombre, porcentaje: 0 });
      inp.value = '';
      poblarSelectParticipantes();
      renderParticipantesModal();
    }

    function removeParticipante(index) {
      repartoParticipantes.splice(index, 1);
      poblarSelectParticipantes();
      renderParticipantesModal();
    }

    function updatePorcentaje(index, valor) {
      repartoParticipantes[index].porcentaje = parseFloat(valor) || 0;
      actualizarSumReparto();
    }

    function repartoLineal() {
      if (repartoParticipantes.length === 0) return;
      const base = Math.floor(100 / repartoParticipantes.length);
      const resto = 100 - (base * repartoParticipantes.length);
      repartoParticipantes.forEach((p, i) => {
        p.porcentaje = base + (i === 0 ? resto : 0);
      });
      renderParticipantesModal();
    }

    function renderParticipantesModal() {
      const container = document.getElementById('reparto-participantes-list');

      if (repartoParticipantes.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:0.85rem;">A√±ade participantes para configurar el reparto</div>';
        actualizarSumReparto();
        return;
      }

      let html = '<div style="display:flex;justify-content:flex-end;margin-bottom:8px;"><button class="btn btn-secondary btn-sm" onclick="repartoLineal()">‚ÜîÔ∏è Lineal</button></div>';

      repartoParticipantes.forEach((p, i) => {
        html += `<div class="reparto-participante-row">
          <span class="reparto-participante-nombre">${p.nombre}</span>
          <input type="number" class="reparto-participante-pct" value="${p.porcentaje}" min="0" max="100" step="0.5"
            onchange="updatePorcentaje(${i}, this.value)" oninput="updatePorcentaje(${i}, this.value)">
          <span style="font-size:0.85rem;color:var(--text-muted);">%</span>
          <button class="reparto-participante-remove" onclick="removeParticipante(${i})">‚úï</button>
        </div>`;
      });

      container.innerHTML = html;
      actualizarSumReparto();
    }

    function actualizarSumReparto() {
      const total = repartoParticipantes.reduce((s, p) => s + (parseFloat(p.porcentaje) || 0), 0);
      const el = document.getElementById('reparto-sum-pct');
      el.textContent = total.toFixed(1).replace('.0', '') + '%';
      el.className = 'reparto-sum-valor ' + (Math.abs(total - 100) < 0.01 ? 'ok' : 'error');
    }

    // ===== REPARTO: GUARDAR / ELIMINAR =====
    async function guardarReparto() {
      const nombre = document.getElementById('reparto-nombre').value.trim();
      if (!nombre) { alert('Ponle un nombre al reparto'); return; }
      if (repartoParticipantes.length === 0) { alert('A√±ade al menos un participante'); return; }

      const totalPct = repartoParticipantes.reduce((s, p) => s + (parseFloat(p.porcentaje) || 0), 0);
      if (Math.abs(totalPct - 100) > 0.01) {
        alert('Los porcentajes deben sumar exactamente 100%. Ahora suman ' + totalPct.toFixed(1) + '%');
        return;
      }

      const selGastos = gastos.filter(g => repartoSeleccionados.has(g.id));
      const totalImporte = selGastos.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);

      const data = {
        nombre,
        gastosIds: Array.from(repartoSeleccionados),
        totalImporte,
        participantes: repartoParticipantes.map(p => ({
          nombre: p.nombre,
          porcentaje: parseFloat(p.porcentaje) || 0,
          importe: parseFloat(((totalImporte * (parseFloat(p.porcentaje) || 0)) / 100).toFixed(2))
        })),
        fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        const ref = db.collection('bienes').doc(bienId).collection('repartos');
        if (editandoRepartoId) {
          await ref.doc(editandoRepartoId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        cerrarModalReparto();
        await cargarRepartos();
        renderRepartoHistorial();
        alert('‚úÖ Reparto guardado');
      } catch(e) {
        console.error(e);
        alert('Error al guardar: ' + e.message);
      }
    }

    async function eliminarReparto() {
      if (!editandoRepartoId) return;
      if (!confirm('¬øEliminar este reparto?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('repartos').doc(editandoRepartoId).delete();
        cerrarModalReparto();
        await cargarRepartos();
        renderRepartoHistorial();
      } catch(e) { alert('Error: ' + e.message); }
    }

    // ========== PDF DESCARGA DIRECTA ==========
    function generarPDF() {
      const bienNombre = document.getElementById('bien-nombre')?.textContent || 'Bien';
      
      let items = [...gastos];
      const filtCat = document.getElementById('filtro-cat').value;
      const filtMed = document.getElementById('filtro-medio').value;
      const filtAnot = document.getElementById('filtro-anotador').value;
      if (filtCat) items = items.filter(g => g.categoria === filtCat);
      if (filtMed) items = items.filter(g => g.medio === filtMed || g.medioPago === filtMed);
      if (filtAnot) items = items.filter(g => (g.anotador || g.pagadorNombre || '') === filtAnot);
      
      const total = items.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
      const media = items.length > 0 ? total / items.length : 0;
      
      // Agrupar por mes
      const meses = {};
      items.forEach(g => {
        const mes = g.fecha ? g.fecha.substring(0, 7) : 'sin-fecha';
        if (!meses[mes]) meses[mes] = [];
        meses[mes].push(g);
      });
      
      let tablas = '';
      Object.keys(meses).sort().reverse().forEach(mes => {
        const regs = meses[mes];
        const totalMes = regs.reduce((s, g) => s + (parseFloat(g.importe) || 0), 0);
        const mesLabel = mes === 'sin-fecha' ? 'Sin fecha' :
          new Date(mes + '-01').toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        
        let filas = regs.map(g => `<tr>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;font-size:11px;">${g.fecha || '-'}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;">${g.concepto || '-'}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;font-size:11px;">${CAT_LABELS[g.categoria] || g.categoria || '-'}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;font-size:11px;">${g.anotador || g.pagadorNombre || '-'}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #eee;text-align:right;font-weight:600;">${(parseFloat(g.importe) || 0).toFixed(2)} ‚Ç¨</td>
        </tr>`).join('');
        
        tablas += `
          <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;padding:8px 12px;background:#F5F0E8;border-radius:6px;margin-bottom:8px;font-weight:700;font-size:13px;text-transform:capitalize;">
              <span>${mesLabel}</span><span>${totalMes.toFixed(2)} ‚Ç¨</span>
            </div>
            <table style="width:100%;border-collapse:collapse;font-size:12px;">
              <thead><tr style="background:#7A9E7E;color:white;">
                <th style="padding:6px 8px;text-align:left;">Fecha</th>
                <th style="padding:6px 8px;text-align:left;">Concepto</th>
                <th style="padding:6px 8px;text-align:left;">Categor√≠a</th>
                <th style="padding:6px 8px;text-align:left;">Anotador</th>
                <th style="padding:6px 8px;text-align:right;">Importe</th>
              </tr></thead>
              <tbody>${filas}</tbody>
            </table>
          </div>`;
      });
      
      const div = document.createElement('div');
      div.innerHTML = `
        <div style="font-family:Helvetica,Arial,sans-serif;padding:10px;color:#333;">
          <div style="text-align:center;margin-bottom:20px;">
            <h2 style="margin:0;color:#5C7D5F;">üí∂ Gastos</h2>
            <p style="margin:4px 0;color:#888;">${bienNombre}</p>
            <p style="margin:2px 0;font-size:11px;color:#aaa;">${new Date().toLocaleDateString('es-ES')}</p>
          </div>
          <div style="display:flex;gap:30px;justify-content:center;margin-bottom:20px;font-size:13px;">
            <span>Total: <b>${total.toFixed(2)} ‚Ç¨</b></span>
            <span>Registros: <b>${items.length}</b></span>
            <span>Media: <b>${media.toFixed(2)} ‚Ç¨</b></span>
          </div>
          ${tablas || '<p style="text-align:center;color:#aaa;">Sin gastos registrados</p>'}
          <div style="text-align:center;margin-top:30px;font-size:10px;color:#bbb;">FAMILYNK ¬∑ Gastos</div>
        </div>
      `;
      
      html2pdf().set({
        margin: [10, 10, 15, 10],
        filename: 'gastos-' + bienNombre.replace(/[^a-zA-Z0-9]/g, '_') + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).from(div).save();
    }
  </script>
</body>
</html>
