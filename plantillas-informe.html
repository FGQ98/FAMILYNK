<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7A9E7E">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Plantillas de Informe</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--mayordomo);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .header-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--mayordomo);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .bien-nombre {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    .main { max-width: 800px; margin: 0 auto; padding: 24px; }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--cream-dark);
      border-top-color: var(--mayordomo);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    .info-box {
      background: var(--mayordomo-muted);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 20px;
    }
    .info-box h3 {
      font-family: 'Quicksand', sans-serif;
      color: var(--mayordomo);
      margin-bottom: 6px;
      font-size: 1rem;
    }
    .info-box p {
      font-size: 0.85rem;
      color: var(--text-light);
      line-height: 1.5;
    }

    /* Lista de plantillas */
    .plantillas-lista {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .plantilla-card {
      background: var(--white);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
    }
    .plantilla-header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .plantilla-header:hover { background: var(--cream); }
    .plantilla-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .plantilla-icono {
      font-size: 1.5rem;
    }
    .plantilla-nombre {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      color: var(--text);
    }
    .plantilla-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .plantilla-actions {
      display: flex;
      gap: 8px;
    }
    .btn-icon {
      background: var(--cream);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .btn-icon:hover { background: var(--cream-dark); }
    .btn-icon.danger:hover { background: #fde8e8; }

    .plantilla-body {
      display: none;
      padding: 0 16px 16px;
      border-top: 1px solid var(--cream-dark);
    }
    .plantilla-card.open .plantilla-body { display: block; }

    /* Apartados dentro de plantilla */
    .apartado-item {
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-top: 12px;
      overflow: hidden;
    }
    .apartado-header {
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--mayordomo);
      color: var(--white);
    }
    .apartado-nombre {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .apartado-lineas {
      padding: 8px 14px;
    }
    .linea-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px dashed var(--cream-dark);
    }
    .linea-item:last-child { border-bottom: none; }
    .linea-texto {
      flex: 1;
      font-size: 0.85rem;
    }
    .linea-eliminar {
      background: none;
      border: none;
      color: var(--error);
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    .linea-eliminar:hover { opacity: 1; }

    .add-linea-form {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .add-linea-form input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
    }
    .add-linea-form button {
      padding: 8px 14px;
      background: var(--sage);
      color: var(--white);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .add-apartado-btn {
      margin-top: 12px;
      padding: 10px;
      width: 100%;
      background: var(--cream-dark);
      border: 2px dashed var(--text-muted);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .add-apartado-btn:hover {
      border-color: var(--mayordomo);
      color: var(--mayordomo);
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }
    .empty-state-icon { font-size: 3rem; margin-bottom: 12px; }

    /* Bot√≥n a√±adir plantilla */
    .btn-add {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--mayordomo);
      color: var(--white);
      border: none;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: var(--shadow-medium);
      transition: transform 0.2s, background 0.2s;
      z-index: 50;
    }
    .btn-add:hover { background: var(--mayordomo-light); transform: scale(1.05); }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: var(--white);
      border-radius: var(--radius-md);
      width: 90%;
      max-width: 450px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s;
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      color: var(--mayordomo);
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }
    .modal-body { padding: 20px; }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--cream-dark);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
    }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--mayordomo); }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary { background: var(--mayordomo); color: var(--white); }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-danger { background: var(--error); color: var(--white); }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
      <div class="header-title">
        üìã Plantillas de Informe
        <span class="bien-nombre" id="bien-nombre">...</span>
      </div>
    </div>
  </header>

  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>

    <div id="content" class="hidden">
      <div class="info-box">
        <h3>üìù Configurar Plantillas de Checklist</h3>
        <p>Crea modelos de informe (check-in, check-out, revisi√≥n...). Cada plantilla tiene apartados (zonas) con l√≠neas que el casero marcar√°.</p>
      </div>

      <div class="plantillas-lista" id="plantillas-lista"></div>

      <div id="empty-state" class="empty-state hidden">
        <div class="empty-state-icon">üìã</div>
        <h3>Sin plantillas</h3>
        <p>Crea tu primera plantilla de informe</p>
      </div>
    </div>
  </main>

  <button class="btn-add" onclick="abrirModalNuevaPlantilla()">+</button>

  <!-- Modal Nueva Plantilla -->
  <div class="modal-overlay" id="modal-plantilla">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-plantilla-titulo">üìã Nueva plantilla</h3>
        <button class="modal-close" onclick="cerrarModalPlantilla()">&times;</button>
      </div>
      <form id="form-plantilla">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre *</label>
            <input type="text" class="form-input" id="plantilla-nombre" required placeholder="Ej: Check-out est√°ndar">
          </div>
          <div class="form-group">
            <label class="form-label">Icono</label>
            <select class="form-select" id="plantilla-icono">
              <option value="üìã">üìã Checklist</option>
              <option value="üö™">üö™ Salida</option>
              <option value="üè†">üè† Entrada</option>
              <option value="üîç">üîç Revisi√≥n</option>
              <option value="‚úÖ">‚úÖ Verificaci√≥n</option>
              <option value="üìù">üìù Informe</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Descripci√≥n</label>
            <input type="text" class="form-input" id="plantilla-descripcion" placeholder="Breve descripci√≥n...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModalPlantilla()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear plantilla</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal A√±adir Apartado -->
  <div class="modal-overlay" id="modal-apartado">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">‚ûï A√±adir apartado (zona)</h3>
        <button class="modal-close" onclick="cerrarModalApartado()">&times;</button>
      </div>
      <form id="form-apartado">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Zona *</label>
            <select class="form-select" id="apartado-zona" required>
              <option value="">Selecciona zona...</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModalApartado()">Cancelar</button>
          <button type="submit" class="btn btn-primary">A√±adir</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let plantillasData = [];
    let zonasData = [];
    let plantillaActual = null; // Para a√±adir apartados

    const params = new URLSearchParams(window.location.search);
    bienId = params.get('id');
    const origen = params.get('origen') || 'bien';

    document.getElementById('btn-volver').href = `${origen}.html?id=${bienId}`;

    if (!bienId) {
      alert('No se especific√≥ el bien');
      window.location.href = 'cgi.html';
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      await cargarDatos();
    });

    async function cargarDatos() {
      try {
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) {
          alert('Bien no encontrado');
          window.location.href = 'cgi.html';
          return;
        }
        bienData = bienDoc.data();
        document.getElementById('bien-nombre').textContent = bienData.nombre || 'Sin nombre';

        // Cargar zonas para el select
        try {
          const zonasSnap = await db.collection('bienes').doc(bienId).collection('zonasLimpieza').get();
          zonasData = zonasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (e) {
          console.log('Error cargando zonas:', e);
        }
        poblarSelectZonas();

        // Cargar plantillas
        const plantillasSnap = await db.collection('bienes').doc(bienId).collection('plantillasInforme').get();
        plantillasData = plantillasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        renderPlantillas();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar: ' + error.message);
      }
    }

    function poblarSelectZonas() {
      const select = document.getElementById('apartado-zona');
      select.innerHTML = '<option value="">Selecciona zona...</option>';
      
      if (zonasData.length === 0) {
        const defaults = ['Cocina', 'Sal√≥n', 'Dormitorio', 'Ba√±o', 'Terraza', 'General'];
        defaults.forEach(z => {
          select.innerHTML += `<option value="${z}">${z}</option>`;
        });
      } else {
        zonasData.forEach(z => {
          select.innerHTML += `<option value="${z.nombre || z.id}">${z.nombre || z.id}</option>`;
        });
      }
    }

    function renderPlantillas() {
      const container = document.getElementById('plantillas-lista');
      const empty = document.getElementById('empty-state');

      if (plantillasData.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');
      container.innerHTML = plantillasData.map((p, pi) => {
        const apartadosHtml = (p.apartados || []).map((apt, ai) => {
          const lineasHtml = (apt.lineas || []).map((linea, li) => `
            <div class="linea-item">
              <span class="linea-texto">‚òê ${linea}</span>
              <button type="button" class="linea-eliminar" onclick="eliminarLinea('${p.id}', ${ai}, ${li})">‚úï</button>
            </div>
          `).join('');

          return `
            <div class="apartado-item">
              <div class="apartado-header">
                <span class="apartado-nombre">${apt.zonaNombre || apt.zona}</span>
                <button type="button" class="btn-icon danger" onclick="eliminarApartado('${p.id}', ${ai})" style="background:transparent;color:white;">‚úï</button>
              </div>
              <div class="apartado-lineas">
                ${lineasHtml || '<p style="color:var(--text-muted);font-size:0.8rem;">Sin l√≠neas</p>'}
                <div class="add-linea-form">
                  <input type="text" id="nueva-linea-${p.id}-${ai}" placeholder="Nueva l√≠nea...">
                  <button type="button" onclick="agregarLinea('${p.id}', ${ai})">+ A√±adir</button>
                </div>
              </div>
            </div>
          `;
        }).join('');

        return `
          <div class="plantilla-card" id="plantilla-${p.id}">
            <div class="plantilla-header" onclick="togglePlantilla('${p.id}')">
              <div class="plantilla-info">
                <span class="plantilla-icono">${p.icono || 'üìã'}</span>
                <div>
                  <div class="plantilla-nombre">${p.nombre}</div>
                  <div class="plantilla-desc">${p.descripcion || ''} ¬∑ ${(p.apartados || []).length} apartados</div>
                </div>
              </div>
              <div class="plantilla-actions" onclick="event.stopPropagation()">
                <button class="btn-icon danger" onclick="eliminarPlantilla('${p.id}')" title="Eliminar">üóëÔ∏è</button>
              </div>
            </div>
            <div class="plantilla-body">
              ${apartadosHtml}
              <button class="add-apartado-btn" onclick="abrirModalApartado('${p.id}')">+ A√±adir apartado (zona)</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function togglePlantilla(id) {
      document.getElementById(`plantilla-${id}`).classList.toggle('open');
    }

    // Modal nueva plantilla
    function abrirModalNuevaPlantilla() {
      document.getElementById('form-plantilla').reset();
      document.getElementById('modal-plantilla').classList.add('active');
    }

    function cerrarModalPlantilla() {
      document.getElementById('modal-plantilla').classList.remove('active');
    }

    document.getElementById('form-plantilla').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const datos = {
        nombre: document.getElementById('plantilla-nombre').value.trim(),
        icono: document.getElementById('plantilla-icono').value,
        descripcion: document.getElementById('plantilla-descripcion').value.trim(),
        apartados: [],
        creadoPor: currentUser.uid,
        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection('bienes').doc(bienId).collection('plantillasInforme').add(datos);
        cerrarModalPlantilla();
        await cargarDatos();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al crear: ' + error.message);
      }
    });

    async function eliminarPlantilla(id) {
      if (!confirm('¬øEliminar esta plantilla?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('plantillasInforme').doc(id).delete();
        await cargarDatos();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar');
      }
    }

    // Modal apartado
    function abrirModalApartado(plantillaId) {
      plantillaActual = plantillaId;
      document.getElementById('apartado-zona').value = '';
      document.getElementById('modal-apartado').classList.add('active');
    }

    function cerrarModalApartado() {
      document.getElementById('modal-apartado').classList.remove('active');
      plantillaActual = null;
    }

    document.getElementById('form-apartado').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!plantillaActual) return;

      const zonaNombre = document.getElementById('apartado-zona').value;
      if (!zonaNombre) return;

      const plantilla = plantillasData.find(p => p.id === plantillaActual);
      if (!plantilla) return;

      const apartados = plantilla.apartados || [];
      apartados.push({ zonaNombre: zonaNombre, lineas: [] });

      try {
        await db.collection('bienes').doc(bienId).collection('plantillasInforme').doc(plantillaActual).update({ apartados });
        cerrarModalApartado();
        await cargarDatos();
        // Mantener abierta la plantilla
        setTimeout(() => document.getElementById(`plantilla-${plantillaActual}`).classList.add('open'), 100);
      } catch (error) {
        console.error('Error:', error);
        alert('Error al a√±adir apartado');
      }
    });

    async function eliminarApartado(plantillaId, apartadoIndex) {
      if (!confirm('¬øEliminar este apartado y todas sus l√≠neas?')) return;
      
      const plantilla = plantillasData.find(p => p.id === plantillaId);
      if (!plantilla) return;

      const apartados = [...(plantilla.apartados || [])];
      apartados.splice(apartadoIndex, 1);

      try {
        await db.collection('bienes').doc(bienId).collection('plantillasInforme').doc(plantillaId).update({ apartados });
        await cargarDatos();
        setTimeout(() => document.getElementById(`plantilla-${plantillaId}`).classList.add('open'), 100);
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar');
      }
    }

    // L√≠neas
    async function agregarLinea(plantillaId, apartadoIndex) {
      const input = document.getElementById(`nueva-linea-${plantillaId}-${apartadoIndex}`);
      const texto = input.value.trim();
      if (!texto) return;

      const plantilla = plantillasData.find(p => p.id === plantillaId);
      if (!plantilla) return;

      const apartados = [...(plantilla.apartados || [])];
      if (!apartados[apartadoIndex].lineas) apartados[apartadoIndex].lineas = [];
      apartados[apartadoIndex].lineas.push(texto);

      try {
        await db.collection('bienes').doc(bienId).collection('plantillasInforme').doc(plantillaId).update({ apartados });
        input.value = '';
        await cargarDatos();
        setTimeout(() => document.getElementById(`plantilla-${plantillaId}`).classList.add('open'), 100);
      } catch (error) {
        console.error('Error:', error);
        alert('Error al a√±adir l√≠nea');
      }
    }

    async function eliminarLinea(plantillaId, apartadoIndex, lineaIndex) {
      const plantilla = plantillasData.find(p => p.id === plantillaId);
      if (!plantilla) return;

      const apartados = [...(plantilla.apartados || [])];
      apartados[apartadoIndex].lineas.splice(lineaIndex, 1);

      try {
        await db.collection('bienes').doc(bienId).collection('plantillasInforme').doc(plantillaId).update({ apartados });
        await cargarDatos();
        setTimeout(() => document.getElementById(`plantilla-${plantillaId}`).classList.add('open'), 100);
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar');
      }
    }
  </script>
</body>
</html>
