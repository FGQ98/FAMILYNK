<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Maquinaria</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage:#7A9E7E; --cream:#FDF8F3; --cream-dark:#F5EDE4; --cream-medium:#FAF5EF;
      --text:#3D3D3D; --text-light:#6B6B6B; --text-muted:#9A9A9A; --white:#FFFFFF;
      --capataz:#6B8E23; --capataz-light:#8FBC3C; --capataz-dark:#4A6B10; --capataz-muted:rgba(107,142,35,0.15);
      --success:#7DB59A; --success-muted:rgba(125,181,154,0.15);
      --warning:#E8B44D; --warning-muted:rgba(232,180,77,0.15);
      --error:#D4695A; --error-muted:rgba(212,105,90,0.15);
      --info:#5B9BD5; --info-muted:rgba(91,155,213,0.15);
      --addon-color:var(--capataz); --addon-light:var(--capataz-light);
      --addon-dark:var(--capataz-dark); --addon-muted:var(--capataz-muted);
      --shadow-soft:0 2px 8px rgba(0,0,0,0.06); --shadow-medium:0 4px 16px rgba(0,0,0,0.08);
      --radius-sm:8px; --radius-md:12px; --radius-lg:16px; --radius-full:50px;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--text);min-height:100vh;}

    .header{background:linear-gradient(135deg,var(--addon-color) 0%,var(--addon-dark) 100%);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow-medium);position:sticky;top:0;z-index:100;}
    .header-left{display:flex;align-items:center;gap:16px;}
    .back-btn{display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.15);border:none;border-radius:var(--radius-md);color:white;font-family:'Nunito';font-size:0.85rem;cursor:pointer;text-decoration:none;transition:all 0.2s;}
    .back-btn:hover{background:rgba(255,255,255,0.25);}
    .header-info h1{color:white;font-family:'Quicksand';font-size:1.2rem;font-weight:700;}
    .header-info p{color:rgba(255,255,255,0.7);font-size:0.8rem;}

    .main{max-width:960px;margin:0 auto;padding:24px;}

    /* Toolbar */
    .toolbar{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center;}
    .search-box{flex:1;min-width:200px;position:relative;}
    .search-box input{width:100%;padding:10px 12px 10px 36px;border:2px solid var(--cream-dark);border-radius:var(--radius-full);font-family:'Nunito';font-size:0.9rem;background:var(--white);}
    .search-box input:focus{outline:none;border-color:var(--addon-color);}
    .search-box::before{content:'üîç';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:0.9rem;}
    .filter-select{padding:10px 14px;border:2px solid var(--cream-dark);border-radius:var(--radius-full);font-family:'Nunito';font-size:0.85rem;background:var(--white);cursor:pointer;}
    .filter-select:focus{outline:none;border-color:var(--addon-color);}

    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border-radius:var(--radius-md);font-family:'Nunito';font-size:0.85rem;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;}
    .btn-addon{background:var(--addon-color);color:white;}
    .btn-addon:hover{background:var(--addon-dark);}
    .btn-secondary{background:var(--cream);color:var(--text);}
    .btn-secondary:hover{background:var(--cream-dark);}
    .btn-danger{background:var(--error);color:white;}
    .btn-sm{padding:7px 12px;font-size:0.8rem;}
    .btn-ghost{background:none;color:var(--text-muted);padding:4px 8px;font-size:0.8rem;border:none;cursor:pointer;}
    .btn-ghost:hover{color:var(--text);background:var(--cream);}

    /* Stats */
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:20px;}
    .stat-card{background:var(--white);border-radius:var(--radius-md);padding:14px 16px;box-shadow:var(--shadow-soft);text-align:center;}
    .stat-value{font-family:'Quicksand';font-weight:700;font-size:1.4rem;color:var(--addon-color);}
    .stat-label{font-size:0.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;}

    /* Grid */
    .maq-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;}
    .maq-card{background:var(--white);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-soft);cursor:pointer;transition:all 0.2s;border:2px solid transparent;}
    .maq-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-medium);border-color:var(--addon-muted);}
    .maq-img{height:140px;background:var(--cream-medium);display:flex;align-items:center;justify-content:center;font-size:3rem;overflow:hidden;position:relative;}
    .maq-img img{width:100%;height:100%;object-fit:cover;}
    .maq-estado{position:absolute;top:8px;right:8px;padding:3px 10px;border-radius:var(--radius-full);font-size:0.7rem;font-weight:600;color:white;}
    .maq-estado.operativa{background:var(--success);}
    .maq-estado.revision{background:var(--warning);}
    .maq-estado.averiada{background:var(--error);}
    .maq-estado.baja{background:var(--text-muted);}
    .maq-body{padding:14px 16px;}
    .maq-nombre{font-family:'Quicksand';font-weight:700;font-size:0.95rem;margin-bottom:2px;}
    .maq-tipo{font-size:0.78rem;color:var(--text-muted);}
    .maq-meta{display:flex;gap:12px;margin-top:8px;font-size:0.75rem;color:var(--text-light);}
    .maq-meta span{display:flex;align-items:center;gap:3px;}
    .maq-alerta{margin-top:8px;padding:6px 10px;border-radius:var(--radius-sm);font-size:0.72rem;font-weight:600;display:flex;align-items:center;gap:4px;}
    .maq-alerta.warning{background:var(--warning-muted);color:#B8860B;}
    .maq-alerta.danger{background:var(--error-muted);color:var(--error);}

    /* Modal */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;align-items:center;justify-content:center;padding:20px;}
    .modal-overlay.active{display:flex;}
    .modal{background:var(--white);border-radius:var(--radius-lg);width:100%;max-width:560px;overflow:hidden;box-shadow:var(--shadow-medium);}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:var(--cream-medium);}
    .modal-title{font-family:'Quicksand';font-size:1rem;font-weight:700;}
    .modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--text-muted);padding:0 4px;}
    .modal-body{padding:20px;max-height:65vh;overflow-y:auto;}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:16px 20px;border-top:1px solid var(--cream-dark);}
    .form-group{margin-bottom:14px;}
    .form-label{display:block;font-size:0.8rem;font-weight:600;margin-bottom:4px;}
    .form-input,.form-select,.form-textarea{width:100%;padding:10px 12px;border:2px solid var(--cream-dark);border-radius:var(--radius-sm);font-family:'Nunito';font-size:0.9rem;background:var(--white);}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--addon-color);}
    .form-textarea{resize:vertical;min-height:60px;}
    .form-hint{font-size:0.72rem;color:var(--text-muted);margin-top:3px;}
    .form-row{display:flex;gap:12px;}
    .form-row .form-group{flex:1;}

    /* Ficha detalle */
    .ficha-section{margin-bottom:20px;}
    .ficha-section-title{font-family:'Quicksand';font-weight:700;font-size:0.85rem;color:var(--addon-color);margin-bottom:10px;padding-bottom:4px;border-bottom:2px solid var(--addon-muted);}
    .ficha-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px;}
    .ficha-field{font-size:0.83rem;}
    .ficha-field-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px;}
    .ficha-field-value{font-weight:600;}

    .empty-state{text-align:center;padding:50px 20px;}
    .empty-state-icon{font-size:3.5rem;opacity:0.3;margin-bottom:12px;}
    .empty-state-title{font-family:'Quicksand';font-weight:700;margin-bottom:8px;}
    .empty-state-text{color:var(--text-muted);font-size:0.9rem;}
    .loading{display:flex;align-items:center;justify-content:center;min-height:200px;}
    .spinner{width:40px;height:40px;border:3px solid var(--cream-dark);border-top-color:var(--addon-color);border-radius:50%;animation:spin 0.8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}

    @media(max-width:600px){
      .form-row{flex-direction:column;gap:0;}
      .maq-grid{grid-template-columns:1fr;}
      .ficha-grid{grid-template-columns:1fr;}
      .stats-row{grid-template-columns:1fr 1fr;}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a id="btn-volver" class="back-btn">‚Üê Volver</a>
      <div class="header-info">
        <h1>üöú Maquinaria</h1>
        <p id="nombre-bien">Cargando...</p>
      </div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-sm" style="background:rgba(255,255,255,0.15);color:white;" onclick="exportarPDF()">üìÑ PDF</button>
      <button class="btn btn-sm" style="background:rgba(255,255,255,0.15);color:white;" onclick="abrirModal()">+ M√°quina</button>
    </div>
  </header>

  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>
    <div id="contenido" style="display:none;">

      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Total</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-operativa" style="color:var(--success)">0</div><div class="stat-label">Operativas</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-revision" style="color:var(--warning)">0</div><div class="stat-label">En revisi√≥n</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-averiada" style="color:var(--error)">0</div><div class="stat-label">Averiadas</div></div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <div class="search-box"><input type="text" id="buscar" placeholder="Buscar m√°quina..." oninput="renderGrid()"></div>
        <select class="filter-select" id="filtro-tipo" onchange="renderGrid()">
          <option value="">Todos los tipos</option>
        </select>
        <select class="filter-select" id="filtro-estado" onchange="renderGrid()">
          <option value="">Todos los estados</option>
          <option value="operativa">‚úÖ Operativa</option>
          <option value="revision">üîß En revisi√≥n</option>
          <option value="averiada">‚ùå Averiada</option>
          <option value="baja">‚è∏Ô∏è Baja</option>
        </select>
      </div>

      <!-- Grid -->
      <div class="maq-grid" id="maq-grid"></div>
      <div id="empty-state" style="display:none;">
        <div class="empty-state">
          <div class="empty-state-icon">üöú</div>
          <div class="empty-state-title">Sin maquinaria</div>
          <div class="empty-state-text">A√±ade tractores, aperos, veh√≠culos y equipos</div>
          <button class="btn btn-addon" style="margin-top:16px;" onclick="abrirModal()">+ Primera m√°quina</button>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== MODAL CREAR/EDITAR ===== -->
  <div class="modal-overlay" id="modal-maq">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="modal-titulo">üöú Nueva m√°quina</h3><button class="modal-close" onclick="cerrarModal()">√ó</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group" style="flex:2;"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="maq-nombre" placeholder="Ej: Tractor John Deere 5075E"></div>
          <div class="form-group" style="flex:0 0 80px;"><label class="form-label">Icono</label><input type="text" class="form-input" id="maq-icono" placeholder="üöú" style="text-align:center;font-size:1.3rem;"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Tipo *</label>
            <select class="form-select" id="maq-tipo">
              <option value="tractor">üöú Tractor</option>
              <option value="apero">‚öôÔ∏è Apero / Implemento</option>
              <option value="vehiculo">üöó Veh√≠culo</option>
              <option value="motosierra">ü™ö Motosierra / Desbrozadora</option>
              <option value="riego">üíß Riego / Bombeo</option>
              <option value="pulverizador">üß™ Pulverizador / Cuba</option>
              <option value="remolque">üöõ Remolque</option>
              <option value="generador">‚ö° Generador</option>
              <option value="herramienta">üîß Herramienta motorizada</option>
              <option value="otro">üì¶ Otro</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">Estado</label>
            <select class="form-select" id="maq-estado">
              <option value="operativa">‚úÖ Operativa</option>
              <option value="revision">üîß En revisi√≥n</option>
              <option value="averiada">‚ùå Averiada</option>
              <option value="baja">‚è∏Ô∏è Baja</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Marca</label><input type="text" class="form-input" id="maq-marca" placeholder="Ej: John Deere"></div>
          <div class="form-group"><label class="form-label">Modelo</label><input type="text" class="form-input" id="maq-modelo" placeholder="Ej: 5075E"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Matr√≠cula / N¬∫ serie</label><input type="text" class="form-input" id="maq-matricula" placeholder=""></div>
          <div class="form-group"><label class="form-label">A√±o adquisici√≥n</label><input type="number" class="form-input" id="maq-anio" placeholder="2020"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Horas / Km</label><input type="number" class="form-input" id="maq-horas" step="0.1" placeholder="0"></div>
          <div class="form-group"><label class="form-label">Unidad medida</label>
            <select class="form-select" id="maq-unidad-horas">
              <option value="horas">Horas</option>
              <option value="km">Km</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Ubicaci√≥n habitual</label><input type="text" class="form-input" id="maq-ubicacion" placeholder="Ej: Nave principal, Parcela 3"></div>
          <div class="form-group"><label class="form-label">Responsable</label><input type="text" class="form-input" id="maq-responsable" placeholder="Ej: Manolo, capataz"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Pr√≥xima revisi√≥n / ITV</label><input type="date" class="form-input" id="maq-revision"></div>
          <div class="form-group"><label class="form-label">Venc. seguro</label><input type="date" class="form-input" id="maq-seguro"></div>
        </div>
        <div class="form-group"><label class="form-label">Notas</label><textarea class="form-textarea" id="maq-notas" placeholder="Observaciones, incidencias conocidas..."></textarea></div>
        <div class="form-group"><label class="form-label">URL foto</label><input type="text" class="form-input" id="maq-foto" placeholder="https://..."></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
        <button class="btn btn-danger btn-sm" id="btn-eliminar" onclick="eliminarMaq()" style="display:none;">Eliminar</button>
        <button class="btn btn-addon" onclick="guardarMaq()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL FICHA ===== -->
  <div class="modal-overlay" id="modal-ficha">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header"><h3 class="modal-title" id="ficha-titulo">üöú Ficha</h3><button class="modal-close" onclick="cerrarFicha()">√ó</button></div>
      <div class="modal-body" id="ficha-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarFicha()">Cerrar</button>
        <button class="btn btn-addon" id="ficha-btn-editar">‚úèÔ∏è Editar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const bienId = params.get('id');
    if (!bienId) { alert('Falta bien'); window.location.href = 'lo-comun.html'; }
    document.getElementById('btn-volver').href = `capataz.html?id=${bienId}`;

    let currentUser = null, maquinas = [], editId = null;

    const TIPOS = {
      tractor:'üöú Tractor', apero:'‚öôÔ∏è Apero', vehiculo:'üöó Veh√≠culo',
      motosierra:'ü™ö Motosierra', riego:'üíß Riego', pulverizador:'üß™ Pulverizador',
      remolque:'üöõ Remolque', generador:'‚ö° Generador', herramienta:'üîß Herramienta', otro:'üì¶ Otro'
    };
    const ESTADOS = { operativa:'‚úÖ Operativa', revision:'üîß En revisi√≥n', averiada:'‚ùå Averiada', baja:'‚è∏Ô∏è Baja' };
    const ICONOS_TIPO = { tractor:'üöú', apero:'‚öôÔ∏è', vehiculo:'üöó', motosierra:'ü™ö', riego:'üíß', pulverizador:'üß™', remolque:'üöõ', generador:'‚ö°', herramienta:'üîß', otro:'üì¶' };

    auth.onAuthStateChanged(async user => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarDatos();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('contenido').style.display = '';
    });

    async function cargarDatos() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (!doc.exists) { alert('Bien no encontrado'); return; }
        document.getElementById('nombre-bien').textContent = doc.data().nombre || '';
        maquinas = doc.data().maquinaria || [];
        actualizarFiltroTipos();
        renderGrid();
      } catch(e) { console.error(e); alert('Error: ' + e.message); }
    }

    async function guardarBD() {
      await db.collection('bienes').doc(bienId).update({ maquinaria: maquinas });
    }

    function actualizarFiltroTipos() {
      const tipos = [...new Set(maquinas.map(m => m.tipo))].sort();
      const sel = document.getElementById('filtro-tipo');
      sel.innerHTML = '<option value="">Todos los tipos</option>' + tipos.map(t => `<option value="${t}">${TIPOS[t]||t}</option>`).join('');
    }

    // ===== RENDER =====
    function renderGrid() {
      const buscar = document.getElementById('buscar').value.toLowerCase();
      const filtroTipo = document.getElementById('filtro-tipo').value;
      const filtroEstado = document.getElementById('filtro-estado').value;

      let items = maquinas.filter(m => {
        if (buscar && !(`${m.nombre} ${m.marca} ${m.modelo} ${m.matricula}`).toLowerCase().includes(buscar)) return false;
        if (filtroTipo && m.tipo !== filtroTipo) return false;
        if (filtroEstado && m.estado !== filtroEstado) return false;
        return true;
      });

      // Stats
      document.getElementById('stat-total').textContent = maquinas.length;
      document.getElementById('stat-operativa').textContent = maquinas.filter(m => m.estado === 'operativa').length;
      document.getElementById('stat-revision').textContent = maquinas.filter(m => m.estado === 'revision').length;
      document.getElementById('stat-averiada').textContent = maquinas.filter(m => m.estado === 'averiada').length;

      const grid = document.getElementById('maq-grid');
      const empty = document.getElementById('empty-state');

      if (!items.length) {
        grid.innerHTML = '';
        empty.style.display = maquinas.length ? 'none' : '';
        if (maquinas.length && !items.length) {
          grid.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted);grid-column:1/-1;">Sin resultados para este filtro</div>';
        }
        return;
      }
      empty.style.display = 'none';

      const hoy = new Date().toISOString().split('T')[0];
      const en30 = new Date(Date.now() + 30*86400000).toISOString().split('T')[0];

      grid.innerHTML = items.map(m => {
        const icono = m.icono || ICONOS_TIPO[m.tipo] || 'üì¶';
        let alerta = '';
        if (m.revision && m.revision <= hoy) alerta = `<div class="maq-alerta danger">‚ö†Ô∏è Revisi√≥n vencida</div>`;
        else if (m.revision && m.revision <= en30) alerta = `<div class="maq-alerta warning">üîî Revisi√≥n pr√≥xima</div>`;
        if (m.seguro && m.seguro <= hoy) alerta += `<div class="maq-alerta danger">‚ö†Ô∏è Seguro vencido</div>`;
        else if (m.seguro && m.seguro <= en30) alerta += `<div class="maq-alerta warning">üîî Seguro por vencer</div>`;

        return `<div class="maq-card" onclick="abrirFicha('${m.id}')">
          <div class="maq-img">${m.foto ? `<img src="${m.foto}" alt="${m.nombre}" onerror="this.parentElement.innerHTML='${icono}'">` : icono}
            <span class="maq-estado ${m.estado}">${ESTADOS[m.estado]||m.estado}</span>
          </div>
          <div class="maq-body">
            <div class="maq-nombre">${m.nombre}</div>
            <div class="maq-tipo">${TIPOS[m.tipo]||m.tipo}${m.marca ? ` ¬∑ ${m.marca}` : ''}${m.modelo ? ` ${m.modelo}` : ''}</div>
            <div class="maq-meta">
              ${m.horas ? `<span>‚è±Ô∏è ${m.horas} ${m.unidadHoras||'h'}</span>` : ''}
              ${m.matricula ? `<span>üî¢ ${m.matricula}</span>` : ''}
              ${m.ubicacion ? `<span>üìç ${m.ubicacion}</span>` : ''}
            </div>
            ${alerta}
          </div>
        </div>`;
      }).join('');
    }

    // ===== FICHA =====
    function abrirFicha(id) {
      const m = maquinas.find(x => x.id === id);
      if (!m) return;
      const icono = m.icono || ICONOS_TIPO[m.tipo] || 'üì¶';
      document.getElementById('ficha-titulo').textContent = `${icono} ${m.nombre}`;
      document.getElementById('ficha-btn-editar').onclick = () => { cerrarFicha(); abrirModal(m); };

      const hoy = new Date().toISOString().split('T')[0];
      const fmtDate = d => d ? new Date(d+'T00:00:00').toLocaleDateString('es-ES') : '‚Äî';
      const alertaRev = m.revision && m.revision <= hoy ? ' <span style="color:var(--error);font-weight:700;">‚ö†Ô∏è VENCIDA</span>' : '';
      const alertaSeg = m.seguro && m.seguro <= hoy ? ' <span style="color:var(--error);font-weight:700;">‚ö†Ô∏è VENCIDO</span>' : '';

      document.getElementById('ficha-body').innerHTML = `
        ${m.foto ? `<div style="border-radius:var(--radius-md);overflow:hidden;margin-bottom:16px;max-height:200px;"><img src="${m.foto}" style="width:100%;object-fit:cover;" onerror="this.parentElement.style.display='none'"></div>` : ''}
        <div class="ficha-section">
          <div class="ficha-section-title">Identificaci√≥n</div>
          <div class="ficha-grid">
            <div class="ficha-field"><div class="ficha-field-label">Tipo</div><div class="ficha-field-value">${TIPOS[m.tipo]||m.tipo}</div></div>
            <div class="ficha-field"><div class="ficha-field-label">Estado</div><div class="ficha-field-value">${ESTADOS[m.estado]||m.estado}</div></div>
            <div class="ficha-field"><div class="ficha-field-label">Marca</div><div class="ficha-field-value">${m.marca||'‚Äî'}</div></div>
            <div class="ficha-field"><div class="ficha-field-label">Modelo</div><div class="ficha-field-value">${m.modelo||'‚Äî'}</div></div>
            <div class="ficha-field"><div class="ficha-field-label">Matr√≠cula / N¬∫ serie</div><div class="ficha-field-value">${m.matricula||'‚Äî'}</div></div>
            <div class="ficha-field"><div class="ficha-field-label">A√±o adquisici√≥n</div><div class="ficha-field-value">${m.anio||'‚Äî'}</div></div>
          </div>
        </div>
        <div class="ficha-section">
          <div class="ficha-section-title">Uso y ubicaci√≥n</div>
          <div class="ficha-grid">
            <div class="ficha-field"><div class="ficha-field-label">${m.unidadHoras === 'km' ? 'Kil√≥metros' : 'Horas de uso'}</div><div class="ficha-field-value">${m.horas ? m.horas.toLocaleString('es-ES') + (m.unidadHoras === 'km' ? ' km' : ' h') : '‚Äî'}</div></div>
            <div class="ficha-field"><div class="ficha-field-label">Ubicaci√≥n</div><div class="ficha-field-value">${m.ubicacion||'‚Äî'}</div></div>
            <div class="ficha-field"><div class="ficha-field-label">Responsable</div><div class="ficha-field-value">${m.responsable||'‚Äî'}</div></div>
          </div>
        </div>
        <div class="ficha-section">
          <div class="ficha-section-title">Documentaci√≥n</div>
          <div class="ficha-grid">
            <div class="ficha-field"><div class="ficha-field-label">Pr√≥xima revisi√≥n / ITV</div><div class="ficha-field-value">${fmtDate(m.revision)}${alertaRev}</div></div>
            <div class="ficha-field"><div class="ficha-field-label">Venc. seguro</div><div class="ficha-field-value">${fmtDate(m.seguro)}${alertaSeg}</div></div>
          </div>
        </div>
        ${m.notas ? `<div class="ficha-section"><div class="ficha-section-title">Notas</div><div style="font-size:0.88rem;color:var(--text-light);white-space:pre-wrap;">${m.notas}</div></div>` : ''}
      `;
      document.getElementById('modal-ficha').classList.add('active');
    }

    function cerrarFicha() { document.getElementById('modal-ficha').classList.remove('active'); }

    // ===== MODAL CRUD =====
    function abrirModal(data) {
      editId = data ? data.id : null;
      document.getElementById('modal-titulo').textContent = data ? '‚úèÔ∏è Editar m√°quina' : 'üöú Nueva m√°quina';
      document.getElementById('btn-eliminar').style.display = data ? '' : 'none';
      document.getElementById('maq-nombre').value = data?.nombre || '';
      document.getElementById('maq-icono').value = data?.icono || '';
      document.getElementById('maq-tipo').value = data?.tipo || 'tractor';
      document.getElementById('maq-estado').value = data?.estado || 'operativa';
      document.getElementById('maq-marca').value = data?.marca || '';
      document.getElementById('maq-modelo').value = data?.modelo || '';
      document.getElementById('maq-matricula').value = data?.matricula || '';
      document.getElementById('maq-anio').value = data?.anio || '';
      document.getElementById('maq-horas').value = data?.horas || '';
      document.getElementById('maq-unidad-horas').value = data?.unidadHoras || 'horas';
      document.getElementById('maq-ubicacion').value = data?.ubicacion || '';
      document.getElementById('maq-responsable').value = data?.responsable || '';
      document.getElementById('maq-revision').value = data?.revision || '';
      document.getElementById('maq-seguro').value = data?.seguro || '';
      document.getElementById('maq-notas').value = data?.notas || '';
      document.getElementById('maq-foto').value = data?.foto || '';
      document.getElementById('modal-maq').classList.add('active');
    }

    function cerrarModal() { document.getElementById('modal-maq').classList.remove('active'); }

    async function guardarMaq() {
      const nombre = document.getElementById('maq-nombre').value.trim();
      if (!nombre) { alert('Nombre obligatorio'); return; }
      const data = {
        nombre,
        icono: document.getElementById('maq-icono').value.trim(),
        tipo: document.getElementById('maq-tipo').value,
        estado: document.getElementById('maq-estado').value,
        marca: document.getElementById('maq-marca').value.trim(),
        modelo: document.getElementById('maq-modelo').value.trim(),
        matricula: document.getElementById('maq-matricula').value.trim(),
        anio: parseInt(document.getElementById('maq-anio').value) || null,
        horas: parseFloat(document.getElementById('maq-horas').value) || null,
        unidadHoras: document.getElementById('maq-unidad-horas').value,
        ubicacion: document.getElementById('maq-ubicacion').value.trim(),
        responsable: document.getElementById('maq-responsable').value.trim(),
        revision: document.getElementById('maq-revision').value || null,
        seguro: document.getElementById('maq-seguro').value || null,
        notas: document.getElementById('maq-notas').value.trim(),
        foto: document.getElementById('maq-foto').value.trim()
      };
      if (editId) {
        const idx = maquinas.findIndex(m => m.id === editId);
        if (idx >= 0) Object.assign(maquinas[idx], data);
      } else {
        maquinas.push({ id: 'maq_' + Date.now(), ...data });
      }
      await guardarBD();
      cerrarModal();
      actualizarFiltroTipos();
      renderGrid();
    }

    async function eliminarMaq() {
      if (!editId || !confirm('¬øEliminar esta m√°quina?')) return;
      maquinas = maquinas.filter(m => m.id !== editId);
      await guardarBD();
      cerrarModal();
      actualizarFiltroTipos();
      renderGrid();
    }

    // ===== PDF =====
    function exportarPDF() {
      if (!maquinas.length) { alert('Sin maquinaria'); return; }
      const ac = '#6B8E23';
      let rows = '';
      maquinas.forEach(m => {
        rows += `<tr>
          <td style="padding:6px 10px;font-weight:600;">${m.icono || ICONOS_TIPO[m.tipo] || 'üì¶'} ${m.nombre}</td>
          <td style="padding:6px 10px;">${TIPOS[m.tipo]||m.tipo}</td>
          <td style="padding:6px 10px;">${m.marca||''} ${m.modelo||''}</td>
          <td style="padding:6px 10px;">${m.matricula||'‚Äî'}</td>
          <td style="padding:6px 10px;">${ESTADOS[m.estado]||m.estado}</td>
          <td style="padding:6px 10px;text-align:right;">${m.horas ? m.horas + (m.unidadHoras==='km'?' km':' h') : '‚Äî'}</td>
          <td style="padding:6px 10px;">${m.ubicacion||'‚Äî'}</td>
        </tr>`;
      });
      const pdf = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Maquinaria</title>
<style>@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Nunito',sans-serif;color:#3D3D3D;padding:40px;max-width:1100px;margin:0 auto}
table{width:100%;border-collapse:collapse}th{font-size:0.72rem;text-transform:uppercase;color:#9A9A9A;border-bottom:2px solid #F5EDE4;text-align:left;padding:8px 10px;}
td{border-bottom:1px solid #F5EDE4;font-size:0.82rem}
@media print{body{padding:20px}}</style></head><body>
<div style="display:flex;justify-content:space-between;margin-bottom:24px;padding-bottom:14px;border-bottom:3px solid ${ac};">
  <div><h1 style="font-family:'Quicksand';font-size:1.4rem;color:${ac};">üöú MAQUINARIA</h1>
  <div style="font-size:0.85rem;color:#6B6B6B;">${document.getElementById('nombre-bien').textContent}</div></div>
  <div style="text-align:right;font-size:0.85rem;color:#6B6B6B;">${new Date().toLocaleDateString('es-ES')}<br>${maquinas.length} m√°quinas</div>
</div>
<table><thead><tr><th>Nombre</th><th>Tipo</th><th>Marca/Modelo</th><th>Matr√≠cula</th><th>Estado</th><th style="text-align:right">Uso</th><th>Ubicaci√≥n</th></tr></thead>
<tbody>${rows}</tbody></table>
<div style="margin-top:40px;text-align:center;font-size:0.7rem;color:#9A9A9A;">FAMILYNK ¬∑ ${new Date().toLocaleDateString('es-ES')}</div>
<script>window.onload=()=>window.print();<\/script></body></html>`;
      const w = window.open('','_blank'); w.document.write(pdf); w.document.close();
    }
  </script>
</body>
</html>
