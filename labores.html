<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Labores</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage:#7A9E7E; --cream:#FDF8F3; --cream-dark:#F5EDE4; --cream-medium:#FAF5EF;
      --text:#3D3D3D; --text-light:#6B6B6B; --text-muted:#9A9A9A; --white:#FFFFFF;
      --capataz:#6B8E23; --capataz-light:#8FBC3C; --capataz-dark:#4A6B10; --capataz-muted:rgba(107,142,35,0.15);
      --success:#7DB59A; --success-muted:rgba(125,181,154,0.15);
      --warning:#E8B44D; --warning-muted:rgba(232,180,77,0.15);
      --error:#D4695A; --error-muted:rgba(212,105,90,0.15);
      --addon-color:var(--capataz); --addon-dark:var(--capataz-dark); --addon-muted:var(--capataz-muted);
      --shadow-soft:0 2px 8px rgba(0,0,0,0.06); --shadow-medium:0 4px 16px rgba(0,0,0,0.08);
      --radius-sm:8px; --radius-md:12px; --radius-lg:16px; --radius-full:50px;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--text);min-height:100vh;}

    /* Header */
    .header{background:linear-gradient(135deg,var(--addon-color) 0%,var(--addon-dark) 100%);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow-medium);position:sticky;top:0;z-index:100;}
    .header-left{display:flex;align-items:center;gap:16px;}
    .back-btn{display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.15);border:none;border-radius:var(--radius-md);color:white;font-family:'Nunito';font-size:0.85rem;cursor:pointer;text-decoration:none;transition:all 0.2s;}
    .back-btn:hover{background:rgba(255,255,255,0.25);}
    .header-info h1{color:white;font-family:'Quicksand';font-size:1.2rem;font-weight:700;}
    .header-info p{color:rgba(255,255,255,0.7);font-size:0.8rem;}

    .main{max-width:960px;margin:0 auto;padding:24px;}

    /* Tabs */
    .tabs{display:flex;gap:4px;background:var(--white);border-radius:var(--radius-full);padding:4px;box-shadow:var(--shadow-soft);margin-bottom:24px;}
    .tab{flex:1;padding:10px 16px;border:none;background:none;font-family:'Quicksand';font-size:0.85rem;font-weight:600;cursor:pointer;border-radius:var(--radius-full);color:var(--text-muted);transition:all 0.2s;text-align:center;}
    .tab.active{background:var(--addon-color);color:white;}
    .tab:not(.active):hover{background:var(--cream);color:var(--text);}
    .tab-panel{display:none;}
    .tab-panel.active{display:block;}

    /* Buttons */
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border-radius:var(--radius-md);font-family:'Nunito';font-size:0.85rem;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;}
    .btn-addon{background:var(--addon-color);color:white;}
    .btn-addon:hover{background:var(--addon-dark);}
    .btn-secondary{background:var(--cream);color:var(--text);}
    .btn-secondary:hover{background:var(--cream-dark);}
    .btn-danger{background:var(--error);color:white;}
    .btn-sm{padding:7px 12px;font-size:0.8rem;}
    .btn-ghost{background:none;color:var(--text-muted);padding:6px 10px;font-size:0.8rem;border:none;cursor:pointer;border-radius:var(--radius-sm);}
    .btn-ghost:hover{color:var(--text);background:var(--cream);}

    /* Cards */
    .labor-card{background:var(--white);border-radius:var(--radius-lg);padding:18px 20px;box-shadow:var(--shadow-soft);margin-bottom:12px;cursor:pointer;transition:all 0.2s;border-left:4px solid var(--addon-color);}
    .labor-card:hover{box-shadow:var(--shadow-medium);transform:translateY(-1px);}
    .labor-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
    .labor-card-nombre{font-family:'Quicksand';font-weight:700;font-size:1rem;display:flex;align-items:center;gap:8px;}
    .labor-card-badge{padding:3px 10px;border-radius:var(--radius-full);font-size:0.7rem;font-weight:600;}
    .badge-externo{background:var(--warning-muted);color:#B8860B;}
    .badge-propio{background:var(--success-muted);color:#2D7A4F;}
    .labor-card-detalle{display:flex;gap:16px;flex-wrap:wrap;font-size:0.8rem;color:var(--text-light);}
    .labor-card-detalle span{display:flex;align-items:center;gap:4px;}

    /* Plan table */
    .plan-table{width:100%;border-collapse:separate;border-spacing:0;background:var(--white);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-soft);}
    .plan-table th{background:var(--cream-medium);padding:10px 14px;text-align:left;font-size:0.72rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);font-weight:600;border-bottom:2px solid var(--cream-dark);}
    .plan-table td{padding:10px 14px;border-bottom:1px solid var(--cream-dark);font-size:0.85rem;vertical-align:middle;}
    .plan-table tr:last-child td{border-bottom:none;}
    .plan-table tr:hover td{background:var(--cream-medium);}
    .plan-table .plan-labor{font-weight:600;}
    .plan-table .plan-parcela{color:var(--addon-color);font-weight:600;}
    .plan-freq{display:inline-block;padding:2px 8px;border-radius:var(--radius-full);font-size:0.72rem;font-weight:600;background:var(--addon-muted);color:var(--addon-dark);}
    .plan-actions{display:flex;gap:4px;}

    /* Modal */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;align-items:center;justify-content:center;padding:20px;}
    .modal-overlay.active{display:flex;}
    .modal{background:var(--white);border-radius:var(--radius-lg);width:100%;max-width:560px;overflow:hidden;box-shadow:var(--shadow-medium);}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:var(--cream-medium);}
    .modal-title{font-family:'Quicksand';font-size:1rem;font-weight:700;}
    .modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--text-muted);padding:0 4px;}
    .modal-body{padding:20px;max-height:65vh;overflow-y:auto;}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:16px 20px;border-top:1px solid var(--cream-dark);}
    .form-group{margin-bottom:14px;}
    .form-label{display:block;font-size:0.8rem;font-weight:600;margin-bottom:4px;}
    .form-input,.form-select,.form-textarea{width:100%;padding:10px 12px;border:2px solid var(--cream-dark);border-radius:var(--radius-sm);font-family:'Nunito';font-size:0.9rem;background:var(--white);}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--addon-color);}
    .form-textarea{resize:vertical;min-height:50px;}
    .form-hint{font-size:0.72rem;color:var(--text-muted);margin-top:3px;}
    .form-row{display:flex;gap:12px;}
    .form-row .form-group{flex:1;}

    /* Ejecuci√≥n toggle */
    .ejecucion-toggle{display:flex;gap:4px;background:var(--cream);border-radius:var(--radius-full);padding:3px;margin-bottom:14px;}
    .ejecucion-btn{flex:1;padding:8px;border:none;background:none;font-family:'Nunito';font-size:0.82rem;font-weight:600;cursor:pointer;border-radius:var(--radius-full);color:var(--text-muted);transition:all 0.2s;text-align:center;}
    .ejecucion-btn.active-ext{background:var(--warning);color:white;}
    .ejecucion-btn.active-prop{background:var(--success);color:white;}
    .ejecucion-panel{display:none;background:var(--cream-medium);padding:14px;border-radius:var(--radius-md);margin-bottom:14px;}
    .ejecucion-panel.active{display:block;}

    .toolbar-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;}

    .empty-state{text-align:center;padding:50px 20px;}
    .empty-icon{font-size:3.5rem;opacity:0.3;margin-bottom:12px;}
    .empty-title{font-family:'Quicksand';font-weight:700;margin-bottom:8px;}
    .empty-text{color:var(--text-muted);font-size:0.9rem;}
    .loading{display:flex;align-items:center;justify-content:center;min-height:200px;}
    .spinner{width:40px;height:40px;border:3px solid var(--cream-dark);border-top-color:var(--addon-color);border-radius:50%;animation:spin 0.8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}

    @media(max-width:600px){
      .form-row{flex-direction:column;gap:0;}
      .tabs{flex-direction:column;border-radius:var(--radius-md);}
      .tab{border-radius:var(--radius-md);}
      .plan-table{font-size:0.8rem;}
      .plan-table th,.plan-table td{padding:8px 10px;}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a id="btn-volver" class="back-btn">‚Üê Volver</a>
      <div class="header-info">
        <h1>üåæ Labores</h1>
        <p id="nombre-bien">Cargando...</p>
      </div>
    </div>
    <button class="btn btn-sm" style="background:rgba(255,255,255,0.15);color:white;" onclick="exportarPDF()">üìÑ PDF</button>
  </header>

  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>

    <div id="contenido" style="display:none;">
      <div class="tabs">
        <button class="tab active" onclick="cambiarTab('catalogo')">üìã Cat√°logo de labores</button>
        <button class="tab" onclick="cambiarTab('plan')">üìÖ Plan de trabajo</button>
      </div>

      <!-- ===== TAB 1: CAT√ÅLOGO DE LABORES ===== -->
      <div class="tab-panel active" id="panel-catalogo">
        <div class="toolbar-top">
          <div><span style="font-size:0.85rem;color:var(--text-light);">Define cada tipo de labor y su forma de ejecuci√≥n</span></div>
          <button class="btn btn-addon" onclick="abrirModalLabor()">+ Nueva labor</button>
        </div>
        <div id="lista-labores"></div>
        <div id="empty-labores" style="display:none;">
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <div class="empty-title">Sin labores definidas</div>
            <div class="empty-text">Crea el cat√°logo de labores: arar, podar, tratar, regar...</div>
            <button class="btn btn-addon" style="margin-top:14px;" onclick="abrirModalLabor()">+ Primera labor</button>
          </div>
        </div>
      </div>

      <!-- ===== TAB 2: PLAN DE TRABAJO ===== -->
      <div class="tab-panel" id="panel-plan">
        <div class="toolbar-top">
          <div><span style="font-size:0.85rem;color:var(--text-light);">Programa labores por parcela, frecuencia y fecha de inicio</span></div>
          <button class="btn btn-addon" onclick="abrirModalPlan()">+ A√±adir al plan</button>
        </div>
        <div id="tabla-plan-wrap"></div>
        <div id="empty-plan" style="display:none;">
          <div class="empty-state">
            <div class="empty-icon">üìÖ</div>
            <div class="empty-title">Plan vac√≠o</div>
            <div class="empty-text">Asigna labores a parcelas con frecuencia y fecha de inicio</div>
            <button class="btn btn-addon" style="margin-top:14px;" onclick="abrirModalPlan()">+ Planificar</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== MODAL LABOR (cat√°logo) ===== -->
  <div class="modal-overlay" id="modal-labor">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="ml-titulo">üìã Nueva labor</h3><button class="modal-close" onclick="cerrarModales()">√ó</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group" style="flex:2;"><label class="form-label">Nombre de la labor *</label><input type="text" class="form-input" id="lab-nombre" placeholder="Ej: Arar, Podar olivos, Tratamiento fitosanitario"></div>
          <div class="form-group" style="flex:0 0 70px;"><label class="form-label">Icono</label><input type="text" class="form-input" id="lab-icono" placeholder="üåæ" style="text-align:center;font-size:1.3rem;"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Maquinaria</label>
          <select class="form-select" id="lab-maquinaria">
            <option value="">Sin maquinaria asignada</option>
          </select>
          <div class="form-hint">Selecciona del cat√°logo de maquinaria de la finca</div>
        </div>

        <label class="form-label">Ejecuci√≥n</label>
        <div class="ejecucion-toggle">
          <button type="button" class="ejecucion-btn active-ext" id="btn-ext" onclick="setEjecucion('externo')">üèóÔ∏è Externalizado</button>
          <button type="button" class="ejecucion-btn" id="btn-prop" onclick="setEjecucion('propio')">üë∑ Propios medios</button>
        </div>

        <!-- Panel Externalizado -->
        <div class="ejecucion-panel active" id="panel-externo">
          <div class="form-row">
            <div class="form-group"><label class="form-label">Precio (‚Ç¨)</label><input type="number" class="form-input" id="lab-ext-precio" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label class="form-label">Plazo (d√≠as)</label><input type="number" class="form-input" id="lab-ext-plazo" placeholder="Ej: 3"></div>
          </div>
          <div class="form-group" style="margin-bottom:0;"><label class="form-label">Proveedor / Contacto</label><input type="text" class="form-input" id="lab-ext-proveedor" placeholder="Nombre, tel√©fono..."></div>
        </div>

        <!-- Panel Propios Medios -->
        <div class="ejecucion-panel" id="panel-propio">
          <div class="form-row">
            <div class="form-group"><label class="form-label">Tiempo por hect√°rea</label><input type="number" class="form-input" id="lab-prop-tiempo" step="0.1" placeholder="horas/ha"></div>
            <div class="form-group"><label class="form-label">Consumo gasoil</label><input type="number" class="form-input" id="lab-prop-gasoil" step="0.1" placeholder="litros/ha"></div>
          </div>
          <div class="form-group" style="margin-bottom:0;"><label class="form-label">Otros consumibles</label><input type="text" class="form-input" id="lab-prop-consumibles" placeholder="Ej: 2 kg abono/ha, 1 l herbicida/ha..."></div>
        </div>

        <div class="form-group"><label class="form-label">Notas</label><textarea class="form-textarea" id="lab-notas" placeholder="Observaciones, precauciones, detalles t√©cnicos..."></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm" id="btn-elim-labor" onclick="eliminarLabor()" style="display:none;">Eliminar</button>
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-addon" onclick="guardarLabor()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL PLAN ===== -->
  <div class="modal-overlay" id="modal-plan">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="mp-titulo">üìÖ A√±adir al plan</h3><button class="modal-close" onclick="cerrarModales()">√ó</button></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Parcela *</label>
          <select class="form-select" id="plan-parcela" required><option value="">Selecciona parcela...</option></select>
        </div>
        <div class="form-group">
          <label class="form-label">Labor *</label>
          <select class="form-select" id="plan-labor" required><option value="">Selecciona labor...</option></select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Frecuencia *</label>
            <select class="form-select" id="plan-frecuencia" required>
              <option value="puntual">üìå Puntual</option>
              <option value="semanal">üîÑ Semanal</option>
              <option value="quincenal">üîÑ Quincenal</option>
              <option value="mensual">üìÖ Mensual</option>
              <option value="bimensual">üìÖ Bimensual</option>
              <option value="trimestral">üìÖ Trimestral</option>
              <option value="semestral">üìÖ Semestral</option>
              <option value="anual">üìÖ Anual</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Primera vez *</label>
            <input type="date" class="form-input" id="plan-fecha" required>
          </div>
        </div>
        <div class="form-group"><label class="form-label">Notas</label><textarea class="form-textarea" id="plan-notas" placeholder="Condiciones, prioridad, dependencias..."></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm" id="btn-elim-plan" onclick="eliminarPlan()" style="display:none;">Eliminar</button>
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-addon" onclick="guardarPlan()">Guardar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const bienId = params.get('id');
    const tabInicial = params.get('tab');
    if (!bienId) { alert('Falta bien'); window.location.href = 'lo-comun.html'; }
    document.getElementById('btn-volver').href = `capataz.html?id=${bienId}`;

    let currentUser = null;
    let catalogoLabores = [];  // Firestore: bienes/{id}.laboresCatalogo[]
    let planTrabajo = [];      // Firestore: bienes/{id}.laboresPlan[]
    let parcelas = [];         // Subcollection: bienes/{id}/parcelas
    let maquinas = [];         // Field: bienes/{id}.maquinaria[]
    let editLaborId = null;
    let editPlanId = null;

    const FRECUENCIAS = {
      puntual:'üìå Puntual', semanal:'üîÑ Semanal', quincenal:'üîÑ Quincenal',
      mensual:'üìÖ Mensual', bimensual:'üìÖ Bimensual', trimestral:'üìÖ Trimestral',
      semestral:'üìÖ Semestral', anual:'üìÖ Anual'
    };

    // ===== AUTH =====
    auth.onAuthStateChanged(async user => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarDatos();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('contenido').style.display = '';
      if (tabInicial === 'plan') cambiarTab('plan');
    });

    // ===== DATA =====
    async function cargarDatos() {
      try {
        const [bienDoc, parcelasSnap] = await Promise.all([
          db.collection('bienes').doc(bienId).get(),
          db.collection('bienes').doc(bienId).collection('parcelas').orderBy('nombre').get()
        ]);
        if (!bienDoc.exists) { alert('Bien no encontrado'); return; }
        const data = bienDoc.data();
        document.getElementById('nombre-bien').textContent = data.nombre || '';
        catalogoLabores = data.laboresCatalogo || [];
        planTrabajo = data.laboresPlan || [];
        maquinas = data.maquinaria || [];
        parcelas = parcelasSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderCatalogo();
        renderPlan();
      } catch(e) { console.error(e); alert('Error cargando datos: ' + e.message); }
    }

    async function guardarBD(campo, valor) {
      await db.collection('bienes').doc(bienId).update({ [campo]: valor });
    }

    // ===== TABS =====
    function cambiarTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`panel-${tab}`).classList.add('active');
    }

    // ===== EJECUCI√ìN TOGGLE =====
    function setEjecucion(tipo) {
      document.getElementById('btn-ext').className = 'ejecucion-btn' + (tipo === 'externo' ? ' active-ext' : '');
      document.getElementById('btn-prop').className = 'ejecucion-btn' + (tipo === 'propio' ? ' active-prop' : '');
      document.getElementById('panel-externo').classList.toggle('active', tipo === 'externo');
      document.getElementById('panel-propio').classList.toggle('active', tipo === 'propio');
    }

    // ================================================
    //  TAB 1: CAT√ÅLOGO DE LABORES
    // ================================================
    function renderCatalogo() {
      const lista = document.getElementById('lista-labores');
      const empty = document.getElementById('empty-labores');
      if (!catalogoLabores.length) { lista.innerHTML = ''; empty.style.display = ''; return; }
      empty.style.display = 'none';

      lista.innerHTML = catalogoLabores.map(l => {
        const icono = l.icono || 'üåæ';
        const esExterno = l.ejecucion === 'externo';
        const maq = maquinas.find(m => m.id === l.maquinariaId);
        return `<div class="labor-card" onclick="editarLabor('${l.id}')">
          <div class="labor-card-header">
            <div class="labor-card-nombre">${icono} ${l.nombre}</div>
            <span class="labor-card-badge ${esExterno ? 'badge-externo' : 'badge-propio'}">${esExterno ? 'üèóÔ∏è Externalizado' : 'üë∑ Propios medios'}</span>
          </div>
          <div class="labor-card-detalle">
            ${maq ? `<span>üöú ${maq.nombre}</span>` : ''}
            ${esExterno && l.precio ? `<span>üí∞ ${fN(l.precio)} ‚Ç¨</span>` : ''}
            ${esExterno && l.plazo ? `<span>üìÖ ${l.plazo} d√≠as</span>` : ''}
            ${esExterno && l.proveedor ? `<span>üèóÔ∏è ${l.proveedor}</span>` : ''}
            ${!esExterno && l.tiempoHa ? `<span>‚è±Ô∏è ${l.tiempoHa} h/ha</span>` : ''}
            ${!esExterno && l.gasoilHa ? `<span>‚õΩ ${l.gasoilHa} l/ha</span>` : ''}
            ${!esExterno && l.consumibles ? `<span>üì¶ ${l.consumibles}</span>` : ''}
          </div>
        </div>`;
      }).join('');
    }

    function fN(n) { return Number(n).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function poblarSelectMaquinaria() {
      const sel = document.getElementById('lab-maquinaria');
      sel.innerHTML = '<option value="">Sin maquinaria asignada</option>' +
        maquinas.filter(m => m.estado !== 'baja').map(m => {
          const ic = m.icono || 'üöú';
          return `<option value="${m.id}">${ic} ${m.nombre}${m.marca ? ' ‚Äî '+m.marca : ''}</option>`;
        }).join('');
    }

    function abrirModalLabor(data) {
      editLaborId = data ? data.id : null;
      document.getElementById('ml-titulo').textContent = data ? '‚úèÔ∏è Editar labor' : 'üìã Nueva labor';
      document.getElementById('btn-elim-labor').style.display = data ? '' : 'none';
      poblarSelectMaquinaria();
      document.getElementById('lab-nombre').value = data?.nombre || '';
      document.getElementById('lab-icono').value = data?.icono || '';
      document.getElementById('lab-maquinaria').value = data?.maquinariaId || '';
      document.getElementById('lab-ext-precio').value = data?.precio || '';
      document.getElementById('lab-ext-plazo').value = data?.plazo || '';
      document.getElementById('lab-ext-proveedor').value = data?.proveedor || '';
      document.getElementById('lab-prop-tiempo').value = data?.tiempoHa || '';
      document.getElementById('lab-prop-gasoil').value = data?.gasoilHa || '';
      document.getElementById('lab-prop-consumibles').value = data?.consumibles || '';
      document.getElementById('lab-notas').value = data?.notas || '';
      setEjecucion(data?.ejecucion || 'externo');
      document.getElementById('modal-labor').classList.add('active');
    }

    function editarLabor(id) {
      const l = catalogoLabores.find(x => x.id === id);
      if (l) abrirModalLabor(l);
    }

    async function guardarLabor() {
      const nombre = document.getElementById('lab-nombre').value.trim();
      if (!nombre) { alert('Nombre obligatorio'); return; }
      const esExterno = document.getElementById('btn-ext').classList.contains('active-ext');
      const data = {
        nombre,
        icono: document.getElementById('lab-icono').value.trim(),
        maquinariaId: document.getElementById('lab-maquinaria').value,
        ejecucion: esExterno ? 'externo' : 'propio',
        precio: esExterno ? parseFloat(document.getElementById('lab-ext-precio').value) || null : null,
        plazo: esExterno ? parseInt(document.getElementById('lab-ext-plazo').value) || null : null,
        proveedor: esExterno ? document.getElementById('lab-ext-proveedor').value.trim() : '',
        tiempoHa: !esExterno ? parseFloat(document.getElementById('lab-prop-tiempo').value) || null : null,
        gasoilHa: !esExterno ? parseFloat(document.getElementById('lab-prop-gasoil').value) || null : null,
        consumibles: !esExterno ? document.getElementById('lab-prop-consumibles').value.trim() : '',
        notas: document.getElementById('lab-notas').value.trim()
      };
      if (editLaborId) {
        const idx = catalogoLabores.findIndex(x => x.id === editLaborId);
        if (idx >= 0) Object.assign(catalogoLabores[idx], data);
      } else {
        catalogoLabores.push({ id: 'lab_' + Date.now(), ...data });
      }
      await guardarBD('laboresCatalogo', catalogoLabores);
      cerrarModales();
      renderCatalogo();
    }

    async function eliminarLabor() {
      if (!editLaborId || !confirm('¬øEliminar esta labor del cat√°logo?')) return;
      catalogoLabores = catalogoLabores.filter(x => x.id !== editLaborId);
      await guardarBD('laboresCatalogo', catalogoLabores);
      cerrarModales();
      renderCatalogo();
    }

    // ================================================
    //  TAB 2: PLAN DE TRABAJO
    // ================================================
    function renderPlan() {
      const wrap = document.getElementById('tabla-plan-wrap');
      const empty = document.getElementById('empty-plan');
      if (!planTrabajo.length) { wrap.innerHTML = ''; empty.style.display = ''; return; }
      empty.style.display = 'none';

      // Ordenar por parcela, luego por fecha
      const sorted = [...planTrabajo].sort((a, b) => {
        const pa = parcelas.find(p => p.id === a.parcelaId)?.nombre || '';
        const pb = parcelas.find(p => p.id === b.parcelaId)?.nombre || '';
        return pa.localeCompare(pb) || (a.fecha || '').localeCompare(b.fecha || '');
      });

      let rows = '';
      sorted.forEach(p => {
        const parcela = parcelas.find(x => x.id === p.parcelaId);
        const labor = catalogoLabores.find(x => x.id === p.laborId);
        const fmtDate = p.fecha ? new Date(p.fecha + 'T00:00:00').toLocaleDateString('es-ES') : '‚Äî';
        rows += `<tr style="cursor:pointer;" onclick="editarPlan('${p.id}')">
          <td class="plan-parcela">${parcela ? parcela.nombre : '(parcela eliminada)'}</td>
          <td class="plan-labor">${labor ? (labor.icono||'üåæ')+' '+labor.nombre : '(labor eliminada)'}</td>
          <td><span class="plan-freq">${FRECUENCIAS[p.frecuencia]||p.frecuencia}</span></td>
          <td>${fmtDate}</td>
          <td style="color:var(--text-muted);font-size:0.8rem;">${p.notas||''}</td>
        </tr>`;
      });

      wrap.innerHTML = `<table class="plan-table">
        <thead><tr><th>Parcela</th><th>Labor</th><th>Frecuencia</th><th>Primera vez</th><th>Notas</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    function poblarSelectsPlan() {
      const sp = document.getElementById('plan-parcela');
      sp.innerHTML = '<option value="">Selecciona parcela...</option>' +
        parcelas.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
      const sl = document.getElementById('plan-labor');
      sl.innerHTML = '<option value="">Selecciona labor...</option>' +
        catalogoLabores.map(l => `<option value="${l.id}">${l.icono||'üåæ'} ${l.nombre}</option>`).join('');
    }

    function abrirModalPlan(data) {
      editPlanId = data ? data.id : null;
      document.getElementById('mp-titulo').textContent = data ? '‚úèÔ∏è Editar entrada' : 'üìÖ A√±adir al plan';
      document.getElementById('btn-elim-plan').style.display = data ? '' : 'none';
      poblarSelectsPlan();
      document.getElementById('plan-parcela').value = data?.parcelaId || '';
      document.getElementById('plan-labor').value = data?.laborId || '';
      document.getElementById('plan-frecuencia').value = data?.frecuencia || 'puntual';
      document.getElementById('plan-fecha').value = data?.fecha || '';
      document.getElementById('plan-notas').value = data?.notas || '';
      document.getElementById('modal-plan').classList.add('active');
    }

    function editarPlan(id) {
      const p = planTrabajo.find(x => x.id === id);
      if (p) abrirModalPlan(p);
    }

    async function guardarPlan() {
      const parcelaId = document.getElementById('plan-parcela').value;
      const laborId = document.getElementById('plan-labor').value;
      const fecha = document.getElementById('plan-fecha').value;
      if (!parcelaId || !laborId || !fecha) { alert('Parcela, labor y fecha son obligatorios'); return; }
      const data = {
        parcelaId,
        laborId,
        frecuencia: document.getElementById('plan-frecuencia').value,
        fecha,
        notas: document.getElementById('plan-notas').value.trim()
      };
      if (editPlanId) {
        const idx = planTrabajo.findIndex(x => x.id === editPlanId);
        if (idx >= 0) Object.assign(planTrabajo[idx], data);
      } else {
        planTrabajo.push({ id: 'plan_' + Date.now(), ...data });
      }
      await guardarBD('laboresPlan', planTrabajo);
      cerrarModales();
      renderPlan();
    }

    async function eliminarPlan() {
      if (!editPlanId || !confirm('¬øEliminar del plan?')) return;
      planTrabajo = planTrabajo.filter(x => x.id !== editPlanId);
      await guardarBD('laboresPlan', planTrabajo);
      cerrarModales();
      renderPlan();
    }

    // ===== MODALES =====
    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    }

    // ===== PDF =====
    function exportarPDF() {
      if (!catalogoLabores.length && !planTrabajo.length) { alert('Sin datos'); return; }
      const ac = '#6B8E23';

      // Cat√°logo
      let catRows = '';
      catalogoLabores.forEach(l => {
        const maq = maquinas.find(m => m.id === l.maquinariaId);
        const esExt = l.ejecucion === 'externo';
        catRows += `<tr>
          <td style="padding:6px 10px;font-weight:600;">${l.icono||'üåæ'} ${l.nombre}</td>
          <td style="padding:6px 10px;">${maq ? maq.nombre : '‚Äî'}</td>
          <td style="padding:6px 10px;">${esExt ? 'üèóÔ∏è Externalizado' : 'üë∑ Propios medios'}</td>
          <td style="padding:6px 10px;">${esExt ? (l.precio ? fN(l.precio)+' ‚Ç¨' : '‚Äî') : (l.tiempoHa ? l.tiempoHa+' h/ha' : '‚Äî')}</td>
          <td style="padding:6px 10px;">${esExt ? (l.plazo ? l.plazo+' d√≠as' : '‚Äî') : (l.gasoilHa ? l.gasoilHa+' l/ha' : '‚Äî')}</td>
        </tr>`;
      });

      // Plan
      let planRows = '';
      planTrabajo.forEach(p => {
        const parcela = parcelas.find(x => x.id === p.parcelaId);
        const labor = catalogoLabores.find(x => x.id === p.laborId);
        const fmtDate = p.fecha ? new Date(p.fecha + 'T00:00:00').toLocaleDateString('es-ES') : '‚Äî';
        planRows += `<tr>
          <td style="padding:6px 10px;font-weight:600;">${parcela?.nombre||'‚Äî'}</td>
          <td style="padding:6px 10px;">${labor ? (labor.icono||'üåæ')+' '+labor.nombre : '‚Äî'}</td>
          <td style="padding:6px 10px;">${FRECUENCIAS[p.frecuencia]||p.frecuencia}</td>
          <td style="padding:6px 10px;">${fmtDate}</td>
          <td style="padding:6px 10px;font-size:0.8rem;">${p.notas||''}</td>
        </tr>`;
      });

      const pdf = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Labores</title>
<style>@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Nunito',sans-serif;color:#3D3D3D;padding:40px;max-width:1100px;margin:0 auto}
table{width:100%;border-collapse:collapse;margin-bottom:30px}th{font-size:0.72rem;text-transform:uppercase;color:#9A9A9A;border-bottom:2px solid #F5EDE4;text-align:left;padding:8px 10px}
td{border-bottom:1px solid #F5EDE4;font-size:0.82rem}h2{font-family:'Quicksand';color:${ac};font-size:1.1rem;margin:24px 0 12px;padding-bottom:6px;border-bottom:2px solid rgba(107,142,35,0.2)}
@media print{body{padding:20px}}</style></head><body>
<div style="display:flex;justify-content:space-between;margin-bottom:24px;padding-bottom:14px;border-bottom:3px solid ${ac};">
  <div><h1 style="font-family:'Quicksand';font-size:1.4rem;color:${ac};">üåæ LABORES</h1>
  <div style="font-size:0.85rem;color:#6B6B6B;">${document.getElementById('nombre-bien').textContent}</div></div>
  <div style="text-align:right;font-size:0.85rem;color:#6B6B6B;">${new Date().toLocaleDateString('es-ES')}</div>
</div>
${catalogoLabores.length ? `<h2>üìã Cat√°logo de labores</h2>
<table><thead><tr><th>Labor</th><th>Maquinaria</th><th>Ejecuci√≥n</th><th>Coste / Tiempo</th><th>Plazo / Gasoil</th></tr></thead><tbody>${catRows}</tbody></table>` : ''}
${planTrabajo.length ? `<h2>üìÖ Plan de trabajo</h2>
<table><thead><tr><th>Parcela</th><th>Labor</th><th>Frecuencia</th><th>Primera vez</th><th>Notas</th></tr></thead><tbody>${planRows}</tbody></table>` : ''}
<div style="margin-top:40px;text-align:center;font-size:0.7rem;color:#9A9A9A;">FAMILYNK ¬∑ ${new Date().toLocaleDateString('es-ES')}</div>
<script>window.onload=()=>window.print();<\/script></body></html>`;
      const w = window.open('', '_blank'); w.document.write(pdf); w.document.close();
    }
  </script>
</body>
</html>
