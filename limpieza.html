<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Limpieza</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--mayordomo);
      color: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--white);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Quicksand', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .header-title span { font-size: 1.5rem; }

    .header-bien {
      font-size: 0.85rem;
      opacity: 0.85;
      margin-left: 8px;
    }

    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--mayordomo);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* Grid de cards */
    .modulos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .modulo-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    .modulo-card:hover {
      box-shadow: var(--shadow-medium);
      transform: translateY(-2px);
    }

    .modulo-card-header {
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      color: var(--white);
    }

    .modulo-card-icon {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .modulo-card-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.15rem;
      font-weight: 600;
    }

    .modulo-card-body {
      padding: 20px;
    }

    .modulo-card-desc {
      color: var(--text-light);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .modulo-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
    }

    .modulo-stat {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .modulo-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'Quicksand', sans-serif;
    }

    .modulo-stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .modulo-card-action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--mayordomo);
      font-weight: 600;
      font-size: 0.9rem;
      text-decoration: none;
      transition: all 0.2s;
    }
    .modulo-card-action:hover {
      gap: 10px;
    }

    /* Card Lavander√≠a */
    .modulo-card.lavanderia .modulo-card-header { background: linear-gradient(135deg, #6B8E8E 0%, #507878 100%); }
    .modulo-card.lavanderia:hover { border-color: #6B8E8E; }
    .modulo-card.lavanderia .modulo-stat-value { color: #507878; }

    /* Card Tareas Limpieza */
    .modulo-card.tareas .modulo-card-header { background: linear-gradient(135deg, #7A9E7E 0%, #5C7D5F 100%); }
    .modulo-card.tareas:hover { border-color: #7A9E7E; }
    .modulo-card.tareas .modulo-stat-value { color: #5C7D5F; }

    /* Card Plan Semanal */
    .modulo-card.plan-semanal .modulo-card-header { background: linear-gradient(135deg, #8B7355 0%, #6B5A45 100%); }
    .modulo-card.plan-semanal:hover { border-color: #8B7355; }
    .modulo-card.plan-semanal .modulo-stat-value { color: #6B5A45; }

    /* Card Limpieza Programada */
    .modulo-card.programada .modulo-card-header { background: linear-gradient(135deg, #9B7EB8 0%, #7A5F96 100%); }
    .modulo-card.programada:hover { border-color: #9B7EB8; }
    .modulo-card.programada .modulo-stat-value { color: #7A5F96; }

    /* Cards interactivas con tareas */
    .plan-card-content { padding: 12px 16px; max-height: 280px; overflow-y: auto; }
    .plan-tarea {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      border-left: 3px solid var(--mayordomo);
      transition: all 0.2s;
    }
    .plan-tarea:hover { background: var(--cream-dark); }
    .plan-tarea.hoy { border-left-color: var(--warning); background: #fffbf5; }
    .plan-tarea.completada { opacity: 0.6; background: #f0f0f0; border-left-color: var(--success); }
    .plan-tarea.completada .plan-tarea-titulo { text-decoration: line-through; color: var(--text-muted); }
    .plan-tarea-check { width: 20px; height: 20px; cursor: pointer; accent-color: var(--mayordomo); }
    .plan-tarea-info { flex: 1; }
    .plan-tarea-titulo { font-weight: 600; font-size: 0.85rem; }
    .plan-tarea-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 10px; margin-top: 2px; }
    .plan-tarea-dia { 
      background: var(--mayordomo-muted); 
      color: var(--mayordomo); 
      padding: 2px 6px; 
      border-radius: 4px; 
      font-size: 0.7rem; 
      font-weight: 600; 
    }
    .plan-tarea.lavanderia { border-left-color: #6B8E8E; }
    .plan-tarea.lavanderia .plan-tarea-dia { background: rgba(107, 142, 142, 0.15); color: #507878; }
    .plan-tarea.limpieza { border-left-color: var(--sage); }
    .plan-tarea.limpieza .plan-tarea-dia { background: var(--sage-muted); color: var(--sage-dark); }
    .plan-empty { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; }
    .plan-empty a { color: var(--mayordomo); }
    .plan-progreso {
      height: 6px;
      background: var(--cream-dark);
      border-radius: 3px;
      margin: 0 16px 12px;
      overflow: hidden;
    }
    .plan-progreso-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--mayordomo) 0%, var(--success) 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
      .modulos-grid { grid-template-columns: 1fr; }
      .main { padding: 16px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
    <div class="header-title">
      <span>üßπ</span>
      Limpieza
      <span class="header-bien" id="nombre-bien"></span>
    </div>
  </header>

  <main class="main">
    <div class="loading" id="loading"><div class="spinner"></div></div>

    <div id="content" class="hidden">
      <div class="modulos-grid">
        <!-- Lavander√≠a -->
        <div class="modulo-card lavanderia">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üëï</div>
            <div class="modulo-card-title">Lavander√≠a</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Gesti√≥n de lavados, ropa pendiente y ciclos de lavadora/secadora.</p>
            <div class="modulo-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-pendientes">0</span>
                <span class="modulo-stat-label">pendientes</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-completados">0</span>
                <span class="modulo-stat-label">completados</span>
              </div>
            </div>
            <a href="#" class="modulo-card-action" id="link-lavanderia">Ver lavander√≠a ‚Üí</a>
          </div>
        </div>

        <!-- Zonas y Tareas -->
        <div class="modulo-card tareas">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üè†</div>
            <div class="modulo-card-title">Zonas y Tareas</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Organiza las zonas del bien y configura tareas por tipo de dependencia.</p>
            <div class="modulo-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-zonas">0</span>
                <span class="modulo-stat-label">zonas</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-tareas">0</span>
                <span class="modulo-stat-label">tareas</span>
              </div>
            </div>
            <a href="#" class="modulo-card-action" id="link-tareas">Gestionar ‚Üí</a>
          </div>
        </div>

        <!-- Plan Semanal -->
        <div class="modulo-card plan-semanal" id="card-plan-semanal">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üìÖ</div>
            <div class="modulo-card-title">Plan Semanal</div>
          </div>
          <div class="plan-progreso">
            <div class="plan-progreso-bar" id="progreso-semanal" style="width: 0%"></div>
          </div>
          <div class="plan-card-content" id="tareas-semanales">
            <div class="plan-empty">Cargando...</div>
          </div>
        </div>

        <!-- Limpieza Programada -->
        <div class="modulo-card programada" id="card-programada">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üìã</div>
            <div class="modulo-card-title">Limpieza Programada</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Tareas recurrentes de limpieza profunda y mantenimiento peri√≥dico.</p>
            <div class="modulo-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-programadas">0</span>
                <span class="modulo-stat-label">tareas</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-frecuencias">0</span>
                <span class="modulo-stat-label">frecuencias</span>
              </div>
            </div>
            <a href="#" class="modulo-card-action" id="link-programada">Gestionar ‚Üí</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <!-- Sistema de permisos CVEB para externos -->
  <script src="permisos-externos.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let origen = 'bien';

    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    origen = urlParams.get('origen') || 'bien';

    // Configurar bot√≥n volver
    document.getElementById('btn-volver').href = origen === 'mayordomo' 
      ? `mayordomo.html?bien=${bienId}` 
      : origen === 'casero'
      ? `casero.html`
      : `bien.html?id=${bienId}`;

    // Configurar links de cards
    document.getElementById('link-lavanderia').href = `lavanderia.html?id=${bienId}&origen=limpieza`;
    document.getElementById('link-tareas').href = `zonas-tareas.html?id=${bienId}&origen=limpieza`;
    document.getElementById('link-programada').href = `limpieza-programada.html?id=${bienId}&origen=limpieza`;

    if (!bienId) window.location.href = 'lo-comun.html';

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      
      // Verificar si es externo y cargar permisos
      await PermisosExt.init(db, user, bienId);
      
      await cargarDatos();
      
      // Aplicar permisos CVEB si es externo
      if (PermisosExt.esExterno) {
        aplicarPermisosCards();
      }
      
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    });

    // Aplicar permisos a los enlaces de cards seg√∫n acceso
    function aplicarPermisosCards() {
      // Card Lavander√≠a
      if (!PermisosExt.puede('limpieza_lavanderia', 'v')) {
        const card = document.querySelector('.modulo-card.lavanderia');
        if (card) card.style.display = 'none';
      }
      
      // Card Zonas y Tareas
      if (!PermisosExt.puede('limpieza_zonasTareas', 'v')) {
        const card = document.querySelector('.modulo-card.tareas');
        if (card) card.style.display = 'none';
      }
      
      // Card Plan Semanal (interactivo)
      if (!PermisosExt.puede('limpieza_planSemanal', 'v')) {
        const card = document.getElementById('card-plan-semanal');
        if (card) card.style.display = 'none';
      } else if (!PermisosExt.puede('limpieza_planSemanal', 'e')) {
        // Solo ver, deshabilitar checkboxes
        document.querySelectorAll('#tareas-semanales input[type="checkbox"]').forEach(cb => {
          cb.disabled = true;
          cb.style.cursor = 'not-allowed';
        });
      }
      
      // Card Limpieza Programada (si existe)
      if (!PermisosExt.puede('limpieza_programada', 'v')) {
        const card = document.querySelector('.modulo-card.programada');
        if (card) card.style.display = 'none';
      }
    }

    async function cargarDatos() {
      try {
        // Cargar datos del bien
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) {
          alert('Bien no encontrado');
          window.location.href = 'lo-comun.html';
          return;
        }
        bienData = { id: bienDoc.id, ...bienDoc.data() };
        document.getElementById('nombre-bien').textContent = `¬∑ ${bienData.nombre || 'Sin nombre'}`;

        // Cargar stats de zonas/tareas
        await cargarStatsZonas();

        // Cargar stats lavander√≠a
        await cargarStatsLavanderia();

        // Cargar stats limpieza programada
        await cargarStatsProgramadas();

        // Cargar plan semanal
        await cargarPlanSemanal();

      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }

    async function cargarStatsZonas() {
      try {
        // Contar zonas
        const zonasSnap = await db.collection('bienes').doc(bienId).collection('zonasLimpieza').get();
        let totalZonas = zonasSnap.docs.length;
        
        // Contar tareas activas configuradas por tipo
        let totalTareas = 0;
        const configDoc = await db.collection('bienes').doc(bienId).collection('configLimpieza').doc('tareasPorTipo').get();
        if (configDoc.exists) {
          const config = configDoc.data();
          for (const tipo of Object.values(config)) {
            if (Array.isArray(tipo)) {
              totalTareas += tipo.filter(t => t.activo).length;
            }
          }
        }

        document.getElementById('stat-zonas').textContent = totalZonas;
        document.getElementById('stat-tareas').textContent = totalTareas;
      } catch (error) {
        console.log('Error cargando stats zonas:', error);
      }
    }

    async function cargarStatsLavanderia() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('lavanderia')
          .where('completado', '==', false).get();
        const completadosSnap = await db.collection('bienes').doc(bienId).collection('lavanderia')
          .where('completado', '==', true).get();
        
        document.getElementById('stat-pendientes').textContent = snap.docs.length;
        document.getElementById('stat-completados').textContent = completadosSnap.docs.length;
      } catch (error) {
        document.getElementById('stat-pendientes').textContent = '0';
        document.getElementById('stat-completados').textContent = '0';
      }
    }

    async function cargarStatsProgramadas() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('limpiezaProgramada').get();
        const tareas = snap.docs.map(d => d.data());
        
        // Contar tareas
        document.getElementById('stat-programadas').textContent = tareas.length;
        
        // Contar frecuencias √∫nicas
        const frecuencias = new Set(tareas.map(t => t.frecuencia || t.dia));
        document.getElementById('stat-frecuencias').textContent = frecuencias.size;
      } catch (error) {
        document.getElementById('stat-programadas').textContent = '0';
        document.getElementById('stat-frecuencias').textContent = '0';
      }
    }

    // ========== PLAN SEMANAL COMBINADO (LIMPIEZA + LAVANDER√çA) ==========
    let planSemanalData = [];
    let completadosData = {};
    let semanaKeyActual = '';

    const TAREAS_INFO = {
      barrer: { nombre: 'Barrer', icon: 'üßπ' },
      fregar: { nombre: 'Fregar', icon: 'ü™£' },
      desinfectar: { nombre: 'Desinfectar', icon: 'üß¥' },
      limpiar: { nombre: 'Limpiar superficies', icon: 'üßΩ' },
      sabanas: { nombre: 'Cambiar s√°banas', icon: 'üõèÔ∏è' },
      ropa: { nombre: 'Recoger ropa', icon: 'üëï' },
      consumibles: { nombre: 'Reponer consumibles', icon: 'üßª' },
      encendidos: { nombre: 'Revisar encendidos', icon: 'üí°' },
      grifos: { nombre: 'Revisar grifos', icon: 'üöø' },
      cristales: { nombre: 'Hacer cristales', icon: 'ü™ü' }
    };

    const TIPOS_DEP = {
      dormitorio: { icon: 'üõèÔ∏è', label: 'Dormitorio' },
      servicio: { icon: 'üöø', label: 'Servicio' },
      aseo: { icon: 'üöΩ', label: 'Aseo' },
      vestuario: { icon: 'üëî', label: 'Vestuario' },
      cocina: { icon: 'üç≥', label: 'Cocina' },
      salon: { icon: 'üõãÔ∏è', label: 'Sal√≥n' },
      comedor: { icon: 'üçΩÔ∏è', label: 'Comedor' },
      almacen: { icon: 'üì¶', label: 'Almac√©n' },
      camara: { icon: '‚ùÑÔ∏è', label: 'C√°mara' },
      taller: { icon: 'üîß', label: 'Taller' },
      instalacion: { icon: '‚ö°', label: 'Cuarto Instalaci√≥n' },
      porche: { icon: 'üåø', label: 'Porche' },
      otro: { icon: 'üè†', label: 'Otro' }
    };

    async function cargarPlanSemanal() {
      const container = document.getElementById('tareas-semanales');
      const progresoBar = document.getElementById('progreso-semanal');
      
      try {
        const hoy = new Date();
        const hoyNum = hoy.getDay();
        const inicioSemana = new Date(hoy);
        inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1);
        inicioSemana.setHours(0, 0, 0, 0);
        semanaKeyActual = inicioSemana.toISOString().split('T')[0];

        planSemanalData = [];

        // 1. Cargar zonas y configuraci√≥n de tareas
        const zonasSnap = await db.collection('bienes').doc(bienId).collection('zonasLimpieza').get();
        const configDoc = await db.collection('bienes').doc(bienId).collection('configLimpieza').doc('tareasPorTipo').get();
        const tareasConfig = configDoc.exists ? configDoc.data() : {};

        // Generar tareas basadas en zonas + config
        zonasSnap.docs.forEach(doc => {
          const zona = { id: doc.id, ...doc.data() };
          const deps = zona.dependencias || {};
          
          // Por cada tipo de dependencia en la zona
          for (const [tipoKey, cantidad] of Object.entries(deps)) {
            if (cantidad > 0 && tareasConfig[tipoKey]) {
              const tareasDelTipo = tareasConfig[tipoKey].filter(t => t.activo);
              
              tareasDelTipo.forEach(tareaConfig => {
                const tareaInfo = TAREAS_INFO[tareaConfig.tareaId];
                if (!tareaInfo) return;
                
                // Seg√∫n frecuencia, asignar d√≠as
                if (tareaConfig.frecuencia === 'diario') {
                  for (let d = 1; d <= 6; d++) {
                    planSemanalData.push({
                      id: `lim_${zona.id}_${tipoKey}_${tareaConfig.tareaId}_${d}`,
                      tipo: 'limpieza',
                      nombre: tareaInfo.nombre,
                      zona: `${zona.nombre} - ${TIPOS_DEP[tipoKey]?.label || tipoKey}`,
                      zonaIcon: tareaInfo.icon,
                      dia: d.toString(),
                      tiempo: 15
                    });
                  }
                } else if (tareaConfig.frecuencia === 'semanal') {
                  // Asignar un d√≠a fijo basado en hash simple
                  const diaHash = (zona.id.charCodeAt(0) + tipoKey.charCodeAt(0) + tareaConfig.tareaId.charCodeAt(0)) % 6 + 1;
                  planSemanalData.push({
                    id: `lim_${zona.id}_${tipoKey}_${tareaConfig.tareaId}`,
                    tipo: 'limpieza',
                    nombre: tareaInfo.nombre,
                    zona: `${zona.nombre} - ${TIPOS_DEP[tipoKey]?.label || tipoKey}`,
                    zonaIcon: tareaInfo.icon,
                    dia: diaHash.toString(),
                    tiempo: 15
                  });
                }
                // Mensual no se muestra en plan semanal
              });
            }
          }
        });

        // 2. Cargar prendas de LAVANDER√çA
        const lavanderiaSnap = await db.collection('bienes').doc(bienId).collection('lavanderia').get();
        lavanderiaSnap.docs.forEach(doc => {
          const prenda = { id: doc.id, ...doc.data() };
          // Solo incluir prendas con d√≠a asignado (semanal/quincenal)
          if (prenda.dia && (prenda.frecuencia === 'semanal' || prenda.frecuencia === 'quincenal')) {
            planSemanalData.push({
              id: `lav_${prenda.id}`,
              tipo: 'lavanderia',
              nombre: prenda.nombre,
              zona: prenda.lugar === 'tintoreria' ? 'Tintorer√≠a' : 'En casa',
              zonaIcon: prenda.lugar === 'tintoreria' ? 'üß∫' : 'üëï',
              dia: prenda.dia,
              tiempo: 30, // Tiempo estimado para lavander√≠a
              notas: prenda.notas,
              procesos: [
                prenda.lavado ? 'üßº' : '',
                prenda.secado ? '‚òÄÔ∏è' : '',
                prenda.planchado ? 'üëî' : ''
              ].filter(Boolean).join(' ')
            });
          }
        });

        // 3. Cargar estado de completados de esta semana
        try {
          const completadosDoc = await db.collection('bienes').doc(bienId)
            .collection('planSemanalCompletados').doc(semanaKeyActual).get();
          if (completadosDoc.exists) {
            completadosData = completadosDoc.data().tareas || {};
          }
        } catch (e) {}

        // 4. Marcar completadas
        planSemanalData = planSemanalData.map(tarea => ({
          ...tarea,
          completada: !!completadosData[tarea.id]
        }));

        // 5. Ordenar por d√≠a
        planSemanalData.sort((a, b) => {
          const diaA = parseInt(a.dia);
          const diaB = parseInt(b.dia);
          return (diaA === 0 ? 7 : diaA) - (diaB === 0 ? 7 : diaB);
        });

        renderPlanSemanal();
        
      } catch (error) {
        console.log('Error cargando plan semanal:', error);
        container.innerHTML = '<div class="plan-empty">Error cargando plan</div>';
      }
    }

    function renderPlanSemanal() {
      const container = document.getElementById('tareas-semanales');
      const progresoBar = document.getElementById('progreso-semanal');
      const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      const hoyNum = new Date().getDay();

      if (planSemanalData.length === 0) {
        container.innerHTML = `
          <div class="plan-empty">
            üìÖ Sin tareas programadas esta semana<br>
            <small>Configura tareas en <a href="zonas-tareas.html?id=${bienId}">Zonas y Tareas</a> o <a href="lavanderia.html?id=${bienId}">Lavander√≠a</a></small>
          </div>
        `;
        progresoBar.style.width = '0%';
        return;
      }

      const completadas = planSemanalData.filter(t => t.completada).length;
      const total = planSemanalData.length;
      const progreso = Math.round((completadas / total) * 100);
      progresoBar.style.width = progreso + '%';

      let html = planSemanalData.map(t => {
        const diaNum = parseInt(t.dia);
        const diaStr = diasSemana[diaNum];
        const esHoy = diaNum === hoyNum;
        const completada = t.completada ? 'completada' : '';
        const tipoClass = t.tipo === 'lavanderia' ? 'lavanderia' : 'limpieza';
        const tipoIcon = t.tipo === 'lavanderia' ? 'üëï' : 'üßπ';

        return `
          <div class="plan-tarea ${completada} ${esHoy ? 'hoy' : ''} ${tipoClass}">
            <input type="checkbox" class="plan-tarea-check" 
              ${t.completada ? 'checked' : ''} 
              onchange="toggleTarea('${t.id}', this.checked)">
            <div class="plan-tarea-info">
              <div class="plan-tarea-titulo">${tipoIcon} ${t.nombre}</div>
              <div class="plan-tarea-meta">
                <span class="plan-tarea-dia">${diaStr}</span>
                <span>${t.zonaIcon} ${t.zona}</span>
                ${t.procesos ? `<span>${t.procesos}</span>` : ''}
                <span>‚è±Ô∏è ${t.tiempo}m</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    async function toggleTarea(tareaId, completada) {
      try {
        const docRef = db.collection('bienes').doc(bienId)
          .collection('planSemanalCompletados').doc(semanaKeyActual);
        
        if (completada) {
          await docRef.set({
            [`tareas.${tareaId}`]: {
              completada: true,
              fechaCompletado: new Date().toISOString(),
              completadoPor: currentUser.uid
            }
          }, { merge: true });
        } else {
          await docRef.set({
            [`tareas.${tareaId}`]: firebase.firestore.FieldValue.delete()
          }, { merge: true });
        }
        
        const tarea = planSemanalData.find(t => t.id === tareaId);
        if (tarea) tarea.completada = completada;
        renderPlanSemanal();
      } catch (error) {
        console.error('Error actualizando tarea:', error);
      }
    }
  </script>
</body>
</html>
