<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK â€” Limpieza</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--mayordomo);
      color: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--white);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Quicksand', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .header-title span { font-size: 1.5rem; }

    .header-bien {
      font-size: 0.85rem;
      opacity: 0.85;
      margin-left: 8px;
    }

    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--mayordomo);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* Grid de cards */
    .modulos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .modulo-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    .modulo-card:hover {
      box-shadow: var(--shadow-medium);
      transform: translateY(-2px);
    }

    .modulo-card-header {
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      color: var(--white);
    }

    .modulo-card-icon {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .modulo-card-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.15rem;
      font-weight: 600;
    }

    .modulo-card-body {
      padding: 20px;
    }

    .modulo-card-desc {
      color: var(--text-light);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .modulo-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
    }

    .modulo-stat {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .modulo-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'Quicksand', sans-serif;
    }

    .modulo-stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .modulo-card-action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--mayordomo);
      font-weight: 600;
      font-size: 0.9rem;
      text-decoration: none;
      transition: all 0.2s;
    }
    .modulo-card-action:hover {
      gap: 10px;
    }

    /* Card LavanderÃ­a */
    .modulo-card.lavanderia .modulo-card-header { background: linear-gradient(135deg, #6B8E8E 0%, #507878 100%); }
    .modulo-card.lavanderia:hover { border-color: #6B8E8E; }
    .modulo-card.lavanderia .modulo-stat-value { color: #507878; }

    /* Card Tareas Limpieza */
    .modulo-card.tareas .modulo-card-header { background: linear-gradient(135deg, #7A9E7E 0%, #5C7D5F 100%); }
    .modulo-card.tareas:hover { border-color: #7A9E7E; }
    .modulo-card.tareas .modulo-stat-value { color: #5C7D5F; }

    /* Card Plan Semanal */
    .modulo-card.plan-semanal .modulo-card-header { background: linear-gradient(135deg, #8B7355 0%, #6B5A45 100%); }
    .modulo-card.plan-semanal:hover { border-color: #8B7355; }
    .modulo-card.plan-semanal .modulo-stat-value { color: #6B5A45; }

    /* Cards interactivas con tareas */
    .plan-card-content { padding: 12px 16px; max-height: 280px; overflow-y: auto; }
    .plan-tarea {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      border-left: 3px solid var(--mayordomo);
      transition: all 0.2s;
    }
    .plan-tarea:hover { background: var(--cream-dark); }
    .plan-tarea.hoy { border-left-color: var(--warning); background: #fffbf5; }
    .plan-tarea.completada { opacity: 0.6; background: #f0f0f0; border-left-color: var(--success); }
    .plan-tarea.completada .plan-tarea-titulo { text-decoration: line-through; color: var(--text-muted); }
    .plan-tarea-check { width: 20px; height: 20px; cursor: pointer; accent-color: var(--mayordomo); }
    .plan-tarea-info { flex: 1; }
    .plan-tarea-titulo { font-weight: 600; font-size: 0.85rem; }
    .plan-tarea-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 10px; margin-top: 2px; }
    .plan-tarea-dia { 
      background: var(--mayordomo-muted); 
      color: var(--mayordomo); 
      padding: 2px 6px; 
      border-radius: 4px; 
      font-size: 0.7rem; 
      font-weight: 600; 
    }
    .plan-empty { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; }
    .plan-progreso {
      height: 6px;
      background: var(--cream-dark);
      border-radius: 3px;
      margin: 0 16px 12px;
      overflow: hidden;
    }
    .plan-progreso-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--mayordomo) 0%, var(--success) 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
      .modulos-grid { grid-template-columns: 1fr; }
      .main { padding: 16px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="#" class="back-btn" id="btn-volver">â† Volver</a>
    <div class="header-title">
      <span>ğŸ§¹</span>
      Limpieza
      <span class="header-bien" id="nombre-bien"></span>
    </div>
  </header>

  <main class="main">
    <div class="loading" id="loading"><div class="spinner"></div></div>

    <div id="content" class="hidden">
      <div class="modulos-grid">
        <!-- LavanderÃ­a -->
        <div class="modulo-card lavanderia">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">ğŸ‘•</div>
            <div class="modulo-card-title">LavanderÃ­a</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">GestiÃ³n de lavados, ropa pendiente y ciclos de lavadora/secadora.</p>
            <div class="modulo-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-pendientes">0</span>
                <span class="modulo-stat-label">pendientes</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-completados">0</span>
                <span class="modulo-stat-label">completados</span>
              </div>
            </div>
            <a href="#" class="modulo-card-action" id="link-lavanderia">Ver lavanderÃ­a â†’</a>
          </div>
        </div>

        <!-- Tareas Limpieza -->
        <div class="modulo-card tareas">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">ğŸ“‹</div>
            <div class="modulo-card-title">Tareas Limpieza</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Checklist de limpieza por zonas y estancias del hogar.</p>
            <div class="modulo-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-zonas">0</span>
                <span class="modulo-stat-label">zonas</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-tareas">0</span>
                <span class="modulo-stat-label">tareas</span>
              </div>
            </div>
            <a href="#" class="modulo-card-action" id="link-tareas">Ver tareas â†’</a>
          </div>
        </div>

        <!-- Plan Semanal -->
        <div class="modulo-card plan-semanal" id="card-plan-semanal">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">ğŸ“…</div>
            <div class="modulo-card-title">Plan Semanal</div>
          </div>
          <div class="plan-progreso">
            <div class="plan-progreso-bar" id="progreso-semanal" style="width: 0%"></div>
          </div>
          <div class="plan-card-content" id="tareas-semanales">
            <div class="plan-empty">Cargando...</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let origen = 'bien';

    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    origen = urlParams.get('origen') || 'bien';

    // Configurar botÃ³n volver
    document.getElementById('btn-volver').href = origen === 'mayordomo' 
      ? `mayordomo.html?bien=${bienId}` 
      : origen === 'casero'
      ? `casero.html`
      : `bien.html?id=${bienId}`;

    // Configurar links de cards
    document.getElementById('link-lavanderia').href = `lavanderia.html?id=${bienId}&origen=limpieza`;
    document.getElementById('link-tareas').href = `tareas-limpieza.html?id=${bienId}&origen=limpieza`;

    if (!bienId) window.location.href = 'lo-comun.html';

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarDatos();
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    });

    async function cargarDatos() {
      try {
        // Cargar datos del bien
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) {
          alert('Bien no encontrado');
          window.location.href = 'lo-comun.html';
          return;
        }
        bienData = { id: bienDoc.id, ...bienDoc.data() };
        document.getElementById('nombre-bien').textContent = `Â· ${bienData.nombre || 'Sin nombre'}`;

        // Cargar stats de zonas/tareas
        await cargarStatsZonas();

        // Cargar stats lavanderÃ­a
        await cargarStatsLavanderia();

        // Cargar plan semanal
        await cargarPlanSemanal();

      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }

    async function cargarStatsZonas() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('limpieza').get();
        let totalZonas = snap.docs.length;
        let totalTareas = 0;
        
        snap.docs.forEach(doc => {
          const zona = doc.data();
          if (zona.tareas) {
            totalTareas += zona.tareas.length;
          }
        });

        document.getElementById('stat-zonas').textContent = totalZonas;
        document.getElementById('stat-tareas').textContent = totalTareas;
      } catch (error) {
        console.log('Error cargando stats zonas:', error);
      }
    }

    async function cargarStatsLavanderia() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('lavanderia')
          .where('completado', '==', false).get();
        const completadosSnap = await db.collection('bienes').doc(bienId).collection('lavanderia')
          .where('completado', '==', true).get();
        
        document.getElementById('stat-pendientes').textContent = snap.docs.length;
        document.getElementById('stat-completados').textContent = completadosSnap.docs.length;
      } catch (error) {
        document.getElementById('stat-pendientes').textContent = '0';
        document.getElementById('stat-completados').textContent = '0';
      }
    }

    // ========== PLAN SEMANAL DE LIMPIEZA ==========
    let planLimpiezaData = [];
    let limpiezaCompletados = {};
    let semanaKeyActual = '';

    async function cargarPlanSemanal() {
      const container = document.getElementById('tareas-semanales');
      const progresoBar = document.getElementById('progreso-semanal');
      
      try {
        const hoy = new Date();
        const inicioSemana = new Date(hoy);
        inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1);
        inicioSemana.setHours(0, 0, 0, 0);
        semanaKeyActual = inicioSemana.toISOString().split('T')[0];

        // Cargar plan base de limpieza
        const planSnap = await db.collection('bienes').doc(bienId).collection('planLimpieza').get();
        const planBase = planSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Cargar completados de esta semana
        try {
          const completadosDoc = await db.collection('bienes').doc(bienId)
            .collection('planLimpiezaCompletados').doc(semanaKeyActual).get();
          if (completadosDoc.exists) {
            limpiezaCompletados = completadosDoc.data().tareas || {};
          }
        } catch (e) {}

        // Combinar plan con estado de completados
        planLimpiezaData = planBase.map(tarea => ({
          ...tarea,
          completada: !!limpiezaCompletados[tarea.id],
          semanaKey: semanaKeyActual
        }));

        // Ordenar por dÃ­a
        planLimpiezaData.sort((a, b) => {
          const diaA = parseInt(a.dia);
          const diaB = parseInt(b.dia);
          return (diaA === 0 ? 7 : diaA) - (diaB === 0 ? 7 : diaB);
        });

        renderPlanSemanal();
        
      } catch (error) {
        console.log('Error cargando plan semanal:', error);
        container.innerHTML = '<div class="plan-empty">Sin plan de limpieza</div>';
      }
    }

    function renderPlanSemanal() {
      const container = document.getElementById('tareas-semanales');
      const progresoBar = document.getElementById('progreso-semanal');
      const diasSemana = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'];
      const hoyNum = new Date().getDay();

      const zonaIcons = {
        cocina: 'ğŸ³', salon: 'ğŸ›‹ï¸', comedor: 'ğŸ½ï¸', dormitorio: 'ğŸ›ï¸',
        bano: 'ğŸš¿', terraza: 'ğŸŒ¿', garaje: 'ğŸš—', lavadero: 'ğŸ§º',
        entrada: 'ğŸšª', general: 'ğŸ '
      };
      const tareaIcons = {
        'barrer-fregar': 'ğŸ§¹', 'cambiar-sabanas': 'ğŸ›ï¸', 'desinfectar': 'ğŸ§´',
        'revisar-consumibles': 'ğŸ“¦', 'planchar': 'ğŸ‘”', 'lavar-ropa': 'ğŸ§º',
        'limpiar-cristales': 'ğŸªŸ', 'aspirar': 'ğŸ”Œ', 'quitar-polvo': 'âœ¨',
        'limpiar-electrodomesticos': 'ğŸ”§', 'ordenar': 'ğŸ“‚', 'otra': 'ğŸ“‹'
      };
      const tareaNombres = {
        'barrer-fregar': 'Barrer y fregar', 'cambiar-sabanas': 'Cambiar sÃ¡banas', 
        'desinfectar': 'Desinfectar', 'revisar-consumibles': 'Revisar consumibles',
        'planchar': 'Planchar', 'lavar-ropa': 'Lavar ropa', 'limpiar-cristales': 'Limpiar cristales',
        'aspirar': 'Aspirar', 'quitar-polvo': 'Quitar polvo', 
        'limpiar-electrodomesticos': 'Limpiar electrodom.', 'ordenar': 'Ordenar', 'otra': 'Otra'
      };

      if (planLimpiezaData.length === 0) {
        container.innerHTML = '<div class="plan-empty">ğŸ§¹ Sin plan de limpieza configurado<br><small><a href="plan-limpieza.html?id=' + bienId + '">Configurar plan â†’</a></small></div>';
        progresoBar.style.width = '0%';
        return;
      }

      const completadas = planLimpiezaData.filter(t => t.completada).length;
      const total = planLimpiezaData.length;
      const progreso = Math.round((completadas / total) * 100);
      progresoBar.style.width = progreso + '%';

      let html = planLimpiezaData.map(t => {
        const diaNum = parseInt(t.dia);
        const diaStr = diasSemana[diaNum];
        const esHoy = diaNum === hoyNum;
        const completada = t.completada ? 'completada' : '';
        const zonaIcon = zonaIcons[t.zona] || 'ğŸ ';
        const tareaIcon = tareaIcons[t.tipo] || 'ğŸ“‹';
        const tareaNombre = t.tipo === 'otra' ? (t.otraTarea || 'Tarea') : (tareaNombres[t.tipo] || t.tipo);

        return `
          <div class="plan-tarea ${completada} ${esHoy ? 'hoy' : ''}">
            <input type="checkbox" class="plan-tarea-check" 
              ${t.completada ? 'checked' : ''} 
              onchange="toggleLimpieza('${t.id}', this.checked)">
            <div class="plan-tarea-info">
              <div class="plan-tarea-titulo">${tareaIcon} ${tareaNombre}</div>
              <div class="plan-tarea-meta">
                <span class="plan-tarea-dia">${diaStr}</span>
                <span>${zonaIcon} ${t.dependencia || ''}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    async function toggleLimpieza(tareaId, completada) {
      try {
        const docRef = db.collection('bienes').doc(bienId)
          .collection('planLimpiezaCompletados').doc(semanaKeyActual);
        
        if (completada) {
          await docRef.set({
            [`tareas.${tareaId}`]: {
              completada: true,
              fechaCompletado: new Date().toISOString(),
              completadoPor: currentUser.uid
            }
          }, { merge: true });
        } else {
          await docRef.set({
            [`tareas.${tareaId}`]: firebase.firestore.FieldValue.delete()
          }, { merge: true });
        }
        
        const tarea = planLimpiezaData.find(t => t.id === tareaId);
        if (tarea) tarea.completada = completada;
        renderPlanSemanal();
      } catch (error) {
        console.error('Error actualizando limpieza:', error);
      }
    }
  </script>
</body>
</html>
