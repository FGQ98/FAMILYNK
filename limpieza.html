<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Limpieza</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--mayordomo);
      color: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--white);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Quicksand', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .header-title span { font-size: 1.5rem; }

    .header-bien {
      font-size: 0.85rem;
      opacity: 0.85;
      margin-left: 8px;
    }

    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--mayordomo);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* Grid de cards */
    .modulos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .modulo-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    .modulo-card:hover {
      box-shadow: var(--shadow-medium);
      transform: translateY(-2px);
    }

    .modulo-card-header {
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      color: var(--white);
    }

    .modulo-card-icon {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .modulo-card-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.15rem;
      font-weight: 600;
    }

    .modulo-card-body {
      padding: 20px;
    }

    .modulo-card-desc {
      color: var(--text-light);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .modulo-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
    }

    .modulo-stat {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .modulo-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'Quicksand', sans-serif;
    }

    .modulo-stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .modulo-card-action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--mayordomo);
      font-weight: 600;
      font-size: 0.9rem;
      text-decoration: none;
      transition: all 0.2s;
    }
    .modulo-card-action:hover {
      gap: 10px;
    }

    /* Card Tareas Limpieza */
    .modulo-card.tareas .modulo-card-header { background: linear-gradient(135deg, #7A9E7E 0%, #5C7D5F 100%); }
    .modulo-card.tareas:hover { border-color: #7A9E7E; }
    .modulo-card.tareas .modulo-stat-value { color: #5C7D5F; }

    /* Card Plan Semanal */
    .modulo-card.plan-semanal .modulo-card-header { background: linear-gradient(135deg, #8B7355 0%, #6B5A45 100%); }
    .modulo-card.plan-semanal:hover { border-color: #8B7355; }
    .modulo-card.plan-semanal .modulo-stat-value { color: #6B5A45; }

    /* Cards interactivas con tareas */
    .plan-card-content { padding: 12px 16px; max-height: 280px; overflow-y: auto; }
    .plan-tarea {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      border-left: 3px solid var(--mayordomo);
      transition: all 0.2s;
    }
    .plan-tarea:hover { background: var(--cream-dark); }
    .plan-tarea.hoy { border-left-color: var(--warning); background: #fffbf5; }
    .plan-tarea.completada { opacity: 0.6; background: #f0f0f0; border-left-color: var(--success); }
    .plan-tarea.completada .plan-tarea-titulo { text-decoration: line-through; color: var(--text-muted); }
    .plan-tarea-check { width: 20px; height: 20px; cursor: pointer; accent-color: var(--mayordomo); }
    .plan-tarea-info { flex: 1; }
    .plan-tarea-titulo { font-weight: 600; font-size: 0.85rem; }
    .plan-tarea-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 10px; margin-top: 2px; }
    .plan-tarea-dia { 
      background: var(--mayordomo-muted); 
      color: var(--mayordomo); 
      padding: 2px 6px; 
      border-radius: 4px; 
      font-size: 0.7rem; 
      font-weight: 600; 
    }
    .plan-tarea.limpieza { border-left-color: var(--sage); }
    .plan-tarea.limpieza .plan-tarea-dia { background: var(--sage-muted); color: var(--sage-dark); }
    .plan-empty { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; }
    .plan-empty a { color: var(--mayordomo); }
    .plan-progreso {
      height: 6px;
      background: var(--cream-dark);
      border-radius: 3px;
      margin: 0 16px 12px;
      overflow: hidden;
    }
    .plan-progreso-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--mayordomo) 0%, var(--success) 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
      .modulos-grid { grid-template-columns: 1fr; }
      .main { padding: 16px; }
    }
    .btn-pdf {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 14px; background: white; color: #5C7D5F;
      border: 2px solid #7A9E7E; border-radius: 8px;
      font-family: 'Nunito', sans-serif; font-size: 0.82rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; text-decoration: none;
    }
    .btn-pdf:hover { background: #7A9E7E; color: white; }
  </style>
  <!-- Sistema de permisos CVEB para externos -->
  <script src="permisos-externos.js"></script>
</head>
<body>
  <header class="header">
    <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
    <div class="header-title">
      <span>üßπ</span>
      Limpieza
      <span class="header-bien" id="nombre-bien"></span>
    </div>
    <button class="btn-pdf" onclick="generarPDF()">üìÑ PDF</button>
  </header>

  <main class="main">
    <div class="loading" id="loading"><div class="spinner"></div></div>

    <div id="content" class="hidden">
      <div class="modulos-grid">
        <!-- Tareas de Limpieza -->
        <div class="modulo-card tareas">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üßπ</div>
            <div class="modulo-card-title">Tareas de Limpieza</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Cat√°logo de tareas de limpieza por tipo de habitaci√≥n.</p>
            <div class="modulo-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-tipos">0</span>
                <span class="modulo-stat-label">tipos con tareas</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="stat-tareas">0</span>
                <span class="modulo-stat-label">tareas definidas</span>
              </div>
            </div>
            <a href="#" class="modulo-card-action" id="link-tareas">Gestionar ‚Üí</a>
          </div>
        </div>

        <!-- Plan Semanal -->
        <a href="#" class="modulo-card plan-semanal" id="card-plan-semanal" style="text-decoration: none; color: inherit; display: block;">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üìÖ</div>
            <div class="modulo-card-title">Plan Semanal</div>
          </div>
          <div class="plan-progreso">
            <div class="plan-progreso-bar" id="progreso-semanal" style="width: 0%"></div>
          </div>
          <div class="plan-card-content" id="tareas-semanales">
            <div class="plan-empty">Cargando...</div>
          </div>
          <div style="padding: 10px 16px; border-top: 1px solid var(--cream-dark); text-align: right;">
            <span style="color: #6B5A45; font-size: 0.85rem; font-weight: 600;">Configurar plan ‚Üí</span>
          </div>
        </a>

      </div>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let origen = 'bien';

    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    origen = urlParams.get('origen') || 'bien';

    // Configurar bot√≥n volver
    document.getElementById('btn-volver').href = origen === 'mayordomo' 
      ? `mayordomo.html?bien=${bienId}` 
      : origen === 'casero'
      ? `casero.html`
      : `bien.html?id=${bienId}`;

    // Configurar links de cards
    document.getElementById('link-tareas').href = `tareas-limpieza.html?id=${bienId}&origen=limpieza`;
    document.getElementById('card-plan-semanal').href = `plan-semanal-limpieza.html?id=${bienId}&origen=limpieza`;

    if (!bienId) window.location.href = 'lo-comun.html';

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      
      // Verificar si es externo y cargar permisos
      await PermisosExt.init(db, user, bienId);
      
      await cargarDatos();
      
      // Aplicar permisos CVEB si es externo
      if (PermisosExt.esExterno) {
        aplicarPermisosCards();
      }
      
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    });

    // Aplicar permisos a los enlaces de cards seg√∫n acceso
    function aplicarPermisosCards() {
      // Card Tareas de Limpieza
      if (!PermisosExt.puede('limpieza_zonasTareas', 'v')) {
        const card = document.querySelector('.modulo-card.tareas');
        if (card) card.style.display = 'none';
      }
      
      // Card Plan Semanal (interactivo)
      if (!PermisosExt.puede('limpieza_planSemanal', 'v')) {
        const card = document.getElementById('card-plan-semanal');
        if (card) card.style.display = 'none';
      } else if (!PermisosExt.puede('limpieza_planSemanal', 'e')) {
        // Solo ver, deshabilitar checkboxes
        document.querySelectorAll('#tareas-semanales input[type="checkbox"]').forEach(cb => {
          cb.disabled = true;
          cb.style.cursor = 'not-allowed';
        });
      }
    }

    async function cargarDatos() {
      try {
        // Cargar datos del bien
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) {
          alert('Bien no encontrado');
          window.location.href = 'lo-comun.html';
          return;
        }
        bienData = { id: bienDoc.id, ...bienDoc.data() };
        document.getElementById('nombre-bien').textContent = `¬∑ ${bienData.nombre || 'Sin nombre'}`;

        // Cargar stats de tareas por tipo
        await cargarStatsTareas();

        // Cargar plan semanal
        await cargarPlanSemanal();

      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }

    async function cargarStatsTareas() {
      try {
        // Leer cat√°logo de tareas desde configLimpieza/tareasPorTipo
        const configDoc = await db.collection('bienes').doc(bienId)
          .collection('configLimpieza').doc('tareasPorTipo').get();
        const tareasPorTipo = configDoc.exists ? configDoc.data() : {};

        // Contar tipos con tareas activas y total de tareas
        let tiposConTareas = 0;
        let totalTareas = 0;

        for (const [tipo, tareas] of Object.entries(tareasPorTipo)) {
          const activas = (tareas || []).filter(t => t.activo);
          if (activas.length > 0) {
            tiposConTareas++;
            totalTareas += activas.length;
          }
        }

        document.getElementById('stat-tipos').textContent = tiposConTareas;
        document.getElementById('stat-tareas').textContent = totalTareas;
      } catch (error) {
        console.log('Error cargando stats tareas:', error);
      }
    }

    // ========== PLAN SEMANAL COMBINADO (LIMPIEZA) ==========
    let planSemanalData = [];
    let completadosData = {};
    let semanaKeyActual = '';

    const TAREAS_INFO = {
      barrer: { nombre: 'Barrer', icon: 'üßπ' },
      fregar: { nombre: 'Fregar suelo', icon: 'ü™£' },
      aspirar: { nombre: 'Aspirar', icon: 'üîå' },
      desinfectar: { nombre: 'Desinfectar', icon: 'üß¥' },
      limpiar: { nombre: 'Limpiar superficies', icon: 'üßΩ' },
      polvo: { nombre: 'Quitar polvo', icon: '‚ú®' },
      cristales: { nombre: 'Limpiar cristales', icon: 'ü™ü' },
      sabanas: { nombre: 'Cambiar s√°banas', icon: 'üõèÔ∏è' },
      ropa: { nombre: 'Recoger ropa', icon: 'üëï' },
      consumibles: { nombre: 'Reponer consumibles', icon: 'üßª' },
      encendidos: { nombre: 'Revisar encendidos', icon: 'üí°' },
      grifos: { nombre: 'Revisar grifos/desag√ºes', icon: 'üöø' },
      electro: { nombre: 'Limpiar electrodom√©sticos', icon: 'üîß' },
      ordenar: { nombre: 'Ordenar', icon: 'üìÇ' }
    };

    const TIPOS_DEP = {
      dormitorio: { icon: 'üõèÔ∏è', label: 'Dormitorio' },
      servicio: { icon: 'üöø', label: 'Servicio' },
      aseo: { icon: 'üöΩ', label: 'Aseo' },
      vestuario: { icon: 'üëî', label: 'Vestuario' },
      cocina: { icon: 'üç≥', label: 'Cocina' },
      salon: { icon: 'üõãÔ∏è', label: 'Sal√≥n' },
      comedor: { icon: 'üçΩÔ∏è', label: 'Comedor' },
      lavadero: { icon: 'üß∫', label: 'Lavadero' },
      almacen: { icon: 'üì¶', label: 'Almac√©n' },
      camara: { icon: '‚ùÑÔ∏è', label: 'C√°mara' },
      taller: { icon: 'üîß', label: 'Taller' },
      instalacion: { icon: '‚ö°', label: 'Cuarto Instalaci√≥n' },
      porche: { icon: 'üåø', label: 'Porche' },
      otro: { icon: 'üè†', label: 'Otro' }
    };

    function calcularSemanaDelMes(fecha = new Date()) {
      const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
      const diaSemana = primerDia.getDay();
      return Math.ceil((fecha.getDate() + diaSemana) / 7);
    }

    function cumpleFrecuencia(inst, mesActual) {
      const mesInicio = inst.mesInicio || 1;
      const frecuencia = inst.frecuencia || 'mensual';
      let diff = mesActual - mesInicio;
      if (diff < 0) diff += 12;
      switch (frecuencia) {
        case 'semanal': return true;
        case 'quincenal': return true;
        case 'mensual': return true;
        case 'bimestral': return diff % 2 === 0;
        case 'trimestral': return diff % 3 === 0;
        case 'semestral': return diff % 6 === 0;
        case 'anual': return mesActual === mesInicio;
        default: return true;
      }
    }

    async function cargarPlanSemanal() {
      const container = document.getElementById('tareas-semanales');
      const progresoBar = document.getElementById('progreso-semanal');
      
      try {
        const hoy = new Date();
        const semanaDelMes = calcularSemanaDelMes(hoy);
        const mesActual = hoy.getMonth() + 1;

        const inicioSemana = new Date(hoy);
        inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1);
        inicioSemana.setHours(0, 0, 0, 0);
        semanaKeyActual = inicioSemana.toISOString().split('T')[0];

        planSemanalData = [];

        // 1. Cargar instrucciones del plan desde planLimpConfig
        const instSnap = await db.collection('bienes').doc(bienId)
          .collection('planLimpConfig').get();
        
        instSnap.docs.forEach(doc => {
          const inst = { id: doc.id, ...doc.data() };
          
          // Filtrar: ¬øtoca esta semana del mes + cumple frecuencia?
          if (!inst.semanas || !inst.semanas.includes(semanaDelMes)) return;
          if (!cumpleFrecuencia(inst, mesActual)) return;

          const tareaInfo = TAREAS_INFO[inst.tareaId] || { nombre: inst.tareaNombre || inst.tareaId, icon: 'üßπ' };
          const habIcon = TIPOS_DEP[inst.habitacionTipo]?.icon || 'üè†';

          planSemanalData.push({
            id: `lim_${inst.id}`,
            tipo: 'limpieza',
            nombre: tareaInfo.nombre,
            zona: `${habIcon} ${inst.habitacionNombre || 'Habitaci√≥n'}`,
            zonaIcon: tareaInfo.icon,
            restricciones: inst.restricciones || [],
            tiempo: inst.duracion || 30,
            frecuencia: inst.frecuencia || 'mensual'
          });
        });

        // 2. Cargar estado de completados de esta semana
        try {
          const completadosDoc = await db.collection('bienes').doc(bienId)
            .collection('planSemanalCompletados').doc(semanaKeyActual).get();
          if (completadosDoc.exists) {
            completadosData = completadosDoc.data().tareas || {};
          }
        } catch (e) {}

        // 4. Marcar completadas
        planSemanalData = planSemanalData.map(tarea => ({
          ...tarea,
          completada: !!completadosData[tarea.id]
        }));

        renderPlanSemanal();
        
      } catch (error) {
        console.log('Error cargando plan semanal:', error);
        container.innerHTML = '<div class="plan-empty">Error cargando plan</div>';
      }
    }

    function renderPlanSemanal() {
      const container = document.getElementById('tareas-semanales');
      const progresoBar = document.getElementById('progreso-semanal');
      const frecLabels = {
        semanal: 'Sem', quincenal: 'Quin', mensual: 'Mens',
        bimestral: 'Bim', trimestral: 'Trim', semestral: 'Semes', anual: 'Anual'
      };

      if (planSemanalData.length === 0) {
        container.innerHTML = `
          <div class="plan-empty">
            üìÖ Sin tareas programadas esta semana<br>
            <small>Configura en <a href="plan-semanal-limpieza.html?id=${bienId}">Plan Semanal</a></small>
          </div>
        `;
        progresoBar.style.width = '0%';
        return;
      }

      const completadas = planSemanalData.filter(t => t.completada).length;
      const total = planSemanalData.length;
      const progreso = Math.round((completadas / total) * 100);
      progresoBar.style.width = progreso + '%';

      let html = planSemanalData.map(t => {
        const completada = t.completada ? 'completada' : '';
        const tipoIcon = 'üßπ';
        const frecTag = frecLabels[t.frecuencia] || '';

        return `
          <div class="plan-tarea ${completada} limpieza">
            <input type="checkbox" class="plan-tarea-check" 
              ${t.completada ? 'checked' : ''} 
              onchange="toggleTarea('${t.id}', this.checked)">
            <div class="plan-tarea-info">
              <div class="plan-tarea-titulo">${tipoIcon} ${t.nombre}</div>
              <div class="plan-tarea-meta">
                ${frecTag ? `<span class="plan-tarea-dia">${frecTag}</span>` : ''}
                <span>${t.zona}</span>
                <span>‚è±Ô∏è ${t.tiempo}m</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    async function toggleTarea(tareaId, completada) {
      try {
        const docRef = db.collection('bienes').doc(bienId)
          .collection('planSemanalCompletados').doc(semanaKeyActual);
        
        if (completada) {
          await docRef.set({
            [`tareas.${tareaId}`]: {
              completada: true,
              fechaCompletado: new Date().toISOString(),
              completadoPor: currentUser.uid
            }
          }, { merge: true });
        } else {
          await docRef.set({
            [`tareas.${tareaId}`]: firebase.firestore.FieldValue.delete()
          }, { merge: true });
        }
        
        const tarea = planSemanalData.find(t => t.id === tareaId);
        if (tarea) tarea.completada = completada;
        renderPlanSemanal();
      } catch (error) {
        console.error('Error actualizando tarea:', error);
      }
    }

    // ========== PDF DESCARGA DIRECTA ==========
    function generarPDF() {
      const bienNombre = document.getElementById('nombre-bien')?.textContent || 'Bien';
      const tiposConTareas = document.getElementById('stat-tipos')?.textContent || '0';
      const totalTareas = document.getElementById('stat-tareas')?.textContent || '0';
      
      // Plan semanal
      let tareasHTML = '';
      if (planSemanalData.length > 0) {
        let filas = planSemanalData.map(t => {
          const completada = completadosData[t.id] ? '‚úÖ' : '‚¨ú';
          return `<tr>
            <td style="padding:6px 8px;border-bottom:1px solid #eee;text-align:center;">${completada}</td>
            <td style="padding:6px 8px;border-bottom:1px solid #eee;">${t.nombre || '-'}</td>
            <td style="padding:6px 8px;border-bottom:1px solid #eee;">${t.zona || '-'}</td>
            <td style="padding:6px 8px;border-bottom:1px solid #eee;text-align:center;">${t.tiempo || '-'} min</td>
            <td style="padding:6px 8px;border-bottom:1px solid #eee;font-size:11px;">${t.frecuencia || '-'}</td>
          </tr>`;
        }).join('');
        
        const completadas = Object.values(completadosData).filter(Boolean).length;
        
        tareasHTML = `
          <h3 style="color:#5C7D5F;font-size:14px;margin:16px 0 8px;">üìã Plan Semanal (${completadas}/${planSemanalData.length} completadas)</h3>
          <table style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead><tr style="background:#7A9E7E;color:white;">
              <th style="padding:6px 8px;width:40px;"></th>
              <th style="padding:6px 8px;text-align:left;">Tarea</th>
              <th style="padding:6px 8px;text-align:left;">Zona</th>
              <th style="padding:6px 8px;text-align:center;">Tiempo</th>
              <th style="padding:6px 8px;text-align:left;">Frecuencia</th>
            </tr></thead>
            <tbody>${filas}</tbody>
          </table>`;
      }
      
      const div = document.createElement('div');
      div.innerHTML = `
        <div style="font-family:Helvetica,Arial,sans-serif;padding:10px;color:#333;">
          <div style="text-align:center;margin-bottom:20px;">
            <h2 style="margin:0;color:#5C7D5F;">üßπ Limpieza</h2>
            <p style="margin:4px 0;color:#888;">${bienNombre}</p>
            <p style="margin:2px 0;font-size:11px;color:#aaa;">${new Date().toLocaleDateString('es-ES')}</p>
          </div>
          <div style="display:flex;gap:30px;justify-content:center;margin-bottom:20px;font-size:13px;">
            <span>Tipos con tareas: <b>${tiposConTareas}</b></span>
            <span>Total tareas: <b>${totalTareas}</b></span>
          </div>
          ${tareasHTML || '<p style="text-align:center;color:#aaa;">Sin plan semanal configurado</p>'}
          <div style="text-align:center;margin-top:30px;font-size:10px;color:#bbb;">FAMILYNK ¬∑ Limpieza</div>
        </div>
      `;
      
      html2pdf().set({
        margin: [10, 10, 15, 10],
        filename: 'limpieza-' + bienNombre.replace(/[^a-zA-Z0-9]/g, '_') + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).from(div).save();
    }
  </script>
</body>
</html>
