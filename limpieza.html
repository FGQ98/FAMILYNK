<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Limpieza</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: var(--cream-dark); color: var(--text); }

    .page-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary { background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }
    .btn-secondary { background: var(--cream); color: var(--text); border: 1px solid var(--cream-dark); }
    .btn-mayordomo { background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%); color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
    .btn-danger { background: var(--error); color: white; }

    .main { max-width: 700px; margin: 0 auto; padding: 24px; }

    .loading { display: flex; align-items: center; justify-content: center; padding: 60px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--sage); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* Resumen */
    .resumen-bar {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .resumen-progress {
      flex: 1;
    }

    .progress-bar {
      height: 12px;
      background: var(--cream-dark);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--sage) 0%, var(--success) 100%);
      border-radius: var(--radius-full);
      transition: width 0.3s ease;
    }

    .progress-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .resumen-stats {
      display: flex;
      gap: 20px;
    }

    .resumen-stat {
      text-align: center;
    }

    .resumen-stat-num {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .resumen-stat-num.done { color: var(--success); }
    .resumen-stat-num.pending { color: var(--warning); }

    .resumen-stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* Zonas */
    .zona-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      margin-bottom: 16px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .zona-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }

    .zona-header:hover { background: var(--cream-medium); }

    .zona-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .zona-count {
      font-size: 0.75rem;
      padding: 2px 10px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .zona-count.all-done { background: var(--sage-muted); color: var(--sage-dark); }
    .zona-count.pending { background: var(--terracotta-muted); color: var(--terracotta); }

    .zona-toggle {
      font-size: 1.2rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .zona-section.collapsed .zona-toggle { transform: rotate(-90deg); }
    .zona-section.collapsed .zona-body { display: none; }

    .zona-body {
      border-top: 1px solid var(--cream-dark);
      padding: 12px;
    }

    /* Tareas */
    .tarea-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tarea-item:last-child { margin-bottom: 0; }
    .tarea-item:hover { background: var(--cream-dark); }

    .tarea-item.done {
      background: var(--sage-muted);
    }

    .tarea-item.done .tarea-texto {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .tarea-check {
      width: 24px;
      height: 24px;
      border: 2px solid var(--cream-dark);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: transparent;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .tarea-item.done .tarea-check {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .tarea-content { flex: 1; }
    .tarea-texto { font-weight: 600; font-size: 0.9rem; }
    .tarea-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

    .tarea-actions {
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .tarea-item:hover .tarea-actions { opacity: 1; }

    .tarea-action-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--white);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .tarea-action-btn:hover { background: var(--cream-dark); }
    .tarea-action-btn.delete:hover { background: var(--error); color: white; }

    /* Bot√≥n a√±adir tarea */
    .add-tarea-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      border: 2px dashed var(--cream-dark);
      background: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .add-tarea-btn:hover {
      border-color: var(--sage);
      color: var(--sage-dark);
      background: var(--sage-muted);
    }

    /* Acciones generales */
    .actions-bar {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
    .empty-state-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--text); }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      padding: 20px;
    }

    .modal-overlay.active { opacity: 1; pointer-events: auto; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 450px;
      overflow: hidden;
      transform: translateY(20px);
      transition: transform 0.2s;
    }

    .modal-overlay.active .modal { transform: translateY(0); }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--cream);
      border-radius: var(--radius-sm);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--cream-dark); display: flex; gap: 12px; justify-content: flex-end; }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
    }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--sage); }

    @media (max-width: 600px) {
      .resumen-bar { flex-direction: column; align-items: stretch; }
      .resumen-stats { justify-content: center; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
      <h1 class="page-title">üßπ Limpieza</h1>
    </div>
    <button class="btn btn-mayordomo" onclick="abrirModalZona()">+ Nueva zona</button>
  </header>

  <main class="main">
    <div id="page-loading" class="loading"><div class="spinner"></div></div>

    <div id="page-content" class="hidden">
      <!-- Resumen -->
      <div class="resumen-bar" id="resumen-bar"></div>

      <!-- Zonas y tareas -->
      <div id="zonas-container"></div>

      <!-- Acciones -->
      <div class="actions-bar">
        <button class="btn btn-secondary" onclick="resetearTareas()">üîÑ Reiniciar todo</button>
      </div>
    </div>
  </main>

  <!-- Modal Zona -->
  <div class="modal-overlay" id="modal-zona">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-zona-title">Nueva zona</h3>
        <button class="modal-close" onclick="cerrarModal()">√ó</button>
      </div>
      <form id="form-zona">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre de la zona *</label>
            <input type="text" class="form-input" id="zona-nombre" placeholder="Ej: Cocina, Ba√±o principal..." required>
          </div>
          <div class="form-group">
            <label class="form-label">Icono</label>
            <select class="form-select" id="zona-icono">
              <option value="üè†">üè† General</option>
              <option value="üç≥">üç≥ Cocina</option>
              <option value="üõÅ">üõÅ Ba√±o</option>
              <option value="üõèÔ∏è">üõèÔ∏è Dormitorio</option>
              <option value="üõãÔ∏è">üõãÔ∏è Sal√≥n</option>
              <option value="üåø">üåø Terraza/Jard√≠n</option>
              <option value="üöó">üöó Garaje</option>
              <option value="üëï">üëï Lavander√≠a</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger hidden" id="btn-eliminar-zona" onclick="eliminarZona()">Eliminar</button>
          <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Tarea -->
  <div class="modal-overlay" id="modal-tarea">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-tarea-title">Nueva tarea</h3>
        <button class="modal-close" onclick="cerrarModal()">√ó</button>
      </div>
      <form id="form-tarea">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Tarea *</label>
            <input type="text" class="form-input" id="tarea-nombre" placeholder="Ej: Fregar suelo, Limpiar cristales..." required>
          </div>
          <div class="form-group">
            <label class="form-label">Frecuencia</label>
            <select class="form-select" id="tarea-frecuencia">
              <option value="cada-uso">Cada uso</option>
              <option value="diaria">Diaria</option>
              <option value="semanal">Semanal</option>
              <option value="quincenal">Quincenal</option>
              <option value="mensual">Mensual</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let bienId = null;
    let currentUser = null;
    let zonasData = [];
    let editingZonaId = null;
    let currentZonaId = null;

    const frecuenciaLabels = {
      'cada-uso': 'Cada uso',
      'diaria': 'Diaria',
      'semanal': 'Semanal',
      'quincenal': 'Quincenal',
      'mensual': 'Mensual'
    };

    // Obtener par√°metros
    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    const origen = urlParams.get('origen') || 'bien';

    document.getElementById('btn-volver').href = origen === 'mayordomo' 
      ? `mayordomo.html?bien=${bienId}` 
      : origen === 'casero'
      ? `casero.html`
      : `bien.html?id=${bienId}`;

    if (!bienId) window.location.href = 'bienes.html';

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarDatos();
    });

    async function cargarDatos() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('limpieza').orderBy('orden', 'asc').get();
        zonasData = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Si no hay zonas, crear unas por defecto
        if (zonasData.length === 0) {
          await crearZonasDefault();
        }

        render();
        document.getElementById('page-loading').classList.add('hidden');
        document.getElementById('page-content').classList.remove('hidden');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar datos');
      }
    }

    async function crearZonasDefault() {
      const zonasDefault = [
        { nombre: 'Cocina', icono: 'üç≥', orden: 1, tareas: [
          { nombre: 'Limpiar encimera', completado: false, frecuencia: 'cada-uso' },
          { nombre: 'Fregar platos', completado: false, frecuencia: 'cada-uso' },
          { nombre: 'Vaciar papelera', completado: false, frecuencia: 'diaria' },
          { nombre: 'Fregar suelo', completado: false, frecuencia: 'semanal' }
        ]},
        { nombre: 'Ba√±os', icono: 'üõÅ', orden: 2, tareas: [
          { nombre: 'Limpiar sanitarios', completado: false, frecuencia: 'semanal' },
          { nombre: 'Cambiar toallas', completado: false, frecuencia: 'semanal' },
          { nombre: 'Reponer papel', completado: false, frecuencia: 'cada-uso' }
        ]},
        { nombre: 'Dormitorios', icono: 'üõèÔ∏è', orden: 3, tareas: [
          { nombre: 'Hacer camas', completado: false, frecuencia: 'diaria' },
          { nombre: 'Cambiar s√°banas', completado: false, frecuencia: 'semanal' },
          { nombre: 'Ventilar', completado: false, frecuencia: 'diaria' }
        ]},
        { nombre: 'General', icono: 'üè†', orden: 4, tareas: [
          { nombre: 'Pasar aspiradora', completado: false, frecuencia: 'semanal' },
          { nombre: 'Quitar polvo', completado: false, frecuencia: 'semanal' },
          { nombre: 'Sacar basura', completado: false, frecuencia: 'diaria' }
        ]}
      ];

      const batch = db.batch();
      zonasDefault.forEach(zona => {
        const ref = db.collection('bienes').doc(bienId).collection('limpieza').doc();
        batch.set(ref, zona);
        zonasData.push({ id: ref.id, ...zona });
      });

      await batch.commit();
    }

    function render() {
      renderResumen();
      renderZonas();
    }

    function renderResumen() {
      const container = document.getElementById('resumen-bar');
      
      let totalTareas = 0;
      let completadas = 0;

      zonasData.forEach(zona => {
        const tareas = zona.tareas || [];
        totalTareas += tareas.length;
        completadas += tareas.filter(t => t.completado).length;
      });

      const porcentaje = totalTareas > 0 ? Math.round((completadas / totalTareas) * 100) : 0;
      const pendientes = totalTareas - completadas;

      container.innerHTML = `
        <div class="resumen-progress">
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${porcentaje}%"></div>
          </div>
          <div class="progress-label">${porcentaje}% completado</div>
        </div>
        <div class="resumen-stats">
          <div class="resumen-stat">
            <div class="resumen-stat-num done">${completadas}</div>
            <div class="resumen-stat-label">Hechas</div>
          </div>
          <div class="resumen-stat">
            <div class="resumen-stat-num pending">${pendientes}</div>
            <div class="resumen-stat-label">Pendientes</div>
          </div>
        </div>
      `;
    }

    function renderZonas() {
      const container = document.getElementById('zonas-container');

      if (zonasData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üßπ</div>
            <div class="empty-state-title">Sin zonas configuradas</div>
            <p>A√±ade zonas para organizar las tareas de limpieza</p>
          </div>
        `;
        return;
      }

      container.innerHTML = zonasData.map(zona => {
        const tareas = zona.tareas || [];
        const completadas = tareas.filter(t => t.completado).length;
        const allDone = tareas.length > 0 && completadas === tareas.length;

        return `
          <div class="zona-section" id="zona-${zona.id}">
            <div class="zona-header" onclick="toggleZona('${zona.id}')">
              <div class="zona-title">
                <span>${zona.icono || 'üè†'}</span>
                <span>${zona.nombre}</span>
                <span class="zona-count ${allDone ? 'all-done' : 'pending'}">${completadas}/${tareas.length}</span>
              </div>
              <span class="zona-toggle">‚ñº</span>
            </div>
            <div class="zona-body">
              ${tareas.map((tarea, idx) => `
                <div class="tarea-item ${tarea.completado ? 'done' : ''}" onclick="toggleTarea('${zona.id}', ${idx})">
                  <div class="tarea-check">${tarea.completado ? '‚úì' : ''}</div>
                  <div class="tarea-content">
                    <div class="tarea-texto">${tarea.nombre}</div>
                    ${tarea.frecuencia ? `<div class="tarea-meta">${frecuenciaLabels[tarea.frecuencia] || tarea.frecuencia}</div>` : ''}
                  </div>
                  <div class="tarea-actions">
                    <button class="tarea-action-btn delete" onclick="event.stopPropagation(); eliminarTarea('${zona.id}', ${idx})">üóëÔ∏è</button>
                  </div>
                </div>
              `).join('')}
              <button class="add-tarea-btn" onclick="abrirModalTarea('${zona.id}')">+ A√±adir tarea</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleZona(zonaId) {
      const section = document.getElementById(`zona-${zonaId}`);
      section.classList.toggle('collapsed');
    }

    async function toggleTarea(zonaId, tareaIdx) {
      const zona = zonasData.find(z => z.id === zonaId);
      if (!zona || !zona.tareas[tareaIdx]) return;

      zona.tareas[tareaIdx].completado = !zona.tareas[tareaIdx].completado;

      try {
        await db.collection('bienes').doc(bienId).collection('limpieza').doc(zonaId).update({
          tareas: zona.tareas
        });
        render();
      } catch (error) {
        console.error(error);
        zona.tareas[tareaIdx].completado = !zona.tareas[tareaIdx].completado;
      }
    }

    async function eliminarTarea(zonaId, tareaIdx) {
      if (!confirm('¬øEliminar esta tarea?')) return;

      const zona = zonasData.find(z => z.id === zonaId);
      if (!zona) return;

      zona.tareas.splice(tareaIdx, 1);

      try {
        await db.collection('bienes').doc(bienId).collection('limpieza').doc(zonaId).update({
          tareas: zona.tareas
        });
        render();
      } catch (error) {
        console.error(error);
        alert('Error al eliminar');
      }
    }

    async function resetearTareas() {
      if (!confirm('¬øMarcar todas las tareas como pendientes?')) return;

      try {
        const batch = db.batch();

        zonasData.forEach(zona => {
          zona.tareas = (zona.tareas || []).map(t => ({ ...t, completado: false }));
          const ref = db.collection('bienes').doc(bienId).collection('limpieza').doc(zona.id);
          batch.update(ref, { tareas: zona.tareas });
        });

        await batch.commit();
        render();
      } catch (error) {
        console.error(error);
        alert('Error al reiniciar');
      }
    }

    // Modal Zona
    function abrirModalZona(zona = null) {
      editingZonaId = zona?.id || null;
      document.getElementById('modal-zona-title').textContent = zona ? '‚úèÔ∏è Editar zona' : 'üè† Nueva zona';
      document.getElementById('btn-eliminar-zona').classList.toggle('hidden', !zona);

      if (zona) {
        document.getElementById('zona-nombre').value = zona.nombre || '';
        document.getElementById('zona-icono').value = zona.icono || 'üè†';
      } else {
        document.getElementById('form-zona').reset();
      }

      document.getElementById('modal-zona').classList.add('active');
    }

    function cerrarModal() {
      document.getElementById('modal-zona').classList.remove('active');
      document.getElementById('modal-tarea').classList.remove('active');
      editingZonaId = null;
      currentZonaId = null;
    }

    document.getElementById('form-zona').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        nombre: document.getElementById('zona-nombre').value,
        icono: document.getElementById('zona-icono').value,
        orden: zonasData.length + 1
      };

      try {
        if (editingZonaId) {
          await db.collection('bienes').doc(bienId).collection('limpieza').doc(editingZonaId).update(data);
          const idx = zonasData.findIndex(z => z.id === editingZonaId);
          if (idx !== -1) zonasData[idx] = { ...zonasData[idx], ...data };
        } else {
          data.tareas = [];
          const ref = await db.collection('bienes').doc(bienId).collection('limpieza').add(data);
          zonasData.push({ id: ref.id, ...data });
        }

        cerrarModal();
        render();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
    });

    async function eliminarZona() {
      if (!editingZonaId || !confirm('¬øEliminar esta zona y todas sus tareas?')) return;

      try {
        await db.collection('bienes').doc(bienId).collection('limpieza').doc(editingZonaId).delete();
        zonasData = zonasData.filter(z => z.id !== editingZonaId);
        cerrarModal();
        render();
      } catch (error) {
        console.error(error);
        alert('Error al eliminar');
      }
    }

    // Modal Tarea
    function abrirModalTarea(zonaId) {
      currentZonaId = zonaId;
      document.getElementById('form-tarea').reset();
      document.getElementById('modal-tarea').classList.add('active');
    }

    document.getElementById('form-tarea').addEventListener('submit', async (e) => {
      e.preventDefault();

      const zona = zonasData.find(z => z.id === currentZonaId);
      if (!zona) return;

      const nuevaTarea = {
        nombre: document.getElementById('tarea-nombre').value,
        frecuencia: document.getElementById('tarea-frecuencia').value,
        completado: false
      };

      if (!zona.tareas) zona.tareas = [];
      zona.tareas.push(nuevaTarea);

      try {
        await db.collection('bienes').doc(bienId).collection('limpieza').doc(currentZonaId).update({
          tareas: zona.tareas
        });

        cerrarModal();
        render();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
    });

    // Cerrar modales con click fuera
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) cerrarModal();
      });
    });
  </script>
</body>
</html>
