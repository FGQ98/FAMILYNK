<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Informes Gerente</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --gerente: #2D4A5C;
      --gerente-light: #4A6B7C;
      --gerente-dark: #1D3544;
      --gerente-muted: rgba(45, 74, 92, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --success-muted: rgba(125, 181, 154, 0.15);
      --warning: #E8B44D;
      --warning-muted: rgba(232, 180, 77, 0.15);
      --error: #D4695A;
      --error-muted: rgba(212, 105, 90, 0.15);
      --gold: #B8965C;
      --gold-muted: rgba(184, 150, 92, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem; color: white;
      cursor: pointer; text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title { display: flex; align-items: center; gap: 12px; color: white; }

    .header-icon {
      width: 40px; height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem;
    }

    .header-info h1 { font-family: 'Quicksand', sans-serif; font-size: 1.2rem; font-weight: 700; }
    .header-info p { font-size: 0.8rem; opacity: 0.85; }

    .header-actions { display: flex; align-items: center; gap: 10px; }

    /* ========== CONTENEDOR ========== */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }

    /* ========== FILTROS ========== */
    .filtros-bar {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: flex-end;
      gap: 16px;
      flex-wrap: wrap;
    }

    .filtro-group { display: flex; flex-direction: column; gap: 6px; }
    .filtro-group.grow { flex: 1; min-width: 200px; }

    .filtro-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--text-muted);
    }

    .filtro-select, .filtro-date {
      padding: 10px 14px;
      border: 1.5px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      color: var(--text);
      background: var(--cream);
      transition: border-color 0.2s;
      outline: none;
    }
    .filtro-select:focus, .filtro-date:focus { border-color: var(--gerente); }

    .filtro-periodo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filtro-periodo span {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 18px; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      border: none; text-decoration: none;
    }
    .btn-gerente {
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      color: white;
    }
    .btn-gerente:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }
    .btn-secondary { background: var(--cream); color: var(--text); border: 1px solid var(--cream-dark); }
    .btn-secondary:hover { background: var(--cream-dark); }
    .btn-sm { padding: 8px 14px; font-size: 0.8rem; }

    /* ========== CARDS ========== */
    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      margin-bottom: 24px;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex; align-items: center; justify-content: space-between;
    }

    .card-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700; font-size: 1.05rem;
      display: flex; align-items: center; gap: 10px;
    }

    .card-body { padding: 20px; }

    /* ========== TABLA RESULTADOS ========== */
    .tabla-resultados { width: 100%; border-collapse: collapse; }

    .tabla-resultados th {
      text-align: left;
      padding: 10px 14px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--text-muted);
      border-bottom: 2px solid var(--cream-dark);
    }

    .tabla-resultados th:last-child { text-align: right; }

    .tabla-resultados td {
      padding: 10px 14px;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--cream-dark);
      vertical-align: middle;
    }

    .tabla-resultados td:last-child { text-align: right; font-variant-numeric: tabular-nums; }

    .tabla-resultados tr:hover { background: var(--cream-medium); }

    /* Filas de categor√≠a (cabecera de bloque) */
    .fila-categoria td {
      font-weight: 700;
      font-family: 'Quicksand', sans-serif;
      color: var(--gerente);
      padding-top: 16px;
      border-bottom: 1px solid var(--gerente-muted);
      font-size: 0.95rem;
    }

    .fila-categoria td:first-child { padding-left: 0; }

    /* Filas de partida (detalle) */
    .fila-partida td { color: var(--text-light); }
    .fila-partida td:first-child { padding-left: 24px; }

    /* Filas de subtotal */
    .fila-subtotal td {
      font-weight: 700;
      background: var(--cream);
      border-bottom: 2px solid var(--cream-dark);
    }

    .fila-subtotal td:first-child { padding-left: 12px; }

    /* Fila resultado final */
    .fila-resultado td {
      font-weight: 700;
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      padding: 16px 14px;
      border-top: 3px double var(--gerente);
      border-bottom: none;
    }

    .fila-resultado.positivo td:last-child { color: var(--success); }
    .fila-resultado.negativo td:last-child { color: var(--error); }

    .importe-positivo { color: var(--success); }
    .importe-negativo { color: var(--error); }

    /* ========== INCIDENCIAS ========== */
    .incidencia-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .incidencia-bloque {
      background: var(--cream);
      border-radius: var(--radius-md);
      padding: 20px;
    }

    .incidencia-bloque-titulo {
      font-family: 'Quicksand', sans-serif;
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 14px;
      display: flex; align-items: center; gap: 8px;
    }

    .incidencia-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--cream-dark);
      font-size: 0.85rem;
    }
    .incidencia-item:last-child { border-bottom: none; }

    .incidencia-estado {
      padding: 3px 10px;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
    }
    .estado-resuelto { background: var(--success-muted); color: var(--success); }
    .estado-pendiente { background: var(--warning-muted); color: var(--warning); }
    .estado-critico { background: var(--error-muted); color: var(--error); }

    .encuesta-resumen {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .encuesta-nota {
      font-family: 'Quicksand', sans-serif;
      font-size: 2rem;
      font-weight: 700;
      color: var(--gerente);
      background: var(--gerente-muted);
      width: 56px; height: 56px;
      border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center;
    }

    .encuesta-detalle { font-size: 0.85rem; color: var(--text-light); line-height: 1.5; }

    .estrellas { color: var(--gold); letter-spacing: 2px; }

    .encuesta-criterio {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      font-size: 0.85rem;
    }

    /* ========== CONTENIDOS ========== */
    .contenido-seccion {
      margin-bottom: 20px;
    }
    .contenido-seccion:last-child { margin-bottom: 0; }

    .contenido-seccion-titulo {
      font-family: 'Quicksand', sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--gerente);
      margin-bottom: 10px;
      display: flex; align-items: center; gap: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .contenido-lista { list-style: none; }
    .contenido-lista li {
      padding: 8px 0 8px 16px;
      border-bottom: 1px solid var(--cream-dark);
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    .contenido-lista li:last-child { border-bottom: none; }
    .contenido-lista li::before {
      content: '';
      width: 6px; height: 6px;
      background: var(--gerente-light);
      border-radius: 50%;
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
    }

    .contenido-extra {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 50px 20px;
      color: var(--text-muted);
    }
    .empty-state-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-title { font-size: 1rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
    .empty-state-text { font-size: 0.85rem; }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      .container { padding: 16px; }
      .filtros-bar { flex-direction: column; align-items: stretch; }
      .filtro-group.grow { min-width: auto; }
      .incidencia-grid { grid-template-columns: 1fr; }
      .tabla-resultados { font-size: 0.8rem; }
      .tabla-resultados th, .tabla-resultados td { padding: 8px 10px; }
      .fila-partida td:first-child { padding-left: 16px; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <a href="gerente.html" class="back-btn" id="btn-volver">‚Üê Gerente</a>
      <div class="header-title">
        <div class="header-icon">üìÑ</div>
        <div class="header-info">
          <h1>Informes</h1>
          <p id="nombre-bien">Cargando...</p>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary btn-sm" onclick="exportarPDF()">üì• Exportar PDF</button>
    </div>
  </header>

  <div class="container">

    <!-- ========== FILTROS ========== -->
    <div class="filtros-bar">
      <div class="filtro-group grow">
        <span class="filtro-label">Reserva</span>
        <select class="filtro-select" id="filtro-reserva">
          <option value="">‚Äî Todas las reservas ‚Äî</option>
        </select>
      </div>
      <div class="filtro-group">
        <span class="filtro-label">Per√≠odo</span>
        <div class="filtro-periodo">
          <input type="date" class="filtro-date" id="filtro-desde">
          <span>‚Üí</span>
          <input type="date" class="filtro-date" id="filtro-hasta">
        </div>
      </div>
      <button class="btn btn-gerente" onclick="aplicarFiltros()">üîç Consultar</button>
    </div>

    <!-- ========== CARD 1: RESULTADOS ========== -->
    <div class="card" id="card-resultados">
      <div class="card-header">
        <h2 class="card-title">üìä Cuenta de Resultados</h2>
        <span class="btn btn-secondary btn-sm" id="periodo-label">Sin filtro aplicado</span>
      </div>
      <div class="card-body">
        <div id="resultados-contenido">
          <table class="tabla-resultados" id="tabla-resultados">
            <thead>
              <tr>
                <th>Concepto</th>
                <th style="text-align:right;">Importe</th>
              </tr>
            </thead>
            <tbody id="tbody-resultados">
              <!-- Se renderiza din√°micamente -->
            </tbody>
          </table>
        </div>
        <div id="resultados-vacio" style="display:none;">
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-title">Sin datos para este per√≠odo</div>
            <div class="empty-state-text">Selecciona una reserva o per√≠odo y pulsa Consultar</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== CARD 2: INCIDENCIAS ========== -->
    <div class="card" id="card-incidencias">
      <div class="card-header">
        <h2 class="card-title">‚ö†Ô∏è Incidencias</h2>
      </div>
      <div class="card-body">
        <div class="incidencia-grid" id="incidencias-grid">

          <!-- Resumen del Hoster -->
          <div class="incidencia-bloque">
            <div class="incidencia-bloque-titulo">üè† Resumen del Hoster</div>
            <div id="hoster-incidencias">
              <!-- Se renderiza din√°micamente -->
            </div>
          </div>

          <!-- Encuesta de satisfacci√≥n -->
          <div class="incidencia-bloque">
            <div class="incidencia-bloque-titulo">üìù Encuesta de Satisfacci√≥n</div>
            <div id="encuesta-contenido">
              <!-- Se renderiza din√°micamente -->
            </div>
          </div>

        </div>
        <div id="incidencias-vacio" style="display:none;">
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <div class="empty-state-title">Sin incidencias registradas</div>
            <div class="empty-state-text">No hay informes del hoster ni encuestas para este filtro</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== CARD 3: CONTENIDOS ========== -->
    <div class="card" id="card-contenidos">
      <div class="card-header">
        <h2 class="card-title">üçΩÔ∏è Contenidos</h2>
      </div>
      <div class="card-body">
        <div id="contenidos-detalle">
          <!-- Se renderiza din√°micamente -->
        </div>
        <div id="contenidos-vacio" style="display:none;">
          <div class="empty-state">
            <div class="empty-state-icon">üçΩÔ∏è</div>
            <div class="empty-state-title">Sin contenidos detallados</div>
            <div class="empty-state-text">Los men√∫s, extras y servicios aparecer√°n aqu√≠ al filtrar</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let reservas = [];

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');
      const origen = params.get('origen') || 'gerente';

      if (!bienId) {
        alert('No se ha especificado el bien');
        window.location.href = 'lo-comun.html';
        return;
      }

      // Bot√≥n volver
      document.getElementById('btn-volver').href = `gerente.html?id=${bienId}`;

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await cargarBien();
          await cargarReservas();
          renderEstadoInicial();
        } else {
          window.location.href = 'login.html';
        }
      });
    });

    // ========== CARGAR DATOS ==========
    async function cargarBien() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (doc.exists) {
          bienData = doc.data();
          document.getElementById('nombre-bien').textContent = bienData.nombre || 'Sin nombre';
        }
      } catch (error) {
        console.error('Error cargando bien:', error);
      }
    }

    async function cargarReservas() {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('reservas')
          .orderBy('fechaInicio', 'desc')
          .get();

        const select = document.getElementById('filtro-reserva');

        snap.forEach(doc => {
          const r = doc.data();
          reservas.push({ id: doc.id, ...r });

          const opt = document.createElement('option');
          opt.value = doc.id;
          const fecha = r.fechaInicio?.toDate?.();
          const fechaStr = fecha ? fecha.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }) : '';
          opt.textContent = `#${doc.id.slice(-4).toUpperCase()} ‚Äî ${r.titular || r.nombre || 'Sin nombre'} ‚Äî ${fechaStr}`;
          select.appendChild(opt);
        });
      } catch (error) {
        console.error('Error cargando reservas:', error);
      }
    }

    // ========== RENDER INICIAL ==========
    function renderEstadoInicial() {
      // Mostrar empty states si no hay filtros
      mostrarEmptyStates();
    }

    function mostrarEmptyStates() {
      document.getElementById('resultados-vacio').style.display = 'block';
      document.getElementById('tbody-resultados').innerHTML = '';
      document.getElementById('incidencias-vacio').style.display = 'block';
      document.getElementById('incidencias-grid').style.display = 'none';
      document.getElementById('contenidos-vacio').style.display = 'block';
      document.getElementById('contenidos-detalle').style.display = 'none';
    }

    function ocultarEmptyStates() {
      document.getElementById('resultados-vacio').style.display = 'none';
      document.getElementById('incidencias-vacio').style.display = 'none';
      document.getElementById('incidencias-grid').style.display = 'grid';
      document.getElementById('contenidos-vacio').style.display = 'none';
      document.getElementById('contenidos-detalle').style.display = 'block';
    }

    // ========== APLICAR FILTROS ==========
    async function aplicarFiltros() {
      const reservaId = document.getElementById('filtro-reserva').value;
      const desde = document.getElementById('filtro-desde').value;
      const hasta = document.getElementById('filtro-hasta').value;

      // Actualizar etiqueta de per√≠odo
      let periodoText = 'Sin filtro';
      if (reservaId) {
        const r = reservas.find(r => r.id === reservaId);
        periodoText = r ? `Reserva #${reservaId.slice(-4).toUpperCase()}` : 'Reserva';
      }
      if (desde && hasta) {
        periodoText = `${formatFecha(desde)} ‚Üí ${formatFecha(hasta)}`;
      } else if (desde) {
        periodoText = `Desde ${formatFecha(desde)}`;
      } else if (hasta) {
        periodoText = `Hasta ${formatFecha(hasta)}`;
      }
      document.getElementById('periodo-label').textContent = periodoText;

      // Cargar datos seg√∫n filtros
      await cargarResultados(reservaId, desde, hasta);
      await cargarIncidencias(reservaId, desde, hasta);
      await cargarContenidos(reservaId, desde, hasta);
    }

    // ========== CARD 1: RESULTADOS ==========
    async function cargarResultados(reservaId, desde, hasta) {
      try {
        const bienRef = db.collection('bienes').doc(bienId);
        let ingresos = { estancias: 0, hospitalidad: 0, actividades: 0, otrosIngresos: 0 };
        let costes = { suministros: 0, limpieza: 0, mantenimiento: 0, otrosCostes: 0 };
        let gastos = { personal: 0, seguros: 0, otrosGastos: 0 };
        let imputacion = { amortizacion: 0, impuestos: 0 };

        // Cargar ventas/ingresos
        let ventasQuery = bienRef.collection('ventas');
        if (reservaId) {
          ventasQuery = ventasQuery.where('reservaId', '==', reservaId);
        }
        const ventasSnap = await ventasQuery.get();
        ventasSnap.forEach(doc => {
          const v = doc.data();
          const tipo = v.tipo || 'estancias';
          const importe = parseFloat(v.importe) || 0;
          if (ingresos.hasOwnProperty(tipo)) {
            ingresos[tipo] += importe;
          } else {
            ingresos.otrosIngresos += importe;
          }
        });

        // Cargar gastos
        let gastosQuery = bienRef.collection('gastos');
        if (desde) gastosQuery = gastosQuery.where('fecha', '>=', firebase.firestore.Timestamp.fromDate(new Date(desde)));
        if (hasta) gastosQuery = gastosQuery.where('fecha', '<=', firebase.firestore.Timestamp.fromDate(new Date(hasta + 'T23:59:59')));
        const gastosSnap = await gastosQuery.get();
        gastosSnap.forEach(doc => {
          const g = doc.data();
          const cat = g.categoria || 'otrosGastos';
          const importe = parseFloat(g.importe) || 0;
          if (costes.hasOwnProperty(cat)) costes[cat] += importe;
          else if (gastos.hasOwnProperty(cat)) gastos[cat] += importe;
          else gastos.otrosGastos += importe;
        });

        // Calcular totales
        const totalIngresos = Object.values(ingresos).reduce((a, b) => a + b, 0);
        const totalCostes = Object.values(costes).reduce((a, b) => a + b, 0);
        const totalGastos = Object.values(gastos).reduce((a, b) => a + b, 0);
        const totalImputacion = Object.values(imputacion).reduce((a, b) => a + b, 0);
        const resultado = totalIngresos - totalCostes - totalGastos - totalImputacion;

        // Render tabla
        renderTablaResultados(ingresos, costes, gastos, imputacion, totalIngresos, totalCostes, totalGastos, totalImputacion, resultado);

        if (totalIngresos === 0 && totalCostes === 0 && totalGastos === 0) {
          document.getElementById('resultados-vacio').style.display = 'block';
          document.getElementById('tbody-resultados').innerHTML = '';
        } else {
          document.getElementById('resultados-vacio').style.display = 'none';
        }

      } catch (error) {
        console.error('Error cargando resultados:', error);
      }
    }

    function renderTablaResultados(ingresos, costes, gastos, imputacion, totI, totC, totG, totIm, resultado) {
      const tbody = document.getElementById('tbody-resultados');
      let html = '';

      // INGRESOS
      html += filaCategoria('üí∞ INGRESOS', '');
      html += filaPartida('Estancias', ingresos.estancias);
      html += filaPartida('Hospitalidad', ingresos.hospitalidad);
      html += filaPartida('Actividades', ingresos.actividades);
      html += filaPartida('Otros ingresos', ingresos.otrosIngresos);
      html += filaSubtotal('Total Ingresos', totI, 'positivo');

      // COSTES
      html += filaCategoria('üèóÔ∏è COSTES DIRECTOS', '');
      html += filaPartida('Suministros', costes.suministros);
      html += filaPartida('Limpieza', costes.limpieza);
      html += filaPartida('Mantenimiento', costes.mantenimiento);
      html += filaPartida('Otros costes', costes.otrosCostes);
      html += filaSubtotal('Total Costes', totC, 'negativo');

      // GASTOS
      html += filaCategoria('üíº GASTOS GENERALES', '');
      html += filaPartida('Personal', gastos.personal);
      html += filaPartida('Seguros', gastos.seguros);
      html += filaPartida('Otros gastos', gastos.otrosGastos);
      html += filaSubtotal('Total Gastos', totG, 'negativo');

      // IMPUTACI√ìN
      html += filaCategoria('üìã IMPUTACI√ìN', '');
      html += filaPartida('Amortizaci√≥n', imputacion.amortizacion);
      html += filaPartida('Impuestos', imputacion.impuestos);
      html += filaSubtotal('Total Imputaci√≥n', totIm, 'negativo');

      // RESULTADO
      const claseRes = resultado >= 0 ? 'positivo' : 'negativo';
      html += '<tr class="fila-resultado ' + claseRes + '">' +
        '<td>üìä RESULTADO</td>' +
        '<td>' + formatEur(resultado) + '</td>' +
        '</tr>';

      tbody.innerHTML = html;
    }

    function filaCategoria(nombre) {
      return '<tr class="fila-categoria"><td>' + nombre + '</td><td></td></tr>';
    }

    function filaPartida(nombre, importe) {
      if (importe === 0) return ''; // no mostrar partidas vac√≠as
      return '<tr class="fila-partida"><td>' + nombre + '</td><td>' + formatEur(importe) + '</td></tr>';
    }

    function filaSubtotal(nombre, importe, tipo) {
      const clase = tipo === 'positivo' ? 'importe-positivo' : (tipo === 'negativo' ? 'importe-negativo' : '');
      return '<tr class="fila-subtotal"><td>' + nombre + '</td><td class="' + clase + '">' + formatEur(importe) + '</td></tr>';
    }

    // ========== CARD 2: INCIDENCIAS ==========
    async function cargarIncidencias(reservaId, desde, hasta) {
      try {
        const bienRef = db.collection('bienes').doc(bienId);

        // Cargar incidencias del Hoster
        let incQuery = bienRef.collection('incidencias');
        if (reservaId) incQuery = incQuery.where('reservaId', '==', reservaId);
        const incSnap = await incQuery.get();

        const hosterDiv = document.getElementById('hoster-incidencias');

        if (incSnap.empty) {
          hosterDiv.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:0.85rem;">Sin incidencias registradas</div>';
        } else {
          let html = '';
          incSnap.forEach(doc => {
            const inc = doc.data();
            const estadoClase = inc.estado === 'resuelto' ? 'estado-resuelto' :
                                inc.estado === 'pendiente' ? 'estado-pendiente' : 'estado-critico';
            const estadoTexto = inc.estado ? inc.estado.charAt(0).toUpperCase() + inc.estado.slice(1) : 'Pendiente';
            html += '<div class="incidencia-item">' +
              '<span>' + (inc.descripcion || inc.titulo || 'Sin descripci√≥n') + '</span>' +
              '<span class="incidencia-estado ' + estadoClase + '">' + estadoTexto + '</span>' +
              '</div>';
          });
          hosterDiv.innerHTML = html;
        }

        // Cargar encuesta de satisfacci√≥n
        let encQuery = bienRef.collection('encuestas');
        if (reservaId) encQuery = encQuery.where('reservaId', '==', reservaId);
        const encSnap = await encQuery.limit(1).get();

        const encuestaDiv = document.getElementById('encuesta-contenido');

        if (encSnap.empty) {
          encuestaDiv.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:0.85rem;">Sin encuesta disponible</div>';
        } else {
          const enc = encSnap.docs[0].data();
          const nota = enc.notaGlobal || enc.nota || '‚Äî';
          const criterios = enc.criterios || {};

          let html = '<div class="encuesta-resumen">' +
            '<div class="encuesta-nota">' + nota + '</div>' +
            '<div class="encuesta-detalle">' +
              '<strong>' + (enc.titular || 'Hu√©sped') + '</strong><br>' +
              '<span class="estrellas">' + renderEstrellas(nota) + '</span>' +
            '</div>' +
            '</div>';

          // Desglose por criterios
          Object.entries(criterios).forEach(([key, val]) => {
            html += '<div class="encuesta-criterio">' +
              '<span>' + key + '</span>' +
              '<span class="estrellas">' + renderEstrellas(val) + '</span>' +
              '</div>';
          });

          if (enc.comentario) {
            html += '<div style="margin-top:12px;padding:12px;background:var(--white);border-radius:var(--radius-sm);font-size:0.85rem;font-style:italic;color:var(--text-light);">"' + enc.comentario + '"</div>';
          }

          encuestaDiv.innerHTML = html;
        }

        // Mostrar/ocultar
        if (incSnap.empty && encSnap.empty) {
          document.getElementById('incidencias-vacio').style.display = 'block';
          document.getElementById('incidencias-grid').style.display = 'none';
        } else {
          document.getElementById('incidencias-vacio').style.display = 'none';
          document.getElementById('incidencias-grid').style.display = 'grid';
        }

      } catch (error) {
        console.error('Error cargando incidencias:', error);
      }
    }

    // ========== CARD 3: CONTENIDOS ==========
    async function cargarContenidos(reservaId, desde, hasta) {
      try {
        const bienRef = db.collection('bienes').doc(bienId);
        let hayContenido = false;
        let html = '';

        // Men√∫s asociados
        let menusQuery = bienRef.collection('menus');
        if (reservaId) menusQuery = menusQuery.where('reservaId', '==', reservaId);
        const menusSnap = await menusQuery.get();

        if (!menusSnap.empty) {
          hayContenido = true;
          html += '<div class="contenido-seccion">' +
            '<div class="contenido-seccion-titulo">üçΩÔ∏è Men√∫s</div>' +
            '<ul class="contenido-lista">';
          menusSnap.forEach(doc => {
            const m = doc.data();
            const tipo = m.tipo || 'Comida';
            const fecha = m.fecha?.toDate?.() ? m.fecha.toDate().toLocaleDateString('es-ES') : '';
            html += '<li><span>' + tipo + (m.nombre ? ' ‚Äî ' + m.nombre : '') + '</span>' +
              '<span class="contenido-extra">' + fecha + '</span></li>';
          });
          html += '</ul></div>';
        }

        // Extras / servicios contratados
        let extrasQuery = bienRef.collection('extras');
        if (reservaId) extrasQuery = extrasQuery.where('reservaId', '==', reservaId);
        const extrasSnap = await extrasQuery.get();

        if (!extrasSnap.empty) {
          hayContenido = true;
          html += '<div class="contenido-seccion">' +
            '<div class="contenido-seccion-titulo">üéØ Extras y Actividades</div>' +
            '<ul class="contenido-lista">';
          extrasSnap.forEach(doc => {
            const e = doc.data();
            html += '<li><span>' + (e.nombre || e.descripcion || 'Extra') + '</span>' +
              '<span class="contenido-extra">' + (e.importe ? formatEur(e.importe) : '') + '</span></li>';
          });
          html += '</ul></div>';
        }

        // Servicios externos
        let servQuery = bienRef.collection('serviciosExternos');
        if (reservaId) servQuery = servQuery.where('reservaId', '==', reservaId);
        const servSnap = await servQuery.get();

        if (!servSnap.empty) {
          hayContenido = true;
          html += '<div class="contenido-seccion">' +
            '<div class="contenido-seccion-titulo">üöê Servicios Externos</div>' +
            '<ul class="contenido-lista">';
          servSnap.forEach(doc => {
            const s = doc.data();
            html += '<li><span>' + (s.proveedor || '') + ' ‚Äî ' + (s.servicio || s.descripcion || '') + '</span>' +
              '<span class="contenido-extra">' + (s.importe ? formatEur(s.importe) : '') + '</span></li>';
          });
          html += '</ul></div>';
        }

        // Notas del hoster
        let notasQuery = bienRef.collection('notasHoster');
        if (reservaId) notasQuery = notasQuery.where('reservaId', '==', reservaId);
        const notasSnap = await notasQuery.get();

        if (!notasSnap.empty) {
          hayContenido = true;
          html += '<div class="contenido-seccion">' +
            '<div class="contenido-seccion-titulo">üìù Notas del Hoster</div>' +
            '<ul class="contenido-lista">';
          notasSnap.forEach(doc => {
            const n = doc.data();
            html += '<li><span>' + (n.texto || n.nota || '') + '</span>' +
              '<span class="contenido-extra">' + (n.fecha?.toDate?.() ? n.fecha.toDate().toLocaleDateString('es-ES') : '') + '</span></li>';
          });
          html += '</ul></div>';
        }

        const detalleDiv = document.getElementById('contenidos-detalle');
        const vacioDiv = document.getElementById('contenidos-vacio');

        if (hayContenido) {
          detalleDiv.innerHTML = html;
          detalleDiv.style.display = 'block';
          vacioDiv.style.display = 'none';
        } else {
          detalleDiv.style.display = 'none';
          vacioDiv.style.display = 'block';
        }

      } catch (error) {
        console.error('Error cargando contenidos:', error);
      }
    }

    // ========== UTILIDADES ==========
    function formatEur(n) {
      if (typeof n !== 'number' || isNaN(n)) return '0 ‚Ç¨';
      return n.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' ‚Ç¨';
    }

    function formatFecha(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function renderEstrellas(nota) {
      const n = parseFloat(nota) || 0;
      const llenas = Math.floor(n);
      const media = n % 1 >= 0.5 ? 1 : 0;
      const vacias = 5 - llenas - media;
      return '‚òÖ'.repeat(llenas) + (media ? '¬Ω' : '') + '‚òÜ'.repeat(vacias);
    }

    function exportarPDF() {
      alert('Funci√≥n de exportaci√≥n PDF pendiente de implementar.\nSe generar√° un informe con los datos filtrados.');
    }
  </script>
</body>
</html>
