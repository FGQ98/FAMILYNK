<!DOCTYPE html>
<html lang="es">
<head>
  <!-- FAMILYNK Icons & PWA -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7A9E7E">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="FAMILYNK">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK â€” Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--sage:#7A9E7E;--sage-muted:rgba(122,158,126,0.15);--cream:#FDF8F3;--cream-dark:#F5EDE4;--terracotta:#C17757;--admin:#4A5568;--admin-dark:#2D3748;--admin-muted:rgba(74,85,104,0.1);--text:#3D3D3D;--text-light:#6B6B6B;--text-muted:#9A9A9A;--white:#FFF;--success:#48BB78;--warning:#ECC94B;--error:#F56565;--info:#4299E1;--shadow-soft:0 2px 8px rgba(0,0,0,0.06);--radius-sm:6px;--radius-md:10px;--radius-lg:14px;--radius-full:50px}
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--text);min-height:100vh}
    .header{background:linear-gradient(135deg,var(--admin-dark),var(--admin));padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .logo{display:flex;align-items:center;gap:0.5em}.logo-icon{height:2rem;filter:brightness(0) invert(1)}.logo-text{font-family:'Quicksand',sans-serif;font-weight:700;font-size:1rem;color:white}.logo-badge{padding:2px 8px;background:var(--terracotta);color:white;border-radius:var(--radius-full);font-size:0.65rem;font-weight:700}
    .header-right{display:flex;align-items:center;gap:12px}.header-link{color:rgba(255,255,255,0.7);font-size:0.8rem;font-weight:600;cursor:pointer}.header-link:hover{color:white}
    .user-badge{display:flex;align-items:center;gap:6px;padding:5px 10px;background:rgba(255,255,255,0.1);border-radius:var(--radius-full);color:white;font-size:0.8rem}.user-badge-avatar{width:26px;height:26px;background:var(--sage);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem}
    .layout{display:grid;grid-template-columns:220px 1fr;min-height:calc(100vh - 58px)}
    .sidebar{background:var(--white);border-right:1px solid var(--cream-dark);padding:16px 0;overflow-y:auto}.sidebar-section{margin-bottom:16px}.sidebar-title{padding:0 16px;font-size:0.6rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);font-weight:700;margin-bottom:4px}.sidebar-nav{list-style:none}
    .sidebar-link{display:flex;align-items:center;gap:8px;padding:9px 16px;color:var(--text-light);font-size:0.8rem;font-weight:600;cursor:pointer;border:none;background:none;width:100%;text-align:left;transition:all 0.2s}.sidebar-link:hover{background:var(--cream);color:var(--text)}.sidebar-link.active{background:var(--admin-muted);color:var(--admin-dark);border-right:3px solid var(--admin)}.sidebar-link-icon{font-size:0.95rem;width:20px;text-align:center}
    @media(max-width:900px){.layout{grid-template-columns:1fr}.sidebar{display:none}.main{padding:16px!important}.stats-grid{grid-template-columns:repeat(2,1fr)!important}.config-grid,.tools-grid,.addon-grid,.plan-grid{grid-template-columns:1fr!important}}
    .main{padding:20px;max-width:1400px}.section{display:none}.section.active{display:block}
    .section-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px}.section-title{font-family:'Quicksand',sans-serif;font-size:1.3rem;font-weight:700;color:var(--admin-dark)}.section-description{color:var(--text-muted);font-size:0.8rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}.stat-card{background:var(--white);border-radius:var(--radius-lg);padding:14px;box-shadow:var(--shadow-soft);display:flex;align-items:center;gap:12px}.stat-icon{width:40px;height:40px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.1rem}.stat-value{font-size:1.4rem;font-weight:700;color:var(--admin-dark)}.stat-label{font-size:0.7rem;color:var(--text-muted)}
    .card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden;margin-bottom:16px}.card-header{padding:12px 16px;border-bottom:1px solid var(--cream-dark);display:flex;align-items:center;justify-content:space-between}.card-title{font-family:'Quicksand',sans-serif;font-weight:700;font-size:0.9rem}.card-body{padding:16px}
    .table-container{overflow-x:auto}.table{width:100%;border-collapse:collapse;font-size:0.8rem}.table th,.table td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--cream-dark)}.table th{background:var(--cream);font-weight:700;font-size:0.7rem;text-transform:uppercase;color:var(--text-muted)}.table tr:hover{background:var(--cream)}
    .badge{display:inline-block;padding:2px 8px;border-radius:var(--radius-full);font-size:0.65rem;font-weight:600}.badge-success{background:rgba(72,187,120,0.2);color:var(--success)}.badge-warning{background:rgba(236,201,75,0.2);color:#B7791F}.badge-error{background:rgba(245,101,101,0.2);color:var(--error)}.badge-info{background:rgba(66,153,225,0.2);color:var(--info)}.badge-neutral{background:var(--cream-dark);color:var(--text-muted)}
    .btn{padding:8px 14px;border-radius:var(--radius-md);font-family:'Nunito',sans-serif;font-size:0.8rem;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}.btn-primary{background:var(--admin);color:white}.btn-primary:hover{background:var(--admin-dark)}.btn-secondary{background:var(--cream-dark);color:var(--text)}.btn-success{background:var(--success);color:white}.btn-sm{padding:5px 10px;font-size:0.75rem}
    .toolbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}.search-box{display:flex;align-items:center;gap:8px;background:var(--white);border:2px solid var(--cream-dark);border-radius:var(--radius-md);padding:6px 10px;flex:1;max-width:300px}.search-input{border:none;outline:none;font-family:'Nunito',sans-serif;font-size:0.8rem;flex:1;background:transparent}.filter-select{padding:8px 12px;border:2px solid var(--cream-dark);border-radius:var(--radius-md);font-family:'Nunito',sans-serif;font-size:0.8rem;background:var(--white)}
    .form-group{margin-bottom:14px}.form-label{display:block;font-size:0.8rem;font-weight:600;margin-bottom:4px}.form-input,.form-select,.form-textarea{width:100%;padding:8px 10px;border:2px solid var(--cream-dark);border-radius:var(--radius-md);font-family:'Nunito',sans-serif;font-size:0.8rem}.form-textarea{resize:vertical;min-height:80px}.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--admin)}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .switch{position:relative;display:inline-block;width:44px;height:24px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--cream-dark);border-radius:24px;transition:0.3s}.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;border-radius:50%;transition:0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2)}input:checked+.slider{background-color:var(--success)}input:checked+.slider:before{transform:translateX(20px)}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s;padding:16px}.modal-overlay.active{opacity:1;visibility:visible}.modal{background:var(--white);border-radius:var(--radius-lg);width:100%;max-width:500px;max-height:90vh;overflow-y:auto}.modal-header{padding:14px 20px;border-bottom:1px solid var(--cream-dark);display:flex;justify-content:space-between;align-items:center}.modal-title{font-family:'Quicksand',sans-serif;font-weight:700;font-size:1rem}.modal-close{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--text-muted)}.modal-body{padding:20px}.modal-footer{padding:12px 20px;border-top:1px solid var(--cream-dark);display:flex;justify-content:flex-end;gap:10px}
    .config-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}.config-card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden}.config-card-header{padding:12px 14px;background:var(--admin-muted);border-bottom:1px solid var(--cream-dark);display:flex;align-items:center;gap:8px}.config-card-icon{font-size:1.1rem}.config-card-title{font-weight:700;font-size:0.85rem}.config-card-body{padding:14px}.config-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--cream-dark)}.config-item:last-child{border-bottom:none}.config-item-label{font-size:0.8rem;color:var(--text-light)}.config-input{width:70px;padding:5px 8px;border:2px solid var(--cream-dark);border-radius:var(--radius-sm);text-align:center;font-weight:600;font-size:0.8rem}
    .tools-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}.tool-card{background:var(--white);border-radius:var(--radius-md);padding:14px;box-shadow:var(--shadow-soft);display:flex;align-items:center;gap:12px}.tool-icon{width:36px;height:36px;background:var(--cream);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1.1rem}.tool-info{flex:1}.tool-name{font-weight:600;font-size:0.85rem}.tool-status{font-size:0.7rem;color:var(--text-muted)}
    .plan-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}.plan-card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden}.plan-card-header{padding:16px;text-align:center}.plan-card-header.free{background:var(--admin-muted)}.plan-card-header.plus{background:rgba(66,153,225,0.15)}.plan-card-header.premium{background:rgba(236,201,75,0.15)}.plan-icon{font-size:2rem;margin-bottom:8px}.plan-name{font-family:'Quicksand',sans-serif;font-weight:700;font-size:1.1rem}.plan-price{font-size:1.5rem;font-weight:700;color:var(--admin-dark);margin-top:6px}.plan-price span{font-size:0.8rem;font-weight:400;color:var(--text-muted)}.plan-card-body{padding:16px}.plan-feature{display:flex;align-items:flex-start;gap:8px;padding:6px 0;font-size:0.8rem}.plan-feature-icon{color:var(--success);font-weight:700}.plan-card-footer{padding:12px 16px;border-top:1px solid var(--cream-dark);display:flex;justify-content:space-between;align-items:center}
    .addon-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}.addon-card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden}.addon-card-header{padding:14px;display:flex;align-items:center;gap:12px}.addon-card-header.crearrama{background:rgba(193,119,87,0.1)}.addon-card-header.mayordomo{background:rgba(139,115,85,0.1)}.addon-card-header.gerente{background:rgba(74,85,104,0.1)}.addon-card-header.capataz{background:rgba(107,142,35,0.1)}.addon-icon{font-size:1.5rem}.addon-name{font-weight:700;font-size:0.95rem}.addon-desc{font-size:0.75rem;color:var(--text-muted)}.addon-card-body{padding:14px;border-top:1px solid var(--cream-dark)}
    .addon-subtabs{display:flex;gap:4px;margin-bottom:20px;background:var(--cream-dark);border-radius:10px;padding:4px}.addon-subtab{flex:1;padding:10px 14px;border:none;border-radius:8px;font-family:'Nunito',sans-serif;font-size:0.82rem;font-weight:700;background:transparent;color:var(--text-light);cursor:pointer;transition:all 0.2s;text-align:center}.addon-subtab:hover{color:var(--text);background:rgba(255,255,255,0.5)}.addon-subtab.active{background:var(--admin);color:white;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
    .addon-subpanel{display:none}.addon-subpanel.active{display:block}
    .modulos-bloque{margin-bottom:20px;background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden}.modulos-bloque-header{padding:12px 16px;font-weight:700;font-size:0.88rem;color:white}.modulos-bloque-header.mayordomo{background:linear-gradient(135deg,#8B7355,#7A6548)}.modulos-bloque-header.gerente{background:linear-gradient(135deg,#4A5568,#2D3748)}.modulos-bloque-header.capataz{background:linear-gradient(135deg,#C17757,#A0604A)}
    .modulos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:8px;padding:16px}
    .modulo-chip{display:flex;align-items:center;gap:8px;padding:9px 12px;border-radius:8px;background:var(--cream);font-size:0.8rem;cursor:pointer;transition:all 0.15s;border:2px solid transparent;user-select:none}.modulo-chip:hover{background:var(--cream-dark)}.modulo-chip.active{border-color:var(--admin);background:rgba(66,153,225,0.08)}.modulo-chip input[type="checkbox"]{accent-color:var(--admin);margin:0}.modulo-chip-icon{font-size:1rem}.modulo-chip-name{font-weight:600;line-height:1.2}
    .service-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}.service-card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden}.service-header{padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--cream-dark)}.service-logo{width:40px;height:40px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.3rem}.service-name{font-weight:700;font-size:0.9rem}.service-type{font-size:0.7rem;color:var(--text-muted)}.service-status{padding:3px 8px;border-radius:var(--radius-full);font-size:0.65rem;font-weight:600}.service-status.activo{background:rgba(72,187,120,0.2);color:var(--success)}.service-status.inactivo{background:var(--cream-dark);color:var(--text-muted)}.service-body{padding:12px 16px}.service-field{margin-bottom:10px}.service-field-label{font-size:0.7rem;color:var(--text-muted);margin-bottom:3px}.service-field-value{font-family:monospace;font-size:0.75rem;padding:6px 8px;background:var(--cream);border-radius:var(--radius-sm)}.service-footer{padding:10px 16px;border-top:1px solid var(--cream-dark);display:flex;justify-content:space-between}
    .log-entry{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--cream-dark);font-size:0.8rem}.log-entry:last-child{border-bottom:none}.log-time{color:var(--text-muted);font-size:0.7rem;white-space:nowrap}.log-icon{font-size:1rem}.log-content{flex:1}.log-user{font-weight:600;color:var(--admin-dark)}.log-action{color:var(--text-light)}
    .notif-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--cream-dark)}.notif-item:last-child{border-bottom:none}.notif-label{font-size:0.85rem}.notif-desc{font-size:0.7rem;color:var(--text-muted)}
    .hidden{display:none!important}.text-center{text-align:center}.text-muted{color:var(--text-muted)}.mt-2{margin-top:12px}.mb-2{margin-bottom:12px}.divider{height:1px;background:var(--cream-dark);margin:16px 0}.empty-state{text-align:center;padding:30px 16px;color:var(--text-muted)}.loading{display:flex;align-items:center;justify-content:center;padding:30px}.spinner{width:32px;height:32px;border:3px solid var(--cream-dark);border-top-color:var(--admin);border-radius:50%;animation:spin 0.8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header class="header">
    <div class="logo"><img src="logo_familynk.png" alt="FAMILYNK" class="logo-icon"><span class="logo-text">FAMILYNK</span><span class="logo-badge">ADMIN</span></div>
    <div class="header-right"><span class="header-link" onclick="cerrarSesion()">Salir</span><div class="user-badge"><div class="user-badge-avatar" id="user-avatar">?</div><span id="user-name">Admin</span></div></div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section"><div class="sidebar-title">MÃ©tricas</div><nav class="sidebar-nav">
        <button class="sidebar-link active" data-section="dashboard" onclick="cambiarSeccion('dashboard')"><span class="sidebar-link-icon">ğŸ“Š</span>Dashboard</button>
        <button class="sidebar-link" data-section="logs" onclick="cambiarSeccion('logs')"><span class="sidebar-link-icon">ğŸ“‹</span>Logs</button>
      </nav></div>
      <div class="sidebar-section"><div class="sidebar-title">GestiÃ³n</div><nav class="sidebar-nav">
        <button class="sidebar-link" data-section="ramas" onclick="cambiarSeccion('ramas')"><span class="sidebar-link-icon">ğŸŒ³</span>Ramas</button>
        <button class="sidebar-link" data-section="estirpes" onclick="cambiarSeccion('estirpes')"><span class="sidebar-link-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>Estirpes</button>
        <button class="sidebar-link" data-section="nidos" onclick="cambiarSeccion('nidos')"><span class="sidebar-link-icon">ğŸªº</span>Nidos</button>
        <button class="sidebar-link" data-section="usuarios" onclick="cambiarSeccion('usuarios')"><span class="sidebar-link-icon">ğŸ‘¤</span>Usuarios</button>
        <button class="sidebar-link" data-section="invitaciones" onclick="cambiarSeccion('invitaciones')"><span class="sidebar-link-icon">âœ‰ï¸</span>Invitaciones</button>
      </nav></div>
      <div class="sidebar-section"><div class="sidebar-title">MonetizaciÃ³n</div><nav class="sidebar-nav">
        <button class="sidebar-link" data-section="planes" onclick="cambiarSeccion('planes')"><span class="sidebar-link-icon">ğŸ’³</span>Planes</button>
        <button class="sidebar-link" data-section="addons" onclick="cambiarSeccion('addons')"><span class="sidebar-link-icon">âš¡</span>Add-ons</button>
      </nav></div>
      <div class="sidebar-section"><div class="sidebar-title">ConfiguraciÃ³n</div><nav class="sidebar-nav">
        <button class="sidebar-link" data-section="cfg-locomun" onclick="cambiarSeccion('cfg-locomun')"><span class="sidebar-link-icon">ğŸ </span>Lo ComÃºn</button>
        <button class="sidebar-link" data-section="cfg-legado" onclick="cambiarSeccion('cfg-legado')"><span class="sidebar-link-icon">ğŸ“œ</span>Legado</button>
        <button class="sidebar-link" data-section="cfg-cerebro" onclick="cambiarSeccion('cfg-cerebro')"><span class="sidebar-link-icon">ğŸ§ </span>Cerebro</button>
        <button class="sidebar-link" data-section="cfg-activacion" onclick="cambiarSeccion('cfg-activacion')"><span class="sidebar-link-icon">ğŸ¯</span>ActivaciÃ³n</button>
        <button class="sidebar-link" data-section="cfg-arbol" onclick="cambiarSeccion('cfg-arbol')"><span class="sidebar-link-icon">ğŸŒ²</span>Ãrbol</button>
        <button class="sidebar-link" data-section="cfg-minido" onclick="cambiarSeccion('cfg-minido')"><span class="sidebar-link-icon">ğŸª¹</span>Mi Nido</button>
        <button class="sidebar-link" data-section="cfg-visibilidad" onclick="cambiarSeccion('cfg-visibilidad')"><span class="sidebar-link-icon">ğŸ‘ï¸</span>Visibilidad</button>
      </nav></div>
      <div class="sidebar-section"><div class="sidebar-title">Sistema</div><nav class="sidebar-nav">
        <button class="sidebar-link" data-section="estructura" onclick="cambiarSeccion('estructura')"><span class="sidebar-link-icon">ğŸ—ï¸</span>Estructura</button>
        <button class="sidebar-link" data-section="servicios" onclick="cambiarSeccion('servicios')"><span class="sidebar-link-icon">ğŸ”Œ</span>Servicios</button>
        <button class="sidebar-link" data-section="notificaciones" onclick="cambiarSeccion('notificaciones')"><span class="sidebar-link-icon">ğŸ””</span>Notificaciones</button>
        <button class="sidebar-link" data-section="backup" onclick="cambiarSeccion('backup')"><span class="sidebar-link-icon">ğŸ’¾</span>Backup</button>
        <button class="sidebar-link" data-section="legal" onclick="cambiarSeccion('legal')"><span class="sidebar-link-icon">âš–ï¸</span>Legal</button>
      </nav></div>
    </aside>

    <main class="main">
      <!-- DASHBOARD -->
      <section class="section active" id="section-dashboard">
        <div class="section-header"><div><h1 class="section-title">ğŸ“Š Dashboard</h1><p class="section-description">MÃ©tricas generales</p></div><button class="btn btn-success" onclick="guardarMetricasHoy()">ğŸ“¸ Guardar MÃ©tricas Hoy</button></div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon" style="background:rgba(193,119,87,0.2)">ğŸŒ³</div><div><div class="stat-value" id="stat-ramas">-</div><div class="stat-label">Ramas</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(122,158,126,0.2)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div><div><div class="stat-value" id="stat-estirpes">-</div><div class="stat-label">Estirpes</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(66,153,225,0.2)">ğŸªº</div><div><div class="stat-value" id="stat-nidos">-</div><div class="stat-label">Nidos</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:var(--sage-muted)">ğŸ‘¤</div><div><div class="stat-value" id="stat-usuarios">-</div><div class="stat-label">Usuarios</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(236,201,75,0.2)">âš¡</div><div><div class="stat-value" id="stat-addons">-</div><div class="stat-label">Add-ons</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(139,115,85,0.2)">ğŸ </div><div><div class="stat-value" id="stat-bienes">-</div><div class="stat-label">Bienes</div></div></div>
        </div>

        <!-- GRÃFICOS DE DISTRIBUCIÃ“N -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px;">
          <!-- DistribuciÃ³n de Planes -->
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ’³ Planes</span></div>
            <div class="card-body" style="text-align:center;">
              <div style="height:150px;position:relative;"><canvas id="chart-planes"></canvas></div>
              <div style="display:flex;justify-content:center;gap:12px;margin-top:8px;font-size:0.7rem;">
                <span><span style="color:#9CA3AF;">â—</span> Free: <b id="stat-plan-free">0</b></span>
                <span><span style="color:#4299E1;">â—</span> Plus: <b id="stat-plan-plus">0</b></span>
                <span><span style="color:#ECC94B;">â—</span> Premium: <b id="stat-plan-premium">0</b></span>
              </div>
            </div>
          </div>

          <!-- Invitaciones -->
          <div class="card">
            <div class="card-header"><span class="card-title">âœ‰ï¸ Invitaciones</span></div>
            <div class="card-body" style="text-align:center;">
              <div style="height:150px;position:relative;"><canvas id="chart-invitaciones"></canvas></div>
              <div style="display:flex;justify-content:center;gap:12px;margin-top:8px;font-size:0.7rem;">
                <span><span style="color:#48BB78;">â—</span> Aceptadas: <b id="stat-inv-aceptadas">0</b></span>
                <span><span style="color:#F6AD55;">â—</span> Pendientes: <b id="stat-inv-pendientes">0</b></span>
              </div>
              <div style="font-size:0.7rem;color:var(--text-muted);margin-top:4px;">Media reenvÃ­os: <b id="stat-media-reenvios">0</b></div>
            </div>
          </div>

          <!-- FacturaciÃ³n -->
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ’° FacturaciÃ³n</span></div>
            <div class="card-body" style="text-align:center;">
              <div style="font-size:2rem;font-weight:700;color:var(--admin-dark);margin:20px 0;" id="stat-facturacion-total">0â‚¬</div>
              <div style="font-size:0.8rem;color:var(--text-light);">MRR estimado</div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--cream-dark);">
                <div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:4px;">
                  <span>Media por cuenta:</span><b id="stat-facturacion-media">0â‚¬</b>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:4px;">
                  <span>Ingresos Planes:</span><b id="stat-ingresos-planes">0â‚¬</b>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:0.75rem;">
                  <span>Ingresos Add-ons:</span><b id="stat-ingresos-addons">0â‚¬</b>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- GRÃFICO DE EVOLUCIÃ“N -->
        <div class="card" style="margin-bottom:16px;">
          <div class="card-header"><span class="card-title">ğŸ“ˆ EvoluciÃ³n de mÃ©tricas</span><span class="text-muted" style="font-size:0.7rem;" id="historico-count">- registros</span></div>
          <div class="card-body" style="height:250px;position:relative;">
            <canvas id="chart-evolucion"></canvas>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card"><div class="card-header"><span class="card-title">ğŸ• Ãšltimas ramas</span></div><div class="card-body" id="ultimas-ramas"><div class="loading"><div class="spinner"></div></div></div></div>
          <div class="card"><div class="card-header"><span class="card-title">ğŸ“‹ HistÃ³rico guardado</span></div><div class="card-body" id="historico-lista" style="max-height:200px;overflow-y:auto;"><div class="loading"><div class="spinner"></div></div></div></div>
        </div>
      </section>

      <!-- LOGS -->
      <section class="section" id="section-logs">
        <div class="section-header"><div><h1 class="section-title">ğŸ“‹ Logs</h1></div><button class="btn btn-secondary" onclick="exportarLogs()">ğŸ“¥ Exportar</button></div>
        <div class="card"><div class="card-body" id="logs-lista"><div class="loading"><div class="spinner"></div></div></div></div>
      </section>

      <!-- RAMAS -->
      <section class="section" id="section-ramas">
        <div class="section-header"><div><h1 class="section-title">ğŸŒ³ Ramas</h1><p class="section-description">Cuentas / DinastÃ­as</p></div></div>
        <div class="toolbar"><div class="search-box"><span>ğŸ”</span><input type="text" class="search-input" placeholder="Buscar..."></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Rama</th><th>Admin</th><th>Actividad</th><th>Recursos</th><th>TrÃ¡fico</th><th>Plan</th><th>MRR</th><th>ğŸ”˜</th><th></th></tr></thead><tbody id="tabla-ramas"><tr><td colspan="9"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- ESTIRPES -->
      <section class="section" id="section-estirpes">
        <div class="section-header"><div><h1 class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Estirpes</h1><p class="section-description">Nidos + descendencia (excepto 1Âª gen)</p></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Estirpe</th><th>Rama</th><th>Nidos derivados</th><th>Generaciones</th><th>Miembros</th><th></th></tr></thead><tbody id="tabla-estirpes"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- NIDOS -->
      <section class="section" id="section-nidos">
        <div class="section-header"><div><h1 class="section-title">ğŸªº Nidos</h1></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Nido</th><th>Rama</th><th>Miembros</th><th>Admin</th><th>Gen</th><th></th></tr></thead><tbody id="tabla-nidos"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- USUARIOS -->
      <section class="section" id="section-usuarios">
        <div class="section-header"><div><h1 class="section-title">ğŸ‘¤ Usuarios</h1></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>#</th><th>Usuario</th><th>Rama</th><th>Nido</th><th>CÃ³d. Nido</th><th>Rol</th><th>Estado</th><th></th></tr></thead><tbody id="tabla-usuarios"><tr><td colspan="8"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- INVITACIONES -->
      <section class="section" id="section-invitaciones">
        <div class="section-header"><div><h1 class="section-title">âœ‰ï¸ Invitaciones</h1></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Email</th><th>Rama</th><th>Nido</th><th>Enviada</th><th>Estado</th><th></th></tr></thead><tbody id="tabla-invitaciones"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- PLANES -->
      <section class="section" id="section-planes">
        <div class="section-header"><div><h1 class="section-title">ğŸ’³ Planes</h1><p class="section-description">Suscripciones, recargas y descuentos</p></div><button class="btn btn-success" onclick="guardarPlanesConfig()">ğŸ’¾ Guardar todo</button></div>
        
        <div class="plan-grid" id="planes-grid">
          <!-- Gratuito -->
          <div class="plan-card">
            <div class="plan-card-header free"><span class="plan-icon">G</span><span class="plan-name">Gratuito</span></div>
            <div class="plan-card-body">
              <div class="form-group"><label class="form-label">DescripciÃ³n</label><input type="text" class="form-input" id="plan-gratuito-desc" value="Para empezar con tu familia"></div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Precio mensual</label><input type="number" class="form-input" id="plan-gratuito-mes" value="0" step="0.01"></div>
                <div class="form-group"><label class="form-label">Precio anual</label><input type="number" class="form-input" id="plan-gratuito-aÃ±o" value="0" step="0.01"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">MÃ¡x fotos</label><input type="number" class="form-input" id="plan-gratuito-fotos" value="100"></div>
                <div class="form-group"><label class="form-label">Generaciones</label><input type="number" class="form-input" id="plan-gratuito-gen" value="3"></div>
              </div>
              <div class="form-group"><label class="form-label">MÃ¡x bienes</label><input type="number" class="form-input" id="plan-gratuito-bienes" value="2"></div>
              <div class="form-group"><label class="form-label">Features (1 por lÃ­nea)</label><textarea class="form-textarea" id="plan-gratuito-features" rows="4">Hasta 3 generaciones
100 fotos
2 bienes compartidos
Ãrbol genealÃ³gico
Legado bÃ¡sico (3 categorÃ­as)
5 herramientas ActivaciÃ³n</textarea></div>
            </div>
          </div>

          <!-- Plus -->
          <div class="plan-card" style="border:2px solid var(--info);">
            <div class="plan-card-header plus"><span class="plan-icon">+</span><span class="plan-name">Plus</span><span class="badge badge-info" style="margin-left:auto;">Destacado</span></div>
            <div class="plan-card-body">
              <div class="form-group"><label class="form-label">DescripciÃ³n</label><input type="text" class="form-input" id="plan-plus-desc" value="Familia extendida"></div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Precio mensual</label><input type="number" class="form-input" id="plan-plus-mes" value="5.99" step="0.01"></div>
                <div class="form-group"><label class="form-label">Precio anual</label><input type="number" class="form-input" id="plan-plus-aÃ±o" value="49" step="0.01"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">MÃ¡x fotos</label><input type="number" class="form-input" id="plan-plus-fotos" value="500"></div>
                <div class="form-group"><label class="form-label">Generaciones</label><input type="number" class="form-input" id="plan-plus-gen" value="4"></div>
              </div>
              <div class="form-group"><label class="form-label">MÃ¡x bienes</label><input type="number" class="form-input" id="plan-plus-bienes" value="10"></div>
              <div class="form-group"><label class="form-label">Features (1 por lÃ­nea)</label><textarea class="form-textarea" id="plan-plus-features" rows="4">Hasta 4 generaciones
500 fotos
Todo lo del plan Gratuito
Amigo Invisible
Quinielas familiares
Votaciones y encuestas</textarea></div>
            </div>
          </div>

          <!-- Premium -->
          <div class="plan-card">
            <div class="plan-card-header premium"><span class="plan-icon">P</span><span class="plan-name">Premium</span></div>
            <div class="plan-card-body">
              <div class="form-group"><label class="form-label">DescripciÃ³n</label><input type="text" class="form-input" id="plan-premium-desc" value="Todo incluido"></div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Precio mensual</label><input type="number" class="form-input" id="plan-premium-mes" value="9.99" step="0.01"></div>
                <div class="form-group"><label class="form-label">Precio anual</label><input type="number" class="form-input" id="plan-premium-aÃ±o" value="99" step="0.01"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">MÃ¡x fotos</label><input type="number" class="form-input" id="plan-premium-fotos" value="9999"></div>
                <div class="form-group"><label class="form-label">Generaciones</label><input type="number" class="form-input" id="plan-premium-gen" value="99"></div>
              </div>
              <div class="form-group"><label class="form-label">MÃ¡x bienes</label><input type="number" class="form-input" id="plan-premium-bienes" value="999"></div>
              <div class="form-group"><label class="form-label">Features (1 por lÃ­nea)</label><textarea class="form-textarea" id="plan-premium-features" rows="4">Generaciones ilimitadas
Fotos ilimitadas
Todo lo del plan Plus
FusiÃ³n de Ramas
Colocar Mesas
Escaleta eventos
Soporte prioritario</textarea></div>
            </div>
          </div>
        </div>

        <div class="divider" style="margin:24px 0;border-top:1px solid var(--cream-dark);"></div>
        <h3 style="font-size:0.95rem;color:var(--admin-dark);margin-bottom:16px;">ğŸ›’ Recargas (compras Ãºnicas)</h3>
        <p class="text-muted mb-2" style="font-size:0.75rem;">Packs para ampliar lÃ­mites cuando el usuario agota su cuota del plan.</p>
        <div class="config-grid">
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ“¸</span><span class="config-card-title">+Fotos</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" id="recarga-fotos-precio" value="1.99" step="0.01"> â‚¬</div>
              <div class="config-item"><span class="config-item-label">Cantidad</span><input type="number" class="config-input" id="recarga-fotos-cantidad" value="50"> fotos</div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="recarga-fotos-activo" checked><span class="slider"></span></label></div>
            </div>
          </div>
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ </span><span class="config-card-title">+Bienes</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" id="recarga-bienes-precio" value="2.99" step="0.01"> â‚¬</div>
              <div class="config-item"><span class="config-item-label">Cantidad</span><input type="number" class="config-input" id="recarga-bienes-cantidad" value="5"> bienes</div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="recarga-bienes-activo" checked><span class="slider"></span></label></div>
            </div>
          </div>
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ”§</span><span class="config-card-title">+Herramientas</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" id="recarga-herramientas-precio" value="0.99" step="0.01"> â‚¬</div>
              <div class="config-item"><span class="config-item-label">Cantidad</span><input type="number" class="config-input" id="recarga-herramientas-cantidad" value="1"> herramienta</div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="recarga-herramientas-activo" checked><span class="slider"></span></label></div>
            </div>
          </div>
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ“¦</span><span class="config-card-title">+Almacenamiento</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" id="recarga-storage-precio" value="4.99" step="0.01"> â‚¬</div>
              <div class="config-item"><span class="config-item-label">Cantidad</span><input type="number" class="config-input" id="recarga-storage-cantidad" value="1"> GB</div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="recarga-storage-activo"><span class="slider"></span></label></div>
            </div>
          </div>
        </div>

        <div class="divider" style="margin:24px 0;border-top:1px solid var(--cream-dark);"></div>
        <h3 style="font-size:0.95rem;color:var(--admin-dark);margin-bottom:16px;">ğŸ·ï¸ Descuentos <span class="badge badge-warning" style="font-size:0.65rem;vertical-align:middle;">Solo Admin</span></h3>
        <p class="text-muted mb-2" style="font-size:0.75rem;">CÃ³digos de descuento invisibles para usuarios. Se aplican manualmente desde el modal de cada Rama.</p>
        <div class="config-grid">
          <div class="config-card">
            <div class="config-card-header" style="background:rgba(66,153,225,0.1);"><span class="config-card-icon">ğŸ«</span><span class="config-card-title">Promo</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Descuento</span><input type="number" class="config-input" id="descuento-promo" value="20" min="0" max="100">%</div>
              <div class="config-item"><span class="config-item-label">DescripciÃ³n</span><input type="text" class="form-input" id="descuento-promo-desc" value="PromociÃ³n temporal" style="font-size:0.75rem;"></div>
            </div>
          </div>
          <div class="config-card">
            <div class="config-card-header" style="background:rgba(122,158,126,0.15);"><span class="config-card-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span class="config-card-title">F&F (Friends & Family)</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Descuento</span><input type="number" class="config-input" id="descuento-ff" value="50" min="0" max="100">%</div>
              <div class="config-item"><span class="config-item-label">DescripciÃ³n</span><input type="text" class="form-input" id="descuento-ff-desc" value="Amigos y familiares cercanos" style="font-size:0.75rem;"></div>
            </div>
          </div>
          <div class="config-card">
            <div class="config-card-header" style="background:rgba(236,201,75,0.15);"><span class="config-card-icon">ğŸ</span><span class="config-card-title">Gratis</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Descuento</span><input type="number" class="config-input" id="descuento-gratis" value="100" min="0" max="100" disabled>%</div>
              <div class="config-item"><span class="config-item-label">DescripciÃ³n</span><input type="text" class="form-input" id="descuento-gratis-desc" value="Beta testers / casos especiales" style="font-size:0.75rem;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ADD-ONS -->
      <section class="section" id="section-addons">
        <div class="section-header"><div><h1 class="section-title">âš¡ Add-ons</h1><p class="section-description">Aplicativos de gestiÃ³n: precios, mÃ³dulos y parÃ¡metros</p></div><button class="btn btn-success" onclick="guardarAddonsConfig()">ğŸ’¾ Guardar todo</button></div>

        <!-- Sub-tabs -->
        <div class="addon-subtabs">
          <button class="addon-subtab active" data-subtab="precios" onclick="cambiarSubtabAddon('precios')">ğŸ’¶ Precios</button>
          <button class="addon-subtab" data-subtab="modulos" onclick="cambiarSubtabAddon('modulos')">ğŸ“¦ MÃ³dulos</button>
          <button class="addon-subtab" data-subtab="parametros" onclick="cambiarSubtabAddon('parametros')">âš™ï¸ ParÃ¡metros</button>
        </div>

        <!-- SUB 1: PRECIOS -->
        <div class="addon-subpanel active" id="subpanel-precios">
          <div class="addon-grid">
            <div class="addon-card"><div class="addon-card-header crearrama"><span class="addon-icon">ğŸŒ³</span><div><div class="addon-name">Crear Rama</div><div class="addon-desc">Bifurcar nueva cuenta</div></div></div><div class="addon-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" id="addon-crearrama-precio" value="9.99" step="0.01"> â‚¬/mes</div><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="addon-crearrama-activo" checked><span class="slider"></span></label></div></div></div>
            <div class="addon-card"><div class="addon-card-header mayordomo"><span class="addon-icon">ğŸ©</span><div><div class="addon-name">Mayordomo</div><div class="addon-desc">GestiÃ³n domÃ©stica</div></div></div><div class="addon-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" id="addon-mayordomo-precio" value="4.99" step="0.01"> â‚¬/mes</div><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="addon-mayordomo-activo" checked><span class="slider"></span></label></div></div></div>
            <div class="addon-card"><div class="addon-card-header gerente"><span class="addon-icon">ğŸ¨</span><div><div class="addon-name">Gerente</div><div class="addon-desc">Alquiler turÃ­stico</div></div></div><div class="addon-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" id="addon-gerente-precio" value="9.99" step="0.01"> â‚¬/mes</div><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="addon-gerente-activo" checked><span class="slider"></span></label></div></div></div>
            <div class="addon-card"><div class="addon-card-header capataz"><span class="addon-icon">ğŸŒ¾</span><div><div class="addon-name">Capataz</div><div class="addon-desc">GestiÃ³n rural</div></div></div><div class="addon-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" id="addon-capataz-precio" value="9.99" step="0.01"> â‚¬/mes</div><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="addon-capataz-activo" checked><span class="slider"></span></label></div></div></div>
          </div>
        </div>

        <!-- SUB 2: MÃ“DULOS DE GESTIÃ“N -->
        <div class="addon-subpanel" id="subpanel-modulos">
          <p class="text-muted" style="font-size:0.78rem;margin-bottom:16px;">Define quÃ© mÃ³dulos incluye cada Add-on. El Admin Rama solo podrÃ¡ activar/desactivar los que tÃº habilites aquÃ­.</p>

          <!-- ğŸ© Mayordomo -->
          <div class="modulos-bloque">
            <div class="modulos-bloque-header mayordomo">ğŸ© Mayordomo â€” MÃ³dulos de gestiÃ³n</div>
            <div class="modulos-grid" id="sys-modulos-mayordomo"></div>
          </div>

          <!-- ğŸ¨ Gerente -->
          <div class="modulos-bloque">
            <div class="modulos-bloque-header gerente">ğŸ¨ Gerente â€” MÃ³dulos de gestiÃ³n</div>
            <div class="modulos-grid" id="sys-modulos-gerente"></div>
          </div>

          <!-- ğŸŒ¾ Capataz -->
          <div class="modulos-bloque">
            <div class="modulos-bloque-header capataz">ğŸŒ¾ Capataz â€” MÃ³dulos de gestiÃ³n</div>
            <div class="modulos-grid" id="sys-modulos-capataz"></div>
          </div>
        </div>

        <!-- SUB 3: OTROS PARÃMETROS -->
        <div class="addon-subpanel" id="subpanel-parametros">
          <p class="text-muted" style="font-size:0.78rem;margin-bottom:16px;">Funcionalidades extra opcionales que aplican por bien. El Admin Rama podrÃ¡ activar/desactivar los que habilites aquÃ­.</p>

          <!-- ğŸ© Mayordomo params -->
          <div class="modulos-bloque">
            <div class="modulos-bloque-header mayordomo">ğŸ© Mayordomo â€” ParÃ¡metros</div>
            <div class="modulos-grid" id="sys-params-mayordomo"></div>
          </div>

          <!-- ğŸ¨ Gerente params -->
          <div class="modulos-bloque">
            <div class="modulos-bloque-header gerente">ğŸ¨ Gerente â€” ParÃ¡metros</div>
            <div class="modulos-grid" id="sys-params-gerente"></div>
          </div>

          <!-- ğŸŒ¾ Capataz params -->
          <div class="modulos-bloque">
            <div class="modulos-bloque-header capataz">ğŸŒ¾ Capataz â€” ParÃ¡metros</div>
            <div class="modulos-grid" id="sys-params-capataz"></div>
          </div>
        </div>
      </section>

      <!-- CFG: LO COMÃšN -->
      <section class="section" id="section-cfg-locomun">
        <div class="section-header"><div><h1 class="section-title">ğŸ  Lo ComÃºn</h1><p class="section-description">Bienes compartidos</p></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“¦</span><span class="config-card-title">LÃ­mites bienes</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Free</span><input type="number" class="config-input" value="3"></div><div class="config-item"><span class="config-item-label">Plus</span><input type="number" class="config-input" value="10"></div><div class="config-item"><span class="config-item-label">Premium</span><input type="number" class="config-input" value="99"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ–¼ï¸</span><span class="config-card-title">ImÃ¡genes</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">MÃ¡x por bien</span><input type="number" class="config-input" value="10"></div><div class="config-item"><span class="config-item-label">TamaÃ±o (MB)</span><input type="number" class="config-input" value="5"></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: LEGADO -->
      <section class="section" id="section-cfg-legado">
        <div class="section-header"><div><h1 class="section-title">ğŸ“œ Legado</h1><p class="section-description">Herencia familiar por plan</p></div></div>
        <p class="text-muted mb-2" style="font-size:0.8rem;">ğŸ’¡ Si activas en Free, se incluye automÃ¡ticamente en Plus y Premium. LÃ­mites = elementos mÃ¡ximos por rama.</p>
        
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“¸</span><span class="config-card-title">Fotos</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="10" title="Free" style="width:45px;"><input type="number" class="config-input" value="50" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Premium" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“–</span><span class="config-card-title">Historias</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="5" title="Free" style="width:45px;"><input type="number" class="config-input" value="20" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Premium" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ³</span><span class="config-card-title">Recetas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="5" title="Free" style="width:45px;"><input type="number" class="config-input" value="30" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Premium" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ˜‚</span><span class="config-card-title">AnÃ©cdotas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="5" title="Free" style="width:45px;"><input type="number" class="config-input" value="20" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Premium" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ­</span><span class="config-card-title">Tradiciones</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="0" title="Free" style="width:45px;"><input type="number" class="config-input" value="10" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Premium" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ’</span><span class="config-card-title">Valores</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="0" title="Free" style="width:45px;"><input type="number" class="config-input" value="10" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Premium" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ’¡</span><span class="config-card-title">SabidurÃ­a</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="0" title="Free" style="width:45px;"><input type="number" class="config-input" value="0" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Premium" style="width:45px;"></div></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: CEREBRO -->
      <section class="section" id="section-cfg-cerebro">
        <div class="section-header"><div><h1 class="section-title">ğŸ§  Cerebro</h1><p class="section-description">Motores de organizaciÃ³n</p></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ’­</span><span class="config-card-title">Memoria</span><span class="badge badge-neutral" style="margin-left:auto;">PrÃ³ximamente</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Recuerdos, fechas, tradiciones</p></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">âš™ï¸</span><span class="config-card-title">Razonamiento</span><span class="badge badge-neutral" style="margin-left:auto;">PrÃ³ximamente</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Decisiones, consensos</p></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">âœ¨</span><span class="config-card-title">IntuiciÃ³n</span><span class="badge badge-neutral" style="margin-left:auto;">PrÃ³ximamente</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Sugerencias, alertas</p></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“Š</span><span class="config-card-title">AnÃ¡lisis</span><span class="badge badge-neutral" style="margin-left:auto;">PrÃ³ximamente</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">EstadÃ­sticas, informes</p></div></div>
        </div>
      </section>

      <!-- CFG: ACTIVACIÃ“N -->
      <section class="section" id="section-cfg-activacion">
        <div class="section-header"><div><h1 class="section-title">ğŸ¯ ActivaciÃ³n</h1><p class="section-description">Herramientas disponibles por plan</p></div></div>
        <p class="text-muted mb-2" style="font-size:0.8rem;">ğŸ’¡ Si activas en Free, se incluye automÃ¡ticamente en Plus y Premium. Si activas en Plus, se incluye en Premium.</p>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ’¬</span><span class="config-card-title">Chat</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“…</span><span class="config-card-title">Eventos/Calendario</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ</span><span class="config-card-title">Amigo Invisible</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“Š</span><span class="config-card-title">Encuestas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“¸</span><span class="config-card-title">GalerÃ­a</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ”„</span><span class="config-card-title">Turno</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ—³ï¸</span><span class="config-card-title">Votaciones</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“</span><span class="config-card-title">Listas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸª‘</span><span class="config-card-title">Colocar Mesas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“‹</span><span class="config-card-title">Escaleta</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“…</span><span class="config-card-title">Elegir Fechas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Premium</label></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: ÃRBOL -->
      <section class="section" id="section-cfg-arbol">
        <div class="section-header"><div><h1 class="section-title">ğŸŒ² Ãrbol</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“</span><span class="config-card-title">Generaciones</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Free</span><input type="number" class="config-input" value="2"></div><div class="config-item"><span class="config-item-label">Plus</span><input type="number" class="config-input" value="4"></div><div class="config-item"><span class="config-item-label">Premium</span><input type="number" class="config-input" value="99"></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: MI NIDO -->
      <section class="section" id="section-cfg-minido">
        <div class="section-header"><div><h1 class="section-title">ğŸª¹ Mi Nido</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ‘¤</span><span class="config-card-title">Perfil</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Foto</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item"><span class="config-item-label">Contacto</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item"><span class="config-item-label">Rasgos</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ¾</span><span class="config-card-title">Mascotas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Permitir</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item"><span class="config-item-label">MÃ¡ximo</span><input type="number" class="config-input" value="5"></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: VISIBILIDAD -->
      <section class="section" id="section-cfg-visibilidad">
        <div class="section-header"><div><h1 class="section-title">ğŸ‘ï¸ Visibilidad</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸŒ³</span><span class="config-card-title">Rama</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Toda la dinastÃ­a</p><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span class="config-card-title">Estirpe</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Descendencia</p><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸªº</span><span class="config-card-title">Nido</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Solo el hogar</p><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
        </div>
        <div class="card mt-2"><div class="card-header"><span class="card-title">Apartados donde aplica</span></div><div class="card-body">
          <div class="config-item"><span class="config-item-label">Lo ComÃºn</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
          <div class="config-item"><span class="config-item-label">Legado</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
          <div class="config-item"><span class="config-item-label">ActivaciÃ³n</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
        </div></div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- ESTRUCTURA -->
      <section class="section" id="section-estructura">
        <div class="section-header"><div><h1 class="section-title">ğŸ—ï¸ Estructura</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">âœ‰ï¸</span><span class="config-card-title">Invitaciones</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">ExpiraciÃ³n (dÃ­as)</span><input type="number" class="config-input" id="config-invitacion-expiracion" value="7"></div><div class="config-item"><span class="config-item-label">ReenvÃ­os mÃ¡x</span><input type="number" class="config-input" id="config-invitacion-reenvios" value="3"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ§ª</span><span class="config-card-title">Trials</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">DÃ­as prueba</span><input type="number" class="config-input" id="config-trial-dias" value="14"></div></div></div>
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ”¢</span><span class="config-card-title">NumeraciÃ³n</span></div>
            <div class="config-card-body">
              <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">Sistema de cÃ³digos para nidos (1.2.3) y miembros (#1, #2...)</p>
              <div class="form-group">
                <label class="form-label">Familia a numerar</label>
                <select class="form-select" id="numeracion-familia" style="width:100%;padding:8px;">
                  <option value="">Cargando familias...</option>
                </select>
              </div>
              <button class="btn btn-primary" style="width:100%;" onclick="ejecutarNumeracion()">ğŸ”¢ Ejecutar NumeraciÃ³n</button>
              <div id="numeracion-resultado" style="margin-top:12px;font-size:0.8rem;display:none;"></div>
            </div>
          </div>
        </div>
        <div class="mt-2"><button class="btn btn-primary" onclick="guardarConfigEstructura()">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- SERVICIOS -->
      <section class="section" id="section-servicios">
        <div class="section-header"><div><h1 class="section-title">ğŸ”Œ Servicios</h1></div></div>
        <div class="service-grid">
          <div class="service-card"><div class="service-header"><div class="service-logo" style="background:#FFCA28;">ğŸ”¥</div><div style="flex:1;"><div class="service-name">Firebase</div><div class="service-type">Auth + Firestore</div></div><span class="service-status activo">Activo</span></div><div class="service-body"><div class="service-field"><div class="service-field-label">Project</div><div class="service-field-value">familynk-dfadb</div></div></div><div class="service-footer"><a href="https://console.firebase.google.com" target="_blank" class="btn btn-sm btn-secondary">Abrir â†’</a></div></div>
          <div class="service-card"><div class="service-header"><div class="service-logo" style="background:#EA4335;">ğŸ“§</div><div style="flex:1;"><div class="service-name">EmailJS</div><div class="service-type">Emails</div></div><span class="service-status activo">Activo</span></div><div class="service-body"><div class="service-field"><div class="service-field-label">Service</div><div class="service-field-value">service_fcfx5od</div></div></div><div class="service-footer"><a href="https://dashboard.emailjs.com" target="_blank" class="btn btn-sm btn-secondary">Abrir â†’</a></div></div>
          <div class="service-card" style="opacity:0.6;"><div class="service-header"><div class="service-logo" style="background:#635BFF;color:white;">ğŸ’³</div><div style="flex:1;"><div class="service-name">Stripe</div><div class="service-type">Pagos</div></div><span class="service-status inactivo">Pendiente</span></div><div class="service-body text-center"><p class="text-muted">Configurar para pagos</p></div><div class="service-footer"><button class="btn btn-sm btn-primary">ğŸ”§ Configurar</button></div></div>
        </div>
      </section>

      <!-- NOTIFICACIONES -->
      <section class="section" id="section-notificaciones">
        <div class="section-header"><div><h1 class="section-title">ğŸ”” Notificaciones</h1></div></div>
        <div class="card"><div class="card-body">
          <div class="notif-item"><div><div class="notif-label">Nueva rama</div><div class="notif-desc">Cuando se crea una cuenta</div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
          <div class="notif-item"><div><div class="notif-label">Nuevo usuario</div><div class="notif-desc">Cuando aceptan invitaciÃ³n</div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
          <div class="notif-item"><div><div class="notif-label">Add-on activado</div><div class="notif-desc">MÃ³dulo de pago</div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
          <div class="notif-item"><div><div class="notif-label">Error sistema</div><div class="notif-desc">Alertas crÃ­ticas</div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
        </div></div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- BACKUP -->
      <section class="section" id="section-backup">
        <div class="section-header"><div><h1 class="section-title">ğŸ’¾ Backup</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“¤</span><span class="config-card-title">Exportar</span></div><div class="config-card-body"><button class="btn btn-secondary mb-2" style="width:100%;" onclick="exportarBackup('ramas')">ğŸŒ³ Ramas</button><button class="btn btn-secondary mb-2" style="width:100%;" onclick="exportarBackup('usuarios')">ğŸ‘¤ Usuarios</button><button class="btn btn-success" style="width:100%;" onclick="exportarBackup('todo')">ğŸ“¦ Todo</button></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“¥</span><span class="config-card-title">Restaurar</span></div><div class="config-card-body"><div class="form-group"><input type="file" class="form-input" accept=".json"></div><button class="btn btn-warning" style="width:100%;">âš ï¸ Restaurar</button></div></div>
        </div>
      </section>

      <!-- LEGAL -->
      <section class="section" id="section-legal">
        <div class="section-header"><div><h1 class="section-title">âš–ï¸ Legal</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“‹</span><span class="config-card-title">TÃ©rminos y Condiciones</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;margin-bottom:8px;">Ãšltima: <span id="tc-fecha">-</span></p><div class="form-group"><textarea class="form-textarea" id="tc-contenido" rows="6"></textarea></div><button class="btn btn-primary" onclick="guardarTerminos()">ğŸ’¾ Guardar</button><a href="terminos.html" target="_blank" class="btn btn-secondary" style="margin-left:8px;">ğŸ‘ï¸</a></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ”’</span><span class="config-card-title">Privacidad</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;margin-bottom:8px;">Ãšltima: <span id="pp-fecha">-</span></p><div class="form-group"><textarea class="form-textarea" id="pp-contenido" rows="6"></textarea></div><button class="btn btn-primary" onclick="guardarPrivacidad()">ğŸ’¾ Guardar</button><a href="privacidad.html" target="_blank" class="btn btn-secondary" style="margin-left:8px;">ğŸ‘ï¸</a></div></div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL PLAN -->
  <div class="modal-overlay" id="modal-plan">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">ğŸ’³ Plan</h3><button class="modal-close" onclick="cerrarModales()">Ã—</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Nombre</label><input type="text" class="form-input" id="plan-nombre"></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Precio (â‚¬/mes)</label><input type="number" class="form-input" id="plan-precio" step="0.01"></div><div class="form-group"><label class="form-label">Icono</label><input type="text" class="form-input" id="plan-icono" placeholder="ğŸŒŸ"></div></div>
        <div class="form-group"><label class="form-label">CaracterÃ­sticas</label><textarea class="form-textarea" id="plan-features" rows="4"></textarea></div>
        <div class="form-group"><label class="form-check"><input type="checkbox" id="plan-activo" checked> Activo</label></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button><button class="btn btn-primary" onclick="guardarPlan()">Guardar</button></div>
    </div>
  </div>

  <!-- MODAL FICHA RAMA -->
  <div class="modal-overlay" id="modal-rama">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header"><h3 class="modal-title">ğŸŒ³ Ficha de Rama</h3><button class="modal-close" onclick="cerrarModales()">Ã—</button></div>
      <div class="modal-body">
        <input type="hidden" id="rama-id">
        
        <!-- Info bÃ¡sica -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
          <div><div class="text-muted" style="font-size:0.7rem;">Nombre</div><div id="rama-nombre" style="font-weight:700;font-size:1.1rem;">-</div></div>
          <div><div class="text-muted" style="font-size:0.7rem;">Admin</div><div id="rama-admin">-</div></div>
          <div><div class="text-muted" style="font-size:0.7rem;">Nidos</div><div id="rama-nidos">-</div></div>
          <div><div class="text-muted" style="font-size:0.7rem;">Miembros</div><div id="rama-miembros">-</div></div>
          <div><div class="text-muted" style="font-size:0.7rem;">Creada</div><div id="rama-fecha">-</div></div>
          <div><div class="text-muted" style="font-size:0.7rem;">Plan actual</div><div id="rama-plan-actual">-</div></div>
        </div>

        <div class="divider"></div>

        <!-- Cambiar Plan -->
        <div class="form-group">
          <label class="form-label">ğŸ“‹ Plan de la Rama <span class="badge badge-warning" style="font-size:0.6rem;vertical-align:middle;">Solo Admin</span></label>
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:6px;padding:10px 16px;background:var(--cream);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;" class="plan-option">
              <input type="radio" name="rama-plan" value="gratuito"> <span>ğŸ†“ Gratuito</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:10px 16px;background:rgba(66,153,225,0.1);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;" class="plan-option">
              <input type="radio" name="rama-plan" value="plus"> <span>â­ Plus</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:10px 16px;background:rgba(193,119,87,0.15);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;" class="plan-option">
              <input type="radio" name="rama-plan" value="premium"> <span>ğŸ‘‘ Premium</span>
            </label>
          </div>
          <p class="text-muted" style="font-size:0.7rem;margin-top:6px;">âš ï¸ Cambiar el plan afecta las funcionalidades disponibles para toda la rama.</p>
        </div>

        <!-- Descuento en Plan -->
        <div class="form-group">
          <label class="form-label">ğŸ·ï¸ Descuento en Plan <span class="badge badge-warning" style="font-size:0.6rem;vertical-align:middle;">Solo Admin</span></label>
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--cream);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-plan" value="0" checked> Sin descuento
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(66,153,225,0.1);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-plan" value="20"> Promo <span class="badge badge-info">20%</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(122,158,126,0.15);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-plan" value="50"> F&F <span class="badge badge-warning">50%</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(72,187,120,0.1);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-plan" value="100"> Gratis <span class="badge badge-success">100%</span>
            </label>
          </div>
        </div>

        <!-- Descuento en Add-ons -->
        <div class="form-group">
          <label class="form-label">ğŸ§© Descuento en Add-ons <span class="badge badge-warning" style="font-size:0.6rem;vertical-align:middle;">Solo Admin</span></label>
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--cream);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-addon" value="0" checked> Sin descuento
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(66,153,225,0.1);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-addon" value="20"> Promo <span class="badge badge-info">20%</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(122,158,126,0.15);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-addon" value="50"> F&F <span class="badge badge-warning">50%</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(72,187,120,0.1);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-addon" value="100"> Gratis <span class="badge badge-success">100%</span>
            </label>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Add-ons activos -->
        <div class="form-group">
          <label class="form-label">ğŸ§© Add-ons activos</label>
          <div id="rama-addons" style="display:flex;gap:8px;flex-wrap:wrap;">-</div>
        </div>

        <!-- Notas admin -->
        <div class="form-group">
          <label class="form-label">ğŸ“ Notas internas</label>
          <textarea class="form-textarea" id="rama-notas" rows="2" placeholder="Notas visibles solo para AdminSistema..."></textarea>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button><button class="btn btn-primary" onclick="guardarRama()">ğŸ’¾ Guardar</button></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script>
    let currentUser=null,userData=null,ramasData=[],nidosData=[],usuariosData=[],logsData=[],planesData=[],historicoData=[],chartEvolucion=null;
    // Estirpe = Nido gen 2 (abuelos) con descendientes que tienen nidos propios
    function calcularEstirpes(nidos){
      const gen2=nidos.filter(n=>n.generacion==='2-abuelos'||n.generacion===2||n.generacion==='2');
      const estirpes=gen2.filter(abuelo=>{
        // Buscar si hay nidos que tengan nidoOrigen apuntando a este abuelo
        return nidos.some(n=>n.nidoOrigen===abuelo.id);
      });
      return estirpes;
    }
    auth.onAuthStateChanged(async user=>{if(!user){window.location.href='login.html';return}currentUser=user;const doc=await db.collection('usuarios').doc(user.uid).get();if(!doc.exists||(doc.data().rol!=='AdminSistema'&&!doc.data().superAdmin)){alert('Acceso denegado');window.location.href='login.html';return}userData=doc.data();document.getElementById('user-name').textContent=(userData.nombre||'Admin').split(' ')[0];document.getElementById('user-avatar').textContent=(userData.nombre||'A').charAt(0).toUpperCase();cargarDashboard()});
    function cerrarSesion(){auth.signOut().then(()=>window.location.href='login.html')}
    function cambiarSeccion(s){document.querySelectorAll('.sidebar-link').forEach(l=>l.classList.toggle('active',l.dataset.section===s));document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));document.getElementById(`section-${s}`).classList.add('active');const m={dashboard:cargarDashboard,logs:cargarLogs,ramas:cargarRamas,estirpes:cargarEstirpes,nidos:cargarNidos,usuarios:cargarUsuarios,invitaciones:cargarInvitaciones,planes:cargarPlanesConfig,addons:cargarAddonsConfig,legal:cargarLegal,estructura:cargarEstructura};if(m[s])m[s]()}
    
    function cargarEstructura() {
      cargarFamiliasNumeracion();
      cargarConfigEstructura();
    }
    let bienesData = [];
    async function cargarDashboard(){
      try{
        const[rS,nS,uS,bS,iS]=await Promise.all([
          db.collection('familias').get(),
          db.collection('nidos').get(),
          db.collection('usuarios').get(),
          db.collection('bienes').get(),
          db.collection('invitaciones-email').get()
        ]);
        ramasData=rS.docs.map(d=>({id:d.id,...d.data()}));
        nidosData=nS.docs.map(d=>({id:d.id,...d.data()}));
        usuariosData=uS.docs.map(d=>({id:d.id,...d.data()}));
        bienesData=bS.docs.map(d=>({id:d.id,...d.data()}));
        const invitacionesData=iS.docs.map(d=>({id:d.id,...d.data()}));
        
        // Stats bÃ¡sicos
        document.getElementById('stat-ramas').textContent=ramasData.length;
        const estirpes=calcularEstirpes(nidosData);
        document.getElementById('stat-estirpes').textContent=estirpes.length;
        document.getElementById('stat-nidos').textContent=nidosData.length;
        document.getElementById('stat-usuarios').textContent=usuariosData.length;
        document.getElementById('stat-bienes').textContent=bienesData.length;
        
        // Contar add-ons activos desde bienes
        let totalAddons = 0;
        bienesData.forEach(b => {
          if (b.mayordomoActivo) totalAddons++;
          if (b.gerenteActivo) totalAddons++;
          if (b.capatazActivo) totalAddons++;
        });
        document.getElementById('stat-addons').textContent=totalAddons;
        
        // Ãšltimas ramas
        document.getElementById('ultimas-ramas').innerHTML=ramasData.slice(0,5).map(r=>`<div class="log-entry"><span class="log-icon">ğŸŒ³</span><div class="log-content"><span class="log-user">${r.nombre||'-'}</span></div><span class="log-time">${r.fechaCreacion?.toDate?.().toLocaleDateString('es')||'-'}</span></div>`).join('')||'<p class="empty-state">Sin ramas</p>';
        
        // Cargar config de precios
        const planesDoc=await db.collection('config').doc('planes').get();
        const addonsDoc=await db.collection('config').doc('addons').get();
        const preciosPlanes=planesDoc.exists?planesDoc.data():{gratuito:{precioMensual:0},plus:{precioMensual:5.99},premium:{precioMensual:9.99}};
        const preciosAddons=addonsDoc.exists?addonsDoc.data():{mayordomo:{precio:4.99},gerente:{precio:9.99},capataz:{precio:9.99},crearRama:{precio:9.99}};
        
        // DistribuciÃ³n de planes
        let planFree=0,planPlus=0,planPremium=0;
        ramasData.forEach(r=>{
          const plan=(r.plan||'gratuito').toLowerCase();
          if(plan==='plus')planPlus++;
          else if(plan==='premium'||plan==='mega')planPremium++;
          else planFree++;
        });
        document.getElementById('stat-plan-free').textContent=planFree;
        document.getElementById('stat-plan-plus').textContent=planPlus;
        document.getElementById('stat-plan-premium').textContent=planPremium;
        renderChartPlanes(planFree,planPlus,planPremium);
        
        // Invitaciones (sin contar reenvÃ­os)
        const invitacionesUnicas=new Map();
        invitacionesData.forEach(inv=>{
          const key=inv.email;
          if(!invitacionesUnicas.has(key)||inv.estado==='aceptada'){
            invitacionesUnicas.set(key,inv);
          }
        });
        let aceptadas=0,pendientes=0,totalReenvios=0,usuariosConReenvio=0;
        invitacionesUnicas.forEach(inv=>{
          if(inv.estado==='aceptada')aceptadas++;
          else pendientes++;
        });
        // Calcular media de reenvÃ­os
        const reenviosPorEmail=new Map();
        invitacionesData.forEach(inv=>{
          const count=reenviosPorEmail.get(inv.email)||0;
          reenviosPorEmail.set(inv.email,count+1);
        });
        reenviosPorEmail.forEach((count,email)=>{
          if(count>1){totalReenvios+=(count-1);usuariosConReenvio++;}
        });
        const mediaReenvios=usuariosConReenvio>0?(totalReenvios/usuariosConReenvio).toFixed(1):'0';
        
        document.getElementById('stat-inv-aceptadas').textContent=aceptadas;
        document.getElementById('stat-inv-pendientes').textContent=pendientes;
        document.getElementById('stat-media-reenvios').textContent=mediaReenvios;
        renderChartInvitaciones(aceptadas,pendientes);
        
        // FacturaciÃ³n
        let ingresoPlanes=0,ingresoAddons=0;
        ramasData.forEach(r=>{
          const plan=(r.plan||'gratuito').toLowerCase();
          const descuento=(r.descuentoPlan||0)/100;
          if(plan==='plus')ingresoPlanes+=(preciosPlanes.plus?.precioMensual||5.99)*(1-descuento);
          else if(plan==='premium'||plan==='mega')ingresoPlanes+=(preciosPlanes.premium?.precioMensual||9.99)*(1-descuento);
        });
        
        // Ingresos por add-ons (desde bienes)
        bienesData.forEach(b => {
          const familia = ramasData.find(r => r.id === b.familiaId);
          const descuentoAddon = (familia?.descuentoAddon || 0) / 100;
          if (b.mayordomoActivo) ingresoAddons += (preciosAddons.mayordomo?.precio || 4.99) * (1 - descuentoAddon);
          if (b.gerenteActivo) ingresoAddons += (preciosAddons.gerente?.precio || 9.99) * (1 - descuentoAddon);
          if (b.capatazActivo) ingresoAddons += (preciosAddons.capataz?.precio || 9.99) * (1 - descuentoAddon);
        });
        
        const totalMRR=ingresoPlanes+ingresoAddons;
        const mediaPorCuenta=ramasData.length>0?(totalMRR/ramasData.length):0;
        
        document.getElementById('stat-facturacion-total').textContent=totalMRR.toFixed(2)+'â‚¬';
        document.getElementById('stat-facturacion-media').textContent=mediaPorCuenta.toFixed(2)+'â‚¬';
        document.getElementById('stat-ingresos-planes').textContent=ingresoPlanes.toFixed(2)+'â‚¬';
        document.getElementById('stat-ingresos-addons').textContent=ingresoAddons.toFixed(2)+'â‚¬';
        
        await cargarHistorico();
      }catch(e){console.error(e);}
    }
    
    let chartPlanes=null,chartInvitaciones=null;
    
    function renderChartPlanes(free,plus,premium){
      const ctx=document.getElementById('chart-planes');
      if(!ctx)return;
      if(chartPlanes)chartPlanes.destroy();
      chartPlanes=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Free','Plus','Premium'],
          datasets:[{data:[free,plus,premium],backgroundColor:['#9CA3AF','#4299E1','#ECC94B'],borderWidth:0}]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{legend:{display:false}},
          cutout:'65%'
        }
      });
    }
    
    function renderChartInvitaciones(aceptadas,pendientes){
      const ctx=document.getElementById('chart-invitaciones');
      if(!ctx)return;
      if(chartInvitaciones)chartInvitaciones.destroy();
      const total=aceptadas+pendientes;
      const pctAceptadas=total>0?Math.round((aceptadas/total)*100):0;
      chartInvitaciones=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Aceptadas','Pendientes'],
          datasets:[{data:[aceptadas,pendientes],backgroundColor:['#48BB78','#F6AD55'],borderWidth:0}]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            tooltip:{callbacks:{label:function(c){return c.label+': '+c.raw+' ('+Math.round((c.raw/total)*100)+'%)';}}}
          },
          cutout:'65%'
        }
      });
    }
    async function cargarHistorico(){
      try{
        const hS=await db.collection('metricas-historico').orderBy('fecha','desc').limit(30).get();
        historicoData=hS.docs.map(d=>({id:d.id,...d.data()}));
        document.getElementById('historico-count').textContent=historicoData.length+' registros';
        // Lista de histÃ³rico
        document.getElementById('historico-lista').innerHTML=historicoData.slice(0,8).map(h=>`<div class="log-entry" style="padding:6px 0;border-bottom:1px solid var(--cream-dark);"><span class="log-icon">ğŸ“¸</span><div class="log-content"><span style="font-weight:600;">${h.fecha?.toDate?.().toLocaleDateString('es',{weekday:'short',day:'numeric',month:'short'})||'-'}</span><span style="font-size:0.7rem;color:var(--text-muted);margin-left:8px;">ğŸŒ³${h.ramas} ğŸªº${h.nidos} ğŸ‘¤${h.usuarios}</span></div></div>`).join('')||'<p class="empty-state" style="font-size:0.8rem;color:var(--text-muted);">Sin histÃ³rico. Pulsa "Guardar MÃ©tricas Hoy"</p>';
        renderizarGrafico();
      }catch(e){console.error('Error cargando histÃ³rico:',e);document.getElementById('historico-lista').innerHTML='<p class="empty-state">Error cargando histÃ³rico</p>';}
    }
    function renderizarGrafico(){
      const ctx=document.getElementById('chart-evolucion');
      if(!ctx)return;
      if(chartEvolucion)chartEvolucion.destroy();
      const datosOrdenados=[...historicoData].reverse();
      const labels=datosOrdenados.map(h=>h.fecha?.toDate?.().toLocaleDateString('es',{day:'numeric',month:'short'})||'');
      chartEvolucion=new Chart(ctx,{
        type:'line',
        data:{
          labels:labels,
          datasets:[
            {label:'Ramas',data:datosOrdenados.map(h=>h.ramas||0),borderColor:'#C17757',backgroundColor:'rgba(193,119,87,0.1)',tension:0.3,fill:true},
            {label:'Nidos',data:datosOrdenados.map(h=>h.nidos||0),borderColor:'#4299E1',backgroundColor:'rgba(66,153,225,0.1)',tension:0.3,fill:true},
            {label:'Usuarios',data:datosOrdenados.map(h=>h.usuarios||0),borderColor:'#7A9E7E',backgroundColor:'rgba(122,158,126,0.1)',tension:0.3,fill:true}
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{legend:{position:'top',labels:{boxWidth:12,padding:15,font:{size:11}}}},
          scales:{y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.05)'}},x:{grid:{display:false}}}
        }
      });
    }
    async function guardarMetricasHoy(){
      const hoy=new Date();
      const fechaId=hoy.toISOString().split('T')[0];
      const ramas=parseInt(document.getElementById('stat-ramas').textContent)||0;
      const estirpes=parseInt(document.getElementById('stat-estirpes').textContent)||0;
      const nidos=parseInt(document.getElementById('stat-nidos').textContent)||0;
      const usuarios=parseInt(document.getElementById('stat-usuarios').textContent)||0;
      const addons=parseInt(document.getElementById('stat-addons').textContent)||0;
      const bienes=parseInt(document.getElementById('stat-bienes').textContent)||0;
      // Nuevas mÃ©tricas
      const planFree=parseInt(document.getElementById('stat-plan-free').textContent)||0;
      const planPlus=parseInt(document.getElementById('stat-plan-plus').textContent)||0;
      const planPremium=parseInt(document.getElementById('stat-plan-premium').textContent)||0;
      const invAceptadas=parseInt(document.getElementById('stat-inv-aceptadas').textContent)||0;
      const invPendientes=parseInt(document.getElementById('stat-inv-pendientes').textContent)||0;
      const mediaReenvios=parseFloat(document.getElementById('stat-media-reenvios').textContent)||0;
      const facturacionTotal=parseFloat(document.getElementById('stat-facturacion-total').textContent.replace('â‚¬',''))||0;
      const facturacionMedia=parseFloat(document.getElementById('stat-facturacion-media').textContent.replace('â‚¬',''))||0;
      try{
        await db.collection('metricas-historico').doc(fechaId).set({
          fecha:firebase.firestore.Timestamp.fromDate(hoy),
          ramas,estirpes,nidos,usuarios,addons,bienes,
          planes:{free:planFree,plus:planPlus,premium:planPremium},
          invitaciones:{aceptadas:invAceptadas,pendientes:invPendientes,mediaReenvios},
          facturacion:{mrr:facturacionTotal,mediaCuenta:facturacionMedia},
          guardadoPor:userData?.nombre||currentUser?.email||'Admin'
        });
        alert('âœ… MÃ©tricas guardadas para '+fechaId);
        await cargarHistorico();
      }catch(e){alert('Error guardando mÃ©tricas: '+e.message);}
    }
    async function cargarLogs(){const s=await db.collection('logs').orderBy('fecha','desc').limit(100).get();logsData=s.docs.map(d=>({id:d.id,...d.data()}));document.getElementById('logs-lista').innerHTML=logsData.map(l=>`<div class="log-entry"><span class="log-time">${l.fecha?.toDate?.().toLocaleString('es')||'-'}</span><span class="log-icon">ğŸ“‹</span><div class="log-content"><span class="log-user">${l.usuario||'Sistema'}</span> <span class="log-action">${l.accion||''}</span></div></div>`).join('')||'<p class="empty-state">Sin logs</p>'}
    function exportarLogs(){const c='Fecha,Usuario,AcciÃ³n\n'+logsData.map(l=>`"${l.fecha?.toDate?.().toISOString()||''}","${l.usuario||''}","${l.accion||''}"`).join('\n');descargar(c,'logs.csv','text/csv')}
    async function cargarRamas(){
      // Cargar todas las colecciones necesarias
      const [familiasSnap, usuariosSnap, nidosSnap, bienesSnap, invitacionesSnap] = await Promise.all([
        db.collection('familias').get(),
        db.collection('usuarios').get(),
        db.collection('nidos').get(),
        db.collection('bienes').get(),
        db.collection('invitaciones-email').get()
      ]);
      
      ramasData = familiasSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const todosUsuarios = usuariosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const todosNidos = nidosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const todosBienes = bienesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const todasInvitaciones = invitacionesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      
      // Cargar config de precios
      const planesDoc = await db.collection('config').doc('planes').get();
      const addonsDoc = await db.collection('config').doc('addons').get();
      const preciosPlanes = planesDoc.exists ? planesDoc.data() : { gratuito: { precioMensual: 0 }, plus: { precioMensual: 5.99 }, premium: { precioMensual: 9.99 } };
      const preciosAddons = addonsDoc.exists ? addonsDoc.data() : { mayordomo: { precio: 4.99 }, gerente: { precio: 9.99 }, capataz: { precio: 9.99 } };
      
      const filas = ramasData.map(r => {
        // Calcular mÃ©tricas para esta familia
        const usuarios = todosUsuarios.filter(u => u.familiaId === r.id);
        const usuariosActivos = usuarios.filter(u => u.estado === 'activo' || u.emailVerified || u.ultimoAcceso);
        const nidos = todosNidos.filter(n => n.familiaId === r.id);
        const bienes = todosBienes.filter(b => b.familiaId === r.id);
        const invitaciones = todasInvitaciones.filter(i => i.familiaId === r.id);
        
        // Add-ons activos
        let addonsActivos = 0;
        bienes.forEach(b => {
          if (b.mayordomoActivo) addonsActivos++;
          if (b.gerenteActivo) addonsActivos++;
          if (b.capatazActivo) addonsActivos++;
        });
        
        // Emails enviados (invitaciones este mes)
        const inicioMes = new Date();
        inicioMes.setDate(1);
        inicioMes.setHours(0, 0, 0, 0);
        const emailsMes = invitaciones.filter(i => {
          const fecha = i.fechaEnvio?.toDate?.() || i.createdAt?.toDate?.();
          return fecha && fecha >= inicioMes;
        }).length;
        
        // Almacenamiento estimado (simplificado: contar fotos * 500KB aprox)
        const almacenamientoMB = Math.round((r.totalFotos || 0) * 0.5 + (r.totalDocumentos || 0) * 0.2);
        
        // MRR (Monthly Recurring Revenue)
        const plan = (r.plan || 'gratuito').toLowerCase();
        const descuentoPlan = (r.descuentoPlan || 0) / 100;
        const descuentoAddon = (r.descuentoAddon || 0) / 100;
        let mrr = 0;
        if (plan === 'plus') mrr = (preciosPlanes.plus?.precioMensual || 5.99) * (1 - descuentoPlan);
        else if (plan === 'premium' || plan === 'mega') mrr = (preciosPlanes.premium?.precioMensual || 9.99) * (1 - descuentoPlan);
        
        bienes.forEach(b => {
          if (b.mayordomoActivo) mrr += (preciosAddons.mayordomo?.precio || 4.99) * (1 - descuentoAddon);
          if (b.gerenteActivo) mrr += (preciosAddons.gerente?.precio || 9.99) * (1 - descuentoAddon);
          if (b.capatazActivo) mrr += (preciosAddons.capataz?.precio || 9.99) * (1 - descuentoAddon);
        });
        
        // SemÃ¡foro de actividad
        const ahora = new Date();
        const ultimaActividad = r.ultimaActividad?.toDate?.() || r.fechaCreacion?.toDate?.() || new Date(0);
        const diasInactivo = Math.floor((ahora - ultimaActividad) / (1000 * 60 * 60 * 24));
        let semaforo = 'ğŸŸ¢'; // Activa
        if (diasInactivo > 90) semaforo = 'ğŸ”´'; // Inactiva
        else if (diasInactivo > 30) semaforo = 'ğŸŸ¡'; // Dormida
        
        // Admin nombre
        const admin = usuarios.find(u => u.rol === 'admin-rama' || u.rol === 'AdminRama' || u.credencial === 'admin-rama');
        const adminNombre = admin?.nombre || admin?.email?.split('@')[0] || r.adminNombre || '-';
        
        return `<tr>
          <td><strong>${r.nombre || '-'}</strong></td>
          <td>${adminNombre}</td>
          <td><span title="Usuarios activos / Nidos">${usuariosActivos.length}ğŸ‘¤ ${nidos.length}ğŸªº</span></td>
          <td><span title="Bienes / Add-ons activos">${bienes.length}ğŸ  ${addonsActivos}âš¡</span></td>
          <td><span title="Emails mes / Almacenamiento">ğŸ“§${emailsMes} ğŸ’¾${almacenamientoMB}MB</span></td>
          <td><span class="badge badge-${plan === 'mega' || plan === 'premium' ? 'warning' : plan === 'plus' ? 'info' : 'neutral'}">${r.plan || 'Free'}</span>${r.descuentoPlan ? ` <span class="badge badge-success">-${r.descuentoPlan}%</span>` : ''}</td>
          <td><strong>${mrr.toFixed(2)}â‚¬</strong></td>
          <td title="${diasInactivo} dÃ­as sin actividad">${semaforo}</td>
          <td><button class="btn btn-sm btn-secondary" onclick="verRama('${r.id}')">ğŸ‘ï¸</button></td>
        </tr>`;
      }).join('');
      
      document.getElementById('tabla-ramas').innerHTML = filas || '<tr><td colspan="9" class="text-center">Sin datos</td></tr>';
    }
    async function cargarEstirpes(){const s=await db.collection('nidos').get();nidosData=s.docs.map(x=>({id:x.id,...x.data()}));const estirpes=calcularEstirpes(nidosData);document.getElementById('tabla-estirpes').innerHTML=estirpes.map(e=>{const nidosHijos=nidosData.filter(n=>n.nidoOrigen===e.id).length;return`<tr><td><strong>${e.nombre||'-'}</strong></td><td>${e.ramaNombre||'-'}</td><td>${nidosHijos}</td><td>${e.generacion||'-'}</td><td>${e.miembros?.length||e.miembrosData?.length||0}</td><td><button class="btn btn-sm btn-secondary">ğŸ‘ï¸</button></td></tr>`}).join('')||'<tr><td colspan="6" class="text-center">Sin estirpes</td></tr>'}
    async function cargarNidos(){const s=await db.collection('nidos').get();nidosData=s.docs.map(d=>({id:d.id,...d.data()}));document.getElementById('tabla-nidos').innerHTML=nidosData.map(n=>`<tr><td><strong>${n.nombre||'-'}</strong></td><td>${n.ramaNombre||'-'}</td><td>${n.miembros?.length||0}</td><td>${n.adminNombre||'-'}</td><td>${n.generacion||1}</td><td><button class="btn btn-sm btn-secondary">ğŸ‘ï¸</button></td></tr>`).join('')||'<tr><td colspan="6" class="text-center">Sin datos</td></tr>'}
    async function cargarUsuarios(){
      const s=await db.collection('usuarios').get();
      usuariosData=s.docs.map(d=>({id:d.id,...d.data()}));
      
      // Cargar nidos para obtener cÃ³digos y nÃºmeros de miembro
      const nidosSnap = await db.collection('nidos').get();
      const nidosMap = {};
      nidosSnap.docs.forEach(n => {
        const data = n.data();
        nidosMap[n.id] = {
          codigoNido: data.codigoNido || '-',
          miembrosData: data.miembrosData || []
        };
      });
      
      document.getElementById('tabla-usuarios').innerHTML=usuariosData.map(u=>{
        // Buscar numeroMiembro en el nido del usuario
        let numMiembro = '-';
        let codNido = '-';
        if (u.nidoId && nidosMap[u.nidoId]) {
          codNido = nidosMap[u.nidoId].codigoNido;
          const miembro = nidosMap[u.nidoId].miembrosData.find(m => m.uid === u.id || m.email === u.email);
          if (miembro && miembro.numeroMiembro) numMiembro = '#' + miembro.numeroMiembro;
        }
        return `<tr><td><strong>${numMiembro}</strong></td><td><strong>${u.nombre||u.email||'-'}</strong></td><td>${u.ramaNombre||'-'}</td><td>${u.nidoNombre||'-'}</td><td><code>${codNido}</code></td><td><span class="badge badge-neutral">${u.rol||'Miembro'}</span></td><td><span class="badge ${u.primerAcceso?'badge-warning':'badge-success'}">${u.primerAcceso?'Invitado':'Activo'}</span></td><td><button class="btn btn-sm btn-secondary">ğŸ‘ï¸</button></td></tr>`;
      }).join('')||'<tr><td colspan="8" class="text-center">Sin datos</td></tr>';
    }
    async function cargarInvitaciones(){const s=await db.collection('invitaciones-email').orderBy('fechaEnvio','desc').limit(100).get();const d=s.docs.map(x=>({id:x.id,...x.data()}));document.getElementById('tabla-invitaciones').innerHTML=d.map(i=>`<tr><td>${i.email||'-'}</td><td>${i.ramaNombre||'-'}</td><td>${i.nidoNombre||'-'}</td><td>${i.fechaEnvio?.toDate?.().toLocaleDateString('es')||'-'}</td><td><span class="badge ${i.estado==='aceptada'?'badge-success':i.estado==='expirada'?'badge-error':'badge-warning'}">${i.estado||'pendiente'}</span></td><td><button class="btn btn-sm btn-secondary">ğŸ”„</button></td></tr>`).join('')||'<tr><td colspan="6" class="text-center">Sin datos</td></tr>'}
    async function cargarPlanesConfig(){
      try{
        // Cargar planes
        const planesDoc=await db.collection('config').doc('planes').get();
        if(planesDoc.exists){
          const data=planesDoc.data();
          if(data.gratuito){
            document.getElementById('plan-gratuito-desc').value=data.gratuito.descripcion||'';
            document.getElementById('plan-gratuito-mes').value=data.gratuito.precioMensual||0;
            document.getElementById('plan-gratuito-aÃ±o').value=data.gratuito.precioAnual||0;
            document.getElementById('plan-gratuito-fotos').value=data.gratuito.maxFotos||150;
            document.getElementById('plan-gratuito-gen').value=data.gratuito.maxGeneraciones||3;
            document.getElementById('plan-gratuito-bienes').value=data.gratuito.maxBienes||3;
            document.getElementById('plan-gratuito-features').value=(data.gratuito.features||[]).join('\n');
          }
          if(data.plus){
            document.getElementById('plan-plus-desc').value=data.plus.descripcion||'';
            document.getElementById('plan-plus-mes').value=data.plus.precioMensual||5.99;
            document.getElementById('plan-plus-aÃ±o').value=data.plus.precioAnual||49;
            document.getElementById('plan-plus-fotos').value=data.plus.maxFotos||500;
            document.getElementById('plan-plus-gen').value=data.plus.maxGeneraciones||4;
            document.getElementById('plan-plus-bienes').value=data.plus.maxBienes||10;
            document.getElementById('plan-plus-features').value=(data.plus.features||[]).join('\n');
          }
          if(data.premium){
            document.getElementById('plan-premium-desc').value=data.premium.descripcion||'';
            document.getElementById('plan-premium-mes').value=data.premium.precioMensual||9.99;
            document.getElementById('plan-premium-aÃ±o').value=data.premium.precioAnual||99;
            document.getElementById('plan-premium-fotos').value=data.premium.maxFotos||9999;
            document.getElementById('plan-premium-gen').value=data.premium.maxGeneraciones||99;
            document.getElementById('plan-premium-bienes').value=data.premium.maxBienes||999;
            document.getElementById('plan-premium-features').value=(data.premium.features||[]).join('\n');
          }
        }
        // Cargar recargas
        const recargasDoc=await db.collection('config').doc('recargas').get();
        if(recargasDoc.exists){
          const r=recargasDoc.data();
          if(r.fotos){document.getElementById('recarga-fotos-precio').value=r.fotos.precio||1.99;document.getElementById('recarga-fotos-cantidad').value=r.fotos.cantidad||50;document.getElementById('recarga-fotos-activo').checked=r.fotos.activo!==false;}
          if(r.bienes){document.getElementById('recarga-bienes-precio').value=r.bienes.precio||2.99;document.getElementById('recarga-bienes-cantidad').value=r.bienes.cantidad||5;document.getElementById('recarga-bienes-activo').checked=r.bienes.activo!==false;}
          if(r.herramientas){document.getElementById('recarga-herramientas-precio').value=r.herramientas.precio||0.99;document.getElementById('recarga-herramientas-cantidad').value=r.herramientas.cantidad||1;document.getElementById('recarga-herramientas-activo').checked=r.herramientas.activo!==false;}
          if(r.storage){document.getElementById('recarga-storage-precio').value=r.storage.precio||4.99;document.getElementById('recarga-storage-cantidad').value=r.storage.cantidad||1;document.getElementById('recarga-storage-activo').checked=r.storage.activo===true;}
        }
        // Cargar descuentos
        const descuentosDoc=await db.collection('config').doc('descuentos').get();
        if(descuentosDoc.exists){
          const d=descuentosDoc.data();
          if(d.promo){document.getElementById('descuento-promo').value=d.promo.porcentaje||20;document.getElementById('descuento-promo-desc').value=d.promo.descripcion||'';}
          if(d.ff){document.getElementById('descuento-ff').value=d.ff.porcentaje||50;document.getElementById('descuento-ff-desc').value=d.ff.descripcion||'';}
          if(d.gratis){document.getElementById('descuento-gratis-desc').value=d.gratis.descripcion||'';}
        }
      }catch(e){console.error('Error cargando config planes:',e);}
    }
    async function guardarPlanesConfig(){
      try{
        const planes={
          gratuito:{
            id:'gratuito',nombre:'Gratuito',icon:'G',
            descripcion:document.getElementById('plan-gratuito-desc').value,
            precioMensual:parseFloat(document.getElementById('plan-gratuito-mes').value)||0,
            precioAnual:parseFloat(document.getElementById('plan-gratuito-aÃ±o').value)||0,
            maxFotos:parseInt(document.getElementById('plan-gratuito-fotos').value)||100,
            maxGeneraciones:parseInt(document.getElementById('plan-gratuito-gen').value)||3,
            maxBienes:parseInt(document.getElementById('plan-gratuito-bienes').value)||2,
            features:document.getElementById('plan-gratuito-features').value.split('\n').filter(f=>f.trim()),
            activo:true,destacado:false,orden:1,cta:'Empezar gratis',trial:false
          },
          plus:{
            id:'plus',nombre:'Plus',icon:'+',
            descripcion:document.getElementById('plan-plus-desc').value,
            precioMensual:parseFloat(document.getElementById('plan-plus-mes').value)||5.99,
            precioAnual:parseFloat(document.getElementById('plan-plus-aÃ±o').value)||49,
            maxFotos:parseInt(document.getElementById('plan-plus-fotos').value)||500,
            maxGeneraciones:parseInt(document.getElementById('plan-plus-gen').value)||4,
            maxBienes:parseInt(document.getElementById('plan-plus-bienes').value)||10,
            features:document.getElementById('plan-plus-features').value.split('\n').filter(f=>f.trim()),
            activo:true,destacado:true,orden:2,cta:'Probar 14 dÃ­as gratis',trial:true
          },
          premium:{
            id:'premium',nombre:'Premium',icon:'P',
            descripcion:document.getElementById('plan-premium-desc').value,
            precioMensual:parseFloat(document.getElementById('plan-premium-mes').value)||9.99,
            precioAnual:parseFloat(document.getElementById('plan-premium-aÃ±o').value)||99,
            maxFotos:parseInt(document.getElementById('plan-premium-fotos').value)||9999,
            maxGeneraciones:parseInt(document.getElementById('plan-premium-gen').value)||99,
            maxBienes:parseInt(document.getElementById('plan-premium-bienes').value)||999,
            features:document.getElementById('plan-premium-features').value.split('\n').filter(f=>f.trim()),
            activo:true,destacado:false,orden:3,cta:'Probar 14 dÃ­as gratis',trial:true
          },
          ultimaModificacion:firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('config').doc('planes').set(planes);
        // Recargas
        const recargas={
          fotos:{id:'fotos',nombre:'+Fotos',icon:'ğŸ“¸',precio:parseFloat(document.getElementById('recarga-fotos-precio').value)||1.99,cantidad:parseInt(document.getElementById('recarga-fotos-cantidad').value)||50,activo:document.getElementById('recarga-fotos-activo').checked},
          bienes:{id:'bienes',nombre:'+Bienes',icon:'ğŸ ',precio:parseFloat(document.getElementById('recarga-bienes-precio').value)||2.99,cantidad:parseInt(document.getElementById('recarga-bienes-cantidad').value)||5,activo:document.getElementById('recarga-bienes-activo').checked},
          herramientas:{id:'herramientas',nombre:'+Herramientas',icon:'ğŸ”§',precio:parseFloat(document.getElementById('recarga-herramientas-precio').value)||0.99,cantidad:parseInt(document.getElementById('recarga-herramientas-cantidad').value)||1,activo:document.getElementById('recarga-herramientas-activo').checked},
          storage:{id:'storage',nombre:'+Almacenamiento',icon:'ğŸ“¦',precio:parseFloat(document.getElementById('recarga-storage-precio').value)||4.99,cantidad:parseInt(document.getElementById('recarga-storage-cantidad').value)||1,unidad:'GB',activo:document.getElementById('recarga-storage-activo').checked},
          ultimaModificacion:firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('config').doc('recargas').set(recargas);
        // Descuentos
        const descuentos={
          promo:{id:'promo',codigo:'PROMO',porcentaje:parseInt(document.getElementById('descuento-promo').value)||20,descripcion:document.getElementById('descuento-promo-desc').value,visible:false},
          ff:{id:'ff',codigo:'F&F',porcentaje:parseInt(document.getElementById('descuento-ff').value)||50,descripcion:document.getElementById('descuento-ff-desc').value,visible:false},
          gratis:{id:'gratis',codigo:'GRATIS',porcentaje:100,descripcion:document.getElementById('descuento-gratis-desc').value,visible:false},
          ultimaModificacion:firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('config').doc('descuentos').set(descuentos);
        alert('âœ… Planes, Recargas y Descuentos guardados');
      }catch(e){alert('Error guardando: '+e.message);}
    }

    // ============================
    // ADD-ONS: CatÃ¡logo del sistema
    // ============================

    // CatÃ¡logo maestro de MÃ“DULOS por add-on (fuente de verdad)
    const CATALOGO_SISTEMA_MODULOS = {
      mayordomo: {
        reservas:       { icon: 'ğŸ“…', nombre: 'Reservas' },
        inventario:     { icon: 'ğŸ“¦', nombre: 'Inventario' },
        ajuar:          { icon: 'ğŸª‘', nombre: 'Ajuar' },
        menus:          { icon: 'ğŸ½ï¸', nombre: 'MenÃºs' },
        gastos:         { icon: 'ğŸ’°', nombre: 'Gastos' },
        mantenimiento:  { icon: 'ğŸ”§', nombre: 'Mantenimiento' },
        limpieza:       { icon: 'ğŸ§¹', nombre: 'Limpieza' },
        eventos:        { icon: 'ğŸ‰', nombre: 'Eventos' },
        planLimpieza:   { icon: 'ğŸ“‹', nombre: 'Plan Limpieza' },
        prepararSemana: { icon: 'ğŸ“', nombre: 'Preparar Semana' },
        especiales:     { icon: 'â­', nombre: 'Especiales' },
        informes:       { icon: 'ğŸ“„', nombre: 'Informes' }
      },
      gerente: {
        reservas:       { icon: 'ğŸ“…', nombre: 'Reservas' },
        zonas:          { icon: 'ğŸ ', nombre: 'Zonas' },
        huespedes:      { icon: 'ğŸ‘¥', nombre: 'HuÃ©spedes' },
        tarifas:        { icon: 'ğŸ’¶', nombre: 'Tarifas' },
        ventas:         { icon: 'ğŸ’°', nombre: 'Ventas' },
        inventario:     { icon: 'ğŸ“¦', nombre: 'Inventario' },
        ajuar:          { icon: 'ğŸª‘', nombre: 'Ajuar' },
        acuerdos:       { icon: 'ğŸ¤', nombre: 'Acuerdos' },
        entidad:        { icon: 'ğŸ›ï¸', nombre: 'VehÃ­culo' },
        servicios:      { icon: 'ğŸš', nombre: 'Otros Servicios' },
        menus:          { icon: 'ğŸ½ï¸', nombre: 'MenÃºs' },
        mantenimiento:  { icon: 'ğŸ”§', nombre: 'Mantenimiento' },
        limpieza:       { icon: 'ğŸ§¹', nombre: 'Limpieza' },
        gastos:         { icon: 'ğŸ’¸', nombre: 'Gastos' },
        informes:       { icon: 'ğŸ“„', nombre: 'Informes' }
      },
      capataz: {
        parcelas:       { icon: 'ğŸŒ¾', nombre: 'Parcelas' },
        cultivos:       { icon: 'ğŸŒ±', nombre: 'Cultivos' },
        maquinaria:     { icon: 'ğŸšœ', nombre: 'Maquinaria' },
        personal:       { icon: 'ğŸ‘·', nombre: 'Personal' },
        riego:          { icon: 'ğŸ’§', nombre: 'Riego' },
        almacen:        { icon: 'ğŸšï¸', nombre: 'AlmacÃ©n' },
        ganado:         { icon: 'ğŸ„', nombre: 'Ganado' },
        mantenimiento:  { icon: 'ğŸ”§', nombre: 'Mantenimiento' },
        gastos:         { icon: 'ğŸ’¸', nombre: 'Gastos' },
        entidad:        { icon: 'ğŸ›ï¸', nombre: 'VehÃ­culo' },
        informes:       { icon: 'ğŸ“„', nombre: 'Informes' }
      }
    };

    // CatÃ¡logo maestro de PARÃMETROS por add-on
    const CATALOGO_SISTEMA_PARAMS = {
      mayordomo: {
        mascota:      { icon: 'ğŸ¾', nombre: 'Mascota' },
        reglas:       { icon: 'ğŸ“', nombre: 'Reglas de la casa' },
        externos:     { icon: 'ğŸ‘·', nombre: 'Externos (caseros)' },
        documentos:   { icon: 'ğŸ“‘', nombre: 'Documentos' },
        contactos:    { icon: 'ğŸ“‡', nombre: 'Contactos Ãºtiles' },
        seguros:      { icon: 'ğŸ›¡ï¸', nombre: 'Seguros' },
        suministros:  { icon: 'ğŸ’¡', nombre: 'Suministros' }
      },
      gerente: {
        mascota:      { icon: 'ğŸ¾', nombre: 'Mascota' },
        reglas:       { icon: 'ğŸ“', nombre: 'Reglas del alojamiento' },
        externos:     { icon: 'ğŸ‘·', nombre: 'Externos (hoster)' },
        documentos:   { icon: 'ğŸ“‘', nombre: 'Documentos' },
        checkInOut:   { icon: 'ğŸ”‘', nombre: 'Check-in / Check-out' },
        seguros:      { icon: 'ğŸ›¡ï¸', nombre: 'Seguros' },
        suministros:  { icon: 'ğŸ’¡', nombre: 'Suministros' },
        plataformas:  { icon: 'ğŸŒ', nombre: 'Plataformas (Airbnb...)' }
      },
      capataz: {
        externos:     { icon: 'ğŸ‘·', nombre: 'Externos (guardas)' },
        documentos:   { icon: 'ğŸ“‘', nombre: 'Documentos' },
        meteorologia: { icon: 'ğŸŒ¦ï¸', nombre: 'MeteorologÃ­a' },
        seguros:      { icon: 'ğŸ›¡ï¸', nombre: 'Seguros' },
        suministros:  { icon: 'ğŸ’¡', nombre: 'Suministros' },
        permisos:     { icon: 'ğŸ“‹', nombre: 'Permisos y licencias' }
      }
    };

    let addonsConfigData = {}; // Datos cargados de Firebase

    function cambiarSubtabAddon(subtab) {
      document.querySelectorAll('.addon-subtab').forEach(t => t.classList.toggle('active', t.dataset.subtab === subtab));
      document.querySelectorAll('.addon-subpanel').forEach(p => p.classList.remove('active'));
      document.getElementById(`subpanel-${subtab}`).classList.add('active');
    }

    function renderSysModulosChips(containerId, catalogo, savedConfig) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = Object.entries(catalogo).map(([key, mod]) => {
        const activo = savedConfig[key] !== false; // activo por defecto
        return `
          <label class="modulo-chip ${activo ? 'active' : ''}">
            <input type="checkbox" data-key="${key}" ${activo ? 'checked' : ''} onchange="this.parentElement.classList.toggle('active', this.checked)">
            <span class="modulo-chip-icon">${mod.icon}</span>
            <span class="modulo-chip-name">${mod.nombre}</span>
          </label>`;
      }).join('');
    }

    async function cargarAddonsConfig() {
      try {
        const doc = await db.collection('config').doc('addons').get();
        if (doc.exists) {
          addonsConfigData = doc.data();
          // Precios
          if (addonsConfigData.crearRama) { document.getElementById('addon-crearrama-precio').value = addonsConfigData.crearRama.precio || 9.99; document.getElementById('addon-crearrama-activo').checked = addonsConfigData.crearRama.activo !== false; }
          if (addonsConfigData.mayordomo) { document.getElementById('addon-mayordomo-precio').value = addonsConfigData.mayordomo.precio || 4.99; document.getElementById('addon-mayordomo-activo').checked = addonsConfigData.mayordomo.activo !== false; }
          if (addonsConfigData.gerente) { document.getElementById('addon-gerente-precio').value = addonsConfigData.gerente.precio || 9.99; document.getElementById('addon-gerente-activo').checked = addonsConfigData.gerente.activo !== false; }
          if (addonsConfigData.capataz) { document.getElementById('addon-capataz-precio').value = addonsConfigData.capataz.precio || 9.99; document.getElementById('addon-capataz-activo').checked = addonsConfigData.capataz.activo !== false; }
        }
        // Renderizar mÃ³dulos con config guardada
        ['mayordomo', 'gerente', 'capataz'].forEach(tipo => {
          const savedMods = addonsConfigData[tipo]?.modulosDisponibles || {};
          const savedParams = addonsConfigData[tipo]?.parametrosDisponibles || {};
          renderSysModulosChips(`sys-modulos-${tipo}`, CATALOGO_SISTEMA_MODULOS[tipo], savedMods);
          renderSysModulosChips(`sys-params-${tipo}`, CATALOGO_SISTEMA_PARAMS[tipo], savedParams);
        });
      } catch (e) { console.error('Error cargando addons config:', e); }
    }

    function recogerChips(containerId) {
      const result = {};
      document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(cb => {
        result[cb.dataset.key] = cb.checked;
      });
      return result;
    }

    async function guardarAddonsConfig() {
      try {
        const addons = {
          crearRama: { id: 'crearRama', nombre: 'Crear Rama', icon: 'ğŸŒ³', descripcion: 'Bifurcar nueva cuenta familiar', precio: parseFloat(document.getElementById('addon-crearrama-precio').value) || 9.99, activo: document.getElementById('addon-crearrama-activo').checked },
          mayordomo: {
            id: 'mayordomo', nombre: 'Mayordomo', icon: 'ğŸ©', descripcion: 'GestiÃ³n domÃ©stica de 2Âª residencia',
            precio: parseFloat(document.getElementById('addon-mayordomo-precio').value) || 4.99,
            activo: document.getElementById('addon-mayordomo-activo').checked,
            modulosDisponibles: recogerChips('sys-modulos-mayordomo'),
            parametrosDisponibles: recogerChips('sys-params-mayordomo')
          },
          gerente: {
            id: 'gerente', nombre: 'Gerente', icon: 'ğŸ¨', descripcion: 'Alquiler turÃ­stico profesional',
            precio: parseFloat(document.getElementById('addon-gerente-precio').value) || 9.99,
            activo: document.getElementById('addon-gerente-activo').checked,
            modulosDisponibles: recogerChips('sys-modulos-gerente'),
            parametrosDisponibles: recogerChips('sys-params-gerente')
          },
          capataz: {
            id: 'capataz', nombre: 'Capataz', icon: 'ğŸŒ¾', descripcion: 'GestiÃ³n de fincas rurales',
            precio: parseFloat(document.getElementById('addon-capataz-precio').value) || 9.99,
            activo: document.getElementById('addon-capataz-activo').checked,
            modulosDisponibles: recogerChips('sys-modulos-capataz'),
            parametrosDisponibles: recogerChips('sys-params-capataz')
          },
          ultimaModificacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('config').doc('addons').set(addons);
        addonsConfigData = addons;
        alert('âœ… Add-ons guardados: precios, mÃ³dulos y parÃ¡metros');
      } catch (e) { alert('Error guardando Add-ons: ' + e.message); }
    }
    async function cargarLegal(){try{const tc=await db.collection('config').doc('terminos').get();if(tc.exists){document.getElementById('tc-contenido').value=tc.data().contenido||'';document.getElementById('tc-fecha').textContent=tc.data().fechaActualizacion?.toDate?.().toLocaleDateString('es')||'-'}const pp=await db.collection('config').doc('privacidad').get();if(pp.exists){document.getElementById('pp-contenido').value=pp.data().contenido||'';document.getElementById('pp-fecha').textContent=pp.data().fechaActualizacion?.toDate?.().toLocaleDateString('es')||'-'}}catch(e){console.error(e)}}
    async function guardarTerminos(){const c=document.getElementById('tc-contenido').value;if(!c.trim())return alert('Contenido requerido');try{await db.collection('config').doc('terminos').set({contenido:c,fechaActualizacion:firebase.firestore.FieldValue.serverTimestamp()});document.getElementById('tc-fecha').textContent=new Date().toLocaleDateString('es');alert('âœ… Guardado')}catch(e){alert('Error: '+e.message)}}
    async function guardarPrivacidad(){const c=document.getElementById('pp-contenido').value;if(!c.trim())return alert('Contenido requerido');try{await db.collection('config').doc('privacidad').set({contenido:c,fechaActualizacion:firebase.firestore.FieldValue.serverTimestamp()});document.getElementById('pp-fecha').textContent=new Date().toLocaleDateString('es');alert('âœ… Guardado')}catch(e){alert('Error: '+e.message)}}
    async function exportarBackup(t){try{let d={};if(t==='ramas'||t==='todo')d.ramas=ramasData;if(t==='usuarios'||t==='todo')d.usuarios=usuariosData;if(t==='nidos'||t==='todo')d.nidos=nidosData;descargar(JSON.stringify(d,null,2),`familynk_${t}_${new Date().toISOString().split('T')[0]}.json`,'application/json')}catch(e){alert('Error: '+e.message)}}
    function descargar(c,n,t){const b=new Blob([c],{type:t});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click()}
    function verRama(id){
      const r=ramasData.find(x=>x.id===id);
      if(!r)return;
      document.getElementById('rama-id').value=id;
      document.getElementById('rama-nombre').textContent=r.nombre||'-';
      document.getElementById('rama-admin').textContent=r.adminNombre||r.adminEmail||'-';
      document.getElementById('rama-nidos').textContent=r.totalNidos||0;
      document.getElementById('rama-miembros').textContent=r.totalMiembros||0;
      document.getElementById('rama-fecha').textContent=r.fechaCreacion?.toDate?.().toLocaleDateString('es')||'-';
      document.getElementById('rama-plan-actual').innerHTML=`<span class="badge badge-${r.plan==='mega'||r.plan==='premium'?'warning':r.plan==='plus'?'info':'neutral'}">${r.plan||'Free'}</span>`;
      document.getElementById('rama-notas').value=r.notasAdmin||'';
      // Plan
      const planActual=r.plan||'gratuito';
      document.querySelectorAll('input[name="rama-plan"]').forEach(i=>i.checked=(i.value===planActual));
      // Descuentos
      document.querySelectorAll('input[name="descuento-plan"]').forEach(i=>i.checked=(parseInt(i.value)===(r.descuentoPlan||0)));
      document.querySelectorAll('input[name="descuento-addon"]').forEach(i=>i.checked=(parseInt(i.value)===(r.descuentoAddon||0)));
      // Add-ons (desde bienes de esta familia)
      const bienesFamilia = bienesData.filter(b => b.familiaId === id);
      const addonsList = [];
      const addonsCount = { mayordomo: 0, gerente: 0, capataz: 0 };
      
      bienesFamilia.forEach(b => {
        if (b.mayordomoActivo) addonsCount.mayordomo++;
        if (b.gerenteActivo) addonsCount.gerente++;
        if (b.capatazActivo) addonsCount.capataz++;
      });
      
      if (addonsCount.mayordomo > 0) addonsList.push(`<span class="badge badge-info">ğŸ¡ Mayordomo (${addonsCount.mayordomo})</span>`);
      if (addonsCount.gerente > 0) addonsList.push(`<span class="badge badge-info">ğŸ¨ Gerente (${addonsCount.gerente})</span>`);
      if (addonsCount.capataz > 0) addonsList.push(`<span class="badge badge-info">ğŸŒ¾ Capataz (${addonsCount.capataz})</span>`);
      
      document.getElementById('rama-addons').innerHTML = addonsList.length 
        ? addonsList.join(' ') + `<span class="text-muted" style="margin-left:8px;font-size:0.75rem;">(${bienesFamilia.length} bienes)</span>`
        : '<span class="text-muted">Ninguno</span>';
      document.getElementById('modal-rama').classList.add('active');
    }
    async function guardarRama(){
      const id=document.getElementById('rama-id').value;
      if(!id)return;
      const plan=document.querySelector('input[name="rama-plan"]:checked')?.value||'gratuito';
      const descuentoPlan=parseInt(document.querySelector('input[name="descuento-plan"]:checked').value)||0;
      const descuentoAddon=parseInt(document.querySelector('input[name="descuento-addon"]:checked').value)||0;
      const notasAdmin=document.getElementById('rama-notas').value.trim();
      try{
        await db.collection('familias').doc(id).update({
          plan:plan,
          descuentoPlan:descuentoPlan,
          descuentoAddon:descuentoAddon,
          notasAdmin:notasAdmin,
          ultimaModificacionAdmin:firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('âœ… Rama actualizada');
        cerrarModales();
        cargarRamas();
      }catch(e){alert('Error: '+e.message);}
    }
    function cerrarModales(){document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active'))}
    document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)cerrarModales()})});

    // ============================================
    // CONFIGURACIÃ“N ESTRUCTURA
    // ============================================
    
    async function guardarConfigEstructura() {
      try {
        const config = {
          invitaciones: {
            expiracionDias: parseInt(document.getElementById('config-invitacion-expiracion').value) || 7,
            reenviosMax: parseInt(document.getElementById('config-invitacion-reenvios').value) || 3
          },
          trials: {
            diasPrueba: parseInt(document.getElementById('config-trial-dias').value) || 14
          },
          ultimaModificacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('configuracion').doc('sistema').set(config, { merge: true });
        alert('âœ… ConfiguraciÃ³n guardada');
      } catch (error) {
        console.error('Error guardando config:', error);
        alert('âŒ Error al guardar: ' + error.message);
      }
    }
    
    async function cargarConfigEstructura() {
      try {
        const doc = await db.collection('configuracion').doc('sistema').get();
        if (doc.exists) {
          const data = doc.data();
          if (data.invitaciones) {
            document.getElementById('config-invitacion-expiracion').value = data.invitaciones.expiracionDias || 7;
            document.getElementById('config-invitacion-reenvios').value = data.invitaciones.reenviosMax || 3;
          }
          if (data.trials) {
            document.getElementById('config-trial-dias').value = data.trials.diasPrueba || 14;
          }
        }
      } catch (e) {
        console.error('Error cargando config estructura:', e);
      }
    }

    // ============================================
    // SISTEMA DE NUMERACIÃ“N
    // ============================================

    // Cargar familias para el selector de numeraciÃ³n
    async function cargarFamiliasNumeracion() {
      try {
        const snap = await db.collection('familias').get();
        const select = document.getElementById('numeracion-familia');
        if (!select) return;
        
        select.innerHTML = '<option value="">Selecciona una familia...</option>' +
          snap.docs.map(doc => {
            const data = doc.data();
            return `<option value="${doc.id}">${data.nombre || doc.id}</option>`;
          }).join('');
      } catch (e) {
        console.error('Error cargando familias:', e);
      }
    }

    // Ejecutar numeraciÃ³n
    async function ejecutarNumeracion() {
      const familiaId = document.getElementById('numeracion-familia').value;
      const resultadoDiv = document.getElementById('numeracion-resultado');
      
      if (!familiaId) {
        alert('Selecciona una familia');
        return;
      }
      
      resultadoDiv.style.display = 'block';
      resultadoDiv.innerHTML = '<span style="color:var(--info);">â³ Procesando...</span>';
      
      try {
        const resultado = await ejecutarNumeracionCompleta(db, familiaId);
        
        const nidosCount = Object.keys(resultado.codigosNidos).length;
        const miembrosCount = Object.keys(resultado.numerosMiembros).length;
        
        let html = `<div style="color:var(--success);">âœ… NumeraciÃ³n completada</div>`;
        html += `<div style="margin-top:8px;">ğŸ“ <strong>${nidosCount}</strong> nidos numerados</div>`;
        html += `<div>ğŸ‘¤ <strong>${miembrosCount}</strong> miembros numerados</div>`;
        
        if (resultado.errores.length > 0) {
          html += `<div style="color:var(--error);margin-top:8px;">âš ï¸ Errores: ${resultado.errores.map(e => e.error).join(', ')}</div>`;
        }
        
        // Mostrar detalle de cÃ³digos
        html += `<details style="margin-top:12px;"><summary style="cursor:pointer;font-weight:600;">Ver cÃ³digos de nidos</summary><div style="margin-top:8px;max-height:150px;overflow-y:auto;font-family:monospace;font-size:0.75rem;">`;
        Object.entries(resultado.codigosNidos).forEach(([id, codigo]) => {
          html += `<div>${codigo} â†’ ${id.substring(0,8)}...</div>`;
        });
        html += `</div></details>`;
        
        resultadoDiv.innerHTML = html;
        
      } catch (error) {
        resultadoDiv.innerHTML = `<span style="color:var(--error);">âŒ Error: ${error.message}</span>`;
      }
    }

    // ============================================
    // FUNCIONES DE NUMERACIÃ“N (Sistema)
    // ============================================

    function calcularCodigosNidos(nidos) {
      const codigosNidos = {};
      
      const nidoRaiz = nidos.find(n => !n.nidoOrigen);
      if (!nidoRaiz) return codigosNidos;
      
      codigosNidos[nidoRaiz.id] = '1';
      
      const hijosPorPadre = {};
      nidos.forEach(n => {
        if (n.nidoOrigen) {
          if (!hijosPorPadre[n.nidoOrigen]) hijosPorPadre[n.nidoOrigen] = [];
          hijosPorPadre[n.nidoOrigen].push(n);
        }
      });
      
      function asignarCodigosHijos(nidoPadreId, codigoPadre) {
        const hijos = hijosPorPadre[nidoPadreId] || [];
        
        hijos.sort((a, b) => {
          const edadA = obtenerEdadFundador(a);
          const edadB = obtenerEdadFundador(b);
          return edadA - edadB;
        });
        
        hijos.forEach((hijo, index) => {
          const codigoHijo = `${codigoPadre}.${index + 1}`;
          codigosNidos[hijo.id] = codigoHijo;
          asignarCodigosHijos(hijo.id, codigoHijo);
        });
      }
      
      asignarCodigosHijos(nidoRaiz.id, '1');
      return codigosNidos;
    }

    function obtenerEdadFundador(nido) {
      const miembros = nido.miembrosData || [];
      const padres = miembros.filter(m => 
        m.rol === 'padre' || m.rol === 'madre' || 
        m.rol === 'Padre' || m.rol === 'Madre' ||
        m.parentesco === 'padre' || m.parentesco === 'madre'
      );
      
      const lista = padres.length > 0 ? padres : miembros;
      if (lista.length === 0) return new Date();
      
      lista.sort((a, b) => {
        const fechaA = a.fechaNacimiento ? new Date(a.fechaNacimiento) : new Date();
        const fechaB = b.fechaNacimiento ? new Date(b.fechaNacimiento) : new Date();
        return fechaA - fechaB;
      });
      
      return lista[0].fechaNacimiento ? new Date(lista[0].fechaNacimiento) : new Date();
    }

    function calcularNumerosMiembros(nidos) {
      const numerosMiembros = {};
      const todosMiembros = [];
      
      nidos.forEach(nido => {
        (nido.miembrosData || []).forEach(m => {
          const idUnico = m.uid || m.email || m.id || `${nido.id}-${m.nombre}`;
          if (!todosMiembros.find(tm => tm.idUnico === idUnico)) {
            todosMiembros.push({
              ...m,
              idUnico,
              nidoId: nido.id,
              fechaNacimientoDate: m.fechaNacimiento ? new Date(m.fechaNacimiento) : null
            });
          }
        });
      });
      
      todosMiembros.sort((a, b) => {
        if (!a.fechaNacimientoDate && !b.fechaNacimientoDate) return 0;
        if (!a.fechaNacimientoDate) return 1;
        if (!b.fechaNacimientoDate) return -1;
        return a.fechaNacimientoDate - b.fechaNacimientoDate;
      });
      
      todosMiembros.forEach((miembro, index) => {
        numerosMiembros[miembro.idUnico] = index + 1;
      });
      
      return numerosMiembros;
    }

    async function ejecutarNumeracionCompleta(db, familiaId) {
      console.log('ğŸ”¢ NumeraciÃ³n para familia:', familiaId);
      
      const resultados = { codigosNidos: {}, numerosMiembros: {}, errores: [] };
      
      try {
        const nidosSnap = await db.collection('nidos').where('familiaId', '==', familiaId).get();
        const nidos = nidosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Calcular cÃ³digos
        resultados.codigosNidos = calcularCodigosNidos(nidos);
        resultados.numerosMiembros = calcularNumerosMiembros(nidos);
        
        // Actualizar en Firestore
        const batch = db.batch();
        
        // Actualizar nidos con codigoNido
        Object.entries(resultados.codigosNidos).forEach(([nidoId, codigo]) => {
          batch.update(db.collection('nidos').doc(nidoId), { codigoNido: codigo });
        });
        
        // Actualizar miembrosData con numeroMiembro
        nidos.forEach(nido => {
          const miembrosActualizados = (nido.miembrosData || []).map(m => {
            const idUnico = m.uid || m.email || m.id || `${nido.id}-${m.nombre}`;
            return { ...m, numeroMiembro: resultados.numerosMiembros[idUnico] || null };
          });
          batch.update(db.collection('nidos').doc(nido.id), { miembrosData: miembrosActualizados });
        });
        
        await batch.commit();
        console.log('âœ… NumeraciÃ³n guardada');
        
      } catch (error) {
        resultados.errores.push({ tipo: 'general', error: error.message });
      }
      
      return resultados;
    }
  </script>
</body>
</html>
