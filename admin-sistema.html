<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK â€” Admin Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --sage: #7A9E7E; --sage-light: #9BB89E; --sage-dark: #5C7D5F; --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3; --cream-dark: #F5EDE4;
      --terracotta: #C17757; --terracotta-muted: rgba(193, 119, 87, 0.15);
      --admin: #4A5568; --admin-light: #718096; --admin-dark: #2D3748; --admin-muted: rgba(74, 85, 104, 0.1);
      --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A; --white: #FFFFFF;
      --success: #48BB78; --warning: #ECC94B; --error: #F56565; --info: #4299E1;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06); --shadow-medium: 0 4px 16px rgba(0,0,0,0.1);
      --radius-sm: 6px; --radius-md: 10px; --radius-lg: 14px; --radius-full: 50px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* HEADER */
    .header { background: linear-gradient(135deg, var(--admin-dark) 0%, var(--admin) 100%); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-medium); position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 0.5em; text-decoration: none; }
    .logo-icon { height: 2rem; width: auto; filter: brightness(0) invert(1); }
    .logo-text { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1rem; color: white; }
    .logo-badge { padding: 2px 8px; background: var(--terracotta); color: white; border-radius: var(--radius-full); font-size: 0.65rem; font-weight: 700; }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .header-link { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.8rem; font-weight: 600; }
    .header-link:hover { color: white; }
    .user-badge { display: flex; align-items: center; gap: 6px; padding: 5px 10px; background: rgba(255,255,255,0.1); border-radius: var(--radius-full); color: white; font-size: 0.8rem; }
    .user-badge-avatar { width: 26px; height: 26px; background: var(--sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem; }

    /* LAYOUT */
    .layout { display: grid; grid-template-columns: 220px 1fr; min-height: calc(100vh - 58px); }
    .sidebar { background: var(--white); border-right: 1px solid var(--cream-dark); padding: 16px 0; overflow-y: auto; }
    .sidebar-section { margin-bottom: 16px; }
    .sidebar-title { padding: 0 16px; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 700; margin-bottom: 4px; }
    .sidebar-nav { list-style: none; }
    .sidebar-link { display: flex; align-items: center; gap: 8px; padding: 9px 16px; color: var(--text-light); text-decoration: none; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: none; background: none; width: 100%; text-align: left; transition: all 0.2s; }
    .sidebar-link:hover { background: var(--cream); color: var(--text); }
    .sidebar-link.active { background: var(--admin-muted); color: var(--admin-dark); border-right: 3px solid var(--admin); }
    .sidebar-link-icon { font-size: 0.95rem; width: 20px; text-align: center; }
    .sidebar-link-badge { margin-left: auto; padding: 2px 6px; background: var(--info); color: white; border-radius: var(--radius-full); font-size: 0.6rem; font-weight: 700; }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .main { padding: 16px !important; }
    }

    /* MAIN */
    .main { padding: 20px; max-width: 1400px; }
    .section { display: none; }
    .section.active { display: block; }
    .section-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .section-title { font-family: 'Quicksand', sans-serif; font-size: 1.3rem; font-weight: 700; color: var(--admin-dark); margin-bottom: 2px; }
    .section-description { color: var(--text-muted); font-size: 0.8rem; }

    /* STATS */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: var(--white); border-radius: var(--radius-lg); padding: 14px; box-shadow: var(--shadow-soft); display: flex; align-items: center; gap: 12px; }
    .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .stat-icon.usuarios { background: var(--sage-muted); }
    .stat-icon.familias { background: var(--terracotta-muted); }
    .stat-icon.planes { background: rgba(236, 201, 75, 0.2); }
    .stat-icon.nidos { background: rgba(66, 153, 225, 0.2); }
    .stat-icon.ingresos { background: rgba(72, 187, 120, 0.2); }
    .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--admin-dark); }
    .stat-label { font-size: 0.7rem; color: var(--text-muted); }
    .stat-trend { font-size: 0.65rem; margin-top: 2px; }
    .stat-trend.up { color: var(--success); }
    .stat-trend.down { color: var(--error); }

    /* CARD */
    .card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); overflow: hidden; margin-bottom: 16px; }
    .card-header { padding: 12px 16px; border-bottom: 1px solid var(--cream-dark); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
    .card-title { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
    .card-body { padding: 16px; }

    /* TABLE */
    .table-container { overflow-x: auto; }
    .table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .table th, .table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--cream-dark); }
    .table th { background: var(--cream); font-weight: 700; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
    .table tr:hover { background: var(--cream); }

    /* BADGES */
    .badge { display: inline-block; padding: 2px 8px; border-radius: var(--radius-full); font-size: 0.65rem; font-weight: 600; }
    .badge-success { background: rgba(72, 187, 120, 0.2); color: var(--success); }
    .badge-warning { background: rgba(236, 201, 75, 0.2); color: #B7791F; }
    .badge-error { background: rgba(245, 101, 101, 0.2); color: var(--error); }
    .badge-info { background: rgba(66, 153, 225, 0.2); color: var(--info); }
    .badge-neutral { background: var(--cream-dark); color: var(--text-muted); }
    .badge-plan { padding: 3px 10px; font-size: 0.7rem; font-weight: 700; }
    .badge-plan.gratuito { background: var(--cream-dark); color: var(--text-muted); }
    .badge-plan.plus { background: rgba(122, 158, 126, 0.2); color: var(--sage-dark); }
    .badge-plan.premium { background: rgba(193, 119, 87, 0.2); color: var(--terracotta); }

    /* BUTTONS */
    .btn { display: inline-flex; align-items: center; gap: 5px; padding: 8px 12px; border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.75rem; font-weight: 600; cursor: pointer; border: none; text-decoration: none; transition: all 0.2s; }
    .btn-primary { background: var(--admin); color: white; }
    .btn-primary:hover { background: var(--admin-dark); }
    .btn-secondary { background: var(--cream); color: var(--text); border: 1px solid var(--cream-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-sm { padding: 4px 8px; font-size: 0.7rem; }

    /* FORM */
    .form-group { margin-bottom: 12px; }
    .form-label { display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; }
    .form-input, .form-select { width: 100%; padding: 8px 10px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.8rem; }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--admin); }
    .form-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 3px; }

    /* TOOLBAR */
    .toolbar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
    .search-box { flex: 1; min-width: 180px; position: relative; }
    .search-input { width: 100%; padding: 8px 12px 8px 32px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md); font-size: 0.8rem; }
    .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    .filter-select { padding: 8px 12px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md); font-size: 0.8rem; background: var(--white); }

    /* SWITCH */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--cream-dark); border-radius: 24px; transition: 0.3s; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s; }
    input:checked + .slider { background-color: var(--success); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* CONFIG GRID */
    .config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
    .config-card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); overflow: hidden; }
    .config-card-header { padding: 12px 14px; background: var(--admin-muted); border-bottom: 1px solid var(--cream-dark); display: flex; align-items: center; gap: 8px; }
    .config-card-icon { font-size: 1.1rem; }
    .config-card-title { font-weight: 700; font-size: 0.85rem; flex: 1; }
    .config-card-body { padding: 14px; }
    .config-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--cream-dark); }
    .config-item:last-child { border-bottom: none; }
    .config-item-label { font-size: 0.8rem; color: var(--text-light); }
    .config-item-sublabel { font-size: 0.7rem; color: var(--text-muted); }

    /* LOGS */
    .log-entry { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--cream-dark); font-size: 0.8rem; }
    .log-entry:last-child { border-bottom: none; }
    .log-time { color: var(--text-muted); font-size: 0.7rem; white-space: nowrap; min-width: 120px; }
    .log-icon { font-size: 1rem; }
    .log-content { flex: 1; }
    .log-user { font-weight: 600; color: var(--admin-dark); }
    .log-action { color: var(--text-light); }

    /* MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; padding: 16px; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--white); border-radius: var(--radius-lg); width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 14px 20px; border-bottom: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1rem; }
    .modal-close { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: var(--text-muted); }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 12px 20px; border-top: 1px solid var(--cream-dark); display: flex; justify-content: flex-end; gap: 10px; }

    /* CHARTS */
    .chart-container { position: relative; height: 250px; }

    /* UTILITIES */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-muted); }
    .mt-2 { margin-top: 12px; }
    .mb-2 { margin-bottom: 12px; }
    .divider { height: 1px; background: var(--cream-dark); margin: 16px 0; }
    .empty-state { text-align: center; padding: 30px 16px; color: var(--text-muted); }
    .loading { display: flex; align-items: center; justify-content: center; padding: 30px; }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--cream-dark); border-top-color: var(--admin); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="index.html" class="logo">
        <img src="logo_familynk.png" alt="FAMILYNK" class="logo-icon">
        <span class="logo-text">FAMILYNK</span>
        <span class="logo-badge">ADMIN</span>
      </a>
    </div>
    <div class="header-right">
      <a href="#" onclick="cerrarSesion()" class="header-link">Salir</a>
      <div class="user-badge">
        <div class="user-badge-avatar" id="user-avatar">A</div>
        <span id="user-name">Admin</span>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">General</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link active" data-section="dashboard" onclick="cambiarSeccion('dashboard')">
            <span class="sidebar-link-icon">ğŸ“Š</span>Dashboard
          </button>
          <button class="sidebar-link" data-section="logs" onclick="cambiarSeccion('logs')">
            <span class="sidebar-link-icon">ğŸ“‹</span>Actividad
          </button>
        </nav>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">ConfiguraciÃ³n</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link" data-section="lo-comun" onclick="cambiarSeccion('lo-comun')">
            <span class="sidebar-link-icon">ğŸ </span>Lo ComÃºn
          </button>
          <button class="sidebar-link" data-section="cerebro" onclick="cambiarSeccion('cerebro')">
            <span class="sidebar-link-icon">ğŸ§ </span>Cerebro
          </button>
          <button class="sidebar-link" data-section="activacion" onclick="cambiarSeccion('activacion')">
            <span class="sidebar-link-icon">âš¡</span>ActivaciÃ³n
          </button>
          <button class="sidebar-link" data-section="arbol" onclick="cambiarSeccion('arbol')">
            <span class="sidebar-link-icon">ğŸŒ³</span>Ãrbol
          </button>
          <button class="sidebar-link" data-section="mi-nido" onclick="cambiarSeccion('mi-nido')">
            <span class="sidebar-link-icon">ğŸªº</span>Mi Nido
          </button>
        </nav>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">MonetizaciÃ³n</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link" data-section="planes" onclick="cambiarSeccion('planes')">
            <span class="sidebar-link-icon">ğŸ’³</span>Planes
          </button>
        </nav>
      </div>
    </aside>

    <main class="main">
      <!-- ============ DASHBOARD ============ -->
      <section class="section active" id="section-dashboard">
        <div class="section-header">
          <div><h1 class="section-title">ğŸ“Š Dashboard</h1><p class="section-description">MÃ©tricas y tendencias de la plataforma</p></div>
          <button class="btn btn-secondary" onclick="exportarMetricas()">ğŸ“¥ Exportar</button>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon usuarios">ğŸ‘¥</div>
            <div>
              <div class="stat-value" id="stat-usuarios">-</div>
              <div class="stat-label">Usuarios</div>
              <div class="stat-trend up" id="trend-usuarios"></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon familias">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
            <div>
              <div class="stat-value" id="stat-familias">-</div>
              <div class="stat-label">Ramas</div>
              <div class="stat-trend up" id="trend-familias"></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon nidos">ğŸªº</div>
            <div>
              <div class="stat-value" id="stat-nidos">-</div>
              <div class="stat-label">Nidos</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon planes">ğŸ’³</div>
            <div>
              <div class="stat-value" id="stat-planes-pago">-</div>
              <div class="stat-label">Planes de pago</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon ingresos">ğŸ’°</div>
            <div>
              <div class="stat-value" id="stat-ingresos">-â‚¬</div>
              <div class="stat-label">FacturaciÃ³n mes</div>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ“ˆ Crecimiento mensual</span></div>
            <div class="card-body">
              <div class="chart-container"><canvas id="chart-crecimiento"></canvas></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ¥§ DistribuciÃ³n de planes</span></div>
            <div class="card-body">
              <div class="chart-container"><canvas id="chart-planes"></canvas></div>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ“‹ Actividad reciente</span></div>
            <div class="card-body" id="actividad-reciente"><div class="loading"><div class="spinner"></div></div></div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ‘¥ Ãšltimas ramas</span></div>
            <div class="card-body" id="ultimas-familias"><div class="loading"><div class="spinner"></div></div></div>
          </div>
        </div>
      </section>

      <!-- ============ LOGS ============ -->
      <section class="section" id="section-logs">
        <div class="section-header">
          <div><h1 class="section-title">ğŸ“‹ Logs de actividad</h1><p class="section-description">Registro de acciones del sistema</p></div>
          <button class="btn btn-secondary" onclick="exportarLogs()">ğŸ“¥ Exportar</button>
        </div>
        <div class="toolbar">
          <select class="filter-select" id="filter-log-tipo" onchange="cargarLogs()">
            <option value="">Todos los tipos</option>
            <option value="usuario">Usuarios</option>
            <option value="familia">Familias</option>
            <option value="plan">Planes</option>
            <option value="config">ConfiguraciÃ³n</option>
            <option value="sistema">Sistema</option>
          </select>
          <select class="filter-select" id="filter-log-fecha" onchange="cargarLogs()">
            <option value="hoy">Hoy</option>
            <option value="semana">Ãšltima semana</option>
            <option value="mes" selected>Ãšltimo mes</option>
            <option value="todo">Todo</option>
          </select>
        </div>
        <div class="card">
          <div class="card-body" id="logs-lista"><div class="loading"><div class="spinner"></div></div></div>
        </div>
      </section>

      <!-- ============ LO COMÃšN ============ -->
      <section class="section" id="section-lo-comun">
        <div class="section-header">
          <div><h1 class="section-title">ğŸ  Lo ComÃºn</h1><p class="section-description">ConfiguraciÃ³n de mÃ³dulos de gestiÃ³n de bienes</p></div>
        </div>

        <div class="stats-grid mb-2">
          <div class="stat-card"><div class="stat-icon" style="background:rgba(139,115,85,0.2)">ğŸ©</div><div><div class="stat-value" id="stat-mayordomo">-</div><div class="stat-label">Usan Mayordomo</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(45,74,92,0.15)">ğŸ¨</div><div><div class="stat-value" id="stat-gerente">-</div><div class="stat-label">Usan Gerente</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(76,112,56,0.15)">ğŸŒ¾</div><div><div class="stat-value" id="stat-capataz">-</div><div class="stat-label">Usan Capataz</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(66,153,225,0.2)">ğŸ </div><div><div class="stat-value" id="stat-bienes">-</div><div class="stat-label">Bienes totales</div></div></div>
        </div>

        <div class="config-grid">
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ©</span><span class="config-card-title">Mayordomo</span><span class="badge badge-info">DomÃ©stico</span></div>
            <div class="config-card-body">
              <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">GestiÃ³n de hogar: reservas, gastos, limpieza, eventos</p>
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="mayordomo-plan" onchange="guardarConfigModulo('mayordomo')"><option value="gratuito">Gratuito</option><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Activo por defecto</span><label class="switch"><input type="checkbox" id="mayordomo-activo" onchange="guardarConfigModulo('mayordomo')"><span class="slider"></span></label></div>
            </div>
          </div>

          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ¨</span><span class="config-card-title">Gerente</span><span class="badge badge-warning">Hospitalidad</span></div>
            <div class="config-card-body">
              <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">Alquiler turÃ­stico: habitaciones, tarifas, huÃ©spedes, ventas</p>
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="gerente-plan" onchange="guardarConfigModulo('gerente')"><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Activo por defecto</span><label class="switch"><input type="checkbox" id="gerente-activo" onchange="guardarConfigModulo('gerente')"><span class="slider"></span></label></div>
            </div>
          </div>

          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸŒ¾</span><span class="config-card-title">Capataz</span><span class="badge badge-success">Rural</span></div>
            <div class="config-card-body">
              <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">GestiÃ³n rural: parcelas, maquinaria, cosechas, personal</p>
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="capataz-plan" onchange="guardarConfigModulo('capataz')"><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Activo por defecto</span><label class="switch"><input type="checkbox" id="capataz-activo" onchange="guardarConfigModulo('capataz')"><span class="slider"></span></label></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ============ CEREBRO ============ -->
      <section class="section" id="section-cerebro">
        <div class="section-header">
          <div><h1 class="section-title">ğŸ§  Cerebro</h1><p class="section-description">Motores de organizaciÃ³n familiar</p></div>
        </div>

        <div class="config-grid">
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ’­</span><span class="config-card-title">Memoria</span><span class="badge badge-neutral">PrÃ³ximamente</span></div>
            <div class="config-card-body"><p style="font-size:0.8rem;color:var(--text-muted);">Archivo de recuerdos, fechas importantes, tradiciones familiares</p></div>
          </div>
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">âš™ï¸</span><span class="config-card-title">Razonamiento</span><span class="badge badge-neutral">PrÃ³ximamente</span></div>
            <div class="config-card-body"><p style="font-size:0.8rem;color:var(--text-muted);">Toma de decisiones, votaciones, consensos familiares</p></div>
          </div>
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">âœ¨</span><span class="config-card-title">IntuiciÃ³n</span><span class="badge badge-neutral">PrÃ³ximamente</span></div>
            <div class="config-card-body"><p style="font-size:0.8rem;color:var(--text-muted);">Sugerencias inteligentes, alertas proactivas, patrones</p></div>
          </div>
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ“Š</span><span class="config-card-title">AnÃ¡lisis</span><span class="badge badge-neutral">PrÃ³ximamente</span></div>
            <div class="config-card-body"><p style="font-size:0.8rem;color:var(--text-muted);">EstadÃ­sticas familiares, informes, tendencias</p></div>
          </div>
        </div>

        <div class="card mt-2">
          <div class="card-body text-center" style="padding:40px;">
            <div style="font-size:3rem;margin-bottom:16px;">ğŸš§</div>
            <h3 style="margin-bottom:8px;">En desarrollo</h3>
            <p class="text-muted">Los motores del Cerebro estÃ¡n siendo diseÃ±ados para ayudar a las familias a organizarse de forma inteligente.</p>
          </div>
        </div>
      </section>

      <!-- ============ ACTIVACIÃ“N ============ -->
      <section class="section" id="section-activacion">
        <div class="section-header">
          <div><h1 class="section-title">âš¡ ActivaciÃ³n</h1><p class="section-description">Herramientas y funcionalidades disponibles</p></div>
        </div>

        <div class="stats-grid mb-2">
          <div class="stat-card"><div class="stat-icon" style="background:rgba(66,153,225,0.2)">ğŸ’¬</div><div><div class="stat-value" id="stat-uso-chat">-</div><div class="stat-label">Usan Chat</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(72,187,120,0.2)">âœ…</div><div><div class="stat-value" id="stat-uso-tareas">-</div><div class="stat-label">Usan Tareas</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(236,201,75,0.2)">ğŸ“…</div><div><div class="stat-value" id="stat-uso-eventos">-</div><div class="stat-label">Usan Eventos</div></div></div>
        </div>

        <div class="config-grid">
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ’¬</span><span class="config-card-title">Chat familiar</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="chat-plan" onchange="guardarConfigHerramienta('chat')"><option value="gratuito">Gratuito</option><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="chat-activo" checked onchange="guardarConfigHerramienta('chat')"><span class="slider"></span></label></div>
            </div>
          </div>

          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">âœ…</span><span class="config-card-title">Tareas</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="tareas-plan" onchange="guardarConfigHerramienta('tareas')"><option value="gratuito">Gratuito</option><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="tareas-activo" checked onchange="guardarConfigHerramienta('tareas')"><span class="slider"></span></label></div>
            </div>
          </div>

          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ“…</span><span class="config-card-title">Eventos / Calendario</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="eventos-plan" onchange="guardarConfigHerramienta('eventos')"><option value="gratuito">Gratuito</option><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="eventos-activo" checked onchange="guardarConfigHerramienta('eventos')"><span class="slider"></span></label></div>
            </div>
          </div>

          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ</span><span class="config-card-title">Amigo Invisible</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="amigo-plan" onchange="guardarConfigHerramienta('amigo')"><option value="gratuito">Gratuito</option><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="amigo-activo" checked onchange="guardarConfigHerramienta('amigo')"><span class="slider"></span></label></div>
            </div>
          </div>

          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ“Š</span><span class="config-card-title">Encuestas</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="encuestas-plan" onchange="guardarConfigHerramienta('encuestas')"><option value="gratuito">Gratuito</option><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="encuestas-activo" checked onchange="guardarConfigHerramienta('encuestas')"><span class="slider"></span></label></div>
            </div>
          </div>

          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ“¸</span><span class="config-card-title">GalerÃ­a / Fotos</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="galeria-plan" onchange="guardarConfigHerramienta('galeria')"><option value="gratuito">Gratuito</option><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="galeria-activo" checked onchange="guardarConfigHerramienta('galeria')"><span class="slider"></span></label></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ============ ÃRBOL ============ -->
      <section class="section" id="section-arbol">
        <div class="section-header">
          <div><h1 class="section-title">ğŸŒ³ Ãrbol</h1><p class="section-description">ConfiguraciÃ³n del Ã¡rbol genealÃ³gico</p></div>
        </div>

        <div class="stats-grid mb-2">
          <div class="stat-card"><div class="stat-icon familias">ğŸŒ³</div><div><div class="stat-value" id="stat-arboles">-</div><div class="stat-label">Ãrboles activos</div></div></div>
          <div class="stat-card"><div class="stat-icon nidos">ğŸ‘¥</div><div><div class="stat-value" id="stat-miembros-total">-</div><div class="stat-label">Miembros totales</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(139,115,85,0.2)">ğŸ“Š</div><div><div class="stat-value" id="stat-media-gen">-</div><div class="stat-label">Media generaciones</div></div></div>
        </div>

        <div class="config-grid">
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ“</span><span class="config-card-title">LÃ­mites por plan</span></div>
            <div class="config-card-body">
              <div class="config-item">
                <div><span class="config-item-label">Plan Gratuito</span><br><span class="config-item-sublabel">Generaciones mÃ¡ximas</span></div>
                <input type="number" class="form-input" style="width:60px;text-align:center;" id="arbol-gen-gratuito" value="2" onchange="guardarConfigArbol()">
              </div>
              <div class="config-item">
                <div><span class="config-item-label">Plan Plus</span><br><span class="config-item-sublabel">Generaciones mÃ¡ximas</span></div>
                <input type="number" class="form-input" style="width:60px;text-align:center;" id="arbol-gen-plus" value="4" onchange="guardarConfigArbol()">
              </div>
              <div class="config-item">
                <div><span class="config-item-label">Plan Premium</span><br><span class="config-item-sublabel">Generaciones mÃ¡ximas</span></div>
                <input type="number" class="form-input" style="width:60px;text-align:center;" id="arbol-gen-premium" value="10" onchange="guardarConfigArbol()">
              </div>
            </div>
          </div>

          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸŒ±</span><span class="config-card-title">Crear Rama (Add-on)</span></div>
            <div class="config-card-body">
              <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">Permite bifurcar una rama nueva a partir de un nido existente</p>
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="crear-rama-plan" onchange="guardarConfigArbol()"><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Precio add-on</span><input type="number" class="form-input" style="width:80px;" id="crear-rama-precio" value="9.99" step="0.01" onchange="guardarConfigArbol()"> â‚¬/mes</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ============ MI NIDO ============ -->
      <section class="section" id="section-mi-nido">
        <div class="section-header">
          <div><h1 class="section-title">ğŸªº Mi Nido</h1><p class="section-description">ConfiguraciÃ³n de funcionalidades del nido</p></div>
        </div>

        <div class="stats-grid mb-2">
          <div class="stat-card"><div class="stat-icon nidos">ğŸªº</div><div><div class="stat-value" id="stat-nidos-total">-</div><div class="stat-label">Nidos creados</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(237,137,54,0.2)">ğŸ¾</div><div><div class="stat-value" id="stat-mascotas">-</div><div class="stat-label">Mascotas</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(72,187,120,0.2)">ğŸ“</div><div><div class="stat-value" id="stat-listas">-</div><div class="stat-label">Listas activas</div></div></div>
        </div>

        <div class="config-grid">
          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ‘¤</span><span class="config-card-title">Perfil de miembros</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Foto de perfil</span><label class="switch"><input type="checkbox" id="nido-foto" checked onchange="guardarConfigNido()"><span class="slider"></span></label></div>
              <div class="config-item"><span class="config-item-label">Datos de contacto</span><label class="switch"><input type="checkbox" id="nido-contacto" checked onchange="guardarConfigNido()"><span class="slider"></span></label></div>
              <div class="config-item"><span class="config-item-label">Rasgos personales</span><label class="switch"><input type="checkbox" id="nido-rasgos" checked onchange="guardarConfigNido()"><span class="slider"></span></label></div>
            </div>
          </div>

          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ¾</span><span class="config-card-title">Mascotas</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Permitir mascotas</span><label class="switch"><input type="checkbox" id="nido-mascotas" checked onchange="guardarConfigNido()"><span class="slider"></span></label></div>
              <div class="config-item">
                <div><span class="config-item-label">MÃ¡ximo por nido</span></div>
                <input type="number" class="form-input" style="width:60px;text-align:center;" id="nido-max-mascotas" value="5" onchange="guardarConfigNido()">
              </div>
            </div>
          </div>

          <div class="config-card">
            <div class="config-card-header"><span class="config-card-icon">ğŸ“</span><span class="config-card-title">Listas de compra</span></div>
            <div class="config-card-body">
              <div class="config-item"><span class="config-item-label">Disponible en plan</span><select class="form-select" style="width:auto;" id="listas-plan" onchange="guardarConfigNido()"><option value="gratuito">Gratuito</option><option value="plus">Plus</option><option value="premium">Premium</option></select></div>
              <div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" id="listas-activo" checked onchange="guardarConfigNido()"><span class="slider"></span></label></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ============ PLANES ============ -->
      <section class="section" id="section-planes">
        <div class="section-header">
          <div><h1 class="section-title">ğŸ’³ Planes</h1><p class="section-description">EstadÃ­sticas, facturaciÃ³n y gestiÃ³n de planes</p></div>
        </div>

        <!-- ESTADÃSTICAS -->
        <div class="stats-grid mb-2">
          <div class="stat-card"><div class="stat-icon" style="background:var(--cream-dark)">ğŸ†“</div><div><div class="stat-value" id="stat-plan-gratuito">-</div><div class="stat-label">Gratuito</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(122,158,126,0.2)">â­</div><div><div class="stat-value" id="stat-plan-plus">-</div><div class="stat-label">Plus</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(193,119,87,0.2)">ğŸ‘‘</div><div><div class="stat-value" id="stat-plan-premium">-</div><div class="stat-label">Premium</div></div></div>
          <div class="stat-card"><div class="stat-icon ingresos">ğŸ’°</div><div><div class="stat-value" id="stat-facturacion-media">-â‚¬</div><div class="stat-label">Media por cuenta</div></div></div>
        </div>

        <div class="grid-2 mb-2">
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ“ˆ EvoluciÃ³n de ingresos</span></div>
            <div class="card-body"><div class="chart-container"><canvas id="chart-ingresos"></canvas></div></div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ¥§ Tipos de plan</span></div>
            <div class="card-body"><div class="chart-container"><canvas id="chart-tipos-plan"></canvas></div></div>
          </div>
        </div>

        <!-- REGALAR PLAN -->
        <div class="card mb-2">
          <div class="card-header"><span class="card-title">ğŸ Regalar plan a familia</span></div>
          <div class="card-body">
            <div class="toolbar" style="margin-bottom:12px;">
              <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="search-familia-regalo" placeholder="Buscar familia por nombre..." oninput="buscarFamiliaRegalo()">
              </div>
            </div>
            <div id="resultados-regalo" class="hidden">
              <table class="table">
                <thead><tr><th>Familia</th><th>Plan actual</th><th>AcciÃ³n</th></tr></thead>
                <tbody id="tabla-familia-regalo"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- FAMILIAS CON PLAN DE PAGO -->
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ‘‘ Familias con plan de pago</span><span class="badge badge-info" id="badge-pago">0</span></div>
          <div class="card-body">
            <div class="table-container">
              <table class="table">
                <thead><tr><th>Familia</th><th>Plan</th><th>Tipo</th><th>Expira</th><th>Acciones</th></tr></thead>
                <tbody id="tabla-planes-pago"><tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL REGALAR PLAN -->
  <div class="modal-overlay" id="modal-regalo">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">ğŸ Regalar plan</span>
        <button class="modal-close" onclick="cerrarModales()">Ã—</button>
      </div>
      <div class="modal-body" id="modal-regalo-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-success" onclick="confirmarRegalo()">ğŸ Regalar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    firebase.initializeApp({apiKey:"AIzaSyCpdWHcOQdHe1aXzXt4WeKpsMrut-KTNxY",authDomain:"familink-def94.firebaseapp.com",projectId:"familink-def94",storageBucket:"familink-def94.appspot.com",messagingSenderId:"489497766824",appId:"1:489497766824:web:38c5c0463a2d04b5fb4d90"});
    const auth = firebase.auth(), db = firebase.firestore();
    let currentUser = null, userData = null;
    let usuariosData = [], familiasData = [], nidosData = [], logsData = [], bienesData = [];
    let chartCrecimiento = null, chartPlanes = null, chartIngresos = null, chartTiposPlan = null;
    let regaloFamiliaId = null;

    // AUTH
    auth.onAuthStateChanged(async user => {
      console.log('ADMIN: onAuthStateChanged', user?.uid);
      
      // DEBUG VISUAL
      const debugDiv = document.createElement('div');
      debugDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:yellow;padding:10px;z-index:9999;font-size:12px;';
      document.body.appendChild(debugDiv);
      
      if (!user) { 
        debugDiv.innerHTML = 'DEBUG: No hay usuario, redirigiendo a login...';
        setTimeout(() => { window.location.href = 'login.html'; }, 2000);
        return; 
      }
      
      debugDiv.innerHTML = 'DEBUG: Usuario encontrado UID: ' + user.uid;
      currentUser = user;
      
      const doc = await db.collection('usuarios').doc(user.uid).get();
      debugDiv.innerHTML += '<br>DEBUG: Documento existe: ' + doc.exists;
      
      if (doc.exists) {
        const data = doc.data();
        debugDiv.innerHTML += '<br>DEBUG: rol=' + data.rol + ', superAdmin=' + data.superAdmin;
        
        if (data.rol === 'AdminSistema' || data.superAdmin === true) {
          debugDiv.innerHTML += '<br>DEBUG: âœ… AUTORIZADO - Cargando dashboard...';
          setTimeout(() => { debugDiv.remove(); }, 3000);
          userData = data;
          document.getElementById('user-name').textContent = userData.nombre || 'Admin';
          document.getElementById('user-avatar').textContent = (userData.nombre || 'A').charAt(0).toUpperCase();
          cargarDashboard();
          return;
        }
      }
      
      debugDiv.innerHTML += '<br>DEBUG: âŒ NO AUTORIZADO - Redirigiendo a cgi en 3s...';
      setTimeout(() => { window.location.href = 'cgi.html'; }, 3000);
    });

    function cerrarSesion() { auth.signOut().then(() => window.location.href = 'login.html'); }

    // NAVEGACIÃ“N
    function cambiarSeccion(seccion) {
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.toggle('active', l.dataset.section === seccion));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(`section-${seccion}`).classList.add('active');
      
      const cargas = {
        'dashboard': cargarDashboard,
        'logs': cargarLogs,
        'lo-comun': cargarLoComun,
        'activacion': cargarActivacion,
        'arbol': cargarArbol,
        'mi-nido': cargarMiNido,
        'planes': cargarPlanes
      };
      if (cargas[seccion]) cargas[seccion]();
    }

    // ============ DASHBOARD ============
    async function cargarDashboard() {
      try {
        const [usersSnap, famSnap, nidosSnap, bienesSnap, logsSnap] = await Promise.all([
          db.collection('usuarios').get(),
          db.collection('familias').get(),
          db.collection('nidos').get(),
          db.collectionGroup('bienes').get(),
          db.collection('logs').orderBy('fecha', 'desc').limit(10).get()
        ]);

        usuariosData = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        familiasData = famSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        nidosData = nidosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        bienesData = bienesSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Stats bÃ¡sicas
        document.getElementById('stat-usuarios').textContent = usuariosData.length;
        document.getElementById('stat-familias').textContent = familiasData.length;
        document.getElementById('stat-nidos').textContent = nidosData.length;

        // Planes de pago
        const planesPago = familiasData.filter(f => f.plan && f.plan !== 'gratuito');
        document.getElementById('stat-planes-pago').textContent = planesPago.length;

        // FacturaciÃ³n estimada (simplificada)
        const ingresos = planesPago.reduce((acc, f) => {
          if (f.plan === 'plus') return acc + 4.99;
          if (f.plan === 'premium') return acc + 9.99;
          return acc;
        }, 0);
        document.getElementById('stat-ingresos').textContent = ingresos.toFixed(2) + 'â‚¬';

        // GrÃ¡ficas
        renderChartCrecimiento();
        renderChartPlanes();

        // Actividad reciente
        const logs = logsSnap.docs.map(d => d.data());
        renderActividadReciente(logs);

        // Ãšltimas familias
        renderUltimasFamilias();

      } catch (e) { console.error('Error dashboard:', e); }
    }

    function renderChartCrecimiento() {
      const ctx = document.getElementById('chart-crecimiento');
      if (chartCrecimiento) chartCrecimiento.destroy();
      
      // Simular datos de Ãºltimos 6 meses
      const meses = ['Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      const usuarios = [5, 12, 18, 25, 32, usuariosData.length];
      const familias = [2, 5, 8, 12, 18, familiasData.length];

      chartCrecimiento = new Chart(ctx, {
        type: 'line',
        data: {
          labels: meses,
          datasets: [
            { label: 'Usuarios', data: usuarios, borderColor: '#7A9E7E', backgroundColor: 'rgba(122,158,126,0.1)', fill: true, tension: 0.3 },
            { label: 'Ramas', data: familias, borderColor: '#C17757', backgroundColor: 'rgba(193,119,87,0.1)', fill: true, tension: 0.3 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function renderChartPlanes() {
      const ctx = document.getElementById('chart-planes');
      if (chartPlanes) chartPlanes.destroy();

      const gratuito = familiasData.filter(f => !f.plan || f.plan === 'gratuito').length;
      const plus = familiasData.filter(f => f.plan === 'plus').length;
      const premium = familiasData.filter(f => f.plan === 'premium').length;

      chartPlanes = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Gratuito', 'Plus', 'Premium'],
          datasets: [{ data: [gratuito, plus, premium], backgroundColor: ['#E2E8F0', '#7A9E7E', '#C17757'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function renderActividadReciente(logs) {
      const container = document.getElementById('actividad-reciente');
      if (!logs.length) { container.innerHTML = '<p class="text-muted text-center">Sin actividad</p>'; return; }
      
      const icons = { usuario: 'ğŸ‘¤', familia: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', plan: 'ğŸ’³', config: 'âš™ï¸', sistema: 'ğŸ”§' };
      container.innerHTML = logs.slice(0, 5).map(l => {
        const fecha = l.fecha?.toDate ? l.fecha.toDate() : new Date();
        return `<div class="log-entry"><span class="log-icon">${icons[l.tipo] || 'ğŸ“‹'}</span><div class="log-content"><span class="log-user">${l.usuario || 'Sistema'}</span> <span class="log-action">${l.accion || ''}</span></div><span class="log-time">${fecha.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}</span></div>`;
      }).join('');
    }

    function renderUltimasFamilias() {
      const container = document.getElementById('ultimas-familias');
      const ultimas = familiasData.slice(-5).reverse();
      if (!ultimas.length) { container.innerHTML = '<p class="text-muted text-center">Sin familias</p>'; return; }
      
      container.innerHTML = ultimas.map(f => `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--cream-dark);"><div style="width:36px;height:36px;background:var(--terracotta-muted);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;">ğŸŒ³</div><div style="flex:1;"><div style="font-weight:600;font-size:0.85rem;">${f.nombre || 'Sin nombre'}</div><div style="font-size:0.7rem;color:var(--text-muted);">${f.plan ? f.plan.toUpperCase() : 'GRATUITO'}</div></div></div>`).join('');
    }

    // ============ LOGS ============
    async function cargarLogs() {
      try {
        let query = db.collection('logs').orderBy('fecha', 'desc');
        
        const tipo = document.getElementById('filter-log-tipo')?.value;
        if (tipo) query = query.where('tipo', '==', tipo);

        const fecha = document.getElementById('filter-log-fecha')?.value || 'mes';
        const ahora = new Date();
        if (fecha === 'hoy') {
          const inicio = new Date(ahora.setHours(0,0,0,0));
          query = query.where('fecha', '>=', inicio);
        } else if (fecha === 'semana') {
          const inicio = new Date(ahora.getTime() - 7*24*60*60*1000);
          query = query.where('fecha', '>=', inicio);
        } else if (fecha === 'mes') {
          const inicio = new Date(ahora.getTime() - 30*24*60*60*1000);
          query = query.where('fecha', '>=', inicio);
        }

        const snap = await query.limit(100).get();
        logsData = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        const container = document.getElementById('logs-lista');
        if (!logsData.length) { container.innerHTML = '<p class="text-muted text-center">Sin logs</p>'; return; }

        const icons = { usuario: 'ğŸ‘¤', familia: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', plan: 'ğŸ’³', config: 'âš™ï¸', sistema: 'ğŸ”§' };
        container.innerHTML = logsData.map(l => {
          const fecha = l.fecha?.toDate ? l.fecha.toDate() : new Date();
          return `<div class="log-entry"><span class="log-time">${fecha.toLocaleDateString('es')} ${fecha.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}</span><span class="log-icon">${icons[l.tipo] || 'ğŸ“‹'}</span><div class="log-content"><span class="log-user">${l.usuario || 'Sistema'}</span> <span class="log-action">${l.accion || ''}</span></div></div>`;
        }).join('');
      } catch (e) { console.error('Error logs:', e); }
    }

    async function registrarLog(tipo, accion) {
      try {
        await db.collection('logs').add({ tipo, accion, usuario: userData?.nombre || 'Admin', uid: currentUser?.uid, fecha: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (e) { console.warn('Error log:', e); }
    }

    function exportarLogs() {
      const csv = 'Fecha,Tipo,Usuario,AcciÃ³n\n' + logsData.map(l => {
        const fecha = l.fecha?.toDate ? l.fecha.toDate().toISOString() : '';
        return `"${fecha}","${l.tipo||''}","${l.usuario||''}","${l.accion||''}"`;
      }).join('\n');
      descargarCSV(csv, 'logs-familynk.csv');
    }

    // ============ LO COMÃšN ============
    async function cargarLoComun() {
      // Contar uso de mÃ³dulos
      let mayordomo = 0, gerente = 0, capataz = 0;
      bienesData.forEach(b => {
        if (b.mayordomoModulos && Object.values(b.mayordomoModulos).some(v => v)) mayordomo++;
        if (b.gerenteModulos && Object.values(b.gerenteModulos).some(v => v)) gerente++;
        if (b.capatazModulos && Object.values(b.capatazModulos).some(v => v)) capataz++;
      });
      document.getElementById('stat-mayordomo').textContent = mayordomo;
      document.getElementById('stat-gerente').textContent = gerente;
      document.getElementById('stat-capataz').textContent = capataz;
      document.getElementById('stat-bienes').textContent = bienesData.length;

      // Cargar config actual
      const config = await cargarConfigGlobal();
      if (config.modulos) {
        document.getElementById('mayordomo-plan').value = config.modulos.mayordomo?.plan || 'gratuito';
        document.getElementById('mayordomo-activo').checked = config.modulos.mayordomo?.activo !== false;
        document.getElementById('gerente-plan').value = config.modulos.gerente?.plan || 'plus';
        document.getElementById('gerente-activo').checked = config.modulos.gerente?.activo !== false;
        document.getElementById('capataz-plan').value = config.modulos.capataz?.plan || 'plus';
        document.getElementById('capataz-activo').checked = config.modulos.capataz?.activo !== false;
      }
    }

    async function guardarConfigModulo(modulo) {
      const plan = document.getElementById(`${modulo}-plan`).value;
      const activo = document.getElementById(`${modulo}-activo`).checked;
      await db.collection('config').doc('global').set({ modulos: { [modulo]: { plan, activo } } }, { merge: true });
      await registrarLog('config', `ConfigurÃ³ mÃ³dulo ${modulo}: plan=${plan}, activo=${activo}`);
    }

    // ============ ACTIVACIÃ“N ============
    async function cargarActivacion() {
      // TODO: Contar uso real de herramientas
      document.getElementById('stat-uso-chat').textContent = '~' + Math.floor(familiasData.length * 0.6);
      document.getElementById('stat-uso-tareas').textContent = '~' + Math.floor(familiasData.length * 0.4);
      document.getElementById('stat-uso-eventos').textContent = '~' + Math.floor(familiasData.length * 0.3);
    }

    async function guardarConfigHerramienta(herramienta) {
      const plan = document.getElementById(`${herramienta}-plan`).value;
      const activo = document.getElementById(`${herramienta}-activo`).checked;
      await db.collection('config').doc('global').set({ herramientas: { [herramienta]: { plan, activo } } }, { merge: true });
      await registrarLog('config', `ConfigurÃ³ herramienta ${herramienta}`);
    }

    // ============ ÃRBOL ============
    async function cargarArbol() {
      document.getElementById('stat-arboles').textContent = familiasData.length;
      document.getElementById('stat-miembros-total').textContent = usuariosData.length;
      
      // Media de generaciones (simplificado)
      const totalGen = familiasData.reduce((acc, f) => acc + (f.limites?.generaciones || 2), 0);
      document.getElementById('stat-media-gen').textContent = (totalGen / familiasData.length || 0).toFixed(1);

      const config = await cargarConfigGlobal();
      if (config.arbol) {
        document.getElementById('arbol-gen-gratuito').value = config.arbol.genGratuito || 2;
        document.getElementById('arbol-gen-plus').value = config.arbol.genPlus || 4;
        document.getElementById('arbol-gen-premium').value = config.arbol.genPremium || 10;
        document.getElementById('crear-rama-plan').value = config.arbol.crearRamaPlan || 'plus';
        document.getElementById('crear-rama-precio').value = config.arbol.crearRamaPrecio || 9.99;
      }
    }

    async function guardarConfigArbol() {
      const data = {
        arbol: {
          genGratuito: parseInt(document.getElementById('arbol-gen-gratuito').value) || 2,
          genPlus: parseInt(document.getElementById('arbol-gen-plus').value) || 4,
          genPremium: parseInt(document.getElementById('arbol-gen-premium').value) || 10,
          crearRamaPlan: document.getElementById('crear-rama-plan').value,
          crearRamaPrecio: parseFloat(document.getElementById('crear-rama-precio').value) || 9.99
        }
      };
      await db.collection('config').doc('global').set(data, { merge: true });
      await registrarLog('config', 'ActualizÃ³ configuraciÃ³n de Ãrbol');
    }

    // ============ MI NIDO ============
    async function cargarMiNido() {
      document.getElementById('stat-nidos-total').textContent = nidosData.length;
      
      // Contar mascotas
      let mascotas = 0, listas = 0;
      nidosData.forEach(n => {
        (n.miembrosData || []).forEach(m => {
          if (m.mascotas) mascotas += m.mascotas.length;
        });
      });
      document.getElementById('stat-mascotas').textContent = mascotas;
      document.getElementById('stat-listas').textContent = '~' + Math.floor(nidosData.length * 0.5);
    }

    async function guardarConfigNido() {
      await registrarLog('config', 'ActualizÃ³ configuraciÃ³n de Mi Nido');
    }

    // ============ PLANES ============
    async function cargarPlanes() {
      const gratuito = familiasData.filter(f => !f.plan || f.plan === 'gratuito').length;
      const plus = familiasData.filter(f => f.plan === 'plus').length;
      const premium = familiasData.filter(f => f.plan === 'premium').length;

      document.getElementById('stat-plan-gratuito').textContent = gratuito;
      document.getElementById('stat-plan-plus').textContent = plus;
      document.getElementById('stat-plan-premium').textContent = premium;

      // FacturaciÃ³n media
      const planesPago = familiasData.filter(f => f.plan && f.plan !== 'gratuito');
      const totalIngresos = planesPago.reduce((acc, f) => {
        if (f.plan === 'plus') return acc + 4.99;
        if (f.plan === 'premium') return acc + 9.99;
        return acc;
      }, 0);
      const media = planesPago.length > 0 ? (totalIngresos / planesPago.length).toFixed(2) : '0.00';
      document.getElementById('stat-facturacion-media').textContent = media + 'â‚¬';

      // GrÃ¡ficas
      renderChartIngresos();
      renderChartTiposPlan(gratuito, plus, premium);

      // Tabla de planes de pago
      document.getElementById('badge-pago').textContent = planesPago.length;
      const tbody = document.getElementById('tabla-planes-pago');
      if (!planesPago.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay familias con plan de pago</td></tr>';
      } else {
        tbody.innerHTML = planesPago.map(f => {
          const expira = f.planExpira ? new Date(f.planExpira).toLocaleDateString('es') : 'Sin lÃ­mite';
          const tipo = f.planTipo || 'pago';
          const tipoLabel = { pago: 'ğŸ’³ Pago', cortesia: 'ğŸ CortesÃ­a', trial: 'ğŸ§ª Trial' }[tipo] || tipo;
          return `<tr><td style="font-weight:600;">${f.nombre || 'Sin nombre'}</td><td><span class="badge badge-plan ${f.plan}">${(f.plan || '').toUpperCase()}</span></td><td>${tipoLabel}</td><td>${expira}</td><td><button class="btn btn-sm btn-secondary" onclick="abrirRegalo('${f.id}')">âœï¸</button> <button class="btn btn-sm btn-secondary" onclick="quitarPlan('${f.id}')">ğŸ—‘ï¸</button></td></tr>`;
        }).join('');
      }
    }

    function renderChartIngresos() {
      const ctx = document.getElementById('chart-ingresos');
      if (chartIngresos) chartIngresos.destroy();
      
      const meses = ['Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      const ingresos = [50, 120, 180, 250, 350, 420]; // Simulado

      chartIngresos = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: meses,
          datasets: [{ label: 'Ingresos â‚¬', data: ingresos, backgroundColor: '#7A9E7E' }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
    }

    function renderChartTiposPlan(gratuito, plus, premium) {
      const ctx = document.getElementById('chart-tipos-plan');
      if (chartTiposPlan) chartTiposPlan.destroy();

      chartTiposPlan = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Gratuito', 'Plus', 'Premium'],
          datasets: [{ data: [gratuito, plus, premium], backgroundColor: ['#E2E8F0', '#7A9E7E', '#C17757'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function buscarFamiliaRegalo() {
      const search = document.getElementById('search-familia-regalo').value.toLowerCase().trim();
      const container = document.getElementById('resultados-regalo');
      const tbody = document.getElementById('tabla-familia-regalo');

      if (search.length < 2) { container.classList.add('hidden'); return; }

      const filtradas = familiasData.filter(f => (f.nombre || '').toLowerCase().includes(search));
      container.classList.remove('hidden');

      if (!filtradas.length) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Sin resultados</td></tr>';
        return;
      }

      tbody.innerHTML = filtradas.slice(0, 5).map(f => `<tr><td style="font-weight:600;">${f.nombre || 'Sin nombre'}</td><td><span class="badge badge-plan ${f.plan || 'gratuito'}">${(f.plan || 'GRATUITO').toUpperCase()}</span></td><td><button class="btn btn-sm btn-success" onclick="abrirRegalo('${f.id}')">ğŸ Regalar</button></td></tr>`).join('');
    }

    function abrirRegalo(familiaId) {
      regaloFamiliaId = familiaId;
      const f = familiasData.find(x => x.id === familiaId);
      if (!f) return;

      document.getElementById('modal-regalo-body').innerHTML = `
        <p style="margin-bottom:16px;">Regalar plan a: <strong>${f.nombre || 'Sin nombre'}</strong></p>
        <div class="form-group">
          <label class="form-label">Plan</label>
          <select class="form-select" id="regalo-plan">
            <option value="plus">â­ Plus (4.99â‚¬/mes)</option>
            <option value="premium">ğŸ‘‘ Premium (9.99â‚¬/mes)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Motivo</label>
          <select class="form-select" id="regalo-tipo">
            <option value="cortesia">ğŸ CortesÃ­a</option>
            <option value="trial">ğŸ§ª Trial/Prueba</option>
            <option value="beta">ğŸ”¬ Beta tester</option>
            <option value="colaborador">ğŸ¤ Colaborador</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">DuraciÃ³n</label>
          <select class="form-select" id="regalo-duracion">
            <option value="1">1 mes</option>
            <option value="3">3 meses</option>
            <option value="6">6 meses</option>
            <option value="12">1 aÃ±o</option>
            <option value="0">Sin lÃ­mite</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Notas (interno)</label>
          <input type="text" class="form-input" id="regalo-notas" placeholder="Ej: PromociÃ³n navidad 2024">
        </div>
      `;
      document.getElementById('modal-regalo').classList.add('active');
    }

    async function confirmarRegalo() {
      if (!regaloFamiliaId) return;

      const plan = document.getElementById('regalo-plan').value;
      const tipo = document.getElementById('regalo-tipo').value;
      const duracion = parseInt(document.getElementById('regalo-duracion').value);
      const notas = document.getElementById('regalo-notas').value;

      const updateData = {
        plan: plan,
        planTipo: tipo,
        planNotas: notas,
        planActualizadoPor: currentUser.uid,
        planActualizadoFecha: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (duracion > 0) {
        const expira = new Date();
        expira.setMonth(expira.getMonth() + duracion);
        updateData.planExpira = expira.toISOString();
      } else {
        updateData.planExpira = firebase.firestore.FieldValue.delete();
      }

      try {
        await db.collection('familias').doc(regaloFamiliaId).update(updateData);
        const familia = familiasData.find(f => f.id === regaloFamiliaId);
        await registrarLog('plan', `RegalÃ³ plan ${plan.toUpperCase()} a ${familia?.nombre || 'familia'}`);
        
        cerrarModales();
        familiasData = [];
        const snap = await db.collection('familias').get();
        familiasData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        cargarPlanes();
        document.getElementById('search-familia-regalo').value = '';
        document.getElementById('resultados-regalo').classList.add('hidden');
        alert('âœ… Plan regalado correctamente');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function quitarPlan(familiaId) {
      if (!confirm('Â¿Quitar plan de pago? La familia volverÃ¡ al plan gratuito.')) return;
      try {
        await db.collection('familias').doc(familiaId).update({
          plan: 'gratuito',
          planTipo: firebase.firestore.FieldValue.delete(),
          planExpira: firebase.firestore.FieldValue.delete(),
          planNotas: firebase.firestore.FieldValue.delete()
        });
        const familia = familiasData.find(f => f.id === familiaId);
        await registrarLog('plan', `QuitÃ³ plan de pago a ${familia?.nombre || 'familia'}`);
        
        const idx = familiasData.findIndex(f => f.id === familiaId);
        if (idx >= 0) familiasData[idx].plan = 'gratuito';
        cargarPlanes();
      } catch (e) { alert('Error: ' + e.message); }
    }

    // ============ UTILIDADES ============
    async function cargarConfigGlobal() {
      try {
        const doc = await db.collection('config').doc('global').get();
        return doc.exists ? doc.data() : {};
      } catch (e) { return {}; }
    }

    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
      regaloFamiliaId = null;
    }

    document.querySelectorAll('.modal-overlay').forEach(m => {
      m.addEventListener('click', e => { if (e.target === m) cerrarModales(); });
    });

    function descargarCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    function exportarMetricas() {
      const data = {
        fecha: new Date().toISOString(),
        usuarios: usuariosData.length,
        familias: familiasData.length,
        nidos: nidosData.length,
        bienes: bienesData.length
      };
      const csv = Object.keys(data).join(',') + '\n' + Object.values(data).join(',');
      descargarCSV(csv, 'metricas-familynk.csv');
    }
  </script>
</body>
</html>
