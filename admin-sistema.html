<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK â€” Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--sage:#7A9E7E;--sage-muted:rgba(122,158,126,0.15);--cream:#FDF8F3;--cream-dark:#F5EDE4;--terracotta:#C17757;--admin:#4A5568;--admin-dark:#2D3748;--admin-muted:rgba(74,85,104,0.1);--text:#3D3D3D;--text-light:#6B6B6B;--text-muted:#9A9A9A;--white:#FFF;--success:#48BB78;--warning:#ECC94B;--error:#F56565;--info:#4299E1;--shadow-soft:0 2px 8px rgba(0,0,0,0.06);--radius-sm:6px;--radius-md:10px;--radius-lg:14px;--radius-full:50px}
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--text);min-height:100vh}
    .header{background:linear-gradient(135deg,var(--admin-dark),var(--admin));padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .logo{display:flex;align-items:center;gap:0.5em}.logo-icon{height:2rem;filter:brightness(0) invert(1)}.logo-text{font-family:'Quicksand',sans-serif;font-weight:700;font-size:1rem;color:white}.logo-badge{padding:2px 8px;background:var(--terracotta);color:white;border-radius:var(--radius-full);font-size:0.65rem;font-weight:700}
    .header-right{display:flex;align-items:center;gap:12px}.header-link{color:rgba(255,255,255,0.7);font-size:0.8rem;font-weight:600;cursor:pointer}.header-link:hover{color:white}
    .user-badge{display:flex;align-items:center;gap:6px;padding:5px 10px;background:rgba(255,255,255,0.1);border-radius:var(--radius-full);color:white;font-size:0.8rem}.user-badge-avatar{width:26px;height:26px;background:var(--sage);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem}
    .layout{display:grid;grid-template-columns:220px 1fr;min-height:calc(100vh - 58px)}
    .sidebar{background:var(--white);border-right:1px solid var(--cream-dark);padding:16px 0;overflow-y:auto}.sidebar-section{margin-bottom:16px}.sidebar-title{padding:0 16px;font-size:0.6rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);font-weight:700;margin-bottom:4px}.sidebar-nav{list-style:none}
    .sidebar-link{display:flex;align-items:center;gap:8px;padding:9px 16px;color:var(--text-light);font-size:0.8rem;font-weight:600;cursor:pointer;border:none;background:none;width:100%;text-align:left;transition:all 0.2s}.sidebar-link:hover{background:var(--cream);color:var(--text)}.sidebar-link.active{background:var(--admin-muted);color:var(--admin-dark);border-right:3px solid var(--admin)}.sidebar-link-icon{font-size:0.95rem;width:20px;text-align:center}
    @media(max-width:900px){.layout{grid-template-columns:1fr}.sidebar{display:none}.main{padding:16px!important}.stats-grid{grid-template-columns:repeat(2,1fr)!important}.config-grid,.tools-grid,.addon-grid,.plan-grid{grid-template-columns:1fr!important}}
    .main{padding:20px;max-width:1400px}.section{display:none}.section.active{display:block}
    .section-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px}.section-title{font-family:'Quicksand',sans-serif;font-size:1.3rem;font-weight:700;color:var(--admin-dark)}.section-description{color:var(--text-muted);font-size:0.8rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}.stat-card{background:var(--white);border-radius:var(--radius-lg);padding:14px;box-shadow:var(--shadow-soft);display:flex;align-items:center;gap:12px}.stat-icon{width:40px;height:40px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.1rem}.stat-value{font-size:1.4rem;font-weight:700;color:var(--admin-dark)}.stat-label{font-size:0.7rem;color:var(--text-muted)}
    .card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden;margin-bottom:16px}.card-header{padding:12px 16px;border-bottom:1px solid var(--cream-dark);display:flex;align-items:center;justify-content:space-between}.card-title{font-family:'Quicksand',sans-serif;font-weight:700;font-size:0.9rem}.card-body{padding:16px}
    .table-container{overflow-x:auto}.table{width:100%;border-collapse:collapse;font-size:0.8rem}.table th,.table td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--cream-dark)}.table th{background:var(--cream);font-weight:700;font-size:0.7rem;text-transform:uppercase;color:var(--text-muted)}.table tr:hover{background:var(--cream)}
    .badge{display:inline-block;padding:2px 8px;border-radius:var(--radius-full);font-size:0.65rem;font-weight:600}.badge-success{background:rgba(72,187,120,0.2);color:var(--success)}.badge-warning{background:rgba(236,201,75,0.2);color:#B7791F}.badge-error{background:rgba(245,101,101,0.2);color:var(--error)}.badge-info{background:rgba(66,153,225,0.2);color:var(--info)}.badge-neutral{background:var(--cream-dark);color:var(--text-muted)}
    .btn{padding:8px 14px;border-radius:var(--radius-md);font-family:'Nunito',sans-serif;font-size:0.8rem;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}.btn-primary{background:var(--admin);color:white}.btn-primary:hover{background:var(--admin-dark)}.btn-secondary{background:var(--cream-dark);color:var(--text)}.btn-success{background:var(--success);color:white}.btn-sm{padding:5px 10px;font-size:0.75rem}
    .toolbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}.search-box{display:flex;align-items:center;gap:8px;background:var(--white);border:2px solid var(--cream-dark);border-radius:var(--radius-md);padding:6px 10px;flex:1;max-width:300px}.search-input{border:none;outline:none;font-family:'Nunito',sans-serif;font-size:0.8rem;flex:1;background:transparent}.filter-select{padding:8px 12px;border:2px solid var(--cream-dark);border-radius:var(--radius-md);font-family:'Nunito',sans-serif;font-size:0.8rem;background:var(--white)}
    .form-group{margin-bottom:14px}.form-label{display:block;font-size:0.8rem;font-weight:600;margin-bottom:4px}.form-input,.form-select,.form-textarea{width:100%;padding:8px 10px;border:2px solid var(--cream-dark);border-radius:var(--radius-md);font-family:'Nunito',sans-serif;font-size:0.8rem}.form-textarea{resize:vertical;min-height:80px}.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--admin)}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .switch{position:relative;display:inline-block;width:44px;height:24px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--cream-dark);border-radius:24px;transition:0.3s}.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;border-radius:50%;transition:0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2)}input:checked+.slider{background-color:var(--success)}input:checked+.slider:before{transform:translateX(20px)}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s;padding:16px}.modal-overlay.active{opacity:1;visibility:visible}.modal{background:var(--white);border-radius:var(--radius-lg);width:100%;max-width:500px;max-height:90vh;overflow-y:auto}.modal-header{padding:14px 20px;border-bottom:1px solid var(--cream-dark);display:flex;justify-content:space-between;align-items:center}.modal-title{font-family:'Quicksand',sans-serif;font-weight:700;font-size:1rem}.modal-close{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--text-muted)}.modal-body{padding:20px}.modal-footer{padding:12px 20px;border-top:1px solid var(--cream-dark);display:flex;justify-content:flex-end;gap:10px}
    .config-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}.config-card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden}.config-card-header{padding:12px 14px;background:var(--admin-muted);border-bottom:1px solid var(--cream-dark);display:flex;align-items:center;gap:8px}.config-card-icon{font-size:1.1rem}.config-card-title{font-weight:700;font-size:0.85rem}.config-card-body{padding:14px}.config-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--cream-dark)}.config-item:last-child{border-bottom:none}.config-item-label{font-size:0.8rem;color:var(--text-light)}.config-input{width:70px;padding:5px 8px;border:2px solid var(--cream-dark);border-radius:var(--radius-sm);text-align:center;font-weight:600;font-size:0.8rem}
    .tools-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}.tool-card{background:var(--white);border-radius:var(--radius-md);padding:14px;box-shadow:var(--shadow-soft);display:flex;align-items:center;gap:12px}.tool-icon{width:36px;height:36px;background:var(--cream);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1.1rem}.tool-info{flex:1}.tool-name{font-weight:600;font-size:0.85rem}.tool-status{font-size:0.7rem;color:var(--text-muted)}
    .plan-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}.plan-card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden}.plan-card-header{padding:16px;text-align:center}.plan-card-header.free{background:var(--admin-muted)}.plan-card-header.plus{background:rgba(66,153,225,0.15)}.plan-card-header.mega{background:rgba(236,201,75,0.15)}.plan-icon{font-size:2rem;margin-bottom:8px}.plan-name{font-family:'Quicksand',sans-serif;font-weight:700;font-size:1.1rem}.plan-price{font-size:1.5rem;font-weight:700;color:var(--admin-dark);margin-top:6px}.plan-price span{font-size:0.8rem;font-weight:400;color:var(--text-muted)}.plan-card-body{padding:16px}.plan-feature{display:flex;align-items:flex-start;gap:8px;padding:6px 0;font-size:0.8rem}.plan-feature-icon{color:var(--success);font-weight:700}.plan-card-footer{padding:12px 16px;border-top:1px solid var(--cream-dark);display:flex;justify-content:space-between;align-items:center}
    .addon-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}.addon-card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden}.addon-card-header{padding:14px;display:flex;align-items:center;gap:12px}.addon-card-header.crearrama{background:rgba(193,119,87,0.1)}.addon-card-header.mayordomo{background:rgba(139,115,85,0.1)}.addon-card-header.gerente{background:rgba(74,85,104,0.1)}.addon-card-header.capataz{background:rgba(107,142,35,0.1)}.addon-icon{font-size:1.5rem}.addon-name{font-weight:700;font-size:0.95rem}.addon-desc{font-size:0.75rem;color:var(--text-muted)}.addon-card-body{padding:14px;border-top:1px solid var(--cream-dark)}
    .service-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}.service-card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);overflow:hidden}.service-header{padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--cream-dark)}.service-logo{width:40px;height:40px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.3rem}.service-name{font-weight:700;font-size:0.9rem}.service-type{font-size:0.7rem;color:var(--text-muted)}.service-status{padding:3px 8px;border-radius:var(--radius-full);font-size:0.65rem;font-weight:600}.service-status.activo{background:rgba(72,187,120,0.2);color:var(--success)}.service-status.inactivo{background:var(--cream-dark);color:var(--text-muted)}.service-body{padding:12px 16px}.service-field{margin-bottom:10px}.service-field-label{font-size:0.7rem;color:var(--text-muted);margin-bottom:3px}.service-field-value{font-family:monospace;font-size:0.75rem;padding:6px 8px;background:var(--cream);border-radius:var(--radius-sm)}.service-footer{padding:10px 16px;border-top:1px solid var(--cream-dark);display:flex;justify-content:space-between}
    .log-entry{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--cream-dark);font-size:0.8rem}.log-entry:last-child{border-bottom:none}.log-time{color:var(--text-muted);font-size:0.7rem;white-space:nowrap}.log-icon{font-size:1rem}.log-content{flex:1}.log-user{font-weight:600;color:var(--admin-dark)}.log-action{color:var(--text-light)}
    .notif-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--cream-dark)}.notif-item:last-child{border-bottom:none}.notif-label{font-size:0.85rem}.notif-desc{font-size:0.7rem;color:var(--text-muted)}
    .hidden{display:none!important}.text-center{text-align:center}.text-muted{color:var(--text-muted)}.mt-2{margin-top:12px}.mb-2{margin-bottom:12px}.divider{height:1px;background:var(--cream-dark);margin:16px 0}.empty-state{text-align:center;padding:30px 16px;color:var(--text-muted)}.loading{display:flex;align-items:center;justify-content:center;padding:30px}.spinner{width:32px;height:32px;border:3px solid var(--cream-dark);border-top-color:var(--admin);border-radius:50%;animation:spin 0.8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header class="header">
    <div class="logo"><img src="logo_familynk.png" alt="FAMILYNK" class="logo-icon"><span class="logo-text">FAMILYNK</span><span class="logo-badge">ADMIN</span></div>
    <div class="header-right"><span class="header-link" onclick="cerrarSesion()">Salir</span><div class="user-badge"><div class="user-badge-avatar" id="user-avatar">?</div><span id="user-name">Admin</span></div></div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section"><div class="sidebar-title">MÃ©tricas</div><nav class="sidebar-nav">
        <button class="sidebar-link active" data-section="dashboard" onclick="cambiarSeccion('dashboard')"><span class="sidebar-link-icon">ğŸ“Š</span>Dashboard</button>
        <button class="sidebar-link" data-section="logs" onclick="cambiarSeccion('logs')"><span class="sidebar-link-icon">ğŸ“‹</span>Logs</button>
      </nav></div>
      <div class="sidebar-section"><div class="sidebar-title">GestiÃ³n</div><nav class="sidebar-nav">
        <button class="sidebar-link" data-section="ramas" onclick="cambiarSeccion('ramas')"><span class="sidebar-link-icon">ğŸŒ³</span>Ramas</button>
        <button class="sidebar-link" data-section="estirpes" onclick="cambiarSeccion('estirpes')"><span class="sidebar-link-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>Estirpes</button>
        <button class="sidebar-link" data-section="nidos" onclick="cambiarSeccion('nidos')"><span class="sidebar-link-icon">ğŸªº</span>Nidos</button>
        <button class="sidebar-link" data-section="usuarios" onclick="cambiarSeccion('usuarios')"><span class="sidebar-link-icon">ğŸ‘¤</span>Usuarios</button>
        <button class="sidebar-link" data-section="invitaciones" onclick="cambiarSeccion('invitaciones')"><span class="sidebar-link-icon">âœ‰ï¸</span>Invitaciones</button>
      </nav></div>
      <div class="sidebar-section"><div class="sidebar-title">MonetizaciÃ³n</div><nav class="sidebar-nav">
        <button class="sidebar-link" data-section="planes" onclick="cambiarSeccion('planes')"><span class="sidebar-link-icon">ğŸ’³</span>Planes</button>
        <button class="sidebar-link" data-section="addons" onclick="cambiarSeccion('addons')"><span class="sidebar-link-icon">âš¡</span>Add-ons</button>
      </nav></div>
      <div class="sidebar-section"><div class="sidebar-title">ConfiguraciÃ³n</div><nav class="sidebar-nav">
        <button class="sidebar-link" data-section="cfg-locomun" onclick="cambiarSeccion('cfg-locomun')"><span class="sidebar-link-icon">ğŸ </span>Lo ComÃºn</button>
        <button class="sidebar-link" data-section="cfg-legado" onclick="cambiarSeccion('cfg-legado')"><span class="sidebar-link-icon">ğŸ“œ</span>Legado</button>
        <button class="sidebar-link" data-section="cfg-cerebro" onclick="cambiarSeccion('cfg-cerebro')"><span class="sidebar-link-icon">ğŸ§ </span>Cerebro</button>
        <button class="sidebar-link" data-section="cfg-activacion" onclick="cambiarSeccion('cfg-activacion')"><span class="sidebar-link-icon">ğŸ¯</span>ActivaciÃ³n</button>
        <button class="sidebar-link" data-section="cfg-arbol" onclick="cambiarSeccion('cfg-arbol')"><span class="sidebar-link-icon">ğŸŒ²</span>Ãrbol</button>
        <button class="sidebar-link" data-section="cfg-minido" onclick="cambiarSeccion('cfg-minido')"><span class="sidebar-link-icon">ğŸª¹</span>Mi Nido</button>
        <button class="sidebar-link" data-section="cfg-visibilidad" onclick="cambiarSeccion('cfg-visibilidad')"><span class="sidebar-link-icon">ğŸ‘ï¸</span>Visibilidad</button>
      </nav></div>
      <div class="sidebar-section"><div class="sidebar-title">Sistema</div><nav class="sidebar-nav">
        <button class="sidebar-link" data-section="estructura" onclick="cambiarSeccion('estructura')"><span class="sidebar-link-icon">ğŸ—ï¸</span>Estructura</button>
        <button class="sidebar-link" data-section="servicios" onclick="cambiarSeccion('servicios')"><span class="sidebar-link-icon">ğŸ”Œ</span>Servicios</button>
        <button class="sidebar-link" data-section="notificaciones" onclick="cambiarSeccion('notificaciones')"><span class="sidebar-link-icon">ğŸ””</span>Notificaciones</button>
        <button class="sidebar-link" data-section="backup" onclick="cambiarSeccion('backup')"><span class="sidebar-link-icon">ğŸ’¾</span>Backup</button>
        <button class="sidebar-link" data-section="legal" onclick="cambiarSeccion('legal')"><span class="sidebar-link-icon">âš–ï¸</span>Legal</button>
      </nav></div>
    </aside>

    <main class="main">
      <!-- DASHBOARD -->
      <section class="section active" id="section-dashboard">
        <div class="section-header"><div><h1 class="section-title">ğŸ“Š Dashboard</h1><p class="section-description">MÃ©tricas generales</p></div></div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon" style="background:rgba(193,119,87,0.2)">ğŸŒ³</div><div><div class="stat-value" id="stat-ramas">-</div><div class="stat-label">Ramas</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(122,158,126,0.2)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div><div><div class="stat-value" id="stat-estirpes">-</div><div class="stat-label">Estirpes</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(66,153,225,0.2)">ğŸªº</div><div><div class="stat-value" id="stat-nidos">-</div><div class="stat-label">Nidos</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:var(--sage-muted)">ğŸ‘¤</div><div><div class="stat-value" id="stat-usuarios">-</div><div class="stat-label">Usuarios</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(236,201,75,0.2)">âš¡</div><div><div class="stat-value" id="stat-addons">-</div><div class="stat-label">Add-ons</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(139,115,85,0.2)">ğŸ </div><div><div class="stat-value" id="stat-bienes">-</div><div class="stat-label">Bienes</div></div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card"><div class="card-header"><span class="card-title">ğŸ“ˆ Ãšltimas ramas</span></div><div class="card-body" id="ultimas-ramas"><div class="loading"><div class="spinner"></div></div></div></div>
          <div class="card"><div class="card-header"><span class="card-title">ğŸ“‹ Actividad</span></div><div class="card-body" id="actividad-reciente"><div class="loading"><div class="spinner"></div></div></div></div>
        </div>
      </section>

      <!-- LOGS -->
      <section class="section" id="section-logs">
        <div class="section-header"><div><h1 class="section-title">ğŸ“‹ Logs</h1></div><button class="btn btn-secondary" onclick="exportarLogs()">ğŸ“¥ Exportar</button></div>
        <div class="card"><div class="card-body" id="logs-lista"><div class="loading"><div class="spinner"></div></div></div></div>
      </section>

      <!-- RAMAS -->
      <section class="section" id="section-ramas">
        <div class="section-header"><div><h1 class="section-title">ğŸŒ³ Ramas</h1><p class="section-description">Cuentas / DinastÃ­as</p></div></div>
        <div class="toolbar"><div class="search-box"><span>ğŸ”</span><input type="text" class="search-input" placeholder="Buscar..."></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Rama</th><th>Admin</th><th>Nidos</th><th>Miembros</th><th>Plan</th><th>Creada</th><th></th></tr></thead><tbody id="tabla-ramas"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- ESTIRPES -->
      <section class="section" id="section-estirpes">
        <div class="section-header"><div><h1 class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Estirpes</h1><p class="section-description">Nidos + descendencia (excepto 1Âª gen)</p></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Estirpe</th><th>Rama</th><th>Nidos derivados</th><th>Generaciones</th><th>Miembros</th><th></th></tr></thead><tbody id="tabla-estirpes"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- NIDOS -->
      <section class="section" id="section-nidos">
        <div class="section-header"><div><h1 class="section-title">ğŸªº Nidos</h1></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Nido</th><th>Rama</th><th>Miembros</th><th>Admin</th><th>Gen</th><th></th></tr></thead><tbody id="tabla-nidos"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- USUARIOS -->
      <section class="section" id="section-usuarios">
        <div class="section-header"><div><h1 class="section-title">ğŸ‘¤ Usuarios</h1></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Usuario</th><th>Rama</th><th>Nido</th><th>Rol</th><th>Estado</th><th></th></tr></thead><tbody id="tabla-usuarios"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- INVITACIONES -->
      <section class="section" id="section-invitaciones">
        <div class="section-header"><div><h1 class="section-title">âœ‰ï¸ Invitaciones</h1></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Email</th><th>Rama</th><th>Nido</th><th>Enviada</th><th>Estado</th><th></th></tr></thead><tbody id="tabla-invitaciones"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- PLANES -->
      <section class="section" id="section-planes">
        <div class="section-header"><div><h1 class="section-title">ğŸ’³ Planes</h1></div><button class="btn btn-primary" onclick="abrirModalPlan()">+ Nuevo</button></div>
        <div class="plan-grid" id="planes-grid"></div>
        <div class="divider"></div>
        <h3 style="font-size:0.9rem;color:var(--text-light);margin-bottom:12px;">Recargas</h3>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ–¼ï¸</span><span class="config-card-title">+ImÃ¡genes</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" value="1.99"> â‚¬</div><div class="config-item"><span class="config-item-label">Cantidad</span><input type="number" class="config-input" value="50"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ </span><span class="config-card-title">+Bienes</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" value="2.99"> â‚¬</div><div class="config-item"><span class="config-item-label">Cantidad</span><input type="number" class="config-input" value="5"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ”§</span><span class="config-card-title">+Herramientas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" value="0.99"> â‚¬</div><div class="config-item"><span class="config-item-label">Cantidad</span><input type="number" class="config-input" value="1"></div></div></div>
        </div>
      </section>

      <!-- ADD-ONS -->
      <section class="section" id="section-addons">
        <div class="section-header"><div><h1 class="section-title">âš¡ Add-ons</h1><p class="section-description">4 mÃ³dulos adicionales</p></div></div>
        <div class="stats-grid mb-2">
          <div class="stat-card"><div class="stat-icon" style="background:rgba(193,119,87,0.2)">ğŸŒ³</div><div><div class="stat-value" id="stat-addon-crearrama">-</div><div class="stat-label">Crear Rama</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(139,115,85,0.2)">ğŸ©</div><div><div class="stat-value" id="stat-addon-mayordomo">-</div><div class="stat-label">Mayordomo</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(74,85,104,0.2)">ğŸ¨</div><div><div class="stat-value" id="stat-addon-gerente">-</div><div class="stat-label">Gerente</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:rgba(107,142,35,0.2)">ğŸŒ¾</div><div><div class="stat-value" id="stat-addon-capataz">-</div><div class="stat-label">Capataz</div></div></div>
        </div>
        <div class="addon-grid">
          <div class="addon-card"><div class="addon-card-header crearrama"><span class="addon-icon">ğŸŒ³</span><div><div class="addon-name">Crear Rama</div><div class="addon-desc">Bifurcar nueva cuenta</div></div></div><div class="addon-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" value="9.99"> â‚¬/mes</div><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
          <div class="addon-card"><div class="addon-card-header mayordomo"><span class="addon-icon">ğŸ©</span><div><div class="addon-name">Mayordomo</div><div class="addon-desc">GestiÃ³n domÃ©stica</div></div></div><div class="addon-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" value="4.99"> â‚¬/mes</div><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
          <div class="addon-card"><div class="addon-card-header gerente"><span class="addon-icon">ğŸ¨</span><div><div class="addon-name">Gerente</div><div class="addon-desc">Alquiler turÃ­stico</div></div></div><div class="addon-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" value="9.99"> â‚¬/mes</div><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
          <div class="addon-card"><div class="addon-card-header capataz"><span class="addon-icon">ğŸŒ¾</span><div><div class="addon-name">Capataz</div><div class="addon-desc">GestiÃ³n rural</div></div></div><div class="addon-card-body"><div class="config-item"><span class="config-item-label">Precio</span><input type="number" class="config-input" value="9.99"> â‚¬/mes</div><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: LO COMÃšN -->
      <section class="section" id="section-cfg-locomun">
        <div class="section-header"><div><h1 class="section-title">ğŸ  Lo ComÃºn</h1><p class="section-description">Bienes compartidos</p></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“¦</span><span class="config-card-title">LÃ­mites bienes</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Free</span><input type="number" class="config-input" value="3"></div><div class="config-item"><span class="config-item-label">Plus</span><input type="number" class="config-input" value="10"></div><div class="config-item"><span class="config-item-label">Mega</span><input type="number" class="config-input" value="99"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ–¼ï¸</span><span class="config-card-title">ImÃ¡genes</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">MÃ¡x por bien</span><input type="number" class="config-input" value="10"></div><div class="config-item"><span class="config-item-label">TamaÃ±o (MB)</span><input type="number" class="config-input" value="5"></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: LEGADO -->
      <section class="section" id="section-cfg-legado">
        <div class="section-header"><div><h1 class="section-title">ğŸ“œ Legado</h1><p class="section-description">Herencia familiar por plan</p></div></div>
        <p class="text-muted mb-2" style="font-size:0.8rem;">ğŸ’¡ Si activas en Free, se incluye automÃ¡ticamente en Plus y Mega. LÃ­mites = elementos mÃ¡ximos por rama.</p>
        
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“¸</span><span class="config-card-title">Fotos</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="10" title="Free" style="width:45px;"><input type="number" class="config-input" value="50" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Mega" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“–</span><span class="config-card-title">Historias</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="5" title="Free" style="width:45px;"><input type="number" class="config-input" value="20" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Mega" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ³</span><span class="config-card-title">Recetas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="5" title="Free" style="width:45px;"><input type="number" class="config-input" value="30" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Mega" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ˜‚</span><span class="config-card-title">AnÃ©cdotas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="5" title="Free" style="width:45px;"><input type="number" class="config-input" value="20" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Mega" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ­</span><span class="config-card-title">Tradiciones</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="0" title="Free" style="width:45px;"><input type="number" class="config-input" value="10" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Mega" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ’</span><span class="config-card-title">Valores</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="0" title="Free" style="width:45px;"><input type="number" class="config-input" value="10" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Mega" style="width:45px;"></div></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ’¡</span><span class="config-card-title">SabidurÃ­a</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div><div class="config-item" style="margin-top:8px;"><span class="config-item-label" style="font-size:0.7rem;">LÃ­mites</span><div style="display:flex;gap:6px;"><input type="number" class="config-input" value="0" title="Free" style="width:45px;"><input type="number" class="config-input" value="0" title="Plus" style="width:45px;"><input type="number" class="config-input" value="999" title="Mega" style="width:45px;"></div></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: CEREBRO -->
      <section class="section" id="section-cfg-cerebro">
        <div class="section-header"><div><h1 class="section-title">ğŸ§  Cerebro</h1><p class="section-description">Motores de organizaciÃ³n</p></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ’­</span><span class="config-card-title">Memoria</span><span class="badge badge-neutral" style="margin-left:auto;">PrÃ³ximamente</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Recuerdos, fechas, tradiciones</p></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">âš™ï¸</span><span class="config-card-title">Razonamiento</span><span class="badge badge-neutral" style="margin-left:auto;">PrÃ³ximamente</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Decisiones, consensos</p></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">âœ¨</span><span class="config-card-title">IntuiciÃ³n</span><span class="badge badge-neutral" style="margin-left:auto;">PrÃ³ximamente</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Sugerencias, alertas</p></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“Š</span><span class="config-card-title">AnÃ¡lisis</span><span class="badge badge-neutral" style="margin-left:auto;">PrÃ³ximamente</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">EstadÃ­sticas, informes</p></div></div>
        </div>
      </section>

      <!-- CFG: ACTIVACIÃ“N -->
      <section class="section" id="section-cfg-activacion">
        <div class="section-header"><div><h1 class="section-title">ğŸ¯ ActivaciÃ³n</h1><p class="section-description">Herramientas disponibles por plan</p></div></div>
        <p class="text-muted mb-2" style="font-size:0.8rem;">ğŸ’¡ Si activas en Free, se incluye automÃ¡ticamente en Plus y Mega. Si activas en Plus, se incluye en Mega.</p>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ’¬</span><span class="config-card-title">Chat</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“…</span><span class="config-card-title">Eventos/Calendario</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ</span><span class="config-card-title">Amigo Invisible</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“Š</span><span class="config-card-title">Encuestas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“¸</span><span class="config-card-title">GalerÃ­a</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ”„</span><span class="config-card-title">Turno</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ—³ï¸</span><span class="config-card-title">Votaciones</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“</span><span class="config-card-title">Listas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸª‘</span><span class="config-card-title">Colocar Mesas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“‹</span><span class="config-card-title">Escaleta</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox"> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“…</span><span class="config-card-title">Elegir Fechas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item" style="gap:12px;"><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Free</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Plus</label><label style="font-size:0.75rem;display:flex;align-items:center;gap:4px;"><input type="checkbox" checked> Mega</label></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: ÃRBOL -->
      <section class="section" id="section-cfg-arbol">
        <div class="section-header"><div><h1 class="section-title">ğŸŒ² Ãrbol</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“</span><span class="config-card-title">Generaciones</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Free</span><input type="number" class="config-input" value="2"></div><div class="config-item"><span class="config-item-label">Plus</span><input type="number" class="config-input" value="4"></div><div class="config-item"><span class="config-item-label">Mega</span><input type="number" class="config-input" value="99"></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: MI NIDO -->
      <section class="section" id="section-cfg-minido">
        <div class="section-header"><div><h1 class="section-title">ğŸª¹ Mi Nido</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ‘¤</span><span class="config-card-title">Perfil</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Foto</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item"><span class="config-item-label">Contacto</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item"><span class="config-item-label">Rasgos</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ¾</span><span class="config-card-title">Mascotas</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Permitir</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div><div class="config-item"><span class="config-item-label">MÃ¡ximo</span><input type="number" class="config-input" value="5"></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- CFG: VISIBILIDAD -->
      <section class="section" id="section-cfg-visibilidad">
        <div class="section-header"><div><h1 class="section-title">ğŸ‘ï¸ Visibilidad</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸŒ³</span><span class="config-card-title">Rama</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Toda la dinastÃ­a</p><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span class="config-card-title">Estirpe</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Descendencia</p><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸªº</span><span class="config-card-title">Nido</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;">Solo el hogar</p><div class="config-item"><span class="config-item-label">Activo</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div></div></div>
        </div>
        <div class="card mt-2"><div class="card-header"><span class="card-title">Apartados donde aplica</span></div><div class="card-body">
          <div class="config-item"><span class="config-item-label">Lo ComÃºn</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
          <div class="config-item"><span class="config-item-label">Legado</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
          <div class="config-item"><span class="config-item-label">ActivaciÃ³n</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
        </div></div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- ESTRUCTURA -->
      <section class="section" id="section-estructura">
        <div class="section-header"><div><h1 class="section-title">ğŸ—ï¸ Estructura</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">âœ‰ï¸</span><span class="config-card-title">Invitaciones</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">ExpiraciÃ³n (dÃ­as)</span><input type="number" class="config-input" value="7"></div><div class="config-item"><span class="config-item-label">ReenvÃ­os mÃ¡x</span><input type="number" class="config-input" value="3"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ§ª</span><span class="config-card-title">Trials</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">DÃ­as prueba</span><input type="number" class="config-input" value="14"></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- SERVICIOS -->
      <section class="section" id="section-servicios">
        <div class="section-header"><div><h1 class="section-title">ğŸ”Œ Servicios</h1></div></div>
        <div class="service-grid">
          <div class="service-card"><div class="service-header"><div class="service-logo" style="background:#FFCA28;">ğŸ”¥</div><div style="flex:1;"><div class="service-name">Firebase</div><div class="service-type">Auth + Firestore</div></div><span class="service-status activo">Activo</span></div><div class="service-body"><div class="service-field"><div class="service-field-label">Project</div><div class="service-field-value">familynk-dfadb</div></div></div><div class="service-footer"><a href="https://console.firebase.google.com" target="_blank" class="btn btn-sm btn-secondary">Abrir â†’</a></div></div>
          <div class="service-card"><div class="service-header"><div class="service-logo" style="background:#EA4335;">ğŸ“§</div><div style="flex:1;"><div class="service-name">EmailJS</div><div class="service-type">Emails</div></div><span class="service-status activo">Activo</span></div><div class="service-body"><div class="service-field"><div class="service-field-label">Service</div><div class="service-field-value">service_fcfx5od</div></div></div><div class="service-footer"><a href="https://dashboard.emailjs.com" target="_blank" class="btn btn-sm btn-secondary">Abrir â†’</a></div></div>
          <div class="service-card" style="opacity:0.6;"><div class="service-header"><div class="service-logo" style="background:#635BFF;color:white;">ğŸ’³</div><div style="flex:1;"><div class="service-name">Stripe</div><div class="service-type">Pagos</div></div><span class="service-status inactivo">Pendiente</span></div><div class="service-body text-center"><p class="text-muted">Configurar para pagos</p></div><div class="service-footer"><button class="btn btn-sm btn-primary">ğŸ”§ Configurar</button></div></div>
        </div>
      </section>

      <!-- NOTIFICACIONES -->
      <section class="section" id="section-notificaciones">
        <div class="section-header"><div><h1 class="section-title">ğŸ”” Notificaciones</h1></div></div>
        <div class="card"><div class="card-body">
          <div class="notif-item"><div><div class="notif-label">Nueva rama</div><div class="notif-desc">Cuando se crea una cuenta</div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
          <div class="notif-item"><div><div class="notif-label">Nuevo usuario</div><div class="notif-desc">Cuando aceptan invitaciÃ³n</div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
          <div class="notif-item"><div><div class="notif-label">Add-on activado</div><div class="notif-desc">MÃ³dulo de pago</div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
          <div class="notif-item"><div><div class="notif-label">Error sistema</div><div class="notif-desc">Alertas crÃ­ticas</div></div><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
        </div></div>
        <div class="mt-2"><button class="btn btn-primary">ğŸ’¾ Guardar</button></div>
      </section>

      <!-- BACKUP -->
      <section class="section" id="section-backup">
        <div class="section-header"><div><h1 class="section-title">ğŸ’¾ Backup</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“¤</span><span class="config-card-title">Exportar</span></div><div class="config-card-body"><button class="btn btn-secondary mb-2" style="width:100%;" onclick="exportarBackup('ramas')">ğŸŒ³ Ramas</button><button class="btn btn-secondary mb-2" style="width:100%;" onclick="exportarBackup('usuarios')">ğŸ‘¤ Usuarios</button><button class="btn btn-success" style="width:100%;" onclick="exportarBackup('todo')">ğŸ“¦ Todo</button></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“¥</span><span class="config-card-title">Restaurar</span></div><div class="config-card-body"><div class="form-group"><input type="file" class="form-input" accept=".json"></div><button class="btn btn-warning" style="width:100%;">âš ï¸ Restaurar</button></div></div>
        </div>
      </section>

      <!-- LEGAL -->
      <section class="section" id="section-legal">
        <div class="section-header"><div><h1 class="section-title">âš–ï¸ Legal</h1></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“‹</span><span class="config-card-title">TÃ©rminos y Condiciones</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;margin-bottom:8px;">Ãšltima: <span id="tc-fecha">-</span></p><div class="form-group"><textarea class="form-textarea" id="tc-contenido" rows="6"></textarea></div><button class="btn btn-primary" onclick="guardarTerminos()">ğŸ’¾ Guardar</button><a href="terminos.html" target="_blank" class="btn btn-secondary" style="margin-left:8px;">ğŸ‘ï¸</a></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ”’</span><span class="config-card-title">Privacidad</span></div><div class="config-card-body"><p class="text-muted" style="font-size:0.8rem;margin-bottom:8px;">Ãšltima: <span id="pp-fecha">-</span></p><div class="form-group"><textarea class="form-textarea" id="pp-contenido" rows="6"></textarea></div><button class="btn btn-primary" onclick="guardarPrivacidad()">ğŸ’¾ Guardar</button><a href="privacidad.html" target="_blank" class="btn btn-secondary" style="margin-left:8px;">ğŸ‘ï¸</a></div></div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL PLAN -->
  <div class="modal-overlay" id="modal-plan">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">ğŸ’³ Plan</h3><button class="modal-close" onclick="cerrarModales()">Ã—</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Nombre</label><input type="text" class="form-input" id="plan-nombre"></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Precio (â‚¬/mes)</label><input type="number" class="form-input" id="plan-precio" step="0.01"></div><div class="form-group"><label class="form-label">Icono</label><input type="text" class="form-input" id="plan-icono" placeholder="ğŸŒŸ"></div></div>
        <div class="form-group"><label class="form-label">CaracterÃ­sticas</label><textarea class="form-textarea" id="plan-features" rows="4"></textarea></div>
        <div class="form-group"><label class="form-check"><input type="checkbox" id="plan-activo" checked> Activo</label></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button><button class="btn btn-primary" onclick="guardarPlan()">Guardar</button></div>
    </div>
  </div>

  <!-- MODAL FICHA RAMA -->
  <div class="modal-overlay" id="modal-rama">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header"><h3 class="modal-title">ğŸŒ³ Ficha de Rama</h3><button class="modal-close" onclick="cerrarModales()">Ã—</button></div>
      <div class="modal-body">
        <input type="hidden" id="rama-id">
        
        <!-- Info bÃ¡sica -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
          <div><div class="text-muted" style="font-size:0.7rem;">Nombre</div><div id="rama-nombre" style="font-weight:700;font-size:1.1rem;">-</div></div>
          <div><div class="text-muted" style="font-size:0.7rem;">Admin</div><div id="rama-admin">-</div></div>
          <div><div class="text-muted" style="font-size:0.7rem;">Nidos</div><div id="rama-nidos">-</div></div>
          <div><div class="text-muted" style="font-size:0.7rem;">Miembros</div><div id="rama-miembros">-</div></div>
          <div><div class="text-muted" style="font-size:0.7rem;">Creada</div><div id="rama-fecha">-</div></div>
          <div><div class="text-muted" style="font-size:0.7rem;">Plan actual</div><div id="rama-plan-actual">-</div></div>
        </div>

        <div class="divider"></div>

        <!-- Descuento en Plan -->
        <div class="form-group">
          <label class="form-label">ğŸ·ï¸ Descuento en Plan</label>
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--cream);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-plan" value="0" checked> Sin descuento
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(66,153,225,0.1);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-plan" value="30"> Promo <span class="badge badge-info">30%</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(236,201,75,0.1);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-plan" value="50"> Cercanos <span class="badge badge-warning">50%</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(72,187,120,0.1);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-plan" value="100"> Gratis <span class="badge badge-success">100%</span>
            </label>
          </div>
        </div>

        <!-- Descuento en Add-ons -->
        <div class="form-group">
          <label class="form-label">ğŸ§© Descuento en Add-ons</label>
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--cream);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-addon" value="0" checked> Sin descuento
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(66,153,225,0.1);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-addon" value="30"> Promo <span class="badge badge-info">30%</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(236,201,75,0.1);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-addon" value="50"> Cercanos <span class="badge badge-warning">50%</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:rgba(72,187,120,0.1);border-radius:var(--radius-md);cursor:pointer;">
              <input type="radio" name="descuento-addon" value="100"> Gratis <span class="badge badge-success">100%</span>
            </label>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Add-ons activos -->
        <div class="form-group">
          <label class="form-label">ğŸ§© Add-ons activos</label>
          <div id="rama-addons" style="display:flex;gap:8px;flex-wrap:wrap;">-</div>
        </div>

        <!-- Notas admin -->
        <div class="form-group">
          <label class="form-label">ğŸ“ Notas internas</label>
          <textarea class="form-textarea" id="rama-notas" rows="2" placeholder="Notas visibles solo para AdminSistema..."></textarea>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button><button class="btn btn-primary" onclick="guardarRama()">ğŸ’¾ Guardar</button></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script>
    let currentUser=null,userData=null,ramasData=[],nidosData=[],usuariosData=[],logsData=[],planesData=[];
    // Estirpe = Nido gen 2 (abuelos) con descendientes que tienen nidos propios
    function calcularEstirpes(nidos){
      const gen2=nidos.filter(n=>n.generacion==='2-abuelos'||n.generacion===2||n.generacion==='2');
      const estirpes=gen2.filter(abuelo=>{
        // Buscar si hay nidos que tengan nidoOrigen apuntando a este abuelo
        return nidos.some(n=>n.nidoOrigen===abuelo.id);
      });
      return estirpes;
    }
    auth.onAuthStateChanged(async user=>{if(!user){window.location.href='login.html';return}currentUser=user;const doc=await db.collection('usuarios').doc(user.uid).get();if(!doc.exists||(doc.data().rol!=='AdminSistema'&&!doc.data().superAdmin)){alert('Acceso denegado');window.location.href='login.html';return}userData=doc.data();document.getElementById('user-name').textContent=(userData.nombre||'Admin').split(' ')[0];document.getElementById('user-avatar').textContent=(userData.nombre||'A').charAt(0).toUpperCase();cargarDashboard()});
    function cerrarSesion(){auth.signOut().then(()=>window.location.href='login.html')}
    function cambiarSeccion(s){document.querySelectorAll('.sidebar-link').forEach(l=>l.classList.toggle('active',l.dataset.section===s));document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));document.getElementById(`section-${s}`).classList.add('active');const m={dashboard:cargarDashboard,logs:cargarLogs,ramas:cargarRamas,estirpes:cargarEstirpes,nidos:cargarNidos,usuarios:cargarUsuarios,invitaciones:cargarInvitaciones,planes:cargarPlanes,addons:cargarAddons,legal:cargarLegal};if(m[s])m[s]()}
    async function cargarDashboard(){try{const[rS,nS,uS,bS]=await Promise.all([db.collection('familias').get(),db.collection('nidos').get(),db.collection('usuarios').get(),db.collectionGroup('bienes').get()]);ramasData=rS.docs.map(d=>({id:d.id,...d.data()}));nidosData=nS.docs.map(d=>({id:d.id,...d.data()}));usuariosData=uS.docs.map(d=>({id:d.id,...d.data()}));document.getElementById('stat-ramas').textContent=ramasData.length;const estirpes=calcularEstirpes(nidosData);document.getElementById('stat-estirpes').textContent=estirpes.length;document.getElementById('stat-nidos').textContent=nidosData.length;document.getElementById('stat-usuarios').textContent=usuariosData.length;document.getElementById('stat-bienes').textContent=bS.size;let a=0;ramasData.forEach(r=>{if(r.addons)a+=Object.values(r.addons).filter(v=>v===true).length});document.getElementById('stat-addons').textContent=a;document.getElementById('ultimas-ramas').innerHTML=ramasData.slice(0,5).map(r=>`<div class="log-entry"><span class="log-icon">ğŸŒ³</span><div class="log-content"><span class="log-user">${r.nombre||'-'}</span></div><span class="log-time">${r.fechaCreacion?.toDate?.().toLocaleDateString('es')||'-'}</span></div>`).join('')||'<p class="empty-state">Sin ramas</p>';const lS=await db.collection('logs').orderBy('fecha','desc').limit(10).get();document.getElementById('actividad-reciente').innerHTML=lS.docs.map(d=>{const l=d.data();return`<div class="log-entry"><span class="log-icon">ğŸ“‹</span><div class="log-content"><span class="log-user">${l.usuario||'Sistema'}</span> <span class="log-action">${l.accion||''}</span></div><span class="log-time">${l.fecha?.toDate?.().toLocaleString('es')||'-'}</span></div>`}).join('')||'<p class="empty-state">Sin actividad</p>'}catch(e){console.error(e)}}
    async function cargarLogs(){const s=await db.collection('logs').orderBy('fecha','desc').limit(100).get();logsData=s.docs.map(d=>({id:d.id,...d.data()}));document.getElementById('logs-lista').innerHTML=logsData.map(l=>`<div class="log-entry"><span class="log-time">${l.fecha?.toDate?.().toLocaleString('es')||'-'}</span><span class="log-icon">ğŸ“‹</span><div class="log-content"><span class="log-user">${l.usuario||'Sistema'}</span> <span class="log-action">${l.accion||''}</span></div></div>`).join('')||'<p class="empty-state">Sin logs</p>'}
    function exportarLogs(){const c='Fecha,Usuario,AcciÃ³n\n'+logsData.map(l=>`"${l.fecha?.toDate?.().toISOString()||''}","${l.usuario||''}","${l.accion||''}"`).join('\n');descargar(c,'logs.csv','text/csv')}
    async function cargarRamas(){const s=await db.collection('familias').get();ramasData=s.docs.map(d=>({id:d.id,...d.data()}));document.getElementById('tabla-ramas').innerHTML=ramasData.map(r=>`<tr><td><strong>${r.nombre||'-'}</strong></td><td>${r.adminNombre||'-'}</td><td>${r.totalNidos||0}</td><td>${r.totalMiembros||0}</td><td><span class="badge badge-${r.plan==='mega'?'warning':r.plan==='plus'?'info':'neutral'}">${r.plan||'Free'}</span>${r.descuentoPlan?` <span class="badge badge-success">-${r.descuentoPlan}%</span>`:''}</td><td>${r.fechaCreacion?.toDate?.().toLocaleDateString('es')||'-'}</td><td><button class="btn btn-sm btn-secondary" onclick="verRama('${r.id}')">ğŸ‘ï¸</button></td></tr>`).join('')||'<tr><td colspan="7" class="text-center">Sin datos</td></tr>'}
    async function cargarEstirpes(){const s=await db.collection('nidos').get();nidosData=s.docs.map(x=>({id:x.id,...x.data()}));const estirpes=calcularEstirpes(nidosData);document.getElementById('tabla-estirpes').innerHTML=estirpes.map(e=>{const nidosHijos=nidosData.filter(n=>n.nidoOrigen===e.id).length;return`<tr><td><strong>${e.nombre||'-'}</strong></td><td>${e.ramaNombre||'-'}</td><td>${nidosHijos}</td><td>${e.generacion||'-'}</td><td>${e.miembros?.length||e.miembrosData?.length||0}</td><td><button class="btn btn-sm btn-secondary">ğŸ‘ï¸</button></td></tr>`}).join('')||'<tr><td colspan="6" class="text-center">Sin estirpes</td></tr>'}
    async function cargarNidos(){const s=await db.collection('nidos').get();nidosData=s.docs.map(d=>({id:d.id,...d.data()}));document.getElementById('tabla-nidos').innerHTML=nidosData.map(n=>`<tr><td><strong>${n.nombre||'-'}</strong></td><td>${n.ramaNombre||'-'}</td><td>${n.miembros?.length||0}</td><td>${n.adminNombre||'-'}</td><td>${n.generacion||1}</td><td><button class="btn btn-sm btn-secondary">ğŸ‘ï¸</button></td></tr>`).join('')||'<tr><td colspan="6" class="text-center">Sin datos</td></tr>'}
    async function cargarUsuarios(){const s=await db.collection('usuarios').get();usuariosData=s.docs.map(d=>({id:d.id,...d.data()}));document.getElementById('tabla-usuarios').innerHTML=usuariosData.map(u=>`<tr><td><strong>${u.nombre||u.email||'-'}</strong></td><td>${u.ramaNombre||'-'}</td><td>${u.nidoNombre||'-'}</td><td><span class="badge badge-neutral">${u.rol||'Miembro'}</span></td><td><span class="badge ${u.primerAcceso?'badge-warning':'badge-success'}">${u.primerAcceso?'Invitado':'Activo'}</span></td><td><button class="btn btn-sm btn-secondary">ğŸ‘ï¸</button></td></tr>`).join('')||'<tr><td colspan="6" class="text-center">Sin datos</td></tr>'}
    async function cargarInvitaciones(){const s=await db.collection('invitaciones-email').orderBy('fechaEnvio','desc').limit(100).get();const d=s.docs.map(x=>({id:x.id,...x.data()}));document.getElementById('tabla-invitaciones').innerHTML=d.map(i=>`<tr><td>${i.email||'-'}</td><td>${i.ramaNombre||'-'}</td><td>${i.nidoNombre||'-'}</td><td>${i.fechaEnvio?.toDate?.().toLocaleDateString('es')||'-'}</td><td><span class="badge ${i.estado==='aceptada'?'badge-success':i.estado==='expirada'?'badge-error':'badge-warning'}">${i.estado||'pendiente'}</span></td><td><button class="btn btn-sm btn-secondary">ğŸ”„</button></td></tr>`).join('')||'<tr><td colspan="6" class="text-center">Sin datos</td></tr>'}
    async function cargarPlanes(){try{const s=await db.collection('config').doc('planes').get();planesData=s.exists?s.data().lista||[]:[{id:'free',nombre:'Free',precio:0,icono:'ğŸ†“',features:['2 generaciones','3 bienes'],activo:true},{id:'plus',nombre:'Plus',precio:4.99,icono:'â­',features:['4 generaciones','10 bienes'],activo:true},{id:'mega',nombre:'Mega',precio:9.99,icono:'ğŸ‘‘',features:['Ilimitado'],activo:true}];renderPlanes()}catch(e){console.error(e)}}
    function renderPlanes(){document.getElementById('planes-grid').innerHTML=planesData.map(p=>`<div class="plan-card"><div class="plan-card-header ${p.id}"><div class="plan-icon">${p.icono||'ğŸ“¦'}</div><div class="plan-name">${p.nombre}</div><div class="plan-price">${p.precio}â‚¬ <span>/mes</span></div></div><div class="plan-card-body">${(p.features||[]).map(f=>`<div class="plan-feature"><span class="plan-feature-icon">âœ“</span>${f}</div>`).join('')}</div><div class="plan-card-footer"><span class="badge ${p.activo?'badge-success':'badge-neutral'}">${p.activo?'Activo':'Inactivo'}</span><button class="btn btn-sm btn-secondary" onclick="editarPlan('${p.id}')">âœï¸</button></div></div>`).join('')}
    function abrirModalPlan(){document.getElementById('modal-plan').classList.add('active')}
    function editarPlan(id){const p=planesData.find(x=>x.id===id);if(!p)return;document.getElementById('plan-nombre').value=p.nombre||'';document.getElementById('plan-precio').value=p.precio||0;document.getElementById('plan-icono').value=p.icono||'';document.getElementById('plan-features').value=(p.features||[]).join('\n');document.getElementById('plan-activo').checked=p.activo!==false;abrirModalPlan()}
    async function guardarPlan(){alert('Guardado (pendiente implementaciÃ³n)');cerrarModales()}
    async function cargarAddons(){let c=0,m=0,g=0,cp=0;ramasData.forEach(r=>{if(r.addons){if(r.addons.crearRama)c++;if(r.addons.mayordomo)m++;if(r.addons.gerente)g++;if(r.addons.capataz)cp++}});document.getElementById('stat-addon-crearrama').textContent=c;document.getElementById('stat-addon-mayordomo').textContent=m;document.getElementById('stat-addon-gerente').textContent=g;document.getElementById('stat-addon-capataz').textContent=cp}
    async function cargarLegal(){try{const tc=await db.collection('config').doc('terminos').get();if(tc.exists){document.getElementById('tc-contenido').value=tc.data().contenido||'';document.getElementById('tc-fecha').textContent=tc.data().fechaActualizacion?.toDate?.().toLocaleDateString('es')||'-'}const pp=await db.collection('config').doc('privacidad').get();if(pp.exists){document.getElementById('pp-contenido').value=pp.data().contenido||'';document.getElementById('pp-fecha').textContent=pp.data().fechaActualizacion?.toDate?.().toLocaleDateString('es')||'-'}}catch(e){console.error(e)}}
    async function guardarTerminos(){const c=document.getElementById('tc-contenido').value;if(!c.trim())return alert('Contenido requerido');try{await db.collection('config').doc('terminos').set({contenido:c,fechaActualizacion:firebase.firestore.FieldValue.serverTimestamp()});document.getElementById('tc-fecha').textContent=new Date().toLocaleDateString('es');alert('âœ… Guardado')}catch(e){alert('Error: '+e.message)}}
    async function guardarPrivacidad(){const c=document.getElementById('pp-contenido').value;if(!c.trim())return alert('Contenido requerido');try{await db.collection('config').doc('privacidad').set({contenido:c,fechaActualizacion:firebase.firestore.FieldValue.serverTimestamp()});document.getElementById('pp-fecha').textContent=new Date().toLocaleDateString('es');alert('âœ… Guardado')}catch(e){alert('Error: '+e.message)}}
    async function exportarBackup(t){try{let d={};if(t==='ramas'||t==='todo')d.ramas=ramasData;if(t==='usuarios'||t==='todo')d.usuarios=usuariosData;if(t==='nidos'||t==='todo')d.nidos=nidosData;descargar(JSON.stringify(d,null,2),`familynk_${t}_${new Date().toISOString().split('T')[0]}.json`,'application/json')}catch(e){alert('Error: '+e.message)}}
    function descargar(c,n,t){const b=new Blob([c],{type:t});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click()}
    function verRama(id){
      const r=ramasData.find(x=>x.id===id);
      if(!r)return;
      document.getElementById('rama-id').value=id;
      document.getElementById('rama-nombre').textContent=r.nombre||'-';
      document.getElementById('rama-admin').textContent=r.adminNombre||r.adminEmail||'-';
      document.getElementById('rama-nidos').textContent=r.totalNidos||0;
      document.getElementById('rama-miembros').textContent=r.totalMiembros||0;
      document.getElementById('rama-fecha').textContent=r.fechaCreacion?.toDate?.().toLocaleDateString('es')||'-';
      document.getElementById('rama-plan-actual').innerHTML=`<span class="badge badge-${r.plan==='mega'?'warning':r.plan==='plus'?'info':'neutral'}">${r.plan||'Free'}</span>`;
      document.getElementById('rama-notas').value=r.notasAdmin||'';
      // Descuentos
      document.querySelectorAll('input[name="descuento-plan"]').forEach(i=>i.checked=(parseInt(i.value)===(r.descuentoPlan||0)));
      document.querySelectorAll('input[name="descuento-addon"]').forEach(i=>i.checked=(parseInt(i.value)===(r.descuentoAddon||0)));
      // Add-ons
      const addons=r.addons||{};
      const addonsList=[];
      if(addons.crearRama)addonsList.push('<span class="badge badge-info">ğŸŒ³ Crear Rama</span>');
      if(addons.mayordomo)addonsList.push('<span class="badge badge-info">ğŸ¡ Mayordomo</span>');
      if(addons.gerente)addonsList.push('<span class="badge badge-info">ğŸ¨ Gerente</span>');
      if(addons.capataz)addonsList.push('<span class="badge badge-info">ğŸŒ¾ Capataz</span>');
      document.getElementById('rama-addons').innerHTML=addonsList.length?addonsList.join(' '):'<span class="text-muted">Ninguno</span>';
      document.getElementById('modal-rama').classList.add('active');
    }
    async function guardarRama(){
      const id=document.getElementById('rama-id').value;
      if(!id)return;
      const descuentoPlan=parseInt(document.querySelector('input[name="descuento-plan"]:checked').value)||0;
      const descuentoAddon=parseInt(document.querySelector('input[name="descuento-addon"]:checked').value)||0;
      const notasAdmin=document.getElementById('rama-notas').value.trim();
      try{
        await db.collection('familias').doc(id).update({
          descuentoPlan:descuentoPlan,
          descuentoAddon:descuentoAddon,
          notasAdmin:notasAdmin,
          ultimaModificacionAdmin:firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('âœ… Rama actualizada');
        cerrarModales();
        cargarRamas();
      }catch(e){alert('Error: '+e.message);}
    }
    function cerrarModales(){document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active'))}
    document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)cerrarModales()})});
  </script>
</body>
</html>
