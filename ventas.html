<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Ventas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --gerente: #2D4A5C;
      --gerente-light: #4A6B7C;
      --gerente-dark: #1D3544;
      --gerente-muted: rgba(45, 74, 92, 0.12);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --gold: #B8965C;
      --gold-muted: rgba(184, 150, 92, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* ===== HEADER ===== */
    .header {
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      padding: 14px 24px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-medium); position: sticky; top: 0; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      display: flex; align-items: center; gap: 6px; padding: 8px 14px;
      background: rgba(255,255,255,0.15); border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem;
      color: white; cursor: pointer; text-decoration: none; transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.25); }
    .header-title { display: flex; align-items: center; gap: 12px; color: white; }
    .header-icon {
      width: 40px; height: 40px; background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md); display: flex; align-items: center;
      justify-content: center; font-size: 1.3rem;
    }
    .header-info h1 { font-family: 'Quicksand', sans-serif; font-size: 1.15rem; font-weight: 700; }
    .header-info p { font-size: 0.8rem; opacity: 0.85; }

    /* ===== MAIN ===== */
    .main { max-width: 1000px; margin: 0 auto; padding: 24px 20px; }

    /* ===== TABS ===== */
    .tabs {
      display: flex; gap: 4px; margin-bottom: 24px;
      background: var(--cream-dark); border-radius: var(--radius-md); padding: 4px;
    }
    .tab {
      flex: 1; padding: 10px 12px; border: none; border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 600;
      background: transparent; color: var(--text-light); cursor: pointer; transition: all 0.2s;
      text-align: center;
    }
    .tab:hover { color: var(--text); }
    .tab.active { background: var(--gerente); color: white; box-shadow: var(--shadow-soft); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ===== CARDS ===== */
    .card {
      background: var(--white); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft); padding: 20px; margin-bottom: 20px;
    }
    .card-title {
      font-family: 'Quicksand', sans-serif; font-weight: 700;
      font-size: 1rem; margin-bottom: 16px; display: flex;
      align-items: center; gap: 8px;
    }

    /* ===== CONFIG SERIE ===== */
    .config-serie {
      display: flex; align-items: flex-end; gap: 12px; padding: 14px;
      background: var(--cream); border-radius: var(--radius-sm); margin-bottom: 20px;
    }
    .serie-preview {
      padding: 8px 16px; background: var(--gerente-muted); border-radius: var(--radius-sm);
      font-weight: 700; font-size: 0.95rem; color: var(--gerente); white-space: nowrap;
    }

    /* ===== FACTURA CARD ===== */
    .factura-card {
      background: var(--white); border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md); padding: 14px; margin-bottom: 10px;
      cursor: pointer; transition: all 0.2s; border-left: 4px solid var(--cream-dark);
    }
    .factura-card:hover { box-shadow: var(--shadow-medium); }
    .factura-card.emitida { border-left-color: var(--success); }
    .factura-card.pendiente { border-left-color: var(--warning); }
    .factura-card.anulada { border-left-color: var(--error); }
    .factura-top {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;
    }
    .factura-numero { font-weight: 700; font-size: 0.95rem; color: var(--gerente); }
    .factura-total { font-weight: 700; font-size: 1.05rem; }
    .factura-meta {
      display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.8rem; color: var(--text-light);
    }
    .estado-badge {
      display: inline-block; padding: 2px 10px; border-radius: 20px;
      font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px;
    }
    .estado-badge.emitida { background: var(--success); color: white; }
    .estado-badge.pendiente { background: var(--warning); color: white; }
    .estado-badge.anulada { background: var(--error); color: white; }
    .estado-badge.cobrada { background: var(--gerente); color: white; }

    /* ===== L√çNEAS FACTURA ===== */
    .linea-fact {
      display: grid; grid-template-columns: 1fr 55px 75px 55px 80px 30px;
      gap: 6px; align-items: center; padding: 6px 0;
      border-bottom: 1px solid var(--cream-dark); font-size: 0.85rem;
    }
    .linea-fact:last-child { border-bottom: none; }
    .linea-fact-header {
      display: grid; grid-template-columns: 1fr 55px 75px 55px 80px 30px;
      gap: 6px; font-size: 0.7rem; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px; padding-bottom: 6px;
      border-bottom: 2px solid var(--cream-dark); font-weight: 600;
    }
    .fact-totales { margin-top: 12px; border-top: 2px solid var(--gerente-muted); padding-top: 10px; }
    .fact-total-row {
      display: flex; justify-content: flex-end; gap: 40px; padding: 3px 0; font-size: 0.9rem;
    }
    .fact-total-row.grande { font-size: 1.15rem; font-weight: 700; color: var(--gerente); border-top: 2px solid var(--gerente); padding-top: 8px; margin-top: 6px; }
    .fact-total-row .label { color: var(--text-light); min-width: 100px; text-align: right; }

    /* ===== INFORME ===== */
    .filtros-informe {
      display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;
    }
    .filtros-informe .form-group { flex: 1; min-width: 140px; }
    .comparar-toggle {
      display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
    }
    .toggle-switch { position: relative; width: 36px; height: 20px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; inset: 0; background: var(--cream-dark);
      border-radius: 20px; cursor: pointer; transition: 0.3s;
    }
    .toggle-slider::before {
      content: ''; position: absolute; width: 16px; height: 16px;
      left: 2px; bottom: 2px; background: white; border-radius: 50%;
      transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch input:checked + .toggle-slider { background: var(--gerente); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(16px); }

    .tabla-informe {
      width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem;
    }
    .tabla-informe th {
      padding: 8px 10px; font-size: 0.72rem; text-align: right;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 2px solid var(--cream-dark); font-weight: 600;
    }
    .tabla-informe th:first-child { text-align: left; }
    .tabla-informe td {
      padding: 8px 10px; border-bottom: 1px solid var(--cream-dark);
      text-align: right; vertical-align: middle;
    }
    .tabla-informe td:first-child { text-align: left; font-weight: 600; }
    .tabla-informe tr:last-child td { border-bottom: none; }
    .tabla-informe tr:hover td { background: var(--cream); }
    .fila-grupo td { background: var(--gerente-muted) !important; font-weight: 700 !important; }
    .fila-total td { background: var(--gerente) !important; color: white !important; font-weight: 700 !important; font-size: 0.95rem; }
    .variacion { font-size: 0.75rem; font-weight: 700; }
    .variacion.positiva { color: var(--success); }
    .variacion.negativa { color: var(--error); }

    /* KPIs */
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .kpi {
      background: var(--white); border-radius: var(--radius-md); padding: 16px;
      text-align: center; box-shadow: var(--shadow-soft);
    }
    .kpi-valor { font-size: 1.4rem; font-weight: 700; color: var(--gerente); }
    .kpi-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

    /* ===== BOTONES ===== */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; border: none; border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; text-decoration: none;
    }
    .btn-gerente { background: var(--gerente); color: white; }
    .btn-gerente:hover { background: var(--gerente-dark); }
    .btn-sm { padding: 5px 12px; font-size: 0.8rem; }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-secondary:hover { background: #ede5db; }
    .btn-danger { background: var(--error); color: white; }
    .btn-icon {
      width: 28px; height: 28px; border-radius: 6px; border: none;
      background: transparent; cursor: pointer; font-size: 0.9rem;
      display: flex; align-items: center; justify-content: center; transition: background 0.2s;
    }
    .btn-icon:hover { background: var(--cream-dark); }
    .btn-icon.danger:hover { background: rgba(212, 105, 90, 0.15); }

    /* ===== MODAL ===== */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      z-index: 200; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--white); border-radius: var(--radius-lg);
      width: 100%; max-width: 680px; max-height: 90vh; overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    .modal-header {
      padding: 16px 20px; background: var(--gerente); color: white;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-header h3 { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1rem; }
    .modal-close {
      background: rgba(255,255,255,0.2); border: none; color: white;
      width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
      font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
    }
    .modal-body { padding: 20px; }
    .modal-footer {
      padding: 12px 20px; border-top: 1px solid var(--cream-dark);
      display: flex; justify-content: flex-end; gap: 8px;
    }
    .form-group { margin-bottom: 14px; }
    .form-label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: var(--text-light); }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 9px 12px; border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm); font-family: 'Nunito', sans-serif;
      font-size: 0.88rem; transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--gerente); outline: none; }
    .form-textarea { resize: vertical; min-height: 60px; }
    .form-row { display: flex; gap: 12px; }
    .form-row > .form-group { flex: 1; }
    .input-sm { padding: 6px 8px; font-size: 0.82rem; text-align: right; width: 100%; }

    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state-icon { font-size: 2.5rem; margin-bottom: 12px; }
    .empty-state-title { font-weight: 700; font-size: 1rem; margin-bottom: 6px; color: var(--text-light); }
    .empty-state-text { font-size: 0.85rem; margin-bottom: 16px; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 640px) {
      .tabs { flex-direction: column; }
      .linea-fact, .linea-fact-header { grid-template-columns: 1fr 45px 65px 45px 70px 28px; font-size: 0.78rem; }
      .filtros-informe { flex-direction: column; }
      .form-row { flex-direction: column; gap: 0; }
      .config-serie { flex-direction: column; align-items: stretch; }
      .kpis { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="gerente.html" class="back-btn" id="btn-volver">‚Üê Gerente</a>
      <div class="header-title">
        <div class="header-icon">üí∞</div>
        <div class="header-info">
          <h1>Ventas</h1>
          <p id="bien-nombre">Cargando...</p>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <div class="tabs">
      <button class="tab active" onclick="cambiarTab('facturacion')">üßæ Facturaci√≥n</button>
      <button class="tab" onclick="cambiarTab('informe')">üìä Informe ventas</button>
    </div>

    <!-- ==================== TAB 1: FACTURACI√ìN ==================== -->
    <div class="tab-content active" id="tab-facturacion">
      <!-- Config serie -->
      <div class="card">
        <div class="card-title">‚öôÔ∏è Serie de facturaci√≥n</div>
        <div class="config-serie">
          <div class="form-group" style="margin:0;flex:0 0 120px;">
            <label class="form-label">Prefijo</label>
            <input type="text" class="form-input" id="serie-prefijo" value="FLK" placeholder="FLK" onchange="guardarConfigSerie()" oninput="actualizarPreviewSerie()">
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="font-size:0.85rem;color:var(--text-muted);">Vista previa:</span>
            <span class="serie-preview" id="serie-preview">FLK-2026-0001</span>
          </div>
        </div>
      </div>

      <!-- Condiciones de pago -->
      <div class="card">
        <div class="card-title">üí≥ Condiciones de pago
          <span style="flex:1;"></span>
          <button class="btn btn-gerente btn-sm" onclick="guardarCondiciones()">üíæ Guardar</button>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Forma de pago</label>
            <input type="text" class="form-input" id="cond-forma" placeholder="Transferencia bancaria">
          </div>
          <div class="form-group">
            <label class="form-label">Cuenta / IBAN</label>
            <input type="text" class="form-input" id="cond-cuenta" placeholder="ES00 0000 0000 0000 0000 0000">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notas legales / condiciones</label>
          <textarea class="form-textarea" id="cond-notas" rows="2" placeholder="Vencimiento, penalizaciones, notas fiscales..."></textarea>
        </div>
      </div>

      <!-- Listado facturas -->
      <div class="card">
        <div class="card-title">üßæ Facturas
          <span style="flex:1;"></span>
          <button class="btn btn-gerente btn-sm" onclick="abrirModalFactura()">+ Nueva factura</button>
        </div>
        <div id="facturas-container">
          <div class="empty-state" id="empty-facturas">
            <div class="empty-state-icon">üßæ</div>
            <div class="empty-state-title">Sin facturas emitidas</div>
            <div class="empty-state-text">Crea tu primera factura</div>
            <button class="btn btn-gerente" onclick="abrirModalFactura()">+ Nueva factura</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 2: INFORME VENTAS ==================== -->
    <div class="tab-content" id="tab-informe">
      <div class="card">
        <div class="card-title">üìä Informe de ventas</div>

        <!-- Filtros -->
        <div class="filtros-informe">
          <div class="form-group">
            <label class="form-label">Per√≠odo</label>
            <select class="form-select" id="inf-periodo" onchange="generarInforme()">
              <option value="mes">Mensual</option>
              <option value="trimestre">Trimestral</option>
              <option value="anual" selected>Anual</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">A√±o</label>
            <select class="form-select" id="inf-anio" onchange="generarInforme()"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Cliente</label>
            <select class="form-select" id="inf-cliente" onchange="generarInforme()">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Grupo</label>
            <select class="form-select" id="inf-grupo" onchange="generarInforme()">
              <option value="">Todos</option>
              <option value="alojamiento">üè† Alojamiento</option>
              <option value="manutencion">üçΩÔ∏è Manutenci√≥n</option>
              <option value="actividades">üéØ Actividades</option>
              <option value="extras">‚ú® Extras</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Servicio</label>
            <select class="form-select" id="inf-servicio" onchange="generarInforme()">
              <option value="">Todos</option>
            </select>
          </div>
        </div>

        <!-- Comparar ejercicios -->
        <div class="comparar-toggle">
          <label class="toggle-switch">
            <input type="checkbox" id="inf-comparar" onchange="toggleComparar()">
            <span class="toggle-slider"></span>
          </label>
          <span style="font-size:0.85rem;font-weight:600;">Comparar con ejercicio anterior</span>
          <select class="form-select" id="inf-anio-comp" style="width:100px;display:none;" onchange="generarInforme()"></select>
        </div>
      </div>

      <!-- KPIs -->
      <div class="kpis" id="kpis-container">
        <div class="kpi"><div class="kpi-valor" id="kpi-facturas">0</div><div class="kpi-label">Facturas</div></div>
        <div class="kpi"><div class="kpi-valor" id="kpi-base">0 ‚Ç¨</div><div class="kpi-label">Base imponible</div></div>
        <div class="kpi"><div class="kpi-valor" id="kpi-iva">0 ‚Ç¨</div><div class="kpi-label">IVA repercutido</div></div>
        <div class="kpi"><div class="kpi-valor" id="kpi-total">0 ‚Ç¨</div><div class="kpi-label">Total facturado</div></div>
      </div>

      <!-- Tabla informe -->
      <div class="card">
        <div id="informe-container">
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-title">Genera un informe</div>
            <div class="empty-state-text">Selecciona los filtros para ver el desglose de ventas</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== MODAL FACTURA ===== -->
  <div class="modal-overlay" id="modal-factura">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-fact-titulo">Nueva factura</h3>
        <button class="modal-close" onclick="cerrarModal('modal-factura')">√ó</button>
      </div>
      <div class="modal-body">
        <!-- N√∫mero y fecha -->
        <div class="form-row">
          <div class="form-group" style="flex:0 0 180px;">
            <label class="form-label">N¬∫ Factura</label>
            <input type="text" class="form-input" id="fact-numero" readonly style="background:var(--cream);font-weight:700;color:var(--gerente);">
          </div>
          <div class="form-group">
            <label class="form-label">Fecha emisi√≥n</label>
            <input type="date" class="form-input" id="fact-fecha">
          </div>
          <div class="form-group">
            <label class="form-label">Estado</label>
            <select class="form-select" id="fact-estado">
              <option value="emitida">‚úÖ Emitida</option>
              <option value="pendiente">‚è≥ Pendiente</option>
              <option value="cobrada">üí∂ Cobrada</option>
              <option value="anulada">‚ùå Anulada</option>
            </select>
          </div>
        </div>

        <!-- Desde presupuesto -->
        <div class="form-group" id="presup-selector-wrap">
          <label class="form-label">üìÑ Importar desde presupuesto aprobado</label>
          <select class="form-select" id="fact-desde-presup" onchange="cargarDesdePresupuesto(this.value)">
            <option value="">‚Äî Factura nueva (sin presupuesto) ‚Äî</option>
          </select>
        </div>

        <!-- Cliente -->
        <div class="form-group">
          <label class="form-label">Cliente</label>
          <input type="text" class="form-input" id="fact-cliente" placeholder="Nombre o raz√≥n social">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">NIF / CIF</label>
            <input type="text" class="form-input" id="fact-nif" placeholder="00000000A">
          </div>
          <div class="form-group">
            <label class="form-label">Direcci√≥n</label>
            <input type="text" class="form-input" id="fact-direccion" placeholder="Direcci√≥n fiscal">
          </div>
        </div>

        <!-- L√≠neas -->
        <div style="margin-top:8px;">
          <label class="form-label">L√≠neas de factura</label>
          <div class="linea-fact-header">
            <span>Concepto</span><span>Uds.</span><span style="text-align:right;">Precio</span><span>%IVA</span><span style="text-align:right;">Importe</span><span></span>
          </div>
          <div id="fact-lineas"></div>
          <button class="btn btn-secondary btn-sm" onclick="addLineaFactura()" style="margin-top:8px;">+ A√±adir l√≠nea</button>
        </div>

        <!-- Totales -->
        <div class="fact-totales">
          <div class="fact-total-row"><span class="label">Base imponible:</span><span id="fact-base">0,00 ‚Ç¨</span></div>
          <div id="fact-ivas-desglose"></div>
          <div class="fact-total-row"><span class="label">Total IVA:</span><span id="fact-iva-total">0,00 ‚Ç¨</span></div>
          <div class="fact-total-row grande"><span class="label">TOTAL FACTURA:</span><span id="fact-total">0,00 ‚Ç¨</span></div>
        </div>

        <!-- Notas factura -->
        <div class="form-group" style="margin-top:14px;">
          <label class="form-label">Observaciones</label>
          <textarea class="form-textarea" id="fact-observaciones" rows="2" placeholder="Notas adicionales..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-factura')">Cancelar</button>
        <button class="btn btn-danger" id="btn-eliminar-fact" onclick="eliminarFactura()" style="display:none;">Eliminar</button>
        <button class="btn btn-secondary" id="btn-pdf-fact" onclick="generarPDFFactura()" style="display:none;">üìÑ PDF</button>
        <button class="btn btn-gerente" onclick="guardarFactura()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let origen = 'gerente';

    // Datos
    let facturasData = [];
    let serviciosData = [];
    let factLineas = [];
    let editingFactId = null;
    let configSerie = { prefijo: 'FLK' };
    let condiciones = { forma: '', cuenta: '', notas: '' };
    let presupuestosData = [];

    const GRUPOS = {
      alojamiento: { icon: 'üè†', nombre: 'Alojamiento' },
      manutencion: { icon: 'üçΩÔ∏è', nombre: 'Manutenci√≥n' },
      actividades: { icon: 'üéØ', nombre: 'Actividades' },
      extras:      { icon: '‚ú®', nombre: 'Extras' }
    };

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');
      origen = params.get('origen') || 'gerente';

      if (!bienId) { alert('No se ha especificado el bien'); window.location.href = 'lo-comun.html'; return; }

      auth.onAuthStateChanged(async (user) => {
        if (!user) { window.location.href = 'login.html'; return; }
        currentUser = user;
        await cargarBien();
        await cargarServicios();
        await cargarFacturas();
        await cargarPresupuestos();
        renderFacturas();
        initInforme();
      });
    });

    // ========== CARGAR ==========
    async function cargarBien() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (doc.exists) {
          bienData = doc.data();
          document.getElementById('bien-nombre').textContent = bienData.nombre || 'Sin nombre';
          document.getElementById('btn-volver').href = `${origen}.html?id=${bienId}`;
          if (bienData.configSerie) {
            configSerie = bienData.configSerie;
            document.getElementById('serie-prefijo').value = configSerie.prefijo || 'FLK';
          }
          if (bienData.condicionesPago) {
            condiciones = bienData.condicionesPago;
            document.getElementById('cond-forma').value = condiciones.forma || '';
            document.getElementById('cond-cuenta').value = condiciones.cuenta || '';
            document.getElementById('cond-notas').value = condiciones.notas || '';
          }
          actualizarPreviewSerie();
        }
      } catch (e) { console.error('Error cargando bien:', e); }
    }

    async function cargarServicios() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('servicios').orderBy('orden', 'asc').get();
        serviciosData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.log('Sin servicios:', e.message); }
    }

    async function cargarFacturas() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('facturas').orderBy('fecha', 'desc').get();
        facturasData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.error('Error cargando facturas:', e); }
    }

    async function cargarPresupuestos() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('presupuestos').get();
        presupuestosData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.log('Sin presupuestos:', e.message); }
    }

    // ========== TABS ==========
    function cambiarTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
      if (tab === 'informe') generarInforme();
    }

    // ========== SERIE ==========
    function actualizarPreviewSerie() {
      const prefijo = document.getElementById('serie-prefijo').value.trim().toUpperCase() || 'FLK';
      const anio = new Date().getFullYear();
      const siguiente = calcularSiguienteNumero();
      document.getElementById('serie-preview').textContent = `${prefijo}-${anio}-${String(siguiente).padStart(4, '0')}`;
    }

    function calcularSiguienteNumero() {
      const anio = new Date().getFullYear();
      const prefijo = (configSerie.prefijo || 'FLK').toUpperCase();
      let max = 0;
      facturasData.forEach(f => {
        if (f.numero && f.numero.startsWith(prefijo + '-' + anio + '-')) {
          const num = parseInt(f.numero.split('-').pop());
          if (num > max) max = num;
        }
      });
      return max + 1;
    }

    function generarNumeroFactura() {
      const prefijo = (document.getElementById('serie-prefijo').value.trim() || configSerie.prefijo || 'FLK').toUpperCase();
      const anio = new Date().getFullYear();
      const sig = calcularSiguienteNumero();
      return `${prefijo}-${anio}-${String(sig).padStart(4, '0')}`;
    }

    async function guardarConfigSerie() {
      configSerie.prefijo = document.getElementById('serie-prefijo').value.trim().toUpperCase() || 'FLK';
      try {
        await db.collection('bienes').doc(bienId).update({ configSerie });
        actualizarPreviewSerie();
      } catch (e) { console.error('Error guardando serie:', e); }
    }

    async function guardarCondiciones() {
      condiciones = {
        forma: document.getElementById('cond-forma').value.trim(),
        cuenta: document.getElementById('cond-cuenta').value.trim(),
        notas: document.getElementById('cond-notas').value.trim()
      };
      try {
        await db.collection('bienes').doc(bienId).update({ condicionesPago: condiciones });
        alert('‚úÖ Condiciones guardadas');
      } catch (e) { console.error('Error:', e); alert('Error al guardar'); }
    }

    // ========== RENDER FACTURAS ==========
    function renderFacturas() {
      const container = document.getElementById('facturas-container');
      const empty = document.getElementById('empty-facturas');

      if (facturasData.length === 0) {
        container.innerHTML = ''; container.appendChild(empty); empty.style.display = ''; return;
      }
      empty.style.display = 'none';

      let html = '';
      facturasData.forEach(f => {
        html += `<div class="factura-card ${f.estado || 'emitida'}" onclick='abrirModalFactura(${JSON.stringify(f).replace(/'/g, "&#39;")})'>
          <div class="factura-top">
            <div class="factura-numero">${f.numero || '‚Äî'}</div>
            <div class="factura-total">${(f.total || 0).toFixed(2)} ‚Ç¨</div>
          </div>
          <div class="factura-meta">
            <span class="estado-badge ${f.estado || 'emitida'}">${(f.estado || 'emitida').toUpperCase()}</span>
            <span>üë§ ${f.cliente || 'Sin cliente'}</span>
            <span>üìÖ ${formatFechaCorta(f.fecha)}</span>
            <span>Base: ${(f.baseImponible || 0).toFixed(2)}‚Ç¨ ¬∑ IVA: ${(f.totalIva || 0).toFixed(2)}‚Ç¨</span>
            ${f.presupuestoId ? '<span style="color:var(--sage);">üìÑ Desde presupuesto</span>' : ''}
          </div>
        </div>`;
      });
      container.innerHTML = html;
    }

    // ========== MODAL FACTURA ==========
    function abrirModalFactura(factura = null) {
      editingFactId = factura?.id || null;
      document.getElementById('modal-fact-titulo').textContent = factura ? `Factura ${factura.numero}` : 'Nueva factura';

      document.getElementById('fact-numero').value = factura?.numero || generarNumeroFactura();
      document.getElementById('fact-fecha').value = factura?.fecha || new Date().toISOString().split('T')[0];
      document.getElementById('fact-estado').value = factura?.estado || 'emitida';
      document.getElementById('fact-cliente').value = factura?.cliente || '';
      document.getElementById('fact-nif').value = factura?.nif || '';
      document.getElementById('fact-direccion').value = factura?.direccion || '';
      document.getElementById('fact-observaciones').value = factura?.observaciones || '';

      document.getElementById('btn-eliminar-fact').style.display = factura ? '' : 'none';
      document.getElementById('btn-pdf-fact').style.display = factura ? '' : 'none';

      // Selector de presupuestos aprobados
      const selPresup = document.getElementById('fact-desde-presup');
      selPresup.innerHTML = '<option value="">‚Äî Factura nueva (sin presupuesto) ‚Äî</option>';
      const aprobados = presupuestosData.filter(p => p.estado === 'aceptado' || p.estado === 'facturado');
      aprobados.forEach(p => {
        const fecha = p.fecha ? formatFechaCorta(p.fecha) : '';
        selPresup.innerHTML += `<option value="${p.id}">${p.cliente} ‚Äî ${(p.total || 0).toFixed(2)}‚Ç¨ (${fecha})</option>`;
      });
      // Si editamos y tiene presupuesto vinculado, seleccionarlo
      if (factura?.presupuestoId) selPresup.value = factura.presupuestoId;
      // Ocultar selector si estamos editando una factura existente sin presupuesto
      document.getElementById('presup-selector-wrap').style.display = factura && !factura.presupuestoId ? 'none' : '';

      factLineas = factura?.lineas ? JSON.parse(JSON.stringify(factura.lineas)) : [];
      if (factLineas.length === 0) addLineaFactura();
      renderLineasFactura();
      document.getElementById('modal-factura').classList.add('active');
    }

    function cargarDesdePresupuesto(presupId) {
      if (!presupId) return;
      const p = presupuestosData.find(x => x.id === presupId);
      if (!p) return;

      // Rellenar datos del cliente
      document.getElementById('fact-cliente').value = p.cliente || '';

      // Convertir l√≠neas del presupuesto a l√≠neas de factura (editables)
      factLineas = (p.lineas || []).map(l => ({
        servicioId: l.servicioId || '',
        concepto: l.nombre || l.concepto || '',
        grupo: l.grupo || '',
        cantidad: l.cantidad || 1,
        precio: l.precio || 0,
        iva: 21 // IVA por defecto, el usuario ajusta por l√≠nea
      }));

      // Si el presupuesto ten√≠a descuento, a√±adir l√≠nea de descuento negativa
      if (p.descuentoValor && p.descuentoValor > 0) {
        factLineas.push({
          servicioId: '',
          concepto: `Descuento: ${p.descuentoNombre || 'Dto. aplicado'}`,
          grupo: '',
          cantidad: 1,
          precio: -(p.descuentoValor),
          iva: 21
        });
      }

      if (factLineas.length === 0) addLineaFactura();
      renderLineasFactura();
    }

    function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }

    // ========== L√çNEAS FACTURA ==========
    function addLineaFactura() {
      factLineas.push({ servicioId: '', concepto: '', grupo: '', cantidad: 1, precio: 0, iva: 21 });
      renderLineasFactura();
    }

    function removeLineaFactura(idx) {
      factLineas.splice(idx, 1);
      renderLineasFactura();
    }

    function renderLineasFactura() {
      const container = document.getElementById('fact-lineas');
      let html = '';
      factLineas.forEach((l, i) => {
        html += `<div class="linea-fact">
          <div>
            <select class="form-select" style="font-size:0.8rem;padding:5px 6px;" onchange="selectServicioFactura(${i}, this.value)">
              <option value="">‚Äî Concepto libre ‚Äî</option>`;
        Object.entries(GRUPOS).forEach(([gKey, g]) => {
          const items = serviciosData.filter(s => s.grupo === gKey);
          if (items.length > 0) {
            html += `<optgroup label="${g.icon} ${g.nombre}">`;
            items.forEach(s => {
              html += `<option value="${s.id}" ${l.servicioId === s.id ? 'selected' : ''}>${s.nombre}</option>`;
            });
            html += `</optgroup>`;
          }
        });
        html += `</select>
            ${!l.servicioId ? `<input type="text" class="form-input" style="margin-top:4px;font-size:0.8rem;padding:5px 8px;" 
              value="${l.concepto || ''}" placeholder="Concepto libre" 
              onchange="factLineas[${i}].concepto = this.value">` : ''}
          </div>
          <input type="number" class="form-input input-sm" min="0" step="0.01" value="${l.cantidad}" 
            onchange="factLineas[${i}].cantidad = parseFloat(this.value) || 0; recalcularFactura();">
          <input type="number" class="form-input input-sm" min="0" step="0.01" value="${l.precio}" 
            onchange="factLineas[${i}].precio = parseFloat(this.value) || 0; recalcularFactura();">
          <select class="form-select" style="font-size:0.8rem;padding:5px 4px;" onchange="factLineas[${i}].iva = parseInt(this.value); recalcularFactura();">
            <option value="21" ${l.iva === 21 ? 'selected' : ''}>21%</option>
            <option value="10" ${l.iva === 10 ? 'selected' : ''}>10%</option>
            <option value="4" ${l.iva === 4 ? 'selected' : ''}>4%</option>
            <option value="0" ${l.iva === 0 ? 'selected' : ''}>0%</option>
          </select>
          <div style="text-align:right;font-weight:600;font-size:0.82rem;">${(l.cantidad * l.precio).toFixed(2)}</div>
          <button class="btn-icon danger" onclick="removeLineaFactura(${i})">üóëÔ∏è</button>
        </div>`;
      });
      container.innerHTML = html;
      recalcularFactura();
    }

    function selectServicioFactura(idx, sid) {
      const s = serviciosData.find(x => x.id === sid);
      if (s) {
        factLineas[idx].servicioId = s.id;
        factLineas[idx].concepto = s.nombre;
        factLineas[idx].grupo = s.grupo;
      } else {
        factLineas[idx].servicioId = '';
        factLineas[idx].grupo = '';
      }
      renderLineasFactura();
    }

    function recalcularFactura() {
      let base = 0;
      const ivasPorTipo = {};

      factLineas.forEach(l => {
        const importe = l.cantidad * l.precio;
        base += importe;
        const pct = l.iva || 0;
        if (!ivasPorTipo[pct]) ivasPorTipo[pct] = 0;
        ivasPorTipo[pct] += importe * pct / 100;
      });

      const totalIva = Object.values(ivasPorTipo).reduce((s, v) => s + v, 0);

      document.getElementById('fact-base').textContent = base.toFixed(2) + ' ‚Ç¨';
      document.getElementById('fact-iva-total').textContent = totalIva.toFixed(2) + ' ‚Ç¨';
      document.getElementById('fact-total').textContent = (base + totalIva).toFixed(2) + ' ‚Ç¨';

      // Desglose IVA
      let desgloseHtml = '';
      Object.keys(ivasPorTipo).sort((a, b) => b - a).forEach(pct => {
        if (ivasPorTipo[pct] > 0) {
          desgloseHtml += `<div class="fact-total-row" style="font-size:0.82rem;"><span class="label">IVA ${pct}%:</span><span>${ivasPorTipo[pct].toFixed(2)} ‚Ç¨</span></div>`;
        }
      });
      document.getElementById('fact-ivas-desglose').innerHTML = desgloseHtml;
    }

    // ========== GUARDAR FACTURA ==========
    async function guardarFactura() {
      const cliente = document.getElementById('fact-cliente').value.trim();
      if (!cliente) { alert('El cliente es obligatorio'); return; }

      let base = 0, totalIva = 0;
      factLineas.forEach(l => {
        const imp = l.cantidad * l.precio;
        base += imp;
        totalIva += imp * (l.iva || 0) / 100;
      });

      const presupId = document.getElementById('fact-desde-presup').value || null;

      const data = {
        numero: document.getElementById('fact-numero').value,
        fecha: document.getElementById('fact-fecha').value,
        estado: document.getElementById('fact-estado').value,
        cliente, nif: document.getElementById('fact-nif').value.trim(),
        direccion: document.getElementById('fact-direccion').value.trim(),
        lineas: factLineas,
        baseImponible: base, totalIva, total: base + totalIva,
        observaciones: document.getElementById('fact-observaciones').value.trim(),
        presupuestoId: presupId
      };

      try {
        const ref = db.collection('bienes').doc(bienId).collection('facturas');
        if (editingFactId) {
          await ref.doc(editingFactId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }

        // Marcar presupuesto como facturado
        if (presupId && !editingFactId) {
          try {
            await db.collection('bienes').doc(bienId).collection('presupuestos').doc(presupId).update({ estado: 'facturado' });
          } catch (pe) { console.log('No se pudo actualizar presupuesto:', pe.message); }
        }

        cerrarModal('modal-factura');
        await cargarFacturas();
        await cargarPresupuestos();
        renderFacturas();
        actualizarPreviewSerie();
      } catch (e) { console.error('Error:', e); alert('Error al guardar'); }
    }

    async function eliminarFactura() {
      if (!editingFactId || !confirm('¬øEliminar esta factura?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('facturas').doc(editingFactId).delete();
        cerrarModal('modal-factura');
        await cargarFacturas();
        renderFacturas();
        actualizarPreviewSerie();
      } catch (e) { console.error('Error:', e); alert('Error al eliminar'); }
    }

    // ========== PDF FACTURA ==========
    function generarPDFFactura() {
      const numero = document.getElementById('fact-numero').value;
      const fecha = document.getElementById('fact-fecha').value;
      const cliente = document.getElementById('fact-cliente').value;
      const nif = document.getElementById('fact-nif').value;
      const direccion = document.getElementById('fact-direccion').value;
      const obs = document.getElementById('fact-observaciones').value;

      let base = 0, totalIva = 0;
      const ivasPorTipo = {};
      let lineasHtml = '';

      factLineas.forEach(l => {
        const imp = l.cantidad * l.precio;
        base += imp;
        const ivaVal = imp * (l.iva || 0) / 100;
        totalIva += ivaVal;
        if (!ivasPorTipo[l.iva]) ivasPorTipo[l.iva] = 0;
        ivasPorTipo[l.iva] += ivaVal;

        const nombre = l.servicioId ? (serviciosData.find(s => s.id === l.servicioId)?.nombre || l.concepto) : l.concepto;
        lineasHtml += `<tr>
          <td style="padding:7px 12px;text-align:left;">${nombre || '‚Äî'}</td>
          <td style="padding:7px 12px;text-align:center;">${l.cantidad}</td>
          <td style="padding:7px 12px;text-align:right;">${l.precio.toFixed(2)} ‚Ç¨</td>
          <td style="padding:7px 12px;text-align:center;">${l.iva}%</td>
          <td style="padding:7px 12px;text-align:right;font-weight:600;">${imp.toFixed(2)} ‚Ç¨</td>
        </tr>`;
      });

      let ivaDesgloseHtml = '';
      Object.keys(ivasPorTipo).sort((a, b) => b - a).forEach(pct => {
        if (ivasPorTipo[pct] > 0) {
          ivaDesgloseHtml += `<div class="t-row"><span>IVA ${pct}%:</span><span>${ivasPorTipo[pct].toFixed(2)} ‚Ç¨</span></div>`;
        }
      });

      const bienNombre = bienData?.nombre || '';
      const pdfHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Factura ${numero}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@600;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Nunito',sans-serif;color:#3D3D3D;padding:40px;max-width:800px;margin:0 auto}
  .header-fact{display:flex;justify-content:space-between;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid #2D4A5C}
  .header-fact h1{font-family:'Quicksand',sans-serif;font-size:1.6rem;color:#2D4A5C}
  .header-fact .meta{text-align:right;font-size:0.85rem;color:#6B6B6B}
  .header-fact .meta strong{color:#3D3D3D}
  .datos{display:flex;justify-content:space-between;margin-bottom:24px}
  .datos .bloque{flex:1}
  .datos h3{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.5px;color:#9A9A9A;margin-bottom:6px}
  .datos p{font-size:0.88rem;line-height:1.6}
  table{width:100%;border-collapse:collapse;margin-bottom:20px}
  thead th{background:#2D4A5C;color:white;padding:8px 12px;font-size:0.78rem;text-transform:uppercase;letter-spacing:0.5px}
  thead th:first-child{text-align:left}thead th:not(:first-child){text-align:right}
  thead th:nth-child(2),thead th:nth-child(4){text-align:center}
  tbody td{border-bottom:1px solid #eee}
  .totales{text-align:right;margin-bottom:24px}
  .t-row{display:flex;justify-content:flex-end;gap:40px;padding:4px 0;font-size:0.9rem}
  .t-row.total{font-size:1.3rem;font-weight:700;color:#2D4A5C;border-top:3px solid #2D4A5C;padding-top:10px;margin-top:8px}
  .condiciones{margin-top:20px;padding:16px;background:#FDF8F3;border-radius:8px;font-size:0.82rem;color:#6B6B6B}
  .condiciones strong{color:#3D3D3D}
  .footer{margin-top:40px;text-align:center;font-size:0.72rem;color:#9A9A9A}
  @media print{body{padding:20px}}
</style></head><body>
  <div class="header-fact">
    <div><h1>FACTURA</h1><div style="font-size:0.85rem;color:#6B6B6B;">${bienNombre}</div></div>
    <div class="meta"><strong>${numero}</strong><br>Fecha: ${fecha}</div>
  </div>
  <div class="datos">
    <div class="bloque"><h3>Cliente</h3><p><strong>${cliente}</strong><br>${nif ? 'NIF/CIF: ' + nif + '<br>' : ''}${direccion || ''}</p></div>
  </div>
  <table><thead><tr><th>Concepto</th><th>Uds.</th><th>Precio</th><th>IVA</th><th>Importe</th></tr></thead><tbody>${lineasHtml}</tbody></table>
  <div class="totales">
    <div class="t-row"><span>Base imponible:</span><span>${base.toFixed(2)} ‚Ç¨</span></div>
    ${ivaDesgloseHtml}
    <div class="t-row"><span>Total IVA:</span><span>${totalIva.toFixed(2)} ‚Ç¨</span></div>
    <div class="t-row total"><span>TOTAL:</span><span>${(base + totalIva).toFixed(2)} ‚Ç¨</span></div>
  </div>
  ${condiciones.forma || condiciones.cuenta ? `<div class="condiciones">
    <strong>Condiciones de pago</strong><br>
    ${condiciones.forma ? 'Forma de pago: ' + condiciones.forma + '<br>' : ''}
    ${condiciones.cuenta ? 'Cuenta: ' + condiciones.cuenta + '<br>' : ''}
    ${condiciones.notas ? condiciones.notas : ''}
  </div>` : ''}
  ${obs ? `<div class="condiciones" style="margin-top:10px;"><strong>Observaciones:</strong><br>${obs.replace(/\n/g, '<br>')}</div>` : ''}
  <div class="footer">Generado con FAMILYNK ¬∑ ${new Date().toLocaleDateString('es-ES')}</div>
  <script>window.onload = () => window.print();<\/script>
</body></html>`;

      const v = window.open('', '_blank');
      v.document.write(pdfHtml);
      v.document.close();
    }

    // ========== INFORME VENTAS ==========
    function initInforme() {
      // A√±os disponibles
      const anios = new Set();
      facturasData.forEach(f => { if (f.fecha) anios.add(parseInt(f.fecha.substring(0, 4))); });
      const anioActual = new Date().getFullYear();
      anios.add(anioActual);
      const sorted = Array.from(anios).sort((a, b) => b - a);

      const selAnio = document.getElementById('inf-anio');
      const selComp = document.getElementById('inf-anio-comp');
      selAnio.innerHTML = '';
      selComp.innerHTML = '';
      sorted.forEach(a => {
        selAnio.innerHTML += `<option value="${a}" ${a === anioActual ? 'selected' : ''}>${a}</option>`;
        selComp.innerHTML += `<option value="${a}" ${a === anioActual - 1 ? 'selected' : ''}>${a}</option>`;
      });

      // Clientes
      const clientes = new Set();
      facturasData.forEach(f => { if (f.cliente) clientes.add(f.cliente); });
      const selCli = document.getElementById('inf-cliente');
      selCli.innerHTML = '<option value="">Todos</option>';
      clientes.forEach(c => { selCli.innerHTML += `<option value="${c}">${c}</option>`; });

      // Servicios
      const selServ = document.getElementById('inf-servicio');
      selServ.innerHTML = '<option value="">Todos</option>';
      serviciosData.forEach(s => {
        selServ.innerHTML += `<option value="${s.id}">${GRUPOS[s.grupo]?.icon || ''} ${s.nombre}</option>`;
      });
    }

    function toggleComparar() {
      const activo = document.getElementById('inf-comparar').checked;
      document.getElementById('inf-anio-comp').style.display = activo ? '' : 'none';
      generarInforme();
    }

    function generarInforme() {
      const periodo = document.getElementById('inf-periodo').value;
      const anio = parseInt(document.getElementById('inf-anio').value);
      const cliente = document.getElementById('inf-cliente').value;
      const grupo = document.getElementById('inf-grupo').value;
      const servicio = document.getElementById('inf-servicio').value;
      const comparar = document.getElementById('inf-comparar').checked;
      const anioComp = comparar ? parseInt(document.getElementById('inf-anio-comp').value) : null;

      // Filtrar facturas (excluir anuladas)
      const filtrar = (facts, yr) => facts.filter(f => {
        if (f.estado === 'anulada') return false;
        if (!f.fecha) return false;
        if (parseInt(f.fecha.substring(0, 4)) !== yr) return false;
        if (cliente && f.cliente !== cliente) return false;
        return true;
      });

      const factsAnio = filtrar(facturasData, anio);
      const factsComp = comparar ? filtrar(facturasData, anioComp) : [];

      // Extraer l√≠neas con filtros de grupo/servicio
      const extraerLineas = (facts) => {
        const lineas = [];
        facts.forEach(f => {
          (f.lineas || []).forEach(l => {
            if (grupo && l.grupo !== grupo) return;
            if (servicio && l.servicioId !== servicio) return;
            lineas.push({ ...l, fecha: f.fecha, cliente: f.cliente });
          });
        });
        return lineas;
      };

      const lineasAnio = extraerLineas(factsAnio);
      const lineasComp = comparar ? extraerLineas(factsComp) : [];

      // KPIs
      const kpiBase = lineasAnio.reduce((s, l) => s + l.cantidad * l.precio, 0);
      const kpiIva = lineasAnio.reduce((s, l) => s + l.cantidad * l.precio * (l.iva || 0) / 100, 0);
      document.getElementById('kpi-facturas').textContent = factsAnio.length;
      document.getElementById('kpi-base').textContent = kpiBase.toFixed(2) + ' ‚Ç¨';
      document.getElementById('kpi-iva').textContent = kpiIva.toFixed(2) + ' ‚Ç¨';
      document.getElementById('kpi-total').textContent = (kpiBase + kpiIva).toFixed(2) + ' ‚Ç¨';

      // Agrupar por periodo
      const agrupar = (lineas, yr) => {
        const buckets = {};
        lineas.forEach(l => {
          const mes = parseInt(l.fecha.substring(5, 7));
          let key;
          if (periodo === 'mes') key = mes;
          else if (periodo === 'trimestre') key = Math.ceil(mes / 3);
          else key = 1;
          if (!buckets[key]) buckets[key] = { base: 0, iva: 0, count: 0 };
          const imp = l.cantidad * l.precio;
          buckets[key].base += imp;
          buckets[key].iva += imp * (l.iva || 0) / 100;
          buckets[key].count++;
        });
        return buckets;
      };

      const bucketsAnio = agrupar(lineasAnio, anio);
      const bucketsComp = comparar ? agrupar(lineasComp, anioComp) : {};

      // Labels
      const labels = {};
      if (periodo === 'mes') {
        const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        for (let i = 1; i <= 12; i++) labels[i] = meses[i - 1];
      } else if (periodo === 'trimestre') {
        for (let i = 1; i <= 4; i++) labels[i] = `T${i}`;
      } else {
        labels[1] = 'Total';
      }

      // Render tabla
      const container = document.getElementById('informe-container');
      let hasData = Object.keys(bucketsAnio).length > 0;
      if (!hasData && !comparar) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìä</div>
          <div class="empty-state-title">Sin datos para este per√≠odo</div>
          <div class="empty-state-text">No hay facturas que coincidan con los filtros</div></div>`;
        return;
      }

      let html = `<div style="overflow-x:auto;"><table class="tabla-informe"><thead><tr>
        <th style="min-width:80px;">Per√≠odo</th>
        <th>Base ${anio}</th><th>IVA ${anio}</th><th>Total ${anio}</th>`;
      if (comparar) {
        html += `<th>Base ${anioComp}</th><th>Total ${anioComp}</th><th>Variaci√≥n</th>`;
      }
      html += `</tr></thead><tbody>`;

      let sumBase = 0, sumIva = 0, sumTotal = 0, sumBaseC = 0, sumTotalC = 0;

      Object.entries(labels).forEach(([key, label]) => {
        const b = bucketsAnio[key] || { base: 0, iva: 0 };
        const total = b.base + b.iva;
        sumBase += b.base; sumIva += b.iva; sumTotal += total;

        html += `<tr><td>${label}</td><td>${b.base.toFixed(2)} ‚Ç¨</td><td>${b.iva.toFixed(2)} ‚Ç¨</td><td style="font-weight:600;">${total.toFixed(2)} ‚Ç¨</td>`;

        if (comparar) {
          const bc = bucketsComp[key] || { base: 0, iva: 0 };
          const totalC = bc.base + bc.iva;
          sumBaseC += bc.base; sumTotalC += totalC;
          const variacion = totalC > 0 ? ((total - totalC) / totalC * 100) : (total > 0 ? 100 : 0);
          const varClass = variacion > 0 ? 'positiva' : variacion < 0 ? 'negativa' : '';
          const varSymbol = variacion > 0 ? '‚ñ≤' : variacion < 0 ? '‚ñº' : '‚Äî';
          html += `<td>${bc.base.toFixed(2)} ‚Ç¨</td><td>${totalC.toFixed(2)} ‚Ç¨</td>
            <td><span class="variacion ${varClass}">${varSymbol} ${Math.abs(variacion).toFixed(1)}%</span></td>`;
        }
        html += `</tr>`;
      });

      // Fila total
      html += `<tr class="fila-total"><td>TOTAL</td><td>${sumBase.toFixed(2)} ‚Ç¨</td><td>${sumIva.toFixed(2)} ‚Ç¨</td><td>${sumTotal.toFixed(2)} ‚Ç¨</td>`;
      if (comparar) {
        const varTotal = sumTotalC > 0 ? ((sumTotal - sumTotalC) / sumTotalC * 100) : (sumTotal > 0 ? 100 : 0);
        const varClass = varTotal > 0 ? 'positiva' : varTotal < 0 ? 'negativa' : '';
        const varSymbol = varTotal > 0 ? '‚ñ≤' : varTotal < 0 ? '‚ñº' : '‚Äî';
        html += `<td>${sumBaseC.toFixed(2)} ‚Ç¨</td><td>${sumTotalC.toFixed(2)} ‚Ç¨</td>
          <td><span class="variacion ${varClass}">${varSymbol} ${Math.abs(varTotal).toFixed(1)}%</span></td>`;
      }
      html += `</tr></tbody></table></div>`;

      // Desglose por grupo (si no filtrado por grupo)
      if (!grupo) {
        html += `<h3 style="font-family:'Quicksand',sans-serif;font-size:0.95rem;margin:20px 0 12px;">Desglose por grupo</h3>`;
        html += `<table class="tabla-informe"><thead><tr><th>Grupo</th><th>Base</th><th>IVA</th><th>Total</th>`;
        if (comparar) html += `<th>Total ${anioComp}</th><th>Variaci√≥n</th>`;
        html += `</tr></thead><tbody>`;

        Object.entries(GRUPOS).forEach(([gKey, g]) => {
          const gLineas = lineasAnio.filter(l => l.grupo === gKey);
          const gBase = gLineas.reduce((s, l) => s + l.cantidad * l.precio, 0);
          const gIva = gLineas.reduce((s, l) => s + l.cantidad * l.precio * (l.iva || 0) / 100, 0);
          const gTotal = gBase + gIva;

          html += `<tr><td>${g.icon} ${g.nombre}</td><td>${gBase.toFixed(2)} ‚Ç¨</td><td>${gIva.toFixed(2)} ‚Ç¨</td><td style="font-weight:600;">${gTotal.toFixed(2)} ‚Ç¨</td>`;
          if (comparar) {
            const gcLineas = lineasComp.filter(l => l.grupo === gKey);
            const gcTotal = gcLineas.reduce((s, l) => s + l.cantidad * l.precio * (1 + (l.iva || 0) / 100), 0);
            const v = gcTotal > 0 ? ((gTotal - gcTotal) / gcTotal * 100) : (gTotal > 0 ? 100 : 0);
            const vc = v > 0 ? 'positiva' : v < 0 ? 'negativa' : '';
            html += `<td>${gcTotal.toFixed(2)} ‚Ç¨</td><td><span class="variacion ${vc}">${v > 0 ? '‚ñ≤' : v < 0 ? '‚ñº' : '‚Äî'} ${Math.abs(v).toFixed(1)}%</span></td>`;
          }
          html += `</tr>`;
        });
        html += `</tbody></table>`;
      }

      container.innerHTML = html;
    }

    // ========== HELPERS ==========
    function formatFechaCorta(dateStr) {
      if (!dateStr) return '‚Äî';
      const [y, m, d] = dateStr.split('-');
      const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
      return `${parseInt(d)} ${meses[parseInt(m) - 1]} ${y}`;
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) modal.classList.remove('active');
      });
    });
  </script>
</body>
</html>
