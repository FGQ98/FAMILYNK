<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Finanzas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E; --cream: #FDF8F3; --cream-dark: #F5EDE4; --cream-medium: #FAF5EF;
      --terracotta: #C17757; --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A; --white: #FFFFFF;
      --capataz: #6B8E23; --capataz-light: #8FBC3C; --capataz-dark: #4A6B10; --capataz-muted: rgba(107,142,35,0.15);
      --gerente: #2D4A5C; --gerente-light: #4A6B7C; --gerente-dark: #1D3544; --gerente-muted: rgba(45,74,92,0.15);
      --success: #7DB59A; --success-muted: rgba(125,181,154,0.15);
      --warning: #E8B44D; --warning-muted: rgba(232,180,77,0.15);
      --error: #D4695A; --error-muted: rgba(212,105,90,0.15);
      --info: #5B9BD5; --info-muted: rgba(91,155,213,0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06); --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-full: 50px;
      --addon-color: var(--capataz); --addon-light: var(--capataz-light);
      --addon-dark: var(--capataz-dark); --addon-muted: var(--capataz-muted);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header {
      background: linear-gradient(135deg, var(--addon-color) 0%, var(--addon-dark) 100%);
      padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-medium); position: sticky; top: 0; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: rgba(255,255,255,0.15); border: none; border-radius: var(--radius-md); color: white; font-family: 'Nunito'; font-size: 0.85rem; cursor: pointer; text-decoration: none; transition: all 0.2s; }
    .back-btn:hover { background: rgba(255,255,255,0.25); }
    .header-info h1 { color: white; font-family: 'Quicksand'; font-size: 1.2rem; font-weight: 700; }
    .header-info p { color: rgba(255,255,255,0.7); font-size: 0.8rem; }

    .main { max-width: 960px; margin: 0 auto; padding: 24px; }
    .card { background: var(--white); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-soft); }
    .card-title { font-family: 'Quicksand'; font-weight: 700; font-size: 1rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--white); padding: 4px; border-radius: var(--radius-full); box-shadow: var(--shadow-soft); }
    .tab { flex: 1; padding: 12px 16px; border: none; background: none; border-radius: var(--radius-full); font-family: 'Nunito'; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; color: var(--text-muted); }
    .tab:hover { color: var(--text); }
    .tab.active { background: var(--addon-color); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Ejercicio */
    .ejercicio-bar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
    .ejercicio-select { flex: 1; min-width: 200px; padding: 12px 14px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md); font-family: 'Nunito'; font-size: 0.95rem; font-weight: 600; background: var(--white); }
    .ejercicio-select:focus { outline: none; border-color: var(--addon-color); }

    /* Buttons */
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; border-radius: var(--radius-md); font-family: 'Nunito'; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; text-decoration: none; }
    .btn-addon { background: var(--addon-color); color: white; }
    .btn-addon:hover { background: var(--addon-dark); }
    .btn-secondary { background: var(--cream); color: var(--text); }
    .btn-secondary:hover { background: var(--cream-dark); }
    .btn-danger { background: var(--error); color: white; }
    .btn-sm { padding: 7px 12px; font-size: 0.8rem; }
    .btn-ghost { background: none; color: var(--text-muted); padding: 4px 8px; border-radius: var(--radius-sm); font-size: 0.78rem; }
    .btn-ghost:hover { background: var(--cream); color: var(--text); }

    /* Resumen */
    .resumen-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
    .resumen-item { background: var(--white); border-radius: var(--radius-md); padding: 14px 10px; text-align: center; box-shadow: var(--shadow-soft); border-top: 3px solid var(--cream-dark); }
    .resumen-item.ventas { border-top-color: var(--success); }
    .resumen-item.costes { border-top-color: var(--warning); }
    .resumen-item.personal { border-top-color: var(--info); }
    .resumen-item.otros { border-top-color: var(--error); }
    .resumen-item.resultado { border-top-color: var(--addon-color); }
    .resumen-label { font-size: 0.68rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .resumen-valor { font-family: 'Quicksand'; font-size: 1.15rem; font-weight: 700; }
    .resumen-item.ventas .resumen-valor { color: var(--success); }
    .resumen-item.costes .resumen-valor { color: var(--warning); }
    .resumen-item.personal .resumen-valor { color: var(--info); }
    .resumen-item.otros .resumen-valor { color: var(--error); }
    .resumen-count { font-size: 0.68rem; color: var(--text-muted); }

    /* Grupo nivel 1 (fijo) */
    .grupo-section { margin-bottom: 16px; }
    .grupo-header {
      display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;
      border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; margin-bottom: 2px;
    }
    .grupo-header:hover { filter: brightness(0.95); }
    .grupo-header.ventas { background: var(--success-muted); }
    .grupo-header.costes { background: var(--warning-muted); }
    .grupo-header.personal { background: var(--info-muted); }
    .grupo-header.otros { background: var(--error-muted); }
    .grupo-header-left { display: flex; align-items: center; gap: 10px; }
    .grupo-header-icon { font-size: 1.1rem; }
    .grupo-header-name { font-family: 'Quicksand'; font-weight: 700; font-size: 0.95rem; }
    .grupo-header-count { font-size: 0.78rem; color: var(--text-muted); }
    .grupo-header-total { font-family: 'Quicksand'; font-weight: 700; font-size: 1.05rem; }
    .grupo-header.ventas .grupo-header-total { color: var(--success); }
    .grupo-header.costes .grupo-header-total { color: var(--warning); }
    .grupo-header.personal .grupo-header-total { color: var(--info); }
    .grupo-header.otros .grupo-header-total { color: var(--error); }
    .grupo-body { padding: 0 4px; }
    .grupo-body.collapsed { display: none; }

    /* Subgrupo nivel 2 (libre) */
    .subgrupo-section { margin: 4px 0 4px 12px; }
    .subgrupo-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px; background: var(--cream-medium); border-radius: var(--radius-sm);
      cursor: pointer; transition: all 0.15s; margin-bottom: 2px;
    }
    .subgrupo-header:hover { background: var(--cream-dark); }
    .subgrupo-header-left { display: flex; align-items: center; gap: 8px; }
    .subgrupo-header-name { font-weight: 700; font-size: 0.88rem; }
    .subgrupo-header-count { font-size: 0.72rem; color: var(--text-muted); }
    .subgrupo-header-total { font-family: 'Quicksand'; font-weight: 700; font-size: 0.92rem; }
    .subgrupo-body { padding: 0 0 0 16px; }
    .subgrupo-body.collapsed { display: none; }

    /* Partida nivel 3 */
    .partida-row { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid var(--cream-dark); gap: 10px; transition: background 0.15s; cursor: pointer; }
    .partida-row:hover { background: var(--cream); }
    .partida-row:last-child { border-bottom: none; }
    .partida-concepto { flex: 1; font-weight: 600; font-size: 0.88rem; }
    .partida-notas { font-size: 0.73rem; color: var(--text-muted); }
    .partida-importe { font-family: 'Quicksand'; font-weight: 700; font-size: 0.92rem; min-width: 90px; text-align: right; }

    /* Realizado: barra + registros */
    .partida-real-info { display: flex; align-items: center; gap: 8px; min-width: 240px; }
    .progress-bar { flex: 1; height: 7px; background: var(--cream-dark); border-radius: 4px; overflow: hidden; min-width: 60px; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
    .progress-fill.ok { background: var(--success); }
    .progress-fill.warn { background: var(--warning); }
    .progress-fill.over { background: var(--error); }
    .partida-pct { font-size: 0.75rem; font-weight: 700; min-width: 40px; text-align: right; }
    .partida-real-amount { font-family: 'Quicksand'; font-weight: 700; font-size: 0.85rem; min-width: 85px; text-align: right; }

    .registros-list { margin: 4px 0 8px 20px; }
    .registro-item { display: flex; align-items: center; gap: 8px; padding: 5px 10px; font-size: 0.8rem; border-left: 2px solid var(--cream-dark); margin-bottom: 1px; }
    .registro-fecha { color: var(--text-muted); min-width: 72px; font-size: 0.75rem; }
    .registro-concepto { flex: 1; }
    .registro-importe { font-weight: 700; min-width: 75px; text-align: right; }

    /* Resultado */
    .resultado-row {
      display: flex; align-items: center; justify-content: space-between; padding: 16px 20px;
      background: var(--addon-muted); border-radius: var(--radius-md); margin-top: 12px;
    }
    .resultado-label { font-family: 'Quicksand'; font-weight: 700; font-size: 1rem; }
    .resultado-valor { font-family: 'Quicksand'; font-weight: 700; font-size: 1.3rem; }

    /* Config */
    .config-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .config-row .form-group { flex: 1; min-width: 140px; }

    /* Forms */
    .form-group { margin-bottom: 12px; }
    .form-label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: var(--text-light); }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 10px 12px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md);
      font-family: 'Nunito'; font-size: 0.9rem; background: var(--white); transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--addon-color); }
    .form-textarea { resize: vertical; min-height: 50px; }
    .form-row { display: flex; gap: 12px; }
    .form-row > .form-group { flex: 1; }
    .subgrupo-input-wrap { display: flex; gap: 8px; align-items: flex-end; }
    .subgrupo-input-wrap .form-group { flex: 1; margin-bottom: 0; }
    .subgrupo-toggle { font-size: 0.78rem; color: var(--addon-color); cursor: pointer; font-weight: 600; white-space: nowrap; padding-bottom: 12px; }
    .subgrupo-toggle:hover { text-decoration: underline; }

    /* Modals */
    .modal-overlay { position: fixed; top:0;left:0;right:0;bottom:0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; opacity:0; visibility:hidden; transition: all 0.3s; padding: 20px; }
    .modal-overlay.active { opacity:1; visibility:visible; }
    .modal { background: var(--white); border-radius: var(--radius-lg); width:100%; max-width:520px; max-height:90vh; overflow-y:auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-family: 'Quicksand'; font-weight: 700; font-size: 1.1rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
    .modal-body { padding: 20px 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--cream-dark); display: flex; justify-content: flex-end; gap: 10px; }

    .empty-state { text-align: center; padding: 40px 20px; }
    .empty-state-icon { font-size: 3rem; opacity: 0.3; margin-bottom: 12px; }
    .empty-state-title { font-family: 'Quicksand'; font-weight: 700; margin-bottom: 8px; }
    .empty-state-text { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px; }
    .loading { display: flex; align-items: center; justify-content: center; min-height: 200px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--addon-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .resumen-grid { grid-template-columns: repeat(3, 1fr); }
      .partida-real-info { min-width: 160px; }
      .form-row { flex-direction: column; gap: 0; }
    }
    @media (max-width: 480px) {
      .resumen-grid { grid-template-columns: 1fr 1fr; }
      .partida-row { flex-wrap: wrap; }
      .partida-real-info { min-width: 100%; margin-top: 4px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a id="btn-volver" class="back-btn">‚Üê Volver</a>
      <div class="header-info">
        <h1>üí∞ Finanzas</h1>
        <p id="nombre-bien">Cargando...</p>
      </div>
    </div>
    <button class="btn btn-sm" style="background:rgba(255,255,255,0.15);color:white;" onclick="exportarPDF()">üìÑ PDF</button>
  </header>

  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>
    <div id="contenido" style="display:none;">

      <!-- Ejercicio -->
      <div class="ejercicio-bar">
        <select class="ejercicio-select" id="sel-ejercicio" onchange="seleccionarEjercicio()"></select>
        <button class="btn btn-addon btn-sm" onclick="abrirModalEjercicio()">+ Ejercicio</button>
        <button class="btn btn-secondary btn-sm" id="btn-config-ej" onclick="toggleConfig()" style="display:none;">‚öôÔ∏è</button>
      </div>

      <div class="card" id="card-config" style="display:none;">
        <div class="card-title">‚öôÔ∏è Ejercicio <span style="flex:1"></span>
          <button class="btn btn-sm btn-addon" onclick="guardarConfigEj()">üíæ</button>
          <button class="btn btn-sm btn-danger" onclick="eliminarEjercicio()">üóëÔ∏è</button>
        </div>
        <div class="config-row">
          <div class="form-group"><label class="form-label">Nombre</label><input type="text" class="form-input" id="ej-nombre"></div>
          <div class="form-group" style="max-width:155px;"><label class="form-label">Inicio</label><input type="date" class="form-input" id="ej-inicio"></div>
          <div class="form-group" style="max-width:155px;"><label class="form-label">Fin</label><input type="date" class="form-input" id="ej-fin"></div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs" id="tabs-fin" style="display:none;">
        <button class="tab active" onclick="cambiarTab('presupuesto')">üìã Presupuesto</button>
        <button class="tab" onclick="cambiarTab('realizado')">üìä Realizado</button>
      </div>

      <!-- TAB PRESUPUESTO -->
      <div class="tab-content active" id="tab-presupuesto">
        <div class="resumen-grid" id="resumen-pto"></div>
        <div class="card">
          <div class="card-title">üìã Partidas presupuestadas <span style="flex:1"></span>
            <button class="btn btn-sm btn-addon" onclick="abrirModalPartida()">+ Partida</button>
          </div>
          <div id="pto-container"></div>
        </div>
      </div>

      <!-- TAB REALIZADO -->
      <div class="tab-content" id="tab-realizado">
        <div class="resumen-grid" id="resumen-real"></div>
        <div class="card">
          <div class="card-title">üìä Ejecuci√≥n presupuestaria <span style="flex:1"></span>
            <button class="btn btn-sm btn-addon" onclick="abrirModalRegistro()">+ Registro</button>
          </div>
          <div id="real-container"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Ejercicio -->
  <div class="modal-overlay" id="modal-ejercicio">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">üìã Nuevo ejercicio</h3><button class="modal-close" onclick="cerrarModales()">√ó</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="new-ej-nombre" placeholder="Ej: Ejercicio 2025-2026"></div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Inicio *</label><input type="date" class="form-input" id="new-ej-inicio"></div>
          <div class="form-group"><label class="form-label">Fin *</label><input type="date" class="form-input" id="new-ej-fin"></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button><button class="btn btn-addon" onclick="crearEjercicio()">Crear</button></div>
    </div>
  </div>

  <!-- Modal Partida -->
  <div class="modal-overlay" id="modal-partida">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="modal-part-title">üìù Nueva partida</h3><button class="modal-close" onclick="cerrarModales()">√ó</button></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Apartado *</label>
          <select class="form-select" id="part-grupo" onchange="actualizarSubgrupos()">
            <option value="ventas">üíö Ventas</option>
            <option value="costes">üü° Costes</option>
            <option value="personal">üîµ Personal</option>
            <option value="otros">üî¥ Otros gastos</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Grupo *</label>
          <div class="subgrupo-input-wrap">
            <div class="form-group">
              <select class="form-select" id="part-subgrupo-sel"></select>
            </div>
            <span class="subgrupo-toggle" id="toggle-new-sub" onclick="toggleNuevoSubgrupo()">+ Nuevo</span>
          </div>
          <input type="text" class="form-input" id="part-subgrupo-new" placeholder="Nombre del nuevo grupo" style="display:none;margin-top:6px;">
        </div>
        <div class="form-group"><label class="form-label">Concepto *</label><input type="text" class="form-input" id="part-concepto" placeholder="Ej: Venta aceituna, Jornales poda..."></div>
        <div class="form-group"><label class="form-label">Importe previsto (‚Ç¨) *</label><input type="number" class="form-input" id="part-importe" min="0" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label class="form-label">Notas</label><textarea class="form-textarea" id="part-notas" rows="2" placeholder="Detalles..."></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-danger btn-sm" id="btn-del-part" onclick="eliminarPartida()" style="display:none;">Eliminar</button>
        <button class="btn btn-addon" onclick="guardarPartida()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Registro -->
  <div class="modal-overlay" id="modal-registro">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="modal-reg-title">üìä Nuevo registro</h3><button class="modal-close" onclick="cerrarModales()">√ó</button></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Partida *</label>
          <select class="form-select" id="reg-partida"></select>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Fecha *</label><input type="date" class="form-input" id="reg-fecha"></div>
          <div class="form-group"><label class="form-label">Importe (‚Ç¨) *</label><input type="number" class="form-input" id="reg-importe" min="0" step="0.01" placeholder="0.00"></div>
        </div>
        <div class="form-group"><label class="form-label">Concepto</label><input type="text" class="form-input" id="reg-concepto" placeholder="Ej: Factura Endesa, Pago jornales..."></div>
        <div class="form-group"><label class="form-label">Notas</label><textarea class="form-textarea" id="reg-notas" rows="2" placeholder="N¬∫ factura, proveedor..."></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-danger btn-sm" id="btn-del-reg" onclick="eliminarRegistro()" style="display:none;">Eliminar</button>
        <button class="btn btn-addon" onclick="guardarRegistro()">Guardar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ===== CONFIG =====
    const GRUPOS = {
      ventas:   { icon: 'üíö', nombre: 'Ventas',       color: '#7DB59A' },
      costes:   { icon: 'üü°', nombre: 'Costes',       color: '#E8B44D' },
      personal: { icon: 'üîµ', nombre: 'Personal',     color: '#5B9BD5' },
      otros:    { icon: 'üî¥', nombre: 'Otros gastos',  color: '#D4695A' }
    };
    const GK = ['ventas', 'costes', 'personal', 'otros'];

    const params = new URLSearchParams(window.location.search);
    const bienId = params.get('id');
    const origen = params.get('origen') || 'capataz';

    if (origen === 'gerente') {
      document.documentElement.style.setProperty('--addon-color', 'var(--gerente)');
      document.documentElement.style.setProperty('--addon-light', 'var(--gerente-light)');
      document.documentElement.style.setProperty('--addon-dark', 'var(--gerente-dark)');
      document.documentElement.style.setProperty('--addon-muted', 'var(--gerente-muted)');
    }

    let currentUser = null, bienData = null, ejercicios = [], ej = null;
    let editPartId = null, editRegId = null, configVis = false;
    let expanded = {};

    if (!bienId) { alert('Falta bien'); window.location.href = 'lo-comun.html'; }
    document.getElementById('btn-volver').href = `${origen}.html?id=${bienId}`;

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarBien();
      await cargarEjercicios();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('contenido').style.display = '';
    });

    // ===== DATA =====
    async function cargarBien() {
      try { const d = await db.collection('bienes').doc(bienId).get(); if (d.exists) { bienData = d.data(); document.getElementById('nombre-bien').textContent = bienData.nombre || ''; } } catch(e) { console.error(e); }
    }

    async function cargarEjercicios() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('ejercicios').orderBy('inicio', 'desc').get();
        ejercicios = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderSelector();
      } catch(e) { console.error(e); }
    }

    function renderSelector() {
      const sel = document.getElementById('sel-ejercicio');
      const prev = sel.value;
      sel.innerHTML = '<option value="">‚Äî Selecciona ejercicio ‚Äî</option>';
      ejercicios.forEach(e => { sel.innerHTML += `<option value="${e.id}">${e.nombre} (${fD(e.inicio)} ‚Üí ${fD(e.fin)})</option>`; });
      if (prev && ejercicios.find(e => e.id === prev)) sel.value = prev;
      else if (ejercicios.length) sel.value = ejercicios[0].id;
      seleccionarEjercicio();
    }

    function seleccionarEjercicio() {
      const id = document.getElementById('sel-ejercicio').value;
      ej = ejercicios.find(e => e.id === id) || null;
      const hay = !!ej;
      document.getElementById('btn-config-ej').style.display = hay ? '' : 'none';
      document.getElementById('tabs-fin').style.display = hay ? '' : 'none';
      ['tab-presupuesto', 'tab-realizado'].forEach(t => { if (!hay) document.getElementById(t).style.display = 'none'; });
      document.getElementById('card-config').style.display = 'none'; configVis = false;
      if (hay) {
        document.getElementById('ej-nombre').value = ej.nombre || '';
        document.getElementById('ej-inicio').value = ej.inicio || '';
        document.getElementById('ej-fin').value = ej.fin || '';
        GK.forEach(g => { if (expanded[g] === undefined) expanded[g] = true; });
        renderPto();
        renderReal();
      }
    }

    // ===== HELPERS =====
    function PP() { return ej?.partidas || []; }
    function RR() { return ej?.registros || []; }
    function sumG(g) { return PP().filter(p => p.grupo === g).reduce((s, p) => s + (parseFloat(p.importe) || 0), 0); }
    function realByPart(pid) { return RR().filter(r => r.partidaId === pid).reduce((s, r) => s + (parseFloat(r.importe) || 0), 0); }
    function realByGrupo(g) { let t = 0; PP().filter(p => p.grupo === g).forEach(p => { t += realByPart(p.id); }); return t; }
    function resultado(sums) { return (sums.ventas || 0) - (sums.costes || 0) - (sums.personal || 0) - (sums.otros || 0); }
    function subsDeGrupo(grupo) {
      const s = new Set();
      PP().filter(p => p.grupo === grupo).forEach(p => { if (p.subgrupo) s.add(p.subgrupo); });
      return Array.from(s).sort();
    }

    // ===== RENDER PRESUPUESTO =====
    function renderPto() {
      if (!ej) return;
      const partidas = PP();
      const sums = {}; GK.forEach(g => { sums[g] = sumG(g); });
      const res = resultado(sums);

      document.getElementById('resumen-pto').innerHTML = GK.map(g =>
        `<div class="resumen-item ${g}"><div class="resumen-label">${GRUPOS[g].nombre}</div>
        <div class="resumen-valor">${fN(sums[g])}</div>
        <div class="resumen-count">${partidas.filter(p => p.grupo === g).length} partidas</div></div>`
      ).join('') + `<div class="resumen-item resultado"><div class="resumen-label">Resultado</div>
        <div class="resumen-valor" style="color:${res >= 0 ? 'var(--success)' : 'var(--error)'}">${fN(res)}</div>
        <div class="resumen-count">Ventas ‚àí Costes ‚àí Pers. ‚àí Otros</div></div>`;

      const c = document.getElementById('pto-container');
      if (!partidas.length) {
        c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-title">Sin partidas</div>
          <div class="empty-state-text">Define las partidas de ingresos y gastos previstos</div>
          <button class="btn btn-addon" onclick="abrirModalPartida()">+ Primera partida</button></div>`;
        return;
      }

      c.innerHTML = GK.map(g => {
        const items = partidas.filter(p => p.grupo === g);
        if (!items.length) return '';
        const subs = subsDeGrupo(g);
        const gExp = expanded[g] !== false;

        let body = subs.map(sub => {
          const si = items.filter(p => p.subgrupo === sub);
          const subTotal = si.reduce((s, p) => s + (parseFloat(p.importe) || 0), 0);
          const sk = g + '/' + sub;
          const sExp = expanded[sk] !== false;
          return `<div class="subgrupo-section">
            <div class="subgrupo-header" onclick="tog('${sk}')">
              <div class="subgrupo-header-left">
                <span style="font-size:0.8rem;">${sExp ? '‚ñæ' : '‚ñ∏'}</span>
                <span class="subgrupo-header-name">üìÅ ${sub}</span>
                <span class="subgrupo-header-count">(${si.length})</span>
              </div>
              <span class="subgrupo-header-total">${fN(subTotal)} ‚Ç¨</span>
            </div>
            <div class="subgrupo-body ${sExp ? '' : 'collapsed'}" id="sp-${css(sk)}">
              ${si.sort((a,b) => (a.concepto||'').localeCompare(b.concepto||'')).map(p =>
                `<div class="partida-row" onclick="editarPartida('${p.id}')">
                  <div style="flex:1;"><div class="partida-concepto">${p.concepto}</div>${p.notas ? `<div class="partida-notas">${p.notas}</div>` : ''}</div>
                  <div class="partida-importe">${fN(p.importe)} ‚Ç¨</div>
                </div>`).join('')}
            </div>
          </div>`;
        }).join('');

        // Sin subgrupo
        const sinSub = items.filter(p => !p.subgrupo);
        if (sinSub.length) {
          body += sinSub.map(p =>
            `<div class="partida-row" style="margin-left:12px;" onclick="editarPartida('${p.id}')">
              <div style="flex:1;"><div class="partida-concepto">${p.concepto} <span style="font-size:0.7rem;color:var(--text-muted);">(sin grupo)</span></div></div>
              <div class="partida-importe">${fN(p.importe)} ‚Ç¨</div>
            </div>`).join('');
        }

        return `<div class="grupo-section">
          <div class="grupo-header ${g}" onclick="tog('${g}')">
            <div class="grupo-header-left">
              <span class="grupo-header-icon">${GRUPOS[g].icon}</span>
              <span class="grupo-header-name">${GRUPOS[g].nombre}</span>
              <span class="grupo-header-count">(${items.length})</span>
            </div>
            <span class="grupo-header-total">${fN(sums[g])} ‚Ç¨</span>
          </div>
          <div class="grupo-body ${gExp ? '' : 'collapsed'}" id="gp-${g}">${body}</div>
        </div>`;
      }).join('') + `<div class="resultado-row"><span class="resultado-label">RESULTADO PREVISTO</span>
        <span class="resultado-valor" style="color:${res >= 0 ? 'var(--success)' : 'var(--error)'}">${fN(res)} ‚Ç¨</span></div>`;
    }

    // ===== RENDER REALIZADO =====
    function renderReal() {
      if (!ej) return;
      const partidas = PP(), registros = RR();
      const sumsPto = {}, sumsReal = {};
      GK.forEach(g => { sumsPto[g] = sumG(g); sumsReal[g] = realByGrupo(g); });
      const resPto = resultado(sumsPto), resReal = resultado(sumsReal);

      document.getElementById('resumen-real').innerHTML = GK.map(g => {
        const pct = sumsPto[g] > 0 ? (sumsReal[g] / sumsPto[g] * 100) : 0;
        return `<div class="resumen-item ${g}"><div class="resumen-label">${GRUPOS[g].nombre}</div>
          <div class="resumen-valor">${fN(sumsReal[g])}</div>
          <div class="resumen-count">Pto: ${fN(sumsPto[g])} ¬∑ ${pct.toFixed(0)}%</div></div>`;
      }).join('') + `<div class="resumen-item resultado"><div class="resumen-label">Resultado</div>
        <div class="resumen-valor" style="color:${resReal >= 0 ? 'var(--success)' : 'var(--error)'}">${fN(resReal)}</div>
        <div class="resumen-count">Pto: ${fN(resPto)}</div></div>`;

      const c = document.getElementById('real-container');
      if (!partidas.length) {
        c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìä</div><div class="empty-state-title">Sin partidas</div>
          <div class="empty-state-text">Define primero las partidas en Presupuesto</div></div>`;
        return;
      }

      c.innerHTML = GK.map(g => {
        const items = partidas.filter(p => p.grupo === g);
        if (!items.length) return '';
        const subs = subsDeGrupo(g);
        const gExp = expanded[g] !== false;

        let body = subs.map(sub => {
          const si = items.filter(p => p.subgrupo === sub);
          const sk = g + '/' + sub;
          const sExp = expanded[sk] !== false;
          const subPto = si.reduce((s, p) => s + (parseFloat(p.importe) || 0), 0);
          const subReal = si.reduce((s, p) => s + realByPart(p.id), 0);
          return `<div class="subgrupo-section">
            <div class="subgrupo-header" onclick="tog('${sk}')">
              <div class="subgrupo-header-left">
                <span style="font-size:0.8rem;">${sExp ? '‚ñæ' : '‚ñ∏'}</span>
                <span class="subgrupo-header-name">üìÅ ${sub}</span>
              </div>
              <span class="subgrupo-header-total">${fN(subReal)} / ${fN(subPto)} ‚Ç¨</span>
            </div>
            <div class="subgrupo-body ${sExp ? '' : 'collapsed'}" id="sr-${css(sk)}">
              ${si.sort((a,b) => (a.concepto||'').localeCompare(b.concepto||'')).map(p => renderPartReal(p)).join('')}
            </div>
          </div>`;
        }).join('');

        const sinSub = items.filter(p => !p.subgrupo);
        if (sinSub.length) body += sinSub.map(p => `<div style="margin-left:12px;">${renderPartReal(p)}</div>`).join('');

        return `<div class="grupo-section">
          <div class="grupo-header ${g}" onclick="tog('${g}')">
            <div class="grupo-header-left">
              <span class="grupo-header-icon">${GRUPOS[g].icon}</span>
              <span class="grupo-header-name">${GRUPOS[g].nombre}</span>
            </div>
            <span class="grupo-header-total">${fN(sumsReal[g])} / ${fN(sumsPto[g])} ‚Ç¨</span>
          </div>
          <div class="grupo-body ${gExp ? '' : 'collapsed'}" id="gr-${g}">${body}</div>
        </div>`;
      }).join('') + `<div class="resultado-row">
        <div><span class="resultado-label">RESULTADO REAL</span><div style="font-size:0.75rem;color:var(--text-muted);">Previsto: ${fN(resPto)} ‚Ç¨</div></div>
        <span class="resultado-valor" style="color:${resReal >= 0 ? 'var(--success)' : 'var(--error)'}">${fN(resReal)} ‚Ç¨</span></div>`;
    }

    function renderPartReal(p) {
      const real = realByPart(p.id);
      const pto = parseFloat(p.importe) || 0;
      const pct = pto > 0 ? (real / pto * 100) : (real > 0 ? 100 : 0);
      const bar = pct <= 75 ? 'ok' : pct <= 100 ? 'warn' : 'over';
      const regs = RR().filter(r => r.partidaId === p.id).sort((a,b) => (b.fecha||'').localeCompare(a.fecha||''));
      const rid = 'rg-' + p.id;

      return `<div style="border-bottom:1px solid var(--cream-dark);padding:4px 0;">
        <div class="partida-row" style="border:none;cursor:pointer;" onclick="togVis('${rid}')">
          <div style="flex:1;"><div class="partida-concepto">${p.concepto}</div><div class="partida-notas">Pto: ${fN(pto)} ‚Ç¨ ¬∑ ${regs.length} reg.</div></div>
          <div class="partida-real-info">
            <div class="progress-bar"><div class="progress-fill ${bar}" style="width:${Math.min(pct, 100)}%"></div></div>
            <span class="partida-pct" style="${pct > 100 ? 'color:var(--error)' : ''}">${pct.toFixed(0)}%</span>
            <span class="partida-real-amount">${fN(real)} ‚Ç¨</span>
          </div>
        </div>
        <div class="registros-list" id="${rid}" style="display:none;">
          ${regs.length ? regs.map(r => `<div class="registro-item">
            <span class="registro-fecha">${fD(r.fecha)}</span>
            <span class="registro-concepto">${r.concepto || '‚Äî'}</span>
            <span class="registro-importe">${fN(r.importe)} ‚Ç¨</span>
            <button class="btn-ghost" style="font-size:0.72rem;padding:2px 5px;" onclick="event.stopPropagation();editarRegistro('${r.id}')">‚úèÔ∏è</button>
          </div>`).join('') : '<div style="font-size:0.8rem;color:var(--text-muted);padding:4px 10px;">Sin registros</div>'}
          <button class="btn btn-sm btn-secondary" style="margin:6px 0 4px 8px;" onclick="event.stopPropagation();abrirModalRegistro('${p.id}')">+ Registro</button>
        </div>
      </div>`;
    }

    // ===== TOGGLE =====
    function tog(key) { expanded[key] = expanded[key] === false; renderPto(); renderReal(); }
    function togVis(id) { const el = document.getElementById(id); if (el) el.style.display = el.style.display === 'none' ? '' : 'none'; }
    function toggleConfig() { configVis = !configVis; document.getElementById('card-config').style.display = configVis ? '' : 'none'; }

    // ===== TABS =====
    function cambiarTab(t) {
      document.querySelectorAll('.tab').forEach((b, i) => b.classList.toggle('active', i === (t === 'presupuesto' ? 0 : 1)));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const el = document.getElementById('tab-' + t); el.classList.add('active'); el.style.display = '';
    }

    // ===== CRUD EJERCICIO =====
    function abrirModalEjercicio() {
      const yr = new Date().getFullYear();
      document.getElementById('new-ej-nombre').value = `Ejercicio ${yr}`;
      document.getElementById('new-ej-inicio').value = `${yr}-01-01`;
      document.getElementById('new-ej-fin').value = `${yr}-12-31`;
      document.getElementById('modal-ejercicio').classList.add('active');
    }

    async function crearEjercicio() {
      const n = document.getElementById('new-ej-nombre').value.trim();
      const i = document.getElementById('new-ej-inicio').value;
      const f = document.getElementById('new-ej-fin').value;
      if (!n || !i || !f) { alert('Rellena todo'); return; }
      try {
        const ref = await db.collection('bienes').doc(bienId).collection('ejercicios').add({
          nombre: n, inicio: i, fin: f, partidas: [], registros: [],
          creadoPor: currentUser.uid, fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        cerrarModales(); await cargarEjercicios();
        document.getElementById('sel-ejercicio').value = ref.id; seleccionarEjercicio();
      } catch(e) { console.error(e); alert('Error'); }
    }

    async function guardarConfigEj() {
      if (!ej) return;
      const n = document.getElementById('ej-nombre').value.trim();
      const i = document.getElementById('ej-inicio').value;
      const f = document.getElementById('ej-fin').value;
      if (!n) { alert('Nombre obligatorio'); return; }
      try {
        await db.collection('bienes').doc(bienId).collection('ejercicios').doc(ej.id).update({ nombre: n, inicio: i, fin: f });
        ej.nombre = n; ej.inicio = i; ej.fin = f; renderSelector(); alert('‚úÖ Guardado');
      } catch(e) { console.error(e); }
    }

    async function eliminarEjercicio() {
      if (!ej || !confirm(`¬øEliminar "${ej.nombre}"?`)) return;
      try { await db.collection('bienes').doc(bienId).collection('ejercicios').doc(ej.id).delete(); ej = null; await cargarEjercicios(); } catch(e) { console.error(e); }
    }

    // ===== CRUD PARTIDAS =====
    function actualizarSubgrupos() {
      const g = document.getElementById('part-grupo').value;
      const subs = subsDeGrupo(g);
      const sel = document.getElementById('part-subgrupo-sel');
      sel.innerHTML = subs.length ? subs.map(s => `<option value="${s}">${s}</option>`).join('') : '<option value="">‚Äî Crea un grupo ‚Üí</option>';
      document.getElementById('part-subgrupo-new').style.display = subs.length ? 'none' : '';
      document.getElementById('toggle-new-sub').textContent = subs.length ? '+ Nuevo' : '';
    }

    function toggleNuevoSubgrupo() {
      const inp = document.getElementById('part-subgrupo-new');
      const vis = inp.style.display !== 'none';
      inp.style.display = vis ? 'none' : '';
      document.getElementById('toggle-new-sub').textContent = vis ? '+ Nuevo' : 'Existente';
      if (!vis) inp.focus();
    }

    function abrirModalPartida(partida) {
      editPartId = partida?.id || null;
      document.getElementById('modal-part-title').textContent = partida ? '‚úèÔ∏è Editar partida' : 'üìù Nueva partida';
      document.getElementById('btn-del-part').style.display = partida ? '' : 'none';
      document.getElementById('part-grupo').value = partida?.grupo || 'ventas';
      actualizarSubgrupos();
      if (partida?.subgrupo) {
        const sel = document.getElementById('part-subgrupo-sel');
        // Asegurar que la opci√≥n existe
        if (![...sel.options].find(o => o.value === partida.subgrupo)) {
          sel.innerHTML += `<option value="${partida.subgrupo}">${partida.subgrupo}</option>`;
        }
        sel.value = partida.subgrupo;
      }
      document.getElementById('part-subgrupo-new').value = '';
      document.getElementById('part-subgrupo-new').style.display = 'none';
      document.getElementById('toggle-new-sub').textContent = '+ Nuevo';
      document.getElementById('part-concepto').value = partida?.concepto || '';
      document.getElementById('part-importe').value = partida?.importe || '';
      document.getElementById('part-notas').value = partida?.notas || '';
      document.getElementById('modal-partida').classList.add('active');
    }

    function editarPartida(id) { const p = PP().find(x => x.id === id); if (p) abrirModalPartida(p); }

    async function guardarPartida() {
      if (!ej) return;
      const grupo = document.getElementById('part-grupo').value;
      const newSub = document.getElementById('part-subgrupo-new');
      const subgrupo = (newSub.style.display !== 'none' && newSub.value.trim()) ? newSub.value.trim() : document.getElementById('part-subgrupo-sel').value;
      const concepto = document.getElementById('part-concepto').value.trim();
      const importe = parseFloat(document.getElementById('part-importe').value) || 0;
      const notas = document.getElementById('part-notas').value.trim();

      if (!subgrupo) { alert('Selecciona o crea un grupo'); return; }
      if (!concepto) { alert('Concepto obligatorio'); return; }
      if (importe <= 0) { alert('Importe > 0'); return; }

      let partidas = [...PP()];
      if (editPartId) {
        const idx = partidas.findIndex(p => p.id === editPartId);
        if (idx >= 0) partidas[idx] = { ...partidas[idx], grupo, subgrupo, concepto, importe, notas };
      } else {
        partidas.push({ id: 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4), grupo, subgrupo, concepto, importe, notas });
      }
      try {
        await db.collection('bienes').doc(bienId).collection('ejercicios').doc(ej.id).update({ partidas });
        ej.partidas = partidas; cerrarModales(); renderPto(); renderReal();
      } catch(e) { console.error(e); alert('Error'); }
    }

    async function eliminarPartida() {
      if (!editPartId || !ej) return;
      const regs = RR().filter(r => r.partidaId === editPartId);
      if (!confirm(regs.length ? `Tiene ${regs.length} registro(s). ¬øEliminar todo?` : '¬øEliminar partida?')) return;
      const partidas = PP().filter(p => p.id !== editPartId);
      const registros = RR().filter(r => r.partidaId !== editPartId);
      try {
        await db.collection('bienes').doc(bienId).collection('ejercicios').doc(ej.id).update({ partidas, registros });
        ej.partidas = partidas; ej.registros = registros; cerrarModales(); renderPto(); renderReal();
      } catch(e) { console.error(e); }
    }

    // ===== CRUD REGISTROS =====
    function poblarSelPartidas(sel, preselect) {
      sel.innerHTML = '';
      GK.forEach(g => {
        const items = PP().filter(p => p.grupo === g);
        if (!items.length) return;
        sel.innerHTML += `<optgroup label="${GRUPOS[g].icon} ${GRUPOS[g].nombre}">`;
        const subs = subsDeGrupo(g);
        subs.forEach(sub => {
          items.filter(p => p.subgrupo === sub).forEach(p => {
            sel.innerHTML += `<option value="${p.id}" ${p.id === preselect ? 'selected' : ''}>${sub} ‚Üí ${p.concepto}</option>`;
          });
        });
        items.filter(p => !p.subgrupo).forEach(p => {
          sel.innerHTML += `<option value="${p.id}" ${p.id === preselect ? 'selected' : ''}>${p.concepto}</option>`;
        });
        sel.innerHTML += `</optgroup>`;
      });
    }

    function abrirModalRegistro(partidaId) {
      editRegId = null;
      document.getElementById('modal-reg-title').textContent = 'üìä Nuevo registro';
      document.getElementById('btn-del-reg').style.display = 'none';
      poblarSelPartidas(document.getElementById('reg-partida'), partidaId || '');
      document.getElementById('reg-fecha').value = new Date().toISOString().split('T')[0];
      document.getElementById('reg-importe').value = '';
      document.getElementById('reg-concepto').value = '';
      document.getElementById('reg-notas').value = '';
      document.getElementById('modal-registro').classList.add('active');
    }

    function editarRegistro(id) {
      const r = RR().find(x => x.id === id);
      if (!r) return;
      editRegId = id;
      document.getElementById('modal-reg-title').textContent = '‚úèÔ∏è Editar registro';
      document.getElementById('btn-del-reg').style.display = '';
      poblarSelPartidas(document.getElementById('reg-partida'), r.partidaId);
      document.getElementById('reg-fecha').value = r.fecha || '';
      document.getElementById('reg-importe').value = r.importe || '';
      document.getElementById('reg-concepto').value = r.concepto || '';
      document.getElementById('reg-notas').value = r.notas || '';
      document.getElementById('modal-registro').classList.add('active');
    }

    async function guardarRegistro() {
      if (!ej) return;
      const partidaId = document.getElementById('reg-partida').value;
      const fecha = document.getElementById('reg-fecha').value;
      const importe = parseFloat(document.getElementById('reg-importe').value) || 0;
      const concepto = document.getElementById('reg-concepto').value.trim();
      const notas = document.getElementById('reg-notas').value.trim();
      if (!partidaId || !fecha || importe <= 0) { alert('Partida, fecha e importe obligatorios'); return; }

      let registros = [...RR()];
      if (editRegId) {
        const idx = registros.findIndex(r => r.id === editRegId);
        if (idx >= 0) registros[idx] = { ...registros[idx], partidaId, fecha, importe, concepto, notas };
      } else {
        registros.push({ id: 'r_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4), partidaId, fecha, importe, concepto, notas });
      }
      try {
        await db.collection('bienes').doc(bienId).collection('ejercicios').doc(ej.id).update({ registros });
        ej.registros = registros; cerrarModales(); renderReal();
      } catch(e) { console.error(e); alert('Error'); }
    }

    async function eliminarRegistro() {
      if (!editRegId || !ej || !confirm('¬øEliminar registro?')) return;
      const registros = RR().filter(r => r.id !== editRegId);
      try {
        await db.collection('bienes').doc(bienId).collection('ejercicios').doc(ej.id).update({ registros });
        ej.registros = registros; cerrarModales(); renderReal();
      } catch(e) { console.error(e); }
    }

    // ===== PDF =====
    function exportarPDF() {
      if (!ej) { alert('Selecciona ejercicio'); return; }
      const isReal = document.querySelectorAll('.tab')[1]?.classList.contains('active');
      const ac = origen === 'gerente' ? '#2D4A5C' : '#6B8E23';
      const partidas = PP();

      const sumsPto = {}, sumsReal = {};
      GK.forEach(g => { sumsPto[g] = sumG(g); sumsReal[g] = realByGrupo(g); });

      let html = '';
      GK.forEach(g => {
        const items = partidas.filter(p => p.grupo === g);
        if (!items.length) return;
        const gc = GRUPOS[g].color;
        html += `<h3 style="color:${gc};margin:20px 0 8px;">${GRUPOS[g].icon} ${GRUPOS[g].nombre}</h3>`;

        subsDeGrupo(g).forEach(sub => {
          const si = items.filter(p => p.subgrupo === sub);
          if (!si.length) return;
          html += `<div style="margin-left:8px;margin-bottom:12px;">
            <div style="font-weight:700;font-size:0.88rem;margin-bottom:4px;">üìÅ ${sub}</div>
            <table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#f5f0ea;">
              <th style="padding:6px 10px;text-align:left;font-size:0.72rem;text-transform:uppercase;color:#9A9A9A;">Concepto</th>
              <th style="padding:6px 10px;text-align:right;font-size:0.72rem;text-transform:uppercase;color:#9A9A9A;">Presupuesto</th>`;
          if (isReal) html += `<th style="text-align:right;padding:6px 10px;font-size:0.72rem;text-transform:uppercase;color:#9A9A9A;">Realizado</th><th style="text-align:right;padding:6px 10px;font-size:0.72rem;text-transform:uppercase;color:#9A9A9A;">%</th>`;
          html += `</tr></thead><tbody>`;
          let sp = 0, sr = 0;
          si.forEach(p => {
            const pto = parseFloat(p.importe) || 0, real = realByPart(p.id);
            const pct = pto > 0 ? (real / pto * 100) : 0;
            sp += pto; sr += real;
            html += `<tr><td style="padding:5px 10px;border-bottom:1px solid #eee;">${p.concepto}</td><td style="padding:5px 10px;text-align:right;border-bottom:1px solid #eee;">${fN(pto)} ‚Ç¨</td>`;
            if (isReal) html += `<td style="text-align:right;border-bottom:1px solid #eee;font-weight:600;">${fN(real)} ‚Ç¨</td><td style="text-align:center;border-bottom:1px solid #eee;">${pct.toFixed(0)}%</td>`;
            html += `</tr>`;
          });
          html += `<tr style="background:${gc}15;font-weight:700;"><td style="padding:6px 10px;">Subtotal ${sub}</td><td style="text-align:right;padding:6px 10px;">${fN(sp)} ‚Ç¨</td>`;
          if (isReal) html += `<td style="text-align:right;">${fN(sr)} ‚Ç¨</td><td></td>`;
          html += `</tr></tbody></table></div>`;
        });
      });

      const resPto = resultado(sumsPto), resReal = resultado(sumsReal);
      const pdf = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Finanzas - ${ej.nombre}</title>
<style>@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Nunito',sans-serif;color:#3D3D3D;padding:40px;max-width:800px;margin:0 auto}
@media print{body{padding:20px}}</style></head><body>
<div style="display:flex;justify-content:space-between;margin-bottom:24px;padding-bottom:14px;border-bottom:3px solid ${ac};">
  <div><h1 style="font-family:'Quicksand';font-size:1.4rem;color:${ac};">FINANZAS ‚Äî ${isReal ? 'PTO vs REALIZADO' : 'PRESUPUESTO'}</h1>
  <div style="font-size:0.88rem;color:#6B6B6B;">${bienData?.nombre || ''}</div></div>
  <div style="text-align:right;font-size:0.85rem;color:#6B6B6B;"><strong>${ej.nombre}</strong><br>${fD(ej.inicio)} ‚Üí ${fD(ej.fin)}</div>
</div>
${html}
<div style="margin-top:20px;padding:16px;background:${ac}15;border-radius:8px;display:flex;justify-content:space-between;">
  <div><div style="font-size:0.75rem;color:#9A9A9A;">RESULTADO PREVISTO</div><div style="font-family:'Quicksand';font-size:1.2rem;font-weight:700;color:${resPto >= 0 ? '#7DB59A' : '#D4695A'}">${fN(resPto)} ‚Ç¨</div></div>
  ${isReal ? `<div style="text-align:right;"><div style="font-size:0.75rem;color:#9A9A9A;">RESULTADO REAL</div><div style="font-family:'Quicksand';font-size:1.2rem;font-weight:700;color:${resReal >= 0 ? '#7DB59A' : '#D4695A'}">${fN(resReal)} ‚Ç¨</div></div>` : ''}
</div>
<div style="margin-top:40px;text-align:center;font-size:0.7rem;color:#9A9A9A;">FAMILYNK ¬∑ ${new Date().toLocaleDateString('es-ES')}</div>
<script>window.onload = () => window.print();<\/script></body></html>`;
      const v = window.open('', '_blank'); v.document.write(pdf); v.document.close();
    }

    // ===== UTILS =====
    function cerrarModales() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); editPartId = null; editRegId = null; }
    function fD(f) { if (!f) return '‚Äî'; const d = new Date(f + 'T00:00:00'); return d.toLocaleDateString('es-ES', { day:'2-digit', month:'short', year:'numeric' }); }
    function fN(n) { return (parseFloat(n) || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function css(s) { return s.replace(/[^a-zA-Z0-9]/g, '-'); }
    document.querySelectorAll('.modal-overlay').forEach(m => { m.addEventListener('click', e => { if (e.target.classList.contains('modal-overlay')) cerrarModales(); }); });
  </script>
</body>
</html>
