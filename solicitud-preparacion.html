<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Solicitud de preparaci√≥n</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E; --sage-dark: #5C7D5F; --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3; --cream-dark: #F5EDE4;
      --terracotta: #C17757; --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A;
      --white: #FFFFFF; --success: #7DB59A; --warning: #E8B44D; --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06); --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
      --mayordomo: #8B7355; --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --solicitud: #7E57C2; --solicitud-muted: rgba(126, 87, 194, 0.12);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; padding-bottom: 100px; }

    /* ========== HEADER ========== */
    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky; top: 0; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      padding: 8px 14px; background: var(--cream); border-radius: var(--radius-md);
      font-size: 0.85rem; color: var(--text-light); text-decoration: none;
    }
    .back-btn:hover { background: var(--cream-dark); }
    .page-title { font-family: 'Quicksand', sans-serif; font-size: 1.2rem; font-weight: 600; }
    .header-badge {
      padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
      background: var(--solicitud-muted); color: var(--solicitud);
    }

    /* ========== LAYOUT ========== */
    .main { max-width: 800px; margin: 0 auto; padding: 24px; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 80px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--solicitud); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* ========== INFO CARD ========== */
    .info-card {
      background: var(--white); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft); padding: 24px; margin-bottom: 24px;
    }
    .info-card-title {
      font-family: 'Quicksand', sans-serif; font-size: 1.05rem; font-weight: 600;
      margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
      padding-bottom: 12px; border-bottom: 2px solid var(--cream-dark);
    }

    /* ========== DIVIDER ========== */
    .divider {
      display: flex; align-items: center; gap: 12px; margin: 32px 0 12px;
    }
    .divider-line { flex: 1; height: 2px; background: var(--cream-dark); }
    .divider-title {
      font-family: 'Quicksand', sans-serif; font-size: 1rem; font-weight: 600; color: var(--solicitud);
    }
    .divider-helper {
      font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px; text-align: center;
      padding: 12px; background: var(--solicitud-muted); border-radius: var(--radius-md);
    }

    /* ========== MULTI-SEMANA BADGE ========== */
    .multi-semana-badge {
      display: none; padding: 10px 16px; background: #FFF3E0; border: 1px solid #FFE0B2;
      border-radius: var(--radius-md); margin-bottom: 16px; font-size: 0.85rem;
      color: #E65100; text-align: center;
    }
    .multi-semana-badge.visible { display: block; }

    /* ========== SECCIONES ========== */
    .seccion {
      background: var(--white); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft); margin-bottom: 20px; overflow: hidden;
      border: 2px solid transparent; transition: border-color 0.3s;
    }
    .seccion.seccion-error {
      border-color: #E53935;
    }
    .seccion.seccion-error .seccion-header {
      background: #FFEBEE;
    }
    .seccion-error-msg {
      display: none; font-size: 0.78rem; color: #E53935; font-weight: 600;
      margin-left: auto; padding: 2px 8px; background: #FFEBEE; border-radius: 8px;
    }
    .seccion.seccion-error .seccion-error-msg { display: inline-block; }
    .seccion-header {
      padding: 16px 20px; background: var(--cream);
      display: flex; align-items: center; justify-content: space-between; cursor: pointer;
    }
    .seccion-titulo {
      font-family: 'Quicksand', sans-serif; font-size: 1rem; font-weight: 600;
      display: flex; align-items: center; gap: 10px;
    }
    .seccion-count {
      background: var(--sage); color: var(--white);
      padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;
    }
    .seccion-toggle { color: var(--text-muted); font-size: 0.8rem; transition: transform 0.2s; }
    .seccion-body { padding: 20px; }
    .seccion-helper {
      font-size: 0.8rem; color: var(--text-muted); margin-bottom: 14px;
      padding: 10px 14px; background: var(--cream); border-radius: var(--radius-sm);
      border-left: 3px solid var(--solicitud);
    }

    /* ========== FORMS ========== */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    .form-label-hint { font-weight: 400; color: var(--text-muted); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 12px 14px; border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.95rem;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--sage); }
    .form-textarea { resize: vertical; min-height: 80px; }

    /* ========== VISIBILIDAD ========== */
    .visibilidad-selector { display: flex; gap: 8px; flex-wrap: wrap; }
    .visibilidad-option {
      flex: 1; min-width: 80px; display: flex; flex-direction: column; align-items: center;
      gap: 4px; padding: 10px 8px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md);
      cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .visibilidad-option:hover { border-color: var(--text-muted); }
    .visibilidad-option.active { border-color: var(--solicitud); background: var(--solicitud-muted); }
    .visibilidad-option input { display: none; }
    .visibilidad-icon { font-size: 1.5rem; }
    .visibilidad-label { font-size: 0.75rem; font-weight: 600; }

    /* ========== MATRICES ========== */
    .matriz { width: 100%; margin-top: 12px; overflow-x: auto; }
    .matriz table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .matriz th, .matriz td { padding: 10px 8px; text-align: center; border: 1px solid var(--cream-dark); }
    .matriz th {
      background: var(--solicitud); color: var(--white); font-weight: 600; font-size: 0.78rem;
      white-space: nowrap;
    }
    .matriz th:first-child { background: var(--cream-dark); color: var(--text); text-align: left; min-width: 100px; }
    .matriz td:first-child { background: var(--cream); font-weight: 600; text-align: left; white-space: nowrap; }
    .matriz input[type="number"] {
      width: 48px; padding: 6px; border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm); text-align: center; font-size: 0.9rem;
    }
    .matriz input[type="number"]:focus { outline: none; border-color: var(--sage); }
    .matriz-placeholder {
      text-align: center; padding: 30px; color: var(--text-muted); font-size: 0.9rem;
      background: var(--cream); border-radius: var(--radius-md);
    }

    /* ========== SLIDER TOGGLE ========== */
    .slider-toggle { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
    .slider-toggle input[type="checkbox"] {
      position: relative; width: 50px; height: 24px; appearance: none;
      background: var(--cream-dark); border-radius: 12px; cursor: pointer; transition: all 0.3s;
    }
    .slider-toggle input[type="checkbox"]::before {
      content: ''; position: absolute; top: 2px; left: 2px;
      width: 20px; height: 20px; background: var(--white); border-radius: 50%;
      transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .slider-toggle input[type="checkbox"]:checked { background: var(--terracotta); }
    .slider-toggle input[type="checkbox"]:checked::before { left: 28px; }
    .slider-label { font-size: 0.75rem; color: var(--text-muted); }

    .especial-input { margin-top: 6px; display: none; }
    .especial-input.visible { display: block; }
    .especial-input input {
      width: 100%; padding: 6px 8px; border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm); font-size: 0.8rem;
    }

    /* ========== ROLES CHIPS ========== */
    .roles-select { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; }
    .role-chip {
      padding: 4px 8px; background: var(--cream); border: 1px solid var(--cream-dark);
      border-radius: 12px; font-size: 0.7rem; cursor: pointer; transition: all 0.2s;
    }
    .role-chip:hover { border-color: var(--sage); }
    .role-chip.selected { background: var(--sage); color: var(--white); border-color: var(--sage); }

    /* ========== ZONAS ========== */
    .zona-group { margin-bottom: 16px; border: 1px solid var(--cream-dark); border-radius: var(--radius-md); overflow: hidden; }
    .zona-header {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px; background: var(--cream); cursor: pointer;
    }
    .zona-header input { width: 18px; height: 18px; accent-color: var(--sage); }
    .zona-header-label { font-weight: 600; font-size: 0.9rem; flex: 1; }
    .zona-count { font-size: 0.75rem; color: var(--text-muted); background: var(--cream-dark); padding: 2px 8px; border-radius: 10px; }
    .zona-toggle-deps { font-size: 0.75rem; color: var(--sage); padding: 4px 8px; background: var(--sage-muted); border-radius: 10px; cursor: pointer; }
    .zona-toggle-deps:hover { background: var(--sage); color: var(--white); }
    .zona-deps { padding: 12px; background: var(--white); display: none; }
    .zona-deps.visible { display: block; }
    .dep-item {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 10px; margin-bottom: 6px; background: var(--cream); border-radius: var(--radius-sm);
    }
    .dep-item input { width: 16px; height: 16px; accent-color: var(--sage); }
    .dep-item-label { font-size: 0.85rem; }
    .dep-item-tipo { font-size: 0.7rem; color: var(--text-muted); margin-left: auto; }

    /* ========== MENAJE ========== */
    .menaje-tipo {
      display: flex; align-items: center; gap: 16px;
      padding: 14px; background: var(--cream); border-radius: var(--radius-md); margin-bottom: 16px;
    }
    .menaje-tipo-label { font-weight: 600; }
    .ajuar-selector { display: none; margin-top: 12px; }
    .ajuar-selector.visible { display: block; }
    .ajuar-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 8px; max-height: 200px; overflow-y: auto;
      padding: 12px; background: var(--cream); border-radius: var(--radius-md);
    }
    .ajuar-item {
      display: flex; align-items: center; gap: 8px;
      padding: 8px; background: var(--white); border-radius: var(--radius-sm);
      font-size: 0.8rem; cursor: pointer; border: 2px solid transparent;
    }
    .ajuar-item:hover { border-color: var(--sage-muted); }
    .ajuar-item.selected { border-color: var(--sage); background: var(--sage-muted); }
    .ajuar-item input { width: 14px; height: 14px; accent-color: var(--sage); }

    /* ========== ITEMS LISTA ========== */
    .item-card {
      display: flex; align-items: flex-start; gap: 12px;
      padding: 12px 16px; background: var(--cream); border-radius: var(--radius-sm);
      margin-bottom: 10px; border-left: 3px solid var(--sage);
    }
    .item-card.compra { border-left-color: var(--terracotta); }
    .item-card.tarea { border-left-color: var(--solicitud); }
    .item-icon { font-size: 1.2rem; }
    .item-content { flex: 1; }
    .item-titulo { font-weight: 600; font-size: 0.9rem; }
    .item-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .item-descripcion { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }
    .item-actions { display: flex; gap: 4px; }
    .item-btn {
      padding: 6px 10px; background: transparent; border: none;
      border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted); font-size: 0.9rem;
    }
    .item-btn:hover { background: var(--cream-dark); color: var(--text); }
    .item-btn.delete:hover { color: var(--error); }

    .add-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      width: 100%; padding: 14px; border: 2px dashed var(--cream-dark);
      background: transparent; border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif; font-size: 0.9rem; color: var(--text-muted); cursor: pointer;
    }
    .add-btn:hover { border-color: var(--sage); color: var(--sage); background: var(--sage-muted); }

    .notas-textarea {
      width: 100%; min-height: 120px; padding: 14px;
      border: 2px solid var(--cream-dark); border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.95rem; resize: vertical;
    }
    .notas-textarea:focus { outline: none; border-color: var(--sage); }
    .empty-state { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; }

    .subseccion { padding: 12px; background: var(--cream); border-radius: var(--radius-md); }
    .subseccion-header {
      display: flex; align-items: center; gap: 8px;
      font-weight: 600; font-size: 0.9rem; margin-bottom: 12px; color: var(--text);
    }
    .subseccion-count {
      background: var(--solicitud); color: var(--white);
      padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: auto;
    }

    /* ========== FOOTER ========== */
    .footer-actions {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--white); padding: 16px 24px;
      display: flex; justify-content: center; gap: 12px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.08); z-index: 50;
    }
    .btn {
      padding: 12px 24px; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-weight: 600; font-size: 0.95rem;
      cursor: pointer; border: none; transition: all 0.2s;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--sage); color: var(--white); }
    .btn-primary:hover:not(:disabled) { background: var(--sage-dark); }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-solicitud { background: var(--solicitud); color: var(--white); }
    .btn-solicitud:hover:not(:disabled) { background: #5E35B1; }

    /* ========== MODAL ========== */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: var(--white); border-radius: var(--radius-lg);
      width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
    }
    .modal-header {
      padding: 20px 24px; border-bottom: 1px solid var(--cream-dark);
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-title { font-family: 'Quicksand', sans-serif; font-size: 1.15rem; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }
    .modal-body { padding: 24px; }
    .modal-footer {
      padding: 16px 24px; border-top: 1px solid var(--cream-dark);
      display: flex; gap: 12px; justify-content: flex-end;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      .main { padding: 16px; }
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .matriz table { min-width: 350px; }
      .page-title { font-size: 1rem; }
    }

    /* ========== PESTA√ëAS ========== */
    .tabs-bar {
      display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #E8E0D8;
      padding-bottom: 0;
    }
    .tab-btn {
      padding: 10px 20px; border: none; background: none; font-family: 'Quicksand', sans-serif;
      font-size: 0.95rem; font-weight: 600; color: var(--text-muted); cursor: pointer;
      border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--sage-dark); border-bottom-color: var(--sage); }
    .tab-btn .tab-count {
      display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 0.75rem;
      background: var(--cream-dark); color: var(--text-muted); margin-left: 6px;
    }
    .tab-btn.active .tab-count { background: var(--sage); color: white; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ========== TARJETAS MIS SOLICITUDES ========== */
    .sol-list { display: flex; flex-direction: column; gap: 12px; }
    .sol-card {
      background: white; border-radius: 12px; padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; align-items: center; gap: 16px;
      transition: transform 0.2s; cursor: pointer;
    }
    .sol-card:hover { transform: translateY(-1px); }
    .sol-indicator {
      width: 5px; height: 48px; border-radius: 3px; flex-shrink: 0;
    }
    .sol-indicator.pendiente { background: #f59e0b; }
    .sol-indicator.aprobada, .sol-indicator.confirmada { background: #22c55e; }
    .sol-indicator.borrador { background: #9CA3AF; }
    .sol-indicator.rechazada, .sol-indicator.cancelada { background: #ef4444; }
    .sol-body { flex: 1; min-width: 0; }
    .sol-nombre { font-weight: 700; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sol-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
    .sol-estado {
      padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;
    }
    .sol-estado.pendiente { background: #FEF3C7; color: #92400E; }
    .sol-estado.aprobada, .sol-estado.confirmada { background: #D1FAE5; color: #065F46; }
    .sol-estado.borrador { background: #F3F4F6; color: #6B7280; }
    .sol-estado.rechazada { background: #FEE2E2; color: #991B1B; }
    .sol-estado.cancelada { background: #FEE2E2; color: #991B1B; }
    .sol-empty {
      text-align: center; padding: 60px 20px; color: var(--text-muted);
    }
    .sol-empty-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }
    .sol-filtros {
      display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
    }
    .sol-filtro {
      padding: 6px 14px; border: 2px solid #E8E0D8; border-radius: 20px; background: white;
      font-family: 'Nunito', sans-serif; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
    }
    .sol-filtro.active { background: var(--sage); color: white; border-color: var(--sage); }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-left">
      <a href="cgi.html" class="back-btn">‚Üê CGI</a>
      <h1 class="page-title" id="page-title">üìã Reservas y Solicitudes</h1>
    </div>
    <div class="header-right">
      <span class="header-badge" id="tipo-badge">Solicitud</span>
    </div>
  </header>

  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>

    <div id="content" class="hidden">

      <!-- PESTA√ëAS -->
      <div class="tabs-bar">
        <button class="tab-btn active" onclick="cambiarPestana('mis')" id="tab-mis">
          üìÖ Mis Solicitudes <span class="tab-count" id="count-mis">0</span>
        </button>
        <button class="tab-btn" onclick="cambiarPestana('nueva')" id="tab-nueva">
          ‚ûï Nueva Solicitud
        </button>
      </div>

      <!-- PANEL: MIS SOLICITUDES -->
      <div class="tab-panel active" id="panel-mis">
        <div class="sol-filtros">
          <button class="sol-filtro active" data-filtro="todas" onclick="filtrarSolicitudes(this)">Todas</button>
          <button class="sol-filtro" data-filtro="pendiente" onclick="filtrarSolicitudes(this)">‚è≥ Pendientes</button>
          <button class="sol-filtro" data-filtro="aprobada" onclick="filtrarSolicitudes(this)">‚úÖ Aprobadas</button>
          <button class="sol-filtro" data-filtro="borrador" onclick="filtrarSolicitudes(this)">üìù Borradores</button>
        </div>
        <div id="mis-solicitudes-list" class="sol-list"></div>
        <div id="mis-solicitudes-empty" class="sol-empty" style="display:none;">
          <div class="sol-empty-icon">üìÖ</div>
          <div>No tienes solicitudes todav√≠a</div>
          <button class="btn-enviar" style="margin-top:16px;max-width:250px;" onclick="cambiarPestana('nueva')">‚ûï Crear primera solicitud</button>
        </div>
      </div>

      <!-- PANEL: NUEVA SOLICITUD (formulario existente) -->
      <div class="tab-panel" id="panel-nueva">

      <!-- ===== INFO B√ÅSICA ===== -->
      <div class="info-card">
        <div class="info-card-title" id="info-card-title">üìã Solicitud de Reserva y/o Evento</div>

        <!-- Nombre (opcional - para eventos) -->
        <div class="form-group">
          <label class="form-label">Nombre o t√≠tulo</label>
          <input type="text" class="form-input" id="sol-nombre" placeholder="Ej: Cumplea√±os de Juan, Fin de semana familiar, Barbacoa...">
        </div>

        <!-- Bien -->
        <div class="form-group">
          <label class="form-label">¬øD√≥nde? *</label>
          <select class="form-select" id="sol-bien" required>
            <option value="">Selecciona un lugar...</option>
          </select>
        </div>

        <!-- Tipo (din√°mico seg√∫n addon) -->
        <div class="form-group hidden" id="sol-tipo-container">
          <label class="form-label" id="sol-tipo-label">Tipo *</label>
          <select class="form-select" id="sol-tipo" required>
            <option value="">Selecciona tipo...</option>
          </select>
        </div>

        <!-- Qui√©n reserva (solo reservas familiares) -->
        <div class="form-group hidden" id="sol-quien-container">
          <label class="form-label">¬øQui√©n reserva? *</label>
          <select class="form-select" id="sol-quien" required>
            <option value="">Selecciona...</option>
          </select>
          <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Selecciona el nido o grupo que hace la reserva</p>
        </div>

        <!-- Fechas (siempre rango) -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Fecha inicio *</label>
            <input type="date" class="form-input" id="sol-fecha-inicio" required>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha fin *</label>
            <input type="date" class="form-input" id="sol-fecha-fin" required>
          </div>
        </div>

        <!-- Motivo / Descripci√≥n -->
        <div class="form-group">
          <label class="form-label">Motivo / Descripci√≥n</label>
          <textarea class="form-textarea" id="sol-motivo" rows="2" placeholder="Cu√©ntanos m√°s sobre tu solicitud..."></textarea>
        </div>

        <!-- Visibilidad -->
        <div class="form-group">
          <label class="form-label">¬øQui√©n puede verlo?</label>
          <div class="visibilidad-selector">
            <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this)">
              <input type="radio" name="sol-visibilidad" value="rama" checked>
              <span class="visibilidad-icon">üå≥</span>
              <span class="visibilidad-label">Rama</span>
            </label>
            <label class="visibilidad-option" onclick="seleccionarVisibilidad(this)">
              <input type="radio" name="sol-visibilidad" value="estirpe">
              <span class="visibilidad-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
              <span class="visibilidad-label">Estirpe</span>
            </label>
            <label class="visibilidad-option" onclick="seleccionarVisibilidad(this)">
              <input type="radio" name="sol-visibilidad" value="nido">
              <span class="visibilidad-icon">üè†</span>
              <span class="visibilidad-label">Nido</span>
            </label>
          </div>
        </div>
      </div>

      <!-- ===== DIVISOR: DETALLE PREPARACI√ìN ===== -->
      <div id="preparacion-wrapper">
        <div class="divider">
          <div class="divider-line"></div>
          <span class="divider-title">üìã Detalle de preparaci√≥n</span>
          <div class="divider-line"></div>
        </div>
        <div class="divider-helper">
          üí° Cuanta m√°s informaci√≥n proporciones, m√°s f√°cil ser√° preparar tu estancia.<br>
          Completa las secciones. Menaje, Producto y Tareas son opcionales.
        </div>

        <!-- Badge multi-semana -->
        <div class="multi-semana-badge" id="multi-semana-badge">
          üìÖ Tu estancia abarca <strong id="num-semanas">2</strong> semanas.
          Se generar√°n borradores de preparaci√≥n para cada una.
        </div>

        <!-- 1. Zonas a preparar -->
        <div class="seccion" id="seccion-zonas">
          <div class="seccion-header" onclick="toggleSeccion('zonas')">
            <div class="seccion-titulo">
              <span>üè†</span> Zonas a preparar
              <span class="seccion-count" id="count-zonas">0</span>
              <span class="seccion-error-msg">‚ö† Obligatorio</span>
            </div>
            <span class="seccion-toggle">‚ñº</span>
          </div>
          <div class="seccion-body" id="body-zonas">
            <div class="seccion-helper">
              Selecciona las zonas de la casa que necesitas preparar. Puedes desglosar por dependencias si lo necesitas.
            </div>
            <div id="zonas-container"><div class="empty-state">Selecciona un bien para ver sus zonas</div></div>
          </div>
        </div>

        <!-- 2. Personas -->
        <div class="seccion" id="seccion-personas">
          <div class="seccion-header" onclick="toggleSeccion('personas')">
            <div class="seccion-titulo"><span>üë•</span> Personas <span class="seccion-error-msg">‚ö† Obligatorio</span></div>
            <span class="seccion-toggle">‚ñº</span>
          </div>
          <div class="seccion-body" id="body-personas">
            <div class="seccion-helper">
              Indica cu√°ntas personas hay cada d√≠a: cu√°ntos vienen, cu√°ntos comen, cu√°ntos duermen...
            </div>
            <div id="personas-container">
              <div class="matriz-placeholder">Selecciona las fechas para ver los d√≠as</div>
            </div>
          </div>
        </div>

        <!-- 3. Men√∫s -->
        <div class="seccion" id="seccion-menus">
          <div class="seccion-header" onclick="toggleSeccion('menus')">
            <div class="seccion-titulo"><span>üçΩÔ∏è</span> Men√∫s <span class="seccion-error-msg">‚ö† Obligatorio</span></div>
            <span class="seccion-toggle">‚ñº</span>
          </div>
          <div class="seccion-body" id="body-menus">
            <div class="seccion-helper">
              Por defecto se sirve el men√∫ habitual. Activa "Especial" si quieres pedir algo concreto para alg√∫n pase.
            </div>
            <div id="menus-container">
              <div class="matriz-placeholder">Selecciona las fechas para configurar men√∫s</div>
            </div>
          </div>
        </div>

        <!-- 4. Servicio -->
        <div class="seccion" id="seccion-servicio">
          <div class="seccion-header" onclick="toggleSeccion('servicio')">
            <div class="seccion-titulo"><span>üë®‚Äçüç≥</span> Servicio <span class="seccion-error-msg">‚ö† Obligatorio</span></div>
            <span class="seccion-toggle">‚ñº</span>
          </div>
          <div class="seccion-body" id="body-servicio">
            <div class="seccion-helper">
              Indica qu√© tipo de servicio necesitas cada pase. El administrador puede ajustarlo tras aprobar la solicitud.
            </div>
            <div id="servicio-container">
              <div class="matriz-placeholder">Selecciona las fechas para configurar servicio</div>
            </div>
          </div>
        </div>

        <!-- 5. Menaje -->
        <div class="seccion" id="seccion-menaje">
          <div class="seccion-header" onclick="toggleSeccion('menaje')">
            <div class="seccion-titulo">
              <span>üç∑</span> Menaje
              <span class="seccion-count" id="count-menaje">0</span>
              <span class="seccion-error-msg">‚ö† Obligatorio</span>
            </div>
            <span class="seccion-toggle">‚ñº</span>
          </div>
          <div class="seccion-body" id="body-menaje">
            <div class="seccion-helper">
              ¬øMenaje habitual o especial? Si es especial, selecciona del ajuar y/o a√±ade elementos extra.
            </div>
            <div class="menaje-tipo">
              <span class="menaje-tipo-label">Tipo de menaje:</span>
              <div class="slider-toggle">
                <span class="slider-label">Habitual</span>
                <input type="checkbox" id="menaje-especial" onchange="toggleMenajeEspecial()">
                <span class="slider-label">Especial</span>
              </div>
            </div>
            <div class="ajuar-selector" id="ajuar-selector">
              <label class="form-label">Selecciona del Ajuar:</label>
              <div class="ajuar-grid" id="ajuar-grid"></div>
            </div>
            <div id="lista-menaje"></div>
            <button class="add-btn" onclick="abrirModalMenaje()">+ A√±adir menaje adicional</button>
          </div>
        </div>

        <!-- 6. Producto -->
        <div class="seccion" id="seccion-producto">
          <div class="seccion-header" onclick="toggleSeccion('producto')">
            <div class="seccion-titulo">
              <span>üì¶</span> Producto
              <span class="seccion-count" id="count-producto">0</span>
              <span class="seccion-error-msg">‚ö† Obligatorio</span>
            </div>
            <span class="seccion-toggle">‚ñº</span>
          </div>
          <div class="seccion-body" id="body-producto">
            <div class="seccion-helper">
              Productos que aportas t√∫ o que necesitas que se compren/preparen.
            </div>
            <div class="subseccion">
              <div class="subseccion-header">
                <span>üè†</span> Aportado por la casa
                <span class="subseccion-count" id="count-aportado">0</span>
              </div>
              <div id="lista-producto-aportado"></div>
              <button class="add-btn" onclick="abrirModalProducto('aportado')">+ A√±adir producto aportado</button>
            </div>
            <div class="subseccion" style="margin-top: 20px;">
              <div class="subseccion-header">
                <span>üõí</span> Solicitado (compras/encargos)
                <span class="subseccion-count" id="count-solicitado">0</span>
              </div>
              <div id="lista-producto-solicitado"></div>
              <button class="add-btn" onclick="abrirModalProducto('solicitado')">+ A√±adir producto solicitado</button>
            </div>
          </div>
        </div>

        <!-- 7. Otras tareas -->
        <div class="seccion">
          <div class="seccion-header" onclick="toggleSeccion('tareas')">
            <div class="seccion-titulo">
              <span>‚úÖ</span> Otras tareas
              <span class="seccion-count" id="count-tareas">0</span>
            </div>
            <span class="seccion-toggle">‚ñº</span>
          </div>
          <div class="seccion-body" id="body-tareas">
            <div class="seccion-helper">
              Tareas no programadas que quieras pedir: revisiones, preparaciones especiales, etc.
            </div>
            <div id="lista-tareas"></div>
            <button class="add-btn" onclick="abrirModalTarea()">+ A√±adir tarea</button>
          </div>
        </div>

        <!-- 8. Notas -->
        <div class="seccion" id="seccion-notas">
          <div class="seccion-header" onclick="toggleSeccion('notas')">
            <div class="seccion-titulo"><span>üìù</span> Danos detalles del evento y/o reserva <span class="seccion-error-msg">‚ö† Obligatorio</span></div>
            <span class="seccion-toggle">‚ñº</span>
          </div>
          <div class="seccion-body" id="body-notas">
            <textarea class="notas-textarea" id="notas-general" placeholder="Danos detalles del evento y/o reserva: tipo de celebraci√≥n, preferencias, necesidades especiales..."></textarea>
          </div>
        </div>
      </div><!-- /preparacion-wrapper -->
      </div><!-- /panel-nueva -->
    </div><!-- /content -->
  </main>

  <div class="footer-actions" id="footer-actions" style="display:none;">
    <button class="btn btn-secondary" onclick="window.location.href='cgi.html'">Cancelar</button>
    <button class="btn btn-solicitud" id="btn-enviar" onclick="enviarSolicitud()">üì§ Enviar solicitud</button>
  </div>

  <!-- ===== MODAL MENAJE ===== -->
  <div class="modal-overlay" id="modal-menaje">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-menaje-titulo">üç∑ A√±adir menaje</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-menaje">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Art√≠culo *</label>
            <input type="text" class="form-input" id="menaje-articulo" placeholder="Ej: Copas de vino, Mantel especial..." required>
          </div>
          <div class="form-group">
            <label class="form-label">Cantidad</label>
            <input type="number" class="form-input" id="menaje-cantidad" value="1" min="1">
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-textarea" id="menaje-notas" placeholder="Detalles adicionales..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== MODAL PRODUCTO ===== -->
  <div class="modal-overlay" id="modal-producto">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-producto-titulo">üì¶ A√±adir producto</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-producto">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Descripci√≥n *</label>
            <input type="text" class="form-input" id="producto-descripcion" placeholder="Ej: Aceite de oliva, Vino tinto..." required>
          </div>
          <div class="form-group">
            <label class="form-label">Cantidad</label>
            <input type="text" class="form-input" id="producto-cantidad" placeholder="Ej: 2 botellas, 1kg...">
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-textarea" id="producto-notas" placeholder="Ubicaci√≥n, observaciones..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== MODAL TAREA ===== -->
  <div class="modal-overlay" id="modal-tarea">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-tarea-titulo">‚úÖ Nueva tarea</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-tarea">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Tarea *</label>
            <input type="text" class="form-input" id="tarea-titulo" placeholder="Ej: Revisar caldera, Podar seto..." required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Momento</label>
              <select class="form-select" id="tarea-dia">
                <option value="">Sin preferencia</option>
                <option value="antes">Antes de la llegada</option>
                <option value="durante">Durante la estancia</option>
                <option value="despues">Despu√©s de la salida</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Prioridad</label>
              <select class="form-select" id="tarea-prioridad">
                <option value="normal">Normal</option>
                <option value="alta">‚ö†Ô∏è Alta</option>
                <option value="urgente">üî¥ Urgente</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-textarea" id="tarea-notas" placeholder="Instrucciones adicionales..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== FIREBASE ===== -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ========================================
    // ESTADO GLOBAL
    // ========================================
    let currentUser = null;
    let userData = null;
    let currentFamilia = null;
    let miNidoPrincipal = null;
    let bienesDisponibles = [];
    let bienSeleccionado = null;
    let zonasData = [];
    let dependenciasData = [];
    let ajuarData = [];
    let nidosData = [];
    let otrosGruposData = [];
    let configCalendarioData = null;
    let tiposActuales = [];
    let diasSolicitud = []; // [{key:'2025-02-07', label:'Vie 7', date: Date}]
    let productoTipo = 'aportado';
    let editingIdx = null;
    let editingType = null;

    let preparacionData = {
      zonas: [],
      zonasDesglose: {},
      personas: {},       // {dateKey: {familiares, desayuno, comida, cena, duermen}}
      menus: {},           // {'pase-dateKey': {especial, descripcion}}
      servicio: {},        // {'pase-dateKey': [roles]}
      menajeEspecial: false,
      menajeAjuar: [],
      menaje: [],
      productosAportados: [],
      productosSolicitados: [],
      tareas: [],
      notas: ''
    };

    const ROLES_SERVICIO = ['Cocinan', 'Sirven', 'Apoyan', 'Refuerzo'];
    const TIPO_ICONS = { dormitorio: 'üõèÔ∏è', aseo: 'üöø', salas: 'üõãÔ∏è', funcional: 'üîß', otros: 'üì¶' };
    const DIAS_SEMANA = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

    // ========================================
    // INIT ‚Äî Formulario unificado (sin selector)
    // ========================================
    // Siempre activo como reserva+evento
    const esReserva = true;
    const esEvento = true;

    // Configurar fechas m√≠nimas
    document.addEventListener('DOMContentLoaded', () => {
      const hoy = new Date().toISOString().split('T')[0];
      document.getElementById('sol-fecha-inicio').min = hoy;
      document.getElementById('sol-fecha-fin').min = hoy;
    });

    // Auth
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;

      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists || !userDoc.data().familiaId) {
        window.location.href = 'cgi.html'; return;
      }
      userData = userDoc.data();

      // Cargar familia
      const estirpesIds = userData.estirpes || [userData.familiaId];
      const estirpeActiva = userData.estirpeActiva || userData.familiaId;
      const estirpeDoc = await db.collection('familias').doc(estirpeActiva).get();
      if (estirpeDoc.exists) {
        currentFamilia = { id: estirpeDoc.id, ...estirpeDoc.data() };
      } else {
        const fallbackDoc = await db.collection('familias').doc(userData.familiaId).get();
        currentFamilia = fallbackDoc.exists ? { id: fallbackDoc.id, ...fallbackDoc.data() } : null;
      }

      if (!currentFamilia) { alert('Error: No se encontr√≥ la familia'); return; }

      // Cargar nido principal
      if (userData.nidoId) {
        try {
          const nidoDoc = await db.collection('nidos').doc(userData.nidoId).get();
          if (nidoDoc.exists) miNidoPrincipal = { id: nidoDoc.id, ...nidoDoc.data() };
        } catch (e) { console.warn('Error nido:', e); }
      }

      await cargarBienes();
      await cargarMisSolicitudes();
      configurarEventosFormulario();

      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
      // Footer solo visible en pesta√±a Nueva
    });

    // ========================================
    // PESTA√ëAS
    // ========================================
    function cambiarPestana(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('panel-' + tab).classList.add('active');
      // Footer solo en pesta√±a nueva
      document.getElementById('footer-actions').style.display = tab === 'nueva' ? 'flex' : 'none';
    }

    // ========================================
    // MIS SOLICITUDES
    // ========================================
    let misSolicitudes = [];
    let filtroSolicitud = 'todas';

    async function cargarMisSolicitudes() {
      try {
        const snap = await db.collectionGroup('reservas')
          .where('solicitadoPor', '==', currentUser.uid)
          .where('familiaId', '==', currentFamilia.id)
          .get();

        misSolicitudes = snap.docs.map(doc => {
          const data = doc.data();
          const pathParts = doc.ref.path.split('/');
          return { id: doc.id, bienId: pathParts[1] || null, ...data };
        }).sort((a, b) => {
          // M√°s recientes primero
          const fa = a.fechaCreacion?.toDate?.() || new Date(0);
          const fb = b.fechaCreacion?.toDate?.() || new Date(0);
          return fb - fa;
        });

        document.getElementById('count-mis').textContent = misSolicitudes.length;
        renderMisSolicitudes();
      } catch (error) {
        console.error('Error cargando solicitudes:', error);
        document.getElementById('mis-solicitudes-list').innerHTML =
          '<div class="sol-empty"><div class="sol-empty-icon">‚ö†Ô∏è</div>Error al cargar solicitudes</div>';
      }
    }

    function renderMisSolicitudes() {
      const list = document.getElementById('mis-solicitudes-list');
      const empty = document.getElementById('mis-solicitudes-empty');

      let filtradas = misSolicitudes;
      if (filtroSolicitud !== 'todas') {
        filtradas = filtradas.filter(r => {
          if (filtroSolicitud === 'aprobada') return ['aprobada', 'confirmada'].includes(r.estado);
          return r.estado === filtroSolicitud;
        });
      }

      if (filtradas.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      const estadoLabel = {
        pendiente: '‚è≥ Pendiente', aprobada: '‚úÖ Aprobada', confirmada: '‚úÖ Confirmada',
        borrador: 'üìù Borrador', rechazada: '‚ùå Rechazada', cancelada: 'üö´ Cancelada'
      };

      list.innerHTML = filtradas.map(r => {
        const estado = r.estado || 'borrador';
        const estadoClass = ['aprobada', 'confirmada'].includes(estado) ? 'aprobada' : estado;
        const nombre = r.nombre || r.bienNombre || r.tipoReservaNombre || 'Solicitud';
        const fechas = r.fechaInicio ? `üìÖ ${formatFechaCorta(r.fechaInicio)} ‚Üí ${formatFechaCorta(r.fechaFin)}` : '';
        const bien = r.bienNombre || '';
        const horaInfo = r.horaLlegada ? ` ¬∑ üïê ${r.horaLlegada}‚Äì${r.horaSalida || ''}` : '';

        return `
          <div class="sol-card" onclick="verSolicitud('${r.id}', '${r.bienId}', '${estado}')">
            <div class="sol-indicator ${estadoClass}"></div>
            <div class="sol-body">
              <div class="sol-nombre">${nombre}</div>
              <div class="sol-meta">
                ${bien ? `<span>üè† ${bien}</span>` : ''}
                ${fechas ? `<span>${fechas}${horaInfo}</span>` : ''}
              </div>
            </div>
            <span class="sol-estado ${estadoClass}">${estadoLabel[estado] || estado}</span>
          </div>
        `;
      }).join('');
    }

    function filtrarSolicitudes(btn) {
      document.querySelectorAll('.sol-filtro').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      filtroSolicitud = btn.dataset.filtro;
      renderMisSolicitudes();
    }

    function formatFechaCorta(fecha) {
      if (!fecha) return '‚Äî';
      const f = typeof fecha === 'string' ? fecha : (fecha.toDate ? fecha.toDate().toISOString().split('T')[0] : '');
      if (!f) return '‚Äî';
      const [y, m, d] = f.split('-');
      const meses = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
      return `${parseInt(d)} ${meses[parseInt(m)-1]}`;
    }

    function verSolicitud(id, bienId, estado) {
      if (estado === 'borrador') {
        // Borrador: abrir en estancia-form para editar
        window.location.href = `estancia-form.html?bienId=${bienId}&id=${id}&src=reservas`;
      } else {
        // Pendiente/Aprobada: ir a la vista de reservas del bien
        window.location.href = `reservas-mayordomo.html?id=${bienId}`;
      }
    }

    // ========================================
    // CARGA DE DATOS
    // ========================================
    async function cargarBienes() {
      try {
        const snap = await db.collection('bienes').where('familiaId', '==', currentFamilia.id).get();
        bienesDisponibles = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        const select = document.getElementById('sol-bien');
        select.innerHTML = '<option value="">Selecciona un lugar...</option>' +
          bienesDisponibles.map(b => {
            const ico = b.mayordomoActivo ? 'üé©' : b.gerenteActivo ? 'üíº' : b.capatazActivo ? 'üöú' : 'üè†';
            return `<option value="${b.id}">${ico} ${b.nombre}</option>`;
          }).join('');

        if (bienesDisponibles.length === 0) {
          select.innerHTML = '<option value="">No hay bienes disponibles</option>';
        }
      } catch (e) {
        console.error('Error cargando bienes:', e);
      }
    }

    async function cargarZonasBien(bienId) {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('habitaciones').get();
        dependenciasData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const zonasMap = {};
        dependenciasData.forEach(dep => {
          const ubicacion = dep.zona || 'Sin asignar';
          if (!zonasMap[ubicacion]) {
            zonasMap[ubicacion] = { id: ubicacion.replace(/\s+/g, '_').toLowerCase(), nombre: ubicacion, dependencias: [] };
          }
          zonasMap[ubicacion].dependencias.push(dep);
        });
        zonasData = Object.values(zonasMap);
      } catch (e) {
        console.error('Error zonas:', e);
        zonasData = []; dependenciasData = [];
      }
    }

    async function cargarAjuarBien(bienId) {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('ajuar').get();
        ajuarData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (e) { ajuarData = []; }
    }

    async function cargarNidosRama() {
      try {
        const snap = await db.collection('nidos').where('familiaId', '==', currentFamilia.id).get();
        nidosData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { nidosData = []; }
    }

    async function cargarConfigCalendario() {
      try {
        const doc = await db.collection('familias').doc(currentFamilia.id)
          .collection('config').doc('calendarioFamiliar').get();
        if (doc.exists) {
          const raw = doc.data();
          configCalendarioData = { hitos: {}, tiposAddon: {}, externos: {} };
          if (raw.tiposAddon) {
            ['mayordomo', 'gerente', 'capataz'].forEach(addon => {
              if (raw.tiposAddon[addon]) {
                configCalendarioData.tiposAddon[addon] = [];
                Object.entries(raw.tiposAddon[addon]).forEach(([tipoId, tipoData]) => {
                  configCalendarioData.tiposAddon[addon].push({
                    id: tipoId, nombre: tipoData.nombre || tipoId,
                    emoji: tipoData.emoji || 'üìã', color: tipoData.color || '#9C27B0',
                    esFamiliar: tipoData.esFamiliar || false, visibleCGI: tipoData.visibleCGI || false
                  });
                });
              }
            });
          }
        }
        // Otros grupos
        const otrosSnap = await db.collection('familias').doc(currentFamilia.id)
          .collection('otrosGruposReserva').orderBy('orden', 'asc').get();
        otrosGruposData = otrosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.warn('Error config calendario:', e); }
    }

    // ========================================
    // EVENTOS FORMULARIO
    // ========================================
    function configurarEventosFormulario() {
      // Al cambiar bien
      document.getElementById('sol-bien').addEventListener('change', onBienChange);

      // Al cambiar fechas (siempre rango)
      document.getElementById('sol-fecha-inicio').addEventListener('change', onFechasChange);
      document.getElementById('sol-fecha-fin').addEventListener('change', onFechasChange);

      // Al cambiar tipo (para mostrar selector qui√©n reserva)
      document.getElementById('sol-tipo').addEventListener('change', onTipoChange);
    }

    async function onBienChange() {
      const bienId = document.getElementById('sol-bien').value;
      const quienContainer = document.getElementById('sol-quien-container');
      quienContainer.classList.add('hidden');

      if (!bienId) {
        document.getElementById('sol-tipo-container').classList.add('hidden');
        bienSeleccionado = null;
        return;
      }

      bienSeleccionado = bienesDisponibles.find(b => b.id === bienId);

      // Cargar dependencias para zonas y ajuar
      await cargarZonasBien(bienId);
      await cargarAjuarBien(bienId);
      if (!configCalendarioData) await cargarConfigCalendario();
      if (nidosData.length === 0) await cargarNidosRama();

      // Cargar tipos seg√∫n selecci√≥n actual
      await actualizarTipos();

      // Mostrar preparaci√≥n y renderizar zonas
      mostrarPreparacionSiBienYFechas();
      renderZonas();
      renderAjuar();
    }

    async function actualizarTipos() {
      const tipoContainer = document.getElementById('sol-tipo-container');
      if (!bienSeleccionado) { tipoContainer.classList.add('hidden'); return; }

      tiposActuales = [];

      if (esReserva) {
        // Tipos de reserva (del addon)
        let addon = null;
        if (bienSeleccionado.mayordomoActivo) addon = 'mayordomo';
        else if (bienSeleccionado.gerenteActivo) addon = 'gerente';
        else if (bienSeleccionado.capatazActivo) addon = 'capataz';

        if (addon && configCalendarioData?.tiposAddon?.[addon]) {
          tiposActuales = configCalendarioData.tiposAddon[addon].map(t => ({
            id: t.id, nombre: t.nombre, icono: t.emoji || '', esFamiliar: t.esFamiliar || false, categoria: t.categoria || t.id
          }));
        }
        if (tiposActuales.length === 0 && addon) {
          // Tipos por defecto seg√∫n addon - SIEMPRE: Familiar (verde), Eventos (azul), Otros (naranja)
          const defaults = {
            mayordomo: [
              { id: 'familiar', nombre: 'Estancia Familiar', icono: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', esFamiliar: true, categoria: 'familiar' },
              { id: 'evento', nombre: 'Eventos', icono: 'üéâ', esFamiliar: false, categoria: 'evento' },
              { id: 'otros', nombre: 'Otros', icono: 'üìã', esFamiliar: false, categoria: 'otros' }
            ],
            gerente: [
              { id: 'familiar', nombre: 'Estancia Familiar', icono: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', esFamiliar: true, categoria: 'familiar' },
              { id: 'evento', nombre: 'Eventos', icono: 'üéâ', esFamiliar: false, categoria: 'evento' },
              { id: 'otros', nombre: 'Otros', icono: 'üìã', esFamiliar: false, categoria: 'otros' }
            ],
            capataz: [
              { id: 'familiar', nombre: 'Estancia Familiar', icono: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', esFamiliar: true, categoria: 'familiar' },
              { id: 'evento', nombre: 'Eventos', icono: 'üéâ', esFamiliar: false, categoria: 'evento' },
              { id: 'otros', nombre: 'Otros', icono: 'üìã', esFamiliar: false, categoria: 'otros' }
            ]
          };
          tiposActuales = defaults[addon] || [];
        }
      } else if (esEvento) {
        // Tipos de evento
        try {
          const tiposSnap = await db.collection('familias').doc(currentFamilia.id).collection('tiposEvento').get();
          tiposActuales = tiposSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) { tiposActuales = []; }
        if (tiposActuales.length === 0) {
          tiposActuales = [
            { id: 'celebracion', nombre: 'Celebraci√≥n', icono: 'üéâ' },
            { id: 'reunion', nombre: 'Reuni√≥n familiar', icono: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
            { id: 'comida', nombre: 'Comida/Cena', icono: 'üçΩÔ∏è' },
            { id: 'otro', nombre: 'Otro', icono: 'üìå' }
          ];
        }
      }

      // Render tipos
      if (tiposActuales.length > 0) {
        const sel = document.getElementById('sol-tipo');
        sel.innerHTML = '<option value="">Selecciona tipo...</option>' +
          tiposActuales.map(t => `<option value="${t.id}">${t.icono || 'üìå'} ${t.nombre}</option>`).join('');
        tipoContainer.classList.remove('hidden');
      } else {
        tipoContainer.classList.add('hidden');
      }
    }

    function onTipoChange() {
      const tipoId = document.getElementById('sol-tipo').value;
      const container = document.getElementById('sol-quien-container');
      const select = document.getElementById('sol-quien');

      if (!tipoId) { container.classList.add('hidden'); return; }

      const tipo = tiposActuales.find(t => t.id === tipoId);
      if (tipo?.esFamiliar) {
        let options = '<option value="">¬øQui√©n reserva?</option>';
        if (nidosData.length > 0) {
          options += '<optgroup label="üè† Nidos">';
          nidosData.forEach(n => { options += `<option value="nido:${n.id}">${n.nombre || 'Nido'}</option>`; });
          options += '</optgroup>';
        }
        if (otrosGruposData.length > 0) {
          options += '<optgroup label="üìã Otros grupos">';
          otrosGruposData.forEach(g => { options += `<option value="otro:${g.id}">${g.emoji || 'üìã'} ${g.nombre}</option>`; });
          options += '</optgroup>';
        }
        select.innerHTML = options;
        container.classList.remove('hidden');
        select.required = true;
      } else {
        container.classList.add('hidden');
        select.required = false;
      }
    }

    function onFechasChange() {
      calcularDias();
      mostrarPreparacionSiBienYFechas();
      renderMatrices();
    }

    function calcularDias() {
      diasSolicitud = [];
      const inicio = document.getElementById('sol-fecha-inicio').value;
      const fin = document.getElementById('sol-fecha-fin').value;
      if (!inicio || !fin || fin < inicio) return;
      let cur = new Date(inicio + 'T12:00:00');
      const end = new Date(fin + 'T12:00:00');
      while (cur <= end) {
        diasSolicitud.push({
          key: cur.toISOString().split('T')[0],
          label: DIAS_SEMANA[cur.getDay()] + ' ' + cur.getDate(),
          date: new Date(cur)
        });
        cur.setDate(cur.getDate() + 1);
      }

      // Multi-semana
      const badge = document.getElementById('multi-semana-badge');
      if (diasSolicitud.length > 7) {
        const numSemanas = Math.ceil(diasSolicitud.length / 7);
        document.getElementById('num-semanas').textContent = numSemanas;
        badge.classList.add('visible');
      } else {
        badge.classList.remove('visible');
      }
    }

    function mostrarPreparacionSiBienYFechas() {
      // Preparaci√≥n siempre visible ‚Äî las secciones se auto-gestionan con empty states
      // Solo actualizar matrices si hay fechas
      if (diasSolicitud.length > 0) {
        renderMatrices();
      }
    }

    // ========================================
    // RENDER ZONAS (id√©ntico a preparar-semana)
    // ========================================
    function renderZonas() {
      const container = document.getElementById('zonas-container');
      const count = preparacionData.zonas.length;
      document.getElementById('count-zonas').textContent = count;

      if (zonasData.length === 0) {
        container.innerHTML = '<div class="empty-state">No hay zonas configuradas para este bien.</div>';
        return;
      }
      container.innerHTML = zonasData.map(z => {
        const selected = preparacionData.zonas.includes(z.id);
        const desglose = preparacionData.zonasDesglose[z.id] || [];
        const showDeps = desglose.length > 0 || selected;
        return `
          <div class="zona-group">
            <div class="zona-header">
              <input type="checkbox" ${selected ? 'checked' : ''} onchange="toggleZona('${z.id}')">
              <span class="zona-header-label" onclick="toggleZona('${z.id}')">üè† ${z.nombre}</span>
              <span class="zona-count">${z.dependencias.length} deps</span>
              ${selected ? `<span class="zona-toggle-deps" onclick="event.stopPropagation(); toggleDesglose('${z.id}')">Desglosar</span>` : ''}
            </div>
            <div class="zona-deps ${showDeps && selected ? 'visible' : ''}" id="deps-${z.id}">
              ${z.dependencias.map(dep => {
                const depSel = desglose.includes(dep.id);
                const ico = TIPO_ICONS[dep.tipo] || 'üì¶';
                return `<div class="dep-item">
                  <input type="checkbox" ${depSel ? 'checked' : ''} onchange="toggleDependencia('${z.id}','${dep.id}')">
                  <span class="dep-item-label">${dep.nombre || dep.numero}</span>
                  <span class="dep-item-tipo">${ico} ${dep.tipo || ''}</span>
                </div>`;
              }).join('')}
            </div>
          </div>`;
      }).join('');
    }

    function toggleZona(id) {
      const idx = preparacionData.zonas.indexOf(id);
      if (idx >= 0) { 
        preparacionData.zonas.splice(idx, 1); 
        delete preparacionData.zonasDesglose[id]; 
      } else {
        preparacionData.zonas.push(id);
        // Auto-seleccionar todas las dependencias
        const zona = zonasData.find(z => z.id === id);
        if (zona) preparacionData.zonasDesglose[id] = zona.dependencias.map(d => d.id);
      }
      renderZonas();
    }
    function toggleDesglose(zonaId) {
      document.getElementById(`deps-${zonaId}`).classList.toggle('visible');
    }
    function toggleDependencia(zonaId, depId) {
      if (!preparacionData.zonasDesglose[zonaId]) preparacionData.zonasDesglose[zonaId] = [];
      const arr = preparacionData.zonasDesglose[zonaId];
      const idx = arr.indexOf(depId);
      if (idx >= 0) arr.splice(idx, 1); else arr.push(depId);
    }

    // ========================================
    // RENDER MATRICES (Personas, Men√∫s, Servicio)
    // ========================================
    function renderMatrices() {
      renderPersonas();
      renderMenus();
      renderServicio();
    }

    function renderPersonas() {
      const container = document.getElementById('personas-container');
      if (diasSolicitud.length === 0) {
        container.innerHTML = '<div class="matriz-placeholder">Selecciona las fechas para ver los d√≠as</div>';
        return;
      }
      const filas = [
        { key: 'familiares', label: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familiares' },
        { key: 'desayuno', label: 'üç≥ Desayunan' },
        { key: 'comida', label: 'üçΩÔ∏è Comen' },
        { key: 'cena', label: 'üåô Cenan' },
        { key: 'duermen', label: 'üõèÔ∏è Duermen' }
      ];
      let html = '<div class="matriz"><table><thead><tr><th></th>';
      diasSolicitud.forEach(d => { html += `<th>${d.label}</th>`; });
      html += '</tr></thead><tbody>';
      filas.forEach(fila => {
        html += `<tr><td>${fila.label}</td>`;
        diasSolicitud.forEach(d => {
          const val = preparacionData.personas[d.key]?.[fila.key] || 0;
          html += `<td><input type="number" min="0" value="${val}" 
            onchange="setPersona('${d.key}','${fila.key}',this.value)"></td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function setPersona(diaKey, campo, valor) {
      if (!preparacionData.personas[diaKey]) {
        preparacionData.personas[diaKey] = { familiares: 0, desayuno: 0, comida: 0, cena: 0, duermen: 0 };
      }
      preparacionData.personas[diaKey][campo] = parseInt(valor) || 0;
    }

    function renderMenus() {
      const container = document.getElementById('menus-container');
      if (diasSolicitud.length === 0) {
        container.innerHTML = '<div class="matriz-placeholder">Selecciona las fechas para configurar men√∫s</div>';
        return;
      }
      const pases = [
        { key: 'desayuno', label: 'üç≥ Desayuno' },
        { key: 'aperitivo', label: 'ü•Ç Aperitivo' },
        { key: 'comida', label: 'üçΩÔ∏è Comida' },
        { key: 'cena', label: 'üåô Cena' }
      ];
      let html = '<div class="matriz"><table><thead><tr><th></th>';
      diasSolicitud.forEach(d => { html += `<th>${d.label}</th>`; });
      html += '</tr></thead><tbody>';
      pases.forEach(pase => {
        html += `<tr><td>${pase.label}</td>`;
        diasSolicitud.forEach(d => {
          const menuKey = `${pase.key}-${d.key}`;
          const menuData = preparacionData.menus[menuKey] || {};
          const checked = menuData.especial ? 'checked' : '';
          html += `<td>
            <div class="slider-toggle" style="justify-content:center;">
              <span class="slider-label" style="font-size:0.65rem;">Prev</span>
              <input type="checkbox" ${checked} onchange="toggleMenuEspecial('${pase.key}','${d.key}')">
              <span class="slider-label" style="font-size:0.65rem;">Esp</span>
            </div>
            <div class="especial-input ${menuData.especial ? 'visible' : ''}" id="especial-${pase.key}-${d.key}">
              <input type="text" placeholder="¬øCu√°l?" value="${menuData.descripcion || ''}"
                onchange="setMenuDescripcion('${pase.key}','${d.key}',this.value)">
            </div>
          </td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function toggleMenuEspecial(pase, diaKey) {
      const menuKey = `${pase}-${diaKey}`;
      if (!preparacionData.menus[menuKey]) preparacionData.menus[menuKey] = { especial: false, descripcion: '' };
      preparacionData.menus[menuKey].especial = !preparacionData.menus[menuKey].especial;
      const el = document.getElementById(`especial-${pase}-${diaKey}`);
      if (el) el.classList.toggle('visible', preparacionData.menus[menuKey].especial);
    }
    function setMenuDescripcion(pase, diaKey, valor) {
      const menuKey = `${pase}-${diaKey}`;
      if (!preparacionData.menus[menuKey]) preparacionData.menus[menuKey] = { especial: true, descripcion: '' };
      preparacionData.menus[menuKey].descripcion = valor;
    }

    function renderServicio() {
      const container = document.getElementById('servicio-container');
      if (diasSolicitud.length === 0) {
        container.innerHTML = '<div class="matriz-placeholder">Selecciona las fechas para configurar servicio</div>';
        return;
      }
      const pases = [
        { key: 'desayuno', label: 'üç≥ Desayuno' },
        { key: 'aperitivo', label: 'ü•Ç Aperitivo' },
        { key: 'comida', label: 'üçΩÔ∏è Comida' },
        { key: 'cena', label: 'üåô Cena' }
      ];
      let html = '<div class="matriz"><table><thead><tr><th></th>';
      diasSolicitud.forEach(d => { html += `<th>${d.label}</th>`; });
      html += '</tr></thead><tbody>';
      pases.forEach(pase => {
        html += `<tr><td>${pase.label}</td>`;
        diasSolicitud.forEach(d => {
          const servKey = `${pase.key}-${d.key}`;
          const roles = preparacionData.servicio[servKey] || [];
          html += '<td><div class="roles-select">';
          ROLES_SERVICIO.forEach(rol => {
            const sel = roles.includes(rol) ? 'selected' : '';
            html += `<span class="role-chip ${sel}" onclick="toggleRol('${pase.key}','${d.key}','${rol}',this)">${rol}</span>`;
          });
          html += '</div></td>';
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function toggleRol(pase, diaKey, rol, el) {
      const servKey = `${pase}-${diaKey}`;
      if (!preparacionData.servicio[servKey]) preparacionData.servicio[servKey] = [];
      const arr = preparacionData.servicio[servKey];
      const idx = arr.indexOf(rol);
      if (idx >= 0) { arr.splice(idx, 1); el.classList.remove('selected'); }
      else { arr.push(rol); el.classList.add('selected'); }
    }

    // ========================================
    // RENDER MENAJE & AJUAR
    // ========================================
    function renderAjuar() {
      const grid = document.getElementById('ajuar-grid');
      if (ajuarData.length === 0) {
        grid.innerHTML = '<div class="empty-state">No hay ajuar configurado</div>';
        return;
      }
      grid.innerHTML = ajuarData.map(item => {
        const sel = preparacionData.menajeAjuar.includes(item.id);
        return `<div class="ajuar-item ${sel ? 'selected' : ''}" onclick="toggleAjuar('${item.id}', this)">
          <input type="checkbox" ${sel ? 'checked' : ''}>
          <span>${item.nombre || item.descripcion || 'Art√≠culo'}</span>
        </div>`;
      }).join('');
    }
    function toggleAjuar(id, el) {
      const idx = preparacionData.menajeAjuar.indexOf(id);
      if (idx >= 0) preparacionData.menajeAjuar.splice(idx, 1);
      else preparacionData.menajeAjuar.push(id);
      el.classList.toggle('selected');
      el.querySelector('input').checked = !el.querySelector('input').checked;
      updateCountMenaje();
    }
    function toggleMenajeEspecial() {
      preparacionData.menajeEspecial = document.getElementById('menaje-especial').checked;
      const selector = document.getElementById('ajuar-selector');
      selector.classList.toggle('visible', preparacionData.menajeEspecial);
    }
    function updateCountMenaje() {
      document.getElementById('count-menaje').textContent =
        preparacionData.menaje.length + preparacionData.menajeAjuar.length;
    }

    function renderMenaje() {
      const container = document.getElementById('lista-menaje');
      container.innerHTML = preparacionData.menaje.map((item, i) =>
        `<div class="item-card">
          <span class="item-icon">üç∑</span>
          <div class="item-content">
            <div class="item-titulo">${item.articulo}</div>
            <div class="item-meta">Cantidad: ${item.cantidad}${item.notas ? ' ¬∑ ' + item.notas : ''}</div>
          </div>
          <div class="item-actions">
            <button class="item-btn" onclick="editarMenaje(${i})">‚úèÔ∏è</button>
            <button class="item-btn delete" onclick="eliminarMenaje(${i})">üóëÔ∏è</button>
          </div>
        </div>`
      ).join('');
      updateCountMenaje();
    }

    // ========================================
    // RENDER PRODUCTOS
    // ========================================
    function renderProductos() {
      renderListaProducto('aportado', preparacionData.productosAportados);
      renderListaProducto('solicitado', preparacionData.productosSolicitados);
      document.getElementById('count-producto').textContent =
        (preparacionData.productosAportados?.length || 0) + (preparacionData.productosSolicitados?.length || 0);
      document.getElementById('count-aportado').textContent = preparacionData.productosAportados?.length || 0;
      document.getElementById('count-solicitado').textContent = preparacionData.productosSolicitados?.length || 0;
    }
    function renderListaProducto(tipo, lista) {
      const container = document.getElementById(`lista-producto-${tipo}`);
      const esCompra = tipo === 'solicitado';
      container.innerHTML = (lista || []).map((item, i) =>
        `<div class="item-card ${esCompra ? 'compra' : ''}">
          <span class="item-icon">${esCompra ? 'üõí' : 'üè†'}</span>
          <div class="item-content">
            <div class="item-titulo">${item.descripcion}</div>
            <div class="item-meta">${item.cantidad ? 'Cant: ' + item.cantidad : ''}${item.notas ? ' ¬∑ ' + item.notas : ''}</div>
          </div>
          <div class="item-actions">
            <button class="item-btn" onclick="editarProducto('${tipo}',${i})">‚úèÔ∏è</button>
            <button class="item-btn delete" onclick="eliminarProducto('${tipo}',${i})">üóëÔ∏è</button>
          </div>
        </div>`
      ).join('');
    }

    // ========================================
    // RENDER TAREAS
    // ========================================
    function renderTareas() {
      const container = document.getElementById('lista-tareas');
      container.innerHTML = preparacionData.tareas.map((t, i) => {
        const prioLabel = t.prioridad === 'urgente' ? 'üî¥ Urgente' : t.prioridad === 'alta' ? '‚ö†Ô∏è Alta' : '';
        return `<div class="item-card tarea">
          <span class="item-icon">‚úÖ</span>
          <div class="item-content">
            <div class="item-titulo">${t.titulo}</div>
            <div class="item-meta">${t.dia ? 'Momento: ' + t.dia : ''} ${prioLabel}${t.notas ? ' ¬∑ ' + t.notas : ''}</div>
          </div>
          <div class="item-actions">
            <button class="item-btn" onclick="editarTarea(${i})">‚úèÔ∏è</button>
            <button class="item-btn delete" onclick="eliminarTarea(${i})">üóëÔ∏è</button>
          </div>
        </div>`;
      }).join('');
      document.getElementById('count-tareas').textContent = preparacionData.tareas.length;
    }

    // ========================================
    // MODALES: MENAJE
    // ========================================
    function abrirModalMenaje(idx) {
      editingIdx = idx !== undefined ? idx : null;
      editingType = 'menaje';
      const form = document.getElementById('form-menaje');
      if (editingIdx !== null) {
        const item = preparacionData.menaje[editingIdx];
        document.getElementById('menaje-articulo').value = item.articulo;
        document.getElementById('menaje-cantidad').value = item.cantidad;
        document.getElementById('menaje-notas').value = item.notas || '';
        document.getElementById('modal-menaje-titulo').textContent = 'üç∑ Editar menaje';
      } else {
        form.reset(); document.getElementById('menaje-cantidad').value = 1;
        document.getElementById('modal-menaje-titulo').textContent = 'üç∑ A√±adir menaje';
      }
      document.getElementById('modal-menaje').classList.add('active');
    }
    function editarMenaje(i) { abrirModalMenaje(i); }
    function eliminarMenaje(i) { preparacionData.menaje.splice(i, 1); renderMenaje(); }

    document.getElementById('form-menaje').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = {
        articulo: document.getElementById('menaje-articulo').value,
        cantidad: parseInt(document.getElementById('menaje-cantidad').value) || 1,
        notas: document.getElementById('menaje-notas').value
      };
      if (editingIdx !== null) preparacionData.menaje[editingIdx] = data;
      else preparacionData.menaje.push(data);
      cerrarModales(); renderMenaje();
    });

    // ========================================
    // MODALES: PRODUCTO
    // ========================================
    function abrirModalProducto(tipo, idx) {
      productoTipo = tipo;
      editingIdx = idx !== undefined ? idx : null;
      editingType = 'producto';
      const form = document.getElementById('form-producto');
      const lista = tipo === 'aportado' ? preparacionData.productosAportados : preparacionData.productosSolicitados;
      if (editingIdx !== null) {
        const item = lista[editingIdx];
        document.getElementById('producto-descripcion').value = item.descripcion;
        document.getElementById('producto-cantidad').value = item.cantidad || '';
        document.getElementById('producto-notas').value = item.notas || '';
        document.getElementById('modal-producto-titulo').textContent = 'üì¶ Editar producto';
      } else {
        form.reset();
        document.getElementById('modal-producto-titulo').textContent = tipo === 'aportado' ? 'üè† A√±adir producto aportado' : 'üõí A√±adir producto solicitado';
      }
      document.getElementById('modal-producto').classList.add('active');
    }
    function editarProducto(tipo, i) { abrirModalProducto(tipo, i); }
    function eliminarProducto(tipo, i) {
      if (tipo === 'aportado') preparacionData.productosAportados.splice(i, 1);
      else preparacionData.productosSolicitados.splice(i, 1);
      renderProductos();
    }

    document.getElementById('form-producto').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = {
        descripcion: document.getElementById('producto-descripcion').value,
        cantidad: document.getElementById('producto-cantidad').value,
        notas: document.getElementById('producto-notas').value
      };
      const lista = productoTipo === 'aportado' ? preparacionData.productosAportados : preparacionData.productosSolicitados;
      if (editingIdx !== null) lista[editingIdx] = data;
      else lista.push(data);
      cerrarModales(); renderProductos();
    });

    // ========================================
    // MODALES: TAREA
    // ========================================
    function abrirModalTarea(idx) {
      editingIdx = idx !== undefined ? idx : null;
      editingType = 'tarea';
      const form = document.getElementById('form-tarea');
      if (editingIdx !== null) {
        const t = preparacionData.tareas[editingIdx];
        document.getElementById('tarea-titulo').value = t.titulo;
        document.getElementById('tarea-dia').value = t.dia || '';
        document.getElementById('tarea-prioridad').value = t.prioridad || 'normal';
        document.getElementById('tarea-notas').value = t.notas || '';
        document.getElementById('modal-tarea-titulo').textContent = '‚úÖ Editar tarea';
      } else {
        form.reset();
        document.getElementById('modal-tarea-titulo').textContent = '‚úÖ Nueva tarea';
      }
      document.getElementById('modal-tarea').classList.add('active');
    }
    function editarTarea(i) { abrirModalTarea(i); }
    function eliminarTarea(i) { preparacionData.tareas.splice(i, 1); renderTareas(); }

    document.getElementById('form-tarea').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = {
        titulo: document.getElementById('tarea-titulo').value,
        dia: document.getElementById('tarea-dia').value,
        prioridad: document.getElementById('tarea-prioridad').value,
        notas: document.getElementById('tarea-notas').value
      };
      if (editingIdx !== null) preparacionData.tareas[editingIdx] = data;
      else preparacionData.tareas.push(data);
      cerrarModales(); renderTareas();
    });

    // ========================================
    // ENVIAR SOLICITUD
    // ========================================
    // ========================================
    // VALIDACI√ìN SECCIONES OBLIGATORIAS
    // ========================================
    function validarSeccionesObligatorias() {
      const errores = [];

      // 1. ZONAS ‚Äî al menos 1 zona seleccionada
      if (!preparacionData.zonas || preparacionData.zonas.length === 0) {
        errores.push({ seccionId: 'seccion-zonas', nombre: 'üè† Zonas' });
      }

      // 2. PERSONAS ‚Äî al menos 1 d√≠a con alg√∫n valor > 0
      const tienePersonas = Object.values(preparacionData.personas || {}).some(dia =>
        (dia.familiares > 0 || dia.desayuno > 0 || dia.comida > 0 || dia.cena > 0 || dia.duermen > 0)
      );
      if (!tienePersonas) {
        errores.push({ seccionId: 'seccion-personas', nombre: 'üë• Personas' });
      }

      // 3. MEN√öS ‚Äî al menos 1 men√∫ con especial=true o con descripci√≥n
      const tieneMenus = Object.values(preparacionData.menus || {}).some(m =>
        m.especial || (m.descripcion && m.descripcion.trim())
      );
      if (!tieneMenus) {
        errores.push({ seccionId: 'seccion-menus', nombre: 'üçΩÔ∏è Men√∫s' });
      }

      // 4. SERVICIO ‚Äî al menos 1 pase con roles asignados
      const tieneServicio = Object.values(preparacionData.servicio || {}).some(roles =>
        Array.isArray(roles) ? roles.length > 0 : !!roles
      );
      if (!tieneServicio) {
        errores.push({ seccionId: 'seccion-servicio', nombre: 'üë®‚Äçüç≥ Servicio' });
      }

      // 5. MENAJE ‚Äî OPCIONAL (skip)
      // const tieneMenaje = preparacionData.menajeEspecial ||
      //   (preparacionData.menajeAjuar && preparacionData.menajeAjuar.length > 0) ||
      //   (preparacionData.menaje && preparacionData.menaje.length > 0);
      // if (!tieneMenaje) {
      //   errores.push({ seccionId: 'seccion-menaje', nombre: 'üç∑ Menaje' });
      // }

      // 6. PRODUCTO ‚Äî OPCIONAL (skip)
      // const tieneProducto = (preparacionData.productosAportados && preparacionData.productosAportados.length > 0) ||
      //   (preparacionData.productosSolicitados && preparacionData.productosSolicitados.length > 0);
      // if (!tieneProducto) {
      //   errores.push({ seccionId: 'seccion-producto', nombre: 'üì¶ Producto' });
      // }

      // 7. TAREAS ‚Äî NO obligatorio (skip)

      // 8. NOTAS ‚Äî texto no vac√≠o
      if (!preparacionData.notas || !preparacionData.notas.trim()) {
        errores.push({ seccionId: 'seccion-notas', nombre: 'üìù Notas' });
      }

      return errores;
    }

    async function enviarSolicitud() {
      // Validar campos obligatorios b√°sicos
      const bienId = document.getElementById('sol-bien').value;
      if (!bienId) { alert('Selecciona un bien'); return; }

      const inicio = document.getElementById('sol-fecha-inicio').value;
      const fin = document.getElementById('sol-fecha-fin').value;
      if (!inicio || !fin) { alert('Selecciona las fechas de inicio y fin'); return; }
      if (fin < inicio) { alert('La fecha de fin debe ser posterior a la de inicio'); return; }

      // Recoger notas antes de validar
      preparacionData.notas = document.getElementById('notas-general')?.value || '';

      // === VALIDACI√ìN DE SECCIONES OBLIGATORIAS ===
      const errores = validarSeccionesObligatorias();
      if (errores.length > 0) {
        // Limpiar errores previos
        document.querySelectorAll('.seccion.seccion-error').forEach(s => s.classList.remove('seccion-error'));
        // Marcar secciones con error
        errores.forEach(e => {
          const el = document.getElementById(e.seccionId);
          if (el) el.classList.add('seccion-error');
        });
        // Scroll a la primera con error
        const primera = document.getElementById(errores[0].seccionId);
        if (primera) primera.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Mensaje
        const nombres = errores.map(e => e.nombre).join(', ');
        alert('Faltan secciones obligatorias por completar:\n\n' + nombres + '\n\nRevisa las secciones marcadas en rojo.');
        return;
      }
      // Limpiar marcas de error si todo OK
      document.querySelectorAll('.seccion.seccion-error').forEach(s => s.classList.remove('seccion-error'));

      if (!confirm('¬øEnviar esta solicitud? Ser√° revisada por los administradores.')) return;

      const btn = document.getElementById('btn-enviar');
      btn.disabled = true;
      btn.textContent = '‚è≥ Enviando...';

      try {
        const bien = bienesDisponibles.find(b => b.id === bienId);
        const tipoId = document.getElementById('sol-tipo').value || '';
        const tipoInfo = tiposActuales.find(t => t.id === tipoId) || {};
        const visibilidad = document.querySelector('input[name="sol-visibilidad"]:checked')?.value || 'rama';
        const nombre = document.getElementById('sol-nombre').value.trim();

        // Datos de qui√©n reserva
        let nidoReservaId = null, nidoReservaNombre = '', otroGrupoId = null, otroGrupoNombre = '';
        if (tipoInfo.esFamiliar) {
          const quien = document.getElementById('sol-quien').value;
          if (quien) {
            const [tipoQ, idQ] = quien.split(':');
            if (tipoQ === 'nido') {
              nidoReservaId = idQ;
              nidoReservaNombre = nidosData.find(n => n.id === idQ)?.nombre || 'Nido';
            } else if (tipoQ === 'otro') {
              otroGrupoId = idQ;
              otroGrupoNombre = otrosGruposData.find(g => g.id === idQ)?.nombre || 'Grupo';
            }
          }
        }

        // Addon activo
        let addonActivo = null;
        if (bien?.mayordomoActivo) addonActivo = 'mayordomo';
        else if (bien?.gerenteActivo) addonActivo = 'gerente';
        else if (bien?.capatazActivo) addonActivo = 'capataz';

        // Construir solicitud - usar categor√≠a del tipo (familiar/evento/otros)
        const solicitudData = {
          tipo: 'solicitud',
          categoria: tipoInfo.categoria || tipoId || 'familiar',
          esReserva: true,
          esEvento: true,
          nombre: nombre,
          bienId: bienId,
          bienNombre: bien?.nombre || '',
          addonActivo: addonActivo,
          tipoReserva: tipoId || null,
          tipoReservaNombre: tipoInfo.nombre || tipoId || null,
          esFamiliar: tipoInfo.esFamiliar || false,
          nidoReservaId, nidoReservaNombre,
          otroGrupoId, otroGrupoNombre,
          fechaInicio: inicio,
          fechaFin: fin,
          descripcion: document.getElementById('sol-motivo').value || '',
          motivo: document.getElementById('sol-motivo').value || '',
          visibilidad,
          nidoId: miNidoPrincipal?.id || null,
          // Preparaci√≥n completa
          preparacion: { ...preparacionData },
          diasSolicitud: diasSolicitud.map(d => d.key),
          // Meta
          estado: 'pendiente',
          solicitadoPor: currentUser.uid,
          solicitadoPorNombre: userData?.nombre || currentUser.email,
          solicitadoPorNido: miNidoPrincipal?.nombre || '',
          solicitadoPorNidoId: miNidoPrincipal?.id || null,
          familiaId: currentFamilia.id,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
          respuesta: null, respondidoPor: null, fechaRespuesta: null
        };

        // DATO √öNICO: solo en bienes/{bienId}/reservas/{id}
        // Otras p√°ginas (mis-reservas, CGI) leen con collectionGroup('reservas')
        solicitudData.origen = 'solicitud';
        const solicitudRef = await db.collection('bienes').doc(bienId).collection('reservas').add(solicitudData);
        console.log('‚úÖ Reserva creada en bien:', solicitudRef.id);

        // 2. Notificar a admins
        const admins = await cargarAdminsParaNotificacion();
        console.log('üë• Admins encontrados:', admins.length, admins.map(a => a.nombre || a.uid));
        
        const destinatarios = admins.filter(a => a.uid !== currentUser.uid).map(a => a.uid);
        const destinatariosFinales = destinatarios.length > 0 ? destinatarios : admins.map(a => a.uid);

        // Crear notificaci√≥n siempre (aunque no haya destinatarios espec√≠ficos)
        const tituloNotif = nombre
          ? `üìã Solicitud: ${nombre} ‚Äî ${bien?.nombre || 'Bien'}`
          : `üìã Solicitud: ${bien?.nombre || 'Bien'} (${inicio} ‚Üí ${fin})`;

        const notifData = {
          tipo: 'accion',
          categoria: 'solicitud',
          titulo: tituloNotif,
          mensaje: `${userData?.nombre || 'Usuario'} ha enviado una solicitud con detalle de preparaci√≥n`,
          familiaId: currentFamilia.id,
          nidoId: miNidoPrincipal?.id || null,
          destinatarios: destinatariosFinales.length > 0 ? destinatariosFinales : [currentUser.uid],
          leidoPor: [], completadoPor: [],
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
          fechaExpiracion: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
          enlace: `reservas.html?id=${bienId}`,
          origen: { tipo: 'solicitud', bienId: bienId, id: solicitudRef.id, solicitadoPor: currentUser.uid },
          estado: 'activa'
        };
        
        console.log('üì© Creando notificaci√≥n:', notifData);
        await db.collection('notificaciones').add(notifData);
        console.log('‚úÖ Notificaci√≥n creada');

        alert('‚úÖ Solicitud enviada correctamente.\nLos administradores la revisar√°n y recibir√°s notificaci√≥n.');
        await cargarMisSolicitudes();
        cambiarPestana('mis');

      } catch (error) {
        console.error('Error enviando solicitud:', error);
        alert('Error al enviar la solicitud: ' + (error.message || 'Int√©ntalo de nuevo'));
      }

      btn.disabled = false;
      btn.textContent = 'üì§ Enviar solicitud';
    }

    async function cargarAdminsParaNotificacion() {
      try {
        const snap = await db.collection('usuarios').where('familiaId', '==', currentFamilia.id).get();
        console.log('üîç Usuarios en familia:', snap.size);
        
        const admins = snap.docs.map(d => ({ uid: d.id, ...d.data() }))
          .filter(u => {
            const rol = String(u.rol || '').toLowerCase();
            // Buscar en ambos campos: credencial y credenciales
            const cred = String(u.credencial || u.credenciales || '').toLowerCase();
            const esAdmin = rol.includes('admin') || cred.includes('admin') ||
              rol === 'patriarca' || rol === 'matriarca' ||
              cred === 'patriarca' || cred === 'matriarca' ||
              u.esAdmin === true || u.adminRama === true || u.superAdmin === true ||
              u.esPatriarca === true || u.esMatriarca === true;
            
            if (esAdmin) console.log('üë§ Admin encontrado:', u.nombre || u.uid, 'rol:', rol, 'cred:', cred);
            return esAdmin;
          });
        
        return admins;
      } catch (e) {
        console.error('Error cargando admins:', e);
        return [];
      }
    }

    // ========================================
    // UTILS
    // ========================================
    function toggleSeccion(id) {
      document.getElementById(`body-${id}`).classList.toggle('hidden');
    }

    function seleccionarVisibilidad(el) {
      el.closest('.visibilidad-selector').querySelectorAll('.visibilidad-option')
        .forEach(opt => opt.classList.remove('active'));
      el.classList.add('active');
      el.querySelector('input').checked = true;
    }

    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
      editingIdx = null; editingType = null;
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) cerrarModales();
      });
    });
  </script>
</body>
</html>
