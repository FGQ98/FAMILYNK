<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Mensajes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --chat-out: #DCF8C6;
      --chat-in: #FFFFFF;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ============ HEADER ============ */
    .header {
      background: var(--white);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow-soft);
      z-index: 100;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      text-decoration: none;
    }

    .back-btn:hover { background: var(--cream-dark); }

    .header-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--sage-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--sage);
      color: white;
    }

    .btn-primary:hover { background: var(--sage-dark); }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
    }

    .btn-secondary:hover { background: var(--cream-dark); }

    /* ============ MAIN LAYOUT ============ */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* ============ SIDEBAR - CONVERSACIONES ============ */
    .sidebar {
      width: 320px;
      background: var(--white);
      border-right: 1px solid var(--cream-dark);
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--cream);
      border-radius: var(--radius-full);
    }

    .search-box input {
      flex: 1;
      border: none;
      background: none;
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      outline: none;
    }

    .search-icon { color: var(--text-muted); }

    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid var(--cream-dark);
    }

    .sidebar-tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      position: relative;
    }

    .sidebar-tab.active {
      color: var(--sage-dark);
    }

    .sidebar-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 20%;
      right: 20%;
      height: 2px;
      background: var(--sage);
      border-radius: 2px;
    }

    .sidebar-tab .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      background: var(--terracotta);
      color: white;
      font-size: 0.65rem;
      border-radius: 9px;
      margin-left: 4px;
    }

    .conversations-list {
      flex: 1;
      overflow-y: auto;
    }

    .conv-section-title {
      padding: 12px 16px 8px;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .conv-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      border-left: 3px solid transparent;
    }

    .conv-item:hover { background: var(--cream); }
    .conv-item.active { 
      background: var(--sage-muted); 
      border-left-color: var(--sage);
    }
    .conv-item.unread { background: rgba(193, 119, 87, 0.08); }

    .conv-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--sage-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .conv-avatar.grupo { background: var(--sage); color: white; }
    .conv-avatar.nido { background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%); color: white; }

    .conv-info {
      flex: 1;
      min-width: 0;
    }

    .conv-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .conv-name {
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conv-item.unread .conv-name { font-weight: 700; }

    .conv-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .conv-item.unread .conv-time { color: var(--terracotta); font-weight: 600; }

    .conv-preview {
      font-size: 0.8rem;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .conv-item.unread .conv-preview { color: var(--text); }

    .conv-unread-badge {
      width: 8px;
      height: 8px;
      background: var(--terracotta);
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* ============ CHAT AREA ============ */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--cream);
    }

    .chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .chat-empty-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .chat-empty-text {
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .chat-empty-hint {
      font-size: 0.85rem;
    }

    /* Chat Header */
    .chat-header {
      background: var(--white);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .chat-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--sage);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
    }

    .chat-header-info {
      flex: 1;
    }

    .chat-header-name {
      font-weight: 700;
      font-size: 0.95rem;
    }

    .chat-header-status {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .chat-header-actions {
      display: flex;
      gap: 8px;
    }

    .chat-header-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--cream);
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-header-btn:hover { background: var(--cream-dark); }

    /* Messages */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message-date-divider {
      text-align: center;
      padding: 8px 0;
    }

    .message-date-divider span {
      background: var(--cream-dark);
      padding: 4px 12px;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .message {
      display: flex;
      gap: 8px;
      max-width: 75%;
    }

    .message.out {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message.in {
      align-self: flex-start;
    }

    .message-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--sage-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      flex-shrink: 0;
      align-self: flex-end;
    }

    .message.out .message-avatar { display: none; }

    .message-bubble {
      padding: 10px 14px;
      border-radius: var(--radius-lg);
      position: relative;
    }

    .message.out .message-bubble {
      background: var(--chat-out);
      border-bottom-right-radius: 4px;
    }

    .message.in .message-bubble {
      background: var(--chat-in);
      border-bottom-left-radius: 4px;
      box-shadow: var(--shadow-soft);
    }

    .message-sender {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--sage-dark);
      margin-bottom: 2px;
    }

    .message.out .message-sender { display: none; }

    .message-text {
      font-size: 0.9rem;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message-time {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-align: right;
      margin-top: 4px;
    }

    /* Chat Input */
    .chat-input-area {
      background: var(--white);
      padding: 12px 20px;
      border-top: 1px solid var(--cream-dark);
    }

    .chat-input-box {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      background: var(--cream);
      border-radius: var(--radius-xl);
      padding: 8px 8px 8px 16px;
    }

    .chat-input {
      flex: 1;
      border: none;
      background: none;
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      resize: none;
      outline: none;
      max-height: 120px;
      min-height: 24px;
    }

    .chat-send-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: var(--sage);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .chat-send-btn:hover { background: var(--sage-dark); transform: scale(1.05); }
    .chat-send-btn:disabled { background: var(--text-muted); cursor: not-allowed; transform: none; }

    /* ============ MODALES ============ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--white);
      border-radius: var(--radius-xl);
      width: 90%;
      max-width: 450px;
      max-height: 80vh;
      overflow: hidden;
      transform: translateY(20px);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--cream);
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .modal-body {
      padding: 20px;
      max-height: 50vh;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--cream-dark);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .member-select-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.2s;
    }

    .member-select-item:hover { background: var(--cream); }
    .member-select-item.selected { 
      background: var(--sage-muted); 
      border: 2px solid var(--sage);
    }

    .member-select-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .member-select-info {
      flex: 1;
    }

    .member-select-name {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .member-select-nido {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .member-select-check {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--sage);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      opacity: 0;
    }

    .member-select-item.selected .member-select-check { opacity: 1; }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--sage);
    }

    .hidden { display: none !important; }

    /* ============ RESPONSIVE ============ */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        bottom: 0;
        width: 85%;
        max-width: 320px;
        z-index: 200;
        transition: left 0.3s;
      }

      .sidebar.active { left: 0; }

      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 199;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
      }

      .sidebar-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .mobile-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: none;
        background: var(--cream);
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
      }

      .header-actions .btn { display: none; }
    }

    @media (min-width: 769px) {
      .mobile-menu-btn { display: none; }
      .sidebar-overlay { display: none; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    <a href="cgi.html" class="back-btn">‚Üê Volver</a>
    <div class="header-title">üí¨ Mensajes</div>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="abrirModalNuevoGrupo()">+ Grupo</button>
      <button class="btn btn-primary" onclick="abrirModalNuevoChat()">+ Chat</button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar - Lista de conversaciones -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input type="text" placeholder="Buscar conversaci√≥n..." id="search-conv" oninput="filtrarConversaciones()">
        </div>
      </div>

      <div class="sidebar-tabs">
        <button class="sidebar-tab active" onclick="cambiarTab('todos')">
          Todos <span class="badge hidden" id="badge-todos">0</span>
        </button>
        <button class="sidebar-tab" onclick="cambiarTab('grupos')">
          Grupos <span class="badge hidden" id="badge-grupos">0</span>
        </button>
        <button class="sidebar-tab" onclick="cambiarTab('privados')">
          Privados <span class="badge hidden" id="badge-privados">0</span>
        </button>
      </div>

      <div class="conversations-list" id="conversations-list">
        <div style="padding: 40px; text-align: center; color: var(--text-muted);">
          <div style="font-size: 2rem; margin-bottom: 8px;">üí¨</div>
          <div>Cargando conversaciones...</div>
        </div>
      </div>
    </aside>

    <!-- Chat Area -->
    <main class="chat-area">
      <!-- Empty State -->
      <div class="chat-empty" id="chat-empty">
        <div class="chat-empty-icon">üí¨</div>
        <div class="chat-empty-text">Selecciona una conversaci√≥n</div>
        <div class="chat-empty-hint">o crea un nuevo chat o grupo</div>
      </div>

      <!-- Chat Content (hidden by default) -->
      <div id="chat-content" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <div class="chat-header">
          <div class="chat-header-avatar" id="chat-avatar">üë•</div>
          <div class="chat-header-info">
            <div class="chat-header-name" id="chat-name">Nombre</div>
            <div class="chat-header-status" id="chat-status">0 participantes</div>
          </div>
          <div class="chat-header-actions">
            <button class="chat-header-btn" onclick="verInfoConversacion()" title="Info">‚ÑπÔ∏è</button>
          </div>
        </div>

        <div class="chat-messages" id="chat-messages"></div>

        <div class="chat-input-area">
          <div class="chat-input-box">
            <textarea 
              class="chat-input" 
              id="chat-input"
              placeholder="Escribe un mensaje..."
              rows="1"
              onkeydown="handleInputKeydown(event)"
            ></textarea>
            <button class="chat-send-btn" id="send-btn" onclick="enviarMensaje()">‚û§</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal: Nuevo Chat Privado -->
  <div class="modal-overlay" id="modal-nuevo-chat">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">üí¨ Nuevo chat privado</div>
        <button class="modal-close" onclick="cerrarModal('modal-nuevo-chat')">√ó</button>
      </div>
      <div class="modal-body">
        <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 16px;">
          Selecciona un miembro de tu estirpe para iniciar una conversaci√≥n privada.
        </p>
        <div id="members-chat-list"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-nuevo-chat')">Cancelar</button>
        <button class="btn btn-primary" onclick="crearChatPrivado()" id="btn-crear-chat" disabled>Iniciar chat</button>
      </div>
    </div>
  </div>

  <!-- Modal: Nuevo Grupo -->
  <div class="modal-overlay" id="modal-nuevo-grupo">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">üë• Nuevo grupo</div>
        <button class="modal-close" onclick="cerrarModal('modal-nuevo-grupo')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nombre del grupo</label>
          <input type="text" class="form-input" id="grupo-nombre" placeholder="Ej: Hermanos, Primos..." maxlength="30">
        </div>
        <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 16px;">
          Selecciona los participantes:
        </p>
        <div id="members-grupo-list"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-nuevo-grupo')">Cancelar</button>
        <button class="btn btn-primary" onclick="crearGrupo()" id="btn-crear-grupo" disabled>Crear grupo</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let userData = null;
    let conversaciones = [];
    let conversacionActiva = null;
    let miembrosEstirpe = [];
    let selectedMemberChat = null;
    let selectedMembersGrupo = [];
    let unsubscribeMessages = null;
    let unsubscribeConversaciones = null;

    // Auth
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;

      try {
        // Cargar datos usuario
        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        
        if (!userDoc.exists) {
          console.error('Usuario no existe en BD:', user.uid);
          alert('Tu cuenta no est√° configurada correctamente. Contacta al administrador.');
          window.location.href = 'cgi.html';
          return;
        }

        userData = userDoc.data();

        if (!userData.familiaId) {
          console.error('Usuario sin familiaId:', user.uid);
          alert('No tienes una familia asignada. Contacta al administrador.');
          window.location.href = 'cgi.html';
          return;
        }

        await cargarMiembrosEstirpe();
        cargarConversaciones();

        // Abrir conversaci√≥n si viene en la URL
        const urlParams = new URLSearchParams(window.location.search);
        const convId = urlParams.get('conv');
        if (convId) {
          setTimeout(() => abrirConversacion(convId), 1000);
        }
      } catch (error) {
        console.error('Error inicializando chat:', error);
        alert('Error al cargar el chat: ' + error.message);
      }
    });

    // ============ CARGAR MIEMBROS ============
    async function cargarMiembrosEstirpe() {
      try {
        const nidosSnap = await db.collection('nidos')
          .where('familiaId', '==', userData.familiaId)
          .get();

        miembrosEstirpe = [];
        const emailsVistos = new Set();

        nidosSnap.docs.forEach(doc => {
          const nido = doc.data();
          (nido.miembrosData || []).forEach(m => {
            if (m.email && !emailsVistos.has(m.email) && m.email !== currentUser.email) {
              emailsVistos.add(m.email);
              miembrosEstirpe.push({
                ...m,
                nidoNombre: nido.nombre,
                nidoId: doc.id
              });
            }
          });
        });

        console.log('Miembros estirpe cargados:', miembrosEstirpe.length);

      } catch (error) {
        console.error('Error cargando miembros:', error);
      }
    }

    // ============ CARGAR CONVERSACIONES ============
    function cargarConversaciones() {
      // Cancelar suscripci√≥n anterior si existe
      if (unsubscribeConversaciones) {
        unsubscribeConversaciones();
      }

      // CAMBIO CLAVE: Usar participantesEmail en lugar de participantes
      // Esto permite encontrar conversaciones incluso antes de que el usuario tenga UID en la lista
      // Tambi√©n usamos fechaActualizacion en lugar de ultimoMensaje.fecha
      
      console.log('Cargando conversaciones para:', currentUser.email);

      // Primero intentamos con participantes (uid)
      unsubscribeConversaciones = db.collection('conversaciones')
        .where('familiaId', '==', userData.familiaId)
        .onSnapshot(snapshot => {
          // Filtrar las que me incluyen (por uid O por email)
          conversaciones = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(c => 
              c.participantes?.includes(currentUser.uid) || 
              c.participantesEmail?.includes(currentUser.email)
            );

          // Ordenar por fecha m√°s reciente
          conversaciones.sort((a, b) => {
            const fechaA = a.fechaActualizacion?.toDate?.() || a.ultimoMensaje?.fecha?.toDate?.() || a.fechaCreacion?.toDate?.() || new Date(0);
            const fechaB = b.fechaActualizacion?.toDate?.() || b.ultimoMensaje?.fecha?.toDate?.() || b.fechaCreacion?.toDate?.() || new Date(0);
            return fechaB - fechaA;
          });

          console.log('Conversaciones encontradas:', conversaciones.length);
          renderConversaciones();
          actualizarBadges();

          // Si tengo conversaciones donde estoy por email pero no por uid, a√±adir mi uid
          conversaciones.forEach(async c => {
            if (c.participantesEmail?.includes(currentUser.email) && !c.participantes?.includes(currentUser.uid)) {
              console.log('A√±adiendo mi UID a conversaci√≥n:', c.id);
              await db.collection('conversaciones').doc(c.id).update({
                participantes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
              });
            }
          });

        }, error => {
          console.error('Error cargando conversaciones:', error);
          // Fallback: cargar sin listener
          db.collection('conversaciones')
            .where('familiaId', '==', userData.familiaId)
            .get()
            .then(snapshot => {
              conversaciones = snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(c => 
                  c.participantes?.includes(currentUser.uid) || 
                  c.participantesEmail?.includes(currentUser.email)
                );
              conversaciones.sort((a, b) => {
                const fechaA = a.fechaActualizacion?.toDate?.() || new Date(0);
                const fechaB = b.fechaActualizacion?.toDate?.() || new Date(0);
                return fechaB - fechaA;
              });
              renderConversaciones();
              actualizarBadges();
            });
        });
    }

    function renderConversaciones(filtro = 'todos', busqueda = '') {
      const container = document.getElementById('conversations-list');
      
      let convsFiltradas = [...conversaciones];

      // Filtrar por tab
      if (filtro === 'grupos') {
        convsFiltradas = convsFiltradas.filter(c => c.tipo === 'grupo' || c.tipo === 'nido');
      } else if (filtro === 'privados') {
        convsFiltradas = convsFiltradas.filter(c => c.tipo === 'privada');
      }

      // Filtrar por b√∫squeda
      if (busqueda) {
        const q = busqueda.toLowerCase();
        convsFiltradas = convsFiltradas.filter(c => 
          (c.nombre || '').toLowerCase().includes(q) ||
          (c.ultimoMensaje?.texto || '').toLowerCase().includes(q)
        );
      }

      if (convsFiltradas.length === 0) {
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--text-muted);">
            <div style="font-size: 2rem; margin-bottom: 8px;">üí¨</div>
            <div>No hay conversaciones</div>
            <div style="font-size: 0.8rem; margin-top: 8px;">Crea un chat o grupo para empezar</div>
          </div>
        `;
        return;
      }

      // Separar grupos y privados
      const grupos = convsFiltradas.filter(c => c.tipo === 'grupo' || c.tipo === 'nido');
      const privados = convsFiltradas.filter(c => c.tipo === 'privada');

      let html = '';

      if (grupos.length > 0 && filtro !== 'privados') {
        html += '<div class="conv-section-title">Grupos</div>';
        html += grupos.map(c => renderConvItem(c)).join('');
      }

      if (privados.length > 0 && filtro !== 'grupos') {
        html += '<div class="conv-section-title">Privados</div>';
        html += privados.map(c => renderConvItem(c)).join('');
      }

      container.innerHTML = html;
    }

    function renderConvItem(conv) {
      const tieneNoLeidos = conv.noLeidosPor?.includes(currentUser.uid);
      const esActiva = conversacionActiva?.id === conv.id;
      
      let avatar = 'üë§';
      let avatarClass = '';
      if (conv.tipo === 'nido') {
        avatar = 'ü™∫';
        avatarClass = 'nido';
      } else if (conv.tipo === 'grupo') {
        avatar = 'üë•';
        avatarClass = 'grupo';
      }

      const nombre = conv.nombre || 'Chat';
      const tiempo = formatearTiempo(conv.fechaActualizacion || conv.ultimoMensaje?.fecha || conv.fechaCreacion);
      const preview = conv.ultimoMensaje?.texto || 'Sin mensajes a√∫n';
      const deNombre = conv.ultimoMensaje?.deNombre || '';

      return `
        <div class="conv-item ${tieneNoLeidos ? 'unread' : ''} ${esActiva ? 'active' : ''}" 
             onclick="abrirConversacion('${conv.id}')">
          <div class="conv-avatar ${avatarClass}">${avatar}</div>
          <div class="conv-info">
            <div class="conv-header">
              <span class="conv-name">${nombre}</span>
              <span class="conv-time">${tiempo}</span>
            </div>
            <div class="conv-preview">
              ${deNombre ? `<strong>${deNombre}:</strong>` : ''} ${preview.substring(0, 35)}${preview.length > 35 ? '...' : ''}
              ${tieneNoLeidos ? '<span class="conv-unread-badge"></span>' : ''}
            </div>
          </div>
        </div>
      `;
    }

    function formatearTiempo(timestamp) {
      if (!timestamp) return '';
      const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const hoy = new Date();

      if (fecha.toDateString() === hoy.toDateString()) {
        return fecha.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
      }

      const ayer = new Date(hoy);
      ayer.setDate(ayer.getDate() - 1);
      if (fecha.toDateString() === ayer.toDateString()) {
        return 'Ayer';
      }

      return fecha.toLocaleDateString('es', { day: 'numeric', month: 'short' });
    }

    function actualizarBadges() {
      const noLeidosTotal = conversaciones.filter(c => c.noLeidosPor?.includes(currentUser.uid)).length;
      const noLeidosGrupos = conversaciones.filter(c => (c.tipo === 'grupo' || c.tipo === 'nido') && c.noLeidosPor?.includes(currentUser.uid)).length;
      const noLeidosPrivados = conversaciones.filter(c => c.tipo === 'privada' && c.noLeidosPor?.includes(currentUser.uid)).length;

      updateBadge('badge-todos', noLeidosTotal);
      updateBadge('badge-grupos', noLeidosGrupos);
      updateBadge('badge-privados', noLeidosPrivados);
    }

    function updateBadge(id, count) {
      const badge = document.getElementById(id);
      if (count > 0) {
        badge.textContent = count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    // ============ ABRIR CONVERSACI√ìN ============
    async function abrirConversacion(convId) {
      console.log('Abriendo conversaci√≥n:', convId);

      // Primero buscar en la lista local
      conversacionActiva = conversaciones.find(c => c.id === convId);
      
      // Si no est√° en la lista local, buscar directamente en Firebase
      if (!conversacionActiva) {
        console.log('No encontrada en local, buscando en Firebase...');
        try {
          const convDoc = await db.collection('conversaciones').doc(convId).get();
          if (convDoc.exists) {
            conversacionActiva = { id: convDoc.id, ...convDoc.data() };
            // A√±adir a la lista local
            conversaciones.unshift(conversacionActiva);
            console.log('Conversaci√≥n encontrada en Firebase:', conversacionActiva.nombre);
          } else {
            console.error('Conversaci√≥n no existe:', convId);
            alert('No se pudo encontrar la conversaci√≥n');
            return;
          }
        } catch (error) {
          console.error('Error buscando conversaci√≥n:', error);
          alert('Error al abrir la conversaci√≥n');
          return;
        }
      }

      // Actualizar UI
      document.getElementById('chat-empty').classList.add('hidden');
      document.getElementById('chat-content').classList.remove('hidden');

      // Header
      let avatar = 'üë§';
      if (conversacionActiva.tipo === 'nido') avatar = 'ü™∫';
      else if (conversacionActiva.tipo === 'grupo') avatar = 'üë•';

      document.getElementById('chat-avatar').textContent = avatar;
      document.getElementById('chat-name').textContent = conversacionActiva.nombre || 'Chat';
      document.getElementById('chat-status').textContent = `${conversacionActiva.participantesNombres?.length || conversacionActiva.participantes?.length || 0} participantes`;

      // Marcar como activa en la lista
      renderConversaciones();

      // Marcar como le√≠do
      if (conversacionActiva.noLeidosPor?.includes(currentUser.uid)) {
        await db.collection('conversaciones').doc(convId).update({
          noLeidosPor: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
        });
      }

      // Cargar mensajes en tiempo real
      if (unsubscribeMessages) unsubscribeMessages();

      unsubscribeMessages = db.collection('mensajes-chat')
        .where('conversacionId', '==', convId)
        .orderBy('fecha', 'asc')
        .onSnapshot(snapshot => {
          const mensajes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderMensajes(mensajes);
        }, error => {
          console.error('Error cargando mensajes:', error);
          // Fallback sin orden
          db.collection('mensajes-chat')
            .where('conversacionId', '==', convId)
            .get()
            .then(snapshot => {
              const mensajes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              mensajes.sort((a, b) => {
                const fechaA = a.fecha?.toDate?.() || new Date(0);
                const fechaB = b.fecha?.toDate?.() || new Date(0);
                return fechaA - fechaB;
              });
              renderMensajes(mensajes);
            });
        });

      // Cerrar sidebar en m√≥vil
      if (window.innerWidth < 769) {
        toggleSidebar();
      }
    }

    function renderMensajes(mensajes) {
      const container = document.getElementById('chat-messages');

      if (mensajes.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <div style="font-size: 2rem; margin-bottom: 8px;">üëã</div>
            <div>¬°Empieza la conversaci√≥n!</div>
          </div>
        `;
        return;
      }

      let html = '';
      let lastDate = null;

      mensajes.forEach(msg => {
        const fecha = msg.fecha?.toDate?.() || new Date();
        const dateStr = fecha.toDateString();

        // Divisor de fecha
        if (dateStr !== lastDate) {
          lastDate = dateStr;
          const hoy = new Date().toDateString();
          const ayer = new Date(Date.now() - 86400000).toDateString();
          let dateLabel = fecha.toLocaleDateString('es', { day: 'numeric', month: 'long' });
          if (dateStr === hoy) dateLabel = 'Hoy';
          else if (dateStr === ayer) dateLabel = 'Ayer';

          html += `<div class="message-date-divider"><span>${dateLabel}</span></div>`;
        }

        const esMio = msg.de === currentUser.uid;
        const iniciales = (msg.deNombre || '??').substring(0, 2).toUpperCase();
        const hora = fecha.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });

        html += `
          <div class="message ${esMio ? 'out' : 'in'}">
            <div class="message-avatar">${iniciales}</div>
            <div class="message-bubble">
              ${!esMio && conversacionActiva.tipo !== 'privada' ? `<div class="message-sender">${msg.deNombre}</div>` : ''}
              <div class="message-text">${escapeHtml(msg.texto)}</div>
              <div class="message-time">${hora}</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
      container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }

    // ============ ENVIAR MENSAJE ============
    async function enviarMensaje() {
      const input = document.getElementById('chat-input');
      const texto = input.value.trim();

      if (!texto || !conversacionActiva) return;

      const btn = document.getElementById('send-btn');
      btn.disabled = true;

      try {
        const miNombre = userData.nombre || currentUser.email.split('@')[0];

        // Crear mensaje
        await db.collection('mensajes-chat').add({
          conversacionId: conversacionActiva.id,
          de: currentUser.uid,
          deNombre: miNombre,
          texto: texto,
          fecha: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Actualizar √∫ltimo mensaje y marcar no le√≠do para otros
        const otrosParticipantes = (conversacionActiva.participantes || []).filter(p => p !== currentUser.uid);

        await db.collection('conversaciones').doc(conversacionActiva.id).update({
          ultimoMensaje: {
            texto: texto,
            de: currentUser.uid,
            deNombre: miNombre,
            fecha: firebase.firestore.FieldValue.serverTimestamp()
          },
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp(),
          noLeidosPor: otrosParticipantes
        });

        input.value = '';
        input.style.height = 'auto';

      } catch (error) {
        console.error('Error enviando mensaje:', error);
        alert('Error al enviar el mensaje');
      }

      btn.disabled = false;
      input.focus();
    }

    function handleInputKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        enviarMensaje();
      }
    }

    // ============ MODALES ============
    function abrirModalNuevoChat() {
      selectedMemberChat = null;
      document.getElementById('btn-crear-chat').disabled = true;
      renderMembersList('members-chat-list', 'chat');
      document.getElementById('modal-nuevo-chat').classList.add('active');
    }

    function abrirModalNuevoGrupo() {
      selectedMembersGrupo = [];
      document.getElementById('grupo-nombre').value = '';
      document.getElementById('btn-crear-grupo').disabled = true;
      renderMembersList('members-grupo-list', 'grupo');
      document.getElementById('modal-nuevo-grupo').classList.add('active');
    }

    function cerrarModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function renderMembersList(containerId, tipo) {
      const container = document.getElementById(containerId);

      if (miembrosEstirpe.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--text-muted);">
            No hay miembros con email en la estirpe.<br>
            <small>A√±ade emails a los miembros de los nidos primero.</small>
          </div>
        `;
        return;
      }

      container.innerHTML = miembrosEstirpe.map(m => {
        const iniciales = (m.iniciales || m.nombre?.substring(0, 2) || '??').toUpperCase();
        const isSelected = tipo === 'chat' 
          ? selectedMemberChat?.email === m.email
          : selectedMembersGrupo.some(s => s.email === m.email);

        return `
          <div class="member-select-item ${isSelected ? 'selected' : ''}" 
               onclick="toggleMemberSelection('${m.email}', '${tipo}')">
            <div class="member-select-avatar">${iniciales}</div>
            <div class="member-select-info">
              <div class="member-select-name">${m.nombre || m.iniciales}</div>
              <div class="member-select-nido">ü™∫ ${m.nidoNombre}</div>
            </div>
            <div class="member-select-check">${isSelected ? '‚úì' : ''}</div>
          </div>
        `;
      }).join('');
    }

    function toggleMemberSelection(email, tipo) {
      const miembro = miembrosEstirpe.find(m => m.email === email);
      if (!miembro) return;

      if (tipo === 'chat') {
        // Solo uno para chat privado
        selectedMemberChat = selectedMemberChat?.email === email ? null : miembro;
        document.getElementById('btn-crear-chat').disabled = !selectedMemberChat;
        renderMembersList('members-chat-list', 'chat');
      } else {
        // M√∫ltiples para grupo
        const idx = selectedMembersGrupo.findIndex(m => m.email === email);
        if (idx >= 0) {
          selectedMembersGrupo.splice(idx, 1);
        } else {
          selectedMembersGrupo.push(miembro);
        }
        document.getElementById('btn-crear-grupo').disabled = selectedMembersGrupo.length === 0;
        renderMembersList('members-grupo-list', 'grupo');
      }
    }

    async function crearChatPrivado() {
      if (!selectedMemberChat) return;

      const btn = document.getElementById('btn-crear-chat');
      btn.disabled = true;
      btn.textContent = 'Creando...';

      try {
        // Verificar si ya existe conversaci√≥n con esta persona
        const existente = conversaciones.find(c => 
          c.tipo === 'privada' && 
          c.participantesEmail?.includes(selectedMemberChat.email)
        );

        if (existente) {
          cerrarModal('modal-nuevo-chat');
          await abrirConversacion(existente.id);
          btn.disabled = false;
          btn.textContent = 'Iniciar chat';
          return;
        }

        const miNombre = userData.nombre || currentUser.email.split('@')[0];

        // Crear nueva conversaci√≥n con fechaActualizacion
        const convRef = await db.collection('conversaciones').add({
          tipo: 'privada',
          nombre: selectedMemberChat.nombre || selectedMemberChat.iniciales,
          participantes: [currentUser.uid],
          participantesEmail: [currentUser.email, selectedMemberChat.email],
          participantesNombres: [miNombre, selectedMemberChat.nombre || selectedMemberChat.iniciales],
          familiaId: userData.familiaId,
          ultimoMensaje: null,
          noLeidosPor: [],
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        console.log('Chat privado creado:', convRef.id);

        cerrarModal('modal-nuevo-chat');
        
        // Esperar un momento y abrir
        setTimeout(() => abrirConversacion(convRef.id), 300);

      } catch (error) {
        console.error('Error creando chat:', error);
        alert('Error al crear el chat: ' + error.message);
      }

      btn.disabled = false;
      btn.textContent = 'Iniciar chat';
    }

    async function crearGrupo() {
      const nombre = document.getElementById('grupo-nombre').value.trim();
      if (!nombre || selectedMembersGrupo.length === 0) {
        alert('Introduce un nombre y selecciona al menos un participante');
        return;
      }

      const btn = document.getElementById('btn-crear-grupo');
      btn.disabled = true;
      btn.textContent = 'Creando...';

      try {
        const miNombre = userData.nombre || currentUser.email.split('@')[0];

        const participantesEmail = [currentUser.email, ...selectedMembersGrupo.map(m => m.email)];
        const participantesNombres = [miNombre, ...selectedMembersGrupo.map(m => m.nombre || m.iniciales)];

        // Crear grupo con fechaActualizacion
        const convRef = await db.collection('conversaciones').add({
          tipo: 'grupo',
          nombre: nombre,
          participantes: [currentUser.uid],
          participantesEmail: participantesEmail,
          participantesNombres: participantesNombres,
          familiaId: userData.familiaId,
          creador: currentUser.uid,
          ultimoMensaje: null,
          noLeidosPor: [],
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        console.log('Grupo creado:', convRef.id, nombre);

        cerrarModal('modal-nuevo-grupo');
        
        // Esperar un momento y abrir
        setTimeout(() => abrirConversacion(convRef.id), 300);

      } catch (error) {
        console.error('Error creando grupo:', error);
        alert('Error al crear el grupo: ' + error.message);
      }

      btn.disabled = false;
      btn.textContent = 'Crear grupo';
    }

    // ============ TABS Y FILTROS ============
    function cambiarTab(tab) {
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      renderConversaciones(tab, document.getElementById('search-conv').value);
    }

    function filtrarConversaciones() {
      const activeTab = document.querySelector('.sidebar-tab.active');
      const tab = activeTab?.textContent.toLowerCase().includes('grupos') ? 'grupos' 
                : activeTab?.textContent.toLowerCase().includes('privados') ? 'privados' 
                : 'todos';
      renderConversaciones(tab, document.getElementById('search-conv').value);
    }

    // ============ MOBILE ============
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
      document.getElementById('sidebar-overlay').classList.toggle('active');
    }

    function verInfoConversacion() {
      if (!conversacionActiva) return;
      
      const participantes = conversacionActiva.participantesNombres?.join(', ') || 'Sin participantes';
      alert(`üìã ${conversacionActiva.nombre}\n\nTipo: ${conversacionActiva.tipo}\nParticipantes: ${participantes}`);
    }
  </script>
</body>
</html>
