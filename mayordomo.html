<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Mayordomo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-dark: #6B5A45;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --warning-muted: rgba(232, 180, 77, 0.15);
      --error: #D4695A;
      --error-muted: rgba(212, 105, 90, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-dark) 100%);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: white;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    .header-info h1 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .header-info p {
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .header-badge {
      padding: 4px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
    }

    /* ========== LAYOUT ========== */
    .layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      min-height: calc(100vh - 72px);
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .sidebar.mobile-open { display: block; position: fixed; top: 72px; left: 0; right: 0; bottom: 0; z-index: 99; }
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      background: var(--white);
      border-right: 1px solid var(--cream-dark);
      padding: 20px 0;
    }

    .sidebar-section {
      margin-bottom: 24px;
    }

    .sidebar-title {
      padding: 0 20px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      font-weight: 700;
      margin-bottom: 8px;
    }

    .sidebar-nav { list-style: none; }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-light);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .sidebar-link:hover { background: var(--cream); color: var(--text); }

    .sidebar-link.active {
      background: var(--mayordomo-muted);
      color: var(--mayordomo);
      border-right: 3px solid var(--mayordomo);
    }

    .sidebar-link-icon { font-size: 1.1rem; width: 24px; text-align: center; }

    .sidebar-link-badge {
      margin-left: auto;
      padding: 2px 8px;
      background: var(--error);
      color: white;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 700;
    }

    .sidebar-submenu {
      margin: 4px 0;
    }

    .sidebar-submenu-title {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-light);
      font-size: 0.9rem;
      font-weight: 600;
    }

    .sidebar-sublink {
      display: block;
      padding: 10px 20px 10px 56px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.85rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    .sidebar-sublink:hover {
      background: var(--cream);
      color: var(--mayordomo);
    }

    /* ========== MAIN CONTENT ========== */
    .main {
      padding: 24px;
      max-width: 1200px;
    }

    .section { display: none; }
    .section.active { display: block; }

    .section-header {
      margin-bottom: 24px;
    }

    .section-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .section-description {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* ========== CARDS ========== */
    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body { padding: 20px; }

    /* ========== BUTTONS ========== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      color: white;
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }

    .btn-mayordomo {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-dark) 100%);
      color: white;
    }

    .btn-mayordomo:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
      border: 1px solid var(--cream-dark);
    }

    .btn-secondary:hover { background: var(--cream-dark); }

    .btn-warning { background: var(--warning); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-sm { padding: 8px 14px; font-size: 0.8rem; }

    /* ========== INVENTARIO ========== */
    .inventario-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .inventario-tab {
      padding: 10px 16px;
      background: var(--white);
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .inventario-tab:hover { border-color: var(--mayordomo-light); }
    .inventario-tab.active { background: var(--mayordomo); color: white; border-color: var(--mayordomo); }

    .inventario-tab-count {
      padding: 2px 8px;
      background: rgba(0,0,0,0.1);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
    }

    .inventario-tab.active .inventario-tab-count { background: rgba(255,255,255,0.2); }

    .grupo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .grupo-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subgrupos-list {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .subgrupo-chip {
      padding: 6px 12px;
      background: var(--cream);
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .subgrupo-chip:hover { background: var(--cream-dark); }
    .subgrupo-chip.active { background: var(--mayordomo-muted); border-color: var(--mayordomo); color: var(--mayordomo); }

    .productos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    .producto-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-soft);
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .producto-card:hover { box-shadow: var(--shadow-medium); }
    .producto-card.bajo { border-color: var(--warning); background: var(--warning-muted); }
    .producto-card.critico { border-color: var(--error); background: var(--error-muted); }

    .producto-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .producto-icon { font-size: 1.8rem; }

    .producto-info { flex: 1; margin-left: 12px; }
    .producto-nombre { font-weight: 700; font-size: 0.95rem; }
    .producto-subgrupo { font-size: 0.75rem; color: var(--text-muted); }

    .producto-stock {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .stock-visual {
      flex: 1;
      height: 8px;
      background: var(--cream-dark);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .stock-bar {
      height: 100%;
      background: var(--success);
      border-radius: var(--radius-full);
      transition: width 0.3s;
    }

    .stock-bar.bajo { background: var(--warning); }
    .stock-bar.critico { background: var(--error); }

    .stock-text {
      font-size: 0.85rem;
      font-weight: 700;
      min-width: 60px;
      text-align: right;
    }

    .stock-text.bajo { color: var(--warning); }
    .stock-text.critico { color: var(--error); }

    .producto-actions {
      display: flex;
      gap: 8px;
      justify-content: space-between;
    }

    .btn-stock {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-stock.minus { background: var(--cream-dark); color: var(--text); }
    .btn-stock.minus:hover { background: var(--error); color: white; }
    .btn-stock.plus { background: var(--sage); color: white; }
    .btn-stock.plus:hover { background: var(--sage-dark); }

    /* ========== LISTA COMPRA BANNER ========== */
    .lista-compra-banner {
      background: var(--warning-muted);
      border: 2px solid var(--warning);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .lista-compra-banner.hidden { display: none; }

    .lista-compra-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .lista-compra-icon { font-size: 1.5rem; }

    .lista-compra-text h3 { font-size: 0.95rem; }
    .lista-compra-text p { font-size: 0.8rem; color: var(--text-muted); }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
    .empty-state-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--text); }
    .empty-state-text { font-size: 0.9rem; margin-bottom: 20px; }

    /* ========== DASHBOARD GRID ========== */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .dashboard-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-float);
      border-color: var(--mayordomo-light);
    }

    .dashboard-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .dashboard-card.disabled:hover {
      transform: none;
      box-shadow: var(--shadow-soft);
      border-color: transparent;
    }

    .dashboard-card-icon {
      width: 56px;
      height: 56px;
      background: var(--mayordomo-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      flex-shrink: 0;
    }

    .dashboard-card-content {
      flex: 1;
    }

    .dashboard-card-content h3 {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .dashboard-card-content p {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .dashboard-card-arrow {
      font-size: 1.2rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .dashboard-card:hover .dashboard-card-arrow {
      transform: translateX(4px);
      color: var(--mayordomo);
    }

    .dashboard-card.disabled:hover .dashboard-card-arrow {
      transform: none;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .dashboard-card {
        padding: 16px;
      }
      
      .dashboard-card-icon {
        width: 48px;
        height: 48px;
        font-size: 1.5rem;
      }
    }

    /* ========== MODALS ========== */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 20px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body { padding: 24px; }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--cream-dark);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    /* ========== FORM ========== */
    .form-group { margin-bottom: 16px; }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--mayordomo);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* ========== OTROS M√ìDULOS (placeholder) ========== */
    .modulo-placeholder {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 40px;
      text-align: center;
      box-shadow: var(--shadow-soft);
    }

    .modulo-placeholder-icon { font-size: 3rem; margin-bottom: 16px; }
    .modulo-placeholder-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; }
    .modulo-placeholder-text { color: var(--text-muted); font-size: 0.9rem; }

    /* ========== MANTENIMIENTO ========== */
    .mant-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .mant-tab {
      padding: 10px 16px;
      background: var(--white);
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mant-tab:hover { border-color: var(--mayordomo-light); }
    .mant-tab.active { background: var(--mayordomo); color: white; border-color: var(--mayordomo); }

    .mant-tab-count {
      margin-left: 6px;
      padding: 2px 8px;
      background: rgba(0,0,0,0.1);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
    }

    .mant-tab.active .mant-tab-count { background: rgba(255,255,255,0.2); }

    .mant-subsection { display: none; }
    .mant-subsection.active { display: block; }

    .mant-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .mant-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .mant-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .herramienta-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s;
      cursor: pointer;
    }

    .herramienta-card:hover { box-shadow: var(--shadow-medium); }

    .herramienta-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .herramienta-nombre {
      font-weight: 700;
      font-size: 0.95rem;
      flex: 1;
    }

    .herramienta-estado {
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 600;
    }

    .herramienta-estado.disponible { background: var(--sage-muted); color: var(--sage-dark); }
    .herramienta-estado.prestada { background: var(--warning-muted); color: var(--warning); }
    .herramienta-estado.averiada { background: var(--error-muted); color: var(--error); }

    .herramienta-meta { font-size: 0.8rem; color: var(--text-muted); }
    .herramienta-ubicacion { font-size: 0.75rem; color: var(--text-light); margin-top: 6px; }

    .reparacion-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-soft);
      border-left: 4px solid var(--cream-dark);
      transition: all 0.2s;
      cursor: pointer;
    }

    .reparacion-card:hover { box-shadow: var(--shadow-medium); }
    .reparacion-card.pendiente { border-left-color: var(--warning); }
    .reparacion-card.en-curso { border-left-color: var(--sage); }
    .reparacion-card.completada { border-left-color: var(--text-muted); }
    .reparacion-card.urgente { border-left-color: var(--error); background: var(--error-muted); }

    .reparacion-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .reparacion-titulo { font-weight: 700; font-size: 0.95rem; flex: 1; }

    .reparacion-estado {
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .reparacion-estado.pendiente { background: var(--warning-muted); color: var(--warning); }
    .reparacion-estado.en-curso { background: var(--sage-muted); color: var(--sage-dark); }
    .reparacion-estado.completada { background: var(--cream); color: var(--text-muted); }

    .reparacion-descripcion { font-size: 0.85rem; color: var(--text-light); margin-bottom: 10px; }

    .reparacion-meta {
      display: flex;
      gap: 16px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .tarea-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s;
      cursor: pointer;
    }

    .tarea-card:hover { box-shadow: var(--shadow-medium); }
    .tarea-card.vencida { background: var(--error-muted); }
    .tarea-card.proxima { background: var(--warning-muted); }

    .tarea-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .tarea-titulo { font-weight: 700; font-size: 0.95rem; }

    .tarea-frecuencia {
      padding: 3px 8px;
      background: var(--cream);
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-light);
    }

    .tarea-descripcion { font-size: 0.85rem; color: var(--text-light); margin-bottom: 10px; }

    .tarea-fechas {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
      padding: 8px;
      background: var(--cream-medium);
      border-radius: var(--radius-sm);
    }

    .tarea-fecha-label { font-weight: 600; }

    .manual-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s;
      cursor: pointer;
    }

    .manual-card:hover { box-shadow: var(--shadow-medium); background: var(--cream-medium); }

    .manual-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .manual-icono {
      width: 40px;
      height: 40px;
      background: var(--mayordomo-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--mayordomo);
    }

    .manual-titulo { font-weight: 700; font-size: 0.95rem; flex: 1; }
    .manual-descripcion { font-size: 0.8rem; color: var(--text-muted); }

    .manual-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--cream-dark);
    }

    .mant-filtros {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .mant-filtro {
      padding: 6px 12px;
      background: var(--cream);
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mant-filtro:hover { background: var(--cream-dark); }
    .mant-filtro.active { background: var(--mayordomo-muted); border-color: var(--mayordomo); color: var(--mayordomo); }

    .mant-empty {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .mant-empty-titulo {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 8px;
      color: var(--text-light);
    }

    .hidden { display: none !important; }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
      .productos-grid { grid-template-columns: 1fr; }
      .mant-grid { grid-template-columns: 1fr; }
    }

    /* ========== EDICI√ìN INVENTARIO ========== */
    .edit-inv-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .edit-inv-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream-dark);
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .edit-inv-tab:hover { border-color: var(--mayordomo-light); }
    .edit-inv-tab.active { background: var(--mayordomo); color: white; }

    .edit-inv-tab-del {
      background: none;
      border: none;
      color: inherit;
      opacity: 0.5;
      cursor: pointer;
      font-size: 1rem;
      padding: 0 0 0 4px;
    }

    .edit-inv-tab-del:hover { opacity: 1; color: var(--error); }
    .edit-inv-tab.active .edit-inv-tab-del:hover { color: #ffaaaa; }

    .edit-inv-add-lugar {
      padding: 8px 14px;
      background: transparent;
      border: 1px dashed var(--mayordomo-light);
      border-radius: var(--radius-md);
      color: var(--mayordomo);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .edit-inv-add-lugar:hover { background: var(--mayordomo-muted); }

    .edit-inv-lugar-content {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
    }

    .edit-inv-grupo {
      background: white;
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      overflow: hidden;
    }

    .edit-inv-grupo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--cream-dark);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .edit-inv-grupo-header button {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1rem;
    }

    .edit-inv-grupo-header button:hover { color: var(--error); }

    .edit-inv-articulos { padding: 12px; }

    .edit-inv-art-header {
      display: grid;
      grid-template-columns: 1fr 100px 80px 70px 32px;
      gap: 8px;
      padding: 0 4px 8px;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .edit-inv-art-row {
      display: grid;
      grid-template-columns: 1fr 100px 80px 70px 32px;
      gap: 8px;
      align-items: center;
      padding: 6px 4px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .edit-inv-art-row:last-child { border-bottom: none; }

    .edit-inv-art-row input {
      padding: 6px 8px;
      border: 1px solid var(--cream-dark);
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: 'Nunito', sans-serif;
    }

    .edit-inv-art-row input:focus {
      outline: none;
      border-color: var(--mayordomo);
    }

    .edit-inv-art-row input[type="number"] { text-align: center; }

    .edit-inv-art-del {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1rem;
      padding: 4px;
    }

    .edit-inv-art-del:hover { color: var(--error); }

    .edit-inv-add-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: transparent;
      border: 1px dashed var(--mayordomo-light);
      border-radius: 6px;
      color: var(--mayordomo);
      font-size: 0.8rem;
      cursor: pointer;
      margin-top: 8px;
    }

    .edit-inv-add-btn:hover { background: var(--mayordomo-muted); }

    .edit-inv-danger-zone {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--cream-dark);
      text-align: right;
    }

    .reauth-icon {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .reauth-msg {
      text-align: center;
      margin-bottom: 20px;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .reauth-error {
      background: rgba(212, 105, 90, 0.1);
      color: var(--error);
      padding: 10px;
      border-radius: var(--radius-sm);
      margin-bottom: 12px;
      font-size: 0.85rem;
      text-align: center;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="bien.html" class="back-btn" id="btn-volver">‚Üê Volver</a>
      <div class="header-title">
        <div class="header-icon">üé©</div>
        <div class="header-info">
          <h1>Mayordomo</h1>
          <p id="bien-nombre">Cargando...</p>
        </div>
      </div>
    </div>
    <span class="header-badge">Premium</span>
  </header>

  <!-- Layout -->
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Gesti√≥n</div>
        <nav class="sidebar-nav">
          <a class="sidebar-link" href="#" onclick="irAModulo('inventario-config')">
            <span class="sidebar-link-icon">üì¶</span>
            Inventario
          </a>
          <a class="sidebar-link" href="#" onclick="irAModulo('reservas')">
            <span class="sidebar-link-icon">üìÖ</span>
            Reservas
          </a>
          <div class="sidebar-submenu">
            <div class="sidebar-submenu-title">
              <span class="sidebar-link-icon">üîß</span>
              Mantenimiento
            </div>
            <a class="sidebar-sublink" href="#" onclick="irAModulo('taller')">üõ†Ô∏è Taller</a>
            <a class="sidebar-sublink" href="#" onclick="irAModulo('reparaciones')">üî© Reparaciones</a>
            <a class="sidebar-sublink" href="#" onclick="irAModulo('mant-programado')">üìã Programado</a>
            <a class="sidebar-sublink" href="#" onclick="irAModulo('manual-mantenimiento')">üìñ Manual</a>
          </div>
          <a class="sidebar-link" href="#" onclick="irAModulo('limpieza')">
            <span class="sidebar-link-icon">üßπ</span>
            Limpieza
          </a>
          <a class="sidebar-link" href="#" onclick="irAModulo('eventos')">
            <span class="sidebar-link-icon">üéâ</span>
            Eventos
          </a>
          <a class="sidebar-link" href="#" onclick="irAModulo('gastos')">
            <span class="sidebar-link-icon">üí∂</span>
            Gastos
          </a>
          <a class="sidebar-link" href="#" onclick="irAModulo('servicios')">
            <span class="sidebar-link-icon">üõéÔ∏è</span>
            Otros Servicios
          </a>
        </nav>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">Configuraci√≥n</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link" data-section="caseros">
            <span class="sidebar-link-icon">üë∑</span>
            Caseros
          </button>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- ==================== DASHBOARD ==================== -->
      <section class="section active" id="section-dashboard">
        <div class="section-header">
          <h2 class="section-title">Panel de Control</h2>
          <p class="section-description">Acceso r√°pido a todos los m√≥dulos de gesti√≥n</p>
        </div>

        <div class="dashboard-grid">
          <!-- Inventario -->
          <div class="dashboard-card" onclick="irAModulo('inventario-config')">
            <div class="dashboard-card-icon">üì¶</div>
            <div class="dashboard-card-content">
              <h3>Inventario</h3>
              <p>Configurar estructura y stock</p>
            </div>
            <span class="dashboard-card-arrow">‚Üí</span>
          </div>

          <!-- Toma de Inventario -->
          <div class="dashboard-card" onclick="irAModulo('toma-inventario')">
            <div class="dashboard-card-icon">üìã</div>
            <div class="dashboard-card-content">
              <h3>Toma de Inventario</h3>
              <p>Conteo y actualizaci√≥n r√°pida</p>
            </div>
            <span class="dashboard-card-arrow">‚Üí</span>
          </div>

          <!-- Reservas -->
          <div class="dashboard-card" onclick="irAModulo('reservas')">
            <div class="dashboard-card-icon">üìÖ</div>
            <div class="dashboard-card-content">
              <h3>Reservas</h3>
              <p>Calendario de uso</p>
            </div>
            <span class="dashboard-card-arrow">‚Üí</span>
          </div>

          <!-- Taller -->
          <div class="dashboard-card" onclick="irAModulo('taller')">
            <div class="dashboard-card-icon">üõ†Ô∏è</div>
            <div class="dashboard-card-content">
              <h3>Taller</h3>
              <p>Herramientas disponibles</p>
            </div>
            <span class="dashboard-card-arrow">‚Üí</span>
          </div>

          <!-- Reparaciones -->
          <div class="dashboard-card" onclick="irAModulo('reparaciones')">
            <div class="dashboard-card-icon">üî©</div>
            <div class="dashboard-card-content">
              <h3>Reparaciones</h3>
              <p>Incidencias y mejoras</p>
            </div>
            <span class="dashboard-card-arrow">‚Üí</span>
          </div>

          <!-- Mantenimiento Programado -->
          <div class="dashboard-card" onclick="irAModulo('mant-programado')">
            <div class="dashboard-card-icon">üîß</div>
            <div class="dashboard-card-content">
              <h3>Mant. Programado</h3>
              <p>Tareas peri√≥dicas</p>
            </div>
            <span class="dashboard-card-arrow">‚Üí</span>
          </div>

          <!-- Manual Mantenimiento -->
          <div class="dashboard-card" onclick="irAModulo('manual-mantenimiento')">
            <div class="dashboard-card-icon">üìñ</div>
            <div class="dashboard-card-content">
              <h3>Manual T√©cnico</h3>
              <p>Documentaci√≥n del bien</p>
            </div>
            <span class="dashboard-card-arrow">‚Üí</span>
          </div>

          <!-- Gastos -->
          <div class="dashboard-card disabled" title="Pr√≥ximamente">
            <div class="dashboard-card-icon">üí∂</div>
            <div class="dashboard-card-content">
              <h3>Gastos</h3>
              <p>Pr√≥ximamente</p>
            </div>
            <span class="dashboard-card-arrow">‚Üí</span>
          </div>

          <!-- Limpieza -->
          <div class="dashboard-card disabled" title="Pr√≥ximamente">
            <div class="dashboard-card-icon">üßπ</div>
            <div class="dashboard-card-content">
              <h3>Limpieza</h3>
              <p>Pr√≥ximamente</p>
            </div>
            <span class="dashboard-card-arrow">‚Üí</span>
          </div>
        </div>
      </section>

      <!-- ==================== CASEROS ==================== -->
      <section class="section" id="section-caseros">
        <div class="section-header">
          <h2 class="section-title">üë∑ Caseros</h2>
          <p class="section-description">Gesti√≥n de accesos y permisos</p>
        </div>
        <div class="modulo-placeholder">
          <div class="modulo-placeholder-icon">üë∑</div>
          <div class="modulo-placeholder-title">M√≥dulo de Caseros</div>
          <div class="modulo-placeholder-text">Gestiona caseros desde la ficha del bien</div>
          <button class="btn btn-secondary" onclick="window.location.href=`bien.html?id=${bienId}`">Ir a ficha del bien</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal Art√≠culo -->
  <div class="modal-overlay" id="modal-producto">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-producto-titulo">Nuevo art√≠culo</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-producto" onsubmit="guardarArticuloModal(event)">
        <input type="hidden" id="producto-id">
        <input type="hidden" id="producto-lugar-key">
        <input type="hidden" id="producto-grupo-key">
        <input type="hidden" id="producto-idx">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre del art√≠culo</label>
            <input type="text" class="form-input" id="producto-nombre" placeholder="Ej: Leche entera" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Lugar</label>
              <select class="form-select" id="producto-lugar" required onchange="cargarGruposSelect()">
                <option value="">Selecciona lugar...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Grupo</label>
              <select class="form-select" id="producto-grupo" required>
                <option value="">Selecciona grupo...</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Formato</label>
              <input type="text" class="form-input" id="producto-formato" placeholder="Ej: 1L, 500g, pack 6">
            </div>
            <div class="form-group">
              <label class="form-label">Unidad</label>
              <input type="text" class="form-input" id="producto-unidad" placeholder="uds, kg, litros..." value="uds">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Stock actual</label>
              <input type="number" class="form-input" id="producto-stock" min="0" value="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Stock m√≠nimo</label>
              <input type="number" class="form-input" id="producto-minimo" min="0" value="1" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-producto" onclick="eliminarArticuloModal()">Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
            <button type="submit" class="btn btn-mayordomo">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Lista de Compra -->
  <div class="modal-overlay" id="modal-lista">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header">
        <h3 class="modal-title">üõí Lista de Compra</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body">
        <p style="color:var(--text-muted);margin-bottom:16px;font-size:0.9rem;">
          Productos que est√°n por debajo del stock m√≠nimo. Marca los que hayas comprado.
        </p>
        <div id="lista-compra-items">
          <!-- Se carga din√°micamente -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cerrar</button>
        <button class="btn btn-mayordomo" onclick="marcarComprados()">‚úì Marcar comprados</button>
      </div>
    </div>
  </div>

  <!-- Modal Herramienta -->
  <div class="modal-overlay" id="modal-herramienta">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-herramienta-titulo">Nueva herramienta</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-herramienta" onsubmit="guardarHerramienta(event)">
        <input type="hidden" id="herramienta-id">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-input" id="herramienta-nombre" placeholder="Ej: Taladro Bosch" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="herramienta-categoria">
                <option value="electricas">El√©ctricas</option>
                <option value="manuales">Manuales</option>
                <option value="medicion">Medici√≥n</option>
                <option value="jardineria">Jardiner√≠a</option>
                <option value="fontaneria">Fontaner√≠a</option>
                <option value="otras">Otras</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Estado</label>
              <select class="form-select" id="herramienta-estado">
                <option value="disponible">Disponible</option>
                <option value="prestada">Prestada</option>
                <option value="averiada">Averiada</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Ubicaci√≥n</label>
            <input type="text" class="form-input" id="herramienta-ubicacion" placeholder="Ej: Garaje, estanter√≠a 2">
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-input" id="herramienta-notas" rows="2" placeholder="Observaciones..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger hidden" id="btn-eliminar-herramienta" onclick="eliminarHerramienta()">Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
            <button type="submit" class="btn btn-mayordomo">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Reparaci√≥n -->
  <div class="modal-overlay" id="modal-reparacion">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-reparacion-titulo">Nueva reparaci√≥n</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-reparacion" onsubmit="guardarReparacion(event)">
        <input type="hidden" id="reparacion-id">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">T√≠tulo</label>
            <input type="text" class="form-input" id="reparacion-titulo" placeholder="Ej: Arreglar grifo cocina" required>
          </div>
          <div class="form-group">
            <label class="form-label">Descripci√≥n</label>
            <textarea class="form-input" id="reparacion-descripcion" rows="3" placeholder="Detalle del problema..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Estado</label>
              <select class="form-select" id="reparacion-estado">
                <option value="pendiente">Pendiente</option>
                <option value="en-curso">En curso</option>
                <option value="completada">Completada</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Prioridad</label>
              <select class="form-select" id="reparacion-prioridad">
                <option value="baja">Baja</option>
                <option value="media">Media</option>
                <option value="alta">Alta</option>
                <option value="urgente">Urgente</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha reporte</label>
              <input type="date" class="form-input" id="reparacion-fecha">
            </div>
            <div class="form-group">
              <label class="form-label">Coste estimado</label>
              <input type="number" class="form-input" id="reparacion-coste" step="0.01" placeholder="0.00">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Responsable / Proveedor</label>
            <input type="text" class="form-input" id="reparacion-responsable" placeholder="Qui√©n lo hace...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger hidden" id="btn-eliminar-reparacion" onclick="eliminarReparacion()">Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
            <button type="submit" class="btn btn-mayordomo">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Tarea Programada -->
  <div class="modal-overlay" id="modal-tarea">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-tarea-titulo">Nueva tarea programada</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-tarea" onsubmit="guardarTarea(event)">
        <input type="hidden" id="tarea-id">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">T√≠tulo</label>
            <input type="text" class="form-input" id="tarea-titulo" placeholder="Ej: Revisi√≥n caldera" required>
          </div>
          <div class="form-group">
            <label class="form-label">Descripci√≥n</label>
            <textarea class="form-input" id="tarea-descripcion" rows="2" placeholder="Qu√© hay que hacer..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Frecuencia</label>
              <select class="form-select" id="tarea-frecuencia">
                <option value="mensual">Mensual</option>
                <option value="trimestral">Trimestral</option>
                <option value="semestral">Semestral</option>
                <option value="anual">Anual</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="tarea-categoria">
                <option value="calefaccion">Calefacci√≥n</option>
                <option value="fontaneria">Fontaner√≠a</option>
                <option value="electricidad">Electricidad</option>
                <option value="jardineria">Jardiner√≠a</option>
                <option value="limpieza">Limpieza profunda</option>
                <option value="seguridad">Seguridad</option>
                <option value="otra">Otra</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">√öltima realizaci√≥n</label>
              <input type="date" class="form-input" id="tarea-ultima">
            </div>
            <div class="form-group">
              <label class="form-label">Pr√≥xima</label>
              <input type="date" class="form-input" id="tarea-proxima">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Responsable</label>
            <input type="text" class="form-input" id="tarea-responsable" placeholder="Qui√©n lo hace...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger hidden" id="btn-eliminar-tarea" onclick="eliminarTarea()">Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
            <button type="submit" class="btn btn-mayordomo">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Manual -->
  <div class="modal-overlay" id="modal-manual">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-manual-titulo">Nueva entrada de manual</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-manual" onsubmit="guardarManual(event)">
        <input type="hidden" id="manual-id">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">T√≠tulo</label>
            <input type="text" class="form-input" id="manual-titulo" placeholder="Ej: Instrucciones caldera" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="manual-tipo">
                <option value="instrucciones">Instrucciones</option>
                <option value="proveedores">Proveedores</option>
                <option value="garantias">Garant√≠as</option>
                <option value="planos">Planos</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="manual-categoria">
                <option value="calefaccion">Calefacci√≥n</option>
                <option value="fontaneria">Fontaner√≠a</option>
                <option value="electricidad">Electricidad</option>
                <option value="electrodomesticos">Electrodom√©sticos</option>
                <option value="jardineria">Jardiner√≠a</option>
                <option value="general">General</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Contenido</label>
            <textarea class="form-input" id="manual-contenido" rows="6" placeholder="Instrucciones, datos de contacto, etc..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger hidden" id="btn-eliminar-manual" onclick="eliminarManual()">Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
            <button type="submit" class="btn btn-mayordomo">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Edici√≥n de Inventario -->
  <div class="modal-overlay" id="modal-edit-inventario">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">Editar Inventario</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body" style="max-height: 65vh; overflow-y: auto;">
        <div class="edit-inv-tabs" id="edit-inv-tabs"></div>
        <div class="edit-inv-lugar-content" id="edit-inv-content">
          <p style="text-align:center; color:var(--text-muted); padding: 30px;">
            Selecciona o crea un lugar para comenzar
          </p>
        </div>
        <div class="edit-inv-danger-zone">
          <button class="btn btn-danger btn-sm" onclick="confirmarBorrarTodo()">
            Borrar todo el inventario
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-mayordomo" onclick="guardarInventarioEdit()">Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- Modal Reautenticaci√≥n -->
  <div class="modal-overlay" id="modal-reauth" style="z-index: 1100;">
    <div class="modal" style="max-width: 380px;">
      <div class="modal-header">
        <h3 class="modal-title">Confirmar identidad</h3>
        <button class="modal-close" onclick="cerrarReauth()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="reauth-icon">üîê</div>
        <p class="reauth-msg">
          Esta acci√≥n es irreversible. Por seguridad, confirma tus credenciales.
        </p>
        <div class="reauth-error" id="reauth-error">Credenciales incorrectas</div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="reauth-email" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Contrase√±a</label>
          <input type="password" class="form-input" id="reauth-password" placeholder="Tu contrase√±a">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarReauth()">Cancelar</button>
        <button class="btn btn-danger" onclick="ejecutarReauth()">Confirmar y borrar</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ========== VARIABLES GLOBALES ==========
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let familiaId = null;
    
    // ========== INVENTARIO DIN√ÅMICO ==========
    let inventario = {};  // Lugar > Grupo > Art√≠culos
    let lugarActual = null;
    let grupoActual = null;

    // ========== INIT ==========
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      
      // Obtener bienId de URL
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('bien') || params.get('id');
      
      if (!bienId) {
        alert('No se especific√≥ el bien');
        window.location.href = 'lo-comun.html';
        return;
      }

      await cargarBien();
      await cargarInventario();
      
      initEventListeners();
    });

    async function cargarBien() {
      const doc = await db.collection('bienes').doc(bienId).get();
      if (!doc.exists) {
        alert('Bien no encontrado');
        window.location.href = 'lo-comun.html';
        return;
      }
      
      bienData = doc.data();
      familiaId = bienData.familiaId;
      
      document.getElementById('bien-nombre').textContent = bienData.nombre || 'Sin nombre';
      document.getElementById('btn-volver').href = `bien.html?id=${bienId}`;
    }

    async function cargarInventario() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        inventario = doc.data()?.inventario || {};
        
        renderLugaresTabs();
        actualizarContadores();
      } catch (error) {
        console.error('Error cargando inventario:', error);
      }
    }

    function renderLugaresTabs() {
      const container = document.getElementById('inventario-tabs');
      const lugares = Object.keys(inventario);
      
      if (lugares.length === 0) {
        container.innerHTML = `
          <div style="color:var(--text-muted); padding: 8px;">
            Sin lugares definidos. 
            <button class="btn btn-secondary btn-sm" onclick="abrirEditInventario()" style="margin-left:8px;">Crear estructura</button>
          </div>
        `;
        document.getElementById('productos-grid').innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="empty-state-icon">üì¶</div>
            <div class="empty-state-title">Sin inventario</div>
            <div class="empty-state-text">Define la estructura de lugares y grupos</div>
            <button class="btn btn-mayordomo" onclick="abrirEditInventario()">Crear estructura</button>
          </div>
        `;
        return;
      }
      
      // Si no hay lugar seleccionado, seleccionar el primero
      if (!lugarActual || !inventario[lugarActual]) {
        lugarActual = lugares[0];
      }
      
      container.innerHTML = lugares.map(key => `
        <button class="inventario-tab ${key === lugarActual ? 'active' : ''}" data-lugar="${key}" onclick="seleccionarLugar('${key}')">
          ${inventario[key].nombre}
          <span class="inventario-tab-count">${contarArticulosLugar(key)}</span>
        </button>
      `).join('');
      
      renderArticulos();
    }

    function contarArticulosLugar(lugarKey) {
      const lugar = inventario[lugarKey];
      if (!lugar?.grupos) return 0;
      
      let total = 0;
      Object.values(lugar.grupos).forEach(grupo => {
        total += (grupo.articulos || []).length;
      });
      return total;
    }

    function seleccionarLugar(lugarKey) {
      lugarActual = lugarKey;
      grupoActual = null;
      
      document.querySelectorAll('.inventario-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.lugar === lugarKey);
      });
      
      renderArticulos();
    }

    function renderArticulos() {
      const lugar = inventario[lugarActual];
      if (!lugar) return;
      
      const container = document.getElementById('productos-grid');
      const titulo = document.getElementById('grupo-title');
      titulo.textContent = lugar.nombre;
      
      const grupos = lugar.grupos || {};
      
      if (Object.keys(grupos).length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="empty-state-icon">üì¶</div>
            <div class="empty-state-title">Sin grupos</div>
            <div class="empty-state-text">A√±ade grupos desde "Editar estructura"</div>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      for (const [grupoKey, grupo] of Object.entries(grupos)) {
        const articulos = grupo.articulos || [];
        
        html += `<div class="grupo-section" style="grid-column: 1/-1; margin-bottom: 16px;">
          <div style="font-weight:600; font-size:0.9rem; color:var(--mayordomo); margin-bottom:8px; padding:8px 0; border-bottom:1px solid var(--cream-dark);">
            ${grupo.nombre} (${articulos.length})
          </div>
          <div class="productos-subgrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:12px;">`;
        
        if (articulos.length === 0) {
          html += `<div style="color:var(--text-muted); font-size:0.85rem; padding:12px;">Sin art√≠culos</div>`;
        } else {
          articulos.forEach((art, idx) => {
            const porcentaje = art.minimo > 0 ? Math.min(100, ((art.actual || 0) / art.minimo) * 100) : 100;
            const estado = (art.actual || 0) === 0 ? 'critico' : (art.actual || 0) < art.minimo ? 'bajo' : 'ok';
            
            html += `
              <div class="producto-card ${estado !== 'ok' ? estado : ''}" onclick="editarArticuloModal('${lugarActual}', '${grupoKey}', ${idx})">
                <div class="producto-header">
                  <div class="producto-info">
                    <div class="producto-nombre">${art.nombre}</div>
                    <div class="producto-subgrupo">${art.formato || ''}</div>
                  </div>
                </div>
                <div class="producto-stock">
                  <div class="stock-visual">
                    <div class="stock-bar ${estado}" style="width: ${porcentaje}%"></div>
                  </div>
                  <span class="stock-text ${estado}">${art.actual || 0}/${art.minimo} ${art.unidad || 'uds'}</span>
                </div>
                <div class="producto-actions" onclick="event.stopPropagation()">
                  <button class="btn-stock minus" onclick="cambiarStock('${lugarActual}', '${grupoKey}', ${idx}, -1)">‚àí</button>
                  <span style="font-size:0.8rem;color:var(--text-muted)">${art.unidad || 'uds'}</span>
                  <button class="btn-stock plus" onclick="cambiarStock('${lugarActual}', '${grupoKey}', ${idx}, 1)">+</button>
                </div>
              </div>
            `;
          });
        }
        
        html += `</div></div>`;
      }
      
      container.innerHTML = html;
    }

    function actualizarContadores() {
      let totalBajo = 0;
      
      for (const lugar of Object.values(inventario)) {
        for (const grupo of Object.values(lugar.grupos || {})) {
          for (const art of (grupo.articulos || [])) {
            if ((art.actual || 0) < art.minimo) totalBajo++;
          }
        }
      }
      
      const badge = document.getElementById('badge-inventario');
      const banner = document.getElementById('lista-compra-banner');
      
      if (totalBajo > 0) {
        badge.textContent = totalBajo;
        badge.style.display = 'inline';
        banner.classList.remove('hidden');
        document.getElementById('items-pendientes').textContent = totalBajo;
      } else {
        badge.style.display = 'none';
        banner.classList.add('hidden');
      }
    }

    async function cambiarStock(lugarKey, grupoKey, idx, delta) {
      const art = inventario[lugarKey].grupos[grupoKey].articulos[idx];
      art.actual = Math.max(0, (art.actual || 0) + delta);
      
      try {
        await db.collection('bienes').doc(bienId).update({ inventario });
        renderArticulos();
        actualizarContadores();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ========== MODAL ART√çCULO ==========
    function abrirModalProducto() {
      document.getElementById('form-producto').reset();
      document.getElementById('producto-id').value = '';
      document.getElementById('producto-lugar-key').value = '';
      document.getElementById('producto-grupo-key').value = '';
      document.getElementById('producto-idx').value = '';
      document.getElementById('modal-producto-titulo').textContent = 'Nuevo art√≠culo';
      document.getElementById('btn-eliminar-producto').classList.add('hidden');
      
      cargarLugaresSelect();
      
      // Preseleccionar lugar actual
      if (lugarActual) {
        document.getElementById('producto-lugar').value = lugarActual;
        cargarGruposSelect();
      }
      
      document.getElementById('modal-producto').classList.add('active');
    }

    function editarArticuloModal(lugarKey, grupoKey, idx) {
      const art = inventario[lugarKey].grupos[grupoKey].articulos[idx];
      
      document.getElementById('producto-lugar-key').value = lugarKey;
      document.getElementById('producto-grupo-key').value = grupoKey;
      document.getElementById('producto-idx').value = idx;
      
      cargarLugaresSelect();
      document.getElementById('producto-lugar').value = lugarKey;
      cargarGruposSelect();
      document.getElementById('producto-grupo').value = grupoKey;
      
      document.getElementById('producto-nombre').value = art.nombre || '';
      document.getElementById('producto-formato').value = art.formato || '';
      document.getElementById('producto-unidad').value = art.unidad || 'uds';
      document.getElementById('producto-stock').value = art.actual || 0;
      document.getElementById('producto-minimo').value = art.minimo || 1;
      
      document.getElementById('modal-producto-titulo').textContent = 'Editar art√≠culo';
      document.getElementById('btn-eliminar-producto').classList.remove('hidden');
      
      document.getElementById('modal-producto').classList.add('active');
    }

    function cargarLugaresSelect() {
      const select = document.getElementById('producto-lugar');
      const lugares = Object.keys(inventario);
      
      select.innerHTML = `<option value="">Selecciona lugar...</option>` +
        lugares.map(key => `<option value="${key}">${inventario[key].nombre}</option>`).join('');
    }

    function cargarGruposSelect() {
      const lugarKey = document.getElementById('producto-lugar').value;
      const select = document.getElementById('producto-grupo');
      
      if (!lugarKey || !inventario[lugarKey]) {
        select.innerHTML = '<option value="">Selecciona grupo...</option>';
        return;
      }
      
      const grupos = inventario[lugarKey].grupos || {};
      
      select.innerHTML = `<option value="">Selecciona grupo...</option>` +
        Object.keys(grupos).map(key => `<option value="${key}">${grupos[key].nombre}</option>`).join('');
    }

    async function guardarArticuloModal(e) {
      e.preventDefault();
      
      const lugarKey = document.getElementById('producto-lugar').value;
      const grupoKey = document.getElementById('producto-grupo').value;
      const oldLugarKey = document.getElementById('producto-lugar-key').value;
      const oldGrupoKey = document.getElementById('producto-grupo-key').value;
      const oldIdx = document.getElementById('producto-idx').value;
      
      if (!lugarKey || !grupoKey) {
        alert('Selecciona lugar y grupo');
        return;
      }
      
      const articulo = {
        nombre: document.getElementById('producto-nombre').value.trim(),
        formato: document.getElementById('producto-formato').value.trim(),
        unidad: document.getElementById('producto-unidad').value.trim() || 'uds',
        actual: parseInt(document.getElementById('producto-stock').value) || 0,
        minimo: parseInt(document.getElementById('producto-minimo').value) || 1
      };
      
      // Si es edici√≥n y cambi√≥ de lugar/grupo, eliminar del antiguo
      if (oldIdx !== '' && (oldLugarKey !== lugarKey || oldGrupoKey !== grupoKey)) {
        inventario[oldLugarKey].grupos[oldGrupoKey].articulos.splice(parseInt(oldIdx), 1);
      }
      
      // Si es edici√≥n en mismo lugar/grupo
      if (oldIdx !== '' && oldLugarKey === lugarKey && oldGrupoKey === grupoKey) {
        inventario[lugarKey].grupos[grupoKey].articulos[parseInt(oldIdx)] = articulo;
      } else {
        // Nuevo art√≠culo
        if (!inventario[lugarKey].grupos[grupoKey].articulos) {
          inventario[lugarKey].grupos[grupoKey].articulos = [];
        }
        inventario[lugarKey].grupos[grupoKey].articulos.push(articulo);
      }
      
      try {
        await db.collection('bienes').doc(bienId).update({ inventario });
        cerrarModales();
        renderLugaresTabs();
        actualizarContadores();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar');
      }
    }

    async function eliminarArticuloModal() {
      const lugarKey = document.getElementById('producto-lugar-key').value;
      const grupoKey = document.getElementById('producto-grupo-key').value;
      const idx = document.getElementById('producto-idx').value;
      
      if (idx === '' || !confirm('¬øEliminar este art√≠culo?')) return;
      
      inventario[lugarKey].grupos[grupoKey].articulos.splice(parseInt(idx), 1);
      
      try {
        await db.collection('bienes').doc(bienId).update({ inventario });
        cerrarModales();
        renderLugaresTabs();
        actualizarContadores();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ========== LISTA DE COMPRA ==========
    function abrirListaCompra() {
      const container = document.getElementById('lista-compra-items');
      let items = [];
      
      for (const [lugarKey, lugar] of Object.entries(inventario)) {
        for (const [grupoKey, grupo] of Object.entries(lugar.grupos || {})) {
          for (let idx = 0; idx < (grupo.articulos || []).length; idx++) {
            const art = grupo.articulos[idx];
            if ((art.actual || 0) < art.minimo) {
              items.push({
                lugarKey, grupoKey, idx,
                lugar: lugar.nombre,
                grupo: grupo.nombre,
                ...art,
                faltan: art.minimo - (art.actual || 0)
              });
            }
          }
        }
      }
      
      if (items.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-muted)">No hay art√≠culos pendientes</p>';
      } else {
        container.innerHTML = items.map(p => `
          <label style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--cream);border-radius:var(--radius-md);margin-bottom:8px;cursor:pointer;">
            <input type="checkbox" class="lista-check" data-lugar="${p.lugarKey}" data-grupo="${p.grupoKey}" data-idx="${p.idx}" data-cantidad="${p.faltan}" style="width:20px;height:20px;">
            <div style="flex:1;">
              <div style="font-weight:600;">${p.nombre}</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">
                ${p.lugar} ‚Ä∫ ${p.grupo} | Comprar: ${p.faltan} ${p.unidad || 'uds'}
              </div>
            </div>
          </label>
        `).join('');
      }
      
      document.getElementById('modal-lista').classList.add('active');
    }

    async function marcarComprados() {
      const checks = document.querySelectorAll('.lista-check:checked');
      
      for (const check of checks) {
        const lugarKey = check.dataset.lugar;
        const grupoKey = check.dataset.grupo;
        const idx = parseInt(check.dataset.idx);
        const cantidad = parseInt(check.dataset.cantidad) || 0;
        
        const art = inventario[lugarKey].grupos[grupoKey].articulos[idx];
        art.actual = (art.actual || 0) + cantidad;
      }
      
      try {
        await db.collection('bienes').doc(bienId).update({ inventario });
        cerrarModales();
        renderLugaresTabs();
        actualizarContadores();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ========== NAVEGACI√ìN ==========
    function cambiarSeccion(seccion) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      
      const sectionEl = document.getElementById(`section-${seccion}`);
      if (sectionEl) sectionEl.classList.add('active');
      
      const linkEl = document.querySelector(`[data-section="${seccion}"]`);
      if (linkEl) linkEl.classList.add('active');
    }

    function irAModulo(modulo) {
      const modulosUrls = {
        'inventario-config': `inventario-config.html?id=${bienId}&origen=mayordomo`,
        'toma-inventario': `toma-inventario.html?id=${bienId}&origen=mayordomo`,
        'reservas': `reservas.html?id=${bienId}&origen=mayordomo`,
        'taller': `taller.html?id=${bienId}&origen=mayordomo`,
        'reparaciones': `reparaciones.html?id=${bienId}&origen=mayordomo`,
        'mant-programado': `mant-programado.html?id=${bienId}&origen=mayordomo`,
        'manual-mantenimiento': `manual-mantenimiento.html?id=${bienId}&origen=mayordomo`,
        'gastos': `gastos.html?id=${bienId}&origen=mayordomo`,
        'limpieza': `limpieza.html?id=${bienId}&origen=mayordomo`,
        'eventos': `eventos.html?id=${bienId}&origen=mayordomo`,
        'servicios': `servicios.html?id=${bienId}&origen=mayordomo`
      };
      
      const url = modulosUrls[modulo];
      if (url) {
        window.location.href = url;
      } else {
        alert('M√≥dulo no disponible');
      }
    }

    function initEventListeners() {
      // Solo el bot√≥n de caseros usa cambiarSeccion
      document.querySelectorAll('.sidebar-link[data-section]').forEach(link => {
        link.addEventListener('click', () => {
          cambiarSeccion(link.dataset.section);
        });
      });
    }

    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    }

    // Cerrar modales con click fuera
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) cerrarModales();
      });
    });

    // ========== MANTENIMIENTO ==========
    let herramientas = [];
    let reparaciones = [];
    let tareasProgramadas = [];
    let manualEntradas = [];
    let filtroHerramientas = 'todas';
    let filtroReparaciones = 'todas';
    let filtroTareas = 'todas';
    let filtroManual = 'todos';
    let mantCargado = false;

    function cambiarMantTab(tab) {
      document.querySelectorAll('.mant-tab').forEach(t => t.classList.toggle('active', t.dataset.mant === tab));
      document.querySelectorAll('.mant-subsection').forEach(s => s.classList.toggle('active', s.id === `mant-${tab}`));
    }

    async function cargarDatosMantenimiento() {
      if (mantCargado) return;
      try {
        const snapHerr = await db.collection('bienes').doc(bienId).collection('herramientas').get();
        herramientas = snapHerr.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const snapRep = await db.collection('bienes').doc(bienId).collection('reparaciones').orderBy('fecha', 'desc').get();
        reparaciones = snapRep.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const snapTar = await db.collection('bienes').doc(bienId).collection('tareasProgramadas').get();
        tareasProgramadas = snapTar.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const snapMan = await db.collection('bienes').doc(bienId).collection('manual').get();
        manualEntradas = snapMan.docs.map(d => ({ id: d.id, ...d.data() }));
        
        actualizarContadoresMant();
        renderHerramientas();
        renderReparaciones();
        renderTareasProgramadas();
        renderManual();
        mantCargado = true;
      } catch (error) {
        console.error('Error cargando mantenimiento:', error);
      }
    }

    function actualizarContadoresMant() {
      document.getElementById('count-herramientas').textContent = herramientas.length;
      document.getElementById('count-reparaciones').textContent = reparaciones.filter(r => r.estado !== 'completada').length;
      document.getElementById('count-programado').textContent = tareasProgramadas.length;
      document.getElementById('count-manual').textContent = manualEntradas.length;
    }

    function renderHerramientas() {
      const grid = document.getElementById('grid-herramientas');
      const items = filtroHerramientas === 'todas' ? herramientas : herramientas.filter(h => h.categoria === filtroHerramientas);
      if (items.length === 0) {
        grid.innerHTML = '<div class="mant-empty"><div class="mant-empty-titulo">Sin herramientas</div>A√±ade herramientas para llevar control</div>';
        return;
      }
      grid.innerHTML = items.map(h => `
        <div class="herramienta-card" onclick="editarHerramienta('${h.id}')">
          <div class="herramienta-header">
            <div class="herramienta-nombre">${h.nombre}</div>
            <span class="herramienta-estado ${h.estado}">${h.estado}</span>
          </div>
          <div class="herramienta-meta">${h.categoria}</div>
          ${h.ubicacion ? `<div class="herramienta-ubicacion">${h.ubicacion}</div>` : ''}
        </div>
      `).join('');
    }

    function filtrarHerramientas(cat) {
      filtroHerramientas = cat;
      document.querySelectorAll('#filtros-herramientas .mant-filtro').forEach(f => f.classList.toggle('active', f.dataset.cat === cat));
      renderHerramientas();
    }

    function abrirModalHerramienta() {
      document.getElementById('form-herramienta').reset();
      document.getElementById('herramienta-id').value = '';
      document.getElementById('modal-herramienta-titulo').textContent = 'Nueva herramienta';
      document.getElementById('btn-eliminar-herramienta').classList.add('hidden');
      document.getElementById('modal-herramienta').classList.add('active');
    }

    function editarHerramienta(id) {
      const h = herramientas.find(x => x.id === id);
      if (!h) return;
      document.getElementById('herramienta-id').value = id;
      document.getElementById('herramienta-nombre').value = h.nombre || '';
      document.getElementById('herramienta-categoria').value = h.categoria || 'manuales';
      document.getElementById('herramienta-estado').value = h.estado || 'disponible';
      document.getElementById('herramienta-ubicacion').value = h.ubicacion || '';
      document.getElementById('herramienta-notas').value = h.notas || '';
      document.getElementById('modal-herramienta-titulo').textContent = 'Editar herramienta';
      document.getElementById('btn-eliminar-herramienta').classList.remove('hidden');
      document.getElementById('modal-herramienta').classList.add('active');
    }

    async function guardarHerramienta(e) {
      e.preventDefault();
      const id = document.getElementById('herramienta-id').value;
      const data = {
        nombre: document.getElementById('herramienta-nombre').value.trim(),
        categoria: document.getElementById('herramienta-categoria').value,
        estado: document.getElementById('herramienta-estado').value,
        ubicacion: document.getElementById('herramienta-ubicacion').value.trim(),
        notas: document.getElementById('herramienta-notas').value.trim(),
        actualizado: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        const ref = db.collection('bienes').doc(bienId).collection('herramientas');
        if (id) { await ref.doc(id).update(data); }
        else { data.creado = firebase.firestore.FieldValue.serverTimestamp(); await ref.add(data); }
        cerrarModales();
        mantCargado = false;
        await cargarDatosMantenimiento();
      } catch (error) { console.error(error); alert('Error al guardar'); }
    }

    async function eliminarHerramienta() {
      const id = document.getElementById('herramienta-id').value;
      if (!id || !confirm('¬øEliminar esta herramienta?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('herramientas').doc(id).delete();
        cerrarModales();
        mantCargado = false;
        await cargarDatosMantenimiento();
      } catch (error) { console.error(error); }
    }

    function renderReparaciones() {
      const grid = document.getElementById('grid-reparaciones');
      const items = filtroReparaciones === 'todas' ? reparaciones : reparaciones.filter(r => r.estado === filtroReparaciones);
      if (items.length === 0) {
        grid.innerHTML = '<div class="mant-empty"><div class="mant-empty-titulo">Sin reparaciones</div>Registra reparaciones y mejoras</div>';
        return;
      }
      grid.innerHTML = items.map(r => {
        const claseCard = r.prioridad === 'urgente' ? 'urgente' : r.estado;
        const fechaStr = r.fecha ? new Date(r.fecha).toLocaleDateString('es-ES') : '';
        return `
          <div class="reparacion-card ${claseCard}" onclick="editarReparacion('${r.id}')">
            <div class="reparacion-header">
              <div class="reparacion-titulo">${r.titulo}</div>
              <span class="reparacion-estado ${r.estado}">${(r.estado || '').replace('-', ' ')}</span>
            </div>
            ${r.descripcion ? `<div class="reparacion-descripcion">${r.descripcion}</div>` : ''}
            <div class="reparacion-meta">
              ${fechaStr ? `<span>${fechaStr}</span>` : ''}
              ${r.coste ? `<span>${r.coste}‚Ç¨</span>` : ''}
              ${r.responsable ? `<span>${r.responsable}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function filtrarReparaciones(estado) {
      filtroReparaciones = estado;
      document.querySelectorAll('#filtros-reparaciones .mant-filtro').forEach(f => f.classList.toggle('active', f.dataset.estado === estado));
      renderReparaciones();
    }

    function abrirModalReparacion() {
      document.getElementById('form-reparacion').reset();
      document.getElementById('reparacion-id').value = '';
      document.getElementById('reparacion-fecha').value = new Date().toISOString().split('T')[0];
      document.getElementById('modal-reparacion-titulo').textContent = 'Nueva reparaci√≥n';
      document.getElementById('btn-eliminar-reparacion').classList.add('hidden');
      document.getElementById('modal-reparacion').classList.add('active');
    }

    function editarReparacion(id) {
      const r = reparaciones.find(x => x.id === id);
      if (!r) return;
      document.getElementById('reparacion-id').value = id;
      document.getElementById('reparacion-titulo').value = r.titulo || '';
      document.getElementById('reparacion-descripcion').value = r.descripcion || '';
      document.getElementById('reparacion-estado').value = r.estado || 'pendiente';
      document.getElementById('reparacion-prioridad').value = r.prioridad || 'media';
      document.getElementById('reparacion-fecha').value = r.fecha || '';
      document.getElementById('reparacion-coste').value = r.coste || '';
      document.getElementById('reparacion-responsable').value = r.responsable || '';
      document.getElementById('modal-reparacion-titulo').textContent = 'Editar reparaci√≥n';
      document.getElementById('btn-eliminar-reparacion').classList.remove('hidden');
      document.getElementById('modal-reparacion').classList.add('active');
    }

    async function guardarReparacion(e) {
      e.preventDefault();
      const id = document.getElementById('reparacion-id').value;
      const data = {
        titulo: document.getElementById('reparacion-titulo').value.trim(),
        descripcion: document.getElementById('reparacion-descripcion').value.trim(),
        estado: document.getElementById('reparacion-estado').value,
        prioridad: document.getElementById('reparacion-prioridad').value,
        fecha: document.getElementById('reparacion-fecha').value,
        coste: parseFloat(document.getElementById('reparacion-coste').value) || null,
        responsable: document.getElementById('reparacion-responsable').value.trim(),
        actualizado: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        const ref = db.collection('bienes').doc(bienId).collection('reparaciones');
        if (id) { await ref.doc(id).update(data); }
        else { data.creado = firebase.firestore.FieldValue.serverTimestamp(); data.creadoPor = currentUser.uid; await ref.add(data); }
        cerrarModales();
        mantCargado = false;
        await cargarDatosMantenimiento();
      } catch (error) { console.error(error); alert('Error al guardar'); }
    }

    async function eliminarReparacion() {
      const id = document.getElementById('reparacion-id').value;
      if (!id || !confirm('¬øEliminar esta reparaci√≥n?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('reparaciones').doc(id).delete();
        cerrarModales();
        mantCargado = false;
        await cargarDatosMantenimiento();
      } catch (error) { console.error(error); }
    }

    function renderTareasProgramadas() {
      const grid = document.getElementById('grid-programado');
      const items = filtroTareas === 'todas' ? tareasProgramadas : tareasProgramadas.filter(t => t.frecuencia === filtroTareas);
      if (items.length === 0) {
        grid.innerHTML = '<div class="mant-empty"><div class="mant-empty-titulo">Sin tareas programadas</div>A√±ade tareas de mantenimiento peri√≥dico</div>';
        return;
      }
      const hoy = new Date();
      grid.innerHTML = items.map(t => {
        let claseCard = '';
        if (t.proxima) {
          const proxima = new Date(t.proxima);
          const diasFaltan = Math.ceil((proxima - hoy) / (1000 * 60 * 60 * 24));
          if (diasFaltan < 0) claseCard = 'vencida';
          else if (diasFaltan <= 7) claseCard = 'proxima';
        }
        return `
          <div class="tarea-card ${claseCard}" onclick="editarTarea('${t.id}')">
            <div class="tarea-header">
              <div class="tarea-titulo">${t.titulo}</div>
              <span class="tarea-frecuencia">${t.frecuencia}</span>
            </div>
            ${t.descripcion ? `<div class="tarea-descripcion">${t.descripcion}</div>` : ''}
            <div class="tarea-fechas">
              <div><span class="tarea-fecha-label">√öltima:</span> ${t.ultima || 'Sin datos'}</div>
              <div><span class="tarea-fecha-label">Pr√≥xima:</span> ${t.proxima || 'Sin definir'}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function filtrarTareas(frec) {
      filtroTareas = frec;
      document.querySelectorAll('#filtros-programado .mant-filtro').forEach(f => f.classList.toggle('active', f.dataset.frec === frec));
      renderTareasProgramadas();
    }

    function abrirModalTarea() {
      document.getElementById('form-tarea').reset();
      document.getElementById('tarea-id').value = '';
      document.getElementById('modal-tarea-titulo').textContent = 'Nueva tarea programada';
      document.getElementById('btn-eliminar-tarea').classList.add('hidden');
      document.getElementById('modal-tarea').classList.add('active');
    }

    function editarTarea(id) {
      const t = tareasProgramadas.find(x => x.id === id);
      if (!t) return;
      document.getElementById('tarea-id').value = id;
      document.getElementById('tarea-titulo').value = t.titulo || '';
      document.getElementById('tarea-descripcion').value = t.descripcion || '';
      document.getElementById('tarea-frecuencia').value = t.frecuencia || 'anual';
      document.getElementById('tarea-categoria').value = t.categoria || 'otra';
      document.getElementById('tarea-ultima').value = t.ultima || '';
      document.getElementById('tarea-proxima').value = t.proxima || '';
      document.getElementById('tarea-responsable').value = t.responsable || '';
      document.getElementById('modal-tarea-titulo').textContent = 'Editar tarea';
      document.getElementById('btn-eliminar-tarea').classList.remove('hidden');
      document.getElementById('modal-tarea').classList.add('active');
    }

    async function guardarTarea(e) {
      e.preventDefault();
      const id = document.getElementById('tarea-id').value;
      const data = {
        titulo: document.getElementById('tarea-titulo').value.trim(),
        descripcion: document.getElementById('tarea-descripcion').value.trim(),
        frecuencia: document.getElementById('tarea-frecuencia').value,
        categoria: document.getElementById('tarea-categoria').value,
        ultima: document.getElementById('tarea-ultima').value,
        proxima: document.getElementById('tarea-proxima').value,
        responsable: document.getElementById('tarea-responsable').value.trim(),
        actualizado: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        const ref = db.collection('bienes').doc(bienId).collection('tareasProgramadas');
        if (id) { await ref.doc(id).update(data); }
        else { data.creado = firebase.firestore.FieldValue.serverTimestamp(); await ref.add(data); }
        cerrarModales();
        mantCargado = false;
        await cargarDatosMantenimiento();
      } catch (error) { console.error(error); alert('Error al guardar'); }
    }

    async function eliminarTarea() {
      const id = document.getElementById('tarea-id').value;
      if (!id || !confirm('¬øEliminar esta tarea?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('tareasProgramadas').doc(id).delete();
        cerrarModales();
        mantCargado = false;
        await cargarDatosMantenimiento();
      } catch (error) { console.error(error); }
    }

    function renderManual() {
      const grid = document.getElementById('grid-manual');
      const items = filtroManual === 'todos' ? manualEntradas : manualEntradas.filter(m => m.tipo === filtroManual);
      if (items.length === 0) {
        grid.innerHTML = '<div class="mant-empty"><div class="mant-empty-titulo">Sin entradas</div>Documenta instrucciones y contactos</div>';
        return;
      }
      const iconosTipo = { instrucciones: 'I', proveedores: 'P', garantias: 'G', planos: 'PL', otro: '?' };
      grid.innerHTML = items.map(m => `
        <div class="manual-card" onclick="editarManual('${m.id}')">
          <div class="manual-header">
            <div class="manual-icono">${iconosTipo[m.tipo] || '?'}</div>
            <div class="manual-titulo">${m.titulo}</div>
          </div>
          <div class="manual-descripcion">${(m.contenido || '').substring(0, 100)}${(m.contenido || '').length > 100 ? '...' : ''}</div>
          <div class="manual-meta">
            <span>${m.tipo}</span>
            <span>${m.categoria}</span>
          </div>
        </div>
      `).join('');
    }

    function filtrarManual(tipo) {
      filtroManual = tipo;
      document.querySelectorAll('#filtros-manual .mant-filtro').forEach(f => f.classList.toggle('active', f.dataset.tipo === tipo));
      renderManual();
    }

    function abrirModalManual() {
      document.getElementById('form-manual').reset();
      document.getElementById('manual-id').value = '';
      document.getElementById('modal-manual-titulo').textContent = 'Nueva entrada de manual';
      document.getElementById('btn-eliminar-manual').classList.add('hidden');
      document.getElementById('modal-manual').classList.add('active');
    }

    function editarManual(id) {
      const m = manualEntradas.find(x => x.id === id);
      if (!m) return;
      document.getElementById('manual-id').value = id;
      document.getElementById('manual-titulo').value = m.titulo || '';
      document.getElementById('manual-tipo').value = m.tipo || 'instrucciones';
      document.getElementById('manual-categoria').value = m.categoria || 'general';
      document.getElementById('manual-contenido').value = m.contenido || '';
      document.getElementById('modal-manual-titulo').textContent = 'Editar entrada';
      document.getElementById('btn-eliminar-manual').classList.remove('hidden');
      document.getElementById('modal-manual').classList.add('active');
    }

    async function guardarManual(e) {
      e.preventDefault();
      const id = document.getElementById('manual-id').value;
      const data = {
        titulo: document.getElementById('manual-titulo').value.trim(),
        tipo: document.getElementById('manual-tipo').value,
        categoria: document.getElementById('manual-categoria').value,
        contenido: document.getElementById('manual-contenido').value.trim(),
        actualizado: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        const ref = db.collection('bienes').doc(bienId).collection('manual');
        if (id) { await ref.doc(id).update(data); }
        else { data.creado = firebase.firestore.FieldValue.serverTimestamp(); await ref.add(data); }
        cerrarModales();
        mantCargado = false;
        await cargarDatosMantenimiento();
      } catch (error) { console.error(error); alert('Error al guardar'); }
    }

    async function eliminarManual() {
      const id = document.getElementById('manual-id').value;
      if (!id || !confirm('¬øEliminar esta entrada?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('manual').doc(id).delete();
        cerrarModales();
        mantCargado = false;
        await cargarDatosMantenimiento();
      } catch (error) { console.error(error); }
    }

    // Cargar mantenimiento cuando se accede a la secci√≥n
    const originalCambiarSeccion = cambiarSeccion;
    cambiarSeccion = function(seccion) {
      originalCambiarSeccion(seccion);
      if (seccion === 'mantenimiento') {
        cargarDatosMantenimiento();
      }
    };

    // ========== EDICI√ìN DE INVENTARIO ==========
    let inventarioEdit = {};
    let lugarActualEdit = null;
    let accionPendiente = null;
    let datoPendiente = null;

    function abrirEditInventario() {
      db.collection('bienes').doc(bienId).get().then(doc => {
        inventarioEdit = doc.data()?.inventario || {};
        lugarActualEdit = null;
        renderEditTabs();
        document.getElementById('modal-edit-inventario').classList.add('active');
      });
    }

    function renderEditTabs() {
      const container = document.getElementById('edit-inv-tabs');
      const lugares = Object.keys(inventarioEdit);
      
      let html = lugares.map(key => `
        <button class="edit-inv-tab ${key === lugarActualEdit ? 'active' : ''}" onclick="seleccionarLugarEdit('${key}')">
          ${inventarioEdit[key].nombre}
          <span class="edit-inv-tab-del" onclick="event.stopPropagation(); confirmarBorrarLugar('${key}')" title="Eliminar lugar">√ó</span>
        </button>
      `).join('');
      
      html += `<button class="edit-inv-add-lugar" onclick="agregarLugarEdit()">+ Lugar</button>`;
      container.innerHTML = html;
      
      if (lugarActualEdit && inventarioEdit[lugarActualEdit]) {
        renderLugarContent();
      } else if (lugares.length > 0 && !lugarActualEdit) {
        seleccionarLugarEdit(lugares[0]);
      } else {
        document.getElementById('edit-inv-content').innerHTML = 
          '<p style="text-align:center; color:var(--text-muted); padding: 30px;">Crea un lugar para comenzar</p>';
      }
    }

    function seleccionarLugarEdit(key) {
      lugarActualEdit = key;
      document.querySelectorAll('.edit-inv-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.edit-inv-tab[onclick*="${key}"]`)?.classList.add('active');
      renderLugarContent();
    }

    function renderLugarContent() {
      const lugar = inventarioEdit[lugarActualEdit];
      if (!lugar) return;
      
      const container = document.getElementById('edit-inv-content');
      let html = '';
      
      const grupos = lugar.grupos || {};
      for (const [grupoKey, grupo] of Object.entries(grupos)) {
        html += `
          <div class="edit-inv-grupo">
            <div class="edit-inv-grupo-header">
              <span>${grupo.nombre}</span>
              <button onclick="confirmarBorrarGrupo('${grupoKey}')" title="Eliminar grupo">√ó</button>
            </div>
            <div class="edit-inv-articulos">
              <div class="edit-inv-art-header">
                <span>Nombre</span>
                <span>Formato</span>
                <span>Unidad</span>
                <span>Min</span>
                <span></span>
              </div>`;
        
        const articulos = grupo.articulos || [];
        articulos.forEach((art, idx) => {
          html += `
            <div class="edit-inv-art-row">
              <input type="text" value="${art.nombre || ''}" onchange="actualizarArticulo('${grupoKey}', ${idx}, 'nombre', this.value)" placeholder="Nombre">
              <input type="text" value="${art.formato || ''}" onchange="actualizarArticulo('${grupoKey}', ${idx}, 'formato', this.value)" placeholder="500ml...">
              <input type="text" value="${art.unidad || 'uds'}" onchange="actualizarArticulo('${grupoKey}', ${idx}, 'unidad', this.value)" placeholder="uds">
              <input type="number" value="${art.minimo || 0}" min="0" onchange="actualizarArticulo('${grupoKey}', ${idx}, 'minimo', parseInt(this.value))">
              <button class="edit-inv-art-del" onclick="eliminarArticulo('${grupoKey}', ${idx})" title="Eliminar">√ó</button>
            </div>`;
        });
        
        html += `
              <button class="edit-inv-add-btn" onclick="agregarArticulo('${grupoKey}')">+ Articulo</button>
            </div>
          </div>`;
      }
      
      html += `<button class="edit-inv-add-btn" onclick="agregarGrupoEdit()" style="margin-top:12px;">+ Grupo</button>`;
      container.innerHTML = html;
    }

    function agregarLugarEdit() {
      const nombre = prompt('Nombre del nuevo lugar:');
      if (!nombre || !nombre.trim()) return;
      
      const key = nombre.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      if (inventarioEdit[key]) {
        alert('Ya existe un lugar con ese nombre');
        return;
      }
      
      inventarioEdit[key] = { nombre: nombre.trim(), grupos: {} };
      lugarActualEdit = key;
      renderEditTabs();
    }

    function agregarGrupoEdit() {
      const nombre = prompt('Nombre del nuevo grupo:');
      if (!nombre || !nombre.trim() || !lugarActualEdit) return;
      
      const key = nombre.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      if (!inventarioEdit[lugarActualEdit].grupos) {
        inventarioEdit[lugarActualEdit].grupos = {};
      }
      
      if (inventarioEdit[lugarActualEdit].grupos[key]) {
        alert('Ya existe un grupo con ese nombre');
        return;
      }
      
      inventarioEdit[lugarActualEdit].grupos[key] = { nombre: nombre.trim(), articulos: [] };
      renderLugarContent();
    }

    function agregarArticulo(grupoKey) {
      if (!inventarioEdit[lugarActualEdit].grupos[grupoKey].articulos) {
        inventarioEdit[lugarActualEdit].grupos[grupoKey].articulos = [];
      }
      inventarioEdit[lugarActualEdit].grupos[grupoKey].articulos.push({
        nombre: '',
        formato: '',
        unidad: 'uds',
        minimo: 0,
        actual: 0
      });
      renderLugarContent();
    }

    function actualizarArticulo(grupoKey, idx, campo, valor) {
      inventarioEdit[lugarActualEdit].grupos[grupoKey].articulos[idx][campo] = valor;
    }

    function eliminarArticulo(grupoKey, idx) {
      if (!confirm('¬øEliminar este art√≠culo?')) return;
      inventarioEdit[lugarActualEdit].grupos[grupoKey].articulos.splice(idx, 1);
      renderLugarContent();
    }

    // ========== BORRADOS CON REAUTENTICACI√ìN ==========
    
    function confirmarBorrarGrupo(grupoKey) {
      if (!confirm(`¬øEliminar el grupo "${inventarioEdit[lugarActualEdit].grupos[grupoKey].nombre}" y todos sus art√≠culos?`)) return;
      accionPendiente = 'borrar_grupo';
      datoPendiente = grupoKey;
      abrirReauth();
    }

    function confirmarBorrarLugar(lugarKey) {
      if (!confirm(`¬øEliminar "${inventarioEdit[lugarKey].nombre}" y todo su contenido?`)) return;
      accionPendiente = 'borrar_lugar';
      datoPendiente = lugarKey;
      abrirReauth();
    }

    function confirmarBorrarTodo() {
      if (!confirm('¬øBorrar TODO el inventario de este bien? Esta acci√≥n es irreversible.')) return;
      accionPendiente = 'borrar_todo';
      datoPendiente = null;
      abrirReauth();
    }

    function abrirReauth() {
      document.getElementById('reauth-email').value = currentUser.email;
      document.getElementById('reauth-password').value = '';
      document.getElementById('reauth-error').style.display = 'none';
      document.getElementById('modal-reauth').classList.add('active');
    }

    function cerrarReauth() {
      document.getElementById('modal-reauth').classList.remove('active');
      accionPendiente = null;
      datoPendiente = null;
    }

    async function ejecutarReauth() {
      const password = document.getElementById('reauth-password').value;
      if (!password) {
        document.getElementById('reauth-error').textContent = 'Introduce tu contrase√±a';
        document.getElementById('reauth-error').style.display = 'block';
        return;
      }
      
      try {
        const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
        await currentUser.reauthenticateWithCredential(credential);
        
        if (accionPendiente === 'borrar_todo') {
          inventarioEdit = {};
          lugarActualEdit = null;
        } else if (accionPendiente === 'borrar_lugar') {
          delete inventarioEdit[datoPendiente];
          if (lugarActualEdit === datoPendiente) lugarActualEdit = null;
        } else if (accionPendiente === 'borrar_grupo') {
          delete inventarioEdit[lugarActualEdit].grupos[datoPendiente];
        }
        
        cerrarReauth();
        renderEditTabs();
        
      } catch (error) {
        console.error('Error reauth:', error);
        document.getElementById('reauth-error').textContent = 'Contrase√±a incorrecta';
        document.getElementById('reauth-error').style.display = 'block';
      }
    }

    async function guardarInventarioEdit() {
      for (const lugarKey of Object.keys(inventarioEdit)) {
        const grupos = inventarioEdit[lugarKey].grupos || {};
        for (const grupoKey of Object.keys(grupos)) {
          grupos[grupoKey].articulos = (grupos[grupoKey].articulos || [])
            .filter(a => a.nombre && a.nombre.trim());
        }
      }
      
      try {
        await db.collection('bienes').doc(bienId).update({
          inventario: inventarioEdit,
          inventarioActualizado: firebase.firestore.FieldValue.serverTimestamp()
        });
        cerrarModales();
        if (typeof cargarInventario === 'function') cargarInventario();
      } catch (error) {
        console.error('Error guardando inventario:', error);
        alert('Error al guardar');
      }
    }
  </script>
</body>
</html>
