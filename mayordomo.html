<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Mayordomo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-dark: #6B5A45;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --success-muted: rgba(125, 181, 154, 0.15);
      --warning: #E8B44D;
      --warning-muted: rgba(232, 180, 77, 0.15);
      --error: #D4695A;
      --error-muted: rgba(212, 105, 90, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-dark) 100%);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: white;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }

    .header-icon {
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }

    .header-info h1 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .header-info p {
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .header-badge {
      padding: 4px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
    }

    /* ========== MAIN ========== */
    .main {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ========== RESUMEN ========== */
    .resumen {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .resumen-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 16px;
      text-align: center;
      box-shadow: var(--shadow-soft);
    }

    .resumen-valor {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--mayordomo);
      line-height: 1;
    }

    .resumen-valor.warning { color: var(--warning); }
    .resumen-valor.error { color: var(--error); }
    .resumen-valor.success { color: var(--success); }

    .resumen-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* ========== SECCI√ìN ========== */
    .section-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ========== CARDS GRID ========== */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .module-card {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 24px;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .module-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-float);
      border-color: var(--mayordomo-light);
    }

    .module-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--mayordomo);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .module-card:hover::before { opacity: 1; }

    .module-icon {
      width: 56px;
      height: 56px;
      background: var(--mayordomo-muted);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin-bottom: 16px;
    }

    .module-card:hover .module-icon {
      background: var(--mayordomo);
      transform: scale(1.05);
    }

    .module-card:hover .module-icon span {
      filter: grayscale(1) brightness(10);
    }

    .module-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .module-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.4;
      flex: 1;
    }

    .module-stats {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed var(--cream-dark);
    }

    .module-stat {
      text-align: center;
    }

    .module-stat-value {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--mayordomo);
    }

    .module-stat-value.warning { color: var(--warning); }
    .module-stat-value.success { color: var(--success); }

    .module-stat-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .module-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 4px 10px;
      background: var(--warning);
      color: white;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 700;
    }

    .module-badge.success { background: var(--success); }
    .module-badge.error { background: var(--error); }

    /* ========== ACTIVIDAD RECIENTE ========== */
    .actividad-list {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .actividad-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--cream);
      transition: background 0.2s;
    }

    .actividad-item:last-child { border-bottom: none; }
    .actividad-item:hover { background: var(--cream); }

    .actividad-icon {
      width: 36px;
      height: 36px;
      background: var(--cream);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .actividad-info { flex: 1; min-width: 0; }

    .actividad-texto {
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .actividad-fecha {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .actividad-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
    }

    /* ========== LOADING ========== */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .spinner {
      width: 44px;
      height: 44px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--mayordomo);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      .header { padding: 12px 16px; }
      .header-info h1 { font-size: 1rem; }
      .header-icon { width: 38px; height: 38px; font-size: 1.1rem; }
      .main { padding: 16px; }
      .cards-grid { grid-template-columns: 1fr; }
      .module-card { padding: 20px; }
      .resumen { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
      <div class="header-title">
        <div class="header-icon">üè†</div>
        <div class="header-info">
          <h1 id="nombre-bien">Cargando...</h1>
          <p>Mayordomo</p>
        </div>
      </div>
    </div>
    <span class="header-badge">ADD-ON</span>
  </header>

  <!-- MAIN -->
  <main class="main">
    <!-- LOADING -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>

    <div id="contenido" class="hidden">
      <!-- RESUMEN -->
      <div class="resumen">
        <div class="resumen-card">
          <div class="resumen-valor" id="stat-reservas">0</div>
          <div class="resumen-label">Reservas mes</div>
        </div>
        <div class="resumen-card">
          <div class="resumen-valor warning" id="stat-pendientes">0</div>
          <div class="resumen-label">Gastos pend.</div>
        </div>
        <div class="resumen-card">
          <div class="resumen-valor error" id="stat-averias">0</div>
          <div class="resumen-label">Aver√≠as</div>
        </div>
        <div class="resumen-card">
          <div class="resumen-valor" id="stat-bajo-stock">0</div>
          <div class="resumen-label">Bajo stock</div>
        </div>
      </div>

      <!-- M√ìDULOS -->
      <h3 class="section-title">üì¶ Gesti√≥n del bien</h3>
      <div class="cards-grid">
        <!-- INVENTARIO -->
        <a href="#" class="module-card" id="card-inventario">
          <span class="module-badge hidden" id="badge-bajo-stock">0 bajo</span>
          <div class="module-icon"><span>üì¶</span></div>
          <div class="module-title">Inventario</div>
          <div class="module-desc">Control de productos, consumibles y art√≠culos del hogar. Toma de inventario m√≥vil.</div>
          <div class="module-stats">
            <div class="module-stat">
              <div class="module-stat-value" id="inv-lugares">-</div>
              <div class="module-stat-label">Lugares</div>
            </div>
            <div class="module-stat">
              <div class="module-stat-value" id="inv-articulos">-</div>
              <div class="module-stat-label">Art√≠culos</div>
            </div>
            <div class="module-stat">
              <div class="module-stat-value" id="inv-ultima">-</div>
              <div class="module-stat-label">√öltima toma</div>
            </div>
          </div>
        </a>

        <!-- RESERVAS -->
        <a href="#" class="module-card" id="card-reservas">
          <span class="module-badge success hidden" id="badge-reservas">0</span>
          <div class="module-icon"><span>üìÖ</span></div>
          <div class="module-title">Reservas</div>
          <div class="module-desc">Calendario de ocupaci√≥n. Gestiona qui√©n y cu√°ndo usa la propiedad.</div>
          <div class="module-stats">
            <div class="module-stat">
              <div class="module-stat-value" id="res-mes">-</div>
              <div class="module-stat-label">Este mes</div>
            </div>
            <div class="module-stat">
              <div class="module-stat-value" id="res-proxima">-</div>
              <div class="module-stat-label">Pr√≥xima</div>
            </div>
          </div>
        </a>

        <!-- MANTENIMIENTO -->
        <a href="#" class="module-card" id="card-mantenimiento">
          <span class="module-badge error hidden" id="badge-averias">0</span>
          <div class="module-icon"><span>üîß</span></div>
          <div class="module-title">Mantenimiento</div>
          <div class="module-desc">Reparaciones, aver√≠as y mantenimiento programado. Historial de intervenciones.</div>
          <div class="module-stats">
            <div class="module-stat">
              <div class="module-stat-value warning" id="mant-pendientes">-</div>
              <div class="module-stat-label">Pendientes</div>
            </div>
            <div class="module-stat">
              <div class="module-stat-value success" id="mant-resueltas">-</div>
              <div class="module-stat-label">Resueltas</div>
            </div>
          </div>
        </a>

        <!-- GASTOS -->
        <a href="#" class="module-card" id="card-gastos">
          <span class="module-badge warning hidden" id="badge-gastos">0</span>
          <div class="module-icon"><span>üí∞</span></div>
          <div class="module-title">Gastos</div>
          <div class="module-desc">Registro de gastos dom√©sticos y reparto entre miembros de la familia.</div>
          <div class="module-stats">
            <div class="module-stat">
              <div class="module-stat-value" id="gasto-mes">-</div>
              <div class="module-stat-label">Este mes</div>
            </div>
            <div class="module-stat">
              <div class="module-stat-value warning" id="gasto-pend">-</div>
              <div class="module-stat-label">Pend. reparto</div>
            </div>
          </div>
        </a>

        <!-- CASEROS -->
        <a href="#" class="module-card" id="card-caseros">
          <div class="module-icon"><span>üë∑</span></div>
          <div class="module-title">Caseros</div>
          <div class="module-desc">Gesti√≥n de cuidadores y personal con acceso limitado a la propiedad.</div>
          <div class="module-stats">
            <div class="module-stat">
              <div class="module-stat-value" id="caseros-activos">-</div>
              <div class="module-stat-label">Activos</div>
            </div>
          </div>
        </a>
      </div>

      <!-- ACTIVIDAD RECIENTE -->
      <h3 class="section-title">üïê Actividad reciente</h3>
      <div class="actividad-list" id="actividad-lista">
        <div class="actividad-empty">
          <p>Sin actividad reciente</p>
        </div>
      </div>
    </div>
  </main>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ========== VARIABLES ==========
    let currentUser = null;
    let bienId = null;
    let bienData = null;

    const MESES_CORTO = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');

      if (!bienId) {
        alert('No se especific√≥ el bien');
        window.location.href = 'lo-comun.html';
        return;
      }

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await cargarDatos();
        } else {
          window.location.href = 'login.html';
        }
      });
    });

    async function cargarDatos() {
      try {
        // Cargar bien
        const doc = await db.collection('bienes').doc(bienId).get();
        if (!doc.exists) {
          alert('Bien no encontrado');
          window.location.href = 'lo-comun.html';
          return;
        }

        bienData = doc.data();
        document.getElementById('nombre-bien').textContent = bienData.nombre || 'Sin nombre';
        document.getElementById('btn-volver').href = `bien.html?id=${bienId}`;

        // Configurar enlaces de cards
        configurarEnlaces();

        // Cargar estad√≠sticas
        await Promise.all([
          cargarStatsInventario(),
          cargarStatsReservas(),
          cargarStatsMantenimiento(),
          cargarStatsGastos(),
          cargarStatsCaseros(),
          cargarActividad()
        ]);

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('contenido').classList.remove('hidden');

      } catch (error) {
        console.error('Error cargando datos:', error);
        document.getElementById('loading').classList.add('hidden');
        alert('Error al cargar los datos');
      }
    }

    function configurarEnlaces() {
      document.getElementById('card-inventario').href = `inventario.html?id=${bienId}&origen=mayordomo`;
      document.getElementById('card-reservas').href = `reservas.html?id=${bienId}&origen=mayordomo`;
      document.getElementById('card-mantenimiento').href = `mantenimiento.html?id=${bienId}&origen=mayordomo`;
      document.getElementById('card-gastos').href = `gastos-mayordomo.html?id=${bienId}`;
      document.getElementById('card-caseros').href = `caseros.html?id=${bienId}`;
    }

    // ========== STATS INVENTARIO ==========
    async function cargarStatsInventario() {
      try {
        const inventario = bienData.inventario || {};
        const lugares = Object.keys(inventario).length;
        
        let articulos = 0;
        let bajoStock = 0;

        Object.values(inventario).forEach(lugar => {
          Object.values(lugar.grupos || {}).forEach(grupo => {
            (grupo.articulos || []).forEach(art => {
              articulos++;
              if (art.actual !== null && art.actual !== undefined && art.minimo) {
                if (art.actual < art.minimo) bajoStock++;
              }
            });
          });
        });

        document.getElementById('inv-lugares').textContent = lugares;
        document.getElementById('inv-articulos').textContent = articulos;

        // √öltima toma
        if (bienData.ultimaToma) {
          const fecha = bienData.ultimaToma.toDate ? bienData.ultimaToma.toDate() : new Date(bienData.ultimaToma);
          document.getElementById('inv-ultima').textContent = `${fecha.getDate()} ${MESES_CORTO[fecha.getMonth()]}`;
        } else {
          document.getElementById('inv-ultima').textContent = 'Nunca';
        }

        // Badge bajo stock
        if (bajoStock > 0) {
          document.getElementById('badge-bajo-stock').textContent = `${bajoStock} bajo`;
          document.getElementById('badge-bajo-stock').classList.remove('hidden');
          document.getElementById('stat-bajo-stock').textContent = bajoStock;
        }

      } catch (error) {
        console.error('Error stats inventario:', error);
      }
    }

    // ========== STATS RESERVAS ==========
    async function cargarStatsReservas() {
      try {
        const ahora = new Date();
        const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1).toISOString().split('T')[0];
        const finMes = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 0).toISOString().split('T')[0];

        const snap = await db.collection('bienes').doc(bienId)
          .collection('reservas')
          .where('fechaEntrada', '>=', inicioMes)
          .where('fechaEntrada', '<=', finMes)
          .get();

        const reservasMes = snap.docs.filter(d => d.data().status !== 'cancelada').length;
        document.getElementById('res-mes').textContent = reservasMes;
        document.getElementById('stat-reservas').textContent = reservasMes;

        if (reservasMes > 0) {
          document.getElementById('badge-reservas').textContent = reservasMes;
          document.getElementById('badge-reservas').classList.remove('hidden');
        }

        // Pr√≥xima reserva
        const hoy = ahora.toISOString().split('T')[0];
        const proximaSnap = await db.collection('bienes').doc(bienId)
          .collection('reservas')
          .where('fechaEntrada', '>=', hoy)
          .where('status', '==', 'confirmada')
          .orderBy('fechaEntrada', 'asc')
          .limit(1)
          .get();

        if (!proximaSnap.empty) {
          const proxima = proximaSnap.docs[0].data();
          const fechaProx = new Date(proxima.fechaEntrada);
          document.getElementById('res-proxima').textContent = `${fechaProx.getDate()} ${MESES_CORTO[fechaProx.getMonth()]}`;
        } else {
          document.getElementById('res-proxima').textContent = '-';
        }

      } catch (error) {
        console.error('Error stats reservas:', error);
      }
    }

    // ========== STATS MANTENIMIENTO ==========
    async function cargarStatsMantenimiento() {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('reparaciones')
          .get();

        let pendientes = 0;
        let resueltas = 0;

        snap.docs.forEach(doc => {
          const data = doc.data();
          if (data.estado === 'pendiente' || data.estado === 'en_progreso') {
            pendientes++;
          } else {
            resueltas++;
          }
        });

        document.getElementById('mant-pendientes').textContent = pendientes;
        document.getElementById('mant-resueltas').textContent = resueltas;
        document.getElementById('stat-averias').textContent = pendientes;

        if (pendientes > 0) {
          document.getElementById('badge-averias').textContent = pendientes;
          document.getElementById('badge-averias').classList.remove('hidden');
        }

      } catch (error) {
        console.error('Error stats mantenimiento:', error);
      }
    }

    // ========== STATS GASTOS ==========
    async function cargarStatsGastos() {
      try {
        const ahora = new Date();
        const mesActual = `${ahora.getFullYear()}-${String(ahora.getMonth() + 1).padStart(2, '0')}`;

        const snap = await db.collection('bienes').doc(bienId)
          .collection('gastos')
          .get();

        let totalMes = 0;
        let pendientes = 0;

        snap.docs.forEach(doc => {
          const data = doc.data();
          if (data.fecha && data.fecha.startsWith(mesActual)) {
            totalMes += data.importe || 0;
          }
          if (!data.repartido) {
            pendientes++;
          }
        });

        document.getElementById('gasto-mes').textContent = formatearImporte(totalMes);
        document.getElementById('gasto-pend').textContent = pendientes;
        document.getElementById('stat-pendientes').textContent = pendientes;

        if (pendientes > 0) {
          document.getElementById('badge-gastos').textContent = pendientes;
          document.getElementById('badge-gastos').classList.remove('hidden');
        }

      } catch (error) {
        console.error('Error stats gastos:', error);
      }
    }

    // ========== STATS CASEROS ==========
    async function cargarStatsCaseros() {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('caseros')
          .where('activo', '==', true)
          .get();

        document.getElementById('caseros-activos').textContent = snap.docs.length;

      } catch (error) {
        console.error('Error stats caseros:', error);
      }
    }

    // ========== ACTIVIDAD RECIENTE ==========
    async function cargarActividad() {
      try {
        // Combinar diferentes fuentes de actividad
        const actividades = [];

        // √öltimos gastos
        const gastosSnap = await db.collection('bienes').doc(bienId)
          .collection('gastos')
          .orderBy('fechaCreacion', 'desc')
          .limit(3)
          .get();

        gastosSnap.docs.forEach(doc => {
          const data = doc.data();
          actividades.push({
            tipo: 'gasto',
            icono: 'üí∞',
            texto: `Gasto: ${data.concepto || 'Sin concepto'}`,
            fecha: data.fechaCreacion?.toDate?.() || new Date()
          });
        });

        // √öltimas reservas
        const reservasSnap = await db.collection('bienes').doc(bienId)
          .collection('reservas')
          .orderBy('fechaCreacion', 'desc')
          .limit(3)
          .get();

        reservasSnap.docs.forEach(doc => {
          const data = doc.data();
          actividades.push({
            tipo: 'reserva',
            icono: 'üìÖ',
            texto: `Reserva: ${data.quien || 'Sin nombre'}`,
            fecha: data.fechaCreacion?.toDate?.() || new Date()
          });
        });

        // √öltimas reparaciones
        const reparacionesSnap = await db.collection('bienes').doc(bienId)
          .collection('reparaciones')
          .orderBy('fechaCreacion', 'desc')
          .limit(3)
          .get();

        reparacionesSnap.docs.forEach(doc => {
          const data = doc.data();
          actividades.push({
            tipo: 'reparacion',
            icono: 'üîß',
            texto: `Aver√≠a: ${data.descripcion || 'Sin descripci√≥n'}`,
            fecha: data.fechaCreacion?.toDate?.() || new Date()
          });
        });

        // Ordenar por fecha y tomar las 5 m√°s recientes
        actividades.sort((a, b) => b.fecha - a.fecha);
        const recientes = actividades.slice(0, 5);

        // Renderizar
        const container = document.getElementById('actividad-lista');

        if (recientes.length === 0) {
          container.innerHTML = '<div class="actividad-empty"><p>Sin actividad reciente</p></div>';
          return;
        }

        container.innerHTML = recientes.map(a => `
          <div class="actividad-item">
            <div class="actividad-icon">${a.icono}</div>
            <div class="actividad-info">
              <div class="actividad-texto">${a.texto}</div>
              <div class="actividad-fecha">${formatearFechaRelativa(a.fecha)}</div>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error actividad:', error);
      }
    }

    // ========== UTILIDADES ==========
    function formatearImporte(num) {
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'k ‚Ç¨';
      }
      return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(num || 0);
    }

    function formatearFechaRelativa(fecha) {
      if (!fecha) return '';
      
      const ahora = new Date();
      const diff = ahora - fecha;
      const minutos = Math.floor(diff / 60000);
      const horas = Math.floor(diff / 3600000);
      const dias = Math.floor(diff / 86400000);

      if (minutos < 60) return `Hace ${minutos} min`;
      if (horas < 24) return `Hace ${horas}h`;
      if (dias < 7) return `Hace ${dias} d√≠as`;
      
      return `${fecha.getDate()} ${MESES_CORTO[fecha.getMonth()]}`;
    }
  </script>
</body>
</html>
