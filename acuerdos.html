<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Acuerdos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --gerente: #2D4A5C;
      --gerente-light: #4A6B7C;
      --gerente-dark: #1D3544;
      --gerente-muted: rgba(45, 74, 92, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --success-muted: rgba(125, 181, 154, 0.15);
      --warning: #E8B44D;
      --warning-muted: rgba(232, 180, 77, 0.15);
      --error: #D4695A;
      --error-muted: rgba(212, 105, 90, 0.15);
      --gold: #B8965C;
      --gold-muted: rgba(184, 150, 92, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem; color: white;
      cursor: pointer; text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title { display: flex; align-items: center; gap: 12px; color: white; }
    .header-title h1 { font-family: 'Quicksand', sans-serif; font-size: 1.2rem; font-weight: 700; }
    .header-title .icon { font-size: 1.4rem; }
    .header-subtitle { font-size: 0.78rem; opacity: 0.8; }

    .header-actions { display: flex; gap: 8px; }

    /* ========== BOTONES ========== */
    .btn {
      padding: 10px 18px; border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 0.85rem;
      cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-primary { background: var(--gerente); color: white; }
    .btn-primary:hover { background: var(--gerente-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { opacity: 0.9; }
    .btn-danger { background: var(--error); color: white; }
    .btn-danger:hover { opacity: 0.9; }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-secondary:hover { background: #EDE5DB; }
    .btn-sm { padding: 6px 12px; font-size: 0.78rem; }
    .btn-white { background: rgba(255,255,255,0.2); color: white; }
    .btn-white:hover { background: rgba(255,255,255,0.35); }

    /* ========== CONTENIDO ========== */
    .content { max-width: 1100px; margin: 0 auto; padding: 24px; }

    /* ========== STATS ========== */
    .stats-bar {
      display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;
    }
    .stat-chip {
      background: var(--white); border-radius: var(--radius-md);
      padding: 10px 16px; box-shadow: var(--shadow-soft);
      display: flex; align-items: center; gap: 8px;
      font-size: 0.82rem; font-weight: 600;
    }
    .stat-chip .num { font-size: 1.1rem; font-weight: 700; color: var(--gerente); }

    /* ========== FILTROS ========== */
    .filters {
      display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;
    }
    .filter-input {
      padding: 8px 12px; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif; font-size: 0.82rem; background: var(--white);
    }

    /* ========== CARDS ACUERDOS ========== */
    .acuerdos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    .acuerdo-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid var(--gerente);
    }
    .acuerdo-card:hover { box-shadow: var(--shadow-medium); transform: translateY(-2px); }
    .acuerdo-card.vencido { border-left-color: var(--error); }
    .acuerdo-card.proximo { border-left-color: var(--warning); }

    .acuerdo-card-header {
      padding: 16px 16px 8px;
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .acuerdo-card-objeto {
      font-weight: 700; font-size: 0.95rem; color: var(--text);
      line-height: 1.3; flex: 1;
    }
    .acuerdo-card-estado {
      font-size: 0.7rem; font-weight: 700; padding: 3px 10px;
      border-radius: var(--radius-full); white-space: nowrap;
    }
    .estado-vigente { background: var(--success-muted); color: var(--success); }
    .estado-vencido { background: var(--error-muted); color: var(--error); }
    .estado-proximo { background: var(--warning-muted); color: var(--warning); }

    .acuerdo-card-body { padding: 4px 16px 16px; }
    .acuerdo-card-meta {
      display: flex; flex-wrap: wrap; gap: 12px;
      font-size: 0.78rem; color: var(--text-light);
    }
    .acuerdo-card-meta span { display: flex; align-items: center; gap: 4px; }
    .acuerdo-card-firmantes {
      margin-top: 8px; font-size: 0.78rem; color: var(--text-muted);
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .acuerdo-card-importe {
      margin-top: 8px; font-size: 0.88rem; font-weight: 700; color: var(--gerente);
    }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center; padding: 60px 20px; color: var(--text-muted);
    }
    .empty-state .icon { font-size: 3rem; opacity: 0.4; margin-bottom: 12px; }
    .empty-state p { font-size: 0.9rem; margin-bottom: 16px; }

    /* ========== MODAL ========== */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 1000;
      justify-content: center; align-items: flex-start;
      padding: 20px; overflow-y: auto;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-xl);
      width: 100%; max-width: 700px;
      box-shadow: var(--shadow-float);
      margin: 20px auto;
      animation: modalIn 0.25s ease;
    }
    @keyframes modalIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

    .modal-header {
      padding: 20px 24px;
      background: linear-gradient(135deg, var(--gerente), var(--gerente-dark));
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      color: white; display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h2 { font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 700; }
    .modal-close {
      background: rgba(255,255,255,0.2); border: none; color: white;
      width: 32px; height: 32px; border-radius: 50%;
      font-size: 1.1rem; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .modal-close:hover { background: rgba(255,255,255,0.35); }

    .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }

    .modal-footer {
      padding: 16px 24px; border-top: 1px solid var(--cream-dark);
      display: flex; justify-content: space-between; align-items: center; gap: 8px;
    }
    .modal-footer-right { display: flex; gap: 8px; }

    /* ========== FORM ========== */
    .form-section {
      margin-bottom: 20px; padding-bottom: 16px;
      border-bottom: 1px solid var(--cream-dark);
    }
    .form-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .form-section-title {
      font-family: 'Quicksand', sans-serif; font-weight: 700;
      font-size: 0.88rem; color: var(--gerente);
      margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
    }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-group { margin-bottom: 12px; }
    .form-label {
      display: block; font-size: 0.78rem; font-weight: 600;
      color: var(--text-light); margin-bottom: 4px;
    }
    .form-input, .form-textarea, .form-select {
      width: 100%; padding: 10px 12px;
      border: 1px solid var(--cream-dark); border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem;
      background: var(--cream-medium); transition: border 0.2s;
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none; border-color: var(--gerente); background: var(--white);
    }
    .form-textarea { resize: vertical; min-height: 70px; }

    /* ========== PRESTACIONES (tabla din√°mica) ========== */
    .prestaciones-table {
      width: 100%; border-collapse: collapse; font-size: 0.82rem;
    }
    .prestaciones-table th {
      text-align: left; padding: 8px 10px;
      font-size: 0.72rem; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.3px;
      border-bottom: 2px solid var(--cream-dark);
    }
    .prestaciones-table td {
      padding: 6px 4px; vertical-align: middle;
    }
    .prestaciones-table input, .prestaciones-table select {
      width: 100%; padding: 7px 8px;
      border: 1px solid var(--cream-dark); border-radius: 6px;
      font-family: 'Nunito', sans-serif; font-size: 0.82rem;
      background: var(--cream-medium);
    }
    .prestaciones-table input:focus, .prestaciones-table select:focus {
      outline: none; border-color: var(--gerente); background: var(--white);
    }
    .btn-remove-row {
      background: none; border: none; cursor: pointer;
      font-size: 1rem; color: var(--error); opacity: 0.6;
      transition: opacity 0.2s;
    }
    .btn-remove-row:hover { opacity: 1; }
    .btn-add-row {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 6px 12px; margin-top: 8px;
      background: var(--gerente-muted); border: 1px dashed var(--gerente-light);
      border-radius: var(--radius-sm); color: var(--gerente);
      font-family: 'Nunito', sans-serif; font-size: 0.78rem; font-weight: 700;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-add-row:hover { background: rgba(45,74,92,0.2); }

    .total-prestaciones {
      text-align: right; padding: 10px 0 0;
      font-size: 0.88rem; font-weight: 700; color: var(--gerente);
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      .header { padding: 12px 16px; }
      .content { padding: 16px; }
      .form-row { grid-template-columns: 1fr; }
      .acuerdos-grid { grid-template-columns: 1fr; }
      .stats-bar { gap: 8px; }
      .modal-body { padding: 16px; }
    }
  </style>
</head>
<body>

  <!-- ========== HEADER ========== -->
  <header class="header">
    <div class="header-left">
      <a id="btn-volver" href="gerente.html" class="back-btn">‚Üê Gerente</a>
      <div class="header-title">
        <span class="icon">ü§ù</span>
        <div>
          <h1>Acuerdos</h1>
          <div class="header-subtitle" id="nombre-bien">Cargando...</div>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-white" onclick="abrirModal()">+ Nuevo acuerdo</button>
    </div>
  </header>

  <!-- ========== CONTENIDO ========== -->
  <div class="content">

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-chip"><span class="num" id="stat-total">0</span> Acuerdos</div>
      <div class="stat-chip" style="border-left:3px solid var(--success);"><span class="num" id="stat-vigentes">0</span> Vigentes</div>
      <div class="stat-chip" style="border-left:3px solid var(--warning);"><span class="num" id="stat-proximos">0</span> Por vencer</div>
      <div class="stat-chip" style="border-left:3px solid var(--error);"><span class="num" id="stat-vencidos">0</span> Vencidos</div>
      <div class="stat-chip" style="border-left:3px solid var(--gerente);"><span class="num" id="stat-importe">0 ‚Ç¨</span> /mes</div>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <input type="text" class="filter-input" id="filtro-buscar" placeholder="üîç Buscar..." oninput="renderAcuerdos()" style="flex:1;min-width:180px;">
      <select class="filter-input" id="filtro-estado" onchange="renderAcuerdos()">
        <option value="">Todos</option>
        <option value="vigente">Vigentes</option>
        <option value="proximo">Por vencer</option>
        <option value="vencido">Vencidos</option>
      </select>
    </div>

    <!-- Grid acuerdos -->
    <div id="acuerdos-grid" class="acuerdos-grid"></div>
  </div>

  <!-- ========== MODAL ========== -->
  <div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)cerrarModal()">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-titulo">ü§ù Nuevo acuerdo</h2>
        <button class="modal-close" onclick="cerrarModal()">‚úï</button>
      </div>
      <div class="modal-body">

        <!-- Secci√≥n 1: Datos generales -->
        <div class="form-section">
          <div class="form-section-title">üìã Datos generales</div>
          <div class="form-group">
            <label class="form-label">Objeto del acuerdo *</label>
            <input type="text" class="form-input" id="ac-objeto" placeholder="Ej: Mantenimiento piscina temporada 2026">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha de firma</label>
              <input type="date" class="form-input" id="ac-fechaFirma">
            </div>
            <div class="form-group">
              <label class="form-label">Fecha de vencimiento</label>
              <input type="date" class="form-input" id="ac-fechaVencimiento">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Firmantes</label>
            <textarea class="form-textarea" id="ac-firmantes" rows="2" placeholder="Nombres de las partes firmantes..."></textarea>
          </div>
        </div>

        <!-- Secci√≥n 2: Obligaciones -->
        <div class="form-section">
          <div class="form-section-title">‚öñÔ∏è Obligaciones</div>
          <div class="form-group">
            <label class="form-label">Obligaciones del bien / propiedad</label>
            <textarea class="form-textarea" id="ac-obligBien" rows="3" placeholder="Lo que se compromete la propiedad..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Obligaciones del colaborador</label>
            <textarea class="form-textarea" id="ac-obligColaborador" rows="3" placeholder="Lo que se compromete el colaborador..."></textarea>
          </div>
        </div>

        <!-- Secci√≥n 3: Prestaciones econ√≥micas -->
        <div class="form-section">
          <div class="form-section-title">üí∂ Prestaciones econ√≥micas</div>
          <table class="prestaciones-table">
            <thead>
              <tr>
                <th style="width:40%;">Concepto</th>
                <th style="width:22%;">Importe (‚Ç¨)</th>
                <th style="width:28%;">Frecuencia</th>
                <th style="width:10%;"></th>
              </tr>
            </thead>
            <tbody id="prestaciones-body"></tbody>
          </table>
          <button class="btn-add-row" onclick="addPrestacion()">+ A√±adir l√≠nea</button>
          <div class="total-prestaciones" id="total-prestaciones"></div>
        </div>

        <!-- Secci√≥n 4: Notas -->
        <div class="form-section">
          <div class="form-section-title">üìù Notas</div>
          <div class="form-group">
            <textarea class="form-textarea" id="ac-notas" rows="3" placeholder="Observaciones, condiciones especiales..."></textarea>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <div>
          <button class="btn btn-danger btn-sm" id="btn-eliminar" onclick="eliminarAcuerdo()" style="display:none;">üóëÔ∏è Eliminar</button>
        </div>
        <div class="modal-footer-right">
          <button class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
          <button class="btn btn-primary" onclick="guardarAcuerdo()">üíæ Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== FIREBASE ========== -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let acuerdos = [];
    let editandoId = null;
    let prestacionCounter = 0;

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');
      const origen = params.get('origen') || 'gerente';

      if (!bienId) {
        alert('No se ha especificado el bien');
        window.location.href = 'lo-comun.html';
        return;
      }

      document.getElementById('btn-volver').href = `gerente.html?id=${bienId}`;

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await cargarBien();
          await cargarAcuerdos();
        } else {
          window.location.href = 'login.html';
        }
      });
    });

    // ========== CARGAR DATOS ==========
    async function cargarBien() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (doc.exists) {
          bienData = doc.data();
          document.getElementById('nombre-bien').textContent = bienData.nombre || 'Sin nombre';
        }
      } catch (error) {
        console.error('Error cargando bien:', error);
      }
    }

    async function cargarAcuerdos() {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('acuerdos')
          .orderBy('fechaFirma', 'desc')
          .get();

        acuerdos = [];
        snap.forEach(doc => {
          acuerdos.push({ id: doc.id, ...doc.data() });
        });

        renderAcuerdos();
      } catch (error) {
        console.error('Error cargando acuerdos:', error);
      }
    }

    // ========== ESTADO ==========
    function calcEstado(ac) {
      if (!ac.fechaVencimiento) return 'vigente';
      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
      const venc = ac.fechaVencimiento.toDate ? ac.fechaVencimiento.toDate() : new Date(ac.fechaVencimiento);
      const diff = (venc - hoy) / (1000 * 60 * 60 * 24);
      if (diff < 0) return 'vencido';
      if (diff <= 30) return 'proximo';
      return 'vigente';
    }

    function estadoBadge(estado) {
      const map = {
        vigente: ['Vigente', 'estado-vigente'],
        proximo: ['Por vencer', 'estado-proximo'],
        vencido: ['Vencido', 'estado-vencido']
      };
      const [text, cls] = map[estado] || map.vigente;
      return `<span class="acuerdo-card-estado ${cls}">${text}</span>`;
    }

    function formatFecha(f) {
      if (!f) return '‚Äî';
      const d = f.toDate ? f.toDate() : new Date(f);
      return d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function totalMensual(prestaciones) {
      if (!prestaciones || prestaciones.length === 0) return 0;
      return prestaciones.reduce((sum, p) => {
        const imp = parseFloat(p.importe) || 0;
        switch (p.frecuencia) {
          case 'anual': return sum + imp / 12;
          case 'trimestral': return sum + imp / 3;
          case 'mensual': return sum + imp;
          case 'semanal': return sum + imp * 4.33;
          case 'diario': return sum + imp * 30;
          case 'unico': return sum; // pago √∫nico no cuenta en recurrente
          default: return sum + imp;
        }
      }, 0);
    }

    // ========== RENDER ==========
    function renderAcuerdos() {
      const buscar = document.getElementById('filtro-buscar').value.toLowerCase();
      const filtroEstado = document.getElementById('filtro-estado').value;

      let lista = acuerdos.map(ac => ({ ...ac, _estado: calcEstado(ac) }));

      if (buscar) {
        lista = lista.filter(ac =>
          (ac.objeto || '').toLowerCase().includes(buscar) ||
          (ac.firmantes || '').toLowerCase().includes(buscar)
        );
      }
      if (filtroEstado) {
        lista = lista.filter(ac => ac._estado === filtroEstado);
      }

      // Stats
      const todos = acuerdos.map(ac => ({ ...ac, _estado: calcEstado(ac) }));
      document.getElementById('stat-total').textContent = acuerdos.length;
      document.getElementById('stat-vigentes').textContent = todos.filter(a => a._estado === 'vigente').length;
      document.getElementById('stat-proximos').textContent = todos.filter(a => a._estado === 'proximo').length;
      document.getElementById('stat-vencidos').textContent = todos.filter(a => a._estado === 'vencido').length;

      const totalMes = todos.filter(a => a._estado !== 'vencido').reduce((s, a) => s + totalMensual(a.prestaciones), 0);
      document.getElementById('stat-importe').textContent = totalMes.toFixed(0) + ' ‚Ç¨';

      const grid = document.getElementById('acuerdos-grid');

      if (lista.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column:1/-1;">
            <div class="icon">ü§ù</div>
            <p>${acuerdos.length === 0 ? 'No hay acuerdos registrados' : 'Sin resultados para este filtro'}</p>
            ${acuerdos.length === 0 ? '<button class="btn btn-primary" onclick="abrirModal()">+ Crear primer acuerdo</button>' : ''}
          </div>`;
        return;
      }

      grid.innerHTML = lista.map(ac => {
        const estado = ac._estado;
        const totalMes = totalMensual(ac.prestaciones);
        const nPrest = (ac.prestaciones || []).length;
        return `
          <div class="acuerdo-card ${estado === 'vencido' ? 'vencido' : estado === 'proximo' ? 'proximo' : ''}" onclick="editarAcuerdo('${ac.id}')">
            <div class="acuerdo-card-header">
              <div class="acuerdo-card-objeto">${ac.objeto || 'Sin objeto'}</div>
              ${estadoBadge(estado)}
            </div>
            <div class="acuerdo-card-body">
              <div class="acuerdo-card-meta">
                <span>üìÖ ${formatFecha(ac.fechaFirma)}</span>
                <span>‚è∞ Vence: ${formatFecha(ac.fechaVencimiento)}</span>
                ${nPrest > 0 ? `<span>üí∂ ${nPrest} concepto${nPrest > 1 ? 's' : ''}</span>` : ''}
              </div>
              ${ac.firmantes ? `<div class="acuerdo-card-firmantes">üë§ ${ac.firmantes}</div>` : ''}
              ${totalMes > 0 ? `<div class="acuerdo-card-importe">${totalMes.toFixed(2)} ‚Ç¨/mes</div>` : ''}
            </div>
          </div>`;
      }).join('');
    }

    // ========== MODAL ==========
    function abrirModal() {
      editandoId = null;
      document.getElementById('modal-titulo').textContent = 'ü§ù Nuevo acuerdo';
      document.getElementById('btn-eliminar').style.display = 'none';

      document.getElementById('ac-objeto').value = '';
      document.getElementById('ac-fechaFirma').value = new Date().toISOString().split('T')[0];
      document.getElementById('ac-fechaVencimiento').value = '';
      document.getElementById('ac-firmantes').value = '';
      document.getElementById('ac-obligBien').value = '';
      document.getElementById('ac-obligColaborador').value = '';
      document.getElementById('ac-notas').value = '';

      // Prestaciones: una l√≠nea vac√≠a
      document.getElementById('prestaciones-body').innerHTML = '';
      prestacionCounter = 0;
      addPrestacion();
      actualizarTotalPrestaciones();

      document.getElementById('modal-overlay').classList.add('active');
    }

    function editarAcuerdo(id) {
      const ac = acuerdos.find(a => a.id === id);
      if (!ac) return;

      editandoId = id;
      document.getElementById('modal-titulo').textContent = 'ü§ù Editar acuerdo';
      document.getElementById('btn-eliminar').style.display = 'inline-flex';

      document.getElementById('ac-objeto').value = ac.objeto || '';
      document.getElementById('ac-fechaFirma').value = ac.fechaFirma ? (ac.fechaFirma.toDate ? ac.fechaFirma.toDate().toISOString().split('T')[0] : ac.fechaFirma) : '';
      document.getElementById('ac-fechaVencimiento').value = ac.fechaVencimiento ? (ac.fechaVencimiento.toDate ? ac.fechaVencimiento.toDate().toISOString().split('T')[0] : ac.fechaVencimiento) : '';
      document.getElementById('ac-firmantes').value = ac.firmantes || '';
      document.getElementById('ac-obligBien').value = ac.obligBien || '';
      document.getElementById('ac-obligColaborador').value = ac.obligColaborador || '';
      document.getElementById('ac-notas').value = ac.notas || '';

      // Prestaciones
      document.getElementById('prestaciones-body').innerHTML = '';
      prestacionCounter = 0;
      const prests = ac.prestaciones || [];
      if (prests.length === 0) {
        addPrestacion();
      } else {
        prests.forEach(p => addPrestacion(p.concepto, p.importe, p.frecuencia));
      }
      actualizarTotalPrestaciones();

      document.getElementById('modal-overlay').classList.add('active');
    }

    function cerrarModal() {
      document.getElementById('modal-overlay').classList.remove('active');
      editandoId = null;
    }

    // ========== PRESTACIONES DIN√ÅMICAS ==========
    function addPrestacion(concepto = '', importe = '', frecuencia = 'mensual') {
      const idx = prestacionCounter++;
      const row = document.createElement('tr');
      row.id = `prest-row-${idx}`;
      row.innerHTML = `
        <td><input type="text" id="prest-concepto-${idx}" value="${concepto}" placeholder="Ej: Limpieza semanal"></td>
        <td><input type="number" id="prest-importe-${idx}" value="${importe}" step="0.01" min="0" placeholder="0.00" oninput="actualizarTotalPrestaciones()"></td>
        <td>
          <select id="prest-frecuencia-${idx}" onchange="actualizarTotalPrestaciones()">
            <option value="mensual" ${frecuencia === 'mensual' ? 'selected' : ''}>Mensual</option>
            <option value="semanal" ${frecuencia === 'semanal' ? 'selected' : ''}>Semanal</option>
            <option value="trimestral" ${frecuencia === 'trimestral' ? 'selected' : ''}>Trimestral</option>
            <option value="anual" ${frecuencia === 'anual' ? 'selected' : ''}>Anual</option>
            <option value="diario" ${frecuencia === 'diario' ? 'selected' : ''}>Diario</option>
            <option value="unico" ${frecuencia === 'unico' ? 'selected' : ''}>Pago √∫nico</option>
          </select>
        </td>
        <td style="text-align:center;"><button class="btn-remove-row" onclick="removePrestacion(${idx})" title="Eliminar">‚úï</button></td>
      `;
      document.getElementById('prestaciones-body').appendChild(row);
    }

    function removePrestacion(idx) {
      const row = document.getElementById(`prest-row-${idx}`);
      if (row) row.remove();
      actualizarTotalPrestaciones();
    }

    function recogerPrestaciones() {
      const rows = document.querySelectorAll('#prestaciones-body tr');
      const result = [];
      rows.forEach(row => {
        const idx = row.id.replace('prest-row-', '');
        const concepto = document.getElementById(`prest-concepto-${idx}`)?.value?.trim() || '';
        const importe = parseFloat(document.getElementById(`prest-importe-${idx}`)?.value) || 0;
        const frecuencia = document.getElementById(`prest-frecuencia-${idx}`)?.value || 'mensual';
        if (concepto || importe > 0) {
          result.push({ concepto, importe, frecuencia });
        }
      });
      return result;
    }

    function actualizarTotalPrestaciones() {
      const prests = recogerPrestaciones();
      const total = totalMensual(prests);
      const el = document.getElementById('total-prestaciones');
      if (prests.length > 0 && total > 0) {
        el.textContent = `Total estimado: ${total.toFixed(2)} ‚Ç¨/mes`;
      } else {
        el.textContent = '';
      }
    }

    // ========== GUARDAR ==========
    async function guardarAcuerdo() {
      const objeto = document.getElementById('ac-objeto').value.trim();
      if (!objeto) {
        alert('El objeto del acuerdo es obligatorio');
        document.getElementById('ac-objeto').focus();
        return;
      }

      const fechaFirmaVal = document.getElementById('ac-fechaFirma').value;
      const fechaVencVal = document.getElementById('ac-fechaVencimiento').value;

      const data = {
        objeto,
        fechaFirma: fechaFirmaVal ? new Date(fechaFirmaVal) : null,
        fechaVencimiento: fechaVencVal ? new Date(fechaVencVal) : null,
        firmantes: document.getElementById('ac-firmantes').value.trim(),
        obligBien: document.getElementById('ac-obligBien').value.trim(),
        obligColaborador: document.getElementById('ac-obligColaborador').value.trim(),
        prestaciones: recogerPrestaciones(),
        notas: document.getElementById('ac-notas').value.trim(),
        modificadoPor: currentUser.email,
        modificadoEn: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        const ref = db.collection('bienes').doc(bienId).collection('acuerdos');
        if (editandoId) {
          await ref.doc(editandoId).update(data);
        } else {
          data.creadoPor = currentUser.email;
          data.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        cerrarModal();
        await cargarAcuerdos();
      } catch (error) {
        console.error('Error guardando acuerdo:', error);
        alert('Error al guardar. Revisa la consola.');
      }
    }

    // ========== ELIMINAR ==========
    async function eliminarAcuerdo() {
      if (!editandoId) return;
      if (!confirm('¬øEliminar este acuerdo? Esta acci√≥n no se puede deshacer.')) return;

      try {
        await db.collection('bienes').doc(bienId)
          .collection('acuerdos').doc(editandoId).delete();
        cerrarModal();
        await cargarAcuerdos();
      } catch (error) {
        console.error('Error eliminando:', error);
        alert('Error al eliminar.');
      }
    }
  </script>
</body>
</html>
