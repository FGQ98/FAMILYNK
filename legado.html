<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Legado</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;

      /* Colores por secci√≥n */
      --valores: #6B5B95;
      --historia: #88B04B;
      --tradiciones: #F7CAC9;
      --cultura: #92A8D1;
      --fotos: #E8A87C;
      --historias: #85DCB8;
      --recetas: #F6A5C0;
      --juegos: #4CAF50;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* Header */
    .header {
      background: var(--white);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 32px; }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5em;
      text-decoration: none;
    }

    .logo-icon {
      height: 2.4rem;
      width: auto;
      filter: hue-rotate(20deg) saturate(0.65) brightness(1.1);
    }

    .logo-text {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--sage-dark);
    }

    .header-nav { display: flex; gap: 4px; }

    .nav-link {
      padding: 8px 14px;
      border-radius: var(--radius-md);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-light);
      transition: all 0.2s;
    }

    .nav-link:hover { background: var(--cream); }
    .nav-link.active { background: var(--sage); color: white; }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 12px 6px 6px;
      background: var(--cream);
      border-radius: var(--radius-full);
      text-decoration: none;
      color: var(--text);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--sage), var(--sage-light));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .user-name { font-weight: 600; font-size: 0.85rem; }

    /* Main */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .page-header {
      margin-bottom: 32px;
    }

    .page-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    /* Secciones Grid */
    .legado-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .legado-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-soft);
      transition: all 0.3s;
      cursor: pointer;
      border-top: 4px solid transparent;
    }

    .legado-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-medium);
    }

    .legado-card.valores { border-top-color: var(--valores); }
    .legado-card.historia { border-top-color: var(--historia); }
    .legado-card.tradiciones { border-top-color: var(--tradiciones); }
    .legado-card.cultura { border-top-color: var(--cultura); }
    .legado-card.fotos { border-top-color: var(--fotos); }
    .legado-card.historias { border-top-color: var(--historias); }
    .legado-card.recetas { border-top-color: var(--recetas); }
    .legado-card.juegos { border-top-color: var(--juegos); }

    .legado-card-link {
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .legado-icon {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin-bottom: 16px;
    }

    .legado-icon.valores { background: rgba(107, 91, 149, 0.15); }
    .legado-icon.historia { background: rgba(136, 176, 75, 0.15); }
    .legado-icon.tradiciones { background: rgba(247, 202, 201, 0.3); }
    .legado-icon.cultura { background: rgba(146, 168, 209, 0.2); }
    .legado-icon.fotos { background: rgba(232, 168, 124, 0.2); }
    .legado-icon.historias { background: rgba(133, 220, 184, 0.2); }
    .legado-icon.recetas { background: rgba(246, 165, 192, 0.2); }
    .legado-icon.juegos { background: rgba(76, 175, 80, 0.15); }

    .legado-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .legado-description {
      font-size: 0.85rem;
      color: var(--text-light);
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .legado-stat {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      padding-top: 12px;
      border-top: 1px solid var(--cream-dark);
    }

    /* Secci√≥n detalle */
    .section-detail {
      margin-top: 40px;
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-soft);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .section-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary { background: var(--sage); color: white; }
    .btn-primary:hover { background: var(--sage-dark); }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }

    /* Items list */
    .items-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .item-card {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .item-card:hover {
      background: var(--cream-dark);
    }

    .item-icon {
      width: 48px;
      height: 48px;
      background: var(--white);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .item-content { flex: 1; }

    .item-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .item-description {
      font-size: 0.85rem;
      color: var(--text-light);
      line-height: 1.4;
    }

    .item-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-state-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-light);
    }

    /* Tabs */
    .legado-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .legado-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--white);
      border: 2px solid transparent;
      border-radius: var(--radius-full);
      cursor: pointer;
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-light);
      transition: all 0.2s;
      box-shadow: var(--shadow-soft);
    }

    .legado-tab:hover {
      transform: translateY(-2px);
    }

    .legado-tab.active {
      color: white;
    }

    .legado-tab[data-section="valores"].active { background: var(--valores); border-color: var(--valores); }
    .legado-tab[data-section="historia"].active { background: var(--historia); border-color: var(--historia); }
    .legado-tab[data-section="tradiciones"].active { background: #E91E63; border-color: #E91E63; }
    .legado-tab[data-section="cultura"].active { background: var(--cultura); border-color: var(--cultura); }

    /* Responsive */
    @media (max-width: 768px) {
      .header-nav { display: none; }
      .user-name { display: none; }

      .legado-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      .legado-card {
        padding: 12px;
        border-top-width: 3px;
      }

      .legado-icon {
        width: 40px;
        height: 40px;
        font-size: 1.3rem;
        margin-bottom: 10px;
      }

      .legado-title {
        font-size: 0.8rem;
        margin-bottom: 4px;
      }

      .legado-description {
        display: none;
      }

      .legado-stat {
        font-size: 0.7rem;
        padding-top: 8px;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .legado-tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 8px;
      }

      .legado-tab {
        flex-shrink: 0;
      }
    }

    /* Pantallas muy peque√±as */
    @media (max-width: 400px) {
      .legado-grid {
        gap: 8px;
      }

      .legado-card {
        padding: 10px;
      }

      .legado-icon {
        width: 36px;
        height: 36px;
        font-size: 1.1rem;
        margin-bottom: 8px;
      }

      .legado-title {
        font-size: 0.75rem;
      }

      .legado-stat {
        font-size: 0.65rem;
        gap: 4px;
      }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="cgi.html" class="logo">
        <img src="logo_familynk.png" alt="FAMILYNK" class="logo-icon">
        <span class="logo-text">FAMILYNK</span>
      </a>

      <nav class="header-nav">
        <a href="mi-nido.html" class="nav-link">Mi Nido</a>
        <a href="arbol.html" class="nav-link">√Årbol</a>
        <a href="lo-comun.html" class="nav-link">Bienes Compartidos</a>
        <a href="legado.html" class="nav-link active">Legado</a>
        <a href="activacion.html" class="nav-link">La Relaci√≥n</a>
      </nav>
    </div>

    <a href="mi-perfil.html" class="user-menu">
      <div class="user-avatar" id="user-avatar">?</div>
      <span class="user-name" id="user-name">...</span>
    </a>
  </header>

  <!-- Main -->
  <main class="main">
    <div class="page-header">
      <h1 class="page-title">üìú Legado</h1>
      <p class="page-subtitle">El patrimonio intangible de tu familia: valores, historia, tradiciones y cultura</p>
    </div>

    <!-- Grid de secciones -->
    <div class="legado-grid" id="legado-grid">
      <!-- Valores -->
      <a href="legado-valores.html" class="legado-card-link" id="card-valores">
        <div class="legado-card valores">
          <div class="legado-icon valores">üíé</div>
          <div class="legado-title">Valores</div>
          <div class="legado-description">
            Los principios que gu√≠an a tu familia. Lo que os define y os une a trav√©s de generaciones.
          </div>
          <div class="legado-stat">
            Ver valores ‚Üí
          </div>
        </div>
      </a>

      <!-- An√©cdotas (antes Historia) -->
      <a href="legado-anecdotas.html" class="legado-card-link" id="card-anecdotas">
        <div class="legado-card historia">
          <div class="legado-icon historia">üòÑ</div>
          <div class="legado-title">An√©cdotas</div>
          <div class="legado-description">
            Momentos divertidos, curiosos y entra√±ables que forman la memoria viva de tu familia.
          </div>
          <div class="legado-stat">
            Ver an√©cdotas ‚Üí
          </div>
        </div>
      </a>

      <!-- Tradiciones -->
      <a href="legado-tradiciones.html" class="legado-card-link" id="card-tradiciones">
        <div class="legado-card tradiciones">
          <div class="legado-icon tradiciones">üéÑ</div>
          <div class="legado-title">Tradiciones</div>
          <div class="legado-description">
            Celebraciones, rituales y costumbres que hacen √∫nica a tu familia.
          </div>
          <div class="legado-stat">
            Ver tradiciones ‚Üí
          </div>
        </div>
      </a>

      <!-- Sabidur√≠a (antes Cultura) -->
      <a href="legado-sabiduria.html" class="legado-card-link" id="card-sabiduria">
        <div class="legado-card cultura">
          <div class="legado-icon cultura">üßì</div>
          <div class="legado-title">Sabidur√≠a</div>
          <div class="legado-description">
            Consejos, frases y ense√±anzas transmitidas de generaci√≥n en generaci√≥n.
          </div>
          <div class="legado-stat">
            Ver sabidur√≠a ‚Üí
          </div>
        </div>
      </a>

      <!-- Fotos -->
      <a href="legado-fotos.html" class="legado-card-link" id="card-fotos">
        <div class="legado-card fotos">
          <div class="legado-icon fotos">üì∑</div>
          <div class="legado-title">Fotos</div>
          <div class="legado-description">
            √Ålbumes y fotograf√≠as que capturan los momentos especiales de tu familia.
          </div>
          <div class="legado-stat">
            Ver √°lbumes ‚Üí
          </div>
        </div>
      </a>

      <!-- Historias -->
      <a href="legado-historias.html" class="legado-card-link" id="card-historias">
        <div class="legado-card historias">
          <div class="legado-icon historias">‚úçÔ∏è</div>
          <div class="legado-title">Historias</div>
          <div class="legado-description">
            Relatos y memorias escritas por los miembros de la familia.
          </div>
          <div class="legado-stat">
            Leer historias ‚Üí
          </div>
        </div>
      </a>

      <!-- Recetas -->
      <a href="legado-recetas.html" class="legado-card-link" id="card-recetas">
        <div class="legado-card recetas">
          <div class="legado-icon recetas">üë®‚Äçüç≥</div>
          <div class="legado-title">Recetas</div>
          <div class="legado-description">
            El recetario familiar: platos tradicionales y secretos culinarios heredados.
          </div>
          <div class="legado-stat">
            Ver recetario ‚Üí
          </div>
        </div>
      </a>

      <!-- Juegos Callejeros -->
      <a href="juegos-calle.html" class="legado-card-link">
        <div class="legado-card juegos">
          <div class="legado-icon juegos">‚öΩ</div>
          <div class="legado-title">Juegos Callejeros</div>
          <div class="legado-description">
            Juegos con pelota, √∫tiles o improvisados para todas las edades.
          </div>
          <div class="legado-stat">
            Ver juegos ‚Üí
          </div>
        </div>
      </a>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/seccion-guard.js"></script>
  <script src="js/eventos-tracker.js"></script>

  <script>
    let currentUser = null;
    let userData = null;
    let currentFamilia = null;
    let esAdmin = false;

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'registro.html';
        return;
      }
      currentUser = user;

      try {
        // Verificar acceso a la secci√≥n Legado
        const puedeAcceder = await SeccionGuard.verificar('legado');
        if (!puedeAcceder) return; // Ya redirigi√≥

        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        if (userDoc.exists) {
          userData = userDoc.data();
          
          // Actualizar avatar del usuario
          const avatar = document.getElementById('user-avatar');
          const iniciales = userData.nombre ? userData.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'üë§';
          avatar.textContent = iniciales;
        }

        // Cargar familia y aplicar filtros de subsecciones
        const familiaId = localStorage.getItem('estirpeActiva');
        if (familiaId) {
          const familiaDoc = await db.collection('familias').doc(familiaId).get();
          if (familiaDoc.exists) {
            currentFamilia = { id: familiaDoc.id, ...familiaDoc.data() };
            
            // Verificar si es admin-rama
            esAdmin = await SeccionGuard.esAdminRama(user.uid, familiaId);
            
            // Aplicar filtros de subsecciones (solo si no es admin)
            if (!esAdmin) {
              aplicarFiltrosLegado();
            }
          }
        }
      } catch (error) {
        console.error('Error:', error);
      }
    });

    function aplicarFiltrosLegado() {
      const config = currentFamilia?.configSecciones || {};
      const legadoConfig = config.legado || {
        recetas: true, fotos: false, historias: false, 
        valores: false, tradiciones: false, anecdotas: false, sabiduria: false
      };

      console.log('‚öôÔ∏è Aplicando filtros Legado:', legadoConfig);

      // Mapa de IDs de cards
      const cardsMap = {
        recetas: 'card-recetas',
        fotos: 'card-fotos',
        historias: 'card-historias',
        valores: 'card-valores',
        tradiciones: 'card-tradiciones',
        anecdotas: 'card-anecdotas',
        sabiduria: 'card-sabiduria'
      };

      // Ocultar cards desactivadas
      Object.keys(cardsMap).forEach(seccion => {
        const activa = legadoConfig[seccion] === true;
        const card = document.getElementById(cardsMap[seccion]);
        if (card) {
          card.style.display = activa ? '' : 'none';
        }
      });

      // Verificar si hay al menos una secci√≥n visible
      const hayAlgunaVisible = Object.keys(legadoConfig).some(k => legadoConfig[k] === true);
      if (!hayAlgunaVisible) {
        const grid = document.getElementById('legado-grid');
        if (grid) {
          grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">No hay secciones de Legado activas actualmente.</div>';
        }
      }
    }
  </script>
</body>
</html>
