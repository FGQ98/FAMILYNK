<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Inventario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-dark: #6B5A45;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --warning-muted: rgba(232, 180, 77, 0.15);
      --error: #D4695A;
      --error-muted: rgba(212, 105, 90, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-dark) 100%);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: white;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
    }

    .header-icon {
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .header-info h1 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .header-info p {
      font-size: 0.75rem;
      opacity: 0.85;
    }

    .header-actions { display: flex; gap: 8px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    .btn-primary:hover { background: rgba(255,255,255,0.3); }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
      border: 1px solid var(--cream-dark);
    }
    .btn-secondary:hover { background: var(--cream-dark); }

    .btn-mayordomo {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-dark) 100%);
      color: white;
    }
    .btn-mayordomo:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }

    .btn-warning { background: var(--warning); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-sm { padding: 8px 14px; font-size: 0.8rem; }

    /* ========== MAIN ========== */
    .main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ========== INVENTARIO TABS ========== */
    .inventario-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .inventario-tab {
      padding: 10px 16px;
      background: var(--white);
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .inventario-tab:hover { border-color: var(--mayordomo-light); }
    .inventario-tab.active { background: var(--mayordomo); color: white; border-color: var(--mayordomo); }

    .inventario-tab-count {
      padding: 2px 8px;
      background: rgba(0,0,0,0.1);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
    }

    .inventario-tab.active .inventario-tab-count { background: rgba(255,255,255,0.2); }

    /* ========== LISTA COMPRA BANNER ========== */
    .lista-compra-banner {
      background: var(--warning-muted);
      border: 2px solid var(--warning);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .lista-compra-banner.hidden { display: none; }

    .lista-compra-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .lista-compra-icon { font-size: 1.5rem; }
    .lista-compra-text h3 { font-size: 0.95rem; }
    .lista-compra-text p { font-size: 0.8rem; color: var(--text-muted); }

    /* ========== GRUPO HEADER ========== */
    .grupo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .grupo-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ========== PRODUCTOS LISTA ========== */
    .productos-lista {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .grupo-section {
      margin-bottom: 20px;
    }

    .grupo-section-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--mayordomo);
      margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--cream-dark);
    }

    .producto-bloque {
      background: var(--white);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      box-shadow: var(--shadow-soft);
      border-left: 4px solid var(--success);
      transition: all 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .producto-bloque:hover { background: var(--cream); }
    .producto-bloque.bajo { border-left-color: var(--warning); background: var(--warning-muted); }
    .producto-bloque.critico { border-left-color: var(--error); background: var(--error-muted); }

    .producto-info { 
      flex: 1;
      min-width: 0;
    }
    .producto-nombre { 
      font-weight: 700; 
      font-size: 0.9rem; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .producto-formato { font-size: 0.75rem; color: var(--text-muted); }

    .producto-stock {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
    }

    .stock-visual {
      flex: 1;
      height: 6px;
      background: var(--cream-dark);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .stock-bar {
      height: 100%;
      background: var(--success);
      border-radius: var(--radius-full);
      transition: width 0.3s;
    }

    .stock-bar.bajo { background: var(--warning); }
    .stock-bar.critico { background: var(--error); }

    .stock-text {
      font-size: 0.8rem;
      font-weight: 700;
      min-width: 60px;
      text-align: right;
    }

    .stock-text.bajo { color: var(--warning); }
    .stock-text.critico { color: var(--error); }

    .producto-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-shrink: 0;
    }

    .btn-stock {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-stock.minus { background: var(--cream-dark); color: var(--text); }
    .btn-stock.minus:hover { background: var(--error); color: white; }
    .btn-stock.plus { background: var(--sage); color: white; }
    .btn-stock.plus:hover { background: var(--sage-dark); }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      grid-column: 1 / -1;
    }

    .empty-state-icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
    .empty-state-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--text); }
    .empty-state-text { font-size: 0.9rem; margin-bottom: 20px; }

    /* ========== MODALS ========== */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 20px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal.modal-lg { max-width: 700px; }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--white);
      z-index: 10;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body { padding: 24px; }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--cream-dark);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    /* ========== FORM ========== */
    .form-group { margin-bottom: 16px; }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--mayordomo);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* ========== EDICI√ìN INVENTARIO ========== */
    .edit-inv-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .edit-inv-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream-dark);
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .edit-inv-tab:hover { border-color: var(--mayordomo-light); }
    .edit-inv-tab.active { background: var(--mayordomo); color: white; }

    .edit-inv-tab-del {
      background: none;
      border: none;
      color: inherit;
      opacity: 0.5;
      cursor: pointer;
      font-size: 1rem;
      padding: 0 0 0 4px;
    }

    .edit-inv-tab-del:hover { opacity: 1; color: var(--error); }
    .edit-inv-tab.active .edit-inv-tab-del:hover { color: #ffaaaa; }

    .edit-inv-add-lugar {
      padding: 8px 14px;
      background: transparent;
      border: 1px dashed var(--mayordomo-light);
      border-radius: var(--radius-md);
      color: var(--mayordomo);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .edit-inv-add-lugar:hover { background: var(--mayordomo-muted); }

    .edit-inv-grupo {
      background: white;
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      overflow: hidden;
      border: 1px solid var(--cream-dark);
    }

    .edit-inv-grupo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--cream-dark);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .edit-inv-grupo-header button {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1rem;
    }

    .edit-inv-grupo-header button:hover { color: var(--error); }

    .edit-inv-articulos { padding: 12px; }

    .edit-inv-art-header {
      display: grid;
      grid-template-columns: 1fr 100px 80px 70px 32px;
      gap: 8px;
      padding: 0 4px 8px;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .edit-inv-art-row {
      display: grid;
      grid-template-columns: 1fr 100px 80px 70px 32px;
      gap: 8px;
      align-items: center;
      padding: 6px 4px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .edit-inv-art-row:last-child { border-bottom: none; }

    .edit-inv-art-row input {
      padding: 6px 8px;
      border: 1px solid var(--cream-dark);
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: 'Nunito', sans-serif;
    }

    .edit-inv-art-row input:focus {
      outline: none;
      border-color: var(--mayordomo);
    }

    .edit-inv-art-row input[type="number"] { text-align: center; }

    .edit-inv-art-del {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1rem;
      padding: 4px;
    }

    .edit-inv-art-del:hover { color: var(--error); }

    .edit-inv-add-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: transparent;
      border: 1px dashed var(--mayordomo-light);
      border-radius: 6px;
      color: var(--mayordomo);
      font-size: 0.8rem;
      cursor: pointer;
      margin-top: 8px;
    }

    .edit-inv-add-btn:hover { background: var(--mayordomo-muted); }

    .edit-inv-danger-zone {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--cream-dark);
      text-align: right;
    }

    /* ========== REAUTH ========== */
    .reauth-icon {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .reauth-msg {
      text-align: center;
      margin-bottom: 20px;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .reauth-error {
      background: rgba(212, 105, 90, 0.1);
      color: var(--error);
      padding: 10px;
      border-radius: var(--radius-sm);
      margin-bottom: 12px;
      font-size: 0.85rem;
      text-align: center;
      display: none;
    }

    .hidden { display: none !important; }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      .header { padding: 12px 16px; }
      .header-actions { flex-wrap: wrap; }
      .main { padding: 16px; }
      .form-row { grid-template-columns: 1fr; }
      .productos-lista { gap: 4px; }
      .edit-inv-art-header,
      .edit-inv-art-row { 
        grid-template-columns: 1fr 70px 60px 50px 28px; 
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
      <div class="header-title">
        <div class="header-icon">üì¶</div>
        <div class="header-info">
          <h1>Inventario</h1>
          <p id="bien-nombre">Cargando...</p>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <a href="#" class="btn btn-primary" id="btn-toma">üìã Toma de Inventario</a>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Banner Lista de Compra -->
    <div class="lista-compra-banner hidden" id="lista-compra-banner">
      <div class="lista-compra-info">
        <span class="lista-compra-icon">üõí</span>
        <div class="lista-compra-text">
          <h3>Lista de compra</h3>
          <p><span id="items-pendientes">0</span> productos bajo stock m√≠nimo</p>
        </div>
      </div>
      <button class="btn btn-warning" onclick="abrirListaCompra()">Ver lista</button>
    </div>

    <!-- Tabs din√°micos por Lugar -->
    <div class="inventario-tabs" id="inventario-tabs">
      <!-- Se genera din√°micamente -->
    </div>

    <!-- Acciones -->
    <div class="grupo-header">
      <div class="grupo-title" id="grupo-title">Selecciona un lugar</div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-secondary" onclick="abrirEditInventario()">‚öôÔ∏è Editar estructura</button>
        <button class="btn btn-mayordomo" onclick="abrirModalProducto()">+ A√±adir art√≠culo</button>
      </div>
    </div>

    <!-- Grid de art√≠culos -->
    <div class="productos-lista" id="productos-lista">
      <!-- Se carga din√°micamente -->
    </div>
  </main>

  <!-- Modal Art√≠culo -->
  <div class="modal-overlay" id="modal-producto">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-producto-titulo">Nuevo art√≠culo</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-producto" onsubmit="guardarArticuloModal(event)">
        <input type="hidden" id="producto-id">
        <input type="hidden" id="producto-lugar-key">
        <input type="hidden" id="producto-grupo-key">
        <input type="hidden" id="producto-idx">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre del art√≠culo</label>
            <input type="text" class="form-input" id="producto-nombre" placeholder="Ej: Leche entera" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Lugar</label>
              <select class="form-select" id="producto-lugar" required onchange="cargarGruposSelect()">
                <option value="">Selecciona lugar...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Grupo</label>
              <select class="form-select" id="producto-grupo" required>
                <option value="">Selecciona grupo...</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Formato</label>
              <input type="text" class="form-input" id="producto-formato" placeholder="Ej: 1L, 500g, pack 6">
            </div>
            <div class="form-group">
              <label class="form-label">Unidad</label>
              <input type="text" class="form-input" id="producto-unidad" value="uds" placeholder="uds, kg, L...">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Stock actual</label>
              <input type="number" class="form-input" id="producto-stock" value="0" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">Stock m√≠nimo</label>
              <input type="number" class="form-input" id="producto-minimo" value="1" min="0">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger hidden" id="btn-eliminar-producto" onclick="eliminarArticuloModal()">Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
            <button type="submit" class="btn btn-mayordomo">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Lista de Compra -->
  <div class="modal-overlay" id="modal-lista">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üõí Lista de Compra</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body">
        <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px;">
          Marca los productos que hayas comprado para actualizar el stock
        </p>
        <div id="lista-compra-items">
          <!-- Items din√°micos -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cerrar</button>
        <button class="btn btn-mayordomo" onclick="marcarComprados()">‚úì Actualizar stock</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Inventario -->
  <div class="modal-overlay" id="modal-edit-inventario">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title">‚öôÔ∏è Editar estructura de inventario</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="edit-inv-tabs" id="edit-inv-tabs">
          <!-- Tabs de lugares -->
        </div>
        <div id="edit-inv-content">
          <!-- Contenido del lugar seleccionado -->
        </div>
        <div class="edit-inv-danger-zone">
          <button class="btn btn-danger btn-sm" onclick="confirmarBorrarTodo()">üóëÔ∏è Borrar todo el inventario</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-mayordomo" onclick="guardarInventarioEdit()">üíæ Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- Modal Reautenticaci√≥n -->
  <div class="modal-overlay" id="modal-reauth">
    <div class="modal" style="max-width:380px;">
      <div class="modal-header">
        <h3 class="modal-title">üîê Confirmar identidad</h3>
        <button class="modal-close" onclick="cerrarReauth()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="reauth-icon">üîí</div>
        <div class="reauth-msg">Esta acci√≥n requiere confirmar tu contrase√±a</div>
        <div class="reauth-error" id="reauth-error"></div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="reauth-email" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Contrase√±a</label>
          <input type="password" class="form-input" id="reauth-password" placeholder="Tu contrase√±a">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarReauth()">Cancelar</button>
        <button class="btn btn-mayordomo" onclick="ejecutarReauth()">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ========== VARIABLES GLOBALES ==========
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let origen = 'mayordomo'; // o 'gerente'
    
    // Inventario din√°mico
    let inventario = {};  // Lugar > Grupo > Art√≠culos
    let lugarActual = null;
    let grupoActual = null;

    // Edici√≥n inventario
    let inventarioEdit = {};
    let lugarActualEdit = null;
    let accionPendiente = null;
    let datoPendiente = null;

    // ========== INIT ==========
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      
      // Obtener par√°metros URL
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');
      origen = params.get('origen') || 'mayordomo';
      
      if (!bienId) {
        alert('No se especific√≥ el bien');
        window.location.href = 'lo-comun.html';
        return;
      }

      await cargarBien();
      await cargarInventario();
    });

    async function cargarBien() {
      const doc = await db.collection('bienes').doc(bienId).get();
      if (!doc.exists) {
        alert('Bien no encontrado');
        window.location.href = 'lo-comun.html';
        return;
      }
      
      bienData = doc.data();
      
      document.getElementById('bien-nombre').textContent = bienData.nombre || 'Sin nombre';
      document.getElementById('btn-volver').href = `${origen}.html?id=${bienId}`;
      document.getElementById('btn-toma').href = `toma-inventario.html?id=${bienId}&origen=${origen}`;
    }

    async function cargarInventario() {
      try {
        // 1. Leer estructura base del documento principal
        const doc = await db.collection('bienes').doc(bienId).get();
        inventario = doc.data()?.inventario || {};
        
        // 2. Leer valores actualizados de la subcolecci√≥n (si existe)
        const tomaDoc = await db.collection('bienes').doc(bienId)
          .collection('tomasInventario').doc('current').get();
        
        if (tomaDoc.exists && tomaDoc.data()?.inventario) {
          // Usar el inventario de la √∫ltima toma (tiene valores actualizados)
          inventario = tomaDoc.data().inventario;
        }
        
        renderLugaresTabs();
        actualizarContadores();
      } catch (error) {
        console.error('Error cargando inventario:', error);
      }
    }
    
    // Funci√≥n auxiliar para sincronizar inventario a la subcolecci√≥n
    async function sincronizarInventarioSubcol() {
      try {
        await db.collection('bienes').doc(bienId)
          .collection('tomasInventario').doc('current').set({
            inventario: inventario,
            ultimaToma: firebase.firestore.FieldValue.serverTimestamp(),
            tomaPor: currentUser?.uid || 'admin'
          });
      } catch (error) {
        console.error('Error sincronizando a subcolecci√≥n:', error);
      }
    }

    // ========== RENDER LUGARES ==========
    function renderLugaresTabs() {
      const container = document.getElementById('inventario-tabs');
      const lugares = Object.keys(inventario);
      
      if (lugares.length === 0) {
        container.innerHTML = `
          <div style="color:var(--text-muted); padding: 8px;">
            Sin lugares definidos. 
            <button class="btn btn-secondary btn-sm" onclick="abrirEditInventario()" style="margin-left:8px;">Crear estructura</button>
          </div>
        `;
        document.getElementById('productos-lista').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <div class="empty-state-title">Sin inventario</div>
            <div class="empty-state-text">Define la estructura de lugares y grupos</div>
            <button class="btn btn-mayordomo" onclick="abrirEditInventario()">Crear estructura</button>
          </div>
        `;
        return;
      }
      
      // Si no hay lugar seleccionado, seleccionar el primero
      if (!lugarActual || !inventario[lugarActual]) {
        lugarActual = lugares[0];
      }
      
      container.innerHTML = lugares.map(key => `
        <button class="inventario-tab ${key === lugarActual ? 'active' : ''}" data-lugar="${key}" onclick="seleccionarLugar('${key}')">
          ${inventario[key].nombre}
          <span class="inventario-tab-count">${contarArticulosLugar(key)}</span>
        </button>
      `).join('');
      
      renderArticulos();
    }

    function contarArticulosLugar(lugarKey) {
      const lugar = inventario[lugarKey];
      if (!lugar?.grupos) return 0;
      
      let total = 0;
      Object.values(lugar.grupos).forEach(grupo => {
        total += (grupo.articulos || []).length;
      });
      return total;
    }

    function seleccionarLugar(lugarKey) {
      lugarActual = lugarKey;
      grupoActual = null;
      
      document.querySelectorAll('.inventario-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.lugar === lugarKey);
      });
      
      renderArticulos();
    }

    // ========== RENDER ART√çCULOS ==========
    function renderArticulos() {
      const lugar = inventario[lugarActual];
      if (!lugar) return;
      
      const container = document.getElementById('productos-lista');
      const titulo = document.getElementById('grupo-title');
      titulo.textContent = lugar.nombre;
      
      const grupos = lugar.grupos || {};
      
      if (Object.keys(grupos).length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <div class="empty-state-title">Sin grupos</div>
            <div class="empty-state-text">A√±ade grupos desde "Editar estructura"</div>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      for (const [grupoKey, grupo] of Object.entries(grupos)) {
        const articulos = grupo.articulos || [];
        
        html += `<div class="grupo-section">
          <div class="grupo-section-title">${grupo.nombre} (${articulos.length})</div>
          <div class="productos-lista">`;
        
        if (articulos.length === 0) {
          html += `<div style="color:var(--text-muted); font-size:0.85rem; padding:12px;">Sin art√≠culos</div>`;
        } else {
          articulos.forEach((art, idx) => {
            const porcentaje = art.minimo > 0 ? Math.min(100, ((art.actual || 0) / art.minimo) * 100) : 100;
            const estado = (art.actual || 0) === 0 ? 'critico' : (art.actual || 0) < art.minimo ? 'bajo' : 'ok';
            
            html += `
              <div class="producto-bloque ${estado !== 'ok' ? estado : ''}" onclick="editarArticuloModal('${lugarActual}', '${grupoKey}', ${idx})">
                <div class="producto-info">
                  <div class="producto-nombre">${art.nombre}</div>
                  <div class="producto-formato">${art.formato || ''}</div>
                </div>
                <div class="producto-stock">
                  <div class="stock-visual">
                    <div class="stock-bar ${estado}" style="width: ${porcentaje}%"></div>
                  </div>
                  <span class="stock-text ${estado}">${art.actual || 0}/${art.minimo}</span>
                </div>
                <div class="producto-actions" onclick="event.stopPropagation()">
                  <button class="btn-stock minus" onclick="cambiarStock('${lugarActual}', '${grupoKey}', ${idx}, -1)">‚àí</button>
                  <button class="btn-stock plus" onclick="cambiarStock('${lugarActual}', '${grupoKey}', ${idx}, 1)">+</button>
                </div>
              </div>
            `;
          });
        }
        
        html += `</div></div>`;
      }
      
      container.innerHTML = html;
    }

    // ========== CONTADORES ==========
    function actualizarContadores() {
      let totalBajo = 0;
      
      for (const lugar of Object.values(inventario)) {
        for (const grupo of Object.values(lugar.grupos || {})) {
          for (const art of (grupo.articulos || [])) {
            if ((art.actual || 0) < art.minimo) totalBajo++;
          }
        }
      }
      
      const banner = document.getElementById('lista-compra-banner');
      
      if (totalBajo > 0) {
        banner.classList.remove('hidden');
        document.getElementById('items-pendientes').textContent = totalBajo;
      } else {
        banner.classList.add('hidden');
      }
    }

    // ========== CAMBIAR STOCK ==========
    async function cambiarStock(lugarKey, grupoKey, idx, delta) {
      const art = inventario[lugarKey].grupos[grupoKey].articulos[idx];
      art.actual = Math.max(0, (art.actual || 0) + delta);
      
      try {
        await db.collection('bienes').doc(bienId).update({ inventario });
        await sincronizarInventarioSubcol(); // Sincronizar a subcolecci√≥n
        renderArticulos();
        actualizarContadores();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ========== MODAL ART√çCULO ==========
    function abrirModalProducto() {
      document.getElementById('form-producto').reset();
      document.getElementById('producto-id').value = '';
      document.getElementById('producto-lugar-key').value = '';
      document.getElementById('producto-grupo-key').value = '';
      document.getElementById('producto-idx').value = '';
      document.getElementById('modal-producto-titulo').textContent = 'Nuevo art√≠culo';
      document.getElementById('btn-eliminar-producto').classList.add('hidden');
      
      cargarLugaresSelect();
      
      if (lugarActual) {
        document.getElementById('producto-lugar').value = lugarActual;
        cargarGruposSelect();
      }
      
      document.getElementById('modal-producto').classList.add('active');
    }

    function editarArticuloModal(lugarKey, grupoKey, idx) {
      const art = inventario[lugarKey].grupos[grupoKey].articulos[idx];
      
      document.getElementById('producto-lugar-key').value = lugarKey;
      document.getElementById('producto-grupo-key').value = grupoKey;
      document.getElementById('producto-idx').value = idx;
      
      cargarLugaresSelect();
      document.getElementById('producto-lugar').value = lugarKey;
      cargarGruposSelect();
      document.getElementById('producto-grupo').value = grupoKey;
      
      document.getElementById('producto-nombre').value = art.nombre || '';
      document.getElementById('producto-formato').value = art.formato || '';
      document.getElementById('producto-unidad').value = art.unidad || 'uds';
      document.getElementById('producto-stock').value = art.actual || 0;
      document.getElementById('producto-minimo').value = art.minimo || 1;
      
      document.getElementById('modal-producto-titulo').textContent = 'Editar art√≠culo';
      document.getElementById('btn-eliminar-producto').classList.remove('hidden');
      
      document.getElementById('modal-producto').classList.add('active');
    }

    function cargarLugaresSelect() {
      const select = document.getElementById('producto-lugar');
      const lugares = Object.keys(inventario);
      
      select.innerHTML = `<option value="">Selecciona lugar...</option>` +
        lugares.map(key => `<option value="${key}">${inventario[key].nombre}</option>`).join('');
    }

    function cargarGruposSelect() {
      const lugarKey = document.getElementById('producto-lugar').value;
      const select = document.getElementById('producto-grupo');
      
      if (!lugarKey || !inventario[lugarKey]) {
        select.innerHTML = '<option value="">Selecciona grupo...</option>';
        return;
      }
      
      const grupos = inventario[lugarKey].grupos || {};
      
      select.innerHTML = `<option value="">Selecciona grupo...</option>` +
        Object.keys(grupos).map(key => `<option value="${key}">${grupos[key].nombre}</option>`).join('');
    }

    async function guardarArticuloModal(e) {
      e.preventDefault();
      
      const lugarKey = document.getElementById('producto-lugar').value;
      const grupoKey = document.getElementById('producto-grupo').value;
      const oldLugarKey = document.getElementById('producto-lugar-key').value;
      const oldGrupoKey = document.getElementById('producto-grupo-key').value;
      const oldIdx = document.getElementById('producto-idx').value;
      
      if (!lugarKey || !grupoKey) {
        alert('Selecciona lugar y grupo');
        return;
      }
      
      const articulo = {
        nombre: document.getElementById('producto-nombre').value.trim(),
        formato: document.getElementById('producto-formato').value.trim(),
        unidad: document.getElementById('producto-unidad').value.trim() || 'uds',
        actual: parseInt(document.getElementById('producto-stock').value) || 0,
        minimo: parseInt(document.getElementById('producto-minimo').value) || 1
      };
      
      // Si es edici√≥n y cambi√≥ de lugar/grupo, eliminar del antiguo
      if (oldIdx !== '' && (oldLugarKey !== lugarKey || oldGrupoKey !== grupoKey)) {
        inventario[oldLugarKey].grupos[oldGrupoKey].articulos.splice(parseInt(oldIdx), 1);
      }
      
      // Si es edici√≥n en mismo lugar/grupo
      if (oldIdx !== '' && oldLugarKey === lugarKey && oldGrupoKey === grupoKey) {
        inventario[lugarKey].grupos[grupoKey].articulos[parseInt(oldIdx)] = articulo;
      } else {
        // Nuevo art√≠culo
        if (!inventario[lugarKey].grupos[grupoKey].articulos) {
          inventario[lugarKey].grupos[grupoKey].articulos = [];
        }
        inventario[lugarKey].grupos[grupoKey].articulos.push(articulo);
      }
      
      try {
        await db.collection('bienes').doc(bienId).update({ inventario });
        await sincronizarInventarioSubcol(); // Sincronizar a subcolecci√≥n
        cerrarModales();
        renderLugaresTabs();
        actualizarContadores();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar');
      }
    }

    async function eliminarArticuloModal() {
      const lugarKey = document.getElementById('producto-lugar-key').value;
      const grupoKey = document.getElementById('producto-grupo-key').value;
      const idx = document.getElementById('producto-idx').value;
      
      if (idx === '' || !confirm('¬øEliminar este art√≠culo?')) return;
      
      inventario[lugarKey].grupos[grupoKey].articulos.splice(parseInt(idx), 1);
      
      try {
        await db.collection('bienes').doc(bienId).update({ inventario });
        await sincronizarInventarioSubcol(); // Sincronizar a subcolecci√≥n
        cerrarModales();
        renderLugaresTabs();
        actualizarContadores();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ========== LISTA DE COMPRA ==========
    function abrirListaCompra() {
      const container = document.getElementById('lista-compra-items');
      let items = [];
      
      for (const [lugarKey, lugar] of Object.entries(inventario)) {
        for (const [grupoKey, grupo] of Object.entries(lugar.grupos || {})) {
          for (let idx = 0; idx < (grupo.articulos || []).length; idx++) {
            const art = grupo.articulos[idx];
            if ((art.actual || 0) < art.minimo) {
              items.push({
                lugarKey, grupoKey, idx,
                lugar: lugar.nombre,
                grupo: grupo.nombre,
                ...art,
                faltan: art.minimo - (art.actual || 0)
              });
            }
          }
        }
      }
      
      if (items.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-muted)">No hay art√≠culos pendientes</p>';
      } else {
        container.innerHTML = items.map(p => `
          <label style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--cream);border-radius:var(--radius-md);margin-bottom:8px;cursor:pointer;">
            <input type="checkbox" class="lista-check" data-lugar="${p.lugarKey}" data-grupo="${p.grupoKey}" data-idx="${p.idx}" data-cantidad="${p.faltan}" style="width:20px;height:20px;">
            <div style="flex:1;">
              <div style="font-weight:600;">${p.nombre}</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">
                ${p.lugar} ‚Ä∫ ${p.grupo} | Comprar: ${p.faltan} ${p.unidad || 'uds'}
              </div>
            </div>
          </label>
        `).join('');
      }
      
      document.getElementById('modal-lista').classList.add('active');
    }

    async function marcarComprados() {
      const checks = document.querySelectorAll('.lista-check:checked');
      
      for (const check of checks) {
        const lugarKey = check.dataset.lugar;
        const grupoKey = check.dataset.grupo;
        const idx = parseInt(check.dataset.idx);
        const cantidad = parseInt(check.dataset.cantidad) || 0;
        
        const art = inventario[lugarKey].grupos[grupoKey].articulos[idx];
        art.actual = (art.actual || 0) + cantidad;
      }
      
      try {
        await db.collection('bienes').doc(bienId).update({ inventario });
        await sincronizarInventarioSubcol(); // Sincronizar a subcolecci√≥n
        cerrarModales();
        renderLugaresTabs();
        actualizarContadores();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ========== EDICI√ìN DE INVENTARIO ==========
    function abrirEditInventario() {
      db.collection('bienes').doc(bienId).get().then(doc => {
        inventarioEdit = doc.data()?.inventario || {};
        lugarActualEdit = null;
        renderEditTabs();
        document.getElementById('modal-edit-inventario').classList.add('active');
      });
    }

    function renderEditTabs() {
      const container = document.getElementById('edit-inv-tabs');
      const lugares = Object.keys(inventarioEdit);
      
      let html = lugares.map(key => `
        <button class="edit-inv-tab ${key === lugarActualEdit ? 'active' : ''}" onclick="seleccionarLugarEdit('${key}')">
          ${inventarioEdit[key].nombre}
          <span class="edit-inv-tab-del" onclick="event.stopPropagation(); confirmarBorrarLugar('${key}')" title="Eliminar lugar">√ó</span>
        </button>
      `).join('');
      
      html += `<button class="edit-inv-add-lugar" onclick="agregarLugarEdit()">+ Lugar</button>`;
      container.innerHTML = html;
      
      if (lugarActualEdit && inventarioEdit[lugarActualEdit]) {
        renderLugarContent();
      } else if (lugares.length > 0 && !lugarActualEdit) {
        seleccionarLugarEdit(lugares[0]);
      } else {
        document.getElementById('edit-inv-content').innerHTML = 
          '<p style="text-align:center; color:var(--text-muted); padding: 30px;">Crea un lugar para comenzar</p>';
      }
    }

    function seleccionarLugarEdit(key) {
      lugarActualEdit = key;
      document.querySelectorAll('.edit-inv-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.edit-inv-tab[onclick*="${key}"]`)?.classList.add('active');
      renderLugarContent();
    }

    function renderLugarContent() {
      const lugar = inventarioEdit[lugarActualEdit];
      if (!lugar) return;
      
      const container = document.getElementById('edit-inv-content');
      let html = '';
      
      const grupos = lugar.grupos || {};
      for (const [grupoKey, grupo] of Object.entries(grupos)) {
        html += `
          <div class="edit-inv-grupo">
            <div class="edit-inv-grupo-header">
              <span>${grupo.nombre}</span>
              <button onclick="confirmarBorrarGrupo('${grupoKey}')" title="Eliminar grupo">√ó</button>
            </div>
            <div class="edit-inv-articulos">
              <div class="edit-inv-art-header">
                <span>Nombre</span>
                <span>Formato</span>
                <span>Unidad</span>
                <span>Min</span>
                <span></span>
              </div>`;
        
        const articulos = grupo.articulos || [];
        articulos.forEach((art, idx) => {
          html += `
            <div class="edit-inv-art-row">
              <input type="text" value="${art.nombre || ''}" onchange="actualizarArticulo('${grupoKey}', ${idx}, 'nombre', this.value)" placeholder="Nombre">
              <input type="text" value="${art.formato || ''}" onchange="actualizarArticulo('${grupoKey}', ${idx}, 'formato', this.value)" placeholder="500ml...">
              <input type="text" value="${art.unidad || 'uds'}" onchange="actualizarArticulo('${grupoKey}', ${idx}, 'unidad', this.value)" placeholder="uds">
              <input type="number" value="${art.minimo || 0}" min="0" onchange="actualizarArticulo('${grupoKey}', ${idx}, 'minimo', parseInt(this.value))">
              <button class="edit-inv-art-del" onclick="eliminarArticulo('${grupoKey}', ${idx})" title="Eliminar">√ó</button>
            </div>`;
        });
        
        html += `
              <button class="edit-inv-add-btn" onclick="agregarArticulo('${grupoKey}')">+ Art√≠culo</button>
            </div>
          </div>`;
      }
      
      html += `<button class="edit-inv-add-btn" onclick="agregarGrupoEdit()" style="margin-top:12px;">+ Grupo</button>`;
      container.innerHTML = html;
    }

    function agregarLugarEdit() {
      const nombre = prompt('Nombre del nuevo lugar:');
      if (!nombre || !nombre.trim()) return;
      
      const key = nombre.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      if (inventarioEdit[key]) {
        alert('Ya existe un lugar con ese nombre');
        return;
      }
      
      inventarioEdit[key] = { nombre: nombre.trim(), grupos: {} };
      lugarActualEdit = key;
      renderEditTabs();
    }

    function agregarGrupoEdit() {
      const nombre = prompt('Nombre del nuevo grupo:');
      if (!nombre || !nombre.trim() || !lugarActualEdit) return;
      
      const key = nombre.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      if (!inventarioEdit[lugarActualEdit].grupos) {
        inventarioEdit[lugarActualEdit].grupos = {};
      }
      
      if (inventarioEdit[lugarActualEdit].grupos[key]) {
        alert('Ya existe un grupo con ese nombre');
        return;
      }
      
      inventarioEdit[lugarActualEdit].grupos[key] = { nombre: nombre.trim(), articulos: [] };
      renderLugarContent();
    }

    function agregarArticulo(grupoKey) {
      if (!inventarioEdit[lugarActualEdit].grupos[grupoKey].articulos) {
        inventarioEdit[lugarActualEdit].grupos[grupoKey].articulos = [];
      }
      inventarioEdit[lugarActualEdit].grupos[grupoKey].articulos.push({
        nombre: '',
        formato: '',
        unidad: 'uds',
        minimo: 0,
        actual: 0
      });
      renderLugarContent();
    }

    function actualizarArticulo(grupoKey, idx, campo, valor) {
      inventarioEdit[lugarActualEdit].grupos[grupoKey].articulos[idx][campo] = valor;
    }

    function eliminarArticulo(grupoKey, idx) {
      if (!confirm('¬øEliminar este art√≠culo?')) return;
      inventarioEdit[lugarActualEdit].grupos[grupoKey].articulos.splice(idx, 1);
      renderLugarContent();
    }

    // ========== BORRADOS CON REAUTENTICACI√ìN ==========
    function confirmarBorrarGrupo(grupoKey) {
      if (!confirm(`¬øEliminar el grupo "${inventarioEdit[lugarActualEdit].grupos[grupoKey].nombre}" y todos sus art√≠culos?`)) return;
      accionPendiente = 'borrar_grupo';
      datoPendiente = grupoKey;
      abrirReauth();
    }

    function confirmarBorrarLugar(lugarKey) {
      if (!confirm(`¬øEliminar "${inventarioEdit[lugarKey].nombre}" y todo su contenido?`)) return;
      accionPendiente = 'borrar_lugar';
      datoPendiente = lugarKey;
      abrirReauth();
    }

    function confirmarBorrarTodo() {
      if (!confirm('¬øBorrar TODO el inventario de este bien? Esta acci√≥n es irreversible.')) return;
      accionPendiente = 'borrar_todo';
      datoPendiente = null;
      abrirReauth();
    }

    function abrirReauth() {
      document.getElementById('reauth-email').value = currentUser.email;
      document.getElementById('reauth-password').value = '';
      document.getElementById('reauth-error').style.display = 'none';
      document.getElementById('modal-reauth').classList.add('active');
    }

    function cerrarReauth() {
      document.getElementById('modal-reauth').classList.remove('active');
      accionPendiente = null;
      datoPendiente = null;
    }

    async function ejecutarReauth() {
      const password = document.getElementById('reauth-password').value;
      if (!password) {
        document.getElementById('reauth-error').textContent = 'Introduce tu contrase√±a';
        document.getElementById('reauth-error').style.display = 'block';
        return;
      }
      
      try {
        const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
        await currentUser.reauthenticateWithCredential(credential);
        
        if (accionPendiente === 'borrar_todo') {
          inventarioEdit = {};
          lugarActualEdit = null;
        } else if (accionPendiente === 'borrar_lugar') {
          delete inventarioEdit[datoPendiente];
          if (lugarActualEdit === datoPendiente) lugarActualEdit = null;
        } else if (accionPendiente === 'borrar_grupo') {
          delete inventarioEdit[lugarActualEdit].grupos[datoPendiente];
        }
        
        cerrarReauth();
        renderEditTabs();
        
      } catch (error) {
        console.error('Error reauth:', error);
        document.getElementById('reauth-error').textContent = 'Contrase√±a incorrecta';
        document.getElementById('reauth-error').style.display = 'block';
      }
    }

    async function guardarInventarioEdit() {
      // Limpiar art√≠culos vac√≠os
      for (const lugarKey of Object.keys(inventarioEdit)) {
        const grupos = inventarioEdit[lugarKey].grupos || {};
        for (const grupoKey of Object.keys(grupos)) {
          grupos[grupoKey].articulos = (grupos[grupoKey].articulos || [])
            .filter(a => a.nombre && a.nombre.trim());
        }
      }
      
      try {
        await db.collection('bienes').doc(bienId).update({
          inventario: inventarioEdit,
          inventarioActualizado: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Actualizar inventario local
        inventario = inventarioEdit;
        
        // Sincronizar a subcolecci√≥n
        await sincronizarInventarioSubcol();
        
        cerrarModales();
        renderLugaresTabs();
        actualizarContadores();
      } catch (error) {
        console.error('Error guardando inventario:', error);
        alert('Error al guardar');
      }
    }

    // ========== UTILIDADES ==========
    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    }

    // Cerrar modales con click fuera
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) cerrarModales();
      });
    });
  </script>
</body>
</html>
