<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Inventario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-dark: #6B5A45;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --gerente: #2D4A5C;
      --gerente-muted: rgba(45, 74, 92, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --success-muted: rgba(125, 181, 154, 0.15);
      --warning: #E8B44D;
      --warning-muted: rgba(232, 180, 77, 0.15);
      --error: #D4695A;
      --error-muted: rgba(212, 105, 90, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* ========== HEADER ========== */
    .header {
      background: var(--white);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 12px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: var(--cream-dark); }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-title h1 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .bien-badge {
      padding: 4px 10px;
      background: var(--mayordomo-muted);
      color: var(--mayordomo);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .header-actions { display: flex; gap: 8px; }

    /* ========== TABS PRINCIPALES ========== */
    .main-tabs {
      display: flex;
      background: var(--white);
      border-bottom: 1px solid var(--cream-dark);
      position: sticky;
      top: 56px;
      z-index: 99;
    }

    .main-tab {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      font-family: 'Quicksand', sans-serif;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-light);
    }

    .main-tab:hover { background: var(--cream); }
    .main-tab.active { 
      color: var(--mayordomo); 
      border-bottom-color: var(--mayordomo);
      background: var(--mayordomo-muted);
    }

    .tab-icon { font-size: 1.1rem; }

    /* ========== CONTENIDO ========== */
    .main { max-width: 800px; margin: 0 auto; padding: 16px; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ========== CONFIGURAR: LUGARES ========== */
    .lugares-list { margin-bottom: 16px; }

    .lugar-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      margin-bottom: 12px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .lugar-header {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--mayordomo-muted);
      cursor: pointer;
      transition: background 0.2s;
    }

    .lugar-header:hover { background: rgba(139, 115, 85, 0.25); }

    .lugar-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .lugar-icon {
      width: 36px;
      height: 36px;
      background: var(--mayordomo);
      color: white;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .lugar-nombre {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
    }

    .lugar-stats {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .lugar-actions {
      display: flex;
      gap: 4px;
    }

    .lugar-actions button {
      padding: 6px 10px;
      background: var(--white);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .lugar-actions button:hover { background: var(--cream-dark); }

    .lugar-body {
      padding: 0 16px 16px;
      display: none;
    }

    .lugar-card.expanded .lugar-body { display: block; }
    .lugar-card.expanded .lugar-chevron { transform: rotate(180deg); }

    .lugar-chevron { transition: transform 0.2s; }

    /* ========== GRUPOS ========== */
    .grupos-list { margin-top: 12px; }

    .grupo-card {
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 10px;
      overflow: hidden;
    }

    .grupo-header {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .grupo-header:hover { background: var(--cream-dark); }

    .grupo-nombre {
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .grupo-body {
      padding: 0 14px 14px;
      display: none;
    }

    .grupo-card.expanded .grupo-body { display: block; }

    /* ========== ART√çCULOS (CONFIG) ========== */
    .articulos-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .articulos-table th {
      text-align: left;
      padding: 8px 6px;
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--cream-dark);
    }

    .articulos-table td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .articulos-table input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      background: var(--white);
    }

    .articulos-table input:focus {
      outline: none;
      border-color: var(--mayordomo);
    }

    .articulos-table input[type="number"] {
      width: 60px;
      text-align: center;
    }

    .btn-delete-art {
      padding: 4px 8px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      opacity: 0.5;
      transition: opacity 0.2s;
    }

    .btn-delete-art:hover { opacity: 1; }

    /* ========== BOTONES ========== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--mayordomo);
      color: white;
    }

    .btn-primary:hover { background: var(--mayordomo-dark); }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
      border: 1px solid var(--cream-dark);
    }

    .btn-secondary:hover { background: var(--cream-dark); }

    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

    .btn-add-inline {
      padding: 8px 12px;
      background: transparent;
      border: 2px dashed var(--mayordomo-light);
      border-radius: var(--radius-md);
      color: var(--mayordomo);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
      transition: all 0.2s;
    }

    .btn-add-inline:hover {
      background: var(--mayordomo-muted);
      border-style: solid;
    }

    .btn-add-lugar {
      width: 100%;
      padding: 16px;
      background: var(--white);
      border: 2px dashed var(--mayordomo);
      border-radius: var(--radius-lg);
      color: var(--mayordomo);
      font-family: 'Quicksand', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-add-lugar:hover {
      background: var(--mayordomo-muted);
      border-style: solid;
    }

    /* ========== TOMA DE INVENTARIO (M√ìVIL-FIRST) ========== */
    .toma-header {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toma-fecha {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .toma-fecha strong {
      color: var(--text);
      font-size: 1rem;
    }

    .toma-progress {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .progress-bar {
      width: 100px;
      height: 8px;
      background: var(--cream-dark);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      border-radius: var(--radius-full);
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    /* Selector de lugar para toma */
    .toma-lugar-selector {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .toma-lugar-btn {
      flex-shrink: 0;
      padding: 10px 16px;
      background: var(--white);
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toma-lugar-btn:hover { border-color: var(--mayordomo); }
    .toma-lugar-btn.active {
      background: var(--mayordomo);
      color: white;
      border-color: var(--mayordomo);
    }

    /* Cards de conteo - MOBILE FRIENDLY */
    .toma-grupo {
      background: var(--white);
      border-radius: var(--radius-lg);
      margin-bottom: 12px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .toma-grupo-header {
      padding: 12px 16px;
      background: var(--cream);
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toma-articulo {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--cream);
      gap: 12px;
    }

    .toma-articulo:last-child { border-bottom: none; }

    .toma-art-info {
      flex: 1;
      min-width: 0;
    }

    .toma-art-nombre {
      font-weight: 600;
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .toma-art-formato {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .toma-art-minimo {
      font-size: 0.7rem;
      padding: 2px 6px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
    }

    .toma-art-input {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toma-input {
      width: 70px;
      height: 44px;
      padding: 0 12px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
      background: var(--white);
      -moz-appearance: textfield;
    }

    .toma-input::-webkit-outer-spin-button,
    .toma-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .toma-input:focus {
      outline: none;
      border-color: var(--mayordomo);
    }

    .toma-input.bajo-minimo {
      border-color: var(--warning);
      background: var(--warning-muted);
    }

    .toma-input.ok {
      border-color: var(--success);
      background: var(--success-muted);
    }

    .toma-status {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .toma-status.ok { background: var(--success-muted); }
    .toma-status.bajo { background: var(--warning-muted); }
    .toma-status.vacio { background: var(--error-muted); }
    .toma-status.pending { background: var(--cream); }

    /* Resumen de toma */
    .toma-resumen {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--white);
      padding: 12px 16px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 50;
    }

    .toma-resumen-stats {
      display: flex;
      gap: 16px;
    }

    .toma-stat {
      text-align: center;
    }

    .toma-stat-num {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .toma-stat-num.ok { color: var(--success); }
    .toma-stat-num.bajo { color: var(--warning); }
    .toma-stat-num.vacio { color: var(--error); }

    .toma-stat-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    .empty-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 8px;
    }

    .empty-text {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    /* ========== MODALES ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 16px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      background: var(--cream);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body { padding: 20px; }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--cream-dark);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .form-group { margin-bottom: 16px; }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--mayordomo);
    }

    .icon-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }

    .icon-option {
      width: 100%;
      aspect-ratio: 1;
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .icon-option:hover { border-color: var(--mayordomo-light); }
    .icon-option.selected { border-color: var(--mayordomo); background: var(--mayordomo-muted); }

    /* ========== LOADING ========== */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--mayordomo);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      .header-title h1 { font-size: 1rem; }
      .bien-badge { display: none; }
      .main { padding: 12px; }
      
      .articulos-table th:nth-child(3),
      .articulos-table td:nth-child(3) { display: none; }
      
      .toma-resumen { padding: 10px 12px; }
      .toma-stat-num { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
      <div class="header-title">
        <h1>üì¶ Inventario</h1>
        <span class="bien-badge" id="nombre-bien">Cargando...</span>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary btn-sm" onclick="guardarTodo()" id="btn-guardar">
        üíæ Guardar
      </button>
    </div>
  </header>

  <!-- TABS -->
  <div class="main-tabs">
    <button class="main-tab active" data-tab="configurar" onclick="cambiarTab('configurar')">
      <span class="tab-icon">‚öôÔ∏è</span>
      <span>Configurar</span>
    </button>
    <button class="main-tab" data-tab="contar" onclick="cambiarTab('contar')">
      <span class="tab-icon">üìã</span>
      <span>Toma</span>
    </button>
  </div>

  <!-- CONTENIDO -->
  <main class="main">
    <!-- LOADING -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>

    <!-- TAB: CONFIGURAR -->
    <div id="tab-configurar" class="tab-content active">
      <div id="lugares-container">
        <!-- Lugares se renderizan aqu√≠ -->
      </div>
      <button class="btn-add-lugar" onclick="abrirModalLugar()">
        ‚ûï A√±adir lugar
      </button>
    </div>

    <!-- TAB: TOMA DE INVENTARIO -->
    <div id="tab-contar" class="tab-content">
      <div class="toma-header">
        <div class="toma-fecha">
          <strong id="toma-fecha-actual"></strong><br>
          √öltima toma: <span id="ultima-toma">Nunca</span>
        </div>
        <div class="toma-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
          <span class="progress-text" id="progress-text">0%</span>
        </div>
      </div>

      <div class="toma-lugar-selector" id="toma-lugares">
        <!-- Botones de lugares -->
      </div>

      <div id="toma-contenido">
        <!-- Grupos y art√≠culos para contar -->
      </div>
    </div>
  </main>

  <!-- BARRA RESUMEN TOMA (solo visible en tab contar) -->
  <div class="toma-resumen hidden" id="toma-resumen">
    <div class="toma-resumen-stats">
      <div class="toma-stat">
        <div class="toma-stat-num ok" id="stat-ok">0</div>
        <div class="toma-stat-label">OK</div>
      </div>
      <div class="toma-stat">
        <div class="toma-stat-num bajo" id="stat-bajo">0</div>
        <div class="toma-stat-label">Bajo</div>
      </div>
      <div class="toma-stat">
        <div class="toma-stat-num vacio" id="stat-pendiente">0</div>
        <div class="toma-stat-label">Pend.</div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="finalizarToma()">
      ‚úÖ Finalizar
    </button>
  </div>

  <!-- MODAL: NUEVO LUGAR -->
  <div class="modal-overlay" id="modal-lugar">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-lugar-titulo">üìç Nuevo lugar</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Icono</label>
          <div class="icon-grid" id="iconos-lugar">
            <button type="button" class="icon-option selected" data-icon="üè†">üè†</button>
            <button type="button" class="icon-option" data-icon="üç≥">üç≥</button>
            <button type="button" class="icon-option" data-icon="üõÅ">üõÅ</button>
            <button type="button" class="icon-option" data-icon="üõèÔ∏è">üõèÔ∏è</button>
            <button type="button" class="icon-option" data-icon="üß∫">üß∫</button>
            <button type="button" class="icon-option" data-icon="üßπ">üßπ</button>
            <button type="button" class="icon-option" data-icon="üöó">üöó</button>
            <button type="button" class="icon-option" data-icon="üè°">üè°</button>
            <button type="button" class="icon-option" data-icon="üå≥">üå≥</button>
            <button type="button" class="icon-option" data-icon="üèä">üèä</button>
            <button type="button" class="icon-option" data-icon="üç∑">üç∑</button>
            <button type="button" class="icon-option" data-icon="‚ùÑÔ∏è">‚ùÑÔ∏è</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Nombre del lugar</label>
          <input type="text" class="form-input" id="lugar-nombre" placeholder="Ej: Cocina, Despensa, Ba√±o principal...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarLugar()">Crear lugar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: NUEVO GRUPO -->
  <div class="modal-overlay" id="modal-grupo">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üìÅ Nuevo grupo</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nombre del grupo</label>
          <input type="text" class="form-input" id="grupo-nombre" placeholder="Ej: Limpieza, Alimentaci√≥n, Higiene...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarGrupo()">Crear grupo</button>
      </div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ========== VARIABLES ==========
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let inventario = {}; // { lugarKey: { nombre, icono, grupos: { grupoKey: { nombre, articulos: [] } } } }
    let lugarActual = null;
    let grupoActualParaAgregar = null;
    let editandoLugarKey = null;
    let tomaLugarActual = null;

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');
      
      // Detectar origen (mayordomo o gerente)
      const origen = params.get('origen') || 'mayordomo';

      if (!bienId) {
        alert('No se especific√≥ el bien');
        window.location.href = 'lo-comun.html';
        return;
      }

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await cargarDatos();
        } else {
          window.location.href = 'login.html';
        }
      });

      // Fecha actual para toma
      const hoy = new Date();
      document.getElementById('toma-fecha-actual').textContent = hoy.toLocaleDateString('es', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long' 
      });

      // Event listeners iconos
      document.querySelectorAll('#iconos-lugar .icon-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#iconos-lugar .icon-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        });
      });
    });

    async function cargarDatos() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (doc.exists) {
          bienData = doc.data();
          document.getElementById('nombre-bien').textContent = bienData.nombre || 'Sin nombre';
          
          // Determinar URL de retorno
          const origen = new URLSearchParams(window.location.search).get('origen');
          if (origen === 'gerente') {
            document.getElementById('btn-volver').href = `gerente.html?id=${bienId}`;
          } else {
            document.getElementById('btn-volver').href = `mayordomo.html?id=${bienId}`;
          }

          // Cargar inventario existente
          inventario = bienData.inventario || {};
          
          // Cargar √∫ltima toma
          if (bienData.ultimaToma) {
            const fecha = bienData.ultimaToma.toDate ? bienData.ultimaToma.toDate() : new Date(bienData.ultimaToma);
            document.getElementById('ultima-toma').textContent = fecha.toLocaleDateString('es', { 
              day: 'numeric', 
              month: 'short', 
              year: 'numeric' 
            });
          }
        }

        document.getElementById('loading').classList.add('hidden');
        renderLugares();
        renderTomaLugares();

      } catch (error) {
        console.error('Error cargando datos:', error);
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // ========== TABS ==========
    function cambiarTab(tab) {
      document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');

      // Mostrar/ocultar barra resumen
      if (tab === 'contar') {
        document.getElementById('toma-resumen').classList.remove('hidden');
        renderTomaContenido();
      } else {
        document.getElementById('toma-resumen').classList.add('hidden');
      }
    }

    // ========== RENDER CONFIGURACI√ìN ==========
    function renderLugares() {
      const container = document.getElementById('lugares-container');
      const lugaresKeys = Object.keys(inventario);

      if (lugaresKeys.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <div class="empty-title">Sin lugares configurados</div>
            <div class="empty-text">Crea lugares como Cocina, Despensa, Ba√±o... para organizar tu inventario</div>
          </div>
        `;
        return;
      }

      container.innerHTML = lugaresKeys.map(key => {
        const lugar = inventario[key];
        const gruposKeys = Object.keys(lugar.grupos || {});
        const totalArticulos = gruposKeys.reduce((sum, gk) => {
          return sum + (lugar.grupos[gk].articulos?.length || 0);
        }, 0);

        return `
          <div class="lugar-card" id="lugar-${key}">
            <div class="lugar-header" onclick="toggleLugar('${key}')">
              <div class="lugar-header-left">
                <div class="lugar-icon">${lugar.icono || 'üìç'}</div>
                <div>
                  <div class="lugar-nombre">${lugar.nombre}</div>
                  <div class="lugar-stats">${gruposKeys.length} grupos ¬∑ ${totalArticulos} art√≠culos</div>
                </div>
              </div>
              <div class="lugar-actions">
                <button onclick="event.stopPropagation(); editarLugar('${key}')" title="Editar">‚úèÔ∏è</button>
                <button onclick="event.stopPropagation(); eliminarLugar('${key}')" title="Eliminar">üóëÔ∏è</button>
                <span class="lugar-chevron">‚ñº</span>
              </div>
            </div>
            <div class="lugar-body">
              <div class="grupos-list" id="grupos-${key}">
                ${renderGrupos(key, lugar.grupos || {})}
              </div>
              <button class="btn-add-inline" onclick="abrirModalGrupo('${key}')">
                ‚ûï A√±adir grupo
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderGrupos(lugarKey, grupos) {
      const gruposKeys = Object.keys(grupos);
      if (gruposKeys.length === 0) {
        return '<p style="color: var(--text-muted); font-size: 0.85rem; padding: 10px;">Sin grupos. A√±ade uno para empezar.</p>';
      }

      return gruposKeys.map(gk => {
        const grupo = grupos[gk];
        const articulos = grupo.articulos || [];

        return `
          <div class="grupo-card" id="grupo-${lugarKey}-${gk}">
            <div class="grupo-header" onclick="toggleGrupo('${lugarKey}', '${gk}')">
              <div class="grupo-nombre">
                üìÅ ${grupo.nombre}
                <span style="color: var(--text-muted); font-weight: normal;">(${articulos.length})</span>
              </div>
              <div style="display: flex; gap: 4px;">
                <button onclick="event.stopPropagation(); eliminarGrupo('${lugarKey}', '${gk}')" style="background:none;border:none;cursor:pointer;opacity:0.5;">üóëÔ∏è</button>
                <span class="grupo-chevron" style="transition: transform 0.2s;">‚ñº</span>
              </div>
            </div>
            <div class="grupo-body">
              <table class="articulos-table">
                <thead>
                  <tr>
                    <th>Art√≠culo</th>
                    <th>Formato</th>
                    <th>Uds. m√≠n.</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="articulos-${lugarKey}-${gk}">
                  ${renderArticulos(lugarKey, gk, articulos)}
                </tbody>
              </table>
              <button class="btn-add-inline" onclick="agregarArticulo('${lugarKey}', '${gk}')">
                ‚ûï A√±adir art√≠culo
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderArticulos(lugarKey, grupoKey, articulos) {
      if (articulos.length === 0) {
        return '<tr><td colspan="4" style="color: var(--text-muted); text-align: center;">Sin art√≠culos</td></tr>';
      }

      return articulos.map((art, idx) => `
        <tr>
          <td>
            <input type="text" value="${art.nombre || ''}" 
              onchange="actualizarArticulo('${lugarKey}', '${grupoKey}', ${idx}, 'nombre', this.value)" 
              placeholder="Nombre">
          </td>
          <td>
            <input type="text" value="${art.formato || ''}" 
              onchange="actualizarArticulo('${lugarKey}', '${grupoKey}', ${idx}, 'formato', this.value)" 
              placeholder="500ml, 1kg...">
          </td>
          <td>
            <input type="number" value="${art.minimo || 0}" min="0"
              onchange="actualizarArticulo('${lugarKey}', '${grupoKey}', ${idx}, 'minimo', parseInt(this.value))">
          </td>
          <td>
            <button class="btn-delete-art" onclick="eliminarArticulo('${lugarKey}', '${grupoKey}', ${idx})">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    // ========== INTERACCIONES CONFIGURACI√ìN ==========
    function toggleLugar(key) {
      const card = document.getElementById(`lugar-${key}`);
      card.classList.toggle('expanded');
    }

    function toggleGrupo(lugarKey, grupoKey) {
      const card = document.getElementById(`grupo-${lugarKey}-${grupoKey}`);
      card.classList.toggle('expanded');
    }

    function abrirModalLugar(key = null) {
      editandoLugarKey = key;
      
      if (key && inventario[key]) {
        document.getElementById('modal-lugar-titulo').textContent = '‚úèÔ∏è Editar lugar';
        document.getElementById('lugar-nombre').value = inventario[key].nombre;
        // Seleccionar icono
        document.querySelectorAll('#iconos-lugar .icon-option').forEach(btn => {
          btn.classList.toggle('selected', btn.dataset.icon === inventario[key].icono);
        });
      } else {
        document.getElementById('modal-lugar-titulo').textContent = 'üìç Nuevo lugar';
        document.getElementById('lugar-nombre').value = '';
        document.querySelectorAll('#iconos-lugar .icon-option').forEach((btn, i) => {
          btn.classList.toggle('selected', i === 0);
        });
      }

      document.getElementById('modal-lugar').classList.add('active');
    }

    function guardarLugar() {
      const nombre = document.getElementById('lugar-nombre').value.trim();
      if (!nombre) {
        alert('El nombre es obligatorio');
        return;
      }

      const icono = document.querySelector('#iconos-lugar .icon-option.selected')?.dataset.icon || 'üìç';
      
      if (editandoLugarKey) {
        inventario[editandoLugarKey].nombre = nombre;
        inventario[editandoLugarKey].icono = icono;
      } else {
        const key = nombre.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        if (inventario[key]) {
          alert('Ya existe un lugar con ese nombre');
          return;
        }
        inventario[key] = { nombre, icono, grupos: {} };
      }

      cerrarModales();
      renderLugares();
      renderTomaLugares();
    }

    function editarLugar(key) {
      abrirModalLugar(key);
    }

    function eliminarLugar(key) {
      if (!confirm(`¬øEliminar "${inventario[key].nombre}" y todo su contenido?`)) return;
      delete inventario[key];
      renderLugares();
      renderTomaLugares();
    }

    function abrirModalGrupo(lugarKey) {
      lugarActual = lugarKey;
      document.getElementById('grupo-nombre').value = '';
      document.getElementById('modal-grupo').classList.add('active');
    }

    function guardarGrupo() {
      const nombre = document.getElementById('grupo-nombre').value.trim();
      if (!nombre || !lugarActual) {
        alert('El nombre es obligatorio');
        return;
      }

      const key = nombre.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      
      if (!inventario[lugarActual].grupos) {
        inventario[lugarActual].grupos = {};
      }
      
      if (inventario[lugarActual].grupos[key]) {
        alert('Ya existe un grupo con ese nombre');
        return;
      }

      inventario[lugarActual].grupos[key] = { nombre, articulos: [] };
      
      cerrarModales();
      renderLugares();
      
      // Expandir el lugar y grupo
      document.getElementById(`lugar-${lugarActual}`).classList.add('expanded');
      setTimeout(() => {
        document.getElementById(`grupo-${lugarActual}-${key}`)?.classList.add('expanded');
      }, 100);
    }

    function eliminarGrupo(lugarKey, grupoKey) {
      const grupo = inventario[lugarKey].grupos[grupoKey];
      if (!confirm(`¬øEliminar "${grupo.nombre}" y todos sus art√≠culos?`)) return;
      delete inventario[lugarKey].grupos[grupoKey];
      renderLugares();
    }

    function agregarArticulo(lugarKey, grupoKey) {
      if (!inventario[lugarKey].grupos[grupoKey].articulos) {
        inventario[lugarKey].grupos[grupoKey].articulos = [];
      }
      inventario[lugarKey].grupos[grupoKey].articulos.push({
        nombre: '',
        formato: '',
        minimo: 0,
        actual: null
      });
      renderLugares();
      
      // Mantener expandidos
      document.getElementById(`lugar-${lugarKey}`).classList.add('expanded');
      document.getElementById(`grupo-${lugarKey}-${grupoKey}`).classList.add('expanded');
    }

    function actualizarArticulo(lugarKey, grupoKey, idx, campo, valor) {
      inventario[lugarKey].grupos[grupoKey].articulos[idx][campo] = valor;
    }

    function eliminarArticulo(lugarKey, grupoKey, idx) {
      inventario[lugarKey].grupos[grupoKey].articulos.splice(idx, 1);
      renderLugares();
      
      // Mantener expandidos
      document.getElementById(`lugar-${lugarKey}`).classList.add('expanded');
      document.getElementById(`grupo-${lugarKey}-${grupoKey}`).classList.add('expanded');
    }

    // ========== TOMA DE INVENTARIO ==========
    function renderTomaLugares() {
      const container = document.getElementById('toma-lugares');
      const lugaresKeys = Object.keys(inventario);

      if (lugaresKeys.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = lugaresKeys.map((key, idx) => {
        const lugar = inventario[key];
        const isActive = idx === 0 && !tomaLugarActual;
        if (isActive) tomaLugarActual = key;
        
        return `
          <button class="toma-lugar-btn ${key === tomaLugarActual ? 'active' : ''}" 
            onclick="seleccionarTomaLugar('${key}')">
            ${lugar.icono || 'üìç'} ${lugar.nombre}
          </button>
        `;
      }).join('');
    }

    function seleccionarTomaLugar(key) {
      tomaLugarActual = key;
      document.querySelectorAll('.toma-lugar-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      renderTomaContenido();
    }

    function renderTomaContenido() {
      const container = document.getElementById('toma-contenido');
      
      if (!tomaLugarActual || !inventario[tomaLugarActual]) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <div class="empty-title">Sin inventario</div>
            <div class="empty-text">Primero configura los lugares y art√≠culos en la pesta√±a "Configurar"</div>
          </div>
        `;
        return;
      }

      const lugar = inventario[tomaLugarActual];
      const grupos = lugar.grupos || {};
      const gruposKeys = Object.keys(grupos);

      if (gruposKeys.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìÅ</div>
            <div class="empty-title">Sin grupos</div>
            <div class="empty-text">A√±ade grupos y art√≠culos a este lugar</div>
          </div>
        `;
        return;
      }

      container.innerHTML = gruposKeys.map(gk => {
        const grupo = grupos[gk];
        const articulos = grupo.articulos || [];

        if (articulos.length === 0) return '';

        return `
          <div class="toma-grupo">
            <div class="toma-grupo-header">
              üìÅ ${grupo.nombre}
            </div>
            ${articulos.map((art, idx) => {
              const actual = art.actual;
              const minimo = art.minimo || 0;
              let statusClass = 'pending';
              let statusIcon = '‚óã';
              let inputClass = '';
              
              if (actual !== null && actual !== undefined && actual !== '') {
                if (actual >= minimo) {
                  statusClass = 'ok';
                  statusIcon = '‚úì';
                  inputClass = 'ok';
                } else if (actual > 0) {
                  statusClass = 'bajo';
                  statusIcon = '‚ö†';
                  inputClass = 'bajo-minimo';
                } else {
                  statusClass = 'vacio';
                  statusIcon = '‚úó';
                  inputClass = 'bajo-minimo';
                }
              }

              return `
                <div class="toma-articulo">
                  <div class="toma-art-info">
                    <div class="toma-art-nombre">${art.nombre || 'Sin nombre'}</div>
                    <div style="display: flex; gap: 6px; align-items: center; margin-top: 2px;">
                      ${art.formato ? `<span class="toma-art-formato">${art.formato}</span>` : ''}
                      <span class="toma-art-minimo">M√≠n: ${minimo}</span>
                    </div>
                  </div>
                  <div class="toma-art-input">
                    <input type="number" class="toma-input ${inputClass}" 
                      value="${actual !== null && actual !== undefined ? actual : ''}"
                      min="0" 
                      placeholder="‚Äî"
                      onchange="actualizarConteo('${tomaLugarActual}', '${gk}', ${idx}, this.value)"
                      onfocus="this.select()">
                    <div class="toma-status ${statusClass}">${statusIcon}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }).join('');

      actualizarEstadisticasToma();
    }

    function actualizarConteo(lugarKey, grupoKey, idx, valor) {
      const numVal = valor === '' ? null : parseInt(valor);
      inventario[lugarKey].grupos[grupoKey].articulos[idx].actual = numVal;
      renderTomaContenido();
    }

    function actualizarEstadisticasToma() {
      let ok = 0, bajo = 0, pendiente = 0, total = 0;

      Object.values(inventario).forEach(lugar => {
        Object.values(lugar.grupos || {}).forEach(grupo => {
          (grupo.articulos || []).forEach(art => {
            total++;
            const actual = art.actual;
            const minimo = art.minimo || 0;

            if (actual === null || actual === undefined || actual === '') {
              pendiente++;
            } else if (actual >= minimo) {
              ok++;
            } else {
              bajo++;
            }
          });
        });
      });

      document.getElementById('stat-ok').textContent = ok;
      document.getElementById('stat-bajo').textContent = bajo;
      document.getElementById('stat-pendiente').textContent = pendiente;

      // Progress
      const completados = total - pendiente;
      const pct = total > 0 ? Math.round((completados / total) * 100) : 0;
      document.getElementById('progress-fill').style.width = pct + '%';
      document.getElementById('progress-text').textContent = pct + '%';
    }

    function finalizarToma() {
      const estadoPendiente = parseInt(document.getElementById('stat-pendiente').textContent);
      
      if (estadoPendiente > 0) {
        if (!confirm(`Hay ${estadoPendiente} art√≠culos sin contar. ¬øFinalizar de todos modos?`)) {
          return;
        }
      }

      guardarTodo(true);
    }

    // ========== GUARDAR ==========
    async function guardarTodo(esToma = false) {
      const btn = document.getElementById('btn-guardar');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Guardando...';

      try {
        // Limpiar art√≠culos vac√≠os
        Object.keys(inventario).forEach(lk => {
          Object.keys(inventario[lk].grupos || {}).forEach(gk => {
            inventario[lk].grupos[gk].articulos = (inventario[lk].grupos[gk].articulos || [])
              .filter(a => a.nombre && a.nombre.trim());
          });
        });

        const updateData = {
          inventario: inventario,
          inventarioActualizado: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (esToma) {
          updateData.ultimaToma = firebase.firestore.FieldValue.serverTimestamp();
        }

        await db.collection('bienes').doc(bienId).update(updateData);

        if (esToma) {
          alert('‚úÖ Toma de inventario guardada');
          document.getElementById('ultima-toma').textContent = 'Ahora';
        } else {
          // Feedback visual breve
          btn.innerHTML = '‚úì Guardado';
          setTimeout(() => {
            btn.innerHTML = 'üíæ Guardar';
          }, 1500);
        }

      } catch (error) {
        console.error('Error guardando:', error);
        alert('Error al guardar: ' + error.message);
      }

      btn.disabled = false;
      if (!esToma) btn.innerHTML = 'üíæ Guardar';
    }

    // ========== MODALES ==========
    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
      editandoLugarKey = null;
      lugarActual = null;
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) cerrarModales();
      });
    });

    // Enter para guardar en modales
    document.getElementById('lugar-nombre').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); guardarLugar(); }
    });

    document.getElementById('grupo-nombre').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); guardarGrupo(); }
    });
  </script>
</body>
</html>
