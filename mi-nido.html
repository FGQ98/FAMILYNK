<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Mi Nido</title>
  <!-- PWA & Icons -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7A9E7E">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="FAMILYNK">
  <link rel="apple-touch-icon" href="img/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="img/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="img/icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --separado: #DAA520;
      --divorciado: #800020;
      --comprometido: #2E8B57;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header {
      background: var(--white);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: var(--cream-dark); color: var(--text); }

    .header-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .main { max-width: 900px; margin: 0 auto; padding: 24px; }

    .page-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
    }

    .nido-icon {
      width: 70px;
      height: 70px;
      background: var(--terracotta-muted);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .page-info { flex: 1; }
    .page-title { font-family: 'Quicksand', sans-serif; font-size: 1.5rem; font-weight: 700; }
    .page-subtitle { color: var(--text-muted); font-size: 0.9rem; }

    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body { padding: 20px; }

    /* Miembros */
    .miembros-list { display: flex; flex-direction: column; gap: 10px; }

    .miembro-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--cream);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .miembro-row:hover { background: var(--cream-dark); }
    .miembro-row.es-yo { border-left: 4px solid var(--sage); }

    .miembro-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-light) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .miembro-info { flex: 1; min-width: 0; }
    .miembro-nombre { font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .miembro-meta { font-size: 0.8rem; color: var(--text-muted); }

    .miembro-badge {
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    .miembro-badge.admin { background: var(--terracotta-muted); color: var(--terracotta); }
    .miembro-badge.yo { background: var(--sage-muted); color: var(--sage-dark); }

    .miembro-relacion {
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .miembro-relacion.progenitor { background: var(--terracotta-muted); color: var(--terracotta); }
    .miembro-relacion.descendiente { background: var(--sage-muted); color: var(--sage-dark); }
    .miembro-relacion.ascendiente { background: #E8E4F0; color: #6B5B95; }
    .miembro-relacion.colateral { background: #FFF3E0; color: #E65100; }

    /* Estados de cuenta */
    .miembro-invitado .miembro-nombre { color: #9A9A9A; }
    .miembro-invitado .miembro-avatar { 
      background: linear-gradient(135deg, #9A9A9A 0%, #B8B8B8 100%); 
    }
    .miembro-fallecido { opacity: 0.5; }
    .miembro-badge.pendiente { background: #FFF3E0; color: #E65100; }
    .miembro-badge.validar { background: #E3F2FD; color: #1565C0; }

    /* Estados vinculares */
    .miembro-separado .miembro-avatar { 
      background: linear-gradient(135deg, var(--separado) 0%, #F4C430 100%);
      box-shadow: 0 0 0 3px rgba(218, 165, 32, 0.3);
    }
    .miembro-divorciado .miembro-avatar { 
      background: linear-gradient(135deg, var(--divorciado) 0%, #A52A2A 100%);
      box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.3);
    }
    .miembro-comprometido .miembro-avatar { 
      background: linear-gradient(135deg, var(--comprometido) 0%, #3CB371 100%);
      box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.3);
    }
    .miembro-badge.separado {
      background: var(--separado);
      color: white;
      font-size: 0.6rem;
    }
    .miembro-badge.divorciado {
      background: var(--divorciado);
      color: white;
      font-size: 0.6rem;
    }
    .miembro-badge.comprometido {
      background: var(--comprometido);
      color: white;
      font-size: 0.6rem;
    }

    /* Botones */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-sage { background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%); color: white; }
    .btn-sage:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }
    .btn-secondary { background: var(--cream); color: var(--text); border: 1px solid var(--cream-dark); }
    .btn-secondary:hover { background: var(--cream-dark); }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

    /* Casas */
    .casas-list { display: flex; flex-direction: column; gap: 10px; }

    .casa-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }

    .casa-icon { font-size: 1.5rem; }
    .casa-info { flex: 1; }
    .casa-nombre { font-weight: 600; }
    .casa-tipo { font-size: 0.8rem; color: var(--text-muted); }

    /* Loading & Empty */
    .loading, .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-state-icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-state-title { font-weight: 700; font-size: 1.1rem; color: var(--text); margin-bottom: 4px; }

    .hidden { display: none !important; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 20px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-float);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title { font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 700; }

    .modal-close {
      width: 32px; height: 32px;
      border: none;
      background: var(--cream);
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text-muted);
    }

    .modal-close:hover { background: var(--cream-dark); }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--cream-dark); display: flex; justify-content: flex-end; gap: 12px; }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-light); }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
    }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--sage); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .info-box {
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      font-size: 0.85rem;
      color: var(--sage-dark);
      margin-bottom: 16px;
    }

    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
      .page-header { flex-direction: column; text-align: center; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="cgi.html" class="back-btn">‚Üê Volver</a>
      <div class="header-title">ü™∫ Mi Nido</div>
    </div>
    <a href="#" class="btn btn-sage btn-sm hidden" id="btn-gestionar-nido">‚úèÔ∏è Gestionar</a>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Loading -->
    <div class="loading" id="loading">
      <p>Cargando...</p>
    </div>

    <!-- Content -->
    <div id="content" class="hidden">
      <!-- Header del nido -->
      <div class="page-header">
        <div class="nido-icon">ü™∫</div>
        <div class="page-info">
          <div class="page-title" id="nido-nombre">Mi Nido</div>
          <div class="page-subtitle" id="nido-desc">Cargando...</div>
        </div>
      </div>

      <!-- Miembros -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üë• Miembros</div>
          <a href="#" class="btn btn-sage btn-sm hidden" id="btn-a√±adir-miembro">+ A√±adir</a>
        </div>
        <div class="card-body">
          <div class="miembros-list" id="miembros-list">
            <p style="color:var(--text-muted);">Sin miembros</p>
          </div>
        </div>
      </div>

      <!-- Viviendas -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üè† Viviendas</div>
        </div>
        <div class="card-body">
          <div class="casas-list" id="casas-list">
            <p style="color:var(--text-muted);">Sin viviendas</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Sin nido -->
    <div id="sin-nido" class="hidden">
      <div class="empty-state">
        <div class="empty-state-icon">ü™∫</div>
        <div class="empty-state-title">Sin nido asignado</div>
        <p>El administrador de tu rama familiar te a√±adir√° a un nido</p>
      </div>
    </div>
  </main>

  <!-- Modal: Editar mi perfil -->
  <div class="modal-overlay" id="modal-perfil">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Mi perfil</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-perfil" onsubmit="guardarPerfil(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Iniciales</label>
              <input type="text" class="form-input" id="perfil-iniciales" maxlength="3" required>
            </div>
            <div class="form-group">
              <label class="form-label">Fecha nacimiento</label>
              <input type="date" class="form-input" id="perfil-nacimiento">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Nombre completo</label>
            <input type="text" class="form-input" id="perfil-nombre" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="perfil-email" disabled>
          </div>
          <div class="form-group" id="grupo-perfil-boda" style="display:none;">
            <label class="form-label">üíí Fecha de enlace/boda</label>
            <input type="date" class="form-input" id="perfil-fechaBoda">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-sage">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Nuevo miembro (nacimiento/adopci√≥n) -->
  <div class="modal-overlay" id="modal-nuevo-miembro">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üë∂ A√±adir miembro</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-nuevo-miembro" onsubmit="guardarNuevoMiembro(event)">
        <div class="modal-body">
          <div class="info-box">
            ‚ÑπÔ∏è A√±ade nuevos miembros al nido: nacimientos, adopciones o acogidas.
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Iniciales</label>
              <input type="text" class="form-input" id="nuevo-iniciales" maxlength="3" placeholder="ABC" required>
            </div>
            <div class="form-group">
              <label class="form-label">Fecha nacimiento</label>
              <input type="date" class="form-input" id="nuevo-nacimiento">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Nombre completo</label>
            <input type="text" class="form-input" id="nuevo-nombre" placeholder="Nombre y apellidos" required>
          </div>
          <div class="form-group">
            <label class="form-label">Relaci√≥n</label>
            <select class="form-select" id="nuevo-relacion">
              <option value="descendiente">üë∂ Descendiente (hijo/a)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-sage">A√±adir</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Admin editar fechas de un miembro -->
  <div class="modal-overlay" id="modal-admin-fechas">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üìù Editar fechas</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-admin-fechas" onsubmit="guardarAdminFechas(event)">
        <div class="modal-body">
          <div class="info-box">
            ‚ÑπÔ∏è Editando fechas de: <strong id="admin-fechas-nombre">‚Äî</strong>
          </div>
          <input type="hidden" id="admin-fechas-idx">
          <div class="form-group" id="grupo-admin-boda" style="display:none;">
            <label class="form-label">üíí Fecha de enlace/boda</label>
            <input type="date" class="form-input" id="admin-fechaBoda">
          </div>
          <div class="form-group">
            <label class="form-label">üïØÔ∏è Fecha de defunci√≥n</label>
            <input type="date" class="form-input" id="admin-fechaDefuncion">
            <span style="font-size:0.72rem; color:var(--text-muted);">Dejar vac√≠o si no aplica</span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-sage">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/eventos-tracker.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let userData = null;
    let nidoData = null;
    let miIndexEnNido = -1; // √çndice del usuario actual en miembrosData
    let esAdminNido = false; // Si el usuario actual es admin del nido

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;

      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists) { window.location.href = 'registro.html'; return; }
      userData = userDoc.data();

      await buscarMiNido();
      
      // Registrar visita a la secci√≥n
      track.consultar('nido');
    });

    // ============================================
    // L√ìGICA MEJORADA PARA ENCONTRAR EL NIDO
    // ============================================
    async function buscarMiNido() {
      try {
        let nidoDoc = null;
        let nidoId = userData.nidoId;

        // PASO 1: Intentar con nidoId directo
        if (nidoId) {
          const doc = await db.collection('nidos').doc(nidoId).get();
          if (doc.exists) {
            nidoDoc = doc;
            console.log('‚úÖ Nido encontrado por nidoId directo');
          }
        }

        // PASO 2: Buscar en nidos de la familia por email/uid
        if (!nidoDoc && userData.familiaId) {
          const nidosSnap = await db.collection('nidos')
            .where('familiaId', '==', userData.familiaId)
            .get();
          
          const userEmail = currentUser.email?.toLowerCase();
          const userId = currentUser.uid;

          for (const doc of nidosSnap.docs) {
            const nido = doc.data();
            const miembros = nido.miembrosData || [];

            // Buscar por email (normalizado) o por uid
            const miIndex = miembros.findIndex(m => 
              (m.email && m.email.toLowerCase() === userEmail) || 
              m.uid === userId
            );

            if (miIndex !== -1) {
              nidoDoc = doc;
              nidoId = doc.id;
              miIndexEnNido = miIndex;
              console.log('‚úÖ Nido encontrado por email/uid en miembrosData:', nido.nombre);
              
              // IMPORTANTE: Sincronizar nidoId en el usuario si no lo ten√≠a
              if (!userData.nidoId || userData.nidoId !== nidoId) {
                await db.collection('usuarios').doc(currentUser.uid).update({ nidoId });
                userData.nidoId = nidoId;
                console.log('‚úÖ nidoId sincronizado en usuario');
              }

              // Sincronizar uid en miembrosData si no lo ten√≠a
              if (!miembros[miIndex].uid) {
                miembros[miIndex].uid = userId;
                await db.collection('nidos').doc(nidoId).update({ miembrosData: miembros });
                console.log('‚úÖ uid sincronizado en miembrosData');
              }

              break;
            }
          }

          // PASO 3: Buscar donde sea admin
          if (!nidoDoc) {
            for (const doc of nidosSnap.docs) {
              const nido = doc.data();
              if (nido.admins?.includes(userId)) {
                nidoDoc = doc;
                nidoId = doc.id;
                console.log('‚úÖ Nido encontrado por admins');
                
                // Sincronizar
                if (!userData.nidoId) {
                  await db.collection('usuarios').doc(currentUser.uid).update({ nidoId });
                }
                break;
              }
            }
          }
        }

        // Mostrar resultado
        document.getElementById('loading').classList.add('hidden');

        if (!nidoDoc) {
          document.getElementById('sin-nido').classList.remove('hidden');
          return;
        }

        nidoData = { id: nidoDoc.id, ...nidoDoc.data() };
        
        // Buscar mi √≠ndice si no lo ten√≠amos
        if (miIndexEnNido === -1) {
          const userEmail = currentUser.email?.toLowerCase();
          const miembros = nidoData.miembrosData || [];
          miIndexEnNido = miembros.findIndex(m => 
            (m.email && m.email.toLowerCase() === userEmail) || 
            m.uid === currentUser.uid
          );
        }

        // Mostrar bot√≥n gestionar si es admin
        const esAdmin = (nidoData.admins || []).includes(currentUser.uid) || 
                        (nidoData.miembrosData || []).some(m => m.uid === currentUser.uid && m.esAdmin);
        esAdminNido = esAdmin;
        if (esAdmin) {
          const btnGestionar = document.getElementById('btn-gestionar-nido');
          btnGestionar.href = `nido.html?id=${nidoData.id}`;
          btnGestionar.classList.remove('hidden');
          
          const btnA√±adir = document.getElementById('btn-a√±adir-miembro');
          btnA√±adir.href = `nido.html?id=${nidoData.id}`;
          btnA√±adir.classList.remove('hidden');
        }

        document.getElementById('content').classList.remove('hidden');
        renderNido();
        renderCasas();

      } catch (error) {
        console.error('Error buscando nido:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('sin-nido').classList.remove('hidden');
      }
    }

    // ============================================
    // RENDER
    // ============================================
    function renderNido() {
      const genLabels = {
        '1-bisabuelos': 'Generaci√≥n 1 ‚Äî Bisabuelos',
        '2-abuelos': 'Generaci√≥n 2 ‚Äî Abuelos',
        '3-padres': 'Generaci√≥n 3 ‚Äî Padres',
        '4-hijos': 'Generaci√≥n 4 ‚Äî Hijos'
      };

      document.getElementById('nido-nombre').textContent = nidoData.nombre || 'Mi Nido';
      document.getElementById('nido-desc').textContent = genLabels[nidoData.generacion] || '';

      const miembros = nidoData.miembrosData || [];
      const list = document.getElementById('miembros-list');
      
      if (miembros.length === 0) {
        list.innerHTML = '<p style="color:var(--text-muted);">Sin miembros</p>';
        return;
      }

      const relacionLabels = {
        'progenitor': 'Progenitor',
        'descendiente': 'Hijo/a',
        'ascendiente': 'Ascendiente',
        'colateral': 'Colateral',
        'hijo': 'Hijo/a'
      };

      list.innerHTML = miembros.map((m, idx) => {
        const esYo = idx === miIndexEnNido;
        let relacion = m.relacion || m.rol || 'otros';
        if (relacion === 'hijo') relacion = 'descendiente';
        const edad = m.fechaNacimiento ? calcularEdad(m.fechaNacimiento) : '';
        
        // Estados de cuenta (seg√∫n racional usuarios FAMILYNK)
        const tieneEmail = m.email ? true : false;
        const tieneUid = m.uid ? true : false;
        const cuentaActiva = m.estadoCuenta === 'activo';
        
        // Determinar estado de invitaci√≥n
        let estadoInvitacion = 'sin-email';
        if (tieneEmail && !tieneUid) {
          estadoInvitacion = 'pendiente'; // Invitado pero nunca acept√≥
        } else if (tieneEmail && tieneUid && !cuentaActiva) {
          estadoInvitacion = 'validar'; // Acept√≥ pero no ha validado contrase√±a
        } else if (tieneEmail && tieneUid && cuentaActiva) {
          estadoInvitacion = 'activo';
        }
        
        const esInvitado = estadoInvitacion === 'pendiente' || estadoInvitacion === 'validar';
        
        // Determinar estado visual (prioridad: fallecido > vincular > invitado)
        const esFallecido = m.fechaDefuncion ? true : false;
        const esComprometido = m.estadoVincular === 'comprometido';
        const esSeparado = m.estadoVincular === 'separado';
        const esDivorciado = m.estadoVincular === 'divorciado';
        
        let estadoClase = '';
        if (esFallecido) estadoClase = 'miembro-fallecido';
        else if (esDivorciado) estadoClase = 'miembro-divorciado';
        else if (esSeparado) estadoClase = 'miembro-separado';
        else if (esComprometido) estadoClase = 'miembro-comprometido';
        else if (esInvitado) estadoClase = 'miembro-invitado';

        // Badge de estado vincular
        let badgeVincular = '';
        if (esComprometido) badgeVincular = '<span class="miembro-badge comprometido">Comprometido</span>';
        else if (esSeparado) badgeVincular = '<span class="miembro-badge separado">Separado</span>';
        else if (esDivorciado) badgeVincular = '<span class="miembro-badge divorciado">Divorciado</span>';

        // Badge de estado de cuenta/invitaci√≥n
        let badgeInvitacion = '';
        if (estadoInvitacion === 'pendiente') {
          badgeInvitacion = '<span class="miembro-badge pendiente" title="Invitado pero no ha aceptado">üì© Pendiente</span>';
        } else if (estadoInvitacion === 'validar') {
          badgeInvitacion = '<span class="miembro-badge validar" title="Ha aceptado pero no ha validado contrase√±a">üîë Validar</span>';
        }

        // Meta info (edad + fechas si existen)
        let metaItems = [];
        if (edad) metaItems.push(edad);
        if (m.fechaBoda) metaItems.push(`üíí ${new Date(m.fechaBoda).toLocaleDateString('es-ES', {day:'numeric',month:'short',year:'numeric'})}`);
        if (m.fechaDefuncion) metaItems.push(`üïØÔ∏è ${new Date(m.fechaDefuncion).toLocaleDateString('es-ES', {day:'numeric',month:'short',year:'numeric'})}`);
        const metaText = metaItems.join(' ¬∑ ');

        return `
          <div class="miembro-row ${esYo ? 'es-yo' : ''} ${estadoClase}" 
               onclick="${esYo ? 'editarMiPerfil()' : (esAdminNido ? `abrirAdminFechas(${idx})` : '')}"
               style="${!esYo && esAdminNido ? 'cursor:pointer;' : ''}">
            <div class="miembro-avatar">${m.iniciales || '?'}</div>
            <div class="miembro-info">
              <div class="miembro-nombre">
                ${m.nombre || 'Sin nombre'}
                ${esYo ? '<span class="miembro-badge yo">T√∫</span>' : ''}
                ${m.esAdmin ? '<span class="miembro-badge admin">Admin</span>' : ''}
                ${badgeVincular}
                ${badgeInvitacion}
              </div>
              <div class="miembro-meta">${metaText}</div>
            </div>
            <span class="miembro-relacion ${relacion}">${relacionLabels[relacion] || 'Otro'}</span>
          </div>
        `;
      }).join('');
    }

    function calcularEdad(fecha) {
      if (!fecha) return '';
      const hoy = new Date();
      const nac = new Date(fecha);
      let edad = hoy.getFullYear() - nac.getFullYear();
      const m = hoy.getMonth() - nac.getMonth();
      if (m < 0 || (m === 0 && hoy.getDate() < nac.getDate())) edad--;
      return `${edad} a√±os`;
    }

    function renderCasas() {
      const casas = nidoData.casas || [];
      const container = document.getElementById('casas-list');
      
      if (casas.length === 0) {
        container.innerHTML = '<p style="color:var(--text-muted);">Sin viviendas registradas</p>';
        return;
      }

      const tipoIconos = { principal: 'üè†', segunda: 'üè°', otra: 'üè¢' };
      const tipoLabels = { principal: 'Principal', segunda: '2¬™ Vivienda', otra: 'Otra' };

      container.innerHTML = casas.map(casa => `
        <div class="casa-item">
          <div class="casa-icon">${tipoIconos[casa.tipo] || 'üè†'}</div>
          <div class="casa-info">
            <div class="casa-nombre">${casa.nombre || 'Sin nombre'}</div>
            <div class="casa-tipo">${tipoLabels[casa.tipo] || 'Otra'}${casa.direccion ? ' ¬∑ ' + casa.direccion : ''}</div>
          </div>
        </div>
      `).join('');
    }

    // ============================================
    // EDITAR MI PERFIL
    // ============================================
    function editarMiPerfil() {
      if (miIndexEnNido === -1) return;
      
      const miembro = nidoData.miembrosData[miIndexEnNido];
      document.getElementById('perfil-iniciales').value = miembro.iniciales || '';
      document.getElementById('perfil-nombre').value = miembro.nombre || '';
      document.getElementById('perfil-nacimiento').value = miembro.fechaNacimiento || '';
      document.getElementById('perfil-email').value = miembro.email || currentUser.email || '';
      
      // Mostrar campo boda solo si es consorte con v√≠nculo
      const vincular = miembro.estadoVincular || '';
      const mostrarBoda = ['matrimonio', 'de-hecho', 'separado', 'divorciado'].includes(vincular);
      document.getElementById('grupo-perfil-boda').style.display = mostrarBoda ? '' : 'none';
      document.getElementById('perfil-fechaBoda').value = miembro.fechaBoda || '';
      
      document.getElementById('modal-perfil').classList.add('active');
    }

    async function guardarPerfil(e) {
      e.preventDefault();
      if (miIndexEnNido === -1) return;

      const miembros = nidoData.miembrosData;
      miembros[miIndexEnNido].iniciales = document.getElementById('perfil-iniciales').value.trim().toUpperCase();
      miembros[miIndexEnNido].nombre = document.getElementById('perfil-nombre').value.trim();
      miembros[miIndexEnNido].fechaNacimiento = document.getElementById('perfil-nacimiento').value || null;
      
      // Guardar fechaBoda si el campo est√° visible
      if (document.getElementById('grupo-perfil-boda').style.display !== 'none') {
        miembros[miIndexEnNido].fechaBoda = document.getElementById('perfil-fechaBoda').value || null;
      }

      try {
        await db.collection('nidos').doc(nidoData.id).update({ miembrosData: miembros });
        nidoData.miembrosData = miembros;
        cerrarModales();
        renderNido();
        alert('‚úÖ Perfil actualizado');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar');
      }
    }

    // ============================================
    // A√ëADIR NUEVO MIEMBRO (nacimiento/adopci√≥n)
    // ============================================
    function abrirModalNuevoMiembro() {
      document.getElementById('form-nuevo-miembro').reset();
      document.getElementById('modal-nuevo-miembro').classList.add('active');
    }

    async function guardarNuevoMiembro(e) {
      e.preventDefault();

      const nuevoMiembro = {
        iniciales: document.getElementById('nuevo-iniciales').value.trim().toUpperCase(),
        nombre: document.getElementById('nuevo-nombre').value.trim(),
        fechaNacimiento: document.getElementById('nuevo-nacimiento').value || null,
        relacion: document.getElementById('nuevo-relacion').value,
        esAdmin: false,
        email: null,
        uid: null,
        fechaCreacion: new Date().toISOString(),
        creadoPor: currentUser.uid
      };

      if (!nuevoMiembro.iniciales || !nuevoMiembro.nombre) {
        alert('Iniciales y nombre son obligatorios');
        return;
      }

      try {
        const miembros = nidoData.miembrosData || [];
        miembros.push(nuevoMiembro);
        
        await db.collection('nidos').doc(nidoData.id).update({ miembrosData: miembros });
        nidoData.miembrosData = miembros;
        
        cerrarModales();
        renderNido();
        alert('‚úÖ Miembro a√±adido');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al a√±adir miembro');
      }
    }

    // ============================================
    // ADMIN: EDITAR FECHAS DE OTRO MIEMBRO
    // ============================================
    function abrirAdminFechas(idx) {
      if (!esAdminNido) return;
      const miembro = nidoData.miembrosData[idx];
      if (!miembro) return;

      document.getElementById('admin-fechas-nombre').textContent = miembro.nombre || 'Sin nombre';
      document.getElementById('admin-fechas-idx').value = idx;
      document.getElementById('admin-fechaBoda').value = miembro.fechaBoda || '';
      document.getElementById('admin-fechaDefuncion').value = miembro.fechaDefuncion || '';

      // Mostrar campo boda solo si tiene estado vincular de pareja
      const vincular = miembro.estadoVincular || '';
      const mostrarBoda = ['matrimonio', 'de-hecho', 'separado', 'divorciado'].includes(vincular);
      document.getElementById('grupo-admin-boda').style.display = mostrarBoda ? '' : 'none';

      document.getElementById('modal-admin-fechas').classList.add('active');
    }

    async function guardarAdminFechas(e) {
      e.preventDefault();
      const idx = parseInt(document.getElementById('admin-fechas-idx').value);
      if (isNaN(idx)) return;

      const miembros = nidoData.miembrosData;
      
      // Solo guardar fechaBoda si el campo est√° visible
      if (document.getElementById('grupo-admin-boda').style.display !== 'none') {
        miembros[idx].fechaBoda = document.getElementById('admin-fechaBoda').value || null;
      }
      miembros[idx].fechaDefuncion = document.getElementById('admin-fechaDefuncion').value || null;

      try {
        await db.collection('nidos').doc(nidoData.id).update({ miembrosData: miembros });
        nidoData.miembrosData = miembros;
        cerrarModales();
        renderNido();
        alert('‚úÖ Fechas actualizadas');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar');
      }
    }

    // ============================================
    // UTILIDADES
    // ============================================
    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) cerrarModales();
      });
    });
  </script>
</body>
</html>
