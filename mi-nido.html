<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Mi Nido</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header {
      background: var(--white);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 32px; }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
    }

    .logo-icon {
      height: 2.6rem;
      width: auto;
      filter: hue-rotate(20deg) saturate(0.65) brightness(1.1); /* Ajustar al sage */
    }

    .logo-text {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--sage-dark);
    }

    .header-nav { display: flex; gap: 4px; }
    .nav-link {
      padding: 8px 14px;
      border-radius: var(--radius-md);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-light);
      transition: all 0.2s;
    }
    .nav-link:hover { background: var(--cream); color: var(--text); }
    .nav-link.active { background: var(--sage); color: white; }

    .header-right { display: flex; align-items: center; gap: 12px; }
    .user-menu {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 12px 6px 6px;
      background: var(--cream);
      border-radius: var(--radius-full);
      text-decoration: none;
      color: var(--text);
    }
    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-light) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.85rem;
    }
    .user-name { font-weight: 600; font-size: 0.85rem; }

    .main { max-width: 1000px; margin: 0 auto; padding: 24px; }

    .page-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
    }

    .nido-icon {
      width: 70px;
      height: 70px;
      background: var(--terracotta-muted);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .page-title { font-family: 'Quicksand', sans-serif; font-size: 1.6rem; font-weight: 700; }
    .page-subtitle { color: var(--text-muted); font-size: 0.9rem; }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 24px;
    }

    @media (max-width: 800px) { .dashboard-grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body { padding: 20px; }

    /* Miembros */
    .miembros-list { display: flex; flex-direction: column; gap: 10px; }

    .miembro-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }

    .miembro-avatar {
      width: 44px;
      height: 44px;
      background: var(--sage);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
    }

    .miembro-info { flex: 1; }
    .miembro-nombre { font-weight: 600; }
    .miembro-rol { font-size: 0.8rem; color: var(--text-muted); }

    .miembro-badge {
      font-size: 0.7rem;
      padding: 4px 8px;
      background: var(--sage-muted);
      color: var(--sage-dark);
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .miembro-relacion {
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .miembro-relacion.progenitor { background: var(--terracotta-muted); color: var(--terracotta); }
    .miembro-relacion.descendiente { background: var(--sage-muted); color: var(--sage-dark); }
    .miembro-relacion.ascendiente { background: #E8E4F0; color: #6B5B95; }
    .miembro-relacion.colateral { background: #FFF3E0; color: #E65100; }
    .miembro-relacion.otros { background: var(--cream-dark); color: var(--text-light); }

    /* Accesos r√°pidos */
    .quick-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .quick-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 20px;
      background: var(--cream);
      border-radius: var(--radius-md);
      text-decoration: none;
      color: var(--text);
      transition: all 0.2s;
    }

    .quick-item:hover { background: var(--sage-muted); }
    .quick-icon { font-size: 1.5rem; }
    .quick-label { font-size: 0.85rem; font-weight: 600; }

    /* Sidebar stats */
    .stat-card {
      text-align: center;
      padding: 20px;
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
    }

    .stat-value { font-size: 2rem; font-weight: 700; color: var(--sage-dark); }
    .stat-label { font-size: 0.8rem; color: var(--text-muted); }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      text-decoration: none;
    }

    .btn-sm { padding: 6px 10px; font-size: 0.75rem; }
    .btn-primary { background: var(--sage); color: white; }

    /* Casas */
    .casa-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--cream-dark);
    }
    .casa-item:last-child { border-bottom: none; }
    .casa-info { flex: 1; }
    .casa-nombre { font-weight: 600; font-size: 0.85rem; }
    .casa-tipo { font-size: 0.7rem; color: var(--text-muted); }
    .casa-actions { display: flex; gap: 4px; }
    .casa-actions button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      font-size: 0.8rem;
      opacity: 0.6;
    }
    .casa-actions button:hover { opacity: 1; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 400px;
      box-shadow: var(--shadow-float);
    }
    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title { font-family: 'Quicksand', sans-serif; font-weight: 700; }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }
    .modal-body { padding: 16px; }
    .modal-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--cream-dark);
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .form-group { margin-bottom: 12px; }
    .form-label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; }
    .form-input {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
    }
    .form-input:focus { outline: none; border-color: var(--sage); }
    .btn-secondary { background: var(--cream); color: var(--text); border: 1px solid var(--cream-dark); }

    .loading { display: flex; align-items: center; justify-content: center; min-height: 300px; }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="cgi.html" class="logo">
        <img src="logo_familynk.png" alt="FAMILYNK" class="logo-icon">
        <span class="logo-text">FAMILYNK</span>
      </a>
      <nav class="header-nav">
        <a href="mi-nido.html" class="nav-link active">Mi Nido</a>
        <a href="arbol.html" class="nav-link">√Årbol</a>
        <a href="lo-comun.html" class="nav-link">Lo Com√∫n</a>
        <a href="legado.html" class="nav-link">Legado</a>
        <a href="cerebro.html" class="nav-link">Cerebro</a>
        <a href="activacion.html" class="nav-link">Activaci√≥n</a>
      </nav>
    </div>
    <div class="header-right">
      <a href="cgi.html" class="user-menu">
        <div class="user-avatar" id="user-avatar">?</div>
        <span class="user-name" id="user-name">...</span>
      </a>
    </div>
  </header>

  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>

    <div id="content" class="hidden">
      <div class="page-header">
        <div class="nido-icon">ü™∫</div>
        <div>
          <h1 class="page-title" id="nido-nombre">Mi Nido</h1>
          <p class="page-subtitle" id="nido-desc">Cargando...</p>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="main-col">
          <!-- Miembros -->
          <div class="card" style="margin-bottom:20px;">
            <div class="card-header">
              <span class="card-title">üë• Miembros</span>
              <button class="btn btn-sm btn-primary">+ A√±adir</button>
            </div>
            <div class="card-body">
              <div class="miembros-list" id="miembros-list"></div>
            </div>
          </div>

          <!-- Accesos r√°pidos -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">‚ö° Accesos r√°pidos</span>
            </div>
            <div class="card-body">
              <div class="quick-grid">
                <a href="tareas.html" class="quick-item">
                  <span class="quick-icon">üìã</span>
                  <span class="quick-label">Tareas</span>
                </a>
                <a href="calendario.html" class="quick-item">
                  <span class="quick-icon">üìÖ</span>
                  <span class="quick-label">Calendario</span>
                </a>
                <a href="tablon.html" class="quick-item">
                  <span class="quick-icon">üí¨</span>
                  <span class="quick-label">Tabl√≥n</span>
                </a>
                <a href="menus.html" class="quick-item">
                  <span class="quick-icon">üçΩÔ∏è</span>
                  <span class="quick-label">Men√∫s</span>
                </a>
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar-col">
          <div class="stat-card">
            <div class="stat-value" id="stat-miembros">0</div>
            <div class="stat-label">Miembros</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-tareas">0</div>
            <div class="stat-label">Tareas pendientes</div>
          </div>
          <div class="card">
            <div class="card-header">
              <span class="card-title">üè† Hogares</span>
              <button class="btn btn-sm btn-primary" onclick="abrirModalCasa()">+</button>
            </div>
            <div class="card-body" id="hogares-list">
              <p style="color:var(--text-muted);font-size:0.85rem;">Sin hogares asignados</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Casa -->
  <div class="modal-overlay" id="modal-casa">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-casa-titulo">üè† A√±adir vivienda</h3>
        <button class="modal-close" onclick="cerrarModalCasa()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Tipo</label>
          <select class="form-input" id="casa-tipo">
            <option value="principal">üè† Principal</option>
            <option value="segunda">üèñÔ∏è 2¬™ Vivienda</option>
            <option value="otra">üè¢ Otra</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Nombre</label>
          <input type="text" class="form-input" id="casa-nombre" placeholder="Ej: Casa Madrid" maxlength="40">
        </div>
        <div class="form-group">
          <label class="form-label">Direcci√≥n (opcional)</label>
          <input type="text" class="form-input" id="casa-direccion" placeholder="Calle, ciudad..." maxlength="100">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModalCasa()">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarCasa()">Guardar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser, userData, nidoData;
    let editingCasaIndex = null;

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;

      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists) { window.location.href = 'login.html'; return; }
      
      userData = userDoc.data();

      const nombre = userData.nombre || user.email.split('@')[0];
      document.getElementById('user-name').textContent = nombre.split(' ')[0];
      document.getElementById('user-avatar').textContent = nombre.charAt(0).toUpperCase();

      await loadNido();
    });

    async function loadNido() {
      try {
        let nidoId = userData.nidoId;
        let nidoDoc = null;

        // ========================================
        // L√ìGICA MEJORADA PARA ENCONTRAR MI NIDO
        // ========================================
        
        // Opci√≥n 1: nidoId directo del usuario
        if (nidoId) {
          nidoDoc = await db.collection('nidos').doc(nidoId).get();
          if (nidoDoc.exists) {
            console.log('Nido encontrado por userData.nidoId');
          } else {
            nidoDoc = null;
          }
        }

        // Opci√≥n 2: Buscar en todos los nidos de la estirpe
        if (!nidoDoc && userData.familiaId) {
          const nidosSnap = await db.collection('nidos')
            .where('familiaId', '==', userData.familiaId)
            .get();
          
          const userEmail = currentUser.email;
          const userId = currentUser.uid;

          // Buscar donde aparezca el usuario
          for (const doc of nidosSnap.docs) {
            const nido = doc.data();
            
            // Por email o uid en miembrosData
            const enMiembrosData = nido.miembrosData?.some(m => 
              m.email === userEmail || m.uid === userId
            );
            
            // Por uid en array miembros
            const enMiembros = nido.miembros?.includes(userId);
            
            if (enMiembrosData || enMiembros) {
              nidoDoc = doc;
              nidoId = doc.id;
              console.log('Nido encontrado por miembrosData/miembros:', nido.nombre);
              break;
            }
          }

          // Si no encontr√≥, buscar donde sea admin
          if (!nidoDoc) {
            for (const doc of nidosSnap.docs) {
              const nido = doc.data();
              if (nido.admins?.includes(userId)) {
                nidoDoc = doc;
                nidoId = doc.id;
                console.log('Nido encontrado por admins:', nido.nombre);
                break;
              }
            }
          }

          // Fallback: primer nido disponible
          if (!nidoDoc && nidosSnap.docs.length > 0) {
            nidoDoc = nidosSnap.docs[0];
            nidoId = nidoDoc.id;
            console.log('‚ö†Ô∏è Fallback al primer nido:', nidoDoc.data().nombre);
          }
        }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

        if (!nidoDoc) {
          document.getElementById('nido-nombre').textContent = 'Sin nido asignado';
          document.getElementById('nido-desc').textContent = 'Crea tu primer nido o pide que te a√±adan a uno';
          return;
        }
        
        nidoData = { id: nidoDoc.id, ...nidoDoc.data() };
        renderNido();
        renderCasas();

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
        document.getElementById('nido-nombre').textContent = 'Error al cargar';
      }
    }

    function renderNido() {
      const genLabels = {
        '1-bisabuelos': 'Generaci√≥n 1 ‚Äî Bisabuelos',
        '2-abuelos': 'Generaci√≥n 2 ‚Äî Abuelos',
        '3-padres': 'Generaci√≥n 3 ‚Äî Padres',
        '4-hijos': 'Generaci√≥n 4 ‚Äî Hijos'
      };

      document.getElementById('nido-nombre').textContent = nidoData.nombre || 'Mi Nido';
      document.getElementById('nido-desc').textContent = genLabels[nidoData.generacion] || '';

      const miembros = nidoData.miembrosData || [];
      document.getElementById('stat-miembros').textContent = miembros.length;

      const list = document.getElementById('miembros-list');
      if (miembros.length === 0) {
        list.innerHTML = '<p style="color:var(--text-muted);">Sin miembros</p>';
        return;
      }

      list.innerHTML = miembros.map(m => {
        const relacionLabels = {
          'progenitor': 'Progenitor',
          'descendiente': 'Hijo/a',
          'ascendiente': 'Ascendiente',
          'colateral': 'Colateral',
          'otros': 'Otros',
          'hijo': 'Hijo/a'  // Compatibilidad datos antiguos
        };
        
        // Compatible con datos antiguos (rol) y nuevos (relacion)
        let relacion = m.relacion || m.rol || 'otros';
        if (relacion === 'hijo') relacion = 'descendiente';
        const relacionLabel = relacionLabels[m.relacion || m.rol] || 'Otros';
        
        return `
          <div class="miembro-row">
            <div class="miembro-avatar">${m.iniciales || '?'}</div>
            <div class="miembro-info">
              <div class="miembro-nombre">${m.nombre || 'Sin nombre'}</div>
              <div class="miembro-rol">${m.fechaNacimiento ? calcularEdad(m.fechaNacimiento) : ''}</div>
            </div>
            <span class="miembro-relacion ${relacion}">${relacionLabel}</span>
            ${m.esAdmin ? '<span class="miembro-badge">Admin</span>' : ''}
          </div>
        `;
      }).join('');
    }

    function calcularEdad(fecha) {
      if (!fecha) return '';
      const hoy = new Date();
      const nac = new Date(fecha);
      let edad = hoy.getFullYear() - nac.getFullYear();
      return `${edad} a√±os`;
    }

    // ============ CASAS ============
    function renderCasas() {
      const casas = nidoData.casas || [];
      const container = document.getElementById('hogares-list');
      
      if (casas.length === 0) {
        container.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem;">Sin viviendas</p>';
        return;
      }

      const tipoLabels = { principal: 'Principal', segunda: '2¬™ Vivienda', otra: 'Otra' };
      container.innerHTML = casas.map((casa, i) => `
        <div class="casa-item">
          <div class="casa-info">
            <div class="casa-nombre">${casa.nombre || 'Sin nombre'}</div>
            <div class="casa-tipo">${tipoLabels[casa.tipo] || 'Otra'}${casa.direccion ? ' ¬∑ ' + casa.direccion : ''}</div>
          </div>
          <div class="casa-actions">
            <button onclick="editarCasa(${i})">‚úèÔ∏è</button>
            <button onclick="eliminarCasa(${i})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function abrirModalCasa() {
      editingCasaIndex = null;
      document.getElementById('modal-casa-titulo').textContent = 'üè† A√±adir vivienda';
      document.getElementById('casa-tipo').value = 'principal';
      document.getElementById('casa-nombre').value = '';
      document.getElementById('casa-direccion').value = '';
      document.getElementById('modal-casa').classList.add('active');
    }

    function editarCasa(index) {
      const casa = nidoData.casas[index];
      if (!casa) return;
      editingCasaIndex = index;
      document.getElementById('modal-casa-titulo').textContent = '‚úèÔ∏è Editar vivienda';
      document.getElementById('casa-tipo').value = casa.tipo || 'principal';
      document.getElementById('casa-nombre').value = casa.nombre || '';
      document.getElementById('casa-direccion').value = casa.direccion || '';
      document.getElementById('modal-casa').classList.add('active');
    }

    function cerrarModalCasa() {
      document.getElementById('modal-casa').classList.remove('active');
      editingCasaIndex = null;
    }

    async function guardarCasa() {
      const nombre = document.getElementById('casa-nombre').value.trim();
      if (!nombre) { alert('El nombre es obligatorio'); return; }

      const casaData = {
        tipo: document.getElementById('casa-tipo').value,
        nombre,
        direccion: document.getElementById('casa-direccion').value.trim()
      };

      try {
        const casas = nidoData.casas || [];
        if (editingCasaIndex !== null) {
          casas[editingCasaIndex] = { ...casas[editingCasaIndex], ...casaData };
        } else {
          casaData.id = Date.now().toString();
          casas.push(casaData);
        }

        await db.collection('nidos').doc(nidoData.id).update({ casas });
        nidoData.casas = casas;
        renderCasas();
        cerrarModalCasa();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function eliminarCasa(index) {
      if (!confirm('¬øEliminar esta vivienda?')) return;
      try {
        const casas = nidoData.casas.filter((_, i) => i !== index);
        await db.collection('nidos').doc(nidoData.id).update({ casas });
        nidoData.casas = casas;
        renderCasas();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    document.getElementById('modal-casa').addEventListener('click', (e) => {
      if (e.target.id === 'modal-casa') cerrarModalCasa();
    });
  </script>
</body>
</html>
