<!DOCTYPE html>
<html lang="es">
<head>
  <!-- FAMILYNK Icons & PWA -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7A9E7E">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="FAMILYNK">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Hoster</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --success-muted: rgba(125, 181, 154, 0.15);
      --warning: #E8B44D;
      --warning-muted: rgba(232, 180, 77, 0.15);
      --error: #D4695A;
      --error-muted: rgba(212, 105, 90, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
      --gerente: #2D4A5C;
      --gerente-light: #4A6B7C;
      --gerente-dark: #1E3544;
      --gerente-muted: rgba(45, 74, 92, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--gerente);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-brand h1 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .header-badge {
      background: rgba(255,255,255,0.2);
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 600;
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-user-name {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .btn-logout {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-logout:hover { background: rgba(255,255,255,0.25); }

    .main { max-width: 1000px; margin: 0 auto; padding: 24px; }

    /* Selector de bien */
    .bien-selector {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-soft);
    }

    .bien-selector-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .bien-selector select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      background: var(--white);
      cursor: pointer;
    }

    .bien-selector select:focus {
      outline: none;
      border-color: var(--gerente);
    }

    /* Info bien */
    .bien-info {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .bien-info-icon {
      width: 60px;
      height: 60px;
      background: var(--gerente-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .bien-info-content { flex: 1; }
    .bien-info-nombre { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.2rem; }
    .bien-info-ubicacion { font-size: 0.85rem; color: var(--text-muted); }

    /* Stats */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    @media (max-width: 600px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
    }

    .stat-card {
      background: var(--white);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
      box-shadow: var(--shadow-soft);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--gerente);
    }

    .stat-value.success { color: var(--success); }
    .stat-value.warning { color: var(--warning); }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Acciones r√°pidas */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    @media (max-width: 600px) {
      .quick-actions { grid-template-columns: repeat(2, 1fr); }
    }

    .quick-action {
      background: var(--white);
      border: 2px dashed var(--cream-dark);
      border-radius: var(--radius-lg);
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-action:hover {
      border-color: var(--gerente);
      background: var(--gerente-muted);
    }

    .quick-action-icon { font-size: 1.5rem; margin-bottom: 4px; }
    .quick-action-text { font-size: 0.8rem; font-weight: 600; }

    /* M√≥dulos grid */
    .modulos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .modulo-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
    }

    .modulo-card.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .modulo-card-header {
      padding: 16px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modulo-card-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modulo-card-permisos {
      display: flex;
      gap: 4px;
    }

    .permiso-badge {
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    .permiso-badge.ver { background: var(--sage-muted); color: var(--sage-dark); }
    .permiso-badge.crear { background: var(--gerente-muted); color: var(--gerente); }
    .permiso-badge.editar { background: var(--warning-muted); color: var(--warning); }

    .modulo-card-body { padding: 16px; max-height: 320px; overflow-y: auto; }

    .modulo-card-empty {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .modulo-card-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--cream-dark);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Reservas */
    .reserva-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      border-left: 4px solid var(--gerente);
      cursor: pointer;
      transition: all 0.2s;
    }

    .reserva-row:hover { background: var(--cream-dark); }
    .reserva-row.hoy { border-left-color: var(--success); background: var(--success-muted); }
    .reserva-row.manana { border-left-color: var(--warning); background: var(--warning-muted); }

    .reserva-fecha {
      text-align: center;
      min-width: 50px;
    }

    .reserva-dia {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--gerente);
    }

    .reserva-mes {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .reserva-info { flex: 1; }
    .reserva-titular { font-weight: 600; font-size: 0.9rem; }
    .reserva-detalle { font-size: 0.75rem; color: var(--text-muted); }

    .reserva-estado {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    .reserva-estado.confirmada { background: var(--success-muted); color: var(--success); }
    .reserva-estado.pendiente { background: var(--warning-muted); color: var(--warning); }
    .reserva-estado.checkin { background: var(--gerente-muted); color: var(--gerente); }

    /* Hu√©spedes */
    .huesped-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
    }

    .huesped-avatar {
      width: 40px;
      height: 40px;
      background: var(--gerente);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .huesped-info { flex: 1; }
    .huesped-nombre { font-weight: 600; font-size: 0.9rem; }
    .huesped-habitacion { font-size: 0.75rem; color: var(--text-muted); }

    .huesped-tipo {
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-size: 0.6rem;
      font-weight: 700;
    }

    .huesped-tipo.titular { background: var(--gerente-muted); color: var(--gerente); }
    .huesped-tipo.acompanante { background: var(--sage-muted); color: var(--sage-dark); }
    .huesped-tipo.invitado { background: var(--terracotta-muted); color: var(--terracotta); }

    /* Habitaciones */
    .habitacion-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
    }

    .habitacion-icon { font-size: 1.5rem; }
    .habitacion-info { flex: 1; }
    .habitacion-nombre { font-weight: 600; font-size: 0.9rem; }
    .habitacion-config { font-size: 0.75rem; color: var(--text-muted); }

    .habitacion-estado {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.65rem;
      font-weight: 700;
    }

    .habitacion-estado.libre { background: var(--success-muted); color: var(--success); }
    .habitacion-estado.ocupada { background: var(--error-muted); color: var(--error); }
    .habitacion-estado.limpieza { background: var(--warning-muted); color: var(--warning); }

    /* Limpieza */
    .limpieza-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      cursor: pointer;
    }

    .limpieza-check {
      width: 24px;
      height: 24px;
      border: 2px solid var(--gerente);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .limpieza-check.done {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .limpieza-info { flex: 1; }
    .limpieza-nombre { font-weight: 600; font-size: 0.9rem; }
    .limpieza-nota { font-size: 0.75rem; color: var(--text-muted); }

    /* Botones */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-gerente { background: var(--gerente); color: white; }
    .btn-gerente:hover { background: var(--gerente-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-secondary { background: var(--cream); color: var(--text); }
    .btn-sm { padding: 6px 10px; font-size: 0.75rem; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      padding: 20px;
    }

    .modal-overlay.active { opacity: 1; pointer-events: auto; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--cream);
      border-radius: var(--radius-sm);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .modal-body { padding: 20px; overflow-y: auto; max-height: 60vh; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid var(--cream-dark); display: flex; gap: 12px; justify-content: flex-end; }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
    }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--gerente); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--gerente);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-brand">
      <span style="font-size: 1.5rem;">üè®</span>
      <h1>Portal Hoster</h1>
      <span class="header-badge">GERENTE</span>
    </div>
    <div class="header-user">
      <span class="header-user-name" id="user-name">Cargando...</span>
      <button class="btn-logout" onclick="logout()">Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="main">
    <div class="loading" id="loading">
      <div class="spinner"></div>
    </div>

    <div id="content" class="hidden">
      <!-- Selector de bien (si hay varios) -->
      <div class="bien-selector" id="bien-selector-container">
        <div class="bien-selector-label">Selecciona el alojamiento</div>
        <select id="bien-select" onchange="cambiarBien()">
          <option value="">-- Seleccionar --</option>
        </select>
      </div>

      <!-- Info bien -->
      <div class="bien-info">
        <div class="bien-info-icon" id="bien-icon">üè®</div>
        <div class="bien-info-content">
          <div class="bien-info-nombre" id="bien-nombre">Sin seleccionar</div>
          <div class="bien-info-ubicacion" id="bien-ubicacion">-</div>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-value success" id="stat-llegadas">0</div>
          <div class="stat-label">Llegadas hoy</div>
        </div>
        <div class="stat-card">
          <div class="stat-value warning" id="stat-salidas">0</div>
          <div class="stat-label">Salidas hoy</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-ocupacion">0%</div>
          <div class="stat-label">Ocupaci√≥n</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-huespedes">0</div>
          <div class="stat-label">Hu√©spedes</div>
        </div>
      </div>

      <!-- Acciones r√°pidas -->
      <div class="quick-actions">
        <div class="quick-action" onclick="abrirModalCheckin()">
          <div class="quick-action-icon">üì•</div>
          <div class="quick-action-text">Check-in</div>
        </div>
        <div class="quick-action" onclick="abrirModalCheckout()">
          <div class="quick-action-icon">üì§</div>
          <div class="quick-action-text">Check-out</div>
        </div>
        <div class="quick-action" onclick="abrirModalIncidencia()">
          <div class="quick-action-icon">‚ö†Ô∏è</div>
          <div class="quick-action-text">Incidencia</div>
        </div>
        <div class="quick-action" onclick="marcarLimpiezaRapida()">
          <div class="quick-action-icon">üßπ</div>
          <div class="quick-action-text">Limpieza OK</div>
        </div>
      </div>

      <!-- M√≥dulos -->
      <div class="modulos-grid" id="modulos-container">
        <!-- Se generan din√°micamente -->
      </div>
    </div>
  </main>

  <!-- Modal Check-in -->
  <div class="modal-overlay" id="modal-checkin">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üì• Realizar Check-in</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Reserva</label>
          <select class="form-select" id="checkin-reserva">
            <option value="">-- Seleccionar reserva --</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Documento titular</label>
          <input type="text" class="form-input" id="checkin-documento" placeholder="DNI / Pasaporte">
        </div>
        <div class="form-group">
          <label class="form-label">Notas</label>
          <textarea class="form-input" id="checkin-notas" rows="2" placeholder="Observaciones de llegada..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-success" onclick="realizarCheckin()">‚úì Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal Check-out -->
  <div class="modal-overlay" id="modal-checkout">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üì§ Realizar Check-out</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Hu√©sped / Habitaci√≥n</label>
          <select class="form-select" id="checkout-huesped">
            <option value="">-- Seleccionar --</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Estado habitaci√≥n</label>
          <select class="form-select" id="checkout-estado">
            <option value="limpieza">Necesita limpieza</option>
            <option value="ok">Revisada OK</option>
            <option value="danos">Con da√±os</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Notas</label>
          <textarea class="form-input" id="checkout-notas" rows="2" placeholder="Observaciones de salida..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-warning" onclick="realizarCheckout()">‚úì Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal Incidencia -->
  <div class="modal-overlay" id="modal-incidencia">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">‚ö†Ô∏è Reportar Incidencia</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Ubicaci√≥n</label>
          <select class="form-select" id="incidencia-ubicacion">
            <option value="general">General</option>
            <option value="habitacion">Habitaci√≥n</option>
            <option value="comunes">Zonas comunes</option>
            <option value="exterior">Exterior</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Descripci√≥n</label>
          <textarea class="form-input" id="incidencia-descripcion" rows="3" placeholder="¬øQu√© ha ocurrido?" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Urgencia</label>
          <select class="form-select" id="incidencia-urgencia">
            <option value="baja">Baja</option>
            <option value="media">Media</option>
            <option value="alta">Alta</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
        <button class="btn btn-gerente" onclick="guardarIncidencia()">Reportar</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let hosterData = null;
    let bienesAsignados = [];
    let bienActual = null;

    // Datos cargados
    let reservasData = [];
    let huespedesData = [];
    let habitacionesData = [];
    let limpiezaData = [];

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'externos.html';
        return;
      }

      currentUser = user;

      try {
        // Buscar usando collectionGroup (hosters est√° como subcolecci√≥n de bienes)
        const hostersQuery = await db.collectionGroup('hosters')
          .where('email', '==', user.email.toLowerCase())
          .where('activo', '==', true)
          .get();

        if (hostersQuery.empty) {
          alert('No tienes acceso como hoster');
          window.location.href = 'externos.html';
          return;
        }

        // Recopilar todos los bienes a los que tiene acceso
        for (const doc of hostersQuery.docs) {
          const hoster = doc.data();
          const bienId = hoster.bienId;
          
          // Obtener datos del bien
          const bienDoc = await db.collection('bienes').doc(bienId).get();
          if (bienDoc.exists) {
            bienesAsignados.push({
              id: bienId,
              hosterId: doc.id,
              permisos: hoster.permisos || {},
              ...bienDoc.data()
            });
          }
        }

        if (bienesAsignados.length === 0) {
          alert('No tienes bienes asignados');
          window.location.href = 'externos.html';
          return;
        }

        document.getElementById('user-name').textContent = hostersQuery.docs[0].data().nombre || user.email.split('@')[0];

        // Renderizar selector
        const select = document.getElementById('bien-select');
        bienesAsignados.forEach(bien => {
          const opt = document.createElement('option');
          opt.value = bien.id;
          opt.textContent = bien.nombre || 'Sin nombre';
          select.appendChild(opt);
        });

        // Si solo hay uno, seleccionar autom√°ticamente
        if (bienesAsignados.length === 1) {
          select.value = bienesAsignados[0].id;
          document.getElementById('bien-selector-container').classList.add('hidden');
          await cambiarBien();
        }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar datos');
      }
    });

    async function cambiarBien() {
      const bienId = document.getElementById('bien-select').value;
      if (!bienId) return;

      bienActual = bienesAsignados.find(b => b.id === bienId);
      if (!bienActual) return;

      document.getElementById('bien-nombre').textContent = bienActual.nombre || 'Sin nombre';
      document.getElementById('bien-ubicacion').textContent = bienActual.ubicacion || '-';
      document.getElementById('bien-icon').textContent = bienActual.icono || 'üè®';

      await cargarDatos();
      renderModulos();
    }

    async function cargarDatos() {
      if (!bienActual) return;

      const bienRef = db.collection('bienes').doc(bienActual.id);
      const hoy = new Date().toISOString().split('T')[0];

      try {
        // Reservas
        const reservasSnap = await bienRef.collection('reservas')
          .where('fechaEntrada', '>=', hoy)
          .orderBy('fechaEntrada')
          .limit(10)
          .get();
        reservasData = reservasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Hu√©spedes
        const huespedesSnap = await bienRef.collection('huespedes')
          .where('estado', '==', 'alojado')
          .get();
        huespedesData = huespedesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Habitaciones
        const habitacionesSnap = await bienRef.collection('habitaciones').get();
        habitacionesData = habitacionesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Limpieza
        const limpiezaSnap = await bienRef.collection('limpieza')
          .where('completada', '==', false)
          .get();
        limpiezaData = limpiezaSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        actualizarStats();

      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }

    function actualizarStats() {
      const hoy = new Date().toISOString().split('T')[0];
      
      const llegadas = reservasData.filter(r => r.fechaEntrada === hoy && r.estado !== 'checkin').length;
      const salidas = huespedesData.filter(h => h.fechaSalida === hoy).length;
      const totalHab = habitacionesData.length || 1;
      const ocupadas = habitacionesData.filter(h => h.estado === 'ocupada').length;

      document.getElementById('stat-llegadas').textContent = llegadas;
      document.getElementById('stat-salidas').textContent = salidas;
      document.getElementById('stat-ocupacion').textContent = Math.round((ocupadas / totalHab) * 100) + '%';
      document.getElementById('stat-huespedes').textContent = huespedesData.length;
    }

    function renderModulos() {
      const container = document.getElementById('modulos-container');
      
      if (!bienActual) {
        container.innerHTML = '<div class="modulo-card-empty">Selecciona un alojamiento</div>';
        return;
      }

      container.innerHTML = `
        ${renderModuloReservas()}
        ${renderModuloHuespedes()}
        ${renderModuloHabitaciones()}
        ${renderModuloLimpieza()}
      `;
    }

    function renderModuloReservas() {
      const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      const hoy = new Date().toISOString().split('T')[0];
      const manana = new Date(Date.now() + 86400000).toISOString().split('T')[0];

      let items = reservasData.length === 0 
        ? '<div class="modulo-card-empty">No hay reservas pr√≥ximas</div>'
        : reservasData.slice(0, 5).map(r => {
            const fecha = new Date(r.fechaEntrada);
            const esHoy = r.fechaEntrada === hoy;
            const esManana = r.fechaEntrada === manana;
            
            return `
              <div class="reserva-row ${esHoy ? 'hoy' : esManana ? 'manana' : ''}">
                <div class="reserva-fecha">
                  <div class="reserva-dia">${fecha.getDate()}</div>
                  <div class="reserva-mes">${meses[fecha.getMonth()]}</div>
                </div>
                <div class="reserva-info">
                  <div class="reserva-titular">${r.titular || 'Sin nombre'}</div>
                  <div class="reserva-detalle">${r.noches || 1} noches ¬∑ ${r.numHuespedes || 1} pers.</div>
                </div>
                <span class="reserva-estado ${r.estado || 'pendiente'}">${r.estado || 'Pendiente'}</span>
              </div>
            `;
          }).join('');

      return `
        <div class="modulo-card">
          <div class="modulo-card-header">
            <div class="modulo-card-title">üìÖ Reservas</div>
          </div>
          <div class="modulo-card-body">${items}</div>
        </div>
      `;
    }

    function renderModuloHuespedes() {
      let items = huespedesData.length === 0
        ? '<div class="modulo-card-empty">No hay hu√©spedes alojados</div>'
        : huespedesData.map(h => `
            <div class="huesped-row">
              <div class="huesped-avatar">${(h.nombre || '?').charAt(0).toUpperCase()}</div>
              <div class="huesped-info">
                <div class="huesped-nombre">${h.nombre || 'Sin nombre'}</div>
                <div class="huesped-habitacion">${h.habitacion || '-'} ¬∑ Sale: ${h.fechaSalida || '-'}</div>
              </div>
              <span class="huesped-tipo ${h.tipo || 'titular'}">${h.tipo || 'Titular'}</span>
            </div>
          `).join('');

      return `
        <div class="modulo-card">
          <div class="modulo-card-header">
            <div class="modulo-card-title">üõèÔ∏è Hu√©spedes</div>
          </div>
          <div class="modulo-card-body">${items}</div>
        </div>
      `;
    }

    function renderModuloHabitaciones() {
      let items = habitacionesData.length === 0
        ? '<div class="modulo-card-empty">No hay habitaciones</div>'
        : habitacionesData.map(h => `
            <div class="habitacion-row">
              <div class="habitacion-icon">üö™</div>
              <div class="habitacion-info">
                <div class="habitacion-nombre">${h.nombre || h.numero || 'Hab.'}</div>
                <div class="habitacion-config">${h.configuracion || '-'}</div>
              </div>
              <span class="habitacion-estado ${h.estado || 'libre'}">${h.estado === 'ocupada' ? 'Ocupada' : h.estado === 'limpieza' ? 'Limpieza' : 'Libre'}</span>
            </div>
          `).join('');

      return `
        <div class="modulo-card">
          <div class="modulo-card-header">
            <div class="modulo-card-title">üè® Habitaciones</div>
          </div>
          <div class="modulo-card-body">${items}</div>
        </div>
      `;
    }

    function renderModuloLimpieza() {
      let items = limpiezaData.length === 0
        ? '<div class="modulo-card-empty">‚úÖ Todo limpio</div>'
        : limpiezaData.map(l => `
            <div class="limpieza-row" onclick="marcarLimpieza('${l.id}')">
              <div class="limpieza-check"></div>
              <div class="limpieza-info">
                <div class="limpieza-nombre">${l.habitacion || l.ubicacion || 'General'}</div>
                <div class="limpieza-nota">${l.nota || 'Limpieza est√°ndar'}</div>
              </div>
            </div>
          `).join('');

      return `
        <div class="modulo-card">
          <div class="modulo-card-header">
            <div class="modulo-card-title">üßπ Limpieza</div>
          </div>
          <div class="modulo-card-body">${items}</div>
        </div>
      `;
    }

    // ========== MODALES ==========
    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    }

    function abrirModalCheckin() {
      const select = document.getElementById('checkin-reserva');
      select.innerHTML = '<option value="">-- Seleccionar --</option>';
      
      const hoy = new Date().toISOString().split('T')[0];
      reservasData.filter(r => r.fechaEntrada <= hoy && r.estado !== 'checkin').forEach(r => {
        select.innerHTML += `<option value="${r.id}">${r.titular} - ${r.fechaEntrada}</option>`;
      });

      document.getElementById('modal-checkin').classList.add('active');
    }

    function abrirModalCheckout() {
      const select = document.getElementById('checkout-huesped');
      select.innerHTML = '<option value="">-- Seleccionar --</option>';
      
      huespedesData.forEach(h => {
        select.innerHTML += `<option value="${h.id}">${h.nombre} - ${h.habitacion || 'Sin hab.'}</option>`;
      });

      document.getElementById('modal-checkout').classList.add('active');
    }

    function abrirModalIncidencia() {
      document.getElementById('modal-incidencia').classList.add('active');
    }

    async function realizarCheckin() {
      const reservaId = document.getElementById('checkin-reserva').value;
      if (!reservaId) return alert('Selecciona una reserva');

      try {
        await db.collection('bienes').doc(bienActual.id)
          .collection('reservas').doc(reservaId)
          .update({ estado: 'checkin', fechaCheckin: new Date().toISOString() });

        alert('‚úÖ Check-in realizado');
        cerrarModales();
        await cargarDatos();
        renderModulos();
      } catch (e) {
        console.error(e);
        alert('Error');
      }
    }

    async function realizarCheckout() {
      const huespedId = document.getElementById('checkout-huesped').value;
      if (!huespedId) return alert('Selecciona un hu√©sped');

      try {
        const estado = document.getElementById('checkout-estado').value;
        
        await db.collection('bienes').doc(bienActual.id)
          .collection('huespedes').doc(huespedId)
          .update({ estado: 'checkout', fechaCheckout: new Date().toISOString() });

        if (estado === 'limpieza') {
          const h = huespedesData.find(x => x.id === huespedId);
          await db.collection('bienes').doc(bienActual.id)
            .collection('limpieza').add({
              habitacion: h?.habitacion || 'General',
              completada: false,
              fechaCreacion: new Date().toISOString()
            });
        }

        alert('‚úÖ Check-out realizado');
        cerrarModales();
        await cargarDatos();
        renderModulos();
      } catch (e) {
        console.error(e);
        alert('Error');
      }
    }

    async function guardarIncidencia() {
      const desc = document.getElementById('incidencia-descripcion').value;
      if (!desc) return alert('Describe la incidencia');

      try {
        await db.collection('bienes').doc(bienActual.id)
          .collection('incidencias').add({
            ubicacion: document.getElementById('incidencia-ubicacion').value,
            descripcion: desc,
            urgencia: document.getElementById('incidencia-urgencia').value,
            estado: 'pendiente',
            creadoPor: currentUser.uid,
            fecha: firebase.firestore.FieldValue.serverTimestamp()
          });

        alert('‚úÖ Incidencia reportada');
        cerrarModales();
      } catch (e) {
        console.error(e);
        alert('Error');
      }
    }

    async function marcarLimpieza(id) {
      try {
        await db.collection('bienes').doc(bienActual.id)
          .collection('limpieza').doc(id)
          .update({ completada: true, fechaCompletada: new Date().toISOString() });

        await cargarDatos();
        renderModulos();
      } catch (e) {
        console.error(e);
      }
    }

    function marcarLimpiezaRapida() {
      if (limpiezaData.length === 0) {
        alert('No hay tareas de limpieza pendientes');
        return;
      }
      // Marcar la primera
      marcarLimpieza(limpiezaData[0].id);
    }

    function logout() {
      auth.signOut().then(() => window.location.href = 'externos.html');
    }

    // Cerrar modales con click fuera
    document.querySelectorAll('.modal-overlay').forEach(m => {
      m.addEventListener('click', e => {
        if (e.target.classList.contains('modal-overlay')) cerrarModales();
      });
    });
  </script>
</body>
</html>
