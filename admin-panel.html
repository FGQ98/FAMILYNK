<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK â€” Admin Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --admin: #4A5568;
      --admin-light: #718096;
      --admin-dark: #2D3748;
      --admin-muted: rgba(74, 85, 104, 0.1);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #48BB78;
      --warning: #ECC94B;
      --error: #F56565;
      --info: #4299E1;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.1);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header {
      background: linear-gradient(135deg, var(--admin-dark) 0%, var(--admin) 100%);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 20px; }

    .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo-icon { width: 38px; height: 38px; background: rgba(255,255,255,0.15); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .logo-text { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.1rem; color: white; }
    .logo-badge { padding: 3px 10px; background: var(--terracotta); color: white; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 700; }

    .header-right { display: flex; align-items: center; gap: 16px; }
    .header-link { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.85rem; font-weight: 600; transition: color 0.2s; }
    .header-link:hover { color: white; }

    .user-badge { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: var(--radius-full); color: white; font-size: 0.85rem; }
    .user-badge-avatar { width: 28px; height: 28px; background: var(--sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; }

    .layout { display: grid; grid-template-columns: 240px 1fr; min-height: calc(100vh - 62px); }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } .sidebar { display: none; } }

    .sidebar { background: var(--white); border-right: 1px solid var(--cream-dark); padding: 20px 0; overflow-y: auto; }
    .sidebar-section { margin-bottom: 20px; }
    .sidebar-title { padding: 0 20px; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 700; margin-bottom: 6px; }
    .sidebar-nav { list-style: none; }
    .sidebar-link { display: flex; align-items: center; gap: 10px; padding: 10px 20px; color: var(--text-light); text-decoration: none; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
    .sidebar-link:hover { background: var(--cream); color: var(--text); }
    .sidebar-link.active { background: var(--admin-muted); color: var(--admin-dark); border-right: 3px solid var(--admin); }
    .sidebar-link-icon { font-size: 1rem; width: 22px; text-align: center; }
    .sidebar-link-badge { margin-left: auto; padding: 2px 7px; background: var(--info); color: white; border-radius: var(--radius-full); font-size: 0.65rem; font-weight: 700; }

    .main { padding: 24px; max-width: 1400px; }
    .section { display: none; }
    .section.active { display: block; }
    .section-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
    .section-title { font-family: 'Quicksand', sans-serif; font-size: 1.4rem; font-weight: 700; color: var(--admin-dark); margin-bottom: 4px; }
    .section-description { color: var(--text-muted); font-size: 0.85rem; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--white); border-radius: var(--radius-lg); padding: 18px; box-shadow: var(--shadow-soft); display: flex; align-items: center; gap: 14px; }
    .stat-icon { width: 46px; height: 46px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
    .stat-icon.usuarios { background: var(--sage-muted); }
    .stat-icon.familias { background: var(--terracotta-muted); }
    .stat-icon.addons { background: rgba(236, 201, 75, 0.2); }
    .stat-icon.activos { background: rgba(72, 187, 120, 0.2); }
    .stat-value { font-size: 1.6rem; font-weight: 700; color: var(--admin-dark); }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); }

    .card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); overflow: hidden; margin-bottom: 20px; }
    .card-header { padding: 14px 20px; border-bottom: 1px solid var(--cream-dark); display: flex; align-items: center; justify-content: space-between; }
    .card-title { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
    .card-body { padding: 20px; }

    .table-container { overflow-x: auto; }
    .table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .table th, .table td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--cream-dark); }
    .table th { background: var(--cream); font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
    .table tr:hover { background: var(--cream); }
    .table-avatar { width: 34px; height: 34px; background: var(--sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.8rem; }
    .table-user { display: flex; align-items: center; gap: 10px; }
    .table-user-name { font-weight: 600; }
    .table-user-email { font-size: 0.75rem; color: var(--text-muted); }

    .badge { display: inline-block; padding: 3px 9px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600; }
    .badge-success { background: rgba(72, 187, 120, 0.2); color: var(--success); }
    .badge-warning { background: rgba(236, 201, 75, 0.2); color: #B7791F; }
    .badge-error { background: rgba(245, 101, 101, 0.2); color: var(--error); }
    .badge-info { background: rgba(66, 153, 225, 0.2); color: var(--info); }
    .badge-neutral { background: var(--cream-dark); color: var(--text-muted); }
    .badge-role { padding: 2px 7px; font-size: 0.65rem; }
    .badge-role.adminsistema { background: var(--admin); color: white; }
    .badge-role.adminrama { background: var(--sage); color: white; }
    .badge-role.adminnido { background: var(--terracotta); color: white; }
    .badge-role.miembro { background: var(--cream-dark); color: var(--text-light); }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 9px 14px; border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; text-decoration: none; }
    .btn-primary { background: var(--admin); color: white; }
    .btn-primary:hover { background: var(--admin-dark); }
    .btn-secondary { background: var(--cream); color: var(--text); border: 1px solid var(--cream-dark); }
    .btn-secondary:hover { background: var(--cream-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-warning { background: var(--warning); color: var(--admin-dark); }
    .btn-sm { padding: 5px 10px; font-size: 0.75rem; }

    .toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .search-box { flex: 1; min-width: 200px; position: relative; }
    .search-input { width: 100%; padding: 9px 14px 9px 36px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.85rem; }
    .search-input:focus { outline: none; border-color: var(--admin); }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem; }
    .filter-select { padding: 9px 14px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.85rem; background: var(--white); }
    .filter-select:focus { outline: none; border-color: var(--admin); }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: var(--text); }
    .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.85rem; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--admin); }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-check { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem; }
    .form-check input { width: 18px; height: 18px; cursor: pointer; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; padding: 20px; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--white); border-radius: var(--radius-lg); width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 18px 24px; border-bottom: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.05rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 14px 24px; border-top: 1px solid var(--cream-dark); display: flex; justify-content: flex-end; gap: 12px; }

    .config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .config-card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); overflow: hidden; }
    .config-card-header { padding: 14px 18px; background: var(--admin-muted); border-bottom: 1px solid var(--cream-dark); display: flex; align-items: center; gap: 10px; }
    .config-card-icon { font-size: 1.3rem; }
    .config-card-title { font-weight: 700; font-size: 0.9rem; }
    .config-card-body { padding: 18px; }
    .config-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--cream-dark); }
    .config-item:last-child { border-bottom: none; }
    .config-item-label { font-size: 0.85rem; color: var(--text-light); }
    .config-input { width: 80px; padding: 6px 10px; border: 2px solid var(--cream-dark); border-radius: var(--radius-sm); text-align: center; font-weight: 600; }
    .config-input:focus { outline: none; border-color: var(--admin); }

    .plan-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .plan-card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); overflow: hidden; border: 2px solid transparent; }
    .plan-card-header { padding: 20px; text-align: center; background: var(--cream); }
    .plan-card-header.free { background: var(--admin-muted); }
    .plan-card-header.crearrama { background: rgba(232, 164, 77, 0.15); }
    .plan-card-header.mayordomo { background: rgba(139, 115, 85, 0.15); }
    .plan-icon { font-size: 2.5rem; margin-bottom: 10px; }
    .plan-name { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.2rem; }
    .plan-price { font-size: 1.8rem; font-weight: 700; color: var(--admin-dark); margin-top: 8px; }
    .plan-price span { font-size: 0.9rem; font-weight: 400; color: var(--text-muted); }
    .plan-card-body { padding: 20px; }
    .plan-feature { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; font-size: 0.85rem; }
    .plan-feature-icon { color: var(--success); font-weight: 700; }
    .plan-card-footer { padding: 16px 20px; border-top: 1px solid var(--cream-dark); }

    .service-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .service-card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); overflow: hidden; }
    .service-header { padding: 16px 20px; display: flex; align-items: center; gap: 14px; border-bottom: 1px solid var(--cream-dark); }
    .service-logo { width: 44px; height: 44px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: var(--cream); }
    .service-info { flex: 1; }
    .service-name { font-weight: 700; font-size: 0.95rem; }
    .service-type { font-size: 0.75rem; color: var(--text-muted); }
    .service-status { padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600; }
    .service-status.activo { background: rgba(72, 187, 120, 0.2); color: var(--success); }
    .service-status.inactivo { background: var(--cream-dark); color: var(--text-muted); }
    .service-body { padding: 16px 20px; }
    .service-field { margin-bottom: 12px; }
    .service-field-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
    .service-field-value { font-family: monospace; font-size: 0.8rem; padding: 8px 10px; background: var(--cream); border-radius: var(--radius-sm); word-break: break-all; }
    .service-footer { padding: 12px 20px; border-top: 1px solid var(--cream-dark); display: flex; justify-content: space-between; }

    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-muted); }
    .mt-2 { margin-top: 16px; }
    .mb-2 { margin-bottom: 16px; }
    .divider { height: 1px; background: var(--cream-dark); margin: 20px 0; }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state-icon { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
    .spinner { width: 36px; height: 36px; border: 3px solid var(--cream-dark); border-top-color: var(--admin); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr 1fr; } .form-row { grid-template-columns: 1fr; } .config-grid, .plan-grid, .service-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="cgi.html" class="logo">
        <div class="logo-icon">ğŸªº</div>
        <span class="logo-text">FAMILYNK</span>
        <span class="logo-badge">ADMIN</span>
      </a>
    </div>
    <div class="header-right">
      <a href="cgi.html" class="header-link">â† Volver al CGI</a>
      <div class="user-badge">
        <div class="user-badge-avatar" id="user-avatar">?</div>
        <span id="user-name">Admin</span>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">General</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link active" data-section="dashboard" onclick="cambiarSeccion('dashboard')">
            <span class="sidebar-link-icon">ğŸ“Š</span>Dashboard
          </button>
        </nav>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">GestiÃ³n de datos</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link" data-section="usuarios" onclick="cambiarSeccion('usuarios')">
            <span class="sidebar-link-icon">ğŸ‘¥</span>Usuarios
            <span class="sidebar-link-badge" id="badge-usuarios">0</span>
          </button>
          <button class="sidebar-link" data-section="familias" onclick="cambiarSeccion('familias')">
            <span class="sidebar-link-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>Familias
            <span class="sidebar-link-badge" id="badge-familias">0</span>
          </button>
          <button class="sidebar-link" data-section="nidos" onclick="cambiarSeccion('nidos')">
            <span class="sidebar-link-icon">ğŸªº</span>Nidos
          </button>
          <button class="sidebar-link" data-section="invitaciones" onclick="cambiarSeccion('invitaciones')">
            <span class="sidebar-link-icon">âœ‰ï¸</span>Invitaciones
          </button>
        </nav>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">MonetizaciÃ³n</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link" data-section="planes" onclick="cambiarSeccion('planes')">
            <span class="sidebar-link-icon">ğŸ’³</span>Planes y precios
          </button>
          <button class="sidebar-link" data-section="addons" onclick="cambiarSeccion('addons')">
            <span class="sidebar-link-icon">âš¡</span>Add-ons activos
          </button>
        </nav>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">Sistema</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link" data-section="estructura" onclick="cambiarSeccion('estructura')">
            <span class="sidebar-link-icon">ğŸ—ï¸</span>Estructura
          </button>
          <button class="sidebar-link" data-section="servicios" onclick="cambiarSeccion('servicios')">
            <span class="sidebar-link-icon">ğŸ”Œ</span>Servicios / APIs
          </button>
          <button class="sidebar-link" data-section="config" onclick="cambiarSeccion('config')">
            <span class="sidebar-link-icon">âš™ï¸</span>ConfiguraciÃ³n
          </button>
        </nav>
      </div>
    </aside>

    <main class="main">
      <!-- DASHBOARD -->
      <section class="section active" id="section-dashboard">
        <div class="section-header">
          <div>
            <h1 class="section-title">ğŸ“Š Dashboard</h1>
            <p class="section-description">Resumen general de FAMILYNK</p>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon usuarios">ğŸ‘¥</div><div><div class="stat-value" id="stat-total-usuarios">-</div><div class="stat-label">Usuarios</div></div></div>
          <div class="stat-card"><div class="stat-icon familias">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div><div><div class="stat-value" id="stat-total-familias">-</div><div class="stat-label">Familias</div></div></div>
          <div class="stat-card"><div class="stat-icon addons">âš¡</div><div><div class="stat-value" id="stat-addons-activos">-</div><div class="stat-label">Add-ons</div></div></div>
          <div class="stat-card"><div class="stat-icon activos">âœ‰ï¸</div><div><div class="stat-value" id="stat-invitaciones">-</div><div class="stat-label">Invitaciones</div></div></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="card"><div class="card-header"><span class="card-title">ğŸ“ˆ Ãšltimos usuarios</span></div><div class="card-body" id="ultimos-usuarios"><div class="loading"><div class="spinner"></div></div></div></div>
          <div class="card"><div class="card-header"><span class="card-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Ãšltimas familias</span></div><div class="card-body" id="ultimas-familias"><div class="loading"><div class="spinner"></div></div></div></div>
        </div>
        <div class="card"><div class="card-header"><span class="card-title">âš¡ Resumen Add-ons</span></div><div class="card-body" id="addons-resumen"><div class="loading"><div class="spinner"></div></div></div></div>
      </section>

      <!-- USUARIOS -->
      <section class="section" id="section-usuarios">
        <div class="section-header"><div><h1 class="section-title">ğŸ‘¥ Usuarios</h1><p class="section-description">GestiÃ³n de usuarios registrados</p></div></div>
        <div class="toolbar">
          <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" id="search-usuarios" placeholder="Buscar..."></div>
          <select class="filter-select" id="filter-rol"><option value="">Todos</option><option value="AdminSistema">AdminSistema</option><option value="AdminRama">AdminRama</option><option value="AdminNido">AdminNido</option><option value="Miembro">Miembro</option></select>
        </div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Usuario</th><th>Rol</th><th>Familia</th><th>Registro</th><th>Acciones</th></tr></thead><tbody id="tabla-usuarios"><tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- FAMILIAS -->
      <section class="section" id="section-familias">
        <div class="section-header"><div><h1 class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Familias</h1><p class="section-description">GestiÃ³n de familias</p></div><button class="btn btn-primary" onclick="abrirModalNuevaFamilia()">+ Nueva familia</button></div>
        <div class="toolbar">
          <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" id="search-familias" placeholder="Buscar..."></div>
          <select class="filter-select" id="filter-plan"><option value="">Todos</option><option value="free">FREE</option></select>
        </div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Familia</th><th>Plan</th><th>Miembros</th><th>Add-ons</th><th>CreaciÃ³n</th><th>Acciones</th></tr></thead><tbody id="tabla-familias"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- NIDOS -->
      <section class="section" id="section-nidos">
        <div class="section-header"><div><h1 class="section-title">ğŸªº Nidos</h1><p class="section-description">Unidades de convivencia</p></div></div>
        <div class="toolbar"><div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" id="search-nidos" placeholder="Buscar..."></div></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Nido</th><th>Familia</th><th>GeneraciÃ³n</th><th>Miembros</th><th>Acciones</th></tr></thead><tbody id="tabla-nidos"><tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- INVITACIONES -->
      <section class="section" id="section-invitaciones">
        <div class="section-header"><div><h1 class="section-title">âœ‰ï¸ Invitaciones</h1><p class="section-description">GestiÃ³n de invitaciones</p></div><button class="btn btn-primary" onclick="abrirModalNuevaInvitacion()">+ Nueva invitaciÃ³n</button></div>
        <div class="toolbar"><select class="filter-select" id="filter-inv-estado"><option value="">Todos</option><option value="pendiente">Pendiente</option><option value="aceptada">Aceptada</option><option value="expirada">Expirada</option></select></div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Email</th><th>Familia</th><th>Rol</th><th>Estado</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody id="tabla-invitaciones"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- PLANES -->
      <section class="section" id="section-planes">
        <div class="section-header"><div><h1 class="section-title">ğŸ’³ Planes y precios</h1><p class="section-description">ConfiguraciÃ³n de planes y add-ons</p></div></div>
        <h3 style="margin-bottom: 16px; font-size: 1rem; color: var(--text-light);">Plan base</h3>
        <div class="plan-grid mb-2">
          <div class="plan-card">
            <div class="plan-card-header free"><div class="plan-icon">ğŸ†“</div><div class="plan-name">FREE</div><div class="plan-price">0â‚¬ <span>/ siempre</span></div></div>
            <div class="plan-card-body">
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Ãrbol (2 generaciones)</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Legado (limitado)</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Cerebro (bÃ¡sico)</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Lo ComÃºn (limitado)</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> ActivaciÃ³n (bÃ¡sico)</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Amigo Invisible</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Encuestas</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> 200 imÃ¡genes</div>
            </div>
            <div class="plan-card-footer"><span class="badge badge-success">Plan por defecto</span></div>
          </div>
        </div>
        <div class="divider"></div>
        <h3 style="margin-bottom: 16px; font-size: 1rem; color: var(--text-light);">Add-ons (14 dÃ­as prueba)</h3>
        <div class="plan-grid">
          <div class="plan-card">
            <div class="plan-card-header crearrama"><div class="plan-icon">ğŸŒ³</div><div class="plan-name">Crear Rama</div><div class="plan-price"><input type="number" class="config-input" id="precio-crearrama" value="0" style="width: 60px; font-size: 1.2rem;">â‚¬ <span>/ mes</span></div></div>
            <div class="plan-card-body">
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Segunda rama familiar</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> CGI fusionado</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Generaciones ilimitadas</div>
            </div>
            <div class="plan-card-footer"><label class="form-check"><input type="checkbox" id="addon-crearrama-activo" checked><span>Add-on disponible</span></label></div>
          </div>
          <div class="plan-card">
            <div class="plan-card-header mayordomo"><div class="plan-icon">ğŸ©</div><div class="plan-name">Mayordomo</div><div class="plan-price"><input type="number" class="config-input" id="precio-mayordomo" value="0" style="width: 60px; font-size: 1.2rem;">â‚¬ <span>/ mes</span></div></div>
            <div class="plan-card-body">
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Inventario con alertas</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Reservas y calendario</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Mantenimiento</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Lista compra automÃ¡tica</div>
              <div class="plan-feature"><span class="plan-feature-icon">âœ“</span> Caseros</div>
            </div>
            <div class="plan-card-footer"><label class="form-check"><input type="checkbox" id="addon-mayordomo-activo" checked><span>Add-on disponible</span></label></div>
          </div>
        </div>
        <div class="mt-2"><button class="btn btn-primary" onclick="guardarPlanes()">ğŸ’¾ Guardar configuraciÃ³n</button></div>
      </section>

      <!-- ADD-ONS ACTIVOS -->
      <section class="section" id="section-addons">
        <div class="section-header"><div><h1 class="section-title">âš¡ Add-ons activos</h1><p class="section-description">Estado por familia</p></div></div>
        <div class="stats-grid mb-2">
          <div class="stat-card"><div class="stat-icon" style="background: rgba(232, 164, 77, 0.2);">ğŸŒ³</div><div><div class="stat-value" id="stat-crear-rama">-</div><div class="stat-label">Crear Rama</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background: rgba(139, 115, 85, 0.2);">ğŸ©</div><div><div class="stat-value" id="stat-mayordomo">-</div><div class="stat-label">Mayordomo</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background: rgba(66, 153, 225, 0.2);">ğŸ§ª</div><div><div class="stat-value" id="stat-trials">-</div><div class="stat-label">En trial</div></div></div>
        </div>
        <div class="card"><div class="table-container"><table class="table"><thead><tr><th>Familia</th><th>ğŸŒ³ Crear Rama</th><th>ğŸ© Mayordomo</th><th>Acciones</th></tr></thead><tbody id="tabla-addons"><tr><td colspan="4"><div class="loading"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
      </section>

      <!-- ESTRUCTURA -->
      <section class="section" id="section-estructura">
        <div class="section-header"><div><h1 class="section-title">ğŸ—ï¸ Estructura del sistema</h1><p class="section-description">ConfiguraciÃ³n de lÃ­mites y arquitectura</p></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸŒ³</span><span class="config-card-title">Ãrbol familiar</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Generaciones FREE</span><input type="number" class="config-input" id="config-gen-free" value="2"></div><div class="config-item"><span class="config-item-label">Generaciones Premium</span><input type="number" class="config-input" id="config-gen-premium" value="99"></div><div class="config-item"><span class="config-item-label">Miembros/nido</span><input type="number" class="config-input" id="config-miembros-nido" value="20"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ–¼ï¸</span><span class="config-card-title">ImÃ¡genes</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">LÃ­mite FREE</span><input type="number" class="config-input" id="config-img-free" value="200"></div><div class="config-item"><span class="config-item-label">LÃ­mite Premium</span><input type="number" class="config-input" id="config-img-premium" value="9999"></div><div class="config-item"><span class="config-item-label">TamaÃ±o mÃ¡x (MB)</span><input type="number" class="config-input" id="config-img-size" value="5"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ </span><span class="config-card-title">Lo ComÃºn</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Bienes FREE</span><input type="number" class="config-input" id="config-bienes-free" value="5"></div><div class="config-item"><span class="config-item-label">Bienes Premium</span><input type="number" class="config-input" id="config-bienes-premium" value="99"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ§ª</span><span class="config-card-title">Trials</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">DÃ­as trial</span><input type="number" class="config-input" id="config-trial-dias" value="14"></div><div class="config-item"><span class="config-item-label">Aviso antes (dÃ­as)</span><input type="number" class="config-input" id="config-trial-aviso" value="3"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">âœ‰ï¸</span><span class="config-card-title">Invitaciones</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">ExpiraciÃ³n (dÃ­as)</span><input type="number" class="config-input" id="config-inv-expira" value="7"></div><div class="config-item"><span class="config-item-label">MÃ¡x reenvÃ­os</span><input type="number" class="config-input" id="config-inv-reenvios" value="3"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ“œ</span><span class="config-card-title">Legado</span></div><div class="config-card-body"><div class="config-item"><span class="config-item-label">Elementos FREE</span><input type="number" class="config-input" id="config-legado-free" value="10"></div><div class="config-item"><span class="config-item-label">Elementos Premium</span><input type="number" class="config-input" id="config-legado-premium" value="999"></div></div></div>
        </div>
        <div class="mt-2"><button class="btn btn-primary" onclick="guardarEstructura()">ğŸ’¾ Guardar estructura</button></div>
      </section>

      <!-- SERVICIOS -->
      <section class="section" id="section-servicios">
        <div class="section-header"><div><h1 class="section-title">ğŸ”Œ Servicios y APIs</h1><p class="section-description">ConfiguraciÃ³n de servicios externos</p></div></div>
        <div class="service-grid">
          <div class="service-card">
            <div class="service-header"><div class="service-logo" style="background: #FFCA28;">ğŸ”¥</div><div class="service-info"><div class="service-name">Firebase</div><div class="service-type">Auth + Firestore + Storage</div></div><span class="service-status activo">Activo</span></div>
            <div class="service-body"><div class="service-field"><div class="service-field-label">Project ID</div><div class="service-field-value">familynk-xxxxx</div></div><div class="service-field"><div class="service-field-label">Plan</div><div class="service-field-value">Blaze</div></div></div>
            <div class="service-footer"><button class="btn btn-sm btn-secondary" onclick="editarServicio('firebase')">âš™ï¸</button><a href="https://console.firebase.google.com" target="_blank" class="btn btn-sm btn-secondary">Abrir â†’</a></div>
          </div>
          <div class="service-card">
            <div class="service-header"><div class="service-logo" style="background: #EA4335;">ğŸ“§</div><div class="service-info"><div class="service-name">EmailJS</div><div class="service-type">EnvÃ­o de emails</div></div><span class="service-status activo">Activo</span></div>
            <div class="service-body"><div class="service-field"><div class="service-field-label">Service ID</div><div class="service-field-value">service_fcfx5od</div></div><div class="service-field"><div class="service-field-label">Template ID</div><div class="service-field-value">template_my2n26t</div></div></div>
            <div class="service-footer"><button class="btn btn-sm btn-secondary" onclick="editarServicio('emailjs')">âš™ï¸</button><a href="https://dashboard.emailjs.com" target="_blank" class="btn btn-sm btn-secondary">Abrir â†’</a></div>
          </div>
          <div class="service-card">
            <div class="service-header"><div class="service-logo" style="background: #000; color: white;">â–²</div><div class="service-info"><div class="service-name">Vercel</div><div class="service-type">Hosting</div></div><span class="service-status activo">Activo</span></div>
            <div class="service-body"><div class="service-field"><div class="service-field-label">Dominio</div><div class="service-field-value">www.familynk.es</div></div></div>
            <div class="service-footer"><button class="btn btn-sm btn-secondary" onclick="editarServicio('vercel')">âš™ï¸</button><a href="https://vercel.com" target="_blank" class="btn btn-sm btn-secondary">Abrir â†’</a></div>
          </div>
          <div class="service-card" style="opacity: 0.6;">
            <div class="service-header"><div class="service-logo" style="background: #635BFF; color: white;">ğŸ’³</div><div class="service-info"><div class="service-name">Stripe</div><div class="service-type">Pagos</div></div><span class="service-status inactivo">No config.</span></div>
            <div class="service-body"><p class="text-muted text-center" style="padding: 20px;">Configura para activar pagos</p></div>
            <div class="service-footer"><button class="btn btn-sm btn-primary" onclick="editarServicio('stripe')">ğŸ”§ Configurar</button></div>
          </div>
        </div>
      </section>

      <!-- CONFIG -->
      <section class="section" id="section-config">
        <div class="section-header"><div><h1 class="section-title">âš™ï¸ ConfiguraciÃ³n</h1><p class="section-description">Ajustes generales</p></div></div>
        <div class="config-grid">
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸŒ</span><span class="config-card-title">AplicaciÃ³n</span></div><div class="config-card-body"><div class="form-group"><label class="form-label">Nombre</label><input type="text" class="form-input" id="config-app-nombre" value="FAMILYNK"></div><div class="form-group"><label class="form-label">Dominio</label><input type="text" class="form-input" id="config-app-dominio" value="www.familynk.es"></div><div class="form-group"><label class="form-label">Email soporte</label><input type="email" class="form-input" id="config-app-email" value="soporte@familynk.es"></div></div></div>
          <div class="config-card"><div class="config-card-header"><span class="config-card-icon">ğŸ”§</span><span class="config-card-title">Herramientas</span></div><div class="config-card-body"><button class="btn btn-secondary mb-2" onclick="exportarUsuarios()" style="width: 100%;">ğŸ“¥ Exportar usuarios</button><button class="btn btn-secondary mb-2" onclick="exportarFamilias()" style="width: 100%;">ğŸ“¥ Exportar familias</button><button class="btn btn-warning mb-2" onclick="limpiarTrialsExpirados()" style="width: 100%;">ğŸ§¹ Limpiar trials</button></div></div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODALES -->
  <div class="modal-overlay" id="modal-usuario"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ‘¤ Usuario</h3><button class="modal-close" onclick="cerrarModales()">Ã—</button></div><div class="modal-body" id="modal-usuario-body"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button><button class="btn btn-primary" onclick="guardarUsuario()">Guardar</button></div></div></div>
  <div class="modal-overlay" id="modal-familia"><div class="modal"><div class="modal-header"><h3 class="modal-title" id="modal-familia-titulo">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Familia</h3><button class="modal-close" onclick="cerrarModales()">Ã—</button></div><div class="modal-body" id="modal-familia-body"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button><button class="btn btn-primary" onclick="guardarFamilia()">Guardar</button></div></div></div>
  <div class="modal-overlay" id="modal-invitacion"><div class="modal"><div class="modal-header"><h3 class="modal-title">âœ‰ï¸ InvitaciÃ³n</h3><button class="modal-close" onclick="cerrarModales()">Ã—</button></div><div class="modal-body" id="modal-invitacion-body"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button><button class="btn btn-primary" onclick="enviarInvitacion()">Enviar</button></div></div></div>
  <div class="modal-overlay" id="modal-servicio"><div class="modal"><div class="modal-header"><h3 class="modal-title" id="modal-servicio-titulo">ğŸ”Œ Servicio</h3><button class="modal-close" onclick="cerrarModales()">Ã—</button></div><div class="modal-body" id="modal-servicio-body"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button><button class="btn btn-primary" onclick="guardarServicio()">Guardar</button></div></div></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null, userData = null, seccionActual = 'dashboard';
    let usuariosData = [], familiasData = [], nidosData = [], invitacionesData = [];
    let editingUserId = null, editingFamiliaId = null;

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists) { window.location.href = 'login.html'; return; }
      userData = userDoc.data();
      if (userData.rol !== 'AdminSistema') { alert('Acceso denegado'); window.location.href = 'cgi.html'; return; }
      const nombre = userData.nombre || user.email.split('@')[0];
      document.getElementById('user-name').textContent = nombre.split(' ')[0];
      document.getElementById('user-avatar').textContent = nombre.charAt(0).toUpperCase();
      cargarDashboard();
    });

    function cambiarSeccion(seccion) {
      seccionActual = seccion;
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.toggle('active', l.dataset.section === seccion));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(`section-${seccion}`).classList.add('active');
      switch(seccion) {
        case 'dashboard': cargarDashboard(); break;
        case 'usuarios': cargarUsuarios(); break;
        case 'familias': cargarFamilias(); break;
        case 'nidos': cargarNidos(); break;
        case 'invitaciones': cargarInvitaciones(); break;
        case 'addons': cargarAddons(); break;
      }
    }

    async function cargarDashboard() {
      try {
        const usersSnap = await db.collection('usuarios').get();
        usuariosData = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        document.getElementById('stat-total-usuarios').textContent = usuariosData.length;
        document.getElementById('badge-usuarios').textContent = usuariosData.length;

        const famSnap = await db.collection('familias').get();
        familiasData = famSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        document.getElementById('stat-total-familias').textContent = familiasData.length;
        document.getElementById('badge-familias').textContent = familiasData.length;

        const invSnap = await db.collection('invitaciones-email').where('estado', '==', 'pendiente').get();
        document.getElementById('stat-invitaciones').textContent = invSnap.size;

        let addonsActivos = 0, crearRamaCount = 0, mayordomoCount = 0, trialsCount = 0;
        const ahora = new Date();
        familiasData.forEach(f => {
          const addons = f.addons || {};
          if (addons.crearRama?.activo || (addons.crearRama?.trialHasta && new Date(addons.crearRama.trialHasta) > ahora)) { crearRamaCount++; addonsActivos++; if (addons.crearRama?.trialHasta && new Date(addons.crearRama.trialHasta) > ahora) trialsCount++; }
          if (addons.mayordomo?.activo || (addons.mayordomo?.trialHasta && new Date(addons.mayordomo.trialHasta) > ahora)) { mayordomoCount++; addonsActivos++; if (addons.mayordomo?.trialHasta && new Date(addons.mayordomo.trialHasta) > ahora) trialsCount++; }
        });
        document.getElementById('stat-addons-activos').textContent = addonsActivos;

        const ultimos = usuariosData.slice(-5).reverse();
        document.getElementById('ultimos-usuarios').innerHTML = ultimos.length > 0 ? ultimos.map(u => `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--cream-dark);"><div class="table-avatar" style="width:32px;height:32px;font-size:0.75rem;">${(u.nombre||u.email||'?').charAt(0).toUpperCase()}</div><div style="flex:1;"><div style="font-weight:600;font-size:0.85rem;">${u.nombre||'Sin nombre'}</div><div style="font-size:0.75rem;color:var(--text-muted);">${u.email||''}</div></div></div>`).join('') : '<p class="text-muted text-center">Sin usuarios</p>';

        const ultimasF = familiasData.slice(-5).reverse();
        document.getElementById('ultimas-familias').innerHTML = ultimasF.length > 0 ? ultimasF.map(f => `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--cream-dark);"><div style="width:32px;height:32px;background:var(--terracotta-muted);border-radius:6px;display:flex;align-items:center;justify-content:center;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div><div style="flex:1;font-weight:600;font-size:0.85rem;">${f.nombre||'Sin nombre'}</div></div>`).join('') : '<p class="text-muted text-center">Sin familias</p>';

        document.getElementById('addons-resumen').innerHTML = `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;text-align:center;"><div style="padding:16px;background:var(--cream);border-radius:8px;"><div style="font-size:1.8rem;">ğŸŒ³</div><div style="font-size:1.3rem;font-weight:700;">${crearRamaCount}</div><div style="font-size:0.8rem;color:var(--text-muted);">Crear Rama</div></div><div style="padding:16px;background:var(--cream);border-radius:8px;"><div style="font-size:1.8rem;">ğŸ©</div><div style="font-size:1.3rem;font-weight:700;">${mayordomoCount}</div><div style="font-size:0.8rem;color:var(--text-muted);">Mayordomo</div></div><div style="padding:16px;background:var(--cream);border-radius:8px;"><div style="font-size:1.8rem;">ğŸ§ª</div><div style="font-size:1.3rem;font-weight:700;">${trialsCount}</div><div style="font-size:0.8rem;color:var(--text-muted);">En trial</div></div></div>`;
      } catch (e) { console.error('Error:', e); }
    }

    async function cargarUsuarios() {
      const tbody = document.getElementById('tabla-usuarios');
      try {
        if (!usuariosData.length) { const snap = await db.collection('usuarios').get(); usuariosData = snap.docs.map(d => ({ id: d.id, ...d.data() })); }
        const search = document.getElementById('search-usuarios').value.toLowerCase();
        const filtroRol = document.getElementById('filter-rol').value;
        let filtrados = usuariosData.filter(u => { const ms = !search || (u.nombre||'').toLowerCase().includes(search) || (u.email||'').toLowerCase().includes(search); const mr = !filtroRol || u.rol === filtroRol; return ms && mr; });
        tbody.innerHTML = filtrados.length > 0 ? filtrados.map(u => { const fam = familiasData.find(f => f.id === u.familiaId); return `<tr><td><div class="table-user"><div class="table-avatar">${(u.nombre||u.email||'?').charAt(0).toUpperCase()}</div><div><div class="table-user-name">${u.nombre||'Sin nombre'}</div><div class="table-user-email">${u.email||''}</div></div></div></td><td><span class="badge badge-role ${(u.rol||'miembro').toLowerCase()}">${u.rol||'Miembro'}</span></td><td>${fam?.nombre||'-'}</td><td>${formatFecha(u.fechaCreacion)}</td><td><button class="btn btn-sm btn-secondary" onclick="verUsuario('${u.id}')">âœï¸</button></td></tr>`; }).join('') : '<tr><td colspan="5" class="empty-state">No hay usuarios</td></tr>';
      } catch (e) { tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Error</td></tr>'; }
    }

    function verUsuario(uid) {
      const u = usuariosData.find(x => x.id === uid); if (!u) return;
      editingUserId = uid;
      document.getElementById('modal-usuario-body').innerHTML = `<div class="form-group"><label class="form-label">Nombre</label><input type="text" class="form-input" id="edit-user-nombre" value="${u.nombre||''}"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" value="${u.email||''}" disabled></div><div class="form-group"><label class="form-label">Rol</label><select class="form-select" id="edit-user-rol"><option value="Miembro" ${u.rol==='Miembro'?'selected':''}>Miembro</option><option value="AdminNido" ${u.rol==='AdminNido'?'selected':''}>AdminNido</option><option value="AdminRama" ${u.rol==='AdminRama'?'selected':''}>AdminRama</option><option value="AdminSistema" ${u.rol==='AdminSistema'?'selected':''}>AdminSistema</option></select></div>`;
      document.getElementById('modal-usuario').classList.add('active');
    }

    async function guardarUsuario() {
      if (!editingUserId) return;
      try { await db.collection('usuarios').doc(editingUserId).update({ nombre: document.getElementById('edit-user-nombre').value, rol: document.getElementById('edit-user-rol').value }); cerrarModales(); usuariosData = []; cargarUsuarios(); alert('âœ… Guardado'); } catch (e) { alert('Error: ' + e.message); }
    }

    async function cargarFamilias() {
      const tbody = document.getElementById('tabla-familias');
      try {
        if (!familiasData.length) { const snap = await db.collection('familias').get(); familiasData = snap.docs.map(d => ({ id: d.id, ...d.data() })); }
        const search = document.getElementById('search-familias').value.toLowerCase();
        const ahora = new Date();
        let filtradas = familiasData.filter(f => !search || (f.nombre||'').toLowerCase().includes(search));
        tbody.innerHTML = filtradas.length > 0 ? filtradas.map(f => { const miembros = usuariosData.filter(u => u.familiaId === f.id).length; const addons = f.addons || {}; const cr = addons.crearRama?.activo || (addons.crearRama?.trialHasta && new Date(addons.crearRama.trialHasta) > ahora); const my = addons.mayordomo?.activo || (addons.mayordomo?.trialHasta && new Date(addons.mayordomo.trialHasta) > ahora); return `<tr><td style="font-weight:600;">${f.nombre||'Sin nombre'}</td><td><span class="badge badge-neutral">${(f.plan||'free').toUpperCase()}</span></td><td>${miembros}</td><td>${cr?'ğŸŒ³':''} ${my?'ğŸ©':''} ${!cr&&!my?'-':''}</td><td>${formatFecha(f.fechaCreacion)}</td><td><button class="btn btn-sm btn-secondary" onclick="verFamilia('${f.id}')">âœï¸</button></td></tr>`; }).join('') : '<tr><td colspan="6" class="empty-state">No hay familias</td></tr>';
      } catch (e) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Error</td></tr>'; }
    }

    function abrirModalNuevaFamilia() {
      editingFamiliaId = null;
      document.getElementById('modal-familia-titulo').textContent = 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Nueva familia';
      document.getElementById('modal-familia-body').innerHTML = `<div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="edit-fam-nombre" placeholder="Familia GarcÃ­a"></div><div class="form-group"><label class="form-label">Apellido principal</label><input type="text" class="form-input" id="edit-fam-apellido" placeholder="GarcÃ­a"></div><div class="form-group"><label class="form-label">Email admin *</label><input type="email" class="form-input" id="edit-fam-admin-email" placeholder="admin@ejemplo.com"><div class="form-hint">Se enviarÃ¡ invitaciÃ³n</div></div>`;
      document.getElementById('modal-familia').classList.add('active');
    }

    function verFamilia(fid) {
      const f = familiasData.find(x => x.id === fid); if (!f) return;
      editingFamiliaId = fid; const addons = f.addons || {}; const limites = f.limites || {}; const ahora = new Date();
      const crActivo = addons.crearRama?.activo || (addons.crearRama?.trialHasta && new Date(addons.crearRama.trialHasta) > ahora);
      const myActivo = addons.mayordomo?.activo || (addons.mayordomo?.trialHasta && new Date(addons.mayordomo.trialHasta) > ahora);
      document.getElementById('modal-familia-titulo').textContent = 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Editar familia';
      document.getElementById('modal-familia-body').innerHTML = `<div class="form-group"><label class="form-label">Nombre</label><input type="text" class="form-input" id="edit-fam-nombre" value="${f.nombre||''}"></div><div class="form-group"><label class="form-label">Plan</label><select class="form-select" id="edit-fam-plan"><option value="free" ${!f.plan||f.plan==='free'?'selected':''}>FREE</option></select></div><div class="divider"></div><h4 style="margin-bottom:12px;font-size:0.85rem;">âš¡ Add-ons</h4><div class="form-group"><label class="form-check"><input type="checkbox" id="edit-fam-cr" ${crActivo?'checked':''}> ğŸŒ³ Crear Rama</label></div><div class="form-group"><label class="form-check"><input type="checkbox" id="edit-fam-my" ${myActivo?'checked':''}> ğŸ© Mayordomo</label></div><div class="divider"></div><h4 style="margin-bottom:12px;font-size:0.85rem;">ğŸ“Š LÃ­mites</h4><div class="form-row"><div class="form-group"><label class="form-label">Generaciones</label><input type="number" class="form-input" id="edit-fam-gen" value="${limites.generaciones||2}"></div><div class="form-group"><label class="form-label">ImÃ¡genes</label><input type="number" class="form-input" id="edit-fam-img" value="${limites.imagenes||200}"></div></div>`;
      document.getElementById('modal-familia').classList.add('active');
    }

    async function guardarFamilia() {
      try {
        if (editingFamiliaId) {
          const crChecked = document.getElementById('edit-fam-cr').checked;
          const myChecked = document.getElementById('edit-fam-my').checked;
          const familia = familiasData.find(f => f.id === editingFamiliaId);
          const updateData = { nombre: document.getElementById('edit-fam-nombre').value, plan: document.getElementById('edit-fam-plan').value, 'addons.crearRama.activo': crChecked, 'addons.mayordomo.activo': myChecked, 'limites.generaciones': parseInt(document.getElementById('edit-fam-gen').value)||2, 'limites.imagenes': parseInt(document.getElementById('edit-fam-img').value)||200 };
          if (crChecked && !familia?.addons?.crearRama?.trialHasta) { const t = new Date(); t.setDate(t.getDate()+14); updateData['addons.crearRama.trialHasta'] = t.toISOString(); }
          if (myChecked && !familia?.addons?.mayordomo?.trialHasta) { const t = new Date(); t.setDate(t.getDate()+14); updateData['addons.mayordomo.trialHasta'] = t.toISOString(); }
          await db.collection('familias').doc(editingFamiliaId).update(updateData);
          alert('âœ… Familia actualizada');
        } else {
          const nombre = document.getElementById('edit-fam-nombre').value;
          const apellido = document.getElementById('edit-fam-apellido').value;
          const adminEmail = document.getElementById('edit-fam-admin-email').value;
          if (!nombre || !adminEmail) { alert('Nombre y email obligatorios'); return; }
          const newFam = await db.collection('familias').add({ nombre, apellidoPrincipal: apellido, plan: 'free', addons: {}, limites: { generaciones: 2, imagenes: 200, imagenesUsadas: 0 }, fechaCreacion: firebase.firestore.FieldValue.serverTimestamp() });
          await db.collection('invitaciones-email').add({ email: adminEmail, familiaId: newFam.id, rol: 'AdminRama', estado: 'pendiente', fechaCreacion: firebase.firestore.FieldValue.serverTimestamp() });
          alert('âœ… Familia creada. InvitaciÃ³n enviada a ' + adminEmail);
        }
        cerrarModales(); familiasData = []; cargarFamilias();
      } catch (e) { alert('Error: ' + e.message); }
    }

    async function cargarNidos() {
      const tbody = document.getElementById('tabla-nidos');
      try {
        const snap = await db.collection('nidos').get(); nidosData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const search = document.getElementById('search-nidos').value.toLowerCase();
        let filtrados = nidosData.filter(n => !search || (n.nombre||'').toLowerCase().includes(search));
        const genLabels = { '1-bisabuelos': 'G1', '2-abuelos': 'G2', '3-padres': 'G3', '4-hijos': 'G4' };
        tbody.innerHTML = filtrados.length > 0 ? filtrados.map(n => { const fam = familiasData.find(f => f.id === n.familiaId); const miembros = n.miembrosData?.length || 0; return `<tr><td style="font-weight:600;">${n.nombre||'Sin nombre'}</td><td>${fam?.nombre||'-'}</td><td><span class="badge badge-info">${genLabels[n.generacion]||'-'}</span></td><td>${miembros}</td><td><button class="btn btn-sm btn-secondary">ğŸ‘ï¸</button></td></tr>`; }).join('') : '<tr><td colspan="5" class="empty-state">No hay nidos</td></tr>';
      } catch (e) { tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Error</td></tr>'; }
    }

    async function cargarInvitaciones() {
      const tbody = document.getElementById('tabla-invitaciones');
      try {
        const snap = await db.collection('invitaciones-email').orderBy('fechaCreacion', 'desc').limit(50).get();
        invitacionesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const filtro = document.getElementById('filter-inv-estado').value;
        let filtradas = invitacionesData; if (filtro) filtradas = filtradas.filter(i => i.estado === filtro);
        tbody.innerHTML = filtradas.length > 0 ? filtradas.map(inv => { const fam = familiasData.find(f => f.id === inv.familiaId); const estadoBadge = inv.estado==='pendiente'?'badge-warning':inv.estado==='aceptada'?'badge-success':'badge-error'; return `<tr><td>${inv.email||'-'}</td><td>${fam?.nombre||'-'}</td><td><span class="badge badge-info">${inv.rol||'Miembro'}</span></td><td><span class="badge ${estadoBadge}">${inv.estado||'pendiente'}</span></td><td>${formatFecha(inv.fechaCreacion)}</td><td>${inv.estado==='pendiente'?`<button class="btn btn-sm btn-secondary" onclick="reenviarInvitacion('${inv.id}')">ğŸ“¤</button> <button class="btn btn-sm btn-danger" onclick="cancelarInvitacion('${inv.id}')">âœ•</button>`:'-'}</td></tr>`; }).join('') : '<tr><td colspan="6" class="empty-state">No hay invitaciones</td></tr>';
      } catch (e) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Error</td></tr>'; }
    }

    function abrirModalNuevaInvitacion() {
      document.getElementById('modal-invitacion-body').innerHTML = `<div class="form-group"><label class="form-label">Email *</label><input type="email" class="form-input" id="inv-email" placeholder="usuario@ejemplo.com"></div><div class="form-group"><label class="form-label">Familia *</label><select class="form-select" id="inv-familia"><option value="">Seleccionar...</option>${familiasData.map(f => `<option value="${f.id}">${f.nombre}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Rol</label><select class="form-select" id="inv-rol"><option value="Miembro">Miembro</option><option value="AdminNido">AdminNido</option><option value="AdminRama">AdminRama</option></select></div>`;
      document.getElementById('modal-invitacion').classList.add('active');
    }

    async function enviarInvitacion() {
      const email = document.getElementById('inv-email').value;
      const familiaId = document.getElementById('inv-familia').value;
      const rol = document.getElementById('inv-rol').value;
      if (!email || !familiaId) { alert('Email y familia obligatorios'); return; }
      try { await db.collection('invitaciones-email').add({ email, familiaId, rol, estado: 'pendiente', fechaCreacion: firebase.firestore.FieldValue.serverTimestamp() }); cerrarModales(); cargarInvitaciones(); alert('âœ… InvitaciÃ³n creada'); } catch (e) { alert('Error: ' + e.message); }
    }

    async function reenviarInvitacion(id) { alert('ğŸ“¤ Reenviar (TODO: EmailJS)'); }
    async function cancelarInvitacion(id) { if (!confirm('Â¿Cancelar?')) return; try { await db.collection('invitaciones-email').doc(id).update({ estado: 'cancelada' }); cargarInvitaciones(); } catch (e) { alert('Error'); } }

    async function cargarAddons() {
      const tbody = document.getElementById('tabla-addons');
      const ahora = new Date(); let crCount = 0, myCount = 0, trialCount = 0;
      tbody.innerHTML = familiasData.map(f => { const addons = f.addons || {}; const cr = addons.crearRama || {}; const crActivo = cr.activo || (cr.trialHasta && new Date(cr.trialHasta) > ahora); const crTrial = cr.trialHasta && new Date(cr.trialHasta) > ahora; const my = addons.mayordomo || {}; const myActivo = my.activo || (my.trialHasta && new Date(my.trialHasta) > ahora); const myTrial = my.trialHasta && new Date(my.trialHasta) > ahora; if (crActivo) crCount++; if (myActivo) myCount++; if (crTrial) trialCount++; if (myTrial) trialCount++; return `<tr><td style="font-weight:600;">${f.nombre}</td><td><span class="badge ${crActivo?(crTrial?'badge-warning':'badge-success'):'badge-neutral'}">${crActivo?(crTrial?'Trial':'Activo'):'No'}</span></td><td><span class="badge ${myActivo?(myTrial?'badge-warning':'badge-success'):'badge-neutral'}">${myActivo?(myTrial?'Trial':'Activo'):'No'}</span></td><td><button class="btn btn-sm btn-secondary" onclick="verFamilia('${f.id}')">âš™ï¸</button></td></tr>`; }).join('');
      document.getElementById('stat-crear-rama').textContent = crCount;
      document.getElementById('stat-mayordomo').textContent = myCount;
      document.getElementById('stat-trials').textContent = trialCount;
    }

    async function guardarEstructura() { try { await db.collection('config').doc('sistema').set({ arbol: { generacionesFree: parseInt(document.getElementById('config-gen-free').value), generacionesPremium: parseInt(document.getElementById('config-gen-premium').value), miembrosNido: parseInt(document.getElementById('config-miembros-nido').value) }, imagenes: { limiteFree: parseInt(document.getElementById('config-img-free').value), limitePremium: parseInt(document.getElementById('config-img-premium').value), tamanoMax: parseInt(document.getElementById('config-img-size').value) }, loComun: { bienesFree: parseInt(document.getElementById('config-bienes-free').value), bienesPremium: parseInt(document.getElementById('config-bienes-premium').value) }, trial: { dias: parseInt(document.getElementById('config-trial-dias').value), avisoAntes: parseInt(document.getElementById('config-trial-aviso').value) }, invitaciones: { expiraDias: parseInt(document.getElementById('config-inv-expira').value), maxReenvios: parseInt(document.getElementById('config-inv-reenvios').value) }, legado: { elementosFree: parseInt(document.getElementById('config-legado-free').value), elementosPremium: parseInt(document.getElementById('config-legado-premium').value) } }, { merge: true }); alert('âœ… Guardado'); } catch (e) { alert('Error: ' + e.message); } }

    function guardarPlanes() { alert('âœ… Planes guardados'); }

    function editarServicio(s) {
      document.getElementById('modal-servicio-titulo').textContent = `ğŸ”Œ ${s}`;
      let c = '';
      if (s === 'firebase') c = `<div class="form-group"><label class="form-label">Project ID</label><input type="text" class="form-input" value="familynk-xxxxx"></div><div class="form-group"><label class="form-label">API Key</label><input type="text" class="form-input" value="AIza..."></div>`;
      else if (s === 'emailjs') c = `<div class="form-group"><label class="form-label">Service ID</label><input type="text" class="form-input" value="service_fcfx5od"></div><div class="form-group"><label class="form-label">Template ID</label><input type="text" class="form-input" value="template_my2n26t"></div><div class="form-group"><label class="form-label">Public Key</label><input type="text" class="form-input" value="eWMtiJpUqrLsA5Nel"></div>`;
      else if (s === 'stripe') c = `<div class="form-group"><label class="form-label">Publishable Key</label><input type="text" class="form-input" placeholder="pk_live_..."></div><div class="form-group"><label class="form-label">Secret Key</label><input type="password" class="form-input" placeholder="sk_live_..."></div>`;
      else c = '<p class="text-muted">ConfiguraciÃ³n</p>';
      document.getElementById('modal-servicio-body').innerHTML = c;
      document.getElementById('modal-servicio').classList.add('active');
    }

    function guardarServicio() { cerrarModales(); alert('âœ… Servicio actualizado'); }

    function exportarUsuarios() { const csv = 'Nombre,Email,Rol,FamiliaID\n' + usuariosData.map(u => `"${u.nombre||''}","${u.email||''}","${u.rol||''}","${u.familiaId||''}"`).join('\n'); descargarCSV(csv, 'usuarios.csv'); }
    function exportarFamilias() { const csv = 'Nombre,Plan,ID\n' + familiasData.map(f => `"${f.nombre||''}","${f.plan||'free'}","${f.id}"`).join('\n'); descargarCSV(csv, 'familias.csv'); }
    function descargarCSV(c, n) { const b = new Blob([c], { type: 'text/csv;charset=utf-8;' }); const l = document.createElement('a'); l.href = URL.createObjectURL(b); l.download = n; l.click(); }

    async function limpiarTrialsExpirados() {
      if (!confirm('Â¿Limpiar trials expirados?')) return;
      const ahora = new Date(); let limpiados = 0;
      for (const f of familiasData) { const addons = f.addons || {}; let nu = false; const ud = {};
        if (addons.crearRama?.trialHasta && new Date(addons.crearRama.trialHasta) < ahora) { ud['addons.crearRama.activo'] = false; nu = true; }
        if (addons.mayordomo?.trialHasta && new Date(addons.mayordomo.trialHasta) < ahora) { ud['addons.mayordomo.activo'] = false; nu = true; }
        if (nu) { await db.collection('familias').doc(f.id).update(ud); limpiados++; }
      }
      alert(`âœ… ${limpiados} trials limpiados`); familiasData = []; cargarDashboard();
    }

    function formatFecha(ts) { if (!ts) return '-'; const f = ts.toDate ? ts.toDate() : new Date(ts); return f.toLocaleDateString('es'); }
    function cerrarModales() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); editingUserId = null; editingFamiliaId = null; }
    document.querySelectorAll('.modal-overlay').forEach(m => { m.addEventListener('click', (e) => { if (e.target === m) cerrarModales(); }); });

    document.getElementById('search-usuarios')?.addEventListener('input', cargarUsuarios);
    document.getElementById('filter-rol')?.addEventListener('change', cargarUsuarios);
    document.getElementById('search-familias')?.addEventListener('input', cargarFamilias);
    document.getElementById('filter-plan')?.addEventListener('change', cargarFamilias);
    document.getElementById('search-nidos')?.addEventListener('input', cargarNidos);
    document.getElementById('filter-inv-estado')?.addEventListener('change', cargarInvitaciones);
  </script>
</body>
</html>
