<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Bien</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --capataz: #6B8E23;
      --capataz-light: #8FBC3C;
      --capataz-muted: rgba(107, 142, 35, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: var(--cream-dark); color: var(--text); }
    .header-actions { display: flex; gap: 8px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      color: white;
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
      border: 1px solid var(--cream-dark);
    }

    .btn-secondary:hover { background: var(--cream-dark); }

    .btn-mayordomo {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%);
      color: white;
    }

    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
    .btn-danger { background: var(--error); color: white; }

    .main { max-width: 1200px; margin: 0 auto; padding: 24px; }

    .layout-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    @media (max-width: 600px) { .layout-grid { grid-template-columns: 1fr; } }

    .bien-hero {
      background: var(--white);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }

    .bien-hero-image {
      height: 100px;
      background: linear-gradient(135deg, var(--sage-light) 0%, var(--sage) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      position: relative;
    }

    .bien-hero-image img { width: 100%; height: 100%; object-fit: cover; }

    .bien-hero-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: var(--mayordomo);
      color: white;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 700;
    }

    .bien-hero-badge.gerente { background: #4A5568; }
    .bien-hero-badge.capataz { background: var(--capataz); }

    .bien-hero-body {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .bien-hero-main {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 200px;
    }

    .bien-tipo-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: white;
      font-weight: 700;
      background: var(--sage-dark);
      padding: 3px 8px;
      border-radius: var(--radius-sm);
    }

    .bien-nombre {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .bien-hero-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .bien-hero-meta span { display: flex; align-items: center; gap: 4px; }
    .bien-hero-meta strong { color: var(--text); font-weight: 600; }

    /* ============ GESTI√ìN CARDS (Mayordomo / Gerente / Capataz) ============ */
    .gestion-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) {
      .gestion-cards { 
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
      .gestion-card-header {
        padding: 10px;
      }
      .gestion-card-title {
        font-size: 0.75rem;
        gap: 4px;
      }
      .gestion-card-status {
        display: none;
      }
      .gestion-card-body {
        padding: 10px;
      }
      .gestion-card-desc {
        display: none;
      }
      .gestion-card-action {
        width: 100%;
        justify-content: center;
        padding: 6px 10px;
        font-size: 0.7rem;
      }
    }

    .gestion-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      transition: all 0.3s;
      cursor: pointer;
    }

    .gestion-card.disabled {
      opacity: 0.5;
      filter: grayscale(1);
    }

    .gestion-card.active {
      box-shadow: var(--shadow-medium);
    }

    .gestion-card-header {
      padding: 16px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .gestion-card-header.mayordomo {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%);
    }

    .gestion-card-header.gerente {
      background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
    }

    .gestion-card-header.capataz {
      background: linear-gradient(135deg, var(--capataz) 0%, var(--capataz-light) 100%);
    }

    .gestion-card.disabled .gestion-card-header {
      background: linear-gradient(135deg, #9A9A9A 0%, #7A7A7A 100%);
    }

    .gestion-card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
    }

    .gestion-card-status {
      font-size: 0.7rem;
      padding: 3px 8px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-full);
    }

    .gestion-card-body {
      padding: 16px;
    }

    .gestion-card-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .gestion-card-action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .gestion-card-action:hover {
      background: var(--cream-dark);
    }

    .gestion-card-action.primary {
      background: var(--sage);
      color: white;
    }

    .gestion-card-action.primary:hover {
      background: var(--sage-dark);
    }

    /* M√≥dulos activos */
    .gestion-modulos {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }

    .gestion-modulos-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .gestion-modulos-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .gestion-modulos-title.mayordomo { color: var(--mayordomo); }
    .gestion-modulos-title.gerente { color: #4A5568; }
    .gestion-modulos-title.capataz { color: var(--capataz); }

    .modulos-botones {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn-modulo-activo {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--mayordomo);
      color: white;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s;
      box-shadow: var(--shadow-soft);
    }

    .btn-modulo-activo:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-float);
    }

    .btn-modulo-activo.gerente {
      background: #4A5568;
    }

    .btn-modulo-activo.gerente:hover {
      background: #2D3748;
    }

    .btn-modulo-activo.capataz {
      background: var(--capataz);
    }

    .btn-modulo-activo.capataz:hover {
      background: var(--capataz-light);
    }

    /* Modal configuraci√≥n m√≥dulos */
    .modulos-config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      max-height: 60vh;
      overflow-y: auto;
      padding: 4px;
    }

    .modulo-config-card {
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .modulo-config-card:hover {
      border-color: var(--sage-light);
      transform: translateY(-2px);
    }

    .modulo-config-card.activo {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .modulo-config-card.activo.gerente {
      border-color: #4A5568;
      background: rgba(74, 85, 104, 0.1);
    }

    .modulo-config-icon {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }

    .modulo-config-nombre {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .modulo-config-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .modulo-config-check {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: transparent;
    }

    .modulo-config-card.activo .modulo-config-check {
      background: var(--sage);
      color: white;
    }

    .modulo-config-card.activo.gerente .modulo-config-check {
      background: #4A5568;
    }

    .modulo-config-card.activo.capataz {
      border-color: var(--capataz);
      background: rgba(139, 115, 85, 0.1);
    }

    .modulo-config-card.activo.capataz .modulo-config-check {
      background: var(--capataz);
    }

    .btn-desactivar-gestion {
      padding: 8px 14px;
      background: transparent;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-desactivar-gestion:hover {
      background: #FFEBEE;
      border-color: #FFCDD2;
      color: var(--error);
    }

    @media (max-width: 600px) {
      .bien-hero-body { flex-direction: column; align-items: flex-start; gap: 8px; }
      .bien-hero-meta { flex-wrap: wrap; gap: 8px; }
    }

    .collapsible-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .collapsible-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }

    .collapsible-header:hover { background: var(--cream-medium); }

    .collapsible-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .collapsible-count {
      font-size: 0.75rem;
      background: var(--sage-muted);
      color: var(--sage-dark);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .collapsible-toggle {
      font-size: 1.2rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .collapsible-section.open .collapsible-toggle { transform: rotate(180deg); }
    .collapsible-body { padding: 0 20px 20px; display: none; }
    .collapsible-section.open .collapsible-body { display: block; }

    .info-list { display: flex; flex-direction: column; gap: 8px; }

    .info-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .info-item-icon { font-size: 1.3rem; }
    .info-item-content { flex: 1; }
    .info-item-title { font-weight: 600; font-size: 0.9rem; }
    .info-item-subtitle { font-size: 0.75rem; color: var(--text-muted); }

    .info-item-action {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      opacity: 0.5;
      padding: 4px;
      text-decoration: none;
    }

    .info-item-action:hover { opacity: 1; }

    .normas-box {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-line;
    }

    /* Responsive para hero y gesti√≥n */
    @media (max-width: 768px) {
      .bien-hero-image {
        height: 80px;
      }
      }

      .bien-nombre {
        font-size: 1.2rem;
      }
    }

    /* TABLET: Vista intermedia */
    @media (min-width: 769px) and (max-width: 1024px) {
      .modulos-botones {
        gap: 8px;
      }

      .btn-modulo-activo {
        padding: 10px 14px;
        font-size: 0.82rem;
      }
    }

    .modulo-panel {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .modulo-panel-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--cream-dark);
    }

    .modulo-panel-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modulo-panel-body { padding: 16px 20px; }

    /* CALENDARIO */
    .calendario-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .calendario-mes {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
    }

    .calendario-nav-btns { display: flex; gap: 4px; }

    .calendario-nav-btn {
      background: var(--cream);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1rem;
    }

    .calendario-nav-btn:hover { background: var(--cream-dark); }

    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .calendario-dia-header {
      text-align: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .calendario-dia {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
      min-height: 28px;
    }

    .calendario-dia:hover { background: var(--cream-dark); }
    .calendario-dia.otro-mes { color: var(--text-muted); opacity: 0.5; }
    .calendario-dia.hoy { background: var(--sage-muted); font-weight: 700; }
    .calendario-dia.reservado { background: var(--sage); color: white; }
    /* Colores por tipo de reserva - se generan din√°micamente */
    .calendario-dia.reservado { color: white; }

    .reservas-lista { margin-top: 16px; }

    .reservas-lista-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .reserva-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      border-left: 4px solid var(--sage);
      cursor: pointer;
      transition: all 0.2s;
    }

    .reserva-item:hover { background: var(--cream-dark); }
    /* Bordes lista reservas - se generan din√°micamente */

    .reserva-fecha { text-align: center; min-width: 50px; }
    .reserva-fecha-dia { font-size: 1.3rem; font-weight: 700; color: var(--sage-dark); }
    .reserva-fecha-mes { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); }
    .reserva-info { flex: 1; }
    .reserva-quien { font-weight: 600; font-size: 0.9rem; }
    .reserva-periodo { font-size: 0.75rem; color: var(--text-muted); }

    .nidos-leyenda {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--cream-dark);
    }

    .nido-leyenda-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; }
    .nido-leyenda-color { width: 12px; height: 12px; border-radius: 3px; }

    /* Otros m√≥dulos */
    .inventario-alerta {
      background: var(--warning);
      color: white;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      margin-bottom: 12px;
    }

    .inventario-list, .mantenimiento-list, .gastos-list, .servicios-list, .eventos-list, .limpieza-checklist {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .inventario-item, .mantenimiento-item, .gasto-item, .servicio-item, .evento-item, .limpieza-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .inventario-item.bajo { border-left: 3px solid var(--error); }
    .inventario-item-nombre, .servicio-nombre { flex: 1; font-size: 0.9rem; }
    .inventario-item-stock { font-size: 0.8rem; color: var(--text-muted); }
    .inventario-item-stock.bajo { color: var(--error); font-weight: 600; }

    .mantenimiento-tipo, .evento-icono, .servicio-icono { font-size: 1.3rem; }
    .mantenimiento-info, .evento-info { flex: 1; }
    .mantenimiento-titulo, .evento-nombre { font-weight: 600; font-size: 0.9rem; }
    .mantenimiento-fecha, .evento-fecha { font-size: 0.75rem; color: var(--text-muted); }

    .mantenimiento-badge, .evento-tipo {
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .mantenimiento-badge.programado { background: var(--sage-muted); color: var(--sage-dark); }
    .mantenimiento-badge.pendiente { background: var(--warning); color: white; }
    .evento-tipo { background: var(--terracotta-muted); color: var(--terracotta); }

    .limpieza-item { cursor: pointer; transition: all 0.2s; }
    .limpieza-item:hover { background: var(--cream-dark); }
    .limpieza-item.done { opacity: 0.5; }
    .limpieza-item.done .limpieza-texto { text-decoration: line-through; }

    .limpieza-check {
      width: 22px;
      height: 22px;
      border: 2px solid var(--sage);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: white;
    }

    .limpieza-item.done .limpieza-check { background: var(--sage); }
    .limpieza-texto { font-size: 0.9rem; }

    .gastos-resumen {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .gasto-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .gasto-stat-valor { font-size: 1.5rem; font-weight: 700; color: var(--sage-dark); }
    .gasto-stat-label { font-size: 0.75rem; color: var(--text-muted); }
    .gasto-item-nombre { flex: 1; font-size: 0.9rem; }
    .gasto-item-valor { font-weight: 600; color: var(--terracotta); }

    /* Gastos mejorado */
    .gastos-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--cream-dark);
    }

    .gastos-tab {
      padding: 10px 16px;
      background: none;
      border: none;
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .gastos-tab:hover { color: var(--text); }
    .gastos-tab.active { color: var(--terracotta); border-bottom-color: var(--terracotta); }

    .gastos-tab-content { display: none; }
    .gastos-tab-content.active { display: block; }

    .gastos-periodo-selector {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .gastos-periodo-btn {
      padding: 6px 12px;
      background: var(--cream-medium);
      border: none;
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gastos-periodo-btn:hover { background: var(--cream-dark); }
    .gastos-periodo-btn.active { background: var(--terracotta); color: white; }

    .gastos-resumen {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .gasto-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .gasto-stat-valor { font-size: 1.5rem; font-weight: 700; color: var(--terracotta); }
    .gasto-stat-label { font-size: 0.7rem; color: var(--text-muted); }

    .gastos-por-categoria {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .gasto-cat-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--cream-medium);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
    }

    .gasto-cat-chip-valor { font-weight: 700; color: var(--terracotta); }

    .gastos-list { display: flex; flex-direction: column; gap: 8px; }

    /* Reparto de gastos */
    .reparto-section { margin-top: 16px; padding: 16px; background: var(--cream); border-radius: var(--radius-md); }
    .reparto-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .reparto-miembros { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
    .reparto-miembro { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--white); border-radius: var(--radius-sm); transition: all 0.2s; }
    .reparto-miembro.selected { background: var(--sage-muted); }
    .reparto-miembro-check { width: 18px; height: 18px; cursor: pointer; accent-color: var(--sage); }
    .reparto-miembro-info { flex: 1; }
    .reparto-miembro-nombre { font-weight: 600; font-size: 0.85rem; }
    .reparto-miembro-nido { font-size: 0.7rem; color: var(--text-muted); }
    .reparto-miembro-pct { width: 70px; display: flex; align-items: center; gap: 2px; }
    .reparto-miembro-pct input { width: 50px; padding: 4px 6px; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm); text-align: right; font-size: 0.8rem; }
    .reparto-miembro-pct input:focus { outline: none; border-color: var(--sage); }
    .reparto-miembro-pct input:disabled { background: var(--cream-dark); color: var(--text-muted); }
    .reparto-miembro-importe { min-width: 70px; text-align: right; font-weight: 600; font-size: 0.85rem; color: var(--sage-dark); }
    .reparto-total { display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--cream-dark); font-weight: 600; }
    .reparto-total.error #reparto-pct-total { color: var(--error); }
    .reparto-warning { margin-top: 8px; padding: 8px; background: rgba(232,180,77,0.15); border-radius: var(--radius-sm); color: var(--warning); font-size: 0.8rem; text-align: center; }

    /* Preview reparto */
    .preview-header { text-align: center; padding-bottom: 16px; border-bottom: 1px solid var(--cream-dark); margin-bottom: 16px; }
    .preview-concepto { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; }
    .preview-total { font-size: 1.4rem; font-weight: 700; color: var(--sage-dark); }
    .preview-lista { display: flex; flex-direction: column; gap: 8px; }
    .preview-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--cream); border-radius: var(--radius-sm); }
    .preview-nombre { font-weight: 600; font-size: 0.9rem; }
    .preview-importe { font-weight: 700; color: var(--mayordomo); }
    .preview-pct { font-size: 0.75rem; color: var(--text-muted); margin-left: 6px; }

    .gasto-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .gasto-item:hover { background: var(--cream-dark); }

    .gasto-item-icon { font-size: 1.3rem; }

    .gasto-item-info { flex: 1; }
    .gasto-item-concepto { font-weight: 600; font-size: 0.9rem; }
    .gasto-item-meta { font-size: 0.7rem; color: var(--text-muted); }

    .gasto-item-importe {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--terracotta);
    }

    .gasto-item-generador {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: var(--mayordomo-muted);
      color: var(--mayordomo);
      border-radius: var(--radius-sm);
    }

    /* Tabla de reparto */
    .reparto-info {
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      padding: 12px;
      margin-bottom: 16px;
      font-size: 0.8rem;
      color: var(--sage-dark);
    }

    .reparto-table {
      width: 100%;
      border-collapse: collapse;
    }

    .reparto-table th {
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 12px;
      border-bottom: 2px solid var(--cream-dark);
    }

    .reparto-table td {
      padding: 12px;
      border-bottom: 1px solid var(--cream-dark);
      font-size: 0.9rem;
    }

    .reparto-table tr:last-child td { border-bottom: none; }

    .reparto-nido-nombre {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .reparto-nido-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .reparto-input {
      width: 70px;
      padding: 6px 10px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      text-align: right;
    }

    .reparto-input:focus {
      outline: none;
      border-color: var(--sage);
    }

    .reparto-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-top: 12px;
    }

    .reparto-total-label { font-weight: 600; }
    .reparto-total-valor { font-size: 1.1rem; font-weight: 700; }
    .reparto-total-valor.ok { color: var(--success); }
    .reparto-total-valor.error { color: var(--error); }

    .reparto-desglose {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--cream-dark);
    }

    .reparto-desglose-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .reparto-desglose-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 0.85rem;
    }

    .reparto-desglose-item span:last-child { font-weight: 600; color: var(--terracotta); }

    /* Caseros */
    .caseros-list { display: flex; flex-direction: column; gap: 10px; }

    .casero-card {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .casero-card:hover { background: var(--cream-dark); }

    .casero-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .casero-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--mayordomo);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
    }

    .casero-info { flex: 1; }
    .casero-nombre { font-weight: 600; font-size: 0.95rem; }
    .casero-email { font-size: 0.75rem; color: var(--text-muted); }

    .casero-permisos {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .casero-permiso-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: var(--sage-muted);
      color: var(--sage-dark);
      border-radius: var(--radius-sm);
    }

    .casero-permiso-badge.limitado {
      background: var(--terracotta-muted);
      color: var(--terracotta);
    }

    /* Matriz permisos en modal */
    .permisos-matrix {
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .permisos-matrix-header {
      display: grid;
      grid-template-columns: 1fr repeat(4, 40px);
      gap: 4px;
      padding: 10px 12px;
      background: var(--cream-dark);
      font-size: 0.7rem;
      font-weight: 600;
      text-align: center;
    }

    .permisos-matrix-header span:first-child { text-align: left; }

    .permisos-matrix-row {
      display: grid;
      grid-template-columns: 1fr repeat(4, 40px);
      gap: 4px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--cream-dark);
      align-items: center;
    }

    .permisos-matrix-row:last-child { border-bottom: none; }

    .permisos-matrix-row label {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .permisos-matrix-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--sage);
    }

    .permisos-matrix-check {
      display: flex;
      justify-content: center;
    }

    /* Cat√°logo de Ajuar */
    .ajuar-grupos { display: flex; flex-direction: column; gap: 10px; }
    
    .ajuar-grupo {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    
    .ajuar-grupo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .ajuar-grupo-header:hover { background: var(--cream-dark); }
    
    .ajuar-grupo-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .ajuar-grupo-icon {
      width: 32px;
      height: 32px;
      background: var(--sage-muted);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    
    .ajuar-grupo-nombre { font-weight: 600; font-size: 0.9rem; }
    .ajuar-grupo-count { font-size: 0.75rem; color: var(--text-muted); }
    .ajuar-grupo-toggle { color: var(--text-muted); transition: transform 0.2s; }
    .ajuar-grupo.open .ajuar-grupo-toggle { transform: rotate(180deg); }
    
    .ajuar-grupo-body {
      display: none;
      padding: 0 14px 14px;
    }
    
    .ajuar-grupo.open .ajuar-grupo-body { display: block; }
    
    .ajuar-articulos { display: flex; flex-direction: column; gap: 8px; }
    
    .ajuar-articulo {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--white);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ajuar-articulo:hover { background: var(--sage-muted); }
    
    .ajuar-articulo-thumb {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      background: var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .ajuar-articulo-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .ajuar-articulo-info { flex: 1; min-width: 0; }
    .ajuar-articulo-nombre { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ajuar-articulo-desc { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .ajuar-btn-add {
      margin-top: 8px;
      padding: 8px;
      background: var(--sage-muted);
      border: 1px dashed var(--sage);
      border-radius: var(--radius-sm);
      color: var(--sage-dark);
      font-size: 0.8rem;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    
    .ajuar-btn-add:hover { background: var(--sage); color: white; border-style: solid; }

    /* Inventario mejorado */
    .inventario-categorias {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .inventario-cat-btn {
      padding: 6px 12px;
      background: var(--cream-medium);
      border: none;
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .inventario-cat-btn:hover { background: var(--cream-dark); }
    .inventario-cat-btn.active { background: var(--sage); color: white; }

    .inventario-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .inventario-item:hover { background: var(--cream-dark); }
    .inventario-item.bajo { border-left: 3px solid var(--error); }
    .inventario-item.ok { border-left: 3px solid var(--success); }

    .inventario-item-icon { font-size: 1.3rem; }

    .inventario-item-info { flex: 1; }
    .inventario-item-nombre { font-weight: 600; font-size: 0.9rem; }
    .inventario-item-meta { font-size: 0.7rem; color: var(--text-muted); }

    .inventario-item-stock {
      text-align: right;
      min-width: 60px;
    }

    .inventario-item-cantidad {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .inventario-item-cantidad.bajo { color: var(--error); }
    .inventario-item-cantidad.ok { color: var(--success); }

    .inventario-item-minimo {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .inventario-quick-btns {
      display: flex;
      gap: 4px;
      margin-left: 8px;
    }

    .inventario-quick-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .inventario-quick-btn.menos {
      background: var(--terracotta-muted);
      color: var(--terracotta);
    }

    .inventario-quick-btn.mas {
      background: var(--sage-muted);
      color: var(--sage-dark);
    }

    .inventario-quick-btn:hover { transform: scale(1.1); }

    .inventario-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .inventario-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 12px;
      text-align: center;
    }

    .inventario-stat-valor {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .inventario-stat-valor.alerta { color: var(--error); }
    .inventario-stat-label { font-size: 0.65rem; color: var(--text-muted); }

    /* Sidebar m√≥dulos */
    .sidebar-modulo-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; padding: 4px 0; color: var(--text-muted); }
    .sidebar-modulo-item.activo { color: var(--text); font-weight: 600; }
    .smod-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--cream-dark); }
    .sidebar-modulo-item.activo .smod-dot { background: var(--success); }

    .sidebar { display: flex; flex-direction: column; gap: 16px; }

    .empty-mini {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .empty-mini-icon { font-size: 2rem; opacity: 0.3; margin-bottom: 8px; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 24px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 450px;
      transform: translateY(20px);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal { transform: translateY(0); }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .modal-close {
      background: var(--cream);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .modal-close:hover { background: var(--cream-dark); }
    .modal-body { padding: 24px; }

    .modal-footer {
      padding: 0 24px 24px;
      display: flex;
      gap: 12px;
      justify-content: space-between;
    }

    .form-group { margin-bottom: 16px; }
    .form-group:last-child { margin-bottom: 0; }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
      transition: all 0.2s;
      background: var(--white);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--sage);
      box-shadow: 0 0 0 3px var(--sage-muted);
    }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="lo-comun.html" class="back-btn"><span>‚Üê</span><span>Lo Com√∫n</span></a>
    </div>
    <div class="header-actions">
      <a href="#" class="btn btn-mayordomo btn-sm hidden" id="btn-abrir-mayordomo">üé© Abrir Mayordomo</a>
      <button class="btn btn-secondary btn-sm" id="btn-editar">‚úèÔ∏è Editar</button>
    </div>
  </header>

  <main class="main">
    <div id="page-loading" class="loading"><div class="spinner"></div></div>

    <div id="page-content" class="hidden">
      <!-- Hero compacto -->
      <div class="bien-hero">
        <div class="bien-hero-image" id="bien-hero-image">üè†</div>
        <div class="bien-hero-body">
          <div class="bien-hero-main">
            <span class="bien-tipo-label" id="bien-tipo">Inmueble</span>
            <h1 class="bien-nombre" id="bien-nombre">Cargando...</h1>
          </div>
          <div class="bien-hero-meta">
            <span>üìç <span id="bien-ubicacion">-</span></span>
            <span><strong>Titular:</strong> <span id="bien-titularidad">-</span></span>
            <span><strong>Origen:</strong> <span id="bien-origen">-</span></span>
          </div>
        </div>
      </div>

      <!-- Cards Gesti√≥n: Mayordomo | Gerente | Capataz -->
      <div class="gestion-cards">
        <div class="gestion-card" id="card-mayordomo" onclick="toggleGestion('mayordomo')">
          <div class="gestion-card-header mayordomo">
            <div class="gestion-card-title">üé© Mayordomo</div>
            <span class="gestion-card-status" id="status-mayordomo">Inactivo</span>
          </div>
          <div class="gestion-card-body">
            <p class="gestion-card-desc">Gesti√≥n dom√©stica: reservas, inventario, gastos, limpieza...</p>
            <button class="gestion-card-action primary" id="btn-mayordomo">Activar</button>
          </div>
        </div>

        <div class="gestion-card disabled" id="card-gerente" onclick="toggleGestion('gerente')">
          <div class="gestion-card-header gerente">
            <div class="gestion-card-title">üíº Gerente</div>
            <span class="gestion-card-status" id="status-gerente">Inactivo</span>
          </div>
          <div class="gestion-card-body">
            <p class="gestion-card-desc">Gesti√≥n profesional: contratos, facturaci√≥n, inquilinos...</p>
            <button class="gestion-card-action primary" id="btn-gerente">Activar</button>
          </div>
        </div>

        <div class="gestion-card disabled" id="card-capataz" onclick="toggleGestion('capataz')">
          <div class="gestion-card-header capataz">
            <div class="gestion-card-title">üöú Capataz</div>
            <span class="gestion-card-status" id="status-capataz">Inactivo</span>
          </div>
          <div class="gestion-card-body">
            <p class="gestion-card-desc">Gesti√≥n rural: parcelas, cultivos, maquinaria, personal...</p>
            <button class="gestion-card-action primary" id="btn-capataz">Activar</button>
          </div>
        </div>
      </div>

      <!-- Panel de m√≥dulos (solo visible si hay gesti√≥n activa) -->
      <div class="gestion-modulos hidden" id="gestion-modulos">
        <div class="gestion-modulos-header">
          <div class="gestion-modulos-title" id="gestion-titulo">üé© M√≥dulos Mayordomo</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-secondary btn-sm" onclick="abrirConfigModulos()">‚öôÔ∏è Configurar m√≥dulos</button>
            <button class="btn-desactivar-gestion" onclick="desactivarGestion()">‚ùå Desactivar</button>
          </div>
        </div>
        <div class="modulos-botones" id="modulos-botones"></div>
      </div>

      <div class="layout-grid">
        <div class="sidebar">
          <!-- Galer√≠a -->
          <div class="collapsible-section open" id="section-galeria">
            <div class="collapsible-header" onclick="toggleSection('galeria')">
              <div class="collapsible-title"><span>üì∑</span><span>Galer√≠a</span><span class="collapsible-count" id="count-galeria">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div id="galeria-fotos" style="display:flex;gap:8px;overflow-x:auto;"><div class="empty-mini" style="padding:12px;">Sin fotos</div></div></div>
          </div>

          <div class="collapsible-section" id="section-personal">
            <div class="collapsible-header" onclick="toggleSection('personal')">
              <div class="collapsible-title"><span>üë∑</span><span>Refuerzos</span><span class="collapsible-count" id="count-personal">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;font-size:0.75rem;">
                <span style="padding:3px 8px;background:var(--cream);border-radius:12px;">üßπ Limpieza</span>
                <span style="padding:3px 8px;background:var(--cream);border-radius:12px;">üåø Jard√≠n</span>
                <span style="padding:3px 8px;background:var(--cream);border-radius:12px;">üîß Otros</span>
              </div>
              <div class="info-list" id="lista-personal"><div class="empty-mini">Sin refuerzos</div></div>
            </div>
          </div>

          <div class="collapsible-section" id="section-mascotas">
            <div class="collapsible-header" onclick="toggleSection('mascotas')">
              <div class="collapsible-title"><span>üêæ</span><span>Mascotas</span><span class="collapsible-count" id="count-mascotas">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-mascotas"><div class="empty-mini">Sin mascotas</div></div></div>
          </div>

          <div class="collapsible-section" id="section-contactos">
            <div class="collapsible-header" onclick="toggleSection('contactos')">
              <div class="collapsible-title"><span>üìû</span><span>Contactos</span><span class="collapsible-count" id="count-contactos">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-contactos"><div class="empty-mini">Sin contactos</div></div></div>
          </div>

          <div class="collapsible-section" id="section-documentos">
            <div class="collapsible-header" onclick="toggleSection('documentos')">
              <div class="collapsible-title"><span>üìÑ</span><span>Documentos</span><span class="collapsible-count" id="count-documentos">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-documentos"><div class="empty-mini">Sin documentos</div></div></div>
          </div>

          <!-- Cat√°logo de Ajuar (solo visible para tipo ajuar) -->
          <div class="collapsible-section open hidden" id="section-catalogo-ajuar">
            <div class="collapsible-header" onclick="toggleSection('catalogo-ajuar')">
              <div class="collapsible-title"><span>ü™ë</span><span>Cat√°logo</span><span class="collapsible-count" id="count-articulos-ajuar">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">Grupos y art√≠culos del ajuar familiar</p>
              <div class="ajuar-grupos" id="lista-grupos-ajuar">
                <div class="empty-mini">Sin grupos creados</div>
              </div>
              <button class="btn btn-secondary btn-sm" style="width:100%;margin-top:10px;" onclick="abrirModalGrupoAjuar()">+ A√±adir grupo</button>
            </div>
          </div>

          <div class="collapsible-section" id="section-normas">
            <div class="collapsible-header" onclick="toggleSection('normas')">
              <div class="collapsible-title"><span>üìú</span><span>Normas</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="normas-box" id="normas-texto">Sin normas definidas</div></div>
          </div>

          <div class="collapsible-section" id="section-caseros">
            <div class="collapsible-header" onclick="toggleSection('caseros')">
              <div class="collapsible-title"><span>üë§</span><span>Caseros</span><span class="collapsible-count" id="count-caseros">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="caseros-list" id="lista-caseros"><div class="empty-mini">Sin caseros asignados</div></div>
              <button class="btn btn-secondary btn-sm" style="width:100%;margin-top:10px;" onclick="abrirModalCasero()">+ A√±adir casero</button>
            </div>
          </div>

          <!-- Hosters (Gerente) -->
          <div class="collapsible-section hidden" id="section-hosters">
            <div class="collapsible-header" onclick="toggleSection('hosters')">
              <div class="collapsible-title"><span>üè®</span><span>Hosters</span><span class="collapsible-count" id="count-hosters">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">Personal de atenci√≥n a hu√©spedes e inquilinos</p>
              <div class="hosters-list" id="lista-hosters"><div class="empty-mini">Sin hosters asignados</div></div>
              <button class="btn btn-secondary btn-sm" style="width:100%;margin-top:10px;" onclick="abrirModalHoster()">+ A√±adir hoster</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Configurar M√≥dulos -->
  <div class="modal-overlay" id="modal-config-modulos">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header" id="modal-config-header">
        <h3 class="modal-title">‚öôÔ∏è Configurar M√≥dulos</h3>
        <button class="modal-close" onclick="cerrarConfigModulos()">√ó</button>
      </div>
      <div class="modal-body">
        <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px;">Selecciona los m√≥dulos que necesitas para gestionar este bien. Puedes activarlos o desactivarlos en cualquier momento.</p>
        <div class="modulos-config-grid" id="modulos-config-grid"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarConfigModulos()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Reserva -->
  <div class="modal-overlay" id="modal-reserva">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-reserva-title">üìÖ Nueva reserva</h3>
        <button class="modal-close" id="modal-reserva-close">√ó</button>
      </div>
      <form id="form-reserva">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¬øQui√©n reserva?</label>
            <select class="form-select" id="reserva-tipo" required>
              <option value="">Cargando...</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha inicio</label>
              <input type="date" class="form-input" id="reserva-inicio" required>
            </div>
            <div class="form-group">
              <label class="form-label">Fecha fin</label>
              <input type="date" class="form-input" id="reserva-fin" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Nota breve</label>
            <input type="text" class="form-input" id="reserva-notas" placeholder="Ej: Cumplea√±os abuelo, cacer√≠a oto√±o..." maxlength="50">
            <div class="form-hint">Se muestra al pasar el rat√≥n sobre la reserva</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-reserva">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-reserva-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-reserva-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Inventario -->
  <div class="modal-overlay" id="modal-inventario">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-inventario-title">üì¶ Nuevo art√≠culo</h3>
        <button class="modal-close" id="modal-inventario-close">√ó</button>
      </div>
      <form id="form-inventario">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre del art√≠culo</label>
            <input type="text" class="form-input" id="inv-nombre" placeholder="Ej: Papel higi√©nico" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="inv-categoria" required>
                <option value="limpieza">üßπ Limpieza</option>
                <option value="bano">üöø Ba√±o</option>
                <option value="cocina">üç≥ Cocina</option>
                <option value="alimentos">ü•´ Alimentos</option>
                <option value="bebidas">üç∑ Bebidas</option>
                <option value="otro">üì¶ Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Unidad</label>
              <select class="form-select" id="inv-unidad">
                <option value="uds">Unidades</option>
                <option value="rollos">Rollos</option>
                <option value="botellas">Botellas</option>
                <option value="paquetes">Paquetes</option>
                <option value="kg">Kg</option>
                <option value="litros">Litros</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Stock actual</label>
              <input type="number" class="form-input" id="inv-stock" min="0" value="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Stock m√≠nimo</label>
              <input type="number" class="form-input" id="inv-minimo" min="0" value="1" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha caducidad (opcional)</label>
            <input type="date" class="form-input" id="inv-caducidad">
          </div>
          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="inv-notas" placeholder="Ej: Marca preferida, d√≥nde comprarlo...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-inventario">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-inventario-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-inventario-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Gastos -->
  <div class="modal-overlay" id="modal-gasto">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-gasto-title">üí∂ Nuevo gasto</h3>
        <button class="modal-close" id="modal-gasto-close">√ó</button>
      </div>
      <form id="form-gasto">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha</label>
              <input type="date" class="form-input" id="gasto-fecha" required>
            </div>
            <div class="form-group">
              <label class="form-label">Importe (‚Ç¨)</label>
              <input type="number" class="form-input" id="gasto-importe" min="0" step="0.01" placeholder="0.00" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Concepto</label>
            <input type="text" class="form-input" id="gasto-concepto" placeholder="Ej: Factura luz noviembre" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="gasto-categoria" required>
                <option value="luz">üí° Luz</option>
                <option value="agua">üíß Agua</option>
                <option value="gas">üî• Gas</option>
                <option value="comunidad">üè¢ Comunidad</option>
                <option value="seguro">üõ°Ô∏è Seguro</option>
                <option value="mantenimiento">üîß Mantenimiento</option>
                <option value="limpieza">üßπ Limpieza</option>
                <option value="compras">üõí Compras</option>
                <option value="otro">üìã Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Proveedor</label>
              <input type="text" class="form-input" id="gasto-proveedor" placeholder="Ej: Iberdrola, Ferreter√≠a...">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Generador (qui√©n lo ordena)</label>
            <select class="form-select" id="gasto-generador">
              <option value="">Sin asignar</option>
            </select>
          </div>

          <!-- Reparto de gastos -->
          <div class="reparto-section">
            <div class="reparto-header">
              <label class="form-label">üìä Reparto entre miembros</label>
              <button type="button" class="btn btn-sm btn-secondary" onclick="repartoLineal()">‚ÜîÔ∏è Lineal</button>
            </div>
            <div class="reparto-miembros" id="reparto-miembros">
              <!-- Se carga din√°micamente -->
            </div>
            <div class="reparto-total" id="reparto-total">
              <span>Total asignado:</span>
              <span id="reparto-pct-total">0%</span>
            </div>
            <div class="reparto-warning hidden" id="reparto-warning">‚ö†Ô∏è Los porcentajes deben sumar 100%</div>
          </div>

          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="gasto-notas" placeholder="Ej: N¬∫ factura, observaciones...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-gasto">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-gasto-cancelar">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="previsualizarReparto()">üëÅÔ∏è Vista previa</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Vista Previa Reparto -->
  <div class="modal-overlay" id="modal-reparto-preview">
    <div class="modal" style="max-width:400px;">
      <div class="modal-header">
        <h3 class="modal-title">üìä Vista previa del reparto</h3>
        <button class="modal-close" onclick="cerrarPreviewReparto()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="preview-header">
          <div class="preview-concepto" id="preview-concepto">-</div>
          <div class="preview-total" id="preview-total">0,00 ‚Ç¨</div>
        </div>
        <div class="preview-lista" id="preview-lista">
          <!-- Se genera din√°micamente -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarPreviewReparto()">Volver</button>
        <button type="button" class="btn btn-primary" onclick="guardarGastoConReparto()">üíæ Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Casero -->
  <!-- Modal Casero -->
  <div class="modal-overlay" id="modal-casero">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-casero-title">üë§ Nuevo casero</h3>
        <button class="modal-close" id="modal-casero-close">√ó</button>
      </div>
      <form id="form-casero">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-input" id="casero-nombre" placeholder="Nombre completo" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Email (para login)</label>
              <input type="email" class="form-input" id="casero-email" placeholder="email@ejemplo.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Tel√©fono</label>
              <input type="tel" class="form-input" id="casero-telefono" placeholder="600 000 000">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" style="margin-bottom:12px;">Permisos en este bien</label>
            <div class="permisos-matrix">
              <div class="permisos-matrix-header">
                <span>Secci√≥n</span>
                <span>V</span>
                <span>C</span>
                <span>E</span>
                <span>B</span>
              </div>
              <div class="permisos-matrix-row">
                <label>üìÖ Reservas</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-reservas-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-reservas-c"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-reservas-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-reservas-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üì¶ Inventario</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-inventario-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-inventario-c" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-inventario-e" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-inventario-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üîß Mantenimiento</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-mantenimiento-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-mantenimiento-c" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-mantenimiento-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-mantenimiento-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üßπ Limpieza</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-limpieza-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-limpieza-c" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-limpieza-e" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-limpieza-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üí∂ Gastos</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-gastos-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-gastos-c" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-gastos-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-gastos-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üìÑ Documentos</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-documentos-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-documentos-c"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-documentos-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-documentos-b"></div>
              </div>
            </div>
            <div style="font-size:0.7rem;color:var(--text-muted);margin-top:6px;">V=Ver, C=Crear, E=Editar, B=Borrar</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-casero">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-casero-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-casero-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Hoster (Gerente) -->
  <div class="modal-overlay" id="modal-hoster">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #4A5568, #2D3748); color: white;">
        <h3 class="modal-title" id="modal-hoster-title">üè® Nuevo hoster</h3>
        <button class="modal-close" id="modal-hoster-close" style="color: white;">√ó</button>
      </div>
      <form id="form-hoster">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-input" id="hoster-nombre" placeholder="Nombre completo" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Email (para login)</label>
              <input type="email" class="form-input" id="hoster-email" placeholder="email@ejemplo.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Tel√©fono</label>
              <input type="tel" class="form-input" id="hoster-telefono" placeholder="600 000 000">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Rol</label>
            <select class="form-select" id="hoster-rol">
              <option value="recepcion">üõéÔ∏è Recepci√≥n</option>
              <option value="limpieza">üßπ Limpieza</option>
              <option value="mantenimiento">üîß Mantenimiento</option>
              <option value="atencion">üí¨ Atenci√≥n hu√©spedes</option>
              <option value="completo">‚≠ê Completo</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" style="margin-bottom:12px;">Permisos en este bien</label>
            <div class="permisos-matrix">
              <div class="permisos-matrix-header">
                <span>Secci√≥n</span>
                <span>V</span>
                <span>C</span>
                <span>E</span>
                <span>B</span>
              </div>
              <div class="permisos-matrix-row">
                <label>üìÖ Reservas</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-reservas-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-reservas-c" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-reservas-e" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-reservas-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üë• Inquilinos</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-inquilinos-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-inquilinos-c"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-inquilinos-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-inquilinos-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üìù Contratos</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-contratos-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-contratos-c"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-contratos-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-contratos-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üßæ Facturaci√≥n</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-facturacion-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-facturacion-c"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-facturacion-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-facturacion-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üìä Contabilidad</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-contabilidad-v"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-contabilidad-c"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-contabilidad-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="hperm-contabilidad-b"></div>
              </div>
            </div>
            <div style="font-size:0.7rem;color:var(--text-muted);margin-top:6px;">V=Ver, C=Crear, E=Editar, B=Borrar</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-hoster">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-hoster-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #4A5568, #2D3748);" id="modal-hoster-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Editar Bien -->
  <div class="modal-overlay" id="modal-editar-bien">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Editar bien</h3>
        <button class="modal-close" id="modal-editar-close">√ó</button>
      </div>
      <form id="form-editar-bien">
        <!-- Tabs -->
        <div class="modal-tabs" style="display:flex;border-bottom:1px solid var(--cream-dark);padding:0 24px;">
          <button type="button" class="modal-tab active" data-tab="datos">üìã Datos</button>
          <button type="button" class="modal-tab" data-tab="personal">üë∑ Personal</button>
          <button type="button" class="modal-tab" data-tab="contactos">üìû Contactos</button>
          <button type="button" class="modal-tab" data-tab="normas">üìú Normas</button>
        </div>

        <div class="modal-body" style="max-height:60vh;overflow-y:auto;">
          <!-- Tab Datos -->
          <div class="tab-content active" id="tab-datos">
            <div class="form-group">
              <label class="form-label">Nombre del bien *</label>
              <input type="text" class="form-input" id="edit-nombre" required>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="form-group">
                <label class="form-label">Tipo</label>
                <select class="form-input" id="edit-tipo" onchange="toggleCamposRustico()">
                  <option value="inmueble">üè† Inmueble</option>
                  <option value="terreno">üå≥ Terreno / Finca r√∫stica</option>
                  <option value="vehiculo">üöó Veh√≠culo</option>
                  <option value="ajuar">ü™ë Ajuar</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Subtipo</label>
                <input type="text" class="form-input" id="edit-subtipo" placeholder="Ej: Segunda residencia">
              </div>
            </div>

            <!-- CAMPOS R√öSTICOS (solo visibles para tipo=terreno) -->
            <div id="campos-rustico" class="hidden">
              <div class="form-group" style="margin-top:16px;padding:16px;background:var(--capataz-muted);border-radius:var(--radius-md);border-left:4px solid var(--capataz);">
                <label class="form-label" style="color:var(--capataz);margin-bottom:12px;">üåæ Aprovechamiento general</label>
                <div style="display:flex;gap:20px;flex-wrap:wrap;">
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="aprov-agricola" style="width:18px;height:18px;accent-color:var(--capataz);">
                    <span>üåæ Agr√≠cola</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="aprov-forestal" style="width:18px;height:18px;accent-color:var(--capataz);">
                    <span>üå≤ Forestal</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="aprov-cinegetico" style="width:18px;height:18px;accent-color:var(--capataz);">
                    <span>ü¶å Cineg√©tico</span>
                  </label>
                </div>
              </div>

              <div class="form-group" style="margin-top:16px;">
                <label class="form-label" style="display:flex;align-items:center;justify-content:space-between;">
                  <span>üìã Fincas registrales</span>
                  <button type="button" class="btn btn-sm" style="background:var(--capataz);color:white;" onclick="addFincaRow()">+ A√±adir finca</button>
                </label>
                <div style="overflow-x:auto;margin-top:8px;">
                  <table id="tabla-fincas" style="width:100%;border-collapse:collapse;font-size:0.85rem;">
                    <thead>
                      <tr style="background:var(--cream-dark);">
                        <th style="padding:10px;text-align:left;font-weight:600;">Registro</th>
                        <th style="padding:10px;text-align:left;font-weight:600;">Nombre</th>
                        <th style="padding:10px;text-align:right;font-weight:600;">Superficie (ha)</th>
                        <th style="padding:10px;text-align:left;font-weight:600;">Uso</th>
                        <th style="padding:10px;width:40px;"></th>
                      </tr>
                    </thead>
                    <tbody id="tbody-fincas"></tbody>
                    <tfoot>
                      <tr style="background:var(--capataz-muted);font-weight:700;">
                        <td style="padding:10px;" colspan="2">TOTAL</td>
                        <td style="padding:10px;text-align:right;" id="total-superficie">0.00 ha</td>
                        <td style="padding:10px;" colspan="2"></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>
            <!-- FIN CAMPOS R√öSTICOS -->
            <div class="form-group">
              <label class="form-label">Ubicaci√≥n</label>
              <input type="text" class="form-input" id="edit-ubicacion" placeholder="Direcci√≥n o localizaci√≥n">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="form-group">
                <label class="form-label">Titularidad</label>
                <input type="text" class="form-input" id="edit-titularidad" placeholder="¬øDe qui√©n es?">
              </div>
              <div class="form-group">
                <label class="form-label">Origen</label>
                <input type="text" class="form-input" id="edit-origen" placeholder="Herencia, compra...">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Notas</label>
              <textarea class="form-input" id="edit-notas" rows="3" placeholder="Informaci√≥n adicional..."></textarea>
            </div>
          </div>

          <!-- Tab Personal -->
          <div class="tab-content" id="tab-personal">
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Personal de servicio asociado a este bien (limpieza, jardinero, etc.)</p>
            <div id="personal-list" style="display:flex;flex-direction:column;gap:12px;"></div>
            <button type="button" class="btn btn-secondary btn-sm" style="margin-top:12px;width:100%;" onclick="addPersonalItem()">+ A√±adir personal</button>
          </div>

          <!-- Tab Contactos -->
          <div class="tab-content" id="tab-contactos">
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Contactos √∫tiles: vecinos, cerrajero, emergencias locales...</p>
            <div id="contactos-list" style="display:flex;flex-direction:column;gap:12px;"></div>
            <button type="button" class="btn btn-secondary btn-sm" style="margin-top:12px;width:100%;" onclick="addContactoItem()">+ A√±adir contacto</button>
          </div>

          <!-- Tab Normas -->
          <div class="tab-content" id="tab-normas">
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Normas de convivencia y uso del bien</p>
            <div class="form-group">
              <textarea class="form-input" id="edit-normas" rows="10" placeholder="Escribe aqu√≠ las normas de uso..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:12px;padding:16px 24px;border-top:1px solid var(--cream-dark);">
          <button type="button" class="btn btn-secondary" id="modal-editar-cancelar">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="modal-editar-guardar">üíæ Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Grupo Ajuar -->
  <div class="modal-overlay" id="modal-grupo-ajuar">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-grupo-ajuar-title">üì¶ Nuevo grupo</h3>
        <button class="modal-close" onclick="cerrarModalGrupoAjuar()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="grupo-ajuar-id">
        <div class="form-group">
          <label class="form-label">Nombre del grupo *</label>
          <input type="text" class="form-input" id="grupo-ajuar-nombre" placeholder="Ej: Muebles sal√≥n, Vajilla, Cuadros..." required>
        </div>
        <div class="form-group">
          <label class="form-label">Icono</label>
          <div style="display:flex;flex-wrap:wrap;gap:8px;" id="grupo-ajuar-iconos">
            <label class="icon-option"><input type="radio" name="grupo-icono" value="ü™ë" checked><span>ü™ë</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üõãÔ∏è"><span>üõãÔ∏è</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üçΩÔ∏è"><span>üçΩÔ∏è</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üñºÔ∏è"><span>üñºÔ∏è</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üìö"><span>üìö</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üè∫"><span>üè∫</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üíé"><span>üíé</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üé®"><span>üé®</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="ü™û"><span>ü™û</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üõèÔ∏è"><span>üõèÔ∏è</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üß∫"><span>üß∫</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üì¶"><span>üì¶</span></label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Descripci√≥n (opcional)</label>
          <input type="text" class="form-input" id="grupo-ajuar-desc" placeholder="Notas sobre este grupo...">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-grupo-ajuar" onclick="eliminarGrupoAjuar()">üóëÔ∏è</button>
        <div style="display:flex;gap:12px;">
          <button type="button" class="btn btn-secondary" onclick="cerrarModalGrupoAjuar()">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarGrupoAjuar()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Art√≠culo Ajuar -->
  <div class="modal-overlay" id="modal-articulo-ajuar">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-articulo-ajuar-title">ü™ë Nuevo art√≠culo</h3>
        <button class="modal-close" onclick="cerrarModalArticuloAjuar()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="articulo-ajuar-id">
        <input type="hidden" id="articulo-ajuar-grupo-id">
        <div class="form-group">
          <label class="form-label">Nombre del art√≠culo *</label>
          <input type="text" class="form-input" id="articulo-ajuar-nombre" placeholder="Ej: Mesa comedor roble, Sof√° chester..." required>
        </div>
        <div class="form-group">
          <label class="form-label">Descripci√≥n</label>
          <textarea class="form-input" id="articulo-ajuar-desc" rows="2" placeholder="Caracter√≠sticas, estado, historia..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Ubicaci√≥n / Lugar</label>
          <input type="text" class="form-input" id="articulo-ajuar-ubicacion" placeholder="Ej: Sal√≥n, Dormitorio 1...">
        </div>
        <div class="form-group">
          <label class="form-label">Marca</label>
          <input type="text" class="form-input" id="articulo-ajuar-marca" placeholder="Ej: IKEA, antig√ºedad, artesanal...">
        </div>
        <div class="form-group">
          <label class="form-label">Procedencia</label>
          <input type="text" class="form-input" id="articulo-ajuar-procedencia" placeholder="Ej: Herencia abuelos, comprado 2015, regalo boda...">
        </div>
        <div class="form-group">
          <label class="form-label">Foto (opcional)</label>
          <div class="foto-upload-area" id="articulo-foto-area" onclick="document.getElementById('articulo-ajuar-foto').click()">
            <span id="articulo-foto-preview">üì∑ Click para subir foto</span>
          </div>
          <input type="file" id="articulo-ajuar-foto" accept="image/*" style="display:none" onchange="previewArticuloFoto(this)">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-articulo-ajuar" onclick="eliminarArticuloAjuar()">üóëÔ∏è</button>
        <div style="display:flex;gap:12px;">
          <button type="button" class="btn btn-secondary" onclick="cerrarModalArticuloAjuar()">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarArticuloAjuar()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Modal tabs */
    .modal-tab {
      padding: 12px 16px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .modal-tab:hover { color: var(--text); }
    .modal-tab.active { color: var(--sage-dark); border-bottom-color: var(--sage); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Dynamic items */
    .dynamic-item {
      background: var(--cream);
      border-radius: var(--radius-md);
      padding: 12px;
      position: relative;
    }
    .dynamic-item-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    .dynamic-item-row:last-child { margin-bottom: 0; }
    .btn-remove-item {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.5;
    }
    .btn-remove-item:hover { opacity: 1; }
    
    /* Icon options */
    .icon-option { cursor: pointer; }
    .icon-option input { display: none; }
    .icon-option span { 
      display: inline-flex; 
      width: 40px; 
      height: 40px; 
      align-items: center; 
      justify-content: center; 
      font-size: 1.3rem; 
      background: var(--cream); 
      border: 2px solid var(--cream-dark); 
      border-radius: var(--radius-sm); 
      transition: all 0.2s;
    }
    .icon-option:hover span { border-color: var(--sage); }
    .icon-option input:checked + span { background: var(--sage-muted); border-color: var(--sage); }
    
    /* Foto upload area */
    .foto-upload-area {
      border: 2px dashed var(--cream-dark);
      border-radius: var(--radius-md);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
    }
    .foto-upload-area:hover { border-color: var(--sage); background: var(--sage-muted); }
    .foto-upload-area img { max-width: 100%; max-height: 150px; border-radius: var(--radius-sm); }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let familiaId = null;
    let nidosData = [];
    let reservasData = [];
    let inventarioData = [];
    let gastosData = [];
    let repartoData = {}; // {nidoId: porcentaje}
    let gastosPeriodo = 'mes';
    let gastosTab = 'registro';
    let inventarioFiltro = 'todos';
    let calendarioMes = new Date();
    let editingReservaId = null;
    let editingInventarioId = null;
    let editingGastoId = null;
    let caserosData = [];
    let editingCaseroId = null;
    let esAdminRama = false;

    const nidoColores = ['nido-1', 'nido-2', 'nido-3', 'nido-4'];
    const nidoColorMap = {};
    
    // Tipos de reserva - se cargan desde Firebase
    let tiposReserva = {};

    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    if (!bienId) window.location.href = 'bienes.html';

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await loadBien();
    });

    async function loadBien() {
      try {
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) { alert('Bien no encontrado'); window.location.href = 'bienes.html'; return; }

        bienData = { id: bienDoc.id, ...bienDoc.data() };
        familiaId = bienData.familiaId;
        
        // Verificar si el usuario es AdminRama
        try {
          const userDoc = await db.collection('usuarios').doc(currentUser.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            esAdminRama = userData.rol === 'adminRama' || userData.rol === 'adminSistema';
          }
        } catch (e) { console.error('Error verificando rol:', e); }
        
        await loadNidos();
        await loadTiposReserva();
        await loadReservas();
        await loadInventario();
        await loadGastos();
        await loadCaseros();
        
        // Migrar m√≥dulos si existen datos antiguos
        await migrarModulos();
        
        renderBien();
        
        // Cargar cat√°logo si es tipo ajuar
        await cargarCatalogoAjuar();

        document.getElementById('page-loading').classList.add('hidden');
        document.getElementById('page-content').classList.remove('hidden');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar');
        window.location.href = 'bienes.html';
      }
    }

    async function loadNidos() {
      if (!familiaId) return;
      const snap = await db.collection('nidos').where('familiaId', '==', familiaId).get();
      nidosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Nidos se usan para gastos/reparto, no para reservas
    }

    // Migrar m√≥dulos existentes a√±adiendo los nuevos que falten
    async function migrarModulos() {
      const updateData = {};
      let needsUpdate = false;

      // M√≥dulos completos de Mayordomo
      const modulosMayordomoCompletos = {
        reservas: false, inventario: false, ajuar: false, menus: false,
        gastos: false, mantenimiento: false, limpieza: false, eventos: false,
        planLimpieza: false, prepararSemana: false, especiales: false
      };

      // M√≥dulos completos de Gerente
      const modulosGerenteCompletos = {
        reservas: false, habitaciones: false, huespedes: false, tarifas: false,
        ventas: false, inventario: false, ajuar: false, contratos: false,
        servicios: false, menus: false
      };

      // M√≥dulos completos de Capataz
      const modulosCapatazCompletos = {
        parcelas: false, instalaciones: false, maquinaria: false,
        personal: false, labores: false, cosechas: false
      };

      // Verificar y migrar Mayordomo
      if (bienData.mayordomoModulos) {
        const existentes = bienData.mayordomoModulos;
        const merged = { ...modulosMayordomoCompletos };
        Object.keys(existentes).forEach(key => {
          if (key in merged) merged[key] = existentes[key];
        });
        // Solo actualizar si hay diferencia
        if (Object.keys(merged).length !== Object.keys(existentes).length ||
            !Object.keys(modulosMayordomoCompletos).every(k => k in existentes)) {
          updateData.mayordomoModulos = merged;
          needsUpdate = true;
        }
      }

      // Verificar y migrar Gerente
      if (bienData.gerenteModulos) {
        const existentes = bienData.gerenteModulos;
        const merged = { ...modulosGerenteCompletos };
        Object.keys(existentes).forEach(key => {
          if (key in merged) merged[key] = existentes[key];
        });
        if (Object.keys(merged).length !== Object.keys(existentes).length ||
            !Object.keys(modulosGerenteCompletos).every(k => k in existentes)) {
          updateData.gerenteModulos = merged;
          needsUpdate = true;
        }
      }

      // Verificar y migrar Capataz
      if (bienData.capatazModulos) {
        const existentes = bienData.capatazModulos;
        const merged = { ...modulosCapatazCompletos };
        Object.keys(existentes).forEach(key => {
          if (key in merged) merged[key] = existentes[key];
        });
        if (Object.keys(merged).length !== Object.keys(existentes).length ||
            !Object.keys(modulosCapatazCompletos).every(k => k in existentes)) {
          updateData.capatazModulos = merged;
          needsUpdate = true;
        }
      }

      // Guardar si hay cambios
      if (needsUpdate) {
        try {
          await db.collection('bienes').doc(bienId).update(updateData);
          // Actualizar datos locales
          if (updateData.mayordomoModulos) bienData.mayordomoModulos = updateData.mayordomoModulos;
          if (updateData.gerenteModulos) bienData.gerenteModulos = updateData.gerenteModulos;
          if (updateData.capatazModulos) bienData.capatazModulos = updateData.capatazModulos;
          console.log('M√≥dulos migrados correctamente');
        } catch (error) {
          console.error('Error migrando m√≥dulos:', error);
        }
      }
    }

    async function loadTiposReserva() {
      try {
        const snap = await db.collection('familias').doc(familiaId).collection('tiposReserva').orderBy('orden', 'asc').get();
        
        if (snap.empty) {
          // Tipos por defecto si no hay configurados
          tiposReserva = {
            'toda-familia': { nombre: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Toda la familia', color: '#7A9E7E' },
            'otros': { nombre: 'üìã Otros', color: '#9A9A9A' }
          };
        } else {
          tiposReserva = {};
          snap.docs.forEach(doc => {
            const data = doc.data();
            tiposReserva[doc.id] = {
              nombre: (data.emoji ? data.emoji + ' ' : '') + data.nombre,
              color: data.color
            };
          });
        }
        
        // Actualizar el select del modal
        const select = document.getElementById('reserva-tipo');
        select.innerHTML = '<option value="">Selecciona...</option>' +
          Object.entries(tiposReserva).map(([id, tipo]) => 
            `<option value="${id}">${tipo.nombre}</option>`
          ).join('');
          
        // Generar estilos din√°micos para los colores
        generarEstilosReservas();
      } catch (error) {
        console.error('Error cargando tipos de reserva:', error);
      }
    }

    function generarEstilosReservas() {
      // Eliminar estilos previos si existen
      const oldStyle = document.getElementById('dynamic-reserva-styles');
      if (oldStyle) oldStyle.remove();
      
      let css = '';
      Object.entries(tiposReserva).forEach(([id, tipo]) => {
        css += `.calendario-dia.tipo-${id} { background: ${tipo.color}; }\n`;
        css += `.reserva-item.tipo-${id} { border-left-color: ${tipo.color}; }\n`;
      });
      
      const style = document.createElement('style');
      style.id = 'dynamic-reserva-styles';
      style.textContent = css;
      document.head.appendChild(style);
    }

    async function loadReservas() {
      const snap = await db.collection('bienes').doc(bienId).collection('reservas').orderBy('fechaInicio', 'asc').get();
      reservasData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function loadInventario() {
      const snap = await db.collection('bienes').doc(bienId).collection('inventario').orderBy('nombre', 'asc').get();
      inventarioData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function loadGastos() {
      const snap = await db.collection('bienes').doc(bienId).collection('gastos').orderBy('fecha', 'desc').get();
      gastosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // Cargar configuraci√≥n de reparto
      const repartoDoc = await db.collection('bienes').doc(bienId).collection('config').doc('reparto').get();
      if (repartoDoc.exists) {
        repartoData = repartoDoc.data().porcentajes || {};
      } else {
        // Inicializar reparto equitativo
        repartoData = {};
        const porcentajeBase = nidosData.length > 0 ? Math.floor(100 / nidosData.length) : 100;
        nidosData.forEach((n, i) => {
          repartoData[n.id] = i === 0 ? 100 - (porcentajeBase * (nidosData.length - 1)) : porcentajeBase;
        });
      }
    }

    async function loadCaseros() {
      const snap = await db.collection('bienes').doc(bienId).collection('caseros').get();
      caserosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    function renderBien() {
      const tipoIcons = { inmueble: 'üè†', terreno: 'üå≥', vehiculo: 'üöó', ajuar: 'ü™ë' };
      const tipoLabels = { inmueble: 'Inmueble', terreno: 'Terreno', vehiculo: 'Veh√≠culo', ajuar: 'Ajuar' };
      const rolIcons = { limpieza: 'üßπ', jardinero: 'üå±', cuidador: 'üë®‚Äç‚öïÔ∏è', mantenimiento: 'üîß', otro: 'üìã' };
      const mascotaIcons = { perro: 'üêï', gato: 'üêà', ave: 'üê¶', otro: 'üêæ' };
      const catIcons = { mantenimiento: 'üîß', vecino: 'üèòÔ∏è', emergencia: 'üö®', suministros: 'üí°', otro: 'üìã' };
      const docIcons = { escritura: 'üìú', seguro: 'üõ°Ô∏è', suministro: 'üí°', empleado: 'üë∑', itv: 'üöó', comunidad: 'üè¢', otro: 'üìÑ' };

      // Hero image - se maneja en renderGestionCards()
      const tipoIcon = tipoIcons[bienData.tipo] || 'üè†';
      if (!bienData.fotos?.length) {
        document.getElementById('bien-hero-image').innerHTML = tipoIcon;
      } else {
        document.getElementById('bien-hero-image').innerHTML = `<img src="${bienData.fotos[0].url}">`;
      }
      
      document.getElementById('bien-tipo').textContent = tipoLabels[bienData.tipo] || bienData.tipo;
      document.getElementById('bien-nombre').textContent = bienData.nombre;
      document.getElementById('bien-ubicacion').textContent = bienData.ubicacion || '-';
      document.getElementById('bien-titularidad').textContent = bienData.titularidad || '-';
      document.getElementById('bien-origen').textContent = bienData.origen || '-';

      // Sidebar counts
      document.getElementById('count-galeria').textContent = (bienData.fotos?.length || 0) + (bienData.croquis?.length || 0) + (bienData.planos?.length || 0);

      const personal = bienData.personal || [];
      document.getElementById('count-personal').textContent = personal.length;
      if (personal.length > 0) {
        document.getElementById('lista-personal').innerHTML = personal.map(p => `
          <div class="info-item">
            <span class="info-item-icon">${rolIcons[p.rol] || 'üë∑'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${p.nombre}</div>
              <div class="info-item-subtitle">${p.tipo === 'residente' ? 'Residente' : 'Puntual'}${p.telefono ? ' ¬∑ ' + p.telefono : ''}</div>
            </div>
            ${p.telefono ? `<a href="tel:${p.telefono}" class="info-item-action">üìû</a>` : ''}
          </div>
        `).join('');
      }

      const mascotas = bienData.mascotas || [];
      document.getElementById('count-mascotas').textContent = mascotas.length;
      if (mascotas.length > 0) {
        document.getElementById('lista-mascotas').innerHTML = mascotas.map(m => `
          <div class="info-item">
            <span class="info-item-icon">${mascotaIcons[m.tipo] || 'üêæ'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${m.nombre}</div>
              <div class="info-item-subtitle">${m.raza || m.tipo}</div>
            </div>
          </div>
        `).join('');
      }

      const contactos = bienData.contactos || [];
      document.getElementById('count-contactos').textContent = contactos.length;
      if (contactos.length > 0) {
        document.getElementById('lista-contactos').innerHTML = contactos.map(c => `
          <div class="info-item">
            <span class="info-item-icon">${catIcons[c.categoria] || 'üìû'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${c.nombre}</div>
              <div class="info-item-subtitle">${c.telefono || ''}</div>
            </div>
            ${c.telefono ? `<a href="tel:${c.telefono}" class="info-item-action">üìû</a>` : ''}
          </div>
        `).join('');
      }

      const documentos = bienData.documentos || [];
      document.getElementById('count-documentos').textContent = documentos.length;
      if (documentos.length > 0) {
        document.getElementById('lista-documentos').innerHTML = documentos.map(d => `
          <div class="info-item">
            <span class="info-item-icon">${docIcons[d.tipo] || 'üìÑ'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${d.nombre}</div>
              <div class="info-item-subtitle">${d.fechaVencimiento ? 'Vence: ' + formatDate(d.fechaVencimiento) : ''}</div>
            </div>
          </div>
        `).join('');
      }

      if (bienData.normasConvivencia) document.getElementById('normas-texto').textContent = bienData.normasConvivencia;

      // Caseros
      document.getElementById('count-caseros').textContent = caserosData.length;
      renderCaserosList();

      // Renderizar estado de gesti√≥n (Mayordomo/Gerente)
      renderGestionCards();
    }

    function renderGestionCards() {
      const cardMayordomo = document.getElementById('card-mayordomo');
      const cardGerente = document.getElementById('card-gerente');
      const cardCapataz = document.getElementById('card-capataz');
      const statusMayordomo = document.getElementById('status-mayordomo');
      const statusGerente = document.getElementById('status-gerente');
      const statusCapataz = document.getElementById('status-capataz');
      const btnMayordomo = document.getElementById('btn-mayordomo');
      const btnGerente = document.getElementById('btn-gerente');
      const btnCapataz = document.getElementById('btn-capataz');
      const gestionModulos = document.getElementById('gestion-modulos');
      const gestionTitulo = document.getElementById('gestion-titulo');
      const botonesContainer = document.getElementById('modulos-botones');
      const sectionCaseros = document.getElementById('section-caseros');
      const sectionHosters = document.getElementById('section-hosters');

      const mayordomoActivo = bienData.mayordomoActivo;
      const gerenteActivo = bienData.gerenteActivo;
      const capatazActivo = bienData.capatazActivo;

      // Reset todas las cards
      [cardMayordomo, cardGerente, cardCapataz].forEach(card => {
        if (card) {
          card.classList.remove('active');
          card.classList.add('disabled');
        }
      });

      // Actualizar cards visuales seg√∫n gesti√≥n activa
      if (mayordomoActivo) {
        cardMayordomo.classList.add('active');
        cardMayordomo.classList.remove('disabled');
        statusMayordomo.textContent = 'Activo';
        statusGerente.textContent = 'Inactivo';
        statusCapataz.textContent = 'Inactivo';
        btnMayordomo.textContent = '‚öôÔ∏è Configurar';
        btnMayordomo.onclick = () => abrirConfigModulos();
        btnGerente.textContent = 'Activar';
        btnCapataz.textContent = 'Activar';
        gestionModulos.classList.remove('hidden');
        gestionTitulo.textContent = 'üé© M√≥dulos Mayordomo';
        gestionTitulo.className = 'gestion-modulos-title mayordomo';
        renderModulosBotones('mayordomo');
        if (sectionCaseros) sectionCaseros.classList.remove('hidden');
        if (sectionHosters) sectionHosters.classList.add('hidden');
      } else if (gerenteActivo) {
        cardGerente.classList.add('active');
        cardGerente.classList.remove('disabled');
        statusGerente.textContent = 'Activo';
        statusMayordomo.textContent = 'Inactivo';
        statusCapataz.textContent = 'Inactivo';
        btnGerente.textContent = '‚öôÔ∏è Configurar';
        btnGerente.onclick = () => abrirConfigModulos();
        btnMayordomo.textContent = 'Activar';
        btnCapataz.textContent = 'Activar';
        gestionModulos.classList.remove('hidden');
        gestionTitulo.textContent = 'üíº M√≥dulos Gerente';
        gestionTitulo.className = 'gestion-modulos-title gerente';
        renderModulosBotones('gerente');
        if (sectionHosters) sectionHosters.classList.remove('hidden');
        if (sectionCaseros) sectionCaseros.classList.add('hidden');
        cargarHosters();
      } else if (capatazActivo) {
        cardCapataz.classList.add('active');
        cardCapataz.classList.remove('disabled');
        statusCapataz.textContent = 'Activo';
        statusMayordomo.textContent = 'Inactivo';
        statusGerente.textContent = 'Inactivo';
        btnCapataz.textContent = '‚öôÔ∏è Configurar';
        btnCapataz.onclick = () => abrirConfigModulos();
        btnMayordomo.textContent = 'Activar';
        btnGerente.textContent = 'Activar';
        gestionModulos.classList.remove('hidden');
        gestionTitulo.textContent = 'üöú M√≥dulos Capataz';
        gestionTitulo.className = 'gestion-modulos-title capataz';
        renderModulosBotones('capataz');
        if (sectionCaseros) sectionCaseros.classList.remove('hidden');
        if (sectionHosters) sectionHosters.classList.add('hidden');
      } else {
        // Ninguno activo - quitar disabled de todas para que se puedan activar
        [cardMayordomo, cardGerente, cardCapataz].forEach(card => {
          if (card) card.classList.remove('active', 'disabled');
        });
        statusMayordomo.textContent = 'Inactivo';
        statusGerente.textContent = 'Inactivo';
        statusCapataz.textContent = 'Inactivo';
        btnMayordomo.textContent = 'Activar';
        btnGerente.textContent = 'Activar';
        btnCapataz.textContent = 'Activar';
        gestionModulos.classList.add('hidden');
        if (sectionCaseros) sectionCaseros.classList.add('hidden');
        if (sectionHosters) sectionHosters.classList.add('hidden');
      }

      // Actualizar badge del hero
      const heroImage = document.getElementById('bien-hero-image');
      let badge = '';
      if (mayordomoActivo) badge = '<span class="bien-hero-badge">üé© Mayordomo</span>';
      else if (gerenteActivo) badge = '<span class="bien-hero-badge gerente">üíº Gerente</span>';
      else if (capatazActivo) badge = '<span class="bien-hero-badge capataz">üöú Capataz</span>';
      
      if (bienData.fotos?.length > 0) {
        heroImage.innerHTML = `<img src="${bienData.fotos[0].url}">${badge}`;
      } else {
        const iconos = { inmueble: 'üè†', vehiculo: 'üöó', embarcacion: '‚õµ', otro: 'üì¶' };
        heroImage.innerHTML = (iconos[bienData.tipo] || 'üè†') + badge;
      }
    }

    function renderModulosBotones(tipo) {
      const botonesContainer = document.getElementById('modulos-botones');
      let botonesHtml = '';

      if (tipo === 'mayordomo') {
        const m = bienData.mayordomoModulos || {};
        const modulosConfig = [
          { key: 'reservas', icon: 'üìÖ', label: 'Reservas', url: `reservas.html?id=${bienId}&origen=bien` },
          { key: 'inventario', icon: 'üì¶', label: 'Inventario', url: `inventario.html?id=${bienId}&origen=bien` },
          { key: 'ajuar', icon: 'ü™ë', label: 'Ajuar', url: `ajuar.html?id=${bienId}&origen=bien` },
          { key: 'menus', icon: 'üçΩÔ∏è', label: 'Men√∫s', url: `menus-nidos.html?id=${bienId}&origen=bien` },
          { key: 'gastos', icon: 'üí∞', label: 'Gastos', url: `gastos.html?id=${bienId}&origen=bien` },
          { key: 'mantenimiento', icon: 'üîß', label: 'Mantenimiento', url: `mantenimiento.html?id=${bienId}&origen=bien` },
          { key: 'limpieza', icon: 'üßπ', label: 'Limpieza', url: `limpieza.html?id=${bienId}&origen=bien` },
          { key: 'planLimpieza', icon: 'üìã', label: 'Plan Limpieza', url: `plan-limpieza.html?id=${bienId}` },
          { key: 'eventos', icon: 'üéâ', label: 'Eventos', url: `eventos.html?id=${bienId}&origen=bien` },
          { key: 'prepararSemana', icon: 'üìÜ', label: 'Preparar Semana', url: `preparar-semana.html?id=${bienId}&origen=bien` },
          { key: 'especiales', icon: 'üõçÔ∏è', label: 'Especiales', url: `config-especiales.html?id=${bienId}&origen=bien` }
        ];
        
        modulosConfig.forEach(mod => {
          if (m[mod.key]) {
            botonesHtml += `<a href="${mod.url}" class="btn-modulo-activo">${mod.icon} ${mod.label}</a>`;
          }
        });
      } else if (tipo === 'gerente') {
        const g = bienData.gerenteModulos || {};
        const modulosConfig = [
          { key: 'reservas', icon: 'üìÖ', label: 'Reservas', url: `reservas.html?id=${bienId}&origen=bien` },
          { key: 'habitaciones', icon: 'üõèÔ∏è', label: 'Habitaciones', url: `habitaciones.html?id=${bienId}` },
          { key: 'huespedes', icon: 'üë•', label: 'Hu√©spedes', url: `huespedes.html?id=${bienId}` },
          { key: 'tarifas', icon: 'üí∂', label: 'Tarifas', url: `tarifas.html?id=${bienId}` },
          { key: 'ventas', icon: 'üí∞', label: 'Ventas', url: `ventas.html?id=${bienId}` },
          { key: 'inventario', icon: 'üì¶', label: 'Inventario', url: `inventario.html?id=${bienId}&origen=bien` },
          { key: 'ajuar', icon: 'ü™ë', label: 'Ajuar', url: `ajuar.html?id=${bienId}&origen=bien` },
          { key: 'contratos', icon: 'üìù', label: 'Contratos', url: `contratos.html?id=${bienId}` },
          { key: 'servicios', icon: 'üöê', label: 'Otros Servicios', url: `servicios-externos.html?id=${bienId}` },
          { key: 'menus', icon: 'üçΩÔ∏è', label: 'Men√∫s', url: `menus-nidos.html?id=${bienId}&origen=bien` }
        ];
        
        modulosConfig.forEach(mod => {
          if (g[mod.key]) {
            botonesHtml += `<a href="${mod.url}" class="btn-modulo-activo gerente">${mod.icon} ${mod.label}</a>`;
          }
        });
      } else if (tipo === 'capataz') {
        const c = bienData.capatazModulos || {};
        const modulosConfig = [
          { key: 'parcelas', icon: 'üó∫Ô∏è', label: 'Parcelas', url: `parcelas.html?bien=${bienId}` },
          { key: 'instalaciones', icon: 'üè≠', label: 'Instalaciones', url: `instalaciones.html?bien=${bienId}` },
          { key: 'maquinaria', icon: 'üöú', label: 'Maquinaria', url: `maquinaria.html?bien=${bienId}` },
          { key: 'personal', icon: 'üë∑', label: 'Personal', url: `personal-finca.html?bien=${bienId}` },
          { key: 'labores', icon: 'üìã', label: 'Labores', url: `labores.html?bien=${bienId}` },
          { key: 'cosechas', icon: 'üåª', label: 'Cosechas', url: `cosechas.html?bien=${bienId}` }
        ];
        
        modulosConfig.forEach(mod => {
          if (c[mod.key]) {
            botonesHtml += `<a href="${mod.url}" class="btn-modulo-activo capataz">${mod.icon} ${mod.label}</a>`;
          }
        });
      }

      if (!botonesHtml) {
        botonesHtml = '<div style="text-align:center;padding:20px;"><div style="font-size:2rem;margin-bottom:8px;">üì¶</div><div style="color:var(--text-muted);font-size:0.9rem;">Sin m√≥dulos activos</div><div style="color:var(--text-muted);font-size:0.8rem;">Pulsa "‚öôÔ∏è Configurar m√≥dulos" para activar los que necesites</div></div>';
      }

      botonesContainer.innerHTML = botonesHtml;
    }

    async function toggleGestion(tipo) {
      // Si ya est√° activo, no hacer nada (usar bot√≥n configurar)
      if (tipo === 'mayordomo' && bienData.mayordomoActivo) return;
      if (tipo === 'gerente' && bienData.gerenteActivo) return;
      if (tipo === 'capataz' && bienData.capatazActivo) return;

      // Si hay otra gesti√≥n activa, preguntar
      const gestionActiva = bienData.mayordomoActivo ? 'Mayordomo' : 
                            bienData.gerenteActivo ? 'Gerente' : 
                            bienData.capatazActivo ? 'Capataz' : null;
      
      if (gestionActiva) {
        const tipoNombre = tipo === 'mayordomo' ? 'Mayordomo' : tipo === 'gerente' ? 'Gerente' : 'Capataz';
        if (!confirm(`¬øCambiar de ${gestionActiva} a ${tipoNombre}? Los datos de ${gestionActiva} se conservar√°n.`)) return;
      }

      // Activar la gesti√≥n seleccionada
      if (tipo === 'mayordomo') {
        await activarMayordomo();
      } else if (tipo === 'gerente') {
        await activarGerente();
      } else if (tipo === 'capataz') {
        await activarCapataz();
      }
    }

    async function desactivarGestion() {
      const tipoActivo = bienData.mayordomoActivo ? 'Mayordomo' : 
                         bienData.gerenteActivo ? 'Gerente' : 
                         bienData.capatazActivo ? 'Capataz' : null;
      if (!tipoActivo) return;

      if (!confirm(`¬øDesactivar ${tipoActivo}? Los datos se conservar√°n y podr√°s reactivarlo cuando quieras.`)) return;

      try {
        await db.collection('bienes').doc(bienId).update({
          mayordomoActivo: false,
          gerenteActivo: false,
          capatazActivo: false
        });

        bienData.mayordomoActivo = false;
        bienData.gerenteActivo = false;
        bienData.capatazActivo = false;
        renderGestionCards();
        alert('‚úÖ Gesti√≥n desactivada. Los datos se han conservado.');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al desactivar');
      }
    }

    async function activarMayordomo() {
      try {
        const updateData = {
          mayordomoActivo: true,
          gerenteActivo: false,
          capatazActivo: false
        };
        
        if (!bienData.mayordomoModulos) {
          updateData.mayordomoModulos = {
            reservas: false,
            inventario: false,
            ajuar: false,
            menus: false,
            gastos: false,
            mantenimiento: false,
            limpieza: false,
            eventos: false
          };
        }

        await db.collection('bienes').doc(bienId).update(updateData);
        
        bienData.mayordomoActivo = true;
        bienData.gerenteActivo = false;
        bienData.capatazActivo = false;
        if (!bienData.mayordomoModulos) {
          bienData.mayordomoModulos = updateData.mayordomoModulos;
        }
        
        // Mostrar Caseros, ocultar Hosters
        document.getElementById('section-caseros')?.classList.remove('hidden');
        document.getElementById('section-hosters')?.classList.add('hidden');
        
        renderGestionCards();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al activar Mayordomo');
      }
    }

    async function activarGerente() {
      try {
        const updateData = {
          gerenteActivo: true,
          mayordomoActivo: false,
          capatazActivo: false
        };
        
        if (!bienData.gerenteModulos) {
          updateData.gerenteModulos = {
            reservas: false,
            habitaciones: false,
            huespedes: false,
            tarifas: false,
            ventas: false,
            inventario: false,
            ajuar: false,
            contratos: false,
            servicios: false,
            menus: false
          };
        }

        await db.collection('bienes').doc(bienId).update(updateData);
        
        bienData.gerenteActivo = true;
        bienData.mayordomoActivo = false;
        bienData.capatazActivo = false;
        if (!bienData.gerenteModulos) {
          bienData.gerenteModulos = updateData.gerenteModulos;
        }
        
        // Mostrar Hosters, ocultar Caseros
        document.getElementById('section-hosters')?.classList.remove('hidden');
        document.getElementById('section-caseros')?.classList.add('hidden');
        
        renderGestionCards();
        cargarHosters();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al activar Gerente');
      }
    }

    async function activarCapataz() {
      try {
        const updateData = {
          capatazActivo: true,
          mayordomoActivo: false,
          gerenteActivo: false
        };
        
        if (!bienData.capatazModulos) {
          updateData.capatazModulos = {
            parcelas: true,
            instalaciones: true,
            maquinaria: true,
            personal: true,
            labores: true,
            cosechas: true
          };
        }

        await db.collection('bienes').doc(bienId).update(updateData);
        
        bienData.capatazActivo = true;
        bienData.mayordomoActivo = false;
        bienData.gerenteActivo = false;
        if (!bienData.capatazModulos) {
          bienData.capatazModulos = updateData.capatazModulos;
        }
        
        // Mostrar Caseros (trabajadores de finca), ocultar Hosters
        document.getElementById('section-caseros')?.classList.remove('hidden');
        document.getElementById('section-hosters')?.classList.add('hidden');
        
        renderGestionCards();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al activar Capataz');
      }
    }

    // Funci√≥n legacy para compatibilidad
    function renderMayordomoModulos() {
      renderGestionCards();
    }

    // ========== CONFIGURACI√ìN DE M√ìDULOS ==========
    const modulosDescripcionesMayordomo = {
      reservas: { icon: 'üìÖ', nombre: 'Reservas', desc: 'Gestiona qui√©n usa el inmueble y cu√°ndo. Calendario compartido y turnos familiares.' },
      inventario: { icon: 'üì¶', nombre: 'Inventario', desc: 'Control de productos consumibles (limpieza, despensa). Alertas de stock bajo y lista de compra.' },
      ajuar: { icon: 'ü™ë', nombre: 'Ajuar', desc: 'Cat√°logo de muebles y enseres. Registra ubicaci√≥n, marca, procedencia y fotos.' },
      menus: { icon: 'üçΩÔ∏è', nombre: 'Men√∫s', desc: 'Planificaci√≥n de comidas. Organiza desayunos, comidas y cenas para cada estancia.' },
      gastos: { icon: 'üí∞', nombre: 'Gastos', desc: 'Registro de gastos del inmueble. Reparto entre nidos y control de pagos.' },
      mantenimiento: { icon: 'üîß', nombre: 'Mantenimiento', desc: 'Tareas programadas y aver√≠as. Historial de reparaciones y recordatorios.' },
      limpieza: { icon: 'üßπ', nombre: 'Limpieza', desc: 'Checklists por estancia y turnos. Control de limpieza al entrar y salir.' },
      planLimpieza: { icon: 'üìã', nombre: 'Plan Limpieza', desc: 'Programa semanal de limpieza por zonas. Tareas recurrentes para caseros y externos.' },
      eventos: { icon: 'üéâ', nombre: 'Eventos', desc: 'Celebraciones y reuniones familiares. Coordina cumplea√±os, fiestas y encuentros.' },
      prepararSemana: { icon: 'üìÜ', nombre: 'Preparar Semana', desc: 'Planifica la pr√≥xima semana. Reservas, tareas de limpieza, compras y men√∫s.' },
      especiales: { icon: 'üõçÔ∏è', nombre: 'Especiales', desc: 'Cat√°logo de productos especiales y delicatessen. Extras bajo petici√≥n.' }
    };

    const modulosDescripcionesGerente = {
      reservas: { icon: 'üìÖ', nombre: 'Reservas', desc: 'Gesti√≥n profesional de reservas. Check-in, check-out y confirmaciones.' },
      habitaciones: { icon: 'üõèÔ∏è', nombre: 'Habitaciones', desc: 'Define habitaciones y espacios disponibles. Capacidad, servicios y configuraci√≥n.' },
      huespedes: { icon: 'üë•', nombre: 'Hu√©spedes', desc: 'Registro de hu√©spedes. Titulares, acompa√±antes e invitados con historial.' },
      tarifas: { icon: 'üí∂', nombre: 'Tarifas', desc: 'Precios por temporada y tipo de habitaci√≥n. Descuentos y ofertas especiales.' },
      ventas: { icon: 'üí∞', nombre: 'Ventas', desc: 'Ingresos por estancias, hospitalidad, actividades y servicios adicionales.' },
      inventario: { icon: 'üì¶', nombre: 'Inventario', desc: 'Control de productos consumibles. Amenities, limpieza y suministros.' },
      ajuar: { icon: 'ü™ë', nombre: 'Ajuar', desc: 'Cat√°logo de mobiliario y equipamiento. Control de estado y ubicaci√≥n.' },
      contratos: { icon: 'üìù', nombre: 'Contratos', desc: 'Gesti√≥n de contratos de alquiler. Documentos y condiciones legales.' },
      servicios: { icon: 'üöê', nombre: 'Otros Servicios', desc: 'Servicios externos: transfers, excursiones, catering, gu√≠as tur√≠sticos.' },
      menus: { icon: 'üçΩÔ∏è', nombre: 'Men√∫s', desc: 'Planificaci√≥n de hospitalidad. Desayunos, comidas, cenas y bar.' }
    };

    const modulosDescripcionesCapataz = {
      parcelas: { icon: 'üó∫Ô∏è', nombre: 'Parcelas', desc: 'Gesti√≥n de parcelas y divisiones de terreno. Superficie, cultivos y linderos.' },
      instalaciones: { icon: 'üè≠', nombre: 'Instalaciones', desc: 'Naves, almacenes, pozos y otras infraestructuras de la finca.' },
      maquinaria: { icon: 'üöú', nombre: 'Maquinaria', desc: 'Inventario de tractores, aperos y equipamiento agr√≠cola.' },
      personal: { icon: 'üë∑', nombre: 'Personal', desc: 'Trabajadores de la finca. Jornales, tareas asignadas y contactos.' },
      labores: { icon: 'üìã', nombre: 'Labores', desc: 'Planificaci√≥n de trabajos agr√≠colas. Siembra, tratamientos, riegos.' },
      cosechas: { icon: 'üåª', nombre: 'Cosechas', desc: 'Registro de producciones. Kilos, calidades y destino de cada cosecha.' }
    };

    function abrirConfigModulos() {
      const grid = document.getElementById('modulos-config-grid');
      const header = document.getElementById('modal-config-header');
      let html = '';
      let modulos = {};
      let descripciones = {};
      let tipoGestion = '';

      if (bienData.mayordomoActivo) {
        modulos = bienData.mayordomoModulos || {};
        descripciones = modulosDescripcionesMayordomo;
        tipoGestion = 'mayordomo';
        header.style.background = 'var(--mayordomo)';
      } else if (bienData.gerenteActivo) {
        modulos = bienData.gerenteModulos || {};
        descripciones = modulosDescripcionesGerente;
        tipoGestion = 'gerente';
        header.style.background = '#4A5568';
      } else if (bienData.capatazActivo) {
        modulos = bienData.capatazModulos || {};
        descripciones = modulosDescripcionesCapataz;
        tipoGestion = 'capataz';
        header.style.background = 'var(--capataz)';
      } else {
        return;
      }

      Object.keys(descripciones).forEach(key => {
        const mod = descripciones[key];
        const activo = modulos[key] === true;
        html += `
          <div class="modulo-config-card ${activo ? 'activo' : ''} ${tipoGestion}" onclick="toggleModuloConfig('${key}', '${tipoGestion}')">
            <div class="modulo-config-check">‚úì</div>
            <div class="modulo-config-icon">${mod.icon}</div>
            <div class="modulo-config-nombre">${mod.nombre}</div>
            <div class="modulo-config-desc">${mod.desc}</div>
          </div>
        `;
      });

      grid.innerHTML = html;
      document.getElementById('modal-config-modulos').classList.add('active');
    }

    function cerrarConfigModulos() {
      document.getElementById('modal-config-modulos').classList.remove('active');
    }

    async function toggleModuloConfig(modulo, tipo) {
      try {
        let modulos, field;
        if (tipo === 'mayordomo') {
          modulos = bienData.mayordomoModulos || {};
          field = 'mayordomoModulos';
        } else if (tipo === 'gerente') {
          modulos = bienData.gerenteModulos || {};
          field = 'gerenteModulos';
        } else if (tipo === 'capataz') {
          modulos = bienData.capatazModulos || {};
          field = 'capatazModulos';
        } else {
          return;
        }

        const nuevoEstado = !modulos[modulo];
        const updateData = {};
        updateData[`${field}.${modulo}`] = nuevoEstado;

        await db.collection('bienes').doc(bienId).update(updateData);

        // Actualizar datos locales
        if (!bienData[field]) bienData[field] = {};
        bienData[field][modulo] = nuevoEstado;

        // Actualizar UI
        abrirConfigModulos();
        renderModulosBotones(tipo);
      } catch (error) {
        console.error('Error al cambiar m√≥dulo:', error);
        alert('Error al actualizar');
      }
    }

    async function toggleModulo(modulo, activo) {
      try {
        const updateData = {};
        updateData[`mayordomoModulos.${modulo}`] = activo;
        
        await db.collection('bienes').doc(bienId).update(updateData);
        
        // Actualizar datos locales
        if (!bienData.mayordomoModulos) bienData.mayordomoModulos = {};
        bienData.mayordomoModulos[modulo] = activo;
        
        renderMayordomoModulos();
      } catch (error) {
        console.error('Error al cambiar m√≥dulo:', error);
        alert('Error al actualizar');
      }
    }

    // Cerrar modal config al click fuera
    document.getElementById('modal-config-modulos').addEventListener('click', (e) => {
      if (e.target.id === 'modal-config-modulos') cerrarConfigModulos();
    });

    function irAMayordomo() {
      window.location.href = `mayordomo.html?bien=${bienId}`;
    }

    function irAInventario() {
      window.location.href = `mayordomo.html?bien=${bienId}`;
    }

    // CALENDARIO
    function renderCalendario() {
      const grid = document.getElementById('calendario-grid');
      const label = document.getElementById('calendario-mes-label');
      const year = calendarioMes.getFullYear();
      const month = calendarioMes.getMonth();
      
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      label.textContent = `${meses[month]} ${year}`;
      
      const primerDia = new Date(year, month, 1);
      const ultimoDia = new Date(year, month + 1, 0);
      let startDay = primerDia.getDay(); if (startDay === 0) startDay = 7; startDay--;
      const diasMes = ultimoDia.getDate();
      const hoy = new Date();
      
      let html = '';
      ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(d => { html += `<div class="calendario-dia-header">${d}</div>`; });
      
      const mesAnterior = new Date(year, month, 0);
      for (let i = startDay - 1; i >= 0; i--) {
        html += `<div class="calendario-dia otro-mes">${mesAnterior.getDate() - i}</div>`;
      }
      
      for (let dia = 1; dia <= diasMes; dia++) {
        const fecha = new Date(year, month, dia);
        const esHoy = fecha.toDateString() === hoy.toDateString();
        const reserva = getReservaParaDia(fecha);
        let clases = 'calendario-dia';
        if (esHoy) clases += ' hoy';
        if (reserva) clases += ` reservado tipo-${reserva.tipo || 'otros'}`;
        const tooltip = reserva ? (reserva.notas || tiposReserva[reserva.tipo]?.nombre || '') : '';
        html += `<div class="${clases}" onclick="clickDia(${dia})" title="${tooltip}">${dia}</div>`;
      }
      
      const totalCeldas = startDay + diasMes;
      const celdasFaltantes = totalCeldas % 7 === 0 ? 0 : 7 - (totalCeldas % 7);
      for (let i = 1; i <= celdasFaltantes; i++) {
        html += `<div class="calendario-dia otro-mes">${i}</div>`;
      }
      
      grid.innerHTML = html;
    }

    function getReservaParaDia(fecha) {
      const t = fecha.getTime();
      for (const r of reservasData) {
        if (!r.fechaInicio || !r.fechaFin) continue;
        const inicio = r.fechaInicio.toDate(); inicio.setHours(0,0,0,0);
        const fin = r.fechaFin.toDate(); fin.setHours(23,59,59,999);
        if (t >= inicio.getTime() && t <= fin.getTime()) return r;
      }
      return null;
    }

    function cambiarMes(delta) { calendarioMes.setMonth(calendarioMes.getMonth() + delta); renderCalendario(); }

    function clickDia(dia) {
      const fecha = new Date(calendarioMes.getFullYear(), calendarioMes.getMonth(), dia);
      const reserva = getReservaParaDia(fecha);
      abrirModalReserva(reserva ? reserva : null, reserva ? null : fecha);
    }

    function renderReservasLista() {
      const container = document.getElementById('reservas-lista-items');
      const containerMovil = document.getElementById('reservas-movil-lista');
      const hoy = new Date(); hoy.setHours(0,0,0,0);
      
      const proximas = reservasData.filter(r => r.fechaFin?.toDate() >= hoy).sort((a, b) => a.fechaInicio.toDate() - b.fechaInicio.toDate()).slice(0, 5);
      
      if (proximas.length === 0) { 
        container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay reservas pr√≥ximas</div>'; 
        if (containerMovil) containerMovil.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.85rem;padding:12px;">No hay reservas pr√≥ximas</div>';
        return; 
      }
      
      // Versi√≥n desktop
      container.innerHTML = proximas.map(r => {
        const inicio = r.fechaInicio.toDate();
        const fin = r.fechaFin.toDate();
        const dias = Math.ceil((fin - inicio) / (1000*60*60*24)) + 1;
        const tipoInfo = tiposReserva[r.tipo] || { nombre: 'Otros', color: '#9A9A9A' };
        return `
          <div class="reserva-item tipo-${r.tipo || 'otros'}" onclick="abrirModalReserva(reservasData.find(x=>x.id==='${r.id}'))" title="${r.notas || ''}">
            <div class="reserva-fecha">
              <div class="reserva-fecha-dia">${inicio.getDate()}</div>
              <div class="reserva-fecha-mes">${inicio.toLocaleDateString('es-ES', {month: 'short'}).toUpperCase()}</div>
            </div>
            <div class="reserva-info">
              <div class="reserva-quien">${tipoInfo.nombre}</div>
              <div class="reserva-periodo">${formatDateRange(inicio, fin)} ¬∑ ${dias} noche${dias > 1 ? 's' : ''}${r.notas ? ' ¬∑ ' + r.notas : ''}</div>
            </div>
          </div>
        `;
      }).join('');
      
      // Versi√≥n m√≥vil compacta
      if (containerMovil) {
        containerMovil.innerHTML = proximas.slice(0, 3).map(r => {
          const inicio = r.fechaInicio.toDate();
          const fin = r.fechaFin.toDate();
          const tipoInfo = tiposReserva[r.tipo] || { nombre: 'Otros', color: '#9A9A9A' };
          return `
            <div class="reserva-mini-item">
              <div class="reserva-mini-dot" style="background:${tipoInfo.color}"></div>
              <div class="reserva-mini-info">
                <div class="reserva-mini-titulo">${tipoInfo.nombre}</div>
                <div class="reserva-mini-fecha">${formatDateRange(inicio, fin)}</div>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function renderNidosLeyenda() {
      const container = document.getElementById('nidos-leyenda');
      const tiposConReservas = [...new Set(reservasData.map(r => r.tipo))].filter(Boolean);
      if (tiposConReservas.length === 0) { container.innerHTML = ''; return; }
      
      container.innerHTML = tiposConReservas.map(tipo => {
        const info = tiposReserva[tipo] || { nombre: tipo, color: '#9A9A9A' };
        return `<div class="nido-leyenda-item"><div class="nido-leyenda-color" style="background:${info.color}"></div><span>${info.nombre}</span></div>`;
      }).join('');
    }

    // MODAL RESERVA
    const modalReserva = document.getElementById('modal-reserva');
    const formReserva = document.getElementById('form-reserva');

    function abrirModalReserva(reserva = null, fechaPre = null) {
      editingReservaId = reserva?.id || null;
      formReserva.reset();
      document.getElementById('btn-eliminar-reserva').classList.toggle('hidden', !reserva);
      
      if (reserva) {
        document.getElementById('modal-reserva-title').textContent = '‚úèÔ∏è Editar reserva';
        document.getElementById('reserva-tipo').value = reserva.tipo || '';
        document.getElementById('reserva-inicio').value = formatDateInput(reserva.fechaInicio.toDate());
        document.getElementById('reserva-fin').value = formatDateInput(reserva.fechaFin.toDate());
        document.getElementById('reserva-notas').value = reserva.notas || '';
      } else {
        document.getElementById('modal-reserva-title').textContent = 'üìÖ Nueva reserva';
        if (fechaPre) {
          document.getElementById('reserva-inicio').value = formatDateInput(fechaPre);
          const fin = new Date(fechaPre); fin.setDate(fin.getDate() + 1);
          document.getElementById('reserva-fin').value = formatDateInput(fin);
        }
      }
      modalReserva.classList.add('active');
    }

    document.getElementById('modal-reserva-close').addEventListener('click', () => modalReserva.classList.remove('active'));
    document.getElementById('modal-reserva-cancelar').addEventListener('click', () => modalReserva.classList.remove('active'));
    modalReserva.addEventListener('click', (e) => { if (e.target === modalReserva) modalReserva.classList.remove('active'); });

    formReserva.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-reserva-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const tipo = document.getElementById('reserva-tipo').value;
        const tipoInfo = tiposReserva[tipo] || { nombre: 'Otros' };
        
        const data = {
          tipo,
          tipoNombre: tipoInfo.nombre,
          fechaInicio: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('reserva-inicio').value + 'T00:00:00')),
          fechaFin: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('reserva-fin').value + 'T23:59:59')),
          notas: document.getElementById('reserva-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('reservas');
        if (editingReservaId) { await ref.doc(editingReservaId).update(data); }
        else { data.creadoPor = currentUser.uid; data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp(); await ref.add(data); }
        
        modalReserva.classList.remove('active');
        await loadReservas();
        renderCalendario(); renderReservasLista(); renderNidosLeyenda();
      } catch (error) { console.error(error); alert('Error al guardar'); }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-reserva').addEventListener('click', async () => {
      if (!editingReservaId || !confirm('¬øEliminar esta reserva?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('reservas').doc(editingReservaId).delete();
        modalReserva.classList.remove('active');
        await loadReservas();
        renderCalendario(); renderReservasLista(); renderNidosLeyenda();
      } catch (error) { console.error(error); alert('Error'); }
    });

    // UTILS
    function toggleSection(s) { document.getElementById(`section-${s}`).classList.toggle('open'); }
    function toggleLimpieza(item) { item.classList.toggle('done'); item.querySelector('.limpieza-check').textContent = item.classList.contains('done') ? '‚úì' : ''; }
    function formatDate(d) { return new Date(d).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }); }
    function formatDateInput(d) { return d.toISOString().split('T')[0]; }
    function formatDateRange(i, f) { const o = { day: 'numeric', month: 'short' }; return `${i.toLocaleDateString('es-ES', o)} - ${f.toLocaleDateString('es-ES', o)}`; }
    function editarBien() {
      // Abrir modal de edici√≥n
      const modal = document.getElementById('modal-editar-bien');
      
      // Cargar datos actuales en el formulario
      document.getElementById('edit-nombre').value = bienData.nombre || '';
      document.getElementById('edit-tipo').value = bienData.tipo || 'inmueble';
      document.getElementById('edit-subtipo').value = bienData.subtipo || '';
      document.getElementById('edit-ubicacion').value = bienData.ubicacion || '';
      document.getElementById('edit-titularidad').value = bienData.titularidad || '';
      document.getElementById('edit-origen').value = bienData.origen || '';
      document.getElementById('edit-notas').value = bienData.notas || '';
      document.getElementById('edit-normas').value = bienData.normasConvivencia || '';
      
      // Cargar campos r√∫sticos si es terreno
      toggleCamposRustico();
      if (bienData.tipo === 'terreno') {
        // Aprovechamiento
        document.getElementById('aprov-agricola').checked = bienData.aprovechamiento?.agricola || false;
        document.getElementById('aprov-forestal').checked = bienData.aprovechamiento?.forestal || false;
        document.getElementById('aprov-cinegetico').checked = bienData.aprovechamiento?.cinegetico || false;
        
        // Fincas
        document.getElementById('tbody-fincas').innerHTML = '';
        if (bienData.fincas && bienData.fincas.length > 0) {
          bienData.fincas.forEach(f => addFincaRow(f));
        }
        actualizarTotalSuperficie();
      }
      
      // Cargar personal
      document.getElementById('personal-list').innerHTML = '';
      if (bienData.personal && bienData.personal.length > 0) {
        bienData.personal.forEach(p => addPersonalItem(p));
      }
      
      // Cargar contactos
      document.getElementById('contactos-list').innerHTML = '';
      if (bienData.contactos && bienData.contactos.length > 0) {
        bienData.contactos.forEach(c => addContactoItem(c));
      }
      
      // Reset tabs
      document.querySelectorAll('#modal-editar-bien .modal-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('#modal-editar-bien .tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector('#modal-editar-bien .modal-tab[data-tab="datos"]').classList.add('active');
      document.getElementById('tab-datos').classList.add('active');
      
      modal.classList.add('active');
    }

    // Tabs del modal editar
    document.querySelectorAll('#modal-editar-bien .modal-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('#modal-editar-bien .modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#modal-editar-bien .tab-content').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // ========== CAMPOS R√öSTICOS ==========
    function toggleCamposRustico() {
      const tipo = document.getElementById('edit-tipo').value;
      const camposRustico = document.getElementById('campos-rustico');
      
      if (tipo === 'terreno') {
        camposRustico.classList.remove('hidden');
      } else {
        camposRustico.classList.add('hidden');
      }
    }

    function addFincaRow(data = null) {
      const tbody = document.getElementById('tbody-fincas');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="padding:8px;">
          <input type="text" class="form-input finca-registro" style="padding:8px;font-size:0.85rem;" placeholder="N¬∫ registro" value="${data?.registro || ''}">
        </td>
        <td style="padding:8px;">
          <input type="text" class="form-input finca-nombre" style="padding:8px;font-size:0.85rem;" placeholder="Nombre" value="${data?.nombre || ''}">
        </td>
        <td style="padding:8px;">
          <input type="number" step="0.01" class="form-input finca-superficie" style="padding:8px;font-size:0.85rem;text-align:right;" placeholder="0.00" value="${data?.superficie || ''}" onchange="actualizarTotalSuperficie()">
        </td>
        <td style="padding:8px;">
          <select class="form-input finca-uso" style="padding:8px;font-size:0.85rem;">
            <option value="">‚Äî Uso ‚Äî</option>
            <option value="secano" ${data?.uso === 'secano' ? 'selected' : ''}>üåæ Secano</option>
            <option value="regadio" ${data?.uso === 'regadio' ? 'selected' : ''}>üíß Regad√≠o</option>
            <option value="olivar" ${data?.uso === 'olivar' ? 'selected' : ''}>ü´í Olivar</option>
            <option value="vinedo" ${data?.uso === 'vinedo' ? 'selected' : ''}>üçá Vi√±edo</option>
            <option value="monte" ${data?.uso === 'monte' ? 'selected' : ''}>üå≤ Monte</option>
            <option value="pastos" ${data?.uso === 'pastos' ? 'selected' : ''}>üêÑ Pastos</option>
            <option value="erial" ${data?.uso === 'erial' ? 'selected' : ''}>üèúÔ∏è Erial</option>
            <option value="otro" ${data?.uso === 'otro' ? 'selected' : ''}>üì¶ Otro</option>
          </select>
        </td>
        <td style="padding:8px;text-align:center;">
          <button type="button" onclick="this.closest('tr').remove(); actualizarTotalSuperficie();" style="background:none;border:none;cursor:pointer;font-size:1rem;">üóëÔ∏è</button>
        </td>
      `;
      tbody.appendChild(row);
    }

    function actualizarTotalSuperficie() {
      const total = calcularTotalSuperficie();
      document.getElementById('total-superficie').textContent = total.toFixed(2) + ' ha';
    }

    function calcularTotalSuperficie() {
      const inputs = document.querySelectorAll('.finca-superficie');
      let total = 0;
      inputs.forEach(input => {
        const val = parseFloat(input.value);
        if (!isNaN(val)) total += val;
      });
      return total;
    }

    function getFincasFromForm() {
      const rows = document.querySelectorAll('#tbody-fincas tr');
      const fincas = [];
      rows.forEach(row => {
        const registro = row.querySelector('.finca-registro')?.value?.trim();
        const nombre = row.querySelector('.finca-nombre')?.value?.trim();
        const superficie = parseFloat(row.querySelector('.finca-superficie')?.value) || 0;
        const uso = row.querySelector('.finca-uso')?.value;
        
        if (registro || nombre || superficie > 0) {
          fincas.push({ registro, nombre, superficie, uso });
        }
      });
      return fincas;
    }

    // Personal din√°mico
    function addPersonalItem(data = null) {
      const list = document.getElementById('personal-list');
      const item = document.createElement('div');
      item.className = 'dynamic-item';
      item.innerHTML = `
        <button type="button" class="btn-remove-item" onclick="this.parentElement.remove()">üóëÔ∏è</button>
        <div class="dynamic-item-row">
          <input type="text" class="form-input personal-nombre" placeholder="Nombre" value="${data?.nombre || ''}">
          <select class="form-input personal-tipo">
            <option value="residente" ${data?.tipo === 'residente' ? 'selected' : ''}>Residente</option>
            <option value="puntual" ${data?.tipo === 'puntual' ? 'selected' : ''}>Puntual</option>
          </select>
        </div>
        <div class="dynamic-item-row">
          <select class="form-input personal-rol">
            <option value="limpieza" ${data?.rol === 'limpieza' ? 'selected' : ''}>üßπ Limpieza</option>
            <option value="jardinero" ${data?.rol === 'jardinero' ? 'selected' : ''}>üå± Jardinero</option>
            <option value="cuidador" ${data?.rol === 'cuidador' ? 'selected' : ''}>üë®‚Äç‚öïÔ∏è Cuidador</option>
            <option value="mantenimiento" ${data?.rol === 'mantenimiento' ? 'selected' : ''}>üîß Mantenimiento</option>
            <option value="otro" ${data?.rol === 'otro' ? 'selected' : ''}>üìã Otro</option>
          </select>
          <input type="tel" class="form-input personal-telefono" placeholder="Tel√©fono" value="${data?.telefono || ''}">
        </div>
      `;
      list.appendChild(item);
    }

    function getPersonalFromForm() {
      const items = [];
      document.querySelectorAll('#personal-list .dynamic-item').forEach(item => {
        const nombre = item.querySelector('.personal-nombre').value;
        if (nombre) {
          items.push({
            nombre,
            tipo: item.querySelector('.personal-tipo').value,
            rol: item.querySelector('.personal-rol').value,
            telefono: item.querySelector('.personal-telefono').value
          });
        }
      });
      return items;
    }

    // Contactos din√°micos
    function addContactoItem(data = null) {
      const list = document.getElementById('contactos-list');
      const item = document.createElement('div');
      item.className = 'dynamic-item';
      item.innerHTML = `
        <button type="button" class="btn-remove-item" onclick="this.parentElement.remove()">üóëÔ∏è</button>
        <div class="dynamic-item-row">
          <input type="text" class="form-input contacto-nombre" placeholder="Nombre" value="${data?.nombre || ''}">
          <select class="form-input contacto-categoria">
            <option value="mantenimiento" ${data?.categoria === 'mantenimiento' ? 'selected' : ''}>üîß Mantenimiento</option>
            <option value="vecino" ${data?.categoria === 'vecino' ? 'selected' : ''}>üèòÔ∏è Vecino</option>
            <option value="emergencia" ${data?.categoria === 'emergencia' ? 'selected' : ''}>üö® Emergencia</option>
            <option value="otro" ${data?.categoria === 'otro' ? 'selected' : ''}>üìã Otro</option>
          </select>
        </div>
        <div class="dynamic-item-row">
          <input type="tel" class="form-input contacto-telefono" placeholder="Tel√©fono" value="${data?.telefono || ''}">
          <input type="text" class="form-input contacto-notas" placeholder="Notas" value="${data?.notas || ''}">
        </div>
      `;
      list.appendChild(item);
    }

    function getContactosFromForm() {
      const items = [];
      document.querySelectorAll('#contactos-list .dynamic-item').forEach(item => {
        const nombre = item.querySelector('.contacto-nombre').value;
        if (nombre) {
          items.push({
            nombre,
            categoria: item.querySelector('.contacto-categoria').value,
            telefono: item.querySelector('.contacto-telefono').value,
            notas: item.querySelector('.contacto-notas').value
          });
        }
      });
      return items;
    }

    // Cerrar modal editar
    document.getElementById('modal-editar-close').addEventListener('click', () => {
      document.getElementById('modal-editar-bien').classList.remove('active');
    });
    document.getElementById('modal-editar-cancelar').addEventListener('click', () => {
      document.getElementById('modal-editar-bien').classList.remove('active');
    });
    document.getElementById('modal-editar-bien').addEventListener('click', (e) => {
      if (e.target.id === 'modal-editar-bien') {
        document.getElementById('modal-editar-bien').classList.remove('active');
      }
    });

    // Guardar cambios del bien
    document.getElementById('form-editar-bien').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('modal-editar-guardar');
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      try {
        const tipo = document.getElementById('edit-tipo').value;
        
        const updateData = {
          nombre: document.getElementById('edit-nombre').value,
          tipo: tipo,
          subtipo: document.getElementById('edit-subtipo').value,
          ubicacion: document.getElementById('edit-ubicacion').value,
          titularidad: document.getElementById('edit-titularidad').value,
          origen: document.getElementById('edit-origen').value,
          notas: document.getElementById('edit-notas').value,
          normasConvivencia: document.getElementById('edit-normas').value,
          personal: getPersonalFromForm(),
          contactos: getContactosFromForm(),
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Si es terreno/r√∫stico, a√±adir campos espec√≠ficos
        if (tipo === 'terreno') {
          updateData.aprovechamiento = {
            agricola: document.getElementById('aprov-agricola').checked,
            forestal: document.getElementById('aprov-forestal').checked,
            cinegetico: document.getElementById('aprov-cinegetico').checked
          };
          updateData.fincas = getFincasFromForm();
          updateData.superficieTotal = calcularTotalSuperficie();
        }

        await db.collection('bienes').doc(bienId).update(updateData);
        
        // Actualizar datos locales
        Object.assign(bienData, updateData);

        document.getElementById('modal-editar-bien').classList.remove('active');
        
        // Re-renderizar todo el bien con los nuevos datos
        renderBien();
        
        alert('‚úÖ Cambios guardados');

      } catch (error) {
        console.error('Error guardando:', error);
        alert('Error al guardar: ' + error.message);
      }

      btn.disabled = false;
      btn.textContent = 'üíæ Guardar cambios';
    });

    document.getElementById('btn-editar').addEventListener('click', editarBien);

    // ========== INVENTARIO ==========
    const catIcons2 = {
      limpieza: 'üßπ',
      bano: 'üöø',
      cocina: 'üç≥',
      alimentos: 'ü•´',
      bebidas: 'üç∑',
      otro: 'üì¶'
    };

    const catLabels = {
      limpieza: 'Limpieza',
      bano: 'Ba√±o',
      cocina: 'Cocina',
      alimentos: 'Alimentos',
      bebidas: 'Bebidas',
      otro: 'Otro'
    };

    function renderInventario() {
      renderInventarioStats();
      renderInventarioCategorias();
      renderInventarioList();
    }

    function renderInventarioStats() {
      const container = document.getElementById('inventario-stats');
      if (!container) return;

      const total = inventarioData.length;
      const bajos = inventarioData.filter(i => i.stockActual <= i.stockMinimo).length;
      const ok = total - bajos;

      container.innerHTML = `
        <div class="inventario-stat">
          <div class="inventario-stat-valor">${total}</div>
          <div class="inventario-stat-label">Total</div>
        </div>
        <div class="inventario-stat">
          <div class="inventario-stat-valor alerta">${bajos}</div>
          <div class="inventario-stat-label">Bajo m√≠nimo</div>
        </div>
        <div class="inventario-stat">
          <div class="inventario-stat-valor" style="color:var(--success)">${ok}</div>
          <div class="inventario-stat-label">OK</div>
        </div>
      `;
    }

    function renderInventarioCategorias() {
      const container = document.getElementById('inventario-categorias');
      if (!container) return;

      // Obtener categor√≠as que tienen items
      const categoriasConItems = ['todos', ...new Set(inventarioData.map(i => i.categoria))];
      
      container.innerHTML = categoriasConItems.map(cat => `
        <button class="inventario-cat-btn ${inventarioFiltro === cat ? 'active' : ''}" onclick="filtrarInventario('${cat}')">
          ${cat === 'todos' ? 'üìã Todos' : (catIcons2[cat] || 'üì¶') + ' ' + (catLabels[cat] || cat)}
        </button>
      `).join('');
    }

    function filtrarInventario(cat) {
      inventarioFiltro = cat;
      renderInventarioCategorias();
      renderInventarioList();
    }

    function renderInventarioList() {
      const container = document.getElementById('inventario-list');
      if (!container) return;

      let items = inventarioData;
      
      // Filtrar por categor√≠a
      if (inventarioFiltro !== 'todos') {
        items = items.filter(i => i.categoria === inventarioFiltro);
      }

      // Ordenar: primero los bajo m√≠nimo
      items.sort((a, b) => {
        const aBajo = a.stockActual <= a.stockMinimo;
        const bBajo = b.stockActual <= b.stockMinimo;
        if (aBajo && !bBajo) return -1;
        if (!aBajo && bBajo) return 1;
        return a.nombre.localeCompare(b.nombre);
      });

      if (items.length === 0) {
        container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay art√≠culos en el inventario</div>';
        return;
      }

      container.innerHTML = items.map(item => {
        const bajo = item.stockActual <= item.stockMinimo;
        const icon = catIcons2[item.categoria] || 'üì¶';
        
        return `
          <div class="inventario-item ${bajo ? 'bajo' : 'ok'}" onclick="abrirModalInventario(inventarioData.find(x=>x.id==='${item.id}'))">
            <span class="inventario-item-icon">${icon}</span>
            <div class="inventario-item-info">
              <div class="inventario-item-nombre">${item.nombre}</div>
              <div class="inventario-item-meta">${item.unidad || 'uds'}${item.fechaCaducidad ? ' ¬∑ Cad: ' + formatDate(item.fechaCaducidad) : ''}</div>
            </div>
            <div class="inventario-item-stock">
              <div class="inventario-item-cantidad ${bajo ? 'bajo' : 'ok'}">${item.stockActual}</div>
              <div class="inventario-item-minimo">m√≠n. ${item.stockMinimo}</div>
            </div>
            <div class="inventario-quick-btns" onclick="event.stopPropagation()">
              <button class="inventario-quick-btn menos" onclick="ajustarStock('${item.id}', -1)">‚àí</button>
              <button class="inventario-quick-btn mas" onclick="ajustarStock('${item.id}', 1)">+</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function ajustarStock(itemId, delta) {
      const item = inventarioData.find(i => i.id === itemId);
      if (!item) return;

      const nuevoStock = Math.max(0, item.stockActual + delta);
      
      try {
        await db.collection('bienes').doc(bienId).collection('inventario').doc(itemId).update({
          stockActual: nuevoStock,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Actualizar localmente
        item.stockActual = nuevoStock;
        renderInventario();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // MODAL INVENTARIO
    const modalInventario = document.getElementById('modal-inventario');
    const formInventario = document.getElementById('form-inventario');

    function abrirModalInventario(item = null) {
      editingInventarioId = item?.id || null;
      formInventario.reset();
      document.getElementById('btn-eliminar-inventario').classList.toggle('hidden', !item);
      
      if (item) {
        document.getElementById('modal-inventario-title').textContent = '‚úèÔ∏è Editar art√≠culo';
        document.getElementById('inv-nombre').value = item.nombre || '';
        document.getElementById('inv-categoria').value = item.categoria || 'otro';
        document.getElementById('inv-unidad').value = item.unidad || 'uds';
        document.getElementById('inv-stock').value = item.stockActual || 0;
        document.getElementById('inv-minimo').value = item.stockMinimo || 1;
        document.getElementById('inv-caducidad').value = item.fechaCaducidad || '';
        document.getElementById('inv-notas').value = item.notas || '';
      } else {
        document.getElementById('modal-inventario-title').textContent = 'üì¶ Nuevo art√≠culo';
      }
      modalInventario.classList.add('active');
    }

    document.getElementById('modal-inventario-close').addEventListener('click', () => modalInventario.classList.remove('active'));
    document.getElementById('modal-inventario-cancelar').addEventListener('click', () => modalInventario.classList.remove('active'));
    modalInventario.addEventListener('click', (e) => { if (e.target === modalInventario) modalInventario.classList.remove('active'); });

    formInventario.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-inventario-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const data = {
          nombre: document.getElementById('inv-nombre').value,
          categoria: document.getElementById('inv-categoria').value,
          unidad: document.getElementById('inv-unidad').value,
          stockActual: parseInt(document.getElementById('inv-stock').value) || 0,
          stockMinimo: parseInt(document.getElementById('inv-minimo').value) || 1,
          fechaCaducidad: document.getElementById('inv-caducidad').value || null,
          notas: document.getElementById('inv-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('inventario');
        if (editingInventarioId) {
          await ref.doc(editingInventarioId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        
        modalInventario.classList.remove('active');
        await loadInventario();
        renderInventario();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-inventario').addEventListener('click', async () => {
      if (!editingInventarioId || !confirm('¬øEliminar este art√≠culo?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('inventario').doc(editingInventarioId).delete();
        modalInventario.classList.remove('active');
        await loadInventario();
        renderInventario();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ========== GASTOS ==========
    const gastoCatIcons = {
      luz: 'üí°',
      agua: 'üíß',
      gas: 'üî•',
      comunidad: 'üè¢',
      seguro: 'üõ°Ô∏è',
      mantenimiento: 'üîß',
      limpieza: 'üßπ',
      compras: 'üõí',
      otro: 'üìã'
    };

    const gastoCatLabels = {
      luz: 'Luz',
      agua: 'Agua',
      gas: 'Gas',
      comunidad: 'Comunidad',
      seguro: 'Seguro',
      mantenimiento: 'Mantenimiento',
      limpieza: 'Limpieza',
      compras: 'Compras',
      otro: 'Otro'
    };

    const coloresNidoHex = ['#7A9E7E', '#C17757', '#6B8E9F', '#9B8EA6'];

    function renderGastos() {
      renderGastosPeriodoSelector();
      renderGastosResumen();
      renderGastosCategorias();
      renderGastosList();
      renderRepartoTable();
      renderRepartoDesglose();
      
      // Popular selector de generador con nidos
      const selectGenerador = document.getElementById('gasto-generador');
      if (selectGenerador) {
        selectGenerador.innerHTML = '<option value="">Sin asignar</option>' +
          nidosData.map(n => `<option value="${n.id}">${n.nombre}</option>`).join('');
      }
    }

    function cambiarTabGastos(tab) {
      gastosTab = tab;
      document.querySelectorAll('.gastos-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.gastos-tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.gastos-tab:nth-child(${tab === 'registro' ? 1 : 2})`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    function renderGastosPeriodoSelector() {
      const container = document.getElementById('gastos-periodo-selector');
      if (!container) return;

      container.innerHTML = `
        <button class="gastos-periodo-btn ${gastosPeriodo === 'mes' ? 'active' : ''}" onclick="cambiarPeriodoGastos('mes')">Este mes</button>
        <button class="gastos-periodo-btn ${gastosPeriodo === 'a√±o' ? 'active' : ''}" onclick="cambiarPeriodoGastos('a√±o')">Este a√±o</button>
        <button class="gastos-periodo-btn ${gastosPeriodo === 'todos' ? 'active' : ''}" onclick="cambiarPeriodoGastos('todos')">Todos</button>
      `;
    }

    function cambiarPeriodoGastos(periodo) {
      gastosPeriodo = periodo;
      renderGastosPeriodoSelector();
      renderGastosResumen();
      renderGastosCategorias();
      renderGastosList();
      renderRepartoDesglose();
    }

    function getGastosFiltrados() {
      const hoy = new Date();
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const inicioA√±o = new Date(hoy.getFullYear(), 0, 1);

      return gastosData.filter(g => {
        if (!g.fecha) return false;
        const fechaGasto = new Date(g.fecha);
        
        if (gastosPeriodo === 'mes') {
          return fechaGasto >= inicioMes;
        } else if (gastosPeriodo === 'a√±o') {
          return fechaGasto >= inicioA√±o;
        }
        return true;
      });
    }

    function renderGastosResumen() {
      const container = document.getElementById('gastos-resumen');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      const total = gastosFiltrados.reduce((sum, g) => sum + (parseFloat(g.importe) || 0), 0);
      const numGastos = gastosFiltrados.length;

      const periodoLabel = gastosPeriodo === 'mes' ? 'Este mes' : gastosPeriodo === 'a√±o' ? 'Este a√±o' : 'Total';

      container.innerHTML = `
        <div class="gasto-stat">
          <div class="gasto-stat-valor">‚Ç¨${total.toFixed(2)}</div>
          <div class="gasto-stat-label">${periodoLabel}</div>
        </div>
        <div class="gasto-stat">
          <div class="gasto-stat-valor" style="color:var(--text)">${numGastos}</div>
          <div class="gasto-stat-label">Registros</div>
        </div>
      `;
    }

    function renderGastosCategorias() {
      const container = document.getElementById('gastos-categorias');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      
      const porCategoria = {};
      gastosFiltrados.forEach(g => {
        const cat = g.categoria || 'otro';
        if (!porCategoria[cat]) porCategoria[cat] = 0;
        porCategoria[cat] += parseFloat(g.importe) || 0;
      });

      const categorias = Object.entries(porCategoria).sort((a, b) => b[1] - a[1]);

      if (categorias.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = categorias.map(([cat, total]) => `
        <div class="gasto-cat-chip">
          <span>${gastoCatIcons[cat] || 'üìã'}</span>
          <span>${gastoCatLabels[cat] || cat}</span>
          <span class="gasto-cat-chip-valor">‚Ç¨${total.toFixed(0)}</span>
        </div>
      `).join('');
    }

    function renderGastosList() {
      const container = document.getElementById('gastos-list');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();

      if (gastosFiltrados.length === 0) {
        container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay gastos registrados</div>';
        return;
      }

      const gastosRecientes = gastosFiltrados.slice(0, 15);

      container.innerHTML = gastosRecientes.map(g => {
        const icon = gastoCatIcons[g.categoria] || 'üìã';
        const generador = g.generadorId ? nidosData.find(n => n.id === g.generadorId) : null;
        const fecha = g.fecha ? new Date(g.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }) : '';
        
        return `
          <div class="gasto-item" onclick="abrirModalGasto(gastosData.find(x=>x.id==='${g.id}'))">
            <span class="gasto-item-icon">${icon}</span>
            <div class="gasto-item-info">
              <div class="gasto-item-concepto">${g.concepto}</div>
              <div class="gasto-item-meta">${fecha}${g.proveedor ? ' ¬∑ ' + g.proveedor : ''}</div>
            </div>
            ${generador ? `<span class="gasto-item-generador">${generador.nombre}</span>` : ''}
            <span class="gasto-item-importe">‚Ç¨${parseFloat(g.importe).toFixed(2)}</span>
          </div>
        `;
      }).join('');
    }

    // TABLA DE REPARTO
    function renderRepartoTable() {
      const container = document.getElementById('reparto-table');
      if (!container) return;

      if (nidosData.length === 0) {
        container.innerHTML = '<tr><td>No hay nidos configurados</td></tr>';
        return;
      }

      let html = `
        <thead>
          <tr>
            <th>Nido</th>
            <th style="text-align:right">Porcentaje</th>
          </tr>
        </thead>
        <tbody>
      `;

      nidosData.forEach((nido, i) => {
        const color = coloresNidoHex[i % coloresNidoHex.length];
        const porcentaje = repartoData[nido.id] || 0;
        
        html += `
          <tr>
            <td>
              <div class="reparto-nido-nombre">
                <div class="reparto-nido-color" style="background:${color}"></div>
                <span>${nido.nombre}</span>
              </div>
            </td>
            <td style="text-align:right">
              <input type="number" class="reparto-input" 
                id="reparto-${nido.id}" 
                value="${porcentaje}" 
                min="0" max="100" 
                onchange="actualizarReparto('${nido.id}', this.value)"> %
            </td>
          </tr>
        `;
      });

      html += '</tbody>';
      container.innerHTML = html;

      actualizarTotalReparto();
    }

    function actualizarReparto(nidoId, valor) {
      repartoData[nidoId] = parseInt(valor) || 0;
      actualizarTotalReparto();
    }

    function actualizarTotalReparto() {
      const container = document.getElementById('reparto-total');
      if (!container) return;

      const total = Object.values(repartoData).reduce((sum, v) => sum + (parseInt(v) || 0), 0);
      const esValido = total === 100;

      container.innerHTML = `
        <span class="reparto-total-label">Total</span>
        <span class="reparto-total-valor ${esValido ? 'ok' : 'error'}">${total}%</span>
      `;
    }

    async function guardarReparto() {
      const total = Object.values(repartoData).reduce((sum, v) => sum + (parseInt(v) || 0), 0);
      
      if (total !== 100) {
        alert('El total debe sumar exactamente 100%');
        return;
      }

      try {
        await db.collection('bienes').doc(bienId).collection('config').doc('reparto').set({
          porcentajes: repartoData,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Reparto guardado');
        renderRepartoDesglose();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
    }

    function renderRepartoDesglose() {
      const container = document.getElementById('reparto-desglose');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      const total = gastosFiltrados.reduce((sum, g) => sum + (parseFloat(g.importe) || 0), 0);

      if (total === 0 || nidosData.length === 0) {
        container.innerHTML = '';
        return;
      }

      const periodoLabel = gastosPeriodo === 'mes' ? 'este mes' : gastosPeriodo === 'a√±o' ? 'este a√±o' : 'en total';

      let html = `<div class="reparto-desglose-title">Desglose ${periodoLabel} (‚Ç¨${total.toFixed(2)})</div>`;

      nidosData.forEach((nido, i) => {
        const porcentaje = repartoData[nido.id] || 0;
        const importe = (total * porcentaje / 100);
        const color = coloresNidoHex[i % coloresNidoHex.length];
        
        html += `
          <div class="reparto-desglose-item">
            <span style="display:flex;align-items:center;gap:6px;">
              <span style="width:8px;height:8px;border-radius:2px;background:${color}"></span>
              ${nido.nombre} (${porcentaje}%)
            </span>
            <span>‚Ç¨${importe.toFixed(2)}</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // MODAL GASTOS
    const modalGasto = document.getElementById('modal-gasto');
    const formGasto = document.getElementById('form-gasto');

    function abrirModalGasto(gasto = null) {
      editingGastoId = gasto?.id || null;
      formGasto.reset();
      document.getElementById('btn-eliminar-gasto').classList.toggle('hidden', !gasto);
      
      document.getElementById('gasto-fecha').value = formatDateInput(new Date());
      
      // Cargar miembros para reparto
      cargarMiembrosReparto(gasto?.repartos || null);
      
      if (gasto) {
        document.getElementById('modal-gasto-title').textContent = '‚úèÔ∏è Editar gasto';
        document.getElementById('gasto-fecha').value = gasto.fecha || '';
        document.getElementById('gasto-importe').value = gasto.importe || '';
        document.getElementById('gasto-concepto').value = gasto.concepto || '';
        document.getElementById('gasto-categoria').value = gasto.categoria || 'otro';
        document.getElementById('gasto-proveedor').value = gasto.proveedor || '';
        document.getElementById('gasto-generador').value = gasto.generadorId || '';
        document.getElementById('gasto-notas').value = gasto.notas || '';
      } else {
        document.getElementById('modal-gasto-title').textContent = 'üí∂ Nuevo gasto';
      }
      modalGasto.classList.add('active');
    }

    // ========== REPARTO DE GASTOS ==========
    let miembrosReparto = [];

    function cargarMiembrosReparto(repartosExistentes = null) {
      const container = document.getElementById('reparto-miembros');
      miembrosReparto = [];

      // Obtener miembros de todos los nidos
      nidosData.forEach(nido => {
        (nido.miembrosData || []).forEach(m => {
          const repartoExistente = repartosExistentes?.find(r => r.miembroId === m.visibleId);
          miembrosReparto.push({
            id: m.visibleId || m.id,
            nombre: m.nombre,
            nido: nido.nombre,
            nidoId: nido.id,
            selected: repartoExistente ? true : (repartosExistentes ? false : true),
            porcentaje: repartoExistente?.porcentaje || 0
          });
        });
      });

      // Si no hay repartos existentes, aplicar reparto lineal
      if (!repartosExistentes && miembrosReparto.length > 0) {
        const pctEach = Math.floor(100 / miembrosReparto.length);
        const resto = 100 - (pctEach * miembrosReparto.length);
        miembrosReparto.forEach((m, i) => {
          m.porcentaje = pctEach + (i < resto ? 1 : 0);
        });
      }

      renderMiembrosReparto();
    }

    function renderMiembrosReparto() {
      const container = document.getElementById('reparto-miembros');
      const importe = parseFloat(document.getElementById('gasto-importe')?.value) || 0;

      if (miembrosReparto.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:12px;">No hay miembros</div>';
        return;
      }

      container.innerHTML = miembrosReparto.map((m, i) => {
        const importeMiembro = (importe * m.porcentaje / 100).toFixed(2);
        return `
          <div class="reparto-miembro ${m.selected ? 'selected' : ''}">
            <input type="checkbox" class="reparto-miembro-check" ${m.selected ? 'checked' : ''} onchange="toggleMiembroReparto(${i})">
            <div class="reparto-miembro-info">
              <div class="reparto-miembro-nombre">${m.nombre}</div>
              <div class="reparto-miembro-nido">ü™∫ ${m.nido}</div>
            </div>
            <div class="reparto-miembro-pct">
              <input type="number" value="${m.porcentaje}" min="0" max="100" 
                     onchange="actualizarPorcentaje(${i}, this.value)" 
                     ${!m.selected ? 'disabled' : ''}>%
            </div>
            <div class="reparto-miembro-importe">${importeMiembro} ‚Ç¨</div>
          </div>
        `;
      }).join('');

      actualizarResumenReparto();
    }

    function toggleMiembroReparto(index) {
      miembrosReparto[index].selected = !miembrosReparto[index].selected;
      if (!miembrosReparto[index].selected) {
        miembrosReparto[index].porcentaje = 0;
      }
      repartoLineal();
    }

    function actualizarPorcentaje(index, valor) {
      miembrosReparto[index].porcentaje = parseFloat(valor) || 0;
      renderMiembrosReparto();
    }

    function repartoLineal() {
      const seleccionados = miembrosReparto.filter(m => m.selected);
      if (seleccionados.length === 0) {
        miembrosReparto.forEach(m => m.porcentaje = 0);
        renderMiembrosReparto();
        return;
      }

      const pctEach = Math.floor(100 / seleccionados.length);
      const resto = 100 - (pctEach * seleccionados.length);
      
      let idx = 0;
      miembrosReparto.forEach(m => {
        if (m.selected) {
          m.porcentaje = pctEach + (idx < resto ? 1 : 0);
          idx++;
        } else {
          m.porcentaje = 0;
        }
      });

      renderMiembrosReparto();
    }

    function actualizarResumenReparto() {
      const totalEl = document.getElementById('reparto-total');
      const pctEl = document.getElementById('reparto-pct-total');
      const warningEl = document.getElementById('reparto-warning');

      const suma = miembrosReparto.reduce((acc, m) => acc + m.porcentaje, 0);
      pctEl.textContent = suma + '%';

      if (suma !== 100) {
        totalEl.classList.add('error');
        warningEl.classList.remove('hidden');
      } else {
        totalEl.classList.remove('error');
        warningEl.classList.add('hidden');
      }
    }

    // Actualizar importes cuando cambia el importe total
    document.getElementById('gasto-importe')?.addEventListener('input', renderMiembrosReparto);

    function previsualizarReparto() {
      const suma = miembrosReparto.reduce((acc, m) => acc + m.porcentaje, 0);
      if (suma !== 100) {
        alert('Los porcentajes deben sumar exactamente 100%');
        return;
      }

      const importe = parseFloat(document.getElementById('gasto-importe')?.value) || 0;
      const concepto = document.getElementById('gasto-concepto')?.value || 'Sin concepto';

      if (importe <= 0) {
        alert('Introduce un importe v√°lido');
        return;
      }

      document.getElementById('preview-concepto').textContent = concepto;
      document.getElementById('preview-total').textContent = importe.toFixed(2) + ' ‚Ç¨';

      const lista = document.getElementById('preview-lista');
      lista.innerHTML = miembrosReparto
        .filter(m => m.selected && m.porcentaje > 0)
        .map(m => {
          const importeMiembro = (importe * m.porcentaje / 100).toFixed(2);
          return `
            <div class="preview-item">
              <span class="preview-nombre">${m.nombre}</span>
              <div>
                <span class="preview-importe">${importeMiembro} ‚Ç¨</span>
                <span class="preview-pct">(${m.porcentaje}%)</span>
              </div>
            </div>
          `;
        }).join('');

      document.getElementById('modal-reparto-preview').classList.add('active');
    }

    function cerrarPreviewReparto() {
      document.getElementById('modal-reparto-preview').classList.remove('active');
    }

    async function guardarGastoConReparto() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      try {
        const importe = parseFloat(document.getElementById('gasto-importe').value) || 0;
        const generadorId = document.getElementById('gasto-generador').value;
        const nido = generadorId ? nidosData.find(n => n.id === generadorId) : null;

        const repartos = miembrosReparto
          .filter(m => m.selected && m.porcentaje > 0)
          .map(m => ({
            miembroId: m.id,
            nombre: m.nombre,
            nidoId: m.nidoId,
            porcentaje: m.porcentaje,
            importe: parseFloat((importe * m.porcentaje / 100).toFixed(2))
          }));

        const data = {
          fecha: document.getElementById('gasto-fecha').value,
          importe: importe,
          concepto: document.getElementById('gasto-concepto').value,
          categoria: document.getElementById('gasto-categoria').value,
          proveedor: document.getElementById('gasto-proveedor').value,
          generadorId: generadorId || null,
          generadorNombre: nido?.nombre || null,
          notas: document.getElementById('gasto-notas').value,
          repartos: repartos,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };

        const ref = db.collection('bienes').doc(bienId).collection('gastos');
        if (editingGastoId) {
          await ref.doc(editingGastoId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }

        cerrarPreviewReparto();
        modalGasto.classList.remove('active');
        await loadGastos();
        renderGastos();
      } catch (error) {
        console.error(error);
        alert('Error al guardar: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üíæ Guardar';
      }
    }

    document.getElementById('modal-gasto-close').addEventListener('click', () => modalGasto.classList.remove('active'));
    document.getElementById('modal-gasto-cancelar').addEventListener('click', () => modalGasto.classList.remove('active'));
    modalGasto.addEventListener('click', (e) => { if (e.target === modalGasto) modalGasto.classList.remove('active'); });
    
    // Preview reparto modal
    document.getElementById('modal-reparto-preview')?.addEventListener('click', (e) => {
      if (e.target.id === 'modal-reparto-preview') cerrarPreviewReparto();
    });

    formGasto.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-gasto-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const generadorId = document.getElementById('gasto-generador').value;
        const nido = generadorId ? nidosData.find(n => n.id === generadorId) : null;
        
        const data = {
          fecha: document.getElementById('gasto-fecha').value,
          importe: parseFloat(document.getElementById('gasto-importe').value) || 0,
          concepto: document.getElementById('gasto-concepto').value,
          categoria: document.getElementById('gasto-categoria').value,
          proveedor: document.getElementById('gasto-proveedor').value,
          generadorId: generadorId || null,
          generadorNombre: nido?.nombre || null,
          notas: document.getElementById('gasto-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('gastos');
        if (editingGastoId) {
          await ref.doc(editingGastoId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        
        modalGasto.classList.remove('active');
        await loadGastos();
        renderGastos();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-gasto').addEventListener('click', async () => {
      if (!editingGastoId || !confirm('¬øEliminar este gasto?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('gastos').doc(editingGastoId).delete();
        modalGasto.classList.remove('active');
        await loadGastos();
        renderGastos();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ========== CASEROS ==========
    const seccionesPermisos = ['reservas', 'inventario', 'ajuar', 'mantenimiento', 'limpieza', 'gastos', 'documentos'];
    const seccionesLabels = {
      reservas: 'üìÖ',
      inventario: 'üì¶',
      ajuar: 'ü™ë',
      mantenimiento: 'üîß',
      limpieza: 'üßπ',
      gastos: 'üí∂',
      documentos: 'üìÑ'
    };

    function renderCaserosList() {
      const container = document.getElementById('lista-caseros');
      if (!container) return;

      if (caserosData.length === 0) {
        container.innerHTML = '<div class="empty-mini">Sin caseros asignados</div>';
        return;
      }

      container.innerHTML = caserosData.map(c => {
        const iniciales = c.nombre ? c.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
        
        // Contar permisos activos
        const permisos = c.permisos || {};
        const permisosActivos = [];
        seccionesPermisos.forEach(sec => {
          if (permisos[sec]?.ver) {
            const tieneEdicion = permisos[sec].crear || permisos[sec].editar;
            permisosActivos.push({ sec, limitado: !tieneEdicion });
          }
        });

        return `
          <div class="casero-card" onclick="abrirModalCasero(caserosData.find(x=>x.id==='${c.id}'))">
            <div class="casero-card-header">
              <div class="casero-avatar">${iniciales}</div>
              <div class="casero-info">
                <div class="casero-nombre">${c.nombre}</div>
                <div class="casero-email">${c.email}${c.telefono ? ' ¬∑ ' + c.telefono : ''}</div>
              </div>
            </div>
            <div class="casero-permisos">
              ${permisosActivos.map(p => `
                <span class="casero-permiso-badge ${p.limitado ? 'limitado' : ''}">${seccionesLabels[p.sec]}</span>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // MODAL CASERO
    const modalCasero = document.getElementById('modal-casero');
    const formCasero = document.getElementById('form-casero');

    function abrirModalCasero(casero = null) {
      editingCaseroId = casero?.id || null;
      formCasero.reset();
      document.getElementById('btn-eliminar-casero').classList.toggle('hidden', !casero);
      
      // Reset checkboxes a valores por defecto
      seccionesPermisos.forEach(sec => {
        document.getElementById(`perm-${sec}-v`).checked = true;
        document.getElementById(`perm-${sec}-c`).checked = ['inventario', 'mantenimiento', 'limpieza', 'gastos'].includes(sec);
        document.getElementById(`perm-${sec}-e`).checked = ['inventario', 'limpieza'].includes(sec);
        document.getElementById(`perm-${sec}-b`).checked = false;
      });
      
      if (casero) {
        document.getElementById('modal-casero-title').textContent = '‚úèÔ∏è Editar casero';
        document.getElementById('casero-nombre').value = casero.nombre || '';
        document.getElementById('casero-email').value = casero.email || '';
        document.getElementById('casero-email').disabled = true; // No editar email
        document.getElementById('casero-telefono').value = casero.telefono || '';
        
        // Cargar permisos
        const permisos = casero.permisos || {};
        seccionesPermisos.forEach(sec => {
          document.getElementById(`perm-${sec}-v`).checked = permisos[sec]?.ver || false;
          document.getElementById(`perm-${sec}-c`).checked = permisos[sec]?.crear || false;
          document.getElementById(`perm-${sec}-e`).checked = permisos[sec]?.editar || false;
          document.getElementById(`perm-${sec}-b`).checked = permisos[sec]?.borrar || false;
        });
      } else {
        document.getElementById('modal-casero-title').textContent = 'üë§ Nuevo casero';
        document.getElementById('casero-email').disabled = false;
      }
      modalCasero.classList.add('active');
    }

    document.getElementById('modal-casero-close').addEventListener('click', () => modalCasero.classList.remove('active'));
    document.getElementById('modal-casero-cancelar').addEventListener('click', () => modalCasero.classList.remove('active'));
    modalCasero.addEventListener('click', (e) => { if (e.target === modalCasero) modalCasero.classList.remove('active'); });

    formCasero.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-casero-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        // Recoger permisos de la matriz
        const permisos = {};
        seccionesPermisos.forEach(sec => {
          permisos[sec] = {
            ver: document.getElementById(`perm-${sec}-v`).checked,
            crear: document.getElementById(`perm-${sec}-c`).checked,
            editar: document.getElementById(`perm-${sec}-e`).checked,
            borrar: document.getElementById(`perm-${sec}-b`).checked
          };
        });

        const data = {
          nombre: document.getElementById('casero-nombre').value,
          email: document.getElementById('casero-email').value.toLowerCase().trim(),
          telefono: document.getElementById('casero-telefono').value,
          permisos: permisos,
          bienId: bienId,
          bienNombre: bienData.nombre || '',
          familiaId: bienData.familiaId || familiaId,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (!data.email) {
          alert('El email es obligatorio');
          btn.disabled = false; btn.textContent = 'Guardar';
          return;
        }
        
        const ref = db.collection('bienes').doc(bienId).collection('caseros');
        
        if (editingCaseroId) {
          await ref.doc(editingCaseroId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          data.activo = true;
          
          // Crear en subcolecci√≥n del bien
          await ref.add(data);
        }
        
        modalCasero.classList.remove('active');
        await loadCaseros();
        document.getElementById('count-caseros').textContent = caserosData.length;
        renderCaserosList();
        
        if (!editingCaseroId) {
          alert('‚úÖ Casero a√±adido.\n\nEmail: ' + data.email);
        }
      } catch (error) {
        console.error('Error guardando casero:', error);
        alert('Error al guardar: ' + error.message);
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-casero').addEventListener('click', async () => {
      if (!editingCaseroId || !confirm('¬øEliminar este casero? Perder√° acceso a este bien.')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('caseros').doc(editingCaseroId).delete();
        modalCasero.classList.remove('active');
        await loadCaseros();
        document.getElementById('count-caseros').textContent = caserosData.length;
        renderCaserosList();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ========== HOSTERS (Gerente) ==========
    let hostersData = [];
    let editingHosterId = null;
    const seccionesPermisosHoster = ['reservas', 'habitaciones', 'huespedes', 'tarifas', 'ventas', 'inventario', 'ajuar', 'servicios'];
    const seccionesLabelsHoster = {
      reservas: 'üìÖ',
      habitaciones: 'üõèÔ∏è',
      huespedes: 'üë•',
      tarifas: 'üí∂',
      ventas: 'üí∞',
      inventario: 'üì¶',
      ajuar: 'ü™ë',
      servicios: 'üöê'
    };

    async function cargarHosters() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('hosters').get();
        hostersData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        document.getElementById('count-hosters').textContent = hostersData.length;
        renderHostersList();
      } catch (e) {
        console.error('Error cargando hosters:', e);
      }
    }

    function renderHostersList() {
      const container = document.getElementById('lista-hosters');
      if (!container) return;

      if (hostersData.length === 0) {
        container.innerHTML = '<div class="empty-mini">Sin hosters asignados</div>';
        return;
      }

      const rolesLabels = {
        recepcion: 'üõéÔ∏è Recepci√≥n',
        limpieza: 'üßπ Limpieza',
        mantenimiento: 'üîß Mantenimiento',
        atencion: 'üí¨ Atenci√≥n',
        completo: '‚≠ê Completo'
      };

      container.innerHTML = hostersData.map(h => {
        const iniciales = h.nombre ? h.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
        
        const permisos = h.permisos || {};
        const permisosActivos = [];
        seccionesPermisosHoster.forEach(sec => {
          if (permisos[sec]?.ver) {
            const tieneEdicion = permisos[sec].crear || permisos[sec].editar;
            permisosActivos.push({ sec, limitado: !tieneEdicion });
          }
        });

        return `
          <div class="casero-card" style="border-left: 3px solid #4A5568;" onclick="abrirModalHoster(hostersData.find(x=>x.id==='${h.id}'))">
            <div class="casero-card-header">
              <div class="casero-avatar" style="background: linear-gradient(135deg, #4A5568, #2D3748);">${iniciales}</div>
              <div class="casero-info">
                <div class="casero-nombre">${h.nombre}</div>
                <div class="casero-email">${h.email}${h.telefono ? ' ¬∑ ' + h.telefono : ''}</div>
                <div style="font-size:0.7rem;color:#4A5568;margin-top:2px;">${rolesLabels[h.rol] || h.rol}</div>
              </div>
            </div>
            <div class="casero-permisos">
              ${permisosActivos.map(p => `
                <span class="casero-permiso-badge ${p.limitado ? 'limitado' : ''}" style="background: ${p.limitado ? '#E2E8F0' : '#4A5568'}; color: ${p.limitado ? '#4A5568' : 'white'};">${seccionesLabelsHoster[p.sec]}</span>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // MODAL HOSTER
    const modalHoster = document.getElementById('modal-hoster');
    const formHoster = document.getElementById('form-hoster');

    function abrirModalHoster(hoster = null) {
      editingHosterId = hoster?.id || null;
      formHoster.reset();
      document.getElementById('btn-eliminar-hoster').classList.toggle('hidden', !hoster);
      
      // Reset checkboxes a valores por defecto
      seccionesPermisosHoster.forEach(sec => {
        document.getElementById(`hperm-${sec}-v`).checked = true;
        document.getElementById(`hperm-${sec}-c`).checked = sec === 'reservas';
        document.getElementById(`hperm-${sec}-e`).checked = sec === 'reservas';
        document.getElementById(`hperm-${sec}-b`).checked = false;
      });
      
      if (hoster) {
        document.getElementById('modal-hoster-title').textContent = '‚úèÔ∏è Editar hoster';
        document.getElementById('hoster-nombre').value = hoster.nombre || '';
        document.getElementById('hoster-email').value = hoster.email || '';
        document.getElementById('hoster-email').disabled = true;
        document.getElementById('hoster-telefono').value = hoster.telefono || '';
        document.getElementById('hoster-rol').value = hoster.rol || 'recepcion';
        
        const permisos = hoster.permisos || {};
        seccionesPermisosHoster.forEach(sec => {
          document.getElementById(`hperm-${sec}-v`).checked = permisos[sec]?.ver || false;
          document.getElementById(`hperm-${sec}-c`).checked = permisos[sec]?.crear || false;
          document.getElementById(`hperm-${sec}-e`).checked = permisos[sec]?.editar || false;
          document.getElementById(`hperm-${sec}-b`).checked = permisos[sec]?.borrar || false;
        });
      } else {
        document.getElementById('modal-hoster-title').textContent = 'üè® Nuevo hoster';
        document.getElementById('hoster-email').disabled = false;
      }
      modalHoster.classList.add('active');
    }

    document.getElementById('modal-hoster-close').addEventListener('click', () => modalHoster.classList.remove('active'));
    document.getElementById('modal-hoster-cancelar').addEventListener('click', () => modalHoster.classList.remove('active'));
    modalHoster.addEventListener('click', (e) => { if (e.target === modalHoster) modalHoster.classList.remove('active'); });

    formHoster.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-hoster-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const permisos = {};
        seccionesPermisosHoster.forEach(sec => {
          permisos[sec] = {
            ver: document.getElementById(`hperm-${sec}-v`).checked,
            crear: document.getElementById(`hperm-${sec}-c`).checked,
            editar: document.getElementById(`hperm-${sec}-e`).checked,
            borrar: document.getElementById(`hperm-${sec}-b`).checked
          };
        });

        const data = {
          nombre: document.getElementById('hoster-nombre').value,
          email: document.getElementById('hoster-email').value.toLowerCase().trim(),
          telefono: document.getElementById('hoster-telefono').value,
          rol: document.getElementById('hoster-rol').value,
          permisos: permisos,
          bienId: bienId,
          bienNombre: bienData.nombre || '',
          familiaId: bienData.familiaId || familiaId,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (!data.email) {
          alert('El email es obligatorio');
          btn.disabled = false; btn.textContent = 'Guardar';
          return;
        }
        
        const ref = db.collection('bienes').doc(bienId).collection('hosters');
        
        if (editingHosterId) {
          await ref.doc(editingHosterId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          data.activo = true;
          await ref.add(data);
        }
        
        modalHoster.classList.remove('active');
        await cargarHosters();
        
        if (!editingHosterId) {
          alert('‚úÖ Hoster a√±adido.\n\nEmail: ' + data.email);
        }
      } catch (error) {
        console.error('Error guardando hoster:', error);
        alert('Error al guardar: ' + error.message);
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-hoster').addEventListener('click', async () => {
      if (!editingHosterId || !confirm('¬øEliminar este hoster? Perder√° acceso a este bien.')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('hosters').doc(editingHosterId).delete();
        modalHoster.classList.remove('active');
        await cargarHosters();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ============ CAT√ÅLOGO AJUAR ============
    let gruposAjuar = [];
    let editingGrupoId = null;
    let editingArticuloId = null;
    let articuloFotoBase64 = null;

    async function cargarCatalogoAjuar() {
      if (bienData.tipo !== 'ajuar') {
        document.getElementById('section-catalogo-ajuar').classList.add('hidden');
        return;
      }
      
      document.getElementById('section-catalogo-ajuar').classList.remove('hidden');
      
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('gruposAjuar').get();
        gruposAjuar = [];
        
        for (const doc of snap.docs) {
          const grupo = { id: doc.id, ...doc.data(), articulos: [] };
          
          // Cargar art√≠culos del grupo
          const artSnap = await db.collection('bienes').doc(bienId)
            .collection('gruposAjuar').doc(doc.id)
            .collection('articulos').get();
          
          grupo.articulos = artSnap.docs.map(a => ({ id: a.id, ...a.data() }));
          gruposAjuar.push(grupo);
        }
        
        renderGruposAjuar();
      } catch (error) {
        console.error('Error cargando cat√°logo:', error);
      }
    }

    function renderGruposAjuar() {
      const container = document.getElementById('lista-grupos-ajuar');
      const countEl = document.getElementById('count-articulos-ajuar');
      
      const totalArticulos = gruposAjuar.reduce((sum, g) => sum + (g.articulos?.length || 0), 0);
      countEl.textContent = totalArticulos;
      
      if (gruposAjuar.length === 0) {
        container.innerHTML = '<div class="empty-mini">Sin grupos creados</div>';
        return;
      }
      
      container.innerHTML = gruposAjuar.map(grupo => `
        <div class="ajuar-grupo" id="grupo-${grupo.id}">
          <div class="ajuar-grupo-header" onclick="toggleGrupoAjuar('${grupo.id}')">
            <div class="ajuar-grupo-info">
              <div class="ajuar-grupo-icon">${grupo.icono || 'üì¶'}</div>
              <div>
                <div class="ajuar-grupo-nombre">${grupo.nombre}</div>
                <div class="ajuar-grupo-count">${grupo.articulos?.length || 0} art√≠culos</div>
              </div>
            </div>
            <span class="ajuar-grupo-toggle">‚ñº</span>
          </div>
          <div class="ajuar-grupo-body">
            <div class="ajuar-articulos">
              ${(grupo.articulos || []).map(art => {
                const detalles = [art.ubicacion, art.marca].filter(Boolean).join(' ¬∑ ') || art.descripcion || '';
                return `
                <div class="ajuar-articulo" onclick="editarArticuloAjuar('${grupo.id}', '${art.id}')">
                  <div class="ajuar-articulo-thumb">
                    ${art.foto ? `<img src="${art.foto}">` : 'ü™ë'}
                  </div>
                  <div class="ajuar-articulo-info">
                    <div class="ajuar-articulo-nombre">${art.nombre}</div>
                    <div class="ajuar-articulo-desc">${detalles}</div>
                  </div>
                </div>
              `}).join('')}
            </div>
            <div class="ajuar-btn-add" onclick="abrirModalArticuloAjuar('${grupo.id}')">+ A√±adir art√≠culo</div>
            <button class="btn btn-sm btn-secondary" style="width:100%;margin-top:8px;" onclick="editarGrupoAjuar('${grupo.id}')">‚úèÔ∏è Editar grupo</button>
          </div>
        </div>
      `).join('');
    }

    function toggleGrupoAjuar(grupoId) {
      const el = document.getElementById('grupo-' + grupoId);
      if (el) el.classList.toggle('open');
    }

    // Modal Grupo
    function abrirModalGrupoAjuar() {
      editingGrupoId = null;
      document.getElementById('grupo-ajuar-id').value = '';
      document.getElementById('grupo-ajuar-nombre').value = '';
      document.getElementById('grupo-ajuar-desc').value = '';
      document.querySelector('input[name="grupo-icono"][value="ü™ë"]').checked = true;
      document.getElementById('btn-eliminar-grupo-ajuar').classList.add('hidden');
      document.getElementById('modal-grupo-ajuar-title').textContent = 'üì¶ Nuevo grupo';
      document.getElementById('modal-grupo-ajuar').classList.add('active');
    }

    function editarGrupoAjuar(grupoId) {
      const grupo = gruposAjuar.find(g => g.id === grupoId);
      if (!grupo) return;
      
      editingGrupoId = grupoId;
      document.getElementById('grupo-ajuar-id').value = grupoId;
      document.getElementById('grupo-ajuar-nombre').value = grupo.nombre || '';
      document.getElementById('grupo-ajuar-desc').value = grupo.descripcion || '';
      
      const iconRadio = document.querySelector(`input[name="grupo-icono"][value="${grupo.icono || 'üì¶'}"]`);
      if (iconRadio) iconRadio.checked = true;
      
      document.getElementById('btn-eliminar-grupo-ajuar').classList.remove('hidden');
      document.getElementById('modal-grupo-ajuar-title').textContent = '‚úèÔ∏è Editar grupo';
      document.getElementById('modal-grupo-ajuar').classList.add('active');
    }

    function cerrarModalGrupoAjuar() {
      document.getElementById('modal-grupo-ajuar').classList.remove('active');
    }

    async function guardarGrupoAjuar() {
      const nombre = document.getElementById('grupo-ajuar-nombre').value.trim();
      if (!nombre) { alert('Introduce un nombre'); return; }
      
      const icono = document.querySelector('input[name="grupo-icono"]:checked')?.value || 'üì¶';
      const descripcion = document.getElementById('grupo-ajuar-desc').value.trim();
      
      try {
        const data = { nombre, icono, descripcion, actualizadoEn: firebase.firestore.FieldValue.serverTimestamp() };
        
        if (editingGrupoId) {
          await db.collection('bienes').doc(bienId).collection('gruposAjuar').doc(editingGrupoId).update(data);
        } else {
          data.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('bienes').doc(bienId).collection('gruposAjuar').add(data);
        }
        
        cerrarModalGrupoAjuar();
        await cargarCatalogoAjuar();
      } catch (error) {
        console.error('Error guardando grupo:', error);
        alert('Error al guardar');
      }
    }

    async function eliminarGrupoAjuar() {
      if (!editingGrupoId || !confirm('¬øEliminar este grupo y todos sus art√≠culos?')) return;
      
      try {
        // Eliminar art√≠culos primero
        const artSnap = await db.collection('bienes').doc(bienId)
          .collection('gruposAjuar').doc(editingGrupoId)
          .collection('articulos').get();
        
        const batch = db.batch();
        artSnap.docs.forEach(doc => batch.delete(doc.ref));
        batch.delete(db.collection('bienes').doc(bienId).collection('gruposAjuar').doc(editingGrupoId));
        await batch.commit();
        
        cerrarModalGrupoAjuar();
        await cargarCatalogoAjuar();
      } catch (error) {
        console.error('Error eliminando grupo:', error);
        alert('Error al eliminar');
      }
    }

    // Modal Art√≠culo
    function abrirModalArticuloAjuar(grupoId) {
      editingArticuloId = null;
      articuloFotoBase64 = null;
      document.getElementById('articulo-ajuar-id').value = '';
      document.getElementById('articulo-ajuar-grupo-id').value = grupoId;
      document.getElementById('articulo-ajuar-nombre').value = '';
      document.getElementById('articulo-ajuar-desc').value = '';
      document.getElementById('articulo-ajuar-ubicacion').value = '';
      document.getElementById('articulo-ajuar-marca').value = '';
      document.getElementById('articulo-ajuar-procedencia').value = '';
      document.getElementById('articulo-foto-preview').innerHTML = 'üì∑ Click para subir foto';
      document.getElementById('btn-eliminar-articulo-ajuar').classList.add('hidden');
      document.getElementById('modal-articulo-ajuar-title').textContent = 'ü™ë Nuevo art√≠culo';
      document.getElementById('modal-articulo-ajuar').classList.add('active');
    }

    function editarArticuloAjuar(grupoId, articuloId) {
      const grupo = gruposAjuar.find(g => g.id === grupoId);
      const articulo = grupo?.articulos?.find(a => a.id === articuloId);
      if (!articulo) return;
      
      editingArticuloId = articuloId;
      articuloFotoBase64 = articulo.foto || null;
      
      document.getElementById('articulo-ajuar-id').value = articuloId;
      document.getElementById('articulo-ajuar-grupo-id').value = grupoId;
      document.getElementById('articulo-ajuar-nombre').value = articulo.nombre || '';
      document.getElementById('articulo-ajuar-desc').value = articulo.descripcion || '';
      document.getElementById('articulo-ajuar-ubicacion').value = articulo.ubicacion || '';
      document.getElementById('articulo-ajuar-marca').value = articulo.marca || '';
      document.getElementById('articulo-ajuar-procedencia').value = articulo.procedencia || '';
      
      if (articulo.foto) {
        document.getElementById('articulo-foto-preview').innerHTML = `<img src="${articulo.foto}">`;
      } else {
        document.getElementById('articulo-foto-preview').innerHTML = 'üì∑ Click para subir foto';
      }
      
      document.getElementById('btn-eliminar-articulo-ajuar').classList.remove('hidden');
      document.getElementById('modal-articulo-ajuar-title').textContent = '‚úèÔ∏è Editar art√≠culo';
      document.getElementById('modal-articulo-ajuar').classList.add('active');
    }

    function cerrarModalArticuloAjuar() {
      document.getElementById('modal-articulo-ajuar').classList.remove('active');
    }

    function previewArticuloFoto(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        articuloFotoBase64 = e.target.result;
        document.getElementById('articulo-foto-preview').innerHTML = `<img src="${articuloFotoBase64}">`;
      };
      reader.readAsDataURL(file);
    }

    async function guardarArticuloAjuar() {
      const grupoId = document.getElementById('articulo-ajuar-grupo-id').value;
      const nombre = document.getElementById('articulo-ajuar-nombre').value.trim();
      if (!nombre) { alert('Introduce un nombre'); return; }
      
      try {
        const data = {
          nombre,
          descripcion: document.getElementById('articulo-ajuar-desc').value.trim(),
          ubicacion: document.getElementById('articulo-ajuar-ubicacion').value.trim(),
          marca: document.getElementById('articulo-ajuar-marca').value.trim(),
          procedencia: document.getElementById('articulo-ajuar-procedencia').value.trim(),
          foto: articuloFotoBase64 || null,
          actualizadoEn: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('gruposAjuar').doc(grupoId).collection('articulos');
        
        if (editingArticuloId) {
          await ref.doc(editingArticuloId).update(data);
        } else {
          data.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        
        cerrarModalArticuloAjuar();
        await cargarCatalogoAjuar();
      } catch (error) {
        console.error('Error guardando art√≠culo:', error);
        alert('Error al guardar');
      }
    }

    async function eliminarArticuloAjuar() {
      const grupoId = document.getElementById('articulo-ajuar-grupo-id').value;
      if (!editingArticuloId || !confirm('¬øEliminar este art√≠culo?')) return;
      
      try {
        await db.collection('bienes').doc(bienId)
          .collection('gruposAjuar').doc(grupoId)
          .collection('articulos').doc(editingArticuloId).delete();
        
        cerrarModalArticuloAjuar();
        await cargarCatalogoAjuar();
      } catch (error) {
        console.error('Error eliminando art√≠culo:', error);
        alert('Error al eliminar');
      }
    }
  </script>
</body>
</html>
