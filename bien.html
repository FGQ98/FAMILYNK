<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Bien</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: var(--cream-dark); color: var(--text); }
    .header-actions { display: flex; gap: 8px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      color: white;
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
      border: 1px solid var(--cream-dark);
    }

    .btn-secondary:hover { background: var(--cream-dark); }

    .btn-mayordomo {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%);
      color: white;
    }

    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
    .btn-danger { background: var(--error); color: white; }

    .main { max-width: 1200px; margin: 0 auto; padding: 24px; }

    .layout-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 24px;
    }

    @media (max-width: 900px) { .layout-grid { grid-template-columns: 1fr; } }

    .bien-hero {
      background: var(--white);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }

    .bien-hero-image {
      height: 200px;
      background: linear-gradient(135deg, var(--sage-light) 0%, var(--sage) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5rem;
      position: relative;
    }

    .bien-hero-image img { width: 100%; height: 100%; object-fit: cover; }

    .bien-hero-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--mayordomo);
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 700;
    }

    .bien-hero-body { padding: 20px; }

    .bien-tipo-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--sage-dark);
      font-weight: 700;
      margin-bottom: 4px;
    }

    .bien-nombre {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .bien-ubicacion {
      color: var(--text-light);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    .bien-meta { display: flex; gap: 16px; flex-wrap: wrap; }
    .bien-meta-item { font-size: 0.8rem; color: var(--text-muted); }
    .bien-meta-item strong { color: var(--text); }

    .collapsible-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .collapsible-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }

    .collapsible-header:hover { background: var(--cream-medium); }

    .collapsible-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .collapsible-count {
      font-size: 0.75rem;
      background: var(--sage-muted);
      color: var(--sage-dark);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .collapsible-toggle {
      font-size: 1.2rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .collapsible-section.open .collapsible-toggle { transform: rotate(180deg); }
    .collapsible-body { padding: 0 20px 20px; display: none; }
    .collapsible-section.open .collapsible-body { display: block; }

    .info-list { display: flex; flex-direction: column; gap: 8px; }

    .info-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .info-item-icon { font-size: 1.3rem; }
    .info-item-content { flex: 1; }
    .info-item-title { font-weight: 600; font-size: 0.9rem; }
    .info-item-subtitle { font-size: 0.75rem; color: var(--text-muted); }

    .info-item-action {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      opacity: 0.5;
      padding: 4px;
      text-decoration: none;
    }

    .info-item-action:hover { opacity: 1; }

    .normas-box {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-line;
    }

    .mayordomo-section { margin-bottom: 24px; }

    .mayordomo-header {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%);
      border-radius: var(--radius-lg);
      padding: 20px;
      color: white;
      margin-bottom: 16px;
    }

    .mayordomo-header h2 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      margin-bottom: 4px;
    }

    .mayordomo-header p { font-size: 0.85rem; opacity: 0.9; }

    .modulos-operativos { display: flex; flex-direction: column; gap: 16px; }

    .modulo-panel {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .modulo-panel-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--cream-dark);
    }

    .modulo-panel-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modulo-panel-body { padding: 16px 20px; }

    /* CALENDARIO */
    .calendario-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .calendario-mes {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
    }

    .calendario-nav-btns { display: flex; gap: 4px; }

    .calendario-nav-btn {
      background: var(--cream);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1rem;
    }

    .calendario-nav-btn:hover { background: var(--cream-dark); }

    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .calendario-dia-header {
      text-align: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .calendario-dia {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
    }

    .calendario-dia:hover { background: var(--cream-dark); }
    .calendario-dia.otro-mes { color: var(--text-muted); opacity: 0.5; }
    .calendario-dia.hoy { background: var(--sage-muted); font-weight: 700; }
    .calendario-dia.reservado { background: var(--sage); color: white; }
    .calendario-dia.nido-1 { background: var(--sage); }
    .calendario-dia.nido-2 { background: var(--terracotta); }
    .calendario-dia.nido-3 { background: #6B8E9F; }
    .calendario-dia.nido-4 { background: #9B8EA6; }

    .reservas-lista { margin-top: 16px; }

    .reservas-lista-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .reserva-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      border-left: 4px solid var(--sage);
      cursor: pointer;
      transition: all 0.2s;
    }

    .reserva-item:hover { background: var(--cream-dark); }
    .reserva-item.nido-1 { border-left-color: var(--sage); }
    .reserva-item.nido-2 { border-left-color: var(--terracotta); }
    .reserva-item.nido-3 { border-left-color: #6B8E9F; }
    .reserva-item.nido-4 { border-left-color: #9B8EA6; }

    .reserva-fecha { text-align: center; min-width: 50px; }
    .reserva-fecha-dia { font-size: 1.3rem; font-weight: 700; color: var(--sage-dark); }
    .reserva-fecha-mes { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); }
    .reserva-info { flex: 1; }
    .reserva-quien { font-weight: 600; font-size: 0.9rem; }
    .reserva-periodo { font-size: 0.75rem; color: var(--text-muted); }

    .nidos-leyenda {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--cream-dark);
    }

    .nido-leyenda-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; }
    .nido-leyenda-color { width: 12px; height: 12px; border-radius: 3px; }

    /* Otros m√≥dulos */
    .inventario-alerta {
      background: var(--warning);
      color: white;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      margin-bottom: 12px;
    }

    .inventario-list, .mantenimiento-list, .gastos-list, .servicios-list, .eventos-list, .limpieza-checklist {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .inventario-item, .mantenimiento-item, .gasto-item, .servicio-item, .evento-item, .limpieza-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .inventario-item.bajo { border-left: 3px solid var(--error); }
    .inventario-item-nombre, .servicio-nombre { flex: 1; font-size: 0.9rem; }
    .inventario-item-stock { font-size: 0.8rem; color: var(--text-muted); }
    .inventario-item-stock.bajo { color: var(--error); font-weight: 600; }

    .mantenimiento-tipo, .evento-icono, .servicio-icono { font-size: 1.3rem; }
    .mantenimiento-info, .evento-info { flex: 1; }
    .mantenimiento-titulo, .evento-nombre { font-weight: 600; font-size: 0.9rem; }
    .mantenimiento-fecha, .evento-fecha { font-size: 0.75rem; color: var(--text-muted); }

    .mantenimiento-badge, .evento-tipo {
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .mantenimiento-badge.programado { background: var(--sage-muted); color: var(--sage-dark); }
    .mantenimiento-badge.pendiente { background: var(--warning); color: white; }
    .evento-tipo { background: var(--terracotta-muted); color: var(--terracotta); }

    .limpieza-item { cursor: pointer; transition: all 0.2s; }
    .limpieza-item:hover { background: var(--cream-dark); }
    .limpieza-item.done { opacity: 0.5; }
    .limpieza-item.done .limpieza-texto { text-decoration: line-through; }

    .limpieza-check {
      width: 22px;
      height: 22px;
      border: 2px solid var(--sage);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: white;
    }

    .limpieza-item.done .limpieza-check { background: var(--sage); }
    .limpieza-texto { font-size: 0.9rem; }

    .gastos-resumen {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .gasto-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .gasto-stat-valor { font-size: 1.5rem; font-weight: 700; color: var(--sage-dark); }
    .gasto-stat-label { font-size: 0.75rem; color: var(--text-muted); }
    .gasto-item-nombre { flex: 1; font-size: 0.9rem; }
    .gasto-item-valor { font-weight: 600; color: var(--terracotta); }

    /* Gastos mejorado */
    .gastos-periodo-selector {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .gastos-periodo-btn {
      padding: 6px 12px;
      background: var(--cream-medium);
      border: none;
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gastos-periodo-btn:hover { background: var(--cream-dark); }
    .gastos-periodo-btn.active { background: var(--terracotta); color: white; }

    .gastos-resumen {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .gasto-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .gasto-stat-valor { font-size: 1.5rem; font-weight: 700; color: var(--terracotta); }
    .gasto-stat-label { font-size: 0.7rem; color: var(--text-muted); }

    .gastos-por-categoria {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .gasto-cat-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--cream-medium);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
    }

    .gasto-cat-chip-valor { font-weight: 700; color: var(--terracotta); }

    .gastos-list { display: flex; flex-direction: column; gap: 8px; }

    .gasto-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .gasto-item:hover { background: var(--cream-dark); }

    .gasto-item-icon { font-size: 1.3rem; }

    .gasto-item-info { flex: 1; }
    .gasto-item-concepto { font-weight: 600; font-size: 0.9rem; }
    .gasto-item-meta { font-size: 0.7rem; color: var(--text-muted); }

    .gasto-item-importe {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--terracotta);
    }

    .gasto-item-pagador {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: var(--sage-muted);
      color: var(--sage-dark);
      border-radius: var(--radius-sm);
    }

    /* Inventario mejorado */
    .inventario-categorias {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .inventario-cat-btn {
      padding: 6px 12px;
      background: var(--cream-medium);
      border: none;
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .inventario-cat-btn:hover { background: var(--cream-dark); }
    .inventario-cat-btn.active { background: var(--sage); color: white; }

    .inventario-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .inventario-item:hover { background: var(--cream-dark); }
    .inventario-item.bajo { border-left: 3px solid var(--error); }
    .inventario-item.ok { border-left: 3px solid var(--success); }

    .inventario-item-icon { font-size: 1.3rem; }

    .inventario-item-info { flex: 1; }
    .inventario-item-nombre { font-weight: 600; font-size: 0.9rem; }
    .inventario-item-meta { font-size: 0.7rem; color: var(--text-muted); }

    .inventario-item-stock {
      text-align: right;
      min-width: 60px;
    }

    .inventario-item-cantidad {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .inventario-item-cantidad.bajo { color: var(--error); }
    .inventario-item-cantidad.ok { color: var(--success); }

    .inventario-item-minimo {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .inventario-quick-btns {
      display: flex;
      gap: 4px;
      margin-left: 8px;
    }

    .inventario-quick-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .inventario-quick-btn.menos {
      background: var(--terracotta-muted);
      color: var(--terracotta);
    }

    .inventario-quick-btn.mas {
      background: var(--sage-muted);
      color: var(--sage-dark);
    }

    .inventario-quick-btn:hover { transform: scale(1.1); }

    .inventario-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .inventario-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 12px;
      text-align: center;
    }

    .inventario-stat-valor {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .inventario-stat-valor.alerta { color: var(--error); }
    .inventario-stat-label { font-size: 0.65rem; color: var(--text-muted); }

    .sidebar { display: flex; flex-direction: column; gap: 16px; }

    .empty-mini {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .empty-mini-icon { font-size: 2rem; opacity: 0.3; margin-bottom: 8px; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 24px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 450px;
      transform: translateY(20px);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal { transform: translateY(0); }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .modal-close {
      background: var(--cream);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .modal-close:hover { background: var(--cream-dark); }
    .modal-body { padding: 24px; }

    .modal-footer {
      padding: 0 24px 24px;
      display: flex;
      gap: 12px;
      justify-content: space-between;
    }

    .form-group { margin-bottom: 16px; }
    .form-group:last-child { margin-bottom: 0; }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
      transition: all 0.2s;
      background: var(--white);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--sage);
      box-shadow: 0 0 0 3px var(--sage-muted);
    }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="bienes.html" class="back-btn"><span>‚Üê</span><span>El Com√∫n</span></a>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary btn-sm" id="btn-editar">‚úèÔ∏è Editar</button>
    </div>
  </header>

  <main class="main">
    <div id="page-loading" class="loading"><div class="spinner"></div></div>

    <div id="page-content" class="hidden">
      <div class="bien-hero">
        <div class="bien-hero-image" id="bien-hero-image">üè†</div>
        <div class="bien-hero-body">
          <div class="bien-tipo-label" id="bien-tipo">Inmueble</div>
          <h1 class="bien-nombre" id="bien-nombre">Cargando...</h1>
          <div class="bien-ubicacion" id="bien-ubicacion"></div>
          <div class="bien-meta">
            <div class="bien-meta-item"><strong>Titularidad:</strong> <span id="bien-titularidad">-</span></div>
            <div class="bien-meta-item"><strong>Origen:</strong> <span id="bien-origen">-</span></div>
          </div>
        </div>
      </div>

      <div class="layout-grid">
        <div class="main-column">
          <div class="mayordomo-section hidden" id="mayordomo-section">
            <div class="mayordomo-header">
              <h2>üé© Mayordomo</h2>
              <p>Gesti√≥n activa de este bien</p>
            </div>
            <div class="modulos-operativos" id="modulos-operativos"></div>
          </div>

          <div class="collapsible-section" id="no-mayordomo-section">
            <div class="collapsible-header" style="cursor: default;">
              <div class="collapsible-title"><span>üé©</span><span>Mayordomo</span></div>
            </div>
            <div class="collapsible-body" style="display: block;">
              <div class="empty-mini">
                <div class="empty-mini-icon">üé©</div>
                <p>El Mayordomo no est√° activado.</p>
                <button class="btn btn-mayordomo btn-sm" style="margin-top: 12px;" onclick="editarBien()">Activar</button>
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar">
          <div class="collapsible-section open" id="section-galeria">
            <div class="collapsible-header" onclick="toggleSection('galeria')">
              <div class="collapsible-title"><span>üì∑</span><span>Galer√≠a</span><span class="collapsible-count" id="count-galeria">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div id="galeria-fotos" style="display:flex;gap:8px;overflow-x:auto;"><div class="empty-mini" style="padding:12px;">Sin fotos</div></div></div>
          </div>

          <div class="collapsible-section" id="section-personal">
            <div class="collapsible-header" onclick="toggleSection('personal')">
              <div class="collapsible-title"><span>üë∑</span><span>Personal</span><span class="collapsible-count" id="count-personal">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-personal"><div class="empty-mini">Sin personal</div></div></div>
          </div>

          <div class="collapsible-section" id="section-mascotas">
            <div class="collapsible-header" onclick="toggleSection('mascotas')">
              <div class="collapsible-title"><span>üêæ</span><span>Mascotas</span><span class="collapsible-count" id="count-mascotas">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-mascotas"><div class="empty-mini">Sin mascotas</div></div></div>
          </div>

          <div class="collapsible-section" id="section-contactos">
            <div class="collapsible-header" onclick="toggleSection('contactos')">
              <div class="collapsible-title"><span>üìû</span><span>Contactos</span><span class="collapsible-count" id="count-contactos">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-contactos"><div class="empty-mini">Sin contactos</div></div></div>
          </div>

          <div class="collapsible-section" id="section-documentos">
            <div class="collapsible-header" onclick="toggleSection('documentos')">
              <div class="collapsible-title"><span>üìÑ</span><span>Documentos</span><span class="collapsible-count" id="count-documentos">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-documentos"><div class="empty-mini">Sin documentos</div></div></div>
          </div>

          <div class="collapsible-section" id="section-normas">
            <div class="collapsible-header" onclick="toggleSection('normas')">
              <div class="collapsible-title"><span>üìú</span><span>Normas</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="normas-box" id="normas-texto">Sin normas definidas</div></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Reserva -->
  <div class="modal-overlay" id="modal-reserva">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-reserva-title">üìÖ Nueva reserva</h3>
        <button class="modal-close" id="modal-reserva-close">√ó</button>
      </div>
      <form id="form-reserva">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nido / Familia</label>
            <select class="form-select" id="reserva-nido" required><option value="">Selecciona...</option></select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha inicio</label>
              <input type="date" class="form-input" id="reserva-inicio" required>
            </div>
            <div class="form-group">
              <label class="form-label">Fecha fin</label>
              <input type="date" class="form-input" id="reserva-fin" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="reserva-notas" placeholder="Ej: Cumplea√±os, vacaciones...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-reserva">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-reserva-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-reserva-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Inventario -->
  <div class="modal-overlay" id="modal-inventario">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-inventario-title">üì¶ Nuevo art√≠culo</h3>
        <button class="modal-close" id="modal-inventario-close">√ó</button>
      </div>
      <form id="form-inventario">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre del art√≠culo</label>
            <input type="text" class="form-input" id="inv-nombre" placeholder="Ej: Papel higi√©nico" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="inv-categoria" required>
                <option value="limpieza">üßπ Limpieza</option>
                <option value="bano">üöø Ba√±o</option>
                <option value="cocina">üç≥ Cocina</option>
                <option value="alimentos">ü•´ Alimentos</option>
                <option value="bebidas">üç∑ Bebidas</option>
                <option value="otro">üì¶ Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Unidad</label>
              <select class="form-select" id="inv-unidad">
                <option value="uds">Unidades</option>
                <option value="rollos">Rollos</option>
                <option value="botellas">Botellas</option>
                <option value="paquetes">Paquetes</option>
                <option value="kg">Kg</option>
                <option value="litros">Litros</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Stock actual</label>
              <input type="number" class="form-input" id="inv-stock" min="0" value="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Stock m√≠nimo</label>
              <input type="number" class="form-input" id="inv-minimo" min="0" value="1" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha caducidad (opcional)</label>
            <input type="date" class="form-input" id="inv-caducidad">
          </div>
          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="inv-notas" placeholder="Ej: Marca preferida, d√≥nde comprarlo...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-inventario">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-inventario-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-inventario-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Gastos -->
  <div class="modal-overlay" id="modal-gasto">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-gasto-title">üí∂ Nuevo gasto</h3>
        <button class="modal-close" id="modal-gasto-close">√ó</button>
      </div>
      <form id="form-gasto">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Concepto</label>
            <input type="text" class="form-input" id="gasto-concepto" placeholder="Ej: Factura luz noviembre" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="gasto-categoria" required>
                <option value="luz">üí° Luz</option>
                <option value="agua">üíß Agua</option>
                <option value="gas">üî• Gas</option>
                <option value="comunidad">üè¢ Comunidad</option>
                <option value="seguro">üõ°Ô∏è Seguro</option>
                <option value="mantenimiento">üîß Mantenimiento</option>
                <option value="limpieza">üßπ Limpieza</option>
                <option value="compras">üõí Compras</option>
                <option value="otro">üìã Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Importe (‚Ç¨)</label>
              <input type="number" class="form-input" id="gasto-importe" min="0" step="0.01" placeholder="0.00" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha</label>
              <input type="date" class="form-input" id="gasto-fecha" required>
            </div>
            <div class="form-group">
              <label class="form-label">Pagado por</label>
              <select class="form-select" id="gasto-pagador">
                <option value="">Com√∫n / Sin asignar</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="gasto-notas" placeholder="Ej: N¬∫ factura, observaciones...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-gasto">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-gasto-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-gasto-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let familiaId = null;
    let nidosData = [];
    let reservasData = [];
    let inventarioData = [];
    let gastosData = [];
    let gastosPeriodo = 'mes';
    let inventarioFiltro = 'todos';
    let calendarioMes = new Date();
    let editingReservaId = null;
    let editingInventarioId = null;
    let editingGastoId = null;

    const nidoColores = ['nido-1', 'nido-2', 'nido-3', 'nido-4'];
    const nidoColorMap = {};

    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    if (!bienId) window.location.href = 'bienes.html';

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await loadBien();
    });

    async function loadBien() {
      try {
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) { alert('Bien no encontrado'); window.location.href = 'bienes.html'; return; }

        bienData = { id: bienDoc.id, ...bienDoc.data() };
        familiaId = bienData.familiaId;
        
        await loadNidos();
        await loadReservas();
        await loadInventario();
        await loadGastos();
        renderBien();

        document.getElementById('page-loading').classList.add('hidden');
        document.getElementById('page-content').classList.remove('hidden');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar');
        window.location.href = 'bienes.html';
      }
    }

    async function loadNidos() {
      if (!familiaId) return;
      const snap = await db.collection('nidos').where('familiaId', '==', familiaId).get();
      nidosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      nidosData.forEach((n, i) => { nidoColorMap[n.id] = nidoColores[i % nidoColores.length]; });
      
      document.getElementById('reserva-nido').innerHTML = '<option value="">Selecciona...</option>' +
        nidosData.map(n => `<option value="${n.id}">${n.nombre}</option>`).join('');
    }

    async function loadReservas() {
      const snap = await db.collection('bienes').doc(bienId).collection('reservas').orderBy('fechaInicio', 'asc').get();
      reservasData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function loadInventario() {
      const snap = await db.collection('bienes').doc(bienId).collection('inventario').orderBy('nombre', 'asc').get();
      inventarioData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function loadGastos() {
      const snap = await db.collection('bienes').doc(bienId).collection('gastos').orderBy('fecha', 'desc').get();
      gastosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    function renderBien() {
      const tipoIcons = { inmueble: 'üè†', terreno: 'üå≥', vehiculo: 'üöó', ajuar: 'ü™ë' };
      const tipoLabels = { inmueble: 'Inmueble', terreno: 'Terreno', vehiculo: 'Veh√≠culo', ajuar: 'Ajuar' };
      const rolIcons = { limpieza: 'üßπ', jardinero: 'üå±', cuidador: 'üë®‚Äç‚öïÔ∏è', mantenimiento: 'üîß', otro: 'üìã' };
      const mascotaIcons = { perro: 'üêï', gato: 'üêà', ave: 'üê¶', otro: 'üêæ' };
      const catIcons = { mantenimiento: 'üîß', vecino: 'üèòÔ∏è', emergencia: 'üö®', suministros: 'üí°', otro: 'üìã' };
      const docIcons = { escritura: 'üìú', seguro: 'üõ°Ô∏è', suministro: 'üí°', empleado: 'üë∑', itv: 'üöó', comunidad: 'üè¢', otro: 'üìÑ' };

      document.getElementById('bien-hero-image').innerHTML = bienData.fotos?.length > 0
        ? `<img src="${bienData.fotos[0].url}">${bienData.mayordomoActivo ? '<span class="bien-hero-badge">üé© Mayordomo</span>' : ''}`
        : tipoIcons[bienData.tipo] || 'üè†';
      
      document.getElementById('bien-tipo').textContent = tipoLabels[bienData.tipo] || bienData.tipo;
      document.getElementById('bien-nombre').textContent = bienData.nombre;
      document.getElementById('bien-ubicacion').innerHTML = bienData.ubicacion ? `<span>üìç</span><span>${bienData.ubicacion}</span>` : '';
      document.getElementById('bien-titularidad').textContent = bienData.titularidad || '-';
      document.getElementById('bien-origen').textContent = bienData.origen || '-';

      // Sidebar counts
      document.getElementById('count-galeria').textContent = (bienData.fotos?.length || 0) + (bienData.croquis?.length || 0) + (bienData.planos?.length || 0);

      const personal = bienData.personal || [];
      document.getElementById('count-personal').textContent = personal.length;
      if (personal.length > 0) {
        document.getElementById('lista-personal').innerHTML = personal.map(p => `
          <div class="info-item">
            <span class="info-item-icon">${rolIcons[p.rol] || 'üë∑'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${p.nombre}</div>
              <div class="info-item-subtitle">${p.tipo === 'residente' ? 'Residente' : 'Puntual'}${p.telefono ? ' ¬∑ ' + p.telefono : ''}</div>
            </div>
            ${p.telefono ? `<a href="tel:${p.telefono}" class="info-item-action">üìû</a>` : ''}
          </div>
        `).join('');
      }

      const mascotas = bienData.mascotas || [];
      document.getElementById('count-mascotas').textContent = mascotas.length;
      if (mascotas.length > 0) {
        document.getElementById('lista-mascotas').innerHTML = mascotas.map(m => `
          <div class="info-item">
            <span class="info-item-icon">${mascotaIcons[m.tipo] || 'üêæ'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${m.nombre}</div>
              <div class="info-item-subtitle">${m.raza || m.tipo}</div>
            </div>
          </div>
        `).join('');
      }

      const contactos = bienData.contactos || [];
      document.getElementById('count-contactos').textContent = contactos.length;
      if (contactos.length > 0) {
        document.getElementById('lista-contactos').innerHTML = contactos.map(c => `
          <div class="info-item">
            <span class="info-item-icon">${catIcons[c.categoria] || 'üìû'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${c.nombre}</div>
              <div class="info-item-subtitle">${c.telefono || ''}</div>
            </div>
            ${c.telefono ? `<a href="tel:${c.telefono}" class="info-item-action">üìû</a>` : ''}
          </div>
        `).join('');
      }

      const documentos = bienData.documentos || [];
      document.getElementById('count-documentos').textContent = documentos.length;
      if (documentos.length > 0) {
        document.getElementById('lista-documentos').innerHTML = documentos.map(d => `
          <div class="info-item">
            <span class="info-item-icon">${docIcons[d.tipo] || 'üìÑ'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${d.nombre}</div>
              <div class="info-item-subtitle">${d.fechaVencimiento ? 'Vence: ' + formatDate(d.fechaVencimiento) : ''}</div>
            </div>
          </div>
        `).join('');
      }

      if (bienData.normasConvivencia) document.getElementById('normas-texto').textContent = bienData.normasConvivencia;

      // Mayordomo
      if (bienData.mayordomoActivo) {
        document.getElementById('mayordomo-section').classList.remove('hidden');
        document.getElementById('no-mayordomo-section').classList.add('hidden');
        renderMayordomoModulos();
      } else {
        document.getElementById('mayordomo-section').classList.add('hidden');
        document.getElementById('no-mayordomo-section').classList.remove('hidden');
      }
    }

    function renderMayordomoModulos() {
      const container = document.getElementById('modulos-operativos');
      const m = bienData.mayordomoModulos || {};
      let html = '';

      if (m.reservas) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header">
              <div class="modulo-panel-title">üìÖ Reservas</div>
              <button class="btn btn-sm btn-primary" onclick="abrirModalReserva()">+ Nueva</button>
            </div>
            <div class="modulo-panel-body">
              <div class="calendario-nav">
                <button class="calendario-nav-btn" onclick="cambiarMes(-1)">‚óÄ</button>
                <span class="calendario-mes" id="calendario-mes-label"></span>
                <button class="calendario-nav-btn" onclick="cambiarMes(1)">‚ñ∂</button>
              </div>
              <div class="calendario-grid" id="calendario-grid"></div>
              <div class="nidos-leyenda" id="nidos-leyenda"></div>
              <div class="reservas-lista">
                <div class="reservas-lista-title">Pr√≥ximas reservas</div>
                <div id="reservas-lista-items"></div>
              </div>
            </div>
          </div>
        `;
      }

      if (m.inventario) {
        html += `
          <div class="modulo-panel" id="panel-inventario">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üì¶ Inventario</div><button class="btn btn-sm btn-primary" onclick="abrirModalInventario()">+ A√±adir</button></div>
            <div class="modulo-panel-body">
              <div class="inventario-stats" id="inventario-stats"></div>
              <div class="inventario-categorias" id="inventario-categorias"></div>
              <div class="inventario-list" id="inventario-list"></div>
            </div>
          </div>
        `;
      }

      if (m.mantenimiento) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üîß Mantenimiento</div><button class="btn btn-sm btn-secondary">+ A√±adir</button></div>
            <div class="modulo-panel-body">
              <div class="mantenimiento-list">
                <div class="mantenimiento-item"><span class="mantenimiento-tipo">üî•</span><div class="mantenimiento-info"><div class="mantenimiento-titulo">Revisi√≥n caldera</div><div class="mantenimiento-fecha">15 diciembre</div></div><span class="mantenimiento-badge programado">Programado</span></div>
              </div>
            </div>
          </div>
        `;
      }

      if (m.limpieza) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üßπ Limpieza</div></div>
            <div class="modulo-panel-body">
              <div class="limpieza-checklist">
                <div class="limpieza-item done" onclick="toggleLimpieza(this)"><div class="limpieza-check">‚úì</div><span class="limpieza-texto">Cambiar s√°banas</span></div>
                <div class="limpieza-item" onclick="toggleLimpieza(this)"><div class="limpieza-check"></div><span class="limpieza-texto">Limpiar ba√±os</span></div>
                <div class="limpieza-item" onclick="toggleLimpieza(this)"><div class="limpieza-check"></div><span class="limpieza-texto">Fregar suelos</span></div>
              </div>
            </div>
          </div>
        `;
      }

      if (m.eventos) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üéâ Eventos</div><button class="btn btn-sm btn-secondary">+ Nuevo</button></div>
            <div class="modulo-panel-body">
              <div class="eventos-list">
                <div class="evento-item"><span class="evento-icono">üéÑ</span><div class="evento-info"><div class="evento-nombre">Cena de Navidad</div><div class="evento-fecha">24 dic ¬∑ 20:00</div></div><span class="evento-tipo">Familia</span></div>
              </div>
            </div>
          </div>
        `;
      }

      if (m.gastos) {
        html += `
          <div class="modulo-panel" id="panel-gastos">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üí∂ Gastos</div><button class="btn btn-sm btn-primary" onclick="abrirModalGasto()">+ A√±adir</button></div>
            <div class="modulo-panel-body">
              <div class="gastos-periodo-selector" id="gastos-periodo-selector"></div>
              <div class="gastos-resumen" id="gastos-resumen"></div>
              <div class="gastos-por-categoria" id="gastos-categorias"></div>
              <div class="gastos-list" id="gastos-list"></div>
            </div>
          </div>
        `;
      }

      if (m.otrosServicios) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üõéÔ∏è Otros Servicios</div></div>
            <div class="modulo-panel-body">
              <div class="servicios-list">
                <div class="servicio-item"><span class="servicio-icono">üçΩÔ∏è</span><span class="servicio-nombre">Catering</span></div>
                <div class="servicio-item"><span class="servicio-icono">üöê</span><span class="servicio-nombre">Transporte</span></div>
              </div>
            </div>
          </div>
        `;
      }

      if (!html) html = '<div class="empty-mini"><div class="empty-mini-icon">üìã</div><p>No hay subm√≥dulos activados.</p></div>';

      container.innerHTML = html;
      if (m.reservas) { renderCalendario(); renderReservasLista(); renderNidosLeyenda(); }
      if (m.inventario) { renderInventario(); }
      if (m.gastos) { renderGastos(); }
    }

    // CALENDARIO
    function renderCalendario() {
      const grid = document.getElementById('calendario-grid');
      const label = document.getElementById('calendario-mes-label');
      const year = calendarioMes.getFullYear();
      const month = calendarioMes.getMonth();
      
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      label.textContent = `${meses[month]} ${year}`;
      
      const primerDia = new Date(year, month, 1);
      const ultimoDia = new Date(year, month + 1, 0);
      let startDay = primerDia.getDay(); if (startDay === 0) startDay = 7; startDay--;
      const diasMes = ultimoDia.getDate();
      const hoy = new Date();
      
      let html = '';
      ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(d => { html += `<div class="calendario-dia-header">${d}</div>`; });
      
      const mesAnterior = new Date(year, month, 0);
      for (let i = startDay - 1; i >= 0; i--) {
        html += `<div class="calendario-dia otro-mes">${mesAnterior.getDate() - i}</div>`;
      }
      
      for (let dia = 1; dia <= diasMes; dia++) {
        const fecha = new Date(year, month, dia);
        const esHoy = fecha.toDateString() === hoy.toDateString();
        const reserva = getReservaParaDia(fecha);
        let clases = 'calendario-dia';
        if (esHoy) clases += ' hoy';
        if (reserva) clases += ` reservado ${nidoColorMap[reserva.nidoId] || 'nido-1'}`;
        html += `<div class="${clases}" onclick="clickDia(${dia})">${dia}</div>`;
      }
      
      const totalCeldas = startDay + diasMes;
      const celdasFaltantes = totalCeldas % 7 === 0 ? 0 : 7 - (totalCeldas % 7);
      for (let i = 1; i <= celdasFaltantes; i++) {
        html += `<div class="calendario-dia otro-mes">${i}</div>`;
      }
      
      grid.innerHTML = html;
    }

    function getReservaParaDia(fecha) {
      const t = fecha.getTime();
      for (const r of reservasData) {
        if (!r.fechaInicio || !r.fechaFin) continue;
        const inicio = r.fechaInicio.toDate(); inicio.setHours(0,0,0,0);
        const fin = r.fechaFin.toDate(); fin.setHours(23,59,59,999);
        if (t >= inicio.getTime() && t <= fin.getTime()) return r;
      }
      return null;
    }

    function cambiarMes(delta) { calendarioMes.setMonth(calendarioMes.getMonth() + delta); renderCalendario(); }

    function clickDia(dia) {
      const fecha = new Date(calendarioMes.getFullYear(), calendarioMes.getMonth(), dia);
      const reserva = getReservaParaDia(fecha);
      abrirModalReserva(reserva ? reserva : null, reserva ? null : fecha);
    }

    function renderReservasLista() {
      const container = document.getElementById('reservas-lista-items');
      const hoy = new Date(); hoy.setHours(0,0,0,0);
      
      const proximas = reservasData.filter(r => r.fechaFin?.toDate() >= hoy).sort((a, b) => a.fechaInicio.toDate() - b.fechaInicio.toDate()).slice(0, 5);
      
      if (proximas.length === 0) { container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay reservas pr√≥ximas</div>'; return; }
      
      container.innerHTML = proximas.map(r => {
        const inicio = r.fechaInicio.toDate();
        const fin = r.fechaFin.toDate();
        const dias = Math.ceil((fin - inicio) / (1000*60*60*24)) + 1;
        return `
          <div class="reserva-item ${nidoColorMap[r.nidoId] || 'nido-1'}" onclick="abrirModalReserva(reservasData.find(x=>x.id==='${r.id}'))">
            <div class="reserva-fecha">
              <div class="reserva-fecha-dia">${inicio.getDate()}</div>
              <div class="reserva-fecha-mes">${inicio.toLocaleDateString('es-ES', {month: 'short'}).toUpperCase()}</div>
            </div>
            <div class="reserva-info">
              <div class="reserva-quien">${r.nidoNombre || 'Familia'}</div>
              <div class="reserva-periodo">${formatDateRange(inicio, fin)} ¬∑ ${dias} noche${dias > 1 ? 's' : ''}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderNidosLeyenda() {
      const container = document.getElementById('nidos-leyenda');
      const nidosConReservas = [...new Set(reservasData.map(r => r.nidoId))];
      if (nidosConReservas.length === 0) { container.innerHTML = ''; return; }
      
      const coloresHex = { 'nido-1': '#7A9E7E', 'nido-2': '#C17757', 'nido-3': '#6B8E9F', 'nido-4': '#9B8EA6' };
      container.innerHTML = nidosConReservas.map(nidoId => {
        const nido = nidosData.find(n => n.id === nidoId);
        return `<div class="nido-leyenda-item"><div class="nido-leyenda-color" style="background:${coloresHex[nidoColorMap[nidoId]]}"></div><span>${nido?.nombre || '?'}</span></div>`;
      }).join('');
    }

    // MODAL RESERVA
    const modalReserva = document.getElementById('modal-reserva');
    const formReserva = document.getElementById('form-reserva');

    function abrirModalReserva(reserva = null, fechaPre = null) {
      editingReservaId = reserva?.id || null;
      formReserva.reset();
      document.getElementById('btn-eliminar-reserva').classList.toggle('hidden', !reserva);
      
      if (reserva) {
        document.getElementById('modal-reserva-title').textContent = '‚úèÔ∏è Editar reserva';
        document.getElementById('reserva-nido').value = reserva.nidoId || '';
        document.getElementById('reserva-inicio').value = formatDateInput(reserva.fechaInicio.toDate());
        document.getElementById('reserva-fin').value = formatDateInput(reserva.fechaFin.toDate());
        document.getElementById('reserva-notas').value = reserva.notas || '';
      } else {
        document.getElementById('modal-reserva-title').textContent = 'üìÖ Nueva reserva';
        if (fechaPre) {
          document.getElementById('reserva-inicio').value = formatDateInput(fechaPre);
          const fin = new Date(fechaPre); fin.setDate(fin.getDate() + 1);
          document.getElementById('reserva-fin').value = formatDateInput(fin);
        }
      }
      modalReserva.classList.add('active');
    }

    document.getElementById('modal-reserva-close').addEventListener('click', () => modalReserva.classList.remove('active'));
    document.getElementById('modal-reserva-cancelar').addEventListener('click', () => modalReserva.classList.remove('active'));
    modalReserva.addEventListener('click', (e) => { if (e.target === modalReserva) modalReserva.classList.remove('active'); });

    formReserva.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-reserva-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const nidoId = document.getElementById('reserva-nido').value;
        const nido = nidosData.find(n => n.id === nidoId);
        
        const data = {
          nidoId, nidoNombre: nido?.nombre || 'Familia',
          fechaInicio: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('reserva-inicio').value + 'T00:00:00')),
          fechaFin: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('reserva-fin').value + 'T23:59:59')),
          notas: document.getElementById('reserva-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('reservas');
        if (editingReservaId) { await ref.doc(editingReservaId).update(data); }
        else { data.creadoPor = currentUser.uid; data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp(); await ref.add(data); }
        
        modalReserva.classList.remove('active');
        await loadReservas();
        renderCalendario(); renderReservasLista(); renderNidosLeyenda();
      } catch (error) { console.error(error); alert('Error al guardar'); }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-reserva').addEventListener('click', async () => {
      if (!editingReservaId || !confirm('¬øEliminar esta reserva?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('reservas').doc(editingReservaId).delete();
        modalReserva.classList.remove('active');
        await loadReservas();
        renderCalendario(); renderReservasLista(); renderNidosLeyenda();
      } catch (error) { console.error(error); alert('Error'); }
    });

    // UTILS
    function toggleSection(s) { document.getElementById(`section-${s}`).classList.toggle('open'); }
    function toggleLimpieza(item) { item.classList.toggle('done'); item.querySelector('.limpieza-check').textContent = item.classList.contains('done') ? '‚úì' : ''; }
    function formatDate(d) { return new Date(d).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }); }
    function formatDateInput(d) { return d.toISOString().split('T')[0]; }
    function formatDateRange(i, f) { const o = { day: 'numeric', month: 'short' }; return `${i.toLocaleDateString('es-ES', o)} - ${f.toLocaleDateString('es-ES', o)}`; }
    function editarBien() { window.location.href = `bienes.html?edit=${bienId}`; }
    document.getElementById('btn-editar').addEventListener('click', editarBien);

    // ========== INVENTARIO ==========
    const catIcons2 = {
      limpieza: 'üßπ',
      bano: 'üöø',
      cocina: 'üç≥',
      alimentos: 'ü•´',
      bebidas: 'üç∑',
      otro: 'üì¶'
    };

    const catLabels = {
      limpieza: 'Limpieza',
      bano: 'Ba√±o',
      cocina: 'Cocina',
      alimentos: 'Alimentos',
      bebidas: 'Bebidas',
      otro: 'Otro'
    };

    function renderInventario() {
      renderInventarioStats();
      renderInventarioCategorias();
      renderInventarioList();
    }

    function renderInventarioStats() {
      const container = document.getElementById('inventario-stats');
      if (!container) return;

      const total = inventarioData.length;
      const bajos = inventarioData.filter(i => i.stockActual <= i.stockMinimo).length;
      const ok = total - bajos;

      container.innerHTML = `
        <div class="inventario-stat">
          <div class="inventario-stat-valor">${total}</div>
          <div class="inventario-stat-label">Total</div>
        </div>
        <div class="inventario-stat">
          <div class="inventario-stat-valor alerta">${bajos}</div>
          <div class="inventario-stat-label">Bajo m√≠nimo</div>
        </div>
        <div class="inventario-stat">
          <div class="inventario-stat-valor" style="color:var(--success)">${ok}</div>
          <div class="inventario-stat-label">OK</div>
        </div>
      `;
    }

    function renderInventarioCategorias() {
      const container = document.getElementById('inventario-categorias');
      if (!container) return;

      // Obtener categor√≠as que tienen items
      const categoriasConItems = ['todos', ...new Set(inventarioData.map(i => i.categoria))];
      
      container.innerHTML = categoriasConItems.map(cat => `
        <button class="inventario-cat-btn ${inventarioFiltro === cat ? 'active' : ''}" onclick="filtrarInventario('${cat}')">
          ${cat === 'todos' ? 'üìã Todos' : (catIcons2[cat] || 'üì¶') + ' ' + (catLabels[cat] || cat)}
        </button>
      `).join('');
    }

    function filtrarInventario(cat) {
      inventarioFiltro = cat;
      renderInventarioCategorias();
      renderInventarioList();
    }

    function renderInventarioList() {
      const container = document.getElementById('inventario-list');
      if (!container) return;

      let items = inventarioData;
      
      // Filtrar por categor√≠a
      if (inventarioFiltro !== 'todos') {
        items = items.filter(i => i.categoria === inventarioFiltro);
      }

      // Ordenar: primero los bajo m√≠nimo
      items.sort((a, b) => {
        const aBajo = a.stockActual <= a.stockMinimo;
        const bBajo = b.stockActual <= b.stockMinimo;
        if (aBajo && !bBajo) return -1;
        if (!aBajo && bBajo) return 1;
        return a.nombre.localeCompare(b.nombre);
      });

      if (items.length === 0) {
        container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay art√≠culos en el inventario</div>';
        return;
      }

      container.innerHTML = items.map(item => {
        const bajo = item.stockActual <= item.stockMinimo;
        const icon = catIcons2[item.categoria] || 'üì¶';
        
        return `
          <div class="inventario-item ${bajo ? 'bajo' : 'ok'}" onclick="abrirModalInventario(inventarioData.find(x=>x.id==='${item.id}'))">
            <span class="inventario-item-icon">${icon}</span>
            <div class="inventario-item-info">
              <div class="inventario-item-nombre">${item.nombre}</div>
              <div class="inventario-item-meta">${item.unidad || 'uds'}${item.fechaCaducidad ? ' ¬∑ Cad: ' + formatDate(item.fechaCaducidad) : ''}</div>
            </div>
            <div class="inventario-item-stock">
              <div class="inventario-item-cantidad ${bajo ? 'bajo' : 'ok'}">${item.stockActual}</div>
              <div class="inventario-item-minimo">m√≠n. ${item.stockMinimo}</div>
            </div>
            <div class="inventario-quick-btns" onclick="event.stopPropagation()">
              <button class="inventario-quick-btn menos" onclick="ajustarStock('${item.id}', -1)">‚àí</button>
              <button class="inventario-quick-btn mas" onclick="ajustarStock('${item.id}', 1)">+</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function ajustarStock(itemId, delta) {
      const item = inventarioData.find(i => i.id === itemId);
      if (!item) return;

      const nuevoStock = Math.max(0, item.stockActual + delta);
      
      try {
        await db.collection('bienes').doc(bienId).collection('inventario').doc(itemId).update({
          stockActual: nuevoStock,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Actualizar localmente
        item.stockActual = nuevoStock;
        renderInventario();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // MODAL INVENTARIO
    const modalInventario = document.getElementById('modal-inventario');
    const formInventario = document.getElementById('form-inventario');

    function abrirModalInventario(item = null) {
      editingInventarioId = item?.id || null;
      formInventario.reset();
      document.getElementById('btn-eliminar-inventario').classList.toggle('hidden', !item);
      
      if (item) {
        document.getElementById('modal-inventario-title').textContent = '‚úèÔ∏è Editar art√≠culo';
        document.getElementById('inv-nombre').value = item.nombre || '';
        document.getElementById('inv-categoria').value = item.categoria || 'otro';
        document.getElementById('inv-unidad').value = item.unidad || 'uds';
        document.getElementById('inv-stock').value = item.stockActual || 0;
        document.getElementById('inv-minimo').value = item.stockMinimo || 1;
        document.getElementById('inv-caducidad').value = item.fechaCaducidad || '';
        document.getElementById('inv-notas').value = item.notas || '';
      } else {
        document.getElementById('modal-inventario-title').textContent = 'üì¶ Nuevo art√≠culo';
      }
      modalInventario.classList.add('active');
    }

    document.getElementById('modal-inventario-close').addEventListener('click', () => modalInventario.classList.remove('active'));
    document.getElementById('modal-inventario-cancelar').addEventListener('click', () => modalInventario.classList.remove('active'));
    modalInventario.addEventListener('click', (e) => { if (e.target === modalInventario) modalInventario.classList.remove('active'); });

    formInventario.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-inventario-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const data = {
          nombre: document.getElementById('inv-nombre').value,
          categoria: document.getElementById('inv-categoria').value,
          unidad: document.getElementById('inv-unidad').value,
          stockActual: parseInt(document.getElementById('inv-stock').value) || 0,
          stockMinimo: parseInt(document.getElementById('inv-minimo').value) || 1,
          fechaCaducidad: document.getElementById('inv-caducidad').value || null,
          notas: document.getElementById('inv-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('inventario');
        if (editingInventarioId) {
          await ref.doc(editingInventarioId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        
        modalInventario.classList.remove('active');
        await loadInventario();
        renderInventario();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-inventario').addEventListener('click', async () => {
      if (!editingInventarioId || !confirm('¬øEliminar este art√≠culo?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('inventario').doc(editingInventarioId).delete();
        modalInventario.classList.remove('active');
        await loadInventario();
        renderInventario();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ========== GASTOS ==========
    const gastoCatIcons = {
      luz: 'üí°',
      agua: 'üíß',
      gas: 'üî•',
      comunidad: 'üè¢',
      seguro: 'üõ°Ô∏è',
      mantenimiento: 'üîß',
      limpieza: 'üßπ',
      compras: 'üõí',
      otro: 'üìã'
    };

    const gastoCatLabels = {
      luz: 'Luz',
      agua: 'Agua',
      gas: 'Gas',
      comunidad: 'Comunidad',
      seguro: 'Seguro',
      mantenimiento: 'Mantenimiento',
      limpieza: 'Limpieza',
      compras: 'Compras',
      otro: 'Otro'
    };

    function renderGastos() {
      renderGastosPeriodoSelector();
      renderGastosResumen();
      renderGastosCategorias();
      renderGastosList();
      
      // Popular selector de pagador con nidos
      const selectPagador = document.getElementById('gasto-pagador');
      if (selectPagador) {
        selectPagador.innerHTML = '<option value="">Com√∫n / Sin asignar</option>' +
          nidosData.map(n => `<option value="${n.id}">${n.nombre}</option>`).join('');
      }
    }

    function renderGastosPeriodoSelector() {
      const container = document.getElementById('gastos-periodo-selector');
      if (!container) return;

      container.innerHTML = `
        <button class="gastos-periodo-btn ${gastosPeriodo === 'mes' ? 'active' : ''}" onclick="cambiarPeriodoGastos('mes')">Este mes</button>
        <button class="gastos-periodo-btn ${gastosPeriodo === 'a√±o' ? 'active' : ''}" onclick="cambiarPeriodoGastos('a√±o')">Este a√±o</button>
        <button class="gastos-periodo-btn ${gastosPeriodo === 'todos' ? 'active' : ''}" onclick="cambiarPeriodoGastos('todos')">Todos</button>
      `;
    }

    function cambiarPeriodoGastos(periodo) {
      gastosPeriodo = periodo;
      renderGastos();
    }

    function getGastosFiltrados() {
      const hoy = new Date();
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const inicioA√±o = new Date(hoy.getFullYear(), 0, 1);

      return gastosData.filter(g => {
        if (!g.fecha) return false;
        const fechaGasto = new Date(g.fecha);
        
        if (gastosPeriodo === 'mes') {
          return fechaGasto >= inicioMes;
        } else if (gastosPeriodo === 'a√±o') {
          return fechaGasto >= inicioA√±o;
        }
        return true; // todos
      });
    }

    function renderGastosResumen() {
      const container = document.getElementById('gastos-resumen');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      const total = gastosFiltrados.reduce((sum, g) => sum + (parseFloat(g.importe) || 0), 0);
      const numGastos = gastosFiltrados.length;

      const periodoLabel = gastosPeriodo === 'mes' ? 'Este mes' : gastosPeriodo === 'a√±o' ? 'Este a√±o' : 'Total';

      container.innerHTML = `
        <div class="gasto-stat">
          <div class="gasto-stat-valor">‚Ç¨${total.toFixed(2)}</div>
          <div class="gasto-stat-label">${periodoLabel}</div>
        </div>
        <div class="gasto-stat">
          <div class="gasto-stat-valor" style="color:var(--text)">${numGastos}</div>
          <div class="gasto-stat-label">Registros</div>
        </div>
      `;
    }

    function renderGastosCategorias() {
      const container = document.getElementById('gastos-categorias');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      
      // Agrupar por categor√≠a
      const porCategoria = {};
      gastosFiltrados.forEach(g => {
        const cat = g.categoria || 'otro';
        if (!porCategoria[cat]) porCategoria[cat] = 0;
        porCategoria[cat] += parseFloat(g.importe) || 0;
      });

      // Ordenar por importe descendente
      const categorias = Object.entries(porCategoria).sort((a, b) => b[1] - a[1]);

      if (categorias.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = categorias.map(([cat, total]) => `
        <div class="gasto-cat-chip">
          <span>${gastoCatIcons[cat] || 'üìã'}</span>
          <span>${gastoCatLabels[cat] || cat}</span>
          <span class="gasto-cat-chip-valor">‚Ç¨${total.toFixed(0)}</span>
        </div>
      `).join('');
    }

    function renderGastosList() {
      const container = document.getElementById('gastos-list');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();

      if (gastosFiltrados.length === 0) {
        container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay gastos registrados</div>';
        return;
      }

      // Mostrar √∫ltimos 10
      const gastosRecientes = gastosFiltrados.slice(0, 10);

      container.innerHTML = gastosRecientes.map(g => {
        const icon = gastoCatIcons[g.categoria] || 'üìã';
        const nido = g.pagadorId ? nidosData.find(n => n.id === g.pagadorId) : null;
        const fecha = g.fecha ? new Date(g.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }) : '';
        
        return `
          <div class="gasto-item" onclick="abrirModalGasto(gastosData.find(x=>x.id==='${g.id}'))">
            <span class="gasto-item-icon">${icon}</span>
            <div class="gasto-item-info">
              <div class="gasto-item-concepto">${g.concepto}</div>
              <div class="gasto-item-meta">${fecha}${g.notas ? ' ¬∑ ' + g.notas : ''}</div>
            </div>
            ${nido ? `<span class="gasto-item-pagador">${nido.nombre}</span>` : ''}
            <span class="gasto-item-importe">‚Ç¨${parseFloat(g.importe).toFixed(2)}</span>
          </div>
        `;
      }).join('');
    }

    // MODAL GASTOS
    const modalGasto = document.getElementById('modal-gasto');
    const formGasto = document.getElementById('form-gasto');

    function abrirModalGasto(gasto = null) {
      editingGastoId = gasto?.id || null;
      formGasto.reset();
      document.getElementById('btn-eliminar-gasto').classList.toggle('hidden', !gasto);
      
      // Fecha por defecto: hoy
      document.getElementById('gasto-fecha').value = formatDateInput(new Date());
      
      if (gasto) {
        document.getElementById('modal-gasto-title').textContent = '‚úèÔ∏è Editar gasto';
        document.getElementById('gasto-concepto').value = gasto.concepto || '';
        document.getElementById('gasto-categoria').value = gasto.categoria || 'otro';
        document.getElementById('gasto-importe').value = gasto.importe || '';
        document.getElementById('gasto-fecha').value = gasto.fecha || '';
        document.getElementById('gasto-pagador').value = gasto.pagadorId || '';
        document.getElementById('gasto-notas').value = gasto.notas || '';
      } else {
        document.getElementById('modal-gasto-title').textContent = 'üí∂ Nuevo gasto';
      }
      modalGasto.classList.add('active');
    }

    document.getElementById('modal-gasto-close').addEventListener('click', () => modalGasto.classList.remove('active'));
    document.getElementById('modal-gasto-cancelar').addEventListener('click', () => modalGasto.classList.remove('active'));
    modalGasto.addEventListener('click', (e) => { if (e.target === modalGasto) modalGasto.classList.remove('active'); });

    formGasto.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-gasto-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const pagadorId = document.getElementById('gasto-pagador').value;
        const nido = pagadorId ? nidosData.find(n => n.id === pagadorId) : null;
        
        const data = {
          concepto: document.getElementById('gasto-concepto').value,
          categoria: document.getElementById('gasto-categoria').value,
          importe: parseFloat(document.getElementById('gasto-importe').value) || 0,
          fecha: document.getElementById('gasto-fecha').value,
          pagadorId: pagadorId || null,
          pagadorNombre: nido?.nombre || null,
          notas: document.getElementById('gasto-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('gastos');
        if (editingGastoId) {
          await ref.doc(editingGastoId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        
        modalGasto.classList.remove('active');
        await loadGastos();
        renderGastos();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-gasto').addEventListener('click', async () => {
      if (!editingGastoId || !confirm('¬øEliminar este gasto?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('gastos').doc(editingGastoId).delete();
        modalGasto.classList.remove('active');
        await loadGastos();
        renderGastos();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });
  </script>
</body>
</html>
