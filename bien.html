<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Bien</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --capataz: #6B8E23;
      --capataz-light: #8FBC3C;
      --capataz-muted: rgba(107, 142, 35, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: var(--cream-dark); color: var(--text); }
    .header-actions { display: flex; gap: 8px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      color: white;
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
      border: 1px solid var(--cream-dark);
    }

    .btn-secondary:hover { background: var(--cream-dark); }

    .btn-mayordomo {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%);
      color: white;
    }

    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
    .btn-danger { background: var(--error); color: white; }

    .main { max-width: 1200px; margin: 0 auto; padding: 24px; }

    .layout-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    @media (max-width: 600px) { .layout-grid { grid-template-columns: 1fr; } }

    .bien-hero {
      background: var(--white);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }

    .bien-hero-image {
      height: 100px;
      background: linear-gradient(135deg, var(--sage-light) 0%, var(--sage) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      position: relative;
    }

    .bien-hero-image img { width: 100%; height: 100%; object-fit: cover; }

    .bien-hero-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: var(--mayordomo);
      color: white;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 700;
    }

    .bien-hero-badge.gerente { background: #4A5568; }
    .bien-hero-badge.capataz { background: var(--capataz); }

    .bien-hero-body {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .bien-hero-main {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 200px;
    }

    .bien-tipo-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: white;
      font-weight: 700;
      background: var(--sage-dark);
      padding: 3px 8px;
      border-radius: var(--radius-sm);
    }

    .bien-nombre {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .bien-hero-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .bien-hero-meta span { display: flex; align-items: center; gap: 4px; }
    .bien-hero-meta strong { color: var(--text); font-weight: 600; }

    /* ============ GESTI√ìN CARDS (Mayordomo / Gerente / Capataz) ============ */
    .gestion-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) {
      .gestion-cards { 
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
      .gestion-card-header {
        padding: 10px;
      }
      .gestion-card-title {
        font-size: 0.75rem;
        gap: 4px;
      }
      .gestion-card-status {
        display: none;
      }
      .gestion-card-body {
        padding: 10px;
      }
      .gestion-card-desc {
        display: none;
      }
      .gestion-card-action {
        width: 100%;
        justify-content: center;
        padding: 6px 10px;
        font-size: 0.7rem;
      }
    }

    .gestion-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      transition: all 0.3s;
      cursor: pointer;
    }

    .gestion-card.disabled {
      opacity: 0.5;
      filter: grayscale(1);
    }

    .gestion-card.active {
      box-shadow: var(--shadow-medium);
    }

    .gestion-card-header {
      padding: 16px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .gestion-card-header.mayordomo {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%);
    }

    .gestion-card-header.gerente {
      background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
    }

    .gestion-card-header.capataz {
      background: linear-gradient(135deg, var(--capataz) 0%, var(--capataz-light) 100%);
    }

    .gestion-card.disabled .gestion-card-header {
      background: linear-gradient(135deg, #9A9A9A 0%, #7A7A7A 100%);
    }

    .gestion-card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
    }

    .gestion-card-status {
      font-size: 0.7rem;
      padding: 3px 8px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-full);
    }

    .gestion-card-body {
      padding: 16px;
    }

    .gestion-card-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .gestion-card-action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .gestion-card-action:hover {
      background: var(--cream-dark);
    }

    .gestion-card-action.primary {
      background: var(--sage);
      color: white;
    }

    .gestion-card-action.primary:hover {
      background: var(--sage-dark);
    }

    /* M√≥dulos activos */
    .gestion-modulos {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }

    .gestion-modulos-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .gestion-modulos-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .gestion-modulos-title.mayordomo { color: var(--mayordomo); }
    .gestion-modulos-title.gerente { color: #4A5568; }
    .gestion-modulos-title.capataz { color: var(--capataz); }

    .modulos-botones {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn-modulo-activo {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--mayordomo);
      color: white;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s;
      box-shadow: var(--shadow-soft);
    }

    .btn-modulo-activo:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-float);
    }

    .btn-modulo-activo.gerente {
      background: #4A5568;
    }

    .btn-modulo-activo.gerente:hover {
      background: #2D3748;
    }

    .btn-modulo-activo.capataz {
      background: var(--capataz);
    }

    .btn-modulo-activo.capataz:hover {
      background: var(--capataz-light);
    }

    /* Modal configuraci√≥n m√≥dulos */
    .modulos-config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      max-height: 60vh;
      overflow-y: auto;
      padding: 4px;
    }

    .modulo-config-card {
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .modulo-config-card:hover {
      border-color: var(--sage-light);
      transform: translateY(-2px);
    }

    .modulo-config-card.activo {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .modulo-config-card.activo.gerente {
      border-color: #4A5568;
      background: rgba(74, 85, 104, 0.1);
    }

    .modulo-config-icon {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }

    .modulo-config-nombre {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .modulo-config-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .modulo-config-check {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: transparent;
    }

    .modulo-config-card.activo .modulo-config-check {
      background: var(--sage);
      color: white;
    }

    .modulo-config-card.activo.gerente .modulo-config-check {
      background: #4A5568;
    }

    .modulo-config-card.activo.capataz {
      border-color: var(--capataz);
      background: rgba(139, 115, 85, 0.1);
    }

    .modulo-config-card.activo.capataz .modulo-config-check {
      background: var(--capataz);
    }

    .btn-desactivar-gestion {
      padding: 8px 14px;
      background: transparent;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-desactivar-gestion:hover {
      background: #FFEBEE;
      border-color: #FFCDD2;
      color: var(--error);
    }

    @media (max-width: 600px) {
      .bien-hero-body { flex-direction: column; align-items: flex-start; gap: 8px; }
      .bien-hero-meta { flex-wrap: wrap; gap: 8px; }
    }

    .collapsible-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .collapsible-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }

    .collapsible-header:hover { background: var(--cream-medium); }

    .collapsible-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .collapsible-count {
      font-size: 0.75rem;
      background: var(--sage-muted);
      color: var(--sage-dark);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .collapsible-toggle {
      font-size: 1.2rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .collapsible-section.open .collapsible-toggle { transform: rotate(180deg); }
    .collapsible-body { padding: 0 20px 20px; display: none; }
    .collapsible-section.open .collapsible-body { display: block; }

    .info-list { display: flex; flex-direction: column; gap: 8px; }

    .info-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .info-item-icon { font-size: 1.3rem; }
    .info-item-content { flex: 1; }
    .info-item-title { font-weight: 600; font-size: 0.9rem; }
    .info-item-subtitle { font-size: 0.75rem; color: var(--text-muted); }

    .info-item-action {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      opacity: 0.5;
      padding: 4px;
      text-decoration: none;
    }

    .info-item-action:hover { opacity: 1; }

    .normas-box {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-line;
    }

    /* Normas de externos - estilos */
    .normas-externos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .normas-externos-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .normas-capitulo {
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      overflow: hidden;
    }

    .normas-capitulo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--sage-muted);
      cursor: pointer;
    }

    .normas-capitulo-header:hover {
      background: var(--sage-light);
    }

    .normas-capitulo-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .normas-capitulo-num {
      background: var(--sage);
      color: white;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .normas-capitulo-actions {
      display: flex;
      gap: 4px;
    }

    .normas-capitulo-actions button {
      background: white;
      border: none;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .normas-capitulo-actions button:hover {
      background: var(--cream-dark);
    }

    .normas-capitulo-body {
      padding: 12px 14px;
      display: none;
    }

    .normas-capitulo.open .normas-capitulo-body {
      display: block;
    }

    .normas-precepto {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px dashed var(--cream-dark);
      font-size: 0.85rem;
    }

    .normas-precepto:last-child {
      border-bottom: none;
    }

    .normas-precepto-num {
      color: var(--text-muted);
      font-weight: 600;
      min-width: 30px;
      font-size: 0.8rem;
    }

    .normas-empty {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
    }

    .normas-empty-icon {
      font-size: 2rem;
      opacity: 0.5;
      margin-bottom: 8px;
    }

    /* Apartados en modales de normas */
    .bien-apartado-item {
      background: var(--cream);
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
      border: 1px solid var(--cream-dark);
    }
    
    .bien-apartado-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--sage-muted);
    }
    
    .bien-apartado-header.miembros {
      background: var(--terracotta-muted);
    }
    
    .bien-apartado-header input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid var(--cream-dark);
      border-radius: 6px;
      font-size: 0.9rem;
      font-family: 'Nunito', sans-serif;
    }
    
    .bien-apartado-num {
      background: var(--sage);
      color: white;
      min-width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }
    
    .bien-apartado-num.miembros {
      background: var(--terracotta);
    }
    
    .bien-apartado-actions {
      display: flex;
      gap: 4px;
    }
    
    .bien-apartado-actions button {
      background: white;
      border: none;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .bien-apartado-actions button:hover {
      background: var(--cream-dark);
    }
    
    .bien-apartado-body {
      padding: 10px 12px;
    }
    
    .bien-apartado-body textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--cream-dark);
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: 'Nunito', sans-serif;
      resize: vertical;
      min-height: 70px;
    }
    
    .bien-apartado-body p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    /* Apartados en visualizaci√≥n */
    .normas-apartado {
      margin: 8px 0;
      padding: 10px;
      background: var(--sage-muted);
      border-radius: 6px;
    }
    
    .normas-apartado.miembros {
      background: var(--terracotta-muted);
    }
    
    .normas-apartado-titulo {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--sage-dark);
    }
    
    .normas-apartado.miembros .normas-apartado-titulo {
      color: var(--terracotta);
    }

    /* Responsive para hero y gesti√≥n */
    @media (max-width: 768px) {
      .bien-hero-image {
        height: 80px;
      }
      }

      .bien-nombre {
        font-size: 1.2rem;
      }
    }

    /* TABLET: Vista intermedia */
    @media (min-width: 769px) and (max-width: 1024px) {
      .modulos-botones {
        gap: 8px;
      }

      .btn-modulo-activo {
        padding: 10px 14px;
        font-size: 0.82rem;
      }
    }

    .modulo-panel {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .modulo-panel-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--cream-dark);
    }

    .modulo-panel-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modulo-panel-body { padding: 16px 20px; }

    /* CALENDARIO */
    .calendario-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .calendario-mes {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
    }

    .calendario-nav-btns { display: flex; gap: 4px; }

    .calendario-nav-btn {
      background: var(--cream);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1rem;
    }

    .calendario-nav-btn:hover { background: var(--cream-dark); }

    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .calendario-dia-header {
      text-align: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .calendario-dia {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
      min-height: 28px;
    }

    .calendario-dia:hover { background: var(--cream-dark); }
    .calendario-dia.otro-mes { color: var(--text-muted); opacity: 0.5; }
    .calendario-dia.hoy { background: var(--sage-muted); font-weight: 700; }
    .calendario-dia.reservado { background: var(--sage); color: white; }
    /* Colores por tipo de reserva - se generan din√°micamente */
    .calendario-dia.reservado { color: white; }

    .reservas-lista { margin-top: 16px; }

    .reservas-lista-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .reserva-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      border-left: 4px solid var(--sage);
      cursor: pointer;
      transition: all 0.2s;
    }

    .reserva-item:hover { background: var(--cream-dark); }
    /* Bordes lista reservas - se generan din√°micamente */

    .reserva-fecha { text-align: center; min-width: 50px; }
    .reserva-fecha-dia { font-size: 1.3rem; font-weight: 700; color: var(--sage-dark); }
    .reserva-fecha-mes { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); }
    .reserva-info { flex: 1; }
    .reserva-quien { font-weight: 600; font-size: 0.9rem; }
    .reserva-periodo { font-size: 0.75rem; color: var(--text-muted); }

    .nidos-leyenda {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--cream-dark);
    }

    .nido-leyenda-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; }
    .nido-leyenda-color { width: 12px; height: 12px; border-radius: 3px; }

    /* Otros m√≥dulos */
    .inventario-alerta {
      background: var(--warning);
      color: white;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      margin-bottom: 12px;
    }

    .inventario-list, .mantenimiento-list, .gastos-list, .servicios-list, .eventos-list, .limpieza-checklist {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .inventario-item, .mantenimiento-item, .gasto-item, .servicio-item, .evento-item, .limpieza-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .inventario-item.bajo { border-left: 3px solid var(--error); }
    .inventario-item-nombre, .servicio-nombre { flex: 1; font-size: 0.9rem; }
    .inventario-item-stock { font-size: 0.8rem; color: var(--text-muted); }
    .inventario-item-stock.bajo { color: var(--error); font-weight: 600; }

    .mantenimiento-tipo, .evento-icono, .servicio-icono { font-size: 1.3rem; }
    .mantenimiento-info, .evento-info { flex: 1; }
    .mantenimiento-titulo, .evento-nombre { font-weight: 600; font-size: 0.9rem; }
    .mantenimiento-fecha, .evento-fecha { font-size: 0.75rem; color: var(--text-muted); }

    .mantenimiento-badge, .evento-tipo {
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .mantenimiento-badge.programado { background: var(--sage-muted); color: var(--sage-dark); }
    .mantenimiento-badge.pendiente { background: var(--warning); color: white; }
    .evento-tipo { background: var(--terracotta-muted); color: var(--terracotta); }

    .limpieza-item { cursor: pointer; transition: all 0.2s; }
    .limpieza-item:hover { background: var(--cream-dark); }
    .limpieza-item.done { opacity: 0.5; }
    .limpieza-item.done .limpieza-texto { text-decoration: line-through; }

    .limpieza-check {
      width: 22px;
      height: 22px;
      border: 2px solid var(--sage);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: white;
    }

    .limpieza-item.done .limpieza-check { background: var(--sage); }
    .limpieza-texto { font-size: 0.9rem; }

    .gastos-resumen {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .gasto-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .gasto-stat-valor { font-size: 1.5rem; font-weight: 700; color: var(--sage-dark); }
    .gasto-stat-label { font-size: 0.75rem; color: var(--text-muted); }
    .gasto-item-nombre { flex: 1; font-size: 0.9rem; }
    .gasto-item-valor { font-weight: 600; color: var(--terracotta); }

    /* Gastos mejorado */
    .gastos-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--cream-dark);
    }

    .gastos-tab {
      padding: 10px 16px;
      background: none;
      border: none;
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .gastos-tab:hover { color: var(--text); }
    .gastos-tab.active { color: var(--terracotta); border-bottom-color: var(--terracotta); }

    .gastos-tab-content { display: none; }
    .gastos-tab-content.active { display: block; }

    .gastos-periodo-selector {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .gastos-periodo-btn {
      padding: 6px 12px;
      background: var(--cream-medium);
      border: none;
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gastos-periodo-btn:hover { background: var(--cream-dark); }
    .gastos-periodo-btn.active { background: var(--terracotta); color: white; }

    .gastos-resumen {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .gasto-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .gasto-stat-valor { font-size: 1.5rem; font-weight: 700; color: var(--terracotta); }
    .gasto-stat-label { font-size: 0.7rem; color: var(--text-muted); }

    .gastos-por-categoria {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .gasto-cat-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--cream-medium);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
    }

    .gasto-cat-chip-valor { font-weight: 700; color: var(--terracotta); }

    .gastos-list { display: flex; flex-direction: column; gap: 8px; }

    /* Reparto de gastos */
    .reparto-section { margin-top: 16px; padding: 16px; background: var(--cream); border-radius: var(--radius-md); }
    .reparto-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .reparto-miembros { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
    .reparto-miembro { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--white); border-radius: var(--radius-sm); transition: all 0.2s; }
    .reparto-miembro.selected { background: var(--sage-muted); }
    .reparto-miembro-check { width: 18px; height: 18px; cursor: pointer; accent-color: var(--sage); }
    .reparto-miembro-info { flex: 1; }
    .reparto-miembro-nombre { font-weight: 600; font-size: 0.85rem; }
    .reparto-miembro-nido { font-size: 0.7rem; color: var(--text-muted); }
    .reparto-miembro-pct { width: 70px; display: flex; align-items: center; gap: 2px; }
    .reparto-miembro-pct input { width: 50px; padding: 4px 6px; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm); text-align: right; font-size: 0.8rem; }
    .reparto-miembro-pct input:focus { outline: none; border-color: var(--sage); }
    .reparto-miembro-pct input:disabled { background: var(--cream-dark); color: var(--text-muted); }
    .reparto-miembro-importe { min-width: 70px; text-align: right; font-weight: 600; font-size: 0.85rem; color: var(--sage-dark); }
    .reparto-total { display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--cream-dark); font-weight: 600; }
    .reparto-total.error #reparto-pct-total { color: var(--error); }
    .reparto-warning { margin-top: 8px; padding: 8px; background: rgba(232,180,77,0.15); border-radius: var(--radius-sm); color: var(--warning); font-size: 0.8rem; text-align: center; }

    /* Preview reparto */
    .preview-header { text-align: center; padding-bottom: 16px; border-bottom: 1px solid var(--cream-dark); margin-bottom: 16px; }
    .preview-concepto { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; }
    .preview-total { font-size: 1.4rem; font-weight: 700; color: var(--sage-dark); }
    .preview-lista { display: flex; flex-direction: column; gap: 8px; }
    .preview-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--cream); border-radius: var(--radius-sm); }
    .preview-nombre { font-weight: 600; font-size: 0.9rem; }
    .preview-importe { font-weight: 700; color: var(--mayordomo); }
    .preview-pct { font-size: 0.75rem; color: var(--text-muted); margin-left: 6px; }

    .gasto-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .gasto-item:hover { background: var(--cream-dark); }

    .gasto-item-icon { font-size: 1.3rem; }

    .gasto-item-info { flex: 1; }
    .gasto-item-concepto { font-weight: 600; font-size: 0.9rem; }
    .gasto-item-meta { font-size: 0.7rem; color: var(--text-muted); }

    .gasto-item-importe {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--terracotta);
    }

    .gasto-item-generador {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: var(--mayordomo-muted);
      color: var(--mayordomo);
      border-radius: var(--radius-sm);
    }

    /* Tabla de reparto */
    .reparto-info {
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      padding: 12px;
      margin-bottom: 16px;
      font-size: 0.8rem;
      color: var(--sage-dark);
    }

    .reparto-table {
      width: 100%;
      border-collapse: collapse;
    }

    .reparto-table th {
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 12px;
      border-bottom: 2px solid var(--cream-dark);
    }

    .reparto-table td {
      padding: 12px;
      border-bottom: 1px solid var(--cream-dark);
      font-size: 0.9rem;
    }

    .reparto-table tr:last-child td { border-bottom: none; }

    .reparto-nido-nombre {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .reparto-nido-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .reparto-input {
      width: 70px;
      padding: 6px 10px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      text-align: right;
    }

    .reparto-input:focus {
      outline: none;
      border-color: var(--sage);
    }

    .reparto-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-top: 12px;
    }

    .reparto-total-label { font-weight: 600; }
    .reparto-total-valor { font-size: 1.1rem; font-weight: 700; }
    .reparto-total-valor.ok { color: var(--success); }
    .reparto-total-valor.error { color: var(--error); }

    .reparto-desglose {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--cream-dark);
    }

    .reparto-desglose-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .reparto-desglose-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 0.85rem;
    }

    .reparto-desglose-item span:last-child { font-weight: 600; color: var(--terracotta); }

    /* Caseros */
    .caseros-list { display: flex; flex-direction: column; gap: 10px; }

    .casero-card {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .casero-card:hover { background: var(--cream-dark); }

    .casero-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .casero-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--mayordomo);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
    }

    .casero-info { flex: 1; }
    .casero-nombre { font-weight: 600; font-size: 0.95rem; }
    .casero-email { font-size: 0.75rem; color: var(--text-muted); }

    .casero-permisos {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .casero-permiso-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: var(--sage-muted);
      color: var(--sage-dark);
      border-radius: var(--radius-sm);
    }

    .casero-permiso-badge.limitado {
      background: var(--terracotta-muted);
      color: var(--terracotta);
    }

    /* Matriz permisos en modal - Estructura jer√°rquica CVEB */
    .permisos-matrix {
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      overflow: hidden;
      max-height: 320px;
      overflow-y: auto;
    }

    .permisos-matrix-header {
      display: grid;
      grid-template-columns: 1fr repeat(4, 32px);
      gap: 4px;
      padding: 8px 12px;
      background: var(--cream-dark);
      font-size: 0.7rem;
      font-weight: 700;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .permisos-matrix-header span:first-child { text-align: left; }

    .permisos-modulo-header {
      display: grid;
      grid-template-columns: 1fr repeat(4, 32px);
      gap: 4px;
      padding: 6px 12px;
      background: var(--mayordomo-muted);
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--mayordomo);
      border-bottom: 1px solid var(--cream-dark);
      cursor: pointer;
    }

    .permisos-modulo-header:hover { background: rgba(139, 115, 85, 0.2); }

    .permisos-matrix-row {
      display: grid;
      grid-template-columns: 1fr repeat(4, 32px);
      gap: 4px;
      padding: 6px 12px;
      border-bottom: 1px solid var(--cream-dark);
      align-items: center;
      background: var(--white);
    }

    .permisos-matrix-row.card-row {
      padding-left: 24px;
      background: var(--cream);
    }

    .permisos-matrix-row.card-row label { font-size: 0.7rem; color: var(--text-light); }

    .permisos-matrix-row:last-child { border-bottom: none; }

    .permisos-matrix-row label {
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .permisos-matrix-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--sage);
    }

    .permisos-matrix-check {
      display: flex;
      justify-content: center;
    }

    /* Cat√°logo de Ajuar */
    .ajuar-grupos { display: flex; flex-direction: column; gap: 10px; }
    
    .ajuar-grupo {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    
    .ajuar-grupo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .ajuar-grupo-header:hover { background: var(--cream-dark); }
    
    .ajuar-grupo-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .ajuar-grupo-icon {
      width: 32px;
      height: 32px;
      background: var(--sage-muted);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    
    .ajuar-grupo-nombre { font-weight: 600; font-size: 0.9rem; }
    .ajuar-grupo-count { font-size: 0.75rem; color: var(--text-muted); }
    .ajuar-grupo-toggle { color: var(--text-muted); transition: transform 0.2s; }
    .ajuar-grupo.open .ajuar-grupo-toggle { transform: rotate(180deg); }
    
    .ajuar-grupo-body {
      display: none;
      padding: 0 14px 14px;
    }
    
    .ajuar-grupo.open .ajuar-grupo-body { display: block; }
    
    .ajuar-articulos { display: flex; flex-direction: column; gap: 8px; }
    
    .ajuar-articulo {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--white);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ajuar-articulo:hover { background: var(--sage-muted); }
    
    .ajuar-articulo-thumb {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      background: var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .ajuar-articulo-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .ajuar-articulo-info { flex: 1; min-width: 0; }
    .ajuar-articulo-nombre { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ajuar-articulo-desc { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .ajuar-btn-add {
      margin-top: 8px;
      padding: 8px;
      background: var(--sage-muted);
      border: 1px dashed var(--sage);
      border-radius: var(--radius-sm);
      color: var(--sage-dark);
      font-size: 0.8rem;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    
    .ajuar-btn-add:hover { background: var(--sage); color: white; border-style: solid; }

    /* Buscador Ajuar */
    .ajuar-search {
      position: relative;
      margin-bottom: 12px;
    }
    .ajuar-search-input {
      width: 100%;
      padding: 10px 14px 10px 38px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      background: var(--white);
      transition: border-color 0.2s;
    }
    .ajuar-search-input:focus {
      outline: none;
      border-color: var(--sage);
    }
    .ajuar-search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    .ajuar-search-clear {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--cream-dark);
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }
    .ajuar-search-clear:hover { background: var(--sage-muted); color: var(--text); }
    .ajuar-search-input:not(:placeholder-shown) + .ajuar-search-clear { display: flex; }
    .ajuar-search-results {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 6px;
      display: none;
    }
    .ajuar-articulo.hidden { display: none; }
    .ajuar-grupo.no-results .ajuar-grupo-header { opacity: 0.5; }
    .ajuar-highlight { background: var(--warning); padding: 0 2px; border-radius: 2px; }
    
    /* Select de ubicaci√≥n con bot√≥n a√±adir */
    .ubicacion-select-wrapper {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .ubicacion-select-wrapper select {
      flex: 1;
    }

    /* Inventario mejorado */
    .inventario-categorias {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .inventario-cat-btn {
      padding: 6px 12px;
      background: var(--cream-medium);
      border: none;
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .inventario-cat-btn:hover { background: var(--cream-dark); }
    .inventario-cat-btn.active { background: var(--sage); color: white; }

    .inventario-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .inventario-item:hover { background: var(--cream-dark); }
    .inventario-item.bajo { border-left: 3px solid var(--error); }
    .inventario-item.ok { border-left: 3px solid var(--success); }

    .inventario-item-icon { font-size: 1.3rem; }

    .inventario-item-info { flex: 1; }
    .inventario-item-nombre { font-weight: 600; font-size: 0.9rem; }
    .inventario-item-meta { font-size: 0.7rem; color: var(--text-muted); }

    .inventario-item-stock {
      text-align: right;
      min-width: 60px;
    }

    .inventario-item-cantidad {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .inventario-item-cantidad.bajo { color: var(--error); }
    .inventario-item-cantidad.ok { color: var(--success); }

    .inventario-item-minimo {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .inventario-quick-btns {
      display: flex;
      gap: 4px;
      margin-left: 8px;
    }

    .inventario-quick-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .inventario-quick-btn.menos {
      background: var(--terracotta-muted);
      color: var(--terracotta);
    }

    .inventario-quick-btn.mas {
      background: var(--sage-muted);
      color: var(--sage-dark);
    }

    .inventario-quick-btn:hover { transform: scale(1.1); }

    .inventario-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .inventario-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 12px;
      text-align: center;
    }

    .inventario-stat-valor {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .inventario-stat-valor.alerta { color: var(--error); }
    .inventario-stat-label { font-size: 0.65rem; color: var(--text-muted); }

    /* Sidebar m√≥dulos */
    .sidebar-modulo-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; padding: 4px 0; color: var(--text-muted); }
    .sidebar-modulo-item.activo { color: var(--text); font-weight: 600; }
    .smod-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--cream-dark); }
    .sidebar-modulo-item.activo .smod-dot { background: var(--success); }

    .sidebar { display: flex; flex-direction: column; gap: 16px; }

    .empty-mini {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .empty-mini-icon { font-size: 2rem; opacity: 0.3; margin-bottom: 8px; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 24px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 450px;
      transform: translateY(20px);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal { transform: translateY(0); }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .modal-close {
      background: var(--cream);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .modal-close:hover { background: var(--cream-dark); }
    .modal-body { padding: 24px; }

    .modal-footer {
      padding: 0 24px 24px;
      display: flex;
      gap: 12px;
      justify-content: space-between;
    }

    .form-group { margin-bottom: 16px; }
    .form-group:last-child { margin-bottom: 0; }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
      transition: all 0.2s;
      background: var(--white);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--sage);
      box-shadow: 0 0 0 3px var(--sage-muted);
    }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* Checkboxes de d√≠as de la semana */
    .dia-check {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
      background: var(--white);
    }
    .dia-check input { display: none; }
    .dia-check span {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
    }
    .dia-check:hover { border-color: var(--sage-light); }
    .dia-check:has(input:checked) {
      background: var(--sage);
      border-color: var(--sage);
    }
    .dia-check:has(input:checked) span { color: white; }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="lo-comun.html" class="back-btn"><span>‚Üê</span><span>Lo Com√∫n</span></a>
    </div>
    <div class="header-actions">
      <a href="#" class="btn btn-mayordomo btn-sm hidden" id="btn-abrir-mayordomo">üé© Abrir Mayordomo</a>
      <button class="btn btn-secondary btn-sm" id="btn-editar">‚úèÔ∏è Editar</button>
    </div>
  </header>

  <main class="main">
    <div id="page-loading" class="loading"><div class="spinner"></div></div>

    <div id="page-content" class="hidden">
      <!-- Hero compacto -->
      <div class="bien-hero">
        <div class="bien-hero-image" id="bien-hero-image">üè†</div>
        <div class="bien-hero-body">
          <div class="bien-hero-main">
            <span class="bien-tipo-label" id="bien-tipo">Inmueble</span>
            <h1 class="bien-nombre" id="bien-nombre">Cargando...</h1>
          </div>
          <div class="bien-hero-meta">
            <span>üìç <span id="bien-ubicacion">-</span></span>
            <span><strong>Titular:</strong> <span id="bien-titularidad">-</span></span>
            <span><strong>Origen:</strong> <span id="bien-origen">-</span></span>
          </div>
        </div>
      </div>

      <!-- Cards Gesti√≥n: Mayordomo | Gerente | Capataz -->
      <div class="gestion-cards">
        <div class="gestion-card" id="card-mayordomo" onclick="toggleGestion('mayordomo')">
          <div class="gestion-card-header mayordomo">
            <div class="gestion-card-title">üé© Mayordomo</div>
            <span class="gestion-card-status" id="status-mayordomo">Inactivo</span>
          </div>
          <div class="gestion-card-body">
            <p class="gestion-card-desc">Gesti√≥n dom√©stica: reservas, inventario, gastos, limpieza...</p>
            <button class="gestion-card-action primary" id="btn-mayordomo">Activar</button>
          </div>
        </div>

        <div class="gestion-card disabled" id="card-gerente" onclick="toggleGestion('gerente')">
          <div class="gestion-card-header gerente">
            <div class="gestion-card-title">üíº Gerente</div>
            <span class="gestion-card-status" id="status-gerente">Inactivo</span>
          </div>
          <div class="gestion-card-body">
            <p class="gestion-card-desc">Gesti√≥n profesional: contratos, facturaci√≥n, inquilinos...</p>
            <button class="gestion-card-action primary" id="btn-gerente">Activar</button>
          </div>
        </div>

        <div class="gestion-card disabled" id="card-capataz" onclick="toggleGestion('capataz')">
          <div class="gestion-card-header capataz">
            <div class="gestion-card-title">üöú Capataz</div>
            <span class="gestion-card-status" id="status-capataz">Inactivo</span>
          </div>
          <div class="gestion-card-body">
            <p class="gestion-card-desc">Gesti√≥n rural: parcelas, cultivos, maquinaria, personal...</p>
            <button class="gestion-card-action primary" id="btn-capataz">Activar</button>
          </div>
        </div>
      </div>

      <!-- Panel de m√≥dulos (solo visible si hay gesti√≥n activa) -->
      <div class="gestion-modulos hidden" id="gestion-modulos">
        <div class="gestion-modulos-header">
          <div class="gestion-modulos-title" id="gestion-titulo">üé© M√≥dulos Mayordomo</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-secondary btn-sm" onclick="abrirConfigModulos()">‚öôÔ∏è Configurar m√≥dulos</button>
            <button class="btn-desactivar-gestion" onclick="desactivarGestion()">‚ùå Desactivar</button>
          </div>
        </div>
        <div class="modulos-botones" id="modulos-botones"></div>
      </div>

      <div class="layout-grid">
        <div class="sidebar">
          <!-- Caseros -->
          <div class="collapsible-section" id="section-caseros">
            <div class="collapsible-header" onclick="toggleSection('caseros')">
              <div class="collapsible-title"><span>üë§</span><span>Caseros</span><span class="collapsible-count" id="count-caseros">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="caseros-list" id="lista-caseros"><div class="empty-mini">Sin caseros asignados</div></div>
              <button class="btn btn-secondary btn-sm" style="width:100%;margin-top:10px;" onclick="abrirModalCasero()">+ A√±adir casero</button>
            </div>
          </div>

          <!-- Normas para miembros de la familia -->
          <div class="collapsible-section" id="section-normas-uso">
            <div class="collapsible-header" onclick="toggleSection('normas-uso')">
              <div class="collapsible-title"><span>üìñ</span><span>Pautas de uso y convivencia de familiares</span><span class="collapsible-count" id="count-normas-uso">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="normas-externos-header">
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">
                  Normas visibles para todos los miembros de la familia
                </p>
                <div class="normas-externos-actions">
                  <button class="btn btn-secondary btn-sm" onclick="copiarPlantillaNormasMiembros()">üìã Copiar plantilla</button>
                  <button class="btn btn-secondary btn-sm" onclick="abrirModalCapituloNormaMiembros()">‚ûï A√±adir cap√≠tulo</button>
                </div>
              </div>
              <div id="normas-miembros-container">
                <div class="normas-empty">
                  <div class="normas-empty-icon">üìñ</div>
                  <p>Sin pautas de uso y convivencia</p>
                  <p style="font-size: 0.8rem;">A√±ade cap√≠tulos o copia una plantilla base</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Normas para externos (solo visible si hay add-on activo) -->
          <div class="collapsible-section hidden" id="section-normas">
            <div class="collapsible-header" onclick="toggleSection('normas')">
              <div class="collapsible-title"><span>üìú</span><span id="titulo-normas-externos">Normas para Caseros</span><span class="collapsible-count" id="count-normas">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="normas-externos-header">
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;" id="desc-normas-externos">
                  Normas visibles para usuarios externos con acceso al bien
                </p>
                <div class="normas-externos-actions">
                  <button class="btn btn-secondary btn-sm" onclick="copiarPlantillaNormas()">üìã Copiar plantilla</button>
                  <button class="btn btn-secondary btn-sm" onclick="abrirModalCapituloNorma()">‚ûï A√±adir cap√≠tulo</button>
                </div>
              </div>
              <div id="normas-externos-container">
                <div class="normas-empty">
                  <div class="normas-empty-icon">üìù</div>
                  <p>Sin normas definidas</p>
                  <p style="font-size: 0.8rem;">A√±ade cap√≠tulos o copia una plantilla base</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Hosters (Gerente) -->
          <div class="collapsible-section hidden" id="section-hosters">
            <div class="collapsible-header" onclick="toggleSection('hosters')">
              <div class="collapsible-title"><span>üè®</span><span>Hosters</span><span class="collapsible-count" id="count-hosters">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">Personal de atenci√≥n a hu√©spedes e inquilinos</p>
              <div class="hosters-list" id="lista-hosters"><div class="empty-mini">Sin hosters asignados</div></div>
              <button class="btn btn-secondary btn-sm" style="width:100%;margin-top:10px;" onclick="abrirModalHoster()">+ A√±adir hoster</button>
            </div>
          </div>

          <div class="collapsible-section" id="section-personal">
            <div class="collapsible-header" onclick="toggleSection('personal')">
              <div class="collapsible-title"><span>üë∑</span><span>Refuerzos</span><span class="collapsible-count" id="count-personal">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;font-size:0.75rem;">
                <span style="padding:3px 8px;background:var(--cream);border-radius:12px;">üßπ Limpieza</span>
                <span style="padding:3px 8px;background:var(--cream);border-radius:12px;">üåø Jard√≠n</span>
                <span style="padding:3px 8px;background:var(--cream);border-radius:12px;">üîß Otros</span>
              </div>
              <div class="info-list" id="lista-personal"><div class="empty-mini">Sin refuerzos</div></div>
            </div>
          </div>

          <div class="collapsible-section" id="section-mascotas">
            <div class="collapsible-header" onclick="toggleSection('mascotas')">
              <div class="collapsible-title"><span>üêæ</span><span>Mascotas</span><span class="collapsible-count" id="count-mascotas">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-mascotas"><div class="empty-mini">Sin mascotas</div></div></div>
          </div>

          <div class="collapsible-section" id="section-habitaciones">
            <div class="collapsible-header" onclick="toggleSection('habitaciones')">
              <div class="collapsible-title"><span>üè†</span><span>Zonas</span><span class="collapsible-count" id="count-habitaciones">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-habitaciones"><div class="empty-mini">Sin habitaciones definidas</div></div></div>
          </div>

          <div class="collapsible-section" id="section-contactos">
            <div class="collapsible-header" onclick="toggleSection('contactos')">
              <div class="collapsible-title"><span>üìû</span><span>Contactos</span><span class="collapsible-count" id="count-contactos">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-contactos"><div class="empty-mini">Sin contactos</div></div></div>
          </div>

          <div class="collapsible-section" id="section-documentos">
            <div class="collapsible-header" onclick="toggleSection('documentos')">
              <div class="collapsible-title"><span>üìÑ</span><span>Documentos</span><span class="collapsible-count" id="count-documentos">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-documentos"><div class="empty-mini">Sin documentos</div></div></div>
          </div>

          <!-- Cat√°logo de Ajuar (solo visible para tipo ajuar) -->
          <div class="collapsible-section hidden" id="section-catalogo-ajuar">
            <div class="collapsible-header" onclick="toggleSection('catalogo-ajuar')">
              <div class="collapsible-title"><span>ü™ë</span><span>Ajuar</span><span class="collapsible-count" id="count-articulos-ajuar">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">Grupos y art√≠culos del ajuar familiar</p>
              
              <!-- Buscador Ajuar -->
              <div class="ajuar-search">
                <span class="ajuar-search-icon">üîç</span>
                <input type="text" class="ajuar-search-input" id="ajuar-search-input" placeholder="Buscar art√≠culo..." oninput="filtrarAjuar(this.value)">
                <button class="ajuar-search-clear" onclick="limpiarBusquedaAjuar()">‚úï</button>
              </div>
              <div class="ajuar-search-results" id="ajuar-search-results"></div>
              
              <div class="ajuar-grupos" id="lista-grupos-ajuar">
                <div class="empty-mini">Sin grupos creados</div>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 10px;">
                <button class="btn btn-secondary btn-sm" style="flex:1;" onclick="abrirModalGrupoAjuar()">+ A√±adir grupo</button>
                <button class="btn btn-secondary btn-sm" style="flex:1;" onclick="abrirModalLugaresAjuar()">üìç Lugares</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Configurar M√≥dulos -->
  <div class="modal-overlay" id="modal-config-modulos">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header" id="modal-config-header">
        <h3 class="modal-title">‚öôÔ∏è Configurar M√≥dulos</h3>
        <button class="modal-close" onclick="cerrarConfigModulos()">√ó</button>
      </div>
      <div class="modal-body">
        <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px;">Selecciona los m√≥dulos que necesitas para gestionar este bien. Puedes activarlos o desactivarlos en cualquier momento.</p>
        <div class="modulos-config-grid" id="modulos-config-grid"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarConfigModulos()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Reserva -->
  <div class="modal-overlay" id="modal-reserva">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-reserva-title">üìÖ Nueva reserva</h3>
        <button class="modal-close" id="modal-reserva-close">√ó</button>
      </div>
      <form id="form-reserva">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¬øQui√©n reserva?</label>
            <select class="form-select" id="reserva-tipo" required>
              <option value="">Cargando...</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha inicio</label>
              <input type="date" class="form-input" id="reserva-inicio" required>
            </div>
            <div class="form-group">
              <label class="form-label">Fecha fin</label>
              <input type="date" class="form-input" id="reserva-fin" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Nota breve</label>
            <input type="text" class="form-input" id="reserva-notas" placeholder="Ej: Cumplea√±os abuelo, cacer√≠a oto√±o..." maxlength="50">
            <div class="form-hint">Se muestra al pasar el rat√≥n sobre la reserva</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-reserva">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-reserva-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-reserva-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Inventario -->
  <div class="modal-overlay" id="modal-inventario">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-inventario-title">üì¶ Nuevo art√≠culo</h3>
        <button class="modal-close" id="modal-inventario-close">√ó</button>
      </div>
      <form id="form-inventario">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre del art√≠culo</label>
            <input type="text" class="form-input" id="inv-nombre" placeholder="Ej: Papel higi√©nico" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="inv-categoria" required>
                <option value="limpieza">üßπ Limpieza</option>
                <option value="bano">üöø Ba√±o</option>
                <option value="cocina">üç≥ Cocina</option>
                <option value="alimentos">ü•´ Alimentos</option>
                <option value="bebidas">üç∑ Bebidas</option>
                <option value="otro">üì¶ Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Unidad</label>
              <select class="form-select" id="inv-unidad">
                <option value="uds">Unidades</option>
                <option value="rollos">Rollos</option>
                <option value="botellas">Botellas</option>
                <option value="paquetes">Paquetes</option>
                <option value="kg">Kg</option>
                <option value="litros">Litros</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Stock actual</label>
              <input type="number" class="form-input" id="inv-stock" min="0" value="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Stock m√≠nimo</label>
              <input type="number" class="form-input" id="inv-minimo" min="0" value="1" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha caducidad (opcional)</label>
            <input type="date" class="form-input" id="inv-caducidad">
          </div>
          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="inv-notas" placeholder="Ej: Marca preferida, d√≥nde comprarlo...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-inventario">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-inventario-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-inventario-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Gastos -->
  <div class="modal-overlay" id="modal-gasto">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-gasto-title">üí∂ Nuevo gasto</h3>
        <button class="modal-close" id="modal-gasto-close">√ó</button>
      </div>
      <form id="form-gasto">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha</label>
              <input type="date" class="form-input" id="gasto-fecha" required>
            </div>
            <div class="form-group">
              <label class="form-label">Importe (‚Ç¨)</label>
              <input type="number" class="form-input" id="gasto-importe" min="0" step="0.01" placeholder="0.00" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Concepto</label>
            <input type="text" class="form-input" id="gasto-concepto" placeholder="Ej: Factura luz noviembre" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="gasto-categoria" required>
                <option value="luz">üí° Luz</option>
                <option value="agua">üíß Agua</option>
                <option value="gas">üî• Gas</option>
                <option value="comunidad">üè¢ Comunidad</option>
                <option value="seguro">üõ°Ô∏è Seguro</option>
                <option value="mantenimiento">üîß Mantenimiento</option>
                <option value="limpieza">üßπ Limpieza</option>
                <option value="compras">üõí Compras</option>
                <option value="otro">üìã Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Proveedor</label>
              <input type="text" class="form-input" id="gasto-proveedor" placeholder="Ej: Iberdrola, Ferreter√≠a...">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Generador (qui√©n lo ordena)</label>
            <select class="form-select" id="gasto-generador">
              <option value="">Sin asignar</option>
            </select>
          </div>

          <!-- Reparto de gastos -->
          <div class="reparto-section">
            <div class="reparto-header">
              <label class="form-label">üìä Reparto entre miembros</label>
              <button type="button" class="btn btn-sm btn-secondary" onclick="repartoLineal()">‚ÜîÔ∏è Lineal</button>
            </div>
            <div class="reparto-miembros" id="reparto-miembros">
              <!-- Se carga din√°micamente -->
            </div>
            <div class="reparto-total" id="reparto-total">
              <span>Total asignado:</span>
              <span id="reparto-pct-total">0%</span>
            </div>
            <div class="reparto-warning hidden" id="reparto-warning">‚ö†Ô∏è Los porcentajes deben sumar 100%</div>
          </div>

          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="gasto-notas" placeholder="Ej: N¬∫ factura, observaciones...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-gasto">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-gasto-cancelar">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="previsualizarReparto()">üëÅÔ∏è Vista previa</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Vista Previa Reparto -->
  <div class="modal-overlay" id="modal-reparto-preview">
    <div class="modal" style="max-width:400px;">
      <div class="modal-header">
        <h3 class="modal-title">üìä Vista previa del reparto</h3>
        <button class="modal-close" onclick="cerrarPreviewReparto()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="preview-header">
          <div class="preview-concepto" id="preview-concepto">-</div>
          <div class="preview-total" id="preview-total">0,00 ‚Ç¨</div>
        </div>
        <div class="preview-lista" id="preview-lista">
          <!-- Se genera din√°micamente -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarPreviewReparto()">Volver</button>
        <button type="button" class="btn btn-primary" onclick="guardarGastoConReparto()">üíæ Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Casero -->
  <!-- Modal Casero -->
  <div class="modal-overlay" id="modal-casero">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-casero-title">üë§ Nuevo casero</h3>
        <button class="modal-close" id="modal-casero-close">√ó</button>
      </div>
      <form id="form-casero">
        <div class="modal-body" style="max-height:65vh;overflow-y:auto;">
          <div class="form-group">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-input" id="casero-nombre" placeholder="Nombre completo" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Email (para login)</label>
              <input type="email" class="form-input" id="casero-email" placeholder="email@ejemplo.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Tel√©fono</label>
              <input type="tel" class="form-input" id="casero-telefono" placeholder="600 000 000">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" style="margin-bottom:12px;">Permisos en este bien</label>
            <div class="permisos-matrix" id="permisos-matrix-casero">
              <div class="permisos-matrix-header">
                <span>M√≥dulo / Card</span>
                <span>C</span>
                <span>V</span>
                <span>E</span>
                <span>B</span>
              </div>
              <div id="permisos-rows-casero"></div>
            </div>
            <div style="font-size:0.65rem;color:var(--text-muted);margin-top:6px;display:flex;gap:10px;flex-wrap:wrap;">
              <span><b>C</b>=Crear</span>
              <span><b>V</b>=Ver</span>
              <span><b>E</b>=Editar</span>
              <span><b>B</b>=Borrar</span>
            </div>
          </div>
          
          <!-- Libranzas -->
          <div class="form-group" style="margin-top:16px;">
            <label class="form-label">üìÖ Libranzas semanales</label>
            <div class="form-row" style="margin-top:8px;">
              <div class="form-group" style="flex:0 0 120px;">
                <label class="form-label" style="font-size:0.75rem;">N¬∫ d√≠as/semana</label>
                <select class="form-select" id="casero-libranza-dias">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="1.5">1.5</option>
                  <option value="2" selected>2</option>
                  <option value="2.5">2.5</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label" style="font-size:0.75rem;">¬øCu√°les?</label>
                <div class="dias-semana-checks" style="display:flex;gap:6px;flex-wrap:wrap;">
                  <label class="dia-check"><input type="checkbox" id="casero-lib-L"><span>L</span></label>
                  <label class="dia-check"><input type="checkbox" id="casero-lib-M"><span>M</span></label>
                  <label class="dia-check"><input type="checkbox" id="casero-lib-X"><span>X</span></label>
                  <label class="dia-check"><input type="checkbox" id="casero-lib-J"><span>J</span></label>
                  <label class="dia-check"><input type="checkbox" id="casero-lib-V"><span>V</span></label>
                  <label class="dia-check"><input type="checkbox" id="casero-lib-S" checked><span>S</span></label>
                  <label class="dia-check"><input type="checkbox" id="casero-lib-D" checked><span>D</span></label>
                </div>
              </div>
            </div>
            <textarea class="form-input" id="casero-libranza-notas" placeholder="Notas sobre libranzas..." rows="2" style="margin-top:8px;"></textarea>
          </div>
          
          <!-- Vacaciones -->
          <div class="form-group" style="margin-top:16px;">
            <label class="form-label">üèñÔ∏è Vacaciones anuales</label>
            <div class="form-row" style="margin-top:8px;">
              <div class="form-group" style="flex:0 0 140px;">
                <label class="form-label" style="font-size:0.75rem;">D√≠as naturales/a√±o</label>
                <input type="number" class="form-input" id="casero-vacaciones-dias" value="30" min="0" max="60">
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label" style="font-size:0.75rem;">Notas</label>
                <input type="text" class="form-input" id="casero-vacaciones-notas" placeholder="Acuerdos, condiciones...">
              </div>
            </div>
            
            <!-- Bloque 1 -->
            <div style="background:var(--cream);border-radius:8px;padding:12px;margin-top:12px;">
              <div style="font-weight:600;font-size:0.8rem;margin-bottom:8px;color:var(--sage-dark);">üìÖ Bloque 1</div>
              <div class="form-row" style="gap:10px;">
                <div class="form-group" style="flex:1;">
                  <label class="form-label" style="font-size:0.7rem;">Salida</label>
                  <input type="date" class="form-input" id="casero-vac1-salida">
                </div>
                <div class="form-group" style="flex:1;">
                  <label class="form-label" style="font-size:0.7rem;">Vuelta</label>
                  <input type="date" class="form-input" id="casero-vac1-vuelta">
                </div>
              </div>
            </div>
            
            <!-- Bloque 2 -->
            <div style="background:var(--cream);border-radius:8px;padding:12px;margin-top:8px;">
              <div style="font-weight:600;font-size:0.8rem;margin-bottom:8px;color:var(--sage-dark);">üìÖ Bloque 2</div>
              <div class="form-row" style="gap:10px;">
                <div class="form-group" style="flex:1;">
                  <label class="form-label" style="font-size:0.7rem;">Salida</label>
                  <input type="date" class="form-input" id="casero-vac2-salida">
                </div>
                <div class="form-group" style="flex:1;">
                  <label class="form-label" style="font-size:0.7rem;">Vuelta</label>
                  <input type="date" class="form-input" id="casero-vac2-vuelta">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-casero">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-casero-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-casero-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Hoster (Gerente) -->
  <div class="modal-overlay" id="modal-hoster">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #4A5568, #2D3748); color: white;">
        <h3 class="modal-title" id="modal-hoster-title">üè® Nuevo hoster</h3>
        <button class="modal-close" id="modal-hoster-close" style="color: white;">√ó</button>
      </div>
      <form id="form-hoster">
        <div class="modal-body" style="max-height:65vh;overflow-y:auto;">
          <div class="form-group">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-input" id="hoster-nombre" placeholder="Nombre completo" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Email (para login)</label>
              <input type="email" class="form-input" id="hoster-email" placeholder="email@ejemplo.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Tel√©fono</label>
              <input type="tel" class="form-input" id="hoster-telefono" placeholder="600 000 000">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Rol</label>
            <select class="form-select" id="hoster-rol">
              <option value="recepcion">üõéÔ∏è Recepci√≥n</option>
              <option value="limpieza">üßπ Limpieza</option>
              <option value="mantenimiento">üîß Mantenimiento</option>
              <option value="atencion">üí¨ Atenci√≥n hu√©spedes</option>
              <option value="completo">‚≠ê Completo</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" style="margin-bottom:12px;">Permisos en este bien</label>
            <div class="permisos-matrix" id="permisos-matrix-hoster">
              <div class="permisos-matrix-header">
                <span>M√≥dulo / Card</span>
                <span>C</span>
                <span>V</span>
                <span>E</span>
                <span>B</span>
              </div>
              <div id="permisos-rows-hoster"></div>
            </div>
            <div style="font-size:0.65rem;color:var(--text-muted);margin-top:6px;display:flex;gap:10px;flex-wrap:wrap;">
              <span><b>C</b>=Crear</span>
              <span><b>V</b>=Ver</span>
              <span><b>E</b>=Editar</span>
              <span><b>B</b>=Borrar</span>
            </div>
          </div>
          
          <!-- Libranzas -->
          <div class="form-group" style="margin-top:16px;">
            <label class="form-label">üìÖ Libranzas semanales</label>
            <div class="form-row" style="margin-top:8px;">
              <div class="form-group" style="flex:0 0 120px;">
                <label class="form-label" style="font-size:0.75rem;">N¬∫ d√≠as/semana</label>
                <select class="form-select" id="hoster-libranza-dias">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="1.5">1.5</option>
                  <option value="2" selected>2</option>
                  <option value="2.5">2.5</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label" style="font-size:0.75rem;">¬øCu√°les?</label>
                <div class="dias-semana-checks" style="display:flex;gap:6px;flex-wrap:wrap;">
                  <label class="dia-check"><input type="checkbox" id="hoster-lib-L"><span>L</span></label>
                  <label class="dia-check"><input type="checkbox" id="hoster-lib-M"><span>M</span></label>
                  <label class="dia-check"><input type="checkbox" id="hoster-lib-X"><span>X</span></label>
                  <label class="dia-check"><input type="checkbox" id="hoster-lib-J"><span>J</span></label>
                  <label class="dia-check"><input type="checkbox" id="hoster-lib-V"><span>V</span></label>
                  <label class="dia-check"><input type="checkbox" id="hoster-lib-S" checked><span>S</span></label>
                  <label class="dia-check"><input type="checkbox" id="hoster-lib-D" checked><span>D</span></label>
                </div>
              </div>
            </div>
            <textarea class="form-input" id="hoster-libranza-notas" placeholder="Notas sobre libranzas..." rows="2" style="margin-top:8px;"></textarea>
          </div>
          
          <!-- Vacaciones -->
          <div class="form-group" style="margin-top:16px;">
            <label class="form-label">üèñÔ∏è Vacaciones anuales</label>
            <div class="form-row" style="margin-top:8px;">
              <div class="form-group" style="flex:0 0 140px;">
                <label class="form-label" style="font-size:0.75rem;">D√≠as naturales/a√±o</label>
                <input type="number" class="form-input" id="hoster-vacaciones-dias" value="30" min="0" max="60">
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label" style="font-size:0.75rem;">Notas</label>
                <input type="text" class="form-input" id="hoster-vacaciones-notas" placeholder="Acuerdos, condiciones...">
              </div>
            </div>
            <div style="background:var(--cream);border-radius:8px;padding:12px;margin-top:12px;">
              <div style="font-weight:600;font-size:0.8rem;margin-bottom:8px;color:var(--sage-dark);">üìÖ Bloque 1</div>
              <div class="form-row" style="gap:10px;">
                <div class="form-group" style="flex:1;"><label class="form-label" style="font-size:0.7rem;">Salida</label><input type="date" class="form-input" id="hoster-vac1-salida"></div>
                <div class="form-group" style="flex:1;"><label class="form-label" style="font-size:0.7rem;">Vuelta</label><input type="date" class="form-input" id="hoster-vac1-vuelta"></div>
              </div>
            </div>
            <div style="background:var(--cream);border-radius:8px;padding:12px;margin-top:8px;">
              <div style="font-weight:600;font-size:0.8rem;margin-bottom:8px;color:var(--sage-dark);">üìÖ Bloque 2</div>
              <div class="form-row" style="gap:10px;">
                <div class="form-group" style="flex:1;"><label class="form-label" style="font-size:0.7rem;">Salida</label><input type="date" class="form-input" id="hoster-vac2-salida"></div>
                <div class="form-group" style="flex:1;"><label class="form-label" style="font-size:0.7rem;">Vuelta</label><input type="date" class="form-input" id="hoster-vac2-vuelta"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-hoster">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-hoster-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #4A5568, #2D3748);" id="modal-hoster-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Guarda (Capataz) -->
  <div class="modal-overlay" id="modal-guarda">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #6B8E23, #556B2F); color: white;">
        <h3 class="modal-title" id="modal-guarda-title">üåæ Nuevo guarda</h3>
        <button class="modal-close" id="modal-guarda-close" style="color: white;">√ó</button>
      </div>
      <form id="form-guarda">
        <div class="modal-body" style="max-height:65vh;overflow-y:auto;">
          <div class="form-group">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-input" id="guarda-nombre" placeholder="Nombre completo" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Email (para login)</label>
              <input type="email" class="form-input" id="guarda-email" placeholder="email@ejemplo.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Tel√©fono</label>
              <input type="tel" class="form-input" id="guarda-telefono" placeholder="600 000 000">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Rol</label>
            <select class="form-select" id="guarda-rol">
              <option value="guarda">üåæ Guarda</option>
              <option value="vigilante">üëÅÔ∏è Vigilante</option>
              <option value="jardinero">üå± Jardinero</option>
              <option value="mantenimiento">üîß Mantenimiento</option>
              <option value="completo">‚≠ê Completo</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" style="margin-bottom:12px;">Permisos en este bien</label>
            <div class="permisos-matrix" id="permisos-matrix-guarda">
              <div class="permisos-matrix-header">
                <span>M√≥dulo / Card</span>
                <span>C</span>
                <span>V</span>
                <span>E</span>
                <span>B</span>
              </div>
              <div id="permisos-rows-guarda"></div>
            </div>
            <div style="font-size:0.65rem;color:var(--text-muted);margin-top:6px;display:flex;gap:10px;flex-wrap:wrap;">
              <span><b>C</b>=Crear</span>
              <span><b>V</b>=Ver</span>
              <span><b>E</b>=Editar</span>
              <span><b>B</b>=Borrar</span>
            </div>
          </div>
          
          <!-- Libranzas -->
          <div class="form-group" style="margin-top:16px;">
            <label class="form-label">üìÖ Libranzas semanales</label>
            <div class="form-row" style="margin-top:8px;">
              <div class="form-group" style="flex:0 0 120px;">
                <label class="form-label" style="font-size:0.75rem;">N¬∫ d√≠as/semana</label>
                <select class="form-select" id="guarda-libranza-dias">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="1.5">1.5</option>
                  <option value="2" selected>2</option>
                  <option value="2.5">2.5</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label" style="font-size:0.75rem;">¬øCu√°les?</label>
                <div class="dias-semana-checks" style="display:flex;gap:6px;flex-wrap:wrap;">
                  <label class="dia-check"><input type="checkbox" id="guarda-lib-L"><span>L</span></label>
                  <label class="dia-check"><input type="checkbox" id="guarda-lib-M"><span>M</span></label>
                  <label class="dia-check"><input type="checkbox" id="guarda-lib-X"><span>X</span></label>
                  <label class="dia-check"><input type="checkbox" id="guarda-lib-J"><span>J</span></label>
                  <label class="dia-check"><input type="checkbox" id="guarda-lib-V"><span>V</span></label>
                  <label class="dia-check"><input type="checkbox" id="guarda-lib-S" checked><span>S</span></label>
                  <label class="dia-check"><input type="checkbox" id="guarda-lib-D" checked><span>D</span></label>
                </div>
              </div>
            </div>
            <textarea class="form-input" id="guarda-libranza-notas" placeholder="Notas sobre libranzas..." rows="2" style="margin-top:8px;"></textarea>
          </div>
          
          <!-- Vacaciones -->
          <div class="form-group" style="margin-top:16px;">
            <label class="form-label">üèñÔ∏è Vacaciones anuales</label>
            <div class="form-row" style="margin-top:8px;">
              <div class="form-group" style="flex:0 0 140px;">
                <label class="form-label" style="font-size:0.75rem;">D√≠as naturales/a√±o</label>
                <input type="number" class="form-input" id="guarda-vacaciones-dias" value="30" min="0" max="60">
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label" style="font-size:0.75rem;">Notas</label>
                <input type="text" class="form-input" id="guarda-vacaciones-notas" placeholder="Acuerdos, condiciones...">
              </div>
            </div>
            <div style="background:var(--cream);border-radius:8px;padding:12px;margin-top:12px;">
              <div style="font-weight:600;font-size:0.8rem;margin-bottom:8px;color:var(--sage-dark);">üìÖ Bloque 1</div>
              <div class="form-row" style="gap:10px;">
                <div class="form-group" style="flex:1;"><label class="form-label" style="font-size:0.7rem;">Salida</label><input type="date" class="form-input" id="guarda-vac1-salida"></div>
                <div class="form-group" style="flex:1;"><label class="form-label" style="font-size:0.7rem;">Vuelta</label><input type="date" class="form-input" id="guarda-vac1-vuelta"></div>
              </div>
            </div>
            <div style="background:var(--cream);border-radius:8px;padding:12px;margin-top:8px;">
              <div style="font-weight:600;font-size:0.8rem;margin-bottom:8px;color:var(--sage-dark);">üìÖ Bloque 2</div>
              <div class="form-row" style="gap:10px;">
                <div class="form-group" style="flex:1;"><label class="form-label" style="font-size:0.7rem;">Salida</label><input type="date" class="form-input" id="guarda-vac2-salida"></div>
                <div class="form-group" style="flex:1;"><label class="form-label" style="font-size:0.7rem;">Vuelta</label><input type="date" class="form-input" id="guarda-vac2-vuelta"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-guarda">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-guarda-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #6B8E23, #556B2F);" id="modal-guarda-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Editar Bien -->
  <div class="modal-overlay" id="modal-editar-bien">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Editar bien</h3>
        <button class="modal-close" id="modal-editar-close">√ó</button>
      </div>
      <form id="form-editar-bien">
        <!-- Tabs -->
        <div class="modal-tabs" style="display:flex;border-bottom:1px solid var(--cream-dark);padding:0 24px;">
          <button type="button" class="modal-tab active" data-tab="datos">üìã Datos</button>
          <button type="button" class="modal-tab" data-tab="habitaciones">üè† Zonas</button>
          <button type="button" class="modal-tab" data-tab="personal">üë∑ Personal</button>
          <button type="button" class="modal-tab" data-tab="contactos">üìû Contactos</button>
          <button type="button" class="modal-tab" data-tab="normas">üìú Normas</button>
        </div>

        <div class="modal-body" style="max-height:60vh;overflow-y:auto;">
          <!-- Tab Datos -->
          <div class="tab-content active" id="tab-datos">
            <div class="form-group">
              <label class="form-label">Nombre del bien *</label>
              <input type="text" class="form-input" id="edit-nombre" required>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="form-group">
                <label class="form-label">Tipo</label>
                <select class="form-input" id="edit-tipo" onchange="toggleCamposRustico()">
                  <option value="inmueble">üè† Inmueble</option>
                  <option value="terreno">üå≥ Terreno / Finca r√∫stica</option>
                  <option value="vehiculo">üöó Veh√≠culo</option>
                  <option value="ajuar">ü™ë Ajuar</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Subtipo</label>
                <input type="text" class="form-input" id="edit-subtipo" placeholder="Ej: Segunda residencia">
              </div>
            </div>

            <!-- CAMPOS R√öSTICOS (solo visibles para tipo=terreno) -->
            <div id="campos-rustico" class="hidden">
              <div class="form-group" style="margin-top:16px;padding:16px;background:var(--capataz-muted);border-radius:var(--radius-md);border-left:4px solid var(--capataz);">
                <label class="form-label" style="color:var(--capataz);margin-bottom:12px;">üåæ Aprovechamiento general</label>
                <div style="display:flex;gap:20px;flex-wrap:wrap;">
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="aprov-agricola" style="width:18px;height:18px;accent-color:var(--capataz);">
                    <span>üåæ Agr√≠cola</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="aprov-forestal" style="width:18px;height:18px;accent-color:var(--capataz);">
                    <span>üå≤ Forestal</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="aprov-cinegetico" style="width:18px;height:18px;accent-color:var(--capataz);">
                    <span>ü¶å Cineg√©tico</span>
                  </label>
                </div>
              </div>

              <div class="form-group" style="margin-top:16px;">
                <label class="form-label" style="display:flex;align-items:center;justify-content:space-between;">
                  <span>üìã Fincas registrales</span>
                  <button type="button" class="btn btn-sm" style="background:var(--capataz);color:white;" onclick="addFincaRow()">+ A√±adir finca</button>
                </label>
                <div style="overflow-x:auto;margin-top:8px;">
                  <table id="tabla-fincas" style="width:100%;border-collapse:collapse;font-size:0.85rem;">
                    <thead>
                      <tr style="background:var(--cream-dark);">
                        <th style="padding:10px;text-align:left;font-weight:600;">Registro</th>
                        <th style="padding:10px;text-align:left;font-weight:600;">Nombre</th>
                        <th style="padding:10px;text-align:right;font-weight:600;">Superficie (ha)</th>
                        <th style="padding:10px;text-align:left;font-weight:600;">Uso</th>
                        <th style="padding:10px;width:40px;"></th>
                      </tr>
                    </thead>
                    <tbody id="tbody-fincas"></tbody>
                    <tfoot>
                      <tr style="background:var(--capataz-muted);font-weight:700;">
                        <td style="padding:10px;" colspan="2">TOTAL</td>
                        <td style="padding:10px;text-align:right;" id="total-superficie">0.00 ha</td>
                        <td style="padding:10px;" colspan="2"></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>
            <!-- FIN CAMPOS R√öSTICOS -->
            <div class="form-group">
              <label class="form-label">Ubicaci√≥n</label>
              <input type="text" class="form-input" id="edit-ubicacion" placeholder="Direcci√≥n o localizaci√≥n">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="form-group">
                <label class="form-label">Titularidad</label>
                <input type="text" class="form-input" id="edit-titularidad" placeholder="¬øDe qui√©n es?">
              </div>
              <div class="form-group">
                <label class="form-label">Origen</label>
                <input type="text" class="form-input" id="edit-origen" placeholder="Herencia, compra...">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Notas</label>
              <textarea class="form-input" id="edit-notas" rows="3" placeholder="Informaci√≥n adicional..."></textarea>
            </div>
          </div>

          <!-- Tab Habitaciones -->
          <div class="tab-content" id="tab-habitaciones">
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Define las habitaciones disponibles en este bien para las confirmaciones de finde</p>
            <div id="habitaciones-list" style="display:flex;flex-direction:column;gap:8px;"></div>
            <div style="display:flex;gap:8px;margin-top:12px;">
              <input type="text" class="form-input" id="nueva-habitacion-nombre" placeholder="Nombre de la habitaci√≥n" style="flex:1;">
              <button type="button" class="btn btn-secondary btn-sm" onclick="addHabitacionItem()">+ A√±adir</button>
            </div>
          </div>

          <!-- Tab Personal -->
          <div class="tab-content" id="tab-personal">
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Personal de servicio asociado a este bien (limpieza, jardinero, etc.)</p>
            <div id="personal-list" style="display:flex;flex-direction:column;gap:12px;"></div>
            <button type="button" class="btn btn-secondary btn-sm" style="margin-top:12px;width:100%;" onclick="addPersonalItem()">+ A√±adir personal</button>
          </div>

          <!-- Tab Contactos -->
          <div class="tab-content" id="tab-contactos">
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Contactos √∫tiles: vecinos, cerrajero, emergencias locales...</p>
            <div id="contactos-list" style="display:flex;flex-direction:column;gap:12px;"></div>
            <button type="button" class="btn btn-secondary btn-sm" style="margin-top:12px;width:100%;" onclick="addContactoItem()">+ A√±adir contacto</button>
          </div>

          <!-- Tab Normas -->
          <div class="tab-content" id="tab-normas">
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Normas de convivencia y uso del bien</p>
            <div class="form-group">
              <textarea class="form-input" id="edit-normas" rows="10" placeholder="Escribe aqu√≠ las normas de uso..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:12px;padding:16px 24px;border-top:1px solid var(--cream-dark);">
          <button type="button" class="btn btn-secondary" id="modal-editar-cancelar">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="modal-editar-guardar">üíæ Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Grupo Ajuar -->
  <div class="modal-overlay" id="modal-grupo-ajuar">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-grupo-ajuar-title">üì¶ Nuevo grupo</h3>
        <button class="modal-close" onclick="cerrarModalGrupoAjuar()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="grupo-ajuar-id">
        <div class="form-group">
          <label class="form-label">Nombre del grupo *</label>
          <input type="text" class="form-input" id="grupo-ajuar-nombre" placeholder="Ej: Muebles sal√≥n, Vajilla, Cuadros..." required>
        </div>
        <div class="form-group">
          <label class="form-label">Icono</label>
          <div style="display:flex;flex-wrap:wrap;gap:8px;" id="grupo-ajuar-iconos">
            <label class="icon-option"><input type="radio" name="grupo-icono" value="ü™ë" checked><span>ü™ë</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üõãÔ∏è"><span>üõãÔ∏è</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üçΩÔ∏è"><span>üçΩÔ∏è</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üñºÔ∏è"><span>üñºÔ∏è</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üìö"><span>üìö</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üè∫"><span>üè∫</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üíé"><span>üíé</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üé®"><span>üé®</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="ü™û"><span>ü™û</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üõèÔ∏è"><span>üõèÔ∏è</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üß∫"><span>üß∫</span></label>
            <label class="icon-option"><input type="radio" name="grupo-icono" value="üì¶"><span>üì¶</span></label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Descripci√≥n (opcional)</label>
          <input type="text" class="form-input" id="grupo-ajuar-desc" placeholder="Notas sobre este grupo...">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-grupo-ajuar" onclick="eliminarGrupoAjuar()">üóëÔ∏è</button>
        <div style="display:flex;gap:12px;">
          <button type="button" class="btn btn-secondary" onclick="cerrarModalGrupoAjuar()">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarGrupoAjuar()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Art√≠culo Ajuar -->
  <div class="modal-overlay" id="modal-articulo-ajuar">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-articulo-ajuar-title">ü™ë Nuevo art√≠culo</h3>
        <button class="modal-close" onclick="cerrarModalArticuloAjuar()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="articulo-ajuar-id">
        <input type="hidden" id="articulo-ajuar-grupo-id">
        <div class="form-group">
          <label class="form-label">Nombre del art√≠culo *</label>
          <input type="text" class="form-input" id="articulo-ajuar-nombre" placeholder="Ej: Mesa comedor roble, Sof√° chester..." required>
        </div>
        <div class="form-group">
          <label class="form-label">Descripci√≥n</label>
          <textarea class="form-input" id="articulo-ajuar-desc" rows="2" placeholder="Caracter√≠sticas, estado, historia..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Ubicaci√≥n / Lugar</label>
          <div class="ubicacion-select-wrapper">
            <select class="form-input" id="articulo-ajuar-ubicacion" style="flex:1;">
              <option value="">-- Selecciona lugar --</option>
              <!-- Se llenan din√°micamente -->
            </select>
            <button type="button" class="btn btn-secondary btn-sm" onclick="crearNuevoLugarAjuar()" title="Crear nuevo lugar" style="padding: 8px 12px;">
              + üìç
            </button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Marca</label>
          <input type="text" class="form-input" id="articulo-ajuar-marca" placeholder="Ej: IKEA, antig√ºedad, artesanal...">
        </div>
        <div class="form-group">
          <label class="form-label">Procedencia</label>
          <input type="text" class="form-input" id="articulo-ajuar-procedencia" placeholder="Ej: Herencia abuelos, comprado 2015, regalo boda...">
        </div>
        <div class="form-group">
          <label class="form-label">Foto (opcional)</label>
          <div class="foto-upload-area" id="articulo-foto-area" onclick="document.getElementById('articulo-ajuar-foto').click()">
            <span id="articulo-foto-preview">üì∑ Click para subir foto</span>
          </div>
          <input type="file" id="articulo-ajuar-foto" accept="image/*" style="display:none" onchange="previewArticuloFoto(this)">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-articulo-ajuar" onclick="eliminarArticuloAjuar()">üóëÔ∏è</button>
        <div style="display:flex;gap:12px;">
          <button type="button" class="btn btn-secondary" onclick="cerrarModalArticuloAjuar()">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarArticuloAjuar()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Gesti√≥n de Lugares Ajuar -->
  <div class="modal-overlay" id="modal-lugares-ajuar">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h3 class="modal-title">üìç Gesti√≥n de Lugares</h3>
        <button class="modal-close" onclick="cerrarModalLugaresAjuar()">√ó</button>
      </div>
      <div class="modal-body">
        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">
          Los lugares aparecen como opciones al crear art√≠culos del ajuar.
        </p>
        
        <!-- Input para a√±adir nuevo -->
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <input type="text" class="form-input" id="nuevo-lugar-nombre" placeholder="Nuevo lugar (ej: Sal√≥n, Cocina...)" style="flex:1;">
          <button class="btn btn-primary btn-sm" onclick="guardarNuevoLugar()">A√±adir</button>
        </div>
        
        <!-- Lista de lugares -->
        <div class="lugares-lista" id="lista-lugares-ajuar">
          <div class="empty-mini">Sin lugares definidos</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModalLugaresAjuar()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Cap√≠tulo de Normas (Externos) -->
  <div class="modal-overlay" id="modal-capitulo-norma">
    <div class="modal" style="max-width:650px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-capitulo-norma-titulo">‚ûï Nuevo cap√≠tulo</h3>
        <button class="modal-close" onclick="cerrarModalCapituloNorma()">√ó</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div class="form-group">
          <label class="form-label">T√≠tulo del cap√≠tulo *</label>
          <input type="text" class="form-input" id="norma-capitulo-titulo" placeholder="Ej: Acceso y seguridad">
        </div>
        <div class="form-group">
          <label class="form-label">Preceptos generales</label>
          <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px;">Preceptos que no requieren apartado (uno por l√≠nea)</p>
          <textarea class="form-input" id="norma-capitulo-preceptos" rows="3" placeholder="Norma general 1&#10;Norma general 2"></textarea>
        </div>
        <div class="form-group">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label class="form-label" style="margin: 0;">Apartados <span style="font-size:0.8rem;color:var(--text-muted);">(opcional)</span></label>
            <button type="button" class="btn btn-secondary btn-sm" onclick="agregarApartadoExternos()">‚ûï A√±adir apartado</button>
          </div>
          <div id="bien-apartados-container-externos"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm hidden" id="btn-eliminar-capitulo-norma" onclick="eliminarCapituloNorma()">üóëÔ∏è Eliminar</button>
        <div style="flex:1;"></div>
        <button type="button" class="btn btn-secondary" onclick="cerrarModalCapituloNorma()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="guardarCapituloNorma()">üíæ Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Copiar Plantilla de Normas -->
  <div class="modal-overlay" id="modal-copiar-plantilla">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h3 class="modal-title">üìã Copiar plantilla base</h3>
        <button class="modal-close" onclick="cerrarModalCopiarPlantilla()">√ó</button>
      </div>
      <div class="modal-body">
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
          Selecciona una plantilla base para copiar las normas a este bien. Podr√°s editarlas despu√©s.
        </p>
        <div class="form-group">
          <label class="form-label">Tipo de plantilla</label>
          <select class="form-input" id="select-tipo-plantilla">
            <option value="">-- Selecciona tipo --</option>
            <option value="casero">üè† Casero (Mayordomo)</option>
            <option value="hoster">üè® Hoster (Gerente)</option>
            <option value="guarda">üåæ Guarda (Capataz)</option>
          </select>
        </div>
        <div id="plantilla-preview" style="display:none;">
          <div class="form-label" style="margin-top: 12px;">Vista previa:</div>
          <div id="plantilla-preview-content" style="max-height: 200px; overflow-y: auto; background: var(--cream); padding: 12px; border-radius: var(--radius-sm); font-size: 0.85rem;"></div>
        </div>
        <div class="form-group" style="margin-top: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer;">
            <input type="checkbox" id="check-reemplazar-normas">
            <span>Reemplazar normas existentes</span>
          </label>
          <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
            Si no marcas esta opci√≥n, se a√±adir√°n a las existentes
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModalCopiarPlantilla()">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn-confirmar-copiar" onclick="confirmarCopiarPlantilla()" disabled>üìã Copiar</button>
      </div>
    </div>
  </div>

  <!-- Modal Cap√≠tulo de Normas para Miembros -->
  <div class="modal-overlay" id="modal-capitulo-norma-miembros">
    <div class="modal" style="max-width:650px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-capitulo-norma-miembros-titulo">‚ûï Nuevo cap√≠tulo</h3>
        <button class="modal-close" onclick="cerrarModalCapituloNormaMiembros()">√ó</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div class="form-group">
          <label class="form-label">T√≠tulo del cap√≠tulo *</label>
          <input type="text" class="form-input" id="norma-miembros-capitulo-titulo" placeholder="Ej: Normas de convivencia">
        </div>
        <div class="form-group">
          <label class="form-label">Preceptos generales</label>
          <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px;">Preceptos que no requieren apartado (uno por l√≠nea)</p>
          <textarea class="form-input" id="norma-miembros-capitulo-preceptos" rows="3" placeholder="Norma general 1&#10;Norma general 2"></textarea>
        </div>
        <div class="form-group">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label class="form-label" style="margin: 0;">Apartados <span style="font-size:0.8rem;color:var(--text-muted);">(opcional)</span></label>
            <button type="button" class="btn btn-secondary btn-sm" onclick="agregarApartadoMiembros()">‚ûï A√±adir apartado</button>
          </div>
          <div id="bien-apartados-container-miembros"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm hidden" id="btn-eliminar-capitulo-norma-miembros" onclick="eliminarCapituloNormaMiembros()">üóëÔ∏è Eliminar</button>
        <div style="flex:1;"></div>
        <button type="button" class="btn btn-secondary" onclick="cerrarModalCapituloNormaMiembros()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="guardarCapituloNormaMiembros()">üíæ Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Copiar Plantilla de Normas para Miembros -->
  <div class="modal-overlay" id="modal-copiar-plantilla-miembros">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h3 class="modal-title">üìã Copiar plantilla de normas de uso</h3>
        <button class="modal-close" onclick="cerrarModalCopiarPlantillaMiembros()">√ó</button>
      </div>
      <div class="modal-body">
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
          Selecciona la plantilla base seg√∫n el tipo de este bien. Podr√°s editarlas despu√©s.
        </p>
        <div id="plantilla-miembros-auto-tipo" style="padding: 12px; background: var(--cream); border-radius: var(--radius-sm); margin-bottom: 16px;">
          <div style="font-size: 0.8rem; color: var(--text-muted);">Add-on activo detectado:</div>
          <div style="font-weight: 700; margin-top: 4px;" id="plantilla-miembros-tipo-label">üè† Mayordomo</div>
        </div>
        <div id="plantilla-miembros-preview" style="display:none;">
          <div class="form-label">Vista previa:</div>
          <div id="plantilla-miembros-preview-content" style="max-height: 200px; overflow-y: auto; background: var(--cream); padding: 12px; border-radius: var(--radius-sm); font-size: 0.85rem;"></div>
        </div>
        <div id="plantilla-miembros-empty" style="text-align: center; padding: 20px; color: var(--text-muted);">
          <p>Cargando plantilla...</p>
        </div>
        <div class="form-group" style="margin-top: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer;">
            <input type="checkbox" id="check-reemplazar-normas-miembros">
            <span>Reemplazar normas existentes</span>
          </label>
          <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
            Si no marcas esta opci√≥n, se a√±adir√°n a las existentes
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModalCopiarPlantillaMiembros()">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn-confirmar-copiar-miembros" onclick="confirmarCopiarPlantillaMiembros()" disabled>üìã Copiar</button>
      </div>
    </div>
  </div>

  <style>
    /* Lugares Ajuar */
    .lugares-lista { display: flex; flex-direction: column; gap: 6px; max-height: 300px; overflow-y: auto; }
    .lugar-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-sm);
    }
    .lugar-item-nombre { font-weight: 600; font-size: 0.9rem; }
    .lugar-item-count { font-size: 0.75rem; color: var(--text-muted); }
    .lugar-item-del {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1rem;
      padding: 4px;
    }
    .lugar-item-del:hover { color: var(--error); }
  </style>

  <style>
    /* Modal tabs */
    .modal-tab {
      padding: 12px 16px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .modal-tab:hover { color: var(--text); }
    .modal-tab.active { color: var(--sage-dark); border-bottom-color: var(--sage); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Dynamic items */
    .dynamic-item {
      background: var(--cream);
      border-radius: var(--radius-md);
      padding: 12px;
      position: relative;
    }
    .dynamic-item-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    .dynamic-item-row:last-child { margin-bottom: 0; }
    .btn-remove-item {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.5;
    }
    .btn-remove-item:hover { opacity: 1; }
    
    /* Icon options */
    .icon-option { cursor: pointer; }
    .icon-option input { display: none; }
    .icon-option span { 
      display: inline-flex; 
      width: 40px; 
      height: 40px; 
      align-items: center; 
      justify-content: center; 
      font-size: 1.3rem; 
      background: var(--cream); 
      border: 2px solid var(--cream-dark); 
      border-radius: var(--radius-sm); 
      transition: all 0.2s;
    }
    .icon-option:hover span { border-color: var(--sage); }
    .icon-option input:checked + span { background: var(--sage-muted); border-color: var(--sage); }
    
    /* Foto upload area */
    .foto-upload-area {
      border: 2px dashed var(--cream-dark);
      border-radius: var(--radius-md);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
    }
    .foto-upload-area:hover { border-color: var(--sage); background: var(--sage-muted); }
    .foto-upload-area img { max-width: 100%; max-height: 150px; border-radius: var(--radius-sm); }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let familiaId = null;
    let nidosData = [];
    let reservasData = [];
    let inventarioData = [];
    let gastosData = [];
    let repartoData = {}; // {nidoId: porcentaje}
    let gastosPeriodo = 'mes';
    let gastosTab = 'registro';
    let inventarioFiltro = 'todos';
    let calendarioMes = new Date();
    let editingReservaId = null;
    let editingInventarioId = null;
    let editingGastoId = null;
    let caserosData = [];
    let editingCaseroId = null;
    let esAdminRama = false;
    let puedeEditar = false; // adminRama=todos, adminNido=su familia, usuario=ninguno
    
    // Normas de externos
    let normasExternosData = [];
    let editingCapituloNormaIdx = null;
    let plantillasNormasCache = {};
    
    // Normas de uso para miembros
    let normasMiembrosData = [];
    let editingCapituloNormaMiembrosIdx = null;
    let plantillasNormasMiembrosCache = {};

    const nidoColores = ['nido-1', 'nido-2', 'nido-3', 'nido-4'];
    const nidoColorMap = {};
    
    // Tipos de reserva - se cargan desde Firebase
    let tiposReserva = {};

    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    if (!bienId) window.location.href = 'bienes.html';

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await loadBien();
    });

    async function loadBien() {
      try {
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) { alert('Bien no encontrado'); window.location.href = 'bienes.html'; return; }

        bienData = { id: bienDoc.id, ...bienDoc.data() };
        familiaId = bienData.familiaId;
        
        // Verificar rol del usuario
        let esAdminNido = false;
        let userFamiliaId = null;
        try {
          const userDoc = await db.collection('usuarios').doc(currentUser.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            const rol = (userData.rol || '').toLowerCase();
            const cred = (userData.credenciales || '').toLowerCase();
            esAdminRama = rol === 'adminrama' || rol === 'adminsistema' || rol === 'admin-rama' || cred === 'admin-rama' || cred === 'adminrama';
            esAdminNido = userData.esAdminNido === true || rol === 'adminnido' || rol === 'admin-nido' || cred === 'admin-nido' || cred === 'adminnido';
            userFamiliaId = userData.familiaId || null;
            console.log('üîë Rol usuario:', userData.rol, '| Credenciales:', userData.credenciales, '| esAdminRama:', esAdminRama, '| esAdminNido:', esAdminNido, '| familiaId usuario:', userFamiliaId, '| familiaId bien:', familiaId);
          }
        } catch (e) { console.error('Error verificando rol:', e); }
        
        // Determinar si puede editar:
        // Admin-rama ‚Üí todos los bienes
        // Admin-nido ‚Üí bienes de su familia
        // Creador del bien ‚Üí como safety net
        // Usuario normal ‚Üí ninguno
        puedeEditar = esAdminRama || (esAdminNido && familiaId === userFamiliaId) || bienData.creadoPor === currentUser.uid;
        console.log('üîê puedeEditar:', puedeEditar, '| creadoPor:', bienData.creadoPor, '| uid:', currentUser.uid);
        
        await loadNidos();
        await loadTiposReserva();
        await loadReservas();
        await loadInventario();
        await loadGastos();
        await loadCaseros();
        await cargarNormasExternos();
        await cargarNormasMiembros();
        
        // Migrar m√≥dulos si existen datos antiguos
        await migrarModulos();
        
        renderBien();
        
        // Cargar cat√°logo si es tipo ajuar
        await cargarCatalogoAjuar();

        document.getElementById('page-loading').classList.add('hidden');
        document.getElementById('page-content').classList.remove('hidden');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar');
        window.location.href = 'bienes.html';
      }
    }

    async function loadNidos() {
      if (!familiaId) return;
      const snap = await db.collection('nidos').where('familiaId', '==', familiaId).get();
      nidosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Nidos se usan para gastos/reparto, no para reservas
    }

    // Migrar m√≥dulos existentes a√±adiendo los nuevos que falten
    async function migrarModulos() {
      const updateData = {};
      let needsUpdate = false;

      // M√≥dulos completos de Mayordomo
      const modulosMayordomoCompletos = {
        reservas: false, habitaciones: false, inventario: false, ajuar: false, menus: false,
        gastos: false, mantenimiento: false, limpieza: false, instalaciones: false, eventos: false,
        planLimpieza: false, prepararSemana: false, especiales: false, informes: false
      };

      // M√≥dulos completos de Gerente
      const modulosGerenteCompletos = {
        reservas: false, habitaciones: false, huespedes: false, tarifas: false,
        ventas: false, inventario: false, ajuar: false, contratos: false,
        servicios: false, menus: false
      };

      // M√≥dulos completos de Capataz
      const modulosCapatazCompletos = {
        parcelas: false, instalaciones: false, maquinaria: false,
        personal: false, labores: false, cosechas: false
      };

      // Verificar y migrar Mayordomo
      if (bienData.mayordomoModulos) {
        const existentes = bienData.mayordomoModulos;
        const merged = { ...modulosMayordomoCompletos };
        Object.keys(existentes).forEach(key => {
          if (key in merged) merged[key] = existentes[key];
        });
        // Solo actualizar si hay diferencia
        if (Object.keys(merged).length !== Object.keys(existentes).length ||
            !Object.keys(modulosMayordomoCompletos).every(k => k in existentes)) {
          updateData.mayordomoModulos = merged;
          needsUpdate = true;
        }
      }

      // Verificar y migrar Gerente
      if (bienData.gerenteModulos) {
        const existentes = bienData.gerenteModulos;
        const merged = { ...modulosGerenteCompletos };
        Object.keys(existentes).forEach(key => {
          if (key in merged) merged[key] = existentes[key];
        });
        if (Object.keys(merged).length !== Object.keys(existentes).length ||
            !Object.keys(modulosGerenteCompletos).every(k => k in existentes)) {
          updateData.gerenteModulos = merged;
          needsUpdate = true;
        }
      }

      // Verificar y migrar Capataz
      if (bienData.capatazModulos) {
        const existentes = bienData.capatazModulos;
        const merged = { ...modulosCapatazCompletos };
        Object.keys(existentes).forEach(key => {
          if (key in merged) merged[key] = existentes[key];
        });
        if (Object.keys(merged).length !== Object.keys(existentes).length ||
            !Object.keys(modulosCapatazCompletos).every(k => k in existentes)) {
          updateData.capatazModulos = merged;
          needsUpdate = true;
        }
      }

      // Guardar si hay cambios
      if (needsUpdate) {
        try {
          await db.collection('bienes').doc(bienId).update(updateData);
          // Actualizar datos locales
          if (updateData.mayordomoModulos) bienData.mayordomoModulos = updateData.mayordomoModulos;
          if (updateData.gerenteModulos) bienData.gerenteModulos = updateData.gerenteModulos;
          if (updateData.capatazModulos) bienData.capatazModulos = updateData.capatazModulos;
          console.log('M√≥dulos migrados correctamente');
        } catch (error) {
          console.error('Error migrando m√≥dulos:', error);
        }
      }
    }

    async function loadTiposReserva() {
      try {
        const snap = await db.collection('familias').doc(familiaId).collection('tiposReserva').orderBy('orden', 'asc').get();
        
        if (snap.empty) {
          // Tipos por defecto si no hay configurados
          tiposReserva = {
            // Estancias (Mayordomo)
            'estancia-familia': { nombre: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Estancia Familia', color: '#7A9E7E' },
            'estancia-huespedes': { nombre: 'üë• Estancia Hu√©spedes', color: '#5C7D5F' },
            'zafarrancho': { nombre: 'üßπ Zafarrancho', color: '#E67E22' },
            // Actividades (Capataz)
            'monteria': { nombre: 'ü¶å Monter√≠a', color: '#8B4513' },
            'recoleccion': { nombre: 'üåæ Recolecci√≥n', color: '#D4A017' },
            'actividad': { nombre: 'üéØ Actividad', color: '#3498DB' },
            // Otros
            'nodisponible': { nombre: 'üö´ No disponible', color: '#95A5A6' },
            'otros': { nombre: 'üìã Otros', color: '#9A9A9A' }
          };
        } else {
          tiposReserva = {};
          snap.docs.forEach(doc => {
            const data = doc.data();
            tiposReserva[doc.id] = {
              nombre: (data.emoji ? data.emoji + ' ' : '') + data.nombre,
              color: data.color
            };
          });
        }
        
        // Actualizar el select del modal
        const select = document.getElementById('reserva-tipo');
        select.innerHTML = '<option value="">Selecciona...</option>' +
          Object.entries(tiposReserva).map(([id, tipo]) => 
            `<option value="${id}">${tipo.nombre}</option>`
          ).join('');
          
        // Generar estilos din√°micos para los colores
        generarEstilosReservas();
      } catch (error) {
        console.error('Error cargando tipos de reserva:', error);
      }
    }

    function generarEstilosReservas() {
      // Eliminar estilos previos si existen
      const oldStyle = document.getElementById('dynamic-reserva-styles');
      if (oldStyle) oldStyle.remove();
      
      let css = '';
      Object.entries(tiposReserva).forEach(([id, tipo]) => {
        css += `.calendario-dia.tipo-${id} { background: ${tipo.color}; }\n`;
        css += `.reserva-item.tipo-${id} { border-left-color: ${tipo.color}; }\n`;
      });
      
      const style = document.createElement('style');
      style.id = 'dynamic-reserva-styles';
      style.textContent = css;
      document.head.appendChild(style);
    }

    async function loadReservas() {
      const snap = await db.collection('bienes').doc(bienId).collection('reservas').orderBy('fechaInicio', 'asc').get();
      reservasData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function loadInventario() {
      const snap = await db.collection('bienes').doc(bienId).collection('inventario').orderBy('nombre', 'asc').get();
      inventarioData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function loadGastos() {
      const snap = await db.collection('bienes').doc(bienId).collection('gastos').orderBy('fecha', 'desc').get();
      gastosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // Cargar configuraci√≥n de reparto
      const repartoDoc = await db.collection('bienes').doc(bienId).collection('config').doc('reparto').get();
      if (repartoDoc.exists) {
        repartoData = repartoDoc.data().porcentajes || {};
      } else {
        // Inicializar reparto equitativo
        repartoData = {};
        const porcentajeBase = nidosData.length > 0 ? Math.floor(100 / nidosData.length) : 100;
        nidosData.forEach((n, i) => {
          repartoData[n.id] = i === 0 ? 100 - (porcentajeBase * (nidosData.length - 1)) : porcentajeBase;
        });
      }
    }

    async function loadCaseros() {
      const snap = await db.collection('bienes').doc(bienId).collection('caseros').get();
      caserosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    function renderBien() {
      const tipoIcons = { inmueble: 'üè†', terreno: 'üå≥', vehiculo: 'üöó', ajuar: 'ü™ë' };
      const tipoLabels = { inmueble: 'Inmueble', terreno: 'Terreno', vehiculo: 'Veh√≠culo', ajuar: 'Ajuar' };
      const rolIcons = { limpieza: 'üßπ', jardinero: 'üå±', cuidador: 'üë®‚Äç‚öïÔ∏è', mantenimiento: 'üîß', otro: 'üìã' };
      const mascotaIcons = { perro: 'üêï', gato: 'üêà', ave: 'üê¶', otro: 'üêæ' };
      const catIcons = { mantenimiento: 'üîß', vecino: 'üèòÔ∏è', emergencia: 'üö®', suministros: 'üí°', otro: 'üìã' };
      const docIcons = { escritura: 'üìú', seguro: 'üõ°Ô∏è', suministro: 'üí°', empleado: 'üë∑', itv: 'üöó', comunidad: 'üè¢', otro: 'üìÑ' };

      // Hero image - se maneja en renderGestionCards()
      const tipoIcon = tipoIcons[bienData.tipo] || 'üè†';
      if (!bienData.fotos?.length) {
        document.getElementById('bien-hero-image').innerHTML = tipoIcon;
      } else {
        document.getElementById('bien-hero-image').innerHTML = `<img src="${bienData.fotos[0].url}">`;
      }
      
      document.getElementById('bien-tipo').textContent = tipoLabels[bienData.tipo] || bienData.tipo;
      document.getElementById('bien-nombre').textContent = bienData.nombre;
      document.getElementById('bien-ubicacion').textContent = bienData.ubicacion || '-';
      document.getElementById('bien-titularidad').textContent = bienData.titularidad || '-';
      document.getElementById('bien-origen').textContent = bienData.origen || '-';

      // Sidebar counts
      // Contadores de secciones

      const personal = bienData.personal || [];
      document.getElementById('count-personal').textContent = personal.length;
      if (personal.length > 0) {
        document.getElementById('lista-personal').innerHTML = personal.map(p => `
          <div class="info-item">
            <span class="info-item-icon">${rolIcons[p.rol] || 'üë∑'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${p.nombre}</div>
              <div class="info-item-subtitle">${p.tipo === 'residente' ? 'Residente' : 'Puntual'}${p.telefono ? ' ¬∑ ' + p.telefono : ''}</div>
            </div>
            ${p.telefono ? `<a href="tel:${p.telefono}" class="info-item-action">üìû</a>` : ''}
          </div>
        `).join('');
      }

      const mascotas = bienData.mascotas || [];
      document.getElementById('count-mascotas').textContent = mascotas.length;
      if (mascotas.length > 0) {
        document.getElementById('lista-mascotas').innerHTML = mascotas.map(m => `
          <div class="info-item">
            <span class="info-item-icon">${mascotaIcons[m.tipo] || 'üêæ'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${m.nombre}</div>
              <div class="info-item-subtitle">${m.raza || m.tipo}</div>
            </div>
          </div>
        `).join('');
      }

      const habitaciones = bienData.habitaciones || [];
      document.getElementById('count-habitaciones').textContent = habitaciones.length;
      if (habitaciones.length > 0) {
        document.getElementById('lista-habitaciones').innerHTML = habitaciones.map(h => `
          <div class="info-item">
            <span class="info-item-icon">üõèÔ∏è</span>
            <div class="info-item-content">
              <div class="info-item-title">${h.nombre || h}</div>
            </div>
          </div>
        `).join('');
      } else {
        document.getElementById('lista-habitaciones').innerHTML = '<div class="empty-mini">Sin habitaciones definidas</div>';
      }

      const contactos = bienData.contactos || [];
      document.getElementById('count-contactos').textContent = contactos.length;
      if (contactos.length > 0) {
        document.getElementById('lista-contactos').innerHTML = contactos.map(c => `
          <div class="info-item">
            <span class="info-item-icon">${catIcons[c.categoria] || 'üìû'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${c.nombre}</div>
              <div class="info-item-subtitle">${c.telefono || ''}</div>
            </div>
            ${c.telefono ? `<a href="tel:${c.telefono}" class="info-item-action">üìû</a>` : ''}
          </div>
        `).join('');
      }

      const documentos = bienData.documentos || [];
      document.getElementById('count-documentos').textContent = documentos.length;
      if (documentos.length > 0) {
        document.getElementById('lista-documentos').innerHTML = documentos.map(d => `
          <div class="info-item">
            <span class="info-item-icon">${docIcons[d.tipo] || 'üìÑ'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${d.nombre}</div>
              <div class="info-item-subtitle">${d.fechaVencimiento ? 'Vence: ' + formatDate(d.fechaVencimiento) : ''}</div>
            </div>
          </div>
        `).join('');
      }

      const normasTextoEl = document.getElementById('normas-texto');
      if (bienData.normasConvivencia && normasTextoEl) normasTextoEl.textContent = bienData.normasConvivencia;

      // Caseros
      document.getElementById('count-caseros').textContent = caserosData.length;
      renderCaserosList();

      // Renderizar estado de gesti√≥n (Mayordomo/Gerente)
      renderGestionCards();
      
      // Control de permisos: ocultar elementos de edici√≥n si no puede editar
      aplicarPermisosEdicion();
    }
    
    function aplicarPermisosEdicion() {
      // Bot√≥n principal de editar bien
      const btnEditar = document.getElementById('btn-editar');
      if (btnEditar) {
        btnEditar.style.display = puedeEditar ? '' : 'none';
      }
      
      // Botones de a√±adir en secciones de normas
      const botonesNormas = document.querySelectorAll('.normas-externos-actions');
      botonesNormas.forEach(el => {
        el.style.display = puedeEditar ? '' : 'none';
      });
      
      // Bot√≥n de a√±adir casero
      const btnAddCasero = document.querySelector('button[onclick="abrirModalCasero()"]');
      if (btnAddCasero) {
        btnAddCasero.style.display = puedeEditar ? '' : 'none';
      }
      
      // Bot√≥n de a√±adir hoster
      const btnAddHoster = document.querySelector('button[onclick="abrirModalHoster()"]');
      if (btnAddHoster) {
        btnAddHoster.style.display = puedeEditar ? '' : 'none';
      }
      
      // Botones de grupos y art√≠culos de ajuar
      const btnAddGrupo = document.querySelector('button[onclick="abrirModalGrupoAjuar()"]');
      const btnAddLugares = document.querySelector('button[onclick="abrirModalLugaresAjuar()"]');
      if (btnAddGrupo) btnAddGrupo.style.display = puedeEditar ? '' : 'none';
      if (btnAddLugares) btnAddLugares.style.display = puedeEditar ? '' : 'none';
      
      // Botones de activar add-ons (Mayordomo, Gerente, Capataz)
      const btnsActivar = document.querySelectorAll('[id^="btn-mayordomo"], [id^="btn-gerente"], [id^="btn-capataz"]');
      btnsActivar.forEach(btn => {
        if (btn && btn.id.includes('btn-') && !btn.id.includes('abrir')) {
          btn.style.display = puedeEditar ? '' : 'none';
        }
      });
    }

    function renderGestionCards() {
      const cardMayordomo = document.getElementById('card-mayordomo');
      const cardGerente = document.getElementById('card-gerente');
      const cardCapataz = document.getElementById('card-capataz');
      const statusMayordomo = document.getElementById('status-mayordomo');
      const statusGerente = document.getElementById('status-gerente');
      const statusCapataz = document.getElementById('status-capataz');
      const btnMayordomo = document.getElementById('btn-mayordomo');
      const btnGerente = document.getElementById('btn-gerente');
      const btnCapataz = document.getElementById('btn-capataz');
      const gestionModulos = document.getElementById('gestion-modulos');
      const gestionTitulo = document.getElementById('gestion-titulo');
      const botonesContainer = document.getElementById('modulos-botones');
      const sectionCaseros = document.getElementById('section-caseros');
      const sectionHosters = document.getElementById('section-hosters');
      const sectionNormasExternos = document.getElementById('section-normas');

      const mayordomoActivo = bienData.mayordomoActivo;
      const gerenteActivo = bienData.gerenteActivo;
      const capatazActivo = bienData.capatazActivo;

      // Reset todas las cards
      [cardMayordomo, cardGerente, cardCapataz].forEach(card => {
        if (card) {
          card.classList.remove('active');
          card.classList.add('disabled');
        }
      });

      // Actualizar cards visuales seg√∫n gesti√≥n activa
      if (mayordomoActivo) {
        cardMayordomo.classList.add('active');
        cardMayordomo.classList.remove('disabled');
        statusMayordomo.textContent = 'Activo';
        statusGerente.textContent = 'Inactivo';
        statusCapataz.textContent = 'Inactivo';
        btnMayordomo.textContent = '‚öôÔ∏è Configurar';
        btnMayordomo.onclick = () => abrirConfigModulos();
        btnGerente.textContent = 'Activar';
        btnCapataz.textContent = 'Activar';
        gestionModulos.classList.remove('hidden');
        gestionTitulo.textContent = 'üé© M√≥dulos Mayordomo';
        gestionTitulo.className = 'gestion-modulos-title mayordomo';
        renderModulosBotones('mayordomo');
        if (sectionCaseros) sectionCaseros.classList.remove('hidden');
        if (sectionHosters) sectionHosters.classList.add('hidden');
        if (sectionNormasExternos) {
          sectionNormasExternos.classList.remove('hidden');
          document.getElementById('titulo-normas-externos').textContent = 'Normas para Caseros';
        }
      } else if (gerenteActivo) {
        cardGerente.classList.add('active');
        cardGerente.classList.remove('disabled');
        statusGerente.textContent = 'Activo';
        statusMayordomo.textContent = 'Inactivo';
        statusCapataz.textContent = 'Inactivo';
        btnGerente.textContent = '‚öôÔ∏è Configurar';
        btnGerente.onclick = () => abrirConfigModulos();
        btnMayordomo.textContent = 'Activar';
        btnCapataz.textContent = 'Activar';
        gestionModulos.classList.remove('hidden');
        gestionTitulo.textContent = 'üíº M√≥dulos Gerente';
        gestionTitulo.className = 'gestion-modulos-title gerente';
        renderModulosBotones('gerente');
        if (sectionHosters) sectionHosters.classList.remove('hidden');
        if (sectionCaseros) sectionCaseros.classList.add('hidden');
        if (sectionNormasExternos) {
          sectionNormasExternos.classList.remove('hidden');
          document.getElementById('titulo-normas-externos').textContent = 'Normas para Hosters';
        }
        cargarHosters();
      } else if (capatazActivo) {
        cardCapataz.classList.add('active');
        cardCapataz.classList.remove('disabled');
        statusCapataz.textContent = 'Activo';
        statusMayordomo.textContent = 'Inactivo';
        statusGerente.textContent = 'Inactivo';
        btnCapataz.textContent = '‚öôÔ∏è Configurar';
        btnCapataz.onclick = () => abrirConfigModulos();
        btnMayordomo.textContent = 'Activar';
        btnGerente.textContent = 'Activar';
        gestionModulos.classList.remove('hidden');
        gestionTitulo.textContent = 'üöú M√≥dulos Capataz';
        gestionTitulo.className = 'gestion-modulos-title capataz';
        renderModulosBotones('capataz');
        if (sectionCaseros) sectionCaseros.classList.remove('hidden');
        if (sectionHosters) sectionHosters.classList.add('hidden');
        if (sectionNormasExternos) {
          sectionNormasExternos.classList.remove('hidden');
          document.getElementById('titulo-normas-externos').textContent = 'Normas para Guardas';
        }
      } else {
        // Ninguno activo - quitar disabled de todas para que se puedan activar
        [cardMayordomo, cardGerente, cardCapataz].forEach(card => {
          if (card) card.classList.remove('active', 'disabled');
        });
        statusMayordomo.textContent = 'Inactivo';
        statusGerente.textContent = 'Inactivo';
        statusCapataz.textContent = 'Inactivo';
        btnMayordomo.textContent = 'Activar';
        btnGerente.textContent = 'Activar';
        btnCapataz.textContent = 'Activar';
        gestionModulos.classList.add('hidden');
        if (sectionCaseros) sectionCaseros.classList.add('hidden');
        if (sectionHosters) sectionHosters.classList.add('hidden');
        if (sectionNormasExternos) sectionNormasExternos.classList.add('hidden');
      }

      // Actualizar badge del hero
      const heroImage = document.getElementById('bien-hero-image');
      let badge = '';
      if (mayordomoActivo) badge = '<span class="bien-hero-badge">üé© Mayordomo</span>';
      else if (gerenteActivo) badge = '<span class="bien-hero-badge gerente">üíº Gerente</span>';
      else if (capatazActivo) badge = '<span class="bien-hero-badge capataz">üöú Capataz</span>';
      
      if (bienData.fotos?.length > 0) {
        heroImage.innerHTML = `<img src="${bienData.fotos[0].url}">${badge}`;
      } else {
        const iconos = { inmueble: 'üè†', vehiculo: 'üöó', embarcacion: '‚õµ', otro: 'üì¶' };
        heroImage.innerHTML = (iconos[bienData.tipo] || 'üè†') + badge;
      }
    }

    function renderModulosBotones(tipo) {
      const botonesContainer = document.getElementById('modulos-botones');
      let botonesHtml = '';

      if (tipo === 'mayordomo') {
        const m = bienData.mayordomoModulos || {};
        const modulosConfig = [
          { key: 'reservas', icon: 'üìÖ', label: 'Estancias', url: `reservas-mayordomo.html?id=${bienId}&origen=bien` },
          { key: 'habitaciones', icon: 'üè†', label: 'Zonas', url: `zonas.html?id=${bienId}&origen=mayordomo` },
          { key: 'inventario', icon: 'üì¶', label: 'Inventario', url: `inventario.html?id=${bienId}&origen=bien` },
          { key: 'ajuar', icon: 'ü™ë', label: 'Ajuar', url: `ajuar.html?id=${bienId}&origen=bien` },
          { key: 'menus', icon: 'üçΩÔ∏è', label: 'Men√∫s', url: `menus-nidos.html?id=${bienId}&origen=bien` },
          { key: 'gastos', icon: 'üí∞', label: 'Gastos', url: `gastos.html?id=${bienId}&origen=bien` },
          { key: 'mantenimiento', icon: 'üîß', label: 'Mantenimiento', url: `mantenimiento.html?id=${bienId}&origen=bien` },
          { key: 'limpieza', icon: 'üßπ', label: 'Limpieza', url: `limpieza.html?id=${bienId}&origen=bien` },
          { key: 'instalaciones', icon: '‚öôÔ∏è', label: 'Instalaciones', url: `instalaciones.html?id=${bienId}&origen=bien` },
          { key: 'eventos', icon: 'üéâ', label: 'Eventos', url: `eventos.html?id=${bienId}&origen=bien` },
          { key: 'especiales', icon: 'üõçÔ∏è', label: 'Especiales', url: `config-especiales.html?id=${bienId}&origen=bien` },
          { key: 'informes', icon: 'üìã', label: 'Informes', url: `informes.html?id=${bienId}&origen=bien` }
        ];
        
        modulosConfig.forEach(mod => {
          if (m[mod.key]) {
            botonesHtml += `<a href="${mod.url}" class="btn-modulo-activo">${mod.icon} ${mod.label}</a>`;
          }
        });
      } else if (tipo === 'gerente') {
        const g = bienData.gerenteModulos || {};
        const modulosConfig = [
          { key: 'reservas', icon: 'üìÖ', label: 'Reservas', url: `reservas.html?id=${bienId}&origen=bien` },
          { key: 'habitaciones', icon: 'üè†', label: 'Zonas', url: `zonas.html?id=${bienId}&origen=gerente` },
          { key: 'huespedes', icon: 'üë•', label: 'Hu√©spedes', url: `huespedes.html?id=${bienId}` },
          { key: 'tarifas', icon: 'üí∂', label: 'Tarifas', url: `tarifas.html?id=${bienId}` },
          { key: 'ventas', icon: 'üí∞', label: 'Ventas', url: `ventas.html?id=${bienId}` },
          { key: 'inventario', icon: 'üì¶', label: 'Inventario', url: `inventario.html?id=${bienId}&origen=bien` },
          { key: 'ajuar', icon: 'ü™ë', label: 'Ajuar', url: `ajuar.html?id=${bienId}&origen=bien` },
          { key: 'contratos', icon: 'üìù', label: 'Contratos', url: `contratos.html?id=${bienId}` },
          { key: 'servicios', icon: 'üöê', label: 'Otros Servicios', url: `servicios-externos.html?id=${bienId}` },
          { key: 'menus', icon: 'üçΩÔ∏è', label: 'Men√∫s', url: `menus-nidos.html?id=${bienId}&origen=bien` }
        ];
        
        modulosConfig.forEach(mod => {
          if (g[mod.key]) {
            botonesHtml += `<a href="${mod.url}" class="btn-modulo-activo gerente">${mod.icon} ${mod.label}</a>`;
          }
        });
      } else if (tipo === 'capataz') {
        const c = bienData.capatazModulos || {};
        const modulosConfig = [
          { key: 'parcelas', icon: 'üó∫Ô∏è', label: 'Parcelas', url: `parcelas.html?bien=${bienId}` },
          { key: 'instalaciones', icon: 'üè≠', label: 'Instalaciones', url: `instalaciones.html?bien=${bienId}` },
          { key: 'maquinaria', icon: 'üöú', label: 'Maquinaria', url: `maquinaria.html?bien=${bienId}` },
          { key: 'personal', icon: 'üë∑', label: 'Personal', url: `personal-finca.html?bien=${bienId}` },
          { key: 'labores', icon: 'üìã', label: 'Labores', url: `labores.html?bien=${bienId}` },
          { key: 'cosechas', icon: 'üåª', label: 'Cosechas', url: `cosechas.html?bien=${bienId}` }
        ];
        
        modulosConfig.forEach(mod => {
          if (c[mod.key]) {
            botonesHtml += `<a href="${mod.url}" class="btn-modulo-activo capataz">${mod.icon} ${mod.label}</a>`;
          }
        });
      }

      if (!botonesHtml) {
        botonesHtml = '<div style="text-align:center;padding:20px;"><div style="font-size:2rem;margin-bottom:8px;">üì¶</div><div style="color:var(--text-muted);font-size:0.9rem;">Sin m√≥dulos activos</div><div style="color:var(--text-muted);font-size:0.8rem;">Pulsa "‚öôÔ∏è Configurar m√≥dulos" para activar los que necesites</div></div>';
      }

      botonesContainer.innerHTML = botonesHtml;
    }

    async function toggleGestion(tipo) {
      // Si ya est√° activo, no hacer nada (usar bot√≥n configurar)
      if (tipo === 'mayordomo' && bienData.mayordomoActivo) return;
      if (tipo === 'gerente' && bienData.gerenteActivo) return;
      if (tipo === 'capataz' && bienData.capatazActivo) return;

      // Si hay otra gesti√≥n activa, preguntar
      const gestionActiva = bienData.mayordomoActivo ? 'Mayordomo' : 
                            bienData.gerenteActivo ? 'Gerente' : 
                            bienData.capatazActivo ? 'Capataz' : null;
      
      if (gestionActiva) {
        const tipoNombre = tipo === 'mayordomo' ? 'Mayordomo' : tipo === 'gerente' ? 'Gerente' : 'Capataz';
        if (!confirm(`¬øCambiar de ${gestionActiva} a ${tipoNombre}? Los datos de ${gestionActiva} se conservar√°n.`)) return;
      }

      // Activar la gesti√≥n seleccionada
      if (tipo === 'mayordomo') {
        await activarMayordomo();
      } else if (tipo === 'gerente') {
        await activarGerente();
      } else if (tipo === 'capataz') {
        await activarCapataz();
      }
    }

    async function desactivarGestion() {
      const tipoActivo = bienData.mayordomoActivo ? 'Mayordomo' : 
                         bienData.gerenteActivo ? 'Gerente' : 
                         bienData.capatazActivo ? 'Capataz' : null;
      if (!tipoActivo) return;

      if (!confirm(`¬øDesactivar ${tipoActivo}? Los datos se conservar√°n y podr√°s reactivarlo cuando quieras.`)) return;

      try {
        await db.collection('bienes').doc(bienId).update({
          mayordomoActivo: false,
          gerenteActivo: false,
          capatazActivo: false
        });

        bienData.mayordomoActivo = false;
        bienData.gerenteActivo = false;
        bienData.capatazActivo = false;
        renderGestionCards();
        alert('‚úÖ Gesti√≥n desactivada. Los datos se han conservado.');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al desactivar');
      }
    }

    async function activarMayordomo() {
      try {
        const updateData = {
          mayordomoActivo: true,
          gerenteActivo: false,
          capatazActivo: false
        };
        
        if (!bienData.mayordomoModulos) {
          updateData.mayordomoModulos = {
            reservas: false,
            habitaciones: false,
            inventario: false,
            ajuar: false,
            menus: false,
            gastos: false,
            mantenimiento: false,
            limpieza: false,
            eventos: false
          };
        }

        await db.collection('bienes').doc(bienId).update(updateData);
        
        bienData.mayordomoActivo = true;
        bienData.gerenteActivo = false;
        bienData.capatazActivo = false;
        if (!bienData.mayordomoModulos) {
          bienData.mayordomoModulos = updateData.mayordomoModulos;
        }
        
        // Mostrar Caseros, ocultar Hosters
        document.getElementById('section-caseros')?.classList.remove('hidden');
        document.getElementById('section-hosters')?.classList.add('hidden');
        
        renderGestionCards();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al activar Mayordomo');
      }
    }

    async function activarGerente() {
      try {
        const updateData = {
          gerenteActivo: true,
          mayordomoActivo: false,
          capatazActivo: false
        };
        
        if (!bienData.gerenteModulos) {
          updateData.gerenteModulos = {
            reservas: false,
            habitaciones: false,
            huespedes: false,
            tarifas: false,
            ventas: false,
            inventario: false,
            ajuar: false,
            contratos: false,
            servicios: false,
            menus: false
          };
        }

        await db.collection('bienes').doc(bienId).update(updateData);
        
        bienData.gerenteActivo = true;
        bienData.mayordomoActivo = false;
        bienData.capatazActivo = false;
        if (!bienData.gerenteModulos) {
          bienData.gerenteModulos = updateData.gerenteModulos;
        }
        
        // Mostrar Hosters, ocultar Caseros
        document.getElementById('section-hosters')?.classList.remove('hidden');
        document.getElementById('section-caseros')?.classList.add('hidden');
        
        renderGestionCards();
        cargarHosters();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al activar Gerente');
      }
    }

    async function activarCapataz() {
      try {
        const updateData = {
          capatazActivo: true,
          mayordomoActivo: false,
          gerenteActivo: false
        };
        
        if (!bienData.capatazModulos) {
          updateData.capatazModulos = {
            parcelas: true,
            instalaciones: true,
            maquinaria: true,
            personal: true,
            labores: true,
            cosechas: true
          };
        }

        await db.collection('bienes').doc(bienId).update(updateData);
        
        bienData.capatazActivo = true;
        bienData.mayordomoActivo = false;
        bienData.gerenteActivo = false;
        if (!bienData.capatazModulos) {
          bienData.capatazModulos = updateData.capatazModulos;
        }
        
        // Mostrar Caseros (trabajadores de finca), ocultar Hosters
        document.getElementById('section-caseros')?.classList.remove('hidden');
        document.getElementById('section-hosters')?.classList.add('hidden');
        
        renderGestionCards();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al activar Capataz');
      }
    }

    // Funci√≥n legacy para compatibilidad
    function renderMayordomoModulos() {
      renderGestionCards();
    }

    // ========== CONFIGURACI√ìN DE M√ìDULOS ==========
    const modulosDescripcionesMayordomo = {
      reservas: { icon: 'üìÖ', nombre: 'Estancias', desc: 'Gestiona qui√©n usa el inmueble y cu√°ndo. Calendario compartido y turnos familiares.' },
      habitaciones: { icon: 'üè†', nombre: 'Zonas', desc: 'Define las zonas disponibles para las confirmaciones de fin de semana.' },
      inventario: { icon: 'üì¶', nombre: 'Inventario', desc: 'Control de productos consumibles (limpieza, despensa). Alertas de stock bajo y lista de compra.' },
      ajuar: { icon: 'ü™ë', nombre: 'Ajuar', desc: 'Cat√°logo de muebles y enseres. Registra ubicaci√≥n, marca, procedencia y fotos.' },
      menus: { icon: 'üçΩÔ∏è', nombre: 'Men√∫s', desc: 'Planificaci√≥n de comidas. Organiza desayunos, comidas y cenas para cada estancia.' },
      gastos: { icon: 'üí∞', nombre: 'Gastos', desc: 'Registro de gastos del inmueble. Reparto entre nidos y control de pagos.' },
      mantenimiento: { icon: 'üîß', nombre: 'Mantenimiento', desc: 'Tareas programadas y aver√≠as. Historial de reparaciones y recordatorios.' },
      limpieza: { icon: 'üßπ', nombre: 'Limpieza', desc: 'Checklists por estancia y turnos. Control de limpieza al entrar y salir.' },
      instalaciones: { icon: '‚öôÔ∏è', nombre: 'Instalaciones', desc: 'Documentaci√≥n t√©cnica de sistemas e instalaciones. Electricidad, fontaner√≠a, calefacci√≥n...' },
      eventos: { icon: 'üéâ', nombre: 'Eventos', desc: 'Celebraciones y reuniones familiares. Coordina cumplea√±os, fiestas y encuentros.' },
      especiales: { icon: 'üõçÔ∏è', nombre: 'Especiales', desc: 'Cat√°logo de productos especiales y delicatessen. Extras bajo petici√≥n.' },
      informes: { icon: 'üìã', nombre: 'Informes', desc: 'Plantillas de checklist para estancias. Configura y consulta informes de entrada y salida.' }
    };

    const modulosDescripcionesGerente = {
      reservas: { icon: 'üìÖ', nombre: 'Reservas', desc: 'Gesti√≥n profesional de reservas. Check-in, check-out y confirmaciones.' },
      habitaciones: { icon: 'üè†', nombre: 'Zonas', desc: 'Define zonas y espacios disponibles. Capacidad, servicios y configuraci√≥n.' },
      huespedes: { icon: 'üë•', nombre: 'Hu√©spedes', desc: 'Registro de hu√©spedes. Titulares, acompa√±antes e invitados con historial.' },
      tarifas: { icon: 'üí∂', nombre: 'Tarifas', desc: 'Precios por temporada y tipo de habitaci√≥n. Descuentos y ofertas especiales.' },
      ventas: { icon: 'üí∞', nombre: 'Ventas', desc: 'Ingresos por estancias, hospitalidad, actividades y servicios adicionales.' },
      inventario: { icon: 'üì¶', nombre: 'Inventario', desc: 'Control de productos consumibles. Amenities, limpieza y suministros.' },
      ajuar: { icon: 'ü™ë', nombre: 'Ajuar', desc: 'Cat√°logo de mobiliario y equipamiento. Control de estado y ubicaci√≥n.' },
      contratos: { icon: 'üìù', nombre: 'Contratos', desc: 'Gesti√≥n de contratos de alquiler. Documentos y condiciones legales.' },
      servicios: { icon: 'üöê', nombre: 'Otros Servicios', desc: 'Servicios externos: transfers, excursiones, catering, gu√≠as tur√≠sticos.' },
      menus: { icon: 'üçΩÔ∏è', nombre: 'Men√∫s', desc: 'Planificaci√≥n de hospitalidad. Desayunos, comidas, cenas y bar.' }
    };

    const modulosDescripcionesCapataz = {
      parcelas: { icon: 'üó∫Ô∏è', nombre: 'Parcelas', desc: 'Gesti√≥n de parcelas y divisiones de terreno. Superficie, cultivos y linderos.' },
      instalaciones: { icon: 'üè≠', nombre: 'Instalaciones', desc: 'Naves, almacenes, pozos y otras infraestructuras de la finca.' },
      maquinaria: { icon: 'üöú', nombre: 'Maquinaria', desc: 'Inventario de tractores, aperos y equipamiento agr√≠cola.' },
      personal: { icon: 'üë∑', nombre: 'Personal', desc: 'Trabajadores de la finca. Jornales, tareas asignadas y contactos.' },
      labores: { icon: 'üìã', nombre: 'Labores', desc: 'Planificaci√≥n de trabajos agr√≠colas. Siembra, tratamientos, riegos.' },
      cosechas: { icon: 'üåª', nombre: 'Cosechas', desc: 'Registro de producciones. Kilos, calidades y destino de cada cosecha.' }
    };

    function abrirConfigModulos() {
      const grid = document.getElementById('modulos-config-grid');
      const header = document.getElementById('modal-config-header');
      let html = '';
      let modulos = {};
      let descripciones = {};
      let tipoGestion = '';

      if (bienData.mayordomoActivo) {
        modulos = bienData.mayordomoModulos || {};
        descripciones = modulosDescripcionesMayordomo;
        tipoGestion = 'mayordomo';
        header.style.background = 'var(--mayordomo)';
      } else if (bienData.gerenteActivo) {
        modulos = bienData.gerenteModulos || {};
        descripciones = modulosDescripcionesGerente;
        tipoGestion = 'gerente';
        header.style.background = '#4A5568';
      } else if (bienData.capatazActivo) {
        modulos = bienData.capatazModulos || {};
        descripciones = modulosDescripcionesCapataz;
        tipoGestion = 'capataz';
        header.style.background = 'var(--capataz)';
      } else {
        return;
      }

      Object.keys(descripciones).forEach(key => {
        const mod = descripciones[key];
        const activo = modulos[key] === true;
        html += `
          <div class="modulo-config-card ${activo ? 'activo' : ''} ${tipoGestion}" onclick="toggleModuloConfig('${key}', '${tipoGestion}')">
            <div class="modulo-config-check">‚úì</div>
            <div class="modulo-config-icon">${mod.icon}</div>
            <div class="modulo-config-nombre">${mod.nombre}</div>
            <div class="modulo-config-desc">${mod.desc}</div>
          </div>
        `;
      });

      grid.innerHTML = html;
      document.getElementById('modal-config-modulos').classList.add('active');
    }

    function cerrarConfigModulos() {
      document.getElementById('modal-config-modulos').classList.remove('active');
    }

    async function toggleModuloConfig(modulo, tipo) {
      try {
        let modulos, field;
        if (tipo === 'mayordomo') {
          modulos = bienData.mayordomoModulos || {};
          field = 'mayordomoModulos';
        } else if (tipo === 'gerente') {
          modulos = bienData.gerenteModulos || {};
          field = 'gerenteModulos';
        } else if (tipo === 'capataz') {
          modulos = bienData.capatazModulos || {};
          field = 'capatazModulos';
        } else {
          return;
        }

        const nuevoEstado = !modulos[modulo];
        const updateData = {};
        updateData[`${field}.${modulo}`] = nuevoEstado;

        await db.collection('bienes').doc(bienId).update(updateData);

        // Actualizar datos locales
        if (!bienData[field]) bienData[field] = {};
        bienData[field][modulo] = nuevoEstado;

        // Actualizar UI
        abrirConfigModulos();
        renderModulosBotones(tipo);
      } catch (error) {
        console.error('Error al cambiar m√≥dulo:', error);
        alert('Error al actualizar');
      }
    }

    async function toggleModulo(modulo, activo) {
      try {
        const updateData = {};
        updateData[`mayordomoModulos.${modulo}`] = activo;
        
        await db.collection('bienes').doc(bienId).update(updateData);
        
        // Actualizar datos locales
        if (!bienData.mayordomoModulos) bienData.mayordomoModulos = {};
        bienData.mayordomoModulos[modulo] = activo;
        
        renderMayordomoModulos();
      } catch (error) {
        console.error('Error al cambiar m√≥dulo:', error);
        alert('Error al actualizar');
      }
    }

    // Cerrar modal config al click fuera
    document.getElementById('modal-config-modulos').addEventListener('click', (e) => {
      if (e.target.id === 'modal-config-modulos') cerrarConfigModulos();
    });

    function irAMayordomo() {
      window.location.href = `mayordomo.html?bien=${bienId}`;
    }

    function irAInventario() {
      window.location.href = `mayordomo.html?bien=${bienId}`;
    }

    // CALENDARIO
    function renderCalendario() {
      const grid = document.getElementById('calendario-grid');
      const label = document.getElementById('calendario-mes-label');
      const year = calendarioMes.getFullYear();
      const month = calendarioMes.getMonth();
      
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      label.textContent = `${meses[month]} ${year}`;
      
      const primerDia = new Date(year, month, 1);
      const ultimoDia = new Date(year, month + 1, 0);
      let startDay = primerDia.getDay(); if (startDay === 0) startDay = 7; startDay--;
      const diasMes = ultimoDia.getDate();
      const hoy = new Date();
      
      let html = '';
      ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(d => { html += `<div class="calendario-dia-header">${d}</div>`; });
      
      const mesAnterior = new Date(year, month, 0);
      for (let i = startDay - 1; i >= 0; i--) {
        html += `<div class="calendario-dia otro-mes">${mesAnterior.getDate() - i}</div>`;
      }
      
      for (let dia = 1; dia <= diasMes; dia++) {
        const fecha = new Date(year, month, dia);
        const esHoy = fecha.toDateString() === hoy.toDateString();
        const reserva = getReservaParaDia(fecha);
        let clases = 'calendario-dia';
        if (esHoy) clases += ' hoy';
        if (reserva) clases += ` reservado tipo-${reserva.tipo || 'otros'}`;
        const tooltip = reserva ? (reserva.notas || tiposReserva[reserva.tipo]?.nombre || '') : '';
        html += `<div class="${clases}" onclick="clickDia(${dia})" title="${tooltip}">${dia}</div>`;
      }
      
      const totalCeldas = startDay + diasMes;
      const celdasFaltantes = totalCeldas % 7 === 0 ? 0 : 7 - (totalCeldas % 7);
      for (let i = 1; i <= celdasFaltantes; i++) {
        html += `<div class="calendario-dia otro-mes">${i}</div>`;
      }
      
      grid.innerHTML = html;
    }

    function getReservaParaDia(fecha) {
      const t = fecha.getTime();
      for (const r of reservasData) {
        if (!r.fechaInicio || !r.fechaFin) continue;
        const inicio = r.fechaInicio.toDate(); inicio.setHours(0,0,0,0);
        const fin = r.fechaFin.toDate(); fin.setHours(23,59,59,999);
        if (t >= inicio.getTime() && t <= fin.getTime()) return r;
      }
      return null;
    }

    function cambiarMes(delta) { calendarioMes.setMonth(calendarioMes.getMonth() + delta); renderCalendario(); }

    function clickDia(dia) {
      const fecha = new Date(calendarioMes.getFullYear(), calendarioMes.getMonth(), dia);
      const reserva = getReservaParaDia(fecha);
      abrirModalReserva(reserva ? reserva : null, reserva ? null : fecha);
    }

    function renderReservasLista() {
      const container = document.getElementById('reservas-lista-items');
      const containerMovil = document.getElementById('reservas-movil-lista');
      const hoy = new Date(); hoy.setHours(0,0,0,0);
      
      const proximas = reservasData.filter(r => r.fechaFin?.toDate() >= hoy).sort((a, b) => a.fechaInicio.toDate() - b.fechaInicio.toDate()).slice(0, 5);
      
      if (proximas.length === 0) { 
        container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay reservas pr√≥ximas</div>'; 
        if (containerMovil) containerMovil.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.85rem;padding:12px;">No hay reservas pr√≥ximas</div>';
        return; 
      }
      
      // Versi√≥n desktop
      container.innerHTML = proximas.map(r => {
        const inicio = r.fechaInicio.toDate();
        const fin = r.fechaFin.toDate();
        const dias = Math.ceil((fin - inicio) / (1000*60*60*24)) + 1;
        const tipoInfo = tiposReserva[r.tipo] || { nombre: 'Otros', color: '#9A9A9A' };
        return `
          <div class="reserva-item tipo-${r.tipo || 'otros'}" onclick="abrirModalReserva(reservasData.find(x=>x.id==='${r.id}'))" title="${r.notas || ''}">
            <div class="reserva-fecha">
              <div class="reserva-fecha-dia">${inicio.getDate()}</div>
              <div class="reserva-fecha-mes">${inicio.toLocaleDateString('es-ES', {month: 'short'}).toUpperCase()}</div>
            </div>
            <div class="reserva-info">
              <div class="reserva-quien">${tipoInfo.nombre}</div>
              <div class="reserva-periodo">${formatDateRange(inicio, fin)} ¬∑ ${dias} noche${dias > 1 ? 's' : ''}${r.notas ? ' ¬∑ ' + r.notas : ''}</div>
            </div>
          </div>
        `;
      }).join('');
      
      // Versi√≥n m√≥vil compacta
      if (containerMovil) {
        containerMovil.innerHTML = proximas.slice(0, 3).map(r => {
          const inicio = r.fechaInicio.toDate();
          const fin = r.fechaFin.toDate();
          const tipoInfo = tiposReserva[r.tipo] || { nombre: 'Otros', color: '#9A9A9A' };
          return `
            <div class="reserva-mini-item">
              <div class="reserva-mini-dot" style="background:${tipoInfo.color}"></div>
              <div class="reserva-mini-info">
                <div class="reserva-mini-titulo">${tipoInfo.nombre}</div>
                <div class="reserva-mini-fecha">${formatDateRange(inicio, fin)}</div>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function renderNidosLeyenda() {
      const container = document.getElementById('nidos-leyenda');
      const tiposConReservas = [...new Set(reservasData.map(r => r.tipo))].filter(Boolean);
      if (tiposConReservas.length === 0) { container.innerHTML = ''; return; }
      
      container.innerHTML = tiposConReservas.map(tipo => {
        const info = tiposReserva[tipo] || { nombre: tipo, color: '#9A9A9A' };
        return `<div class="nido-leyenda-item"><div class="nido-leyenda-color" style="background:${info.color}"></div><span>${info.nombre}</span></div>`;
      }).join('');
    }

    // MODAL RESERVA
    const modalReserva = document.getElementById('modal-reserva');
    const formReserva = document.getElementById('form-reserva');

    function abrirModalReserva(reserva = null, fechaPre = null) {
      editingReservaId = reserva?.id || null;
      formReserva.reset();
      document.getElementById('btn-eliminar-reserva').classList.toggle('hidden', !reserva);
      
      if (reserva) {
        document.getElementById('modal-reserva-title').textContent = '‚úèÔ∏è Editar reserva';
        document.getElementById('reserva-tipo').value = reserva.tipo || '';
        document.getElementById('reserva-inicio').value = formatDateInput(reserva.fechaInicio.toDate());
        document.getElementById('reserva-fin').value = formatDateInput(reserva.fechaFin.toDate());
        document.getElementById('reserva-notas').value = reserva.notas || '';
      } else {
        document.getElementById('modal-reserva-title').textContent = 'üìÖ Nueva reserva';
        if (fechaPre) {
          document.getElementById('reserva-inicio').value = formatDateInput(fechaPre);
          const fin = new Date(fechaPre); fin.setDate(fin.getDate() + 1);
          document.getElementById('reserva-fin').value = formatDateInput(fin);
        }
      }
      modalReserva.classList.add('active');
    }

    document.getElementById('modal-reserva-close').addEventListener('click', () => modalReserva.classList.remove('active'));
    document.getElementById('modal-reserva-cancelar').addEventListener('click', () => modalReserva.classList.remove('active'));
    modalReserva.addEventListener('click', (e) => { if (e.target === modalReserva) modalReserva.classList.remove('active'); });

    formReserva.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-reserva-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const tipo = document.getElementById('reserva-tipo').value;
        const tipoInfo = tiposReserva[tipo] || { nombre: 'Otros' };
        
        const data = {
          tipo,
          tipoNombre: tipoInfo.nombre,
          fechaInicio: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('reserva-inicio').value + 'T00:00:00')),
          fechaFin: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('reserva-fin').value + 'T23:59:59')),
          notas: document.getElementById('reserva-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('reservas');
        if (editingReservaId) { await ref.doc(editingReservaId).update(data); }
        else { data.creadoPor = currentUser.uid; data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp(); await ref.add(data); }
        
        modalReserva.classList.remove('active');
        await loadReservas();
        renderCalendario(); renderReservasLista(); renderNidosLeyenda();
      } catch (error) { console.error(error); alert('Error al guardar'); }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-reserva').addEventListener('click', async () => {
      if (!editingReservaId || !confirm('¬øEliminar esta reserva?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('reservas').doc(editingReservaId).delete();
        modalReserva.classList.remove('active');
        await loadReservas();
        renderCalendario(); renderReservasLista(); renderNidosLeyenda();
      } catch (error) { console.error(error); alert('Error'); }
    });

    // UTILS
    function toggleSection(s) { document.getElementById(`section-${s}`).classList.toggle('open'); }
    function toggleLimpieza(item) { item.classList.toggle('done'); item.querySelector('.limpieza-check').textContent = item.classList.contains('done') ? '‚úì' : ''; }
    function formatDate(d) { return new Date(d).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }); }
    function formatDateInput(d) { return d.toISOString().split('T')[0]; }
    function formatDateRange(i, f) { const o = { day: 'numeric', month: 'short' }; return `${i.toLocaleDateString('es-ES', o)} - ${f.toLocaleDateString('es-ES', o)}`; }
    function scrollToSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        // Si es colapsable, abrirla primero
        if (section.classList.contains('collapsible-section') && !section.classList.contains('open')) {
          section.classList.add('open');
        }
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    function editarBien() {
      // Verificar permisos de edici√≥n
      if (!puedeEditar) {
        alert('Solo el creador del bien o un administrador puede editar esta informaci√≥n.');
        return;
      }
      
      // Abrir modal de edici√≥n
      const modal = document.getElementById('modal-editar-bien');
      
      // Cargar datos actuales en el formulario
      document.getElementById('edit-nombre').value = bienData.nombre || '';
      document.getElementById('edit-tipo').value = bienData.tipo || 'inmueble';
      document.getElementById('edit-subtipo').value = bienData.subtipo || '';
      document.getElementById('edit-ubicacion').value = bienData.ubicacion || '';
      document.getElementById('edit-titularidad').value = bienData.titularidad || '';
      document.getElementById('edit-origen').value = bienData.origen || '';
      document.getElementById('edit-notas').value = bienData.notas || '';
      document.getElementById('edit-normas').value = bienData.normasConvivencia || '';
      
      // Cargar campos r√∫sticos si es terreno
      toggleCamposRustico();
      if (bienData.tipo === 'terreno') {
        // Aprovechamiento
        document.getElementById('aprov-agricola').checked = bienData.aprovechamiento?.agricola || false;
        document.getElementById('aprov-forestal').checked = bienData.aprovechamiento?.forestal || false;
        document.getElementById('aprov-cinegetico').checked = bienData.aprovechamiento?.cinegetico || false;
        
        // Fincas
        document.getElementById('tbody-fincas').innerHTML = '';
        if (bienData.fincas && bienData.fincas.length > 0) {
          bienData.fincas.forEach(f => addFincaRow(f));
        }
        actualizarTotalSuperficie();
      }
      
      // Cargar personal
      document.getElementById('personal-list').innerHTML = '';
      if (bienData.personal && bienData.personal.length > 0) {
        bienData.personal.forEach(p => addPersonalItem(p));
      }
      
      // Cargar contactos
      document.getElementById('contactos-list').innerHTML = '';
      if (bienData.contactos && bienData.contactos.length > 0) {
        bienData.contactos.forEach(c => addContactoItem(c));
      }
      
      // Cargar habitaciones
      document.getElementById('habitaciones-list').innerHTML = '';
      document.getElementById('nueva-habitacion-nombre').value = '';
      if (bienData.habitaciones && bienData.habitaciones.length > 0) {
        bienData.habitaciones.forEach(h => addHabitacionItemFromData(h));
      }
      
      // Reset tabs
      document.querySelectorAll('#modal-editar-bien .modal-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('#modal-editar-bien .tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector('#modal-editar-bien .modal-tab[data-tab="datos"]').classList.add('active');
      document.getElementById('tab-datos').classList.add('active');
      
      modal.classList.add('active');
    }

    // Tabs del modal editar
    document.querySelectorAll('#modal-editar-bien .modal-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('#modal-editar-bien .modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#modal-editar-bien .tab-content').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // ========== CAMPOS R√öSTICOS ==========
    function toggleCamposRustico() {
      const tipo = document.getElementById('edit-tipo').value;
      const camposRustico = document.getElementById('campos-rustico');
      
      if (tipo === 'terreno') {
        camposRustico.classList.remove('hidden');
      } else {
        camposRustico.classList.add('hidden');
      }
    }

    function addFincaRow(data = null) {
      const tbody = document.getElementById('tbody-fincas');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="padding:8px;">
          <input type="text" class="form-input finca-registro" style="padding:8px;font-size:0.85rem;" placeholder="N¬∫ registro" value="${data?.registro || ''}">
        </td>
        <td style="padding:8px;">
          <input type="text" class="form-input finca-nombre" style="padding:8px;font-size:0.85rem;" placeholder="Nombre" value="${data?.nombre || ''}">
        </td>
        <td style="padding:8px;">
          <input type="number" step="0.01" class="form-input finca-superficie" style="padding:8px;font-size:0.85rem;text-align:right;" placeholder="0.00" value="${data?.superficie || ''}" onchange="actualizarTotalSuperficie()">
        </td>
        <td style="padding:8px;">
          <select class="form-input finca-uso" style="padding:8px;font-size:0.85rem;">
            <option value="">‚Äî Uso ‚Äî</option>
            <option value="secano" ${data?.uso === 'secano' ? 'selected' : ''}>üåæ Secano</option>
            <option value="regadio" ${data?.uso === 'regadio' ? 'selected' : ''}>üíß Regad√≠o</option>
            <option value="olivar" ${data?.uso === 'olivar' ? 'selected' : ''}>ü´í Olivar</option>
            <option value="vinedo" ${data?.uso === 'vinedo' ? 'selected' : ''}>üçá Vi√±edo</option>
            <option value="monte" ${data?.uso === 'monte' ? 'selected' : ''}>üå≤ Monte</option>
            <option value="pastos" ${data?.uso === 'pastos' ? 'selected' : ''}>üêÑ Pastos</option>
            <option value="erial" ${data?.uso === 'erial' ? 'selected' : ''}>üèúÔ∏è Erial</option>
            <option value="otro" ${data?.uso === 'otro' ? 'selected' : ''}>üì¶ Otro</option>
          </select>
        </td>
        <td style="padding:8px;text-align:center;">
          <button type="button" onclick="this.closest('tr').remove(); actualizarTotalSuperficie();" style="background:none;border:none;cursor:pointer;font-size:1rem;">üóëÔ∏è</button>
        </td>
      `;
      tbody.appendChild(row);
    }

    function actualizarTotalSuperficie() {
      const total = calcularTotalSuperficie();
      document.getElementById('total-superficie').textContent = total.toFixed(2) + ' ha';
    }

    function calcularTotalSuperficie() {
      const inputs = document.querySelectorAll('.finca-superficie');
      let total = 0;
      inputs.forEach(input => {
        const val = parseFloat(input.value);
        if (!isNaN(val)) total += val;
      });
      return total;
    }

    function getFincasFromForm() {
      const rows = document.querySelectorAll('#tbody-fincas tr');
      const fincas = [];
      rows.forEach(row => {
        const registro = row.querySelector('.finca-registro')?.value?.trim();
        const nombre = row.querySelector('.finca-nombre')?.value?.trim();
        const superficie = parseFloat(row.querySelector('.finca-superficie')?.value) || 0;
        const uso = row.querySelector('.finca-uso')?.value;
        
        if (registro || nombre || superficie > 0) {
          fincas.push({ registro, nombre, superficie, uso });
        }
      });
      return fincas;
    }

    // Personal din√°mico
    function addPersonalItem(data = null) {
      const list = document.getElementById('personal-list');
      const item = document.createElement('div');
      item.className = 'dynamic-item';
      item.innerHTML = `
        <button type="button" class="btn-remove-item" onclick="this.parentElement.remove()">üóëÔ∏è</button>
        <div class="dynamic-item-row">
          <input type="text" class="form-input personal-nombre" placeholder="Nombre" value="${data?.nombre || ''}">
          <select class="form-input personal-tipo">
            <option value="residente" ${data?.tipo === 'residente' ? 'selected' : ''}>Residente</option>
            <option value="puntual" ${data?.tipo === 'puntual' ? 'selected' : ''}>Puntual</option>
          </select>
        </div>
        <div class="dynamic-item-row">
          <select class="form-input personal-rol">
            <option value="limpieza" ${data?.rol === 'limpieza' ? 'selected' : ''}>üßπ Limpieza</option>
            <option value="jardinero" ${data?.rol === 'jardinero' ? 'selected' : ''}>üå± Jardinero</option>
            <option value="cuidador" ${data?.rol === 'cuidador' ? 'selected' : ''}>üë®‚Äç‚öïÔ∏è Cuidador</option>
            <option value="mantenimiento" ${data?.rol === 'mantenimiento' ? 'selected' : ''}>üîß Mantenimiento</option>
            <option value="otro" ${data?.rol === 'otro' ? 'selected' : ''}>üìã Otro</option>
          </select>
          <input type="tel" class="form-input personal-telefono" placeholder="Tel√©fono" value="${data?.telefono || ''}">
        </div>
      `;
      list.appendChild(item);
    }

    function getPersonalFromForm() {
      const items = [];
      document.querySelectorAll('#personal-list .dynamic-item').forEach(item => {
        const nombre = item.querySelector('.personal-nombre').value;
        if (nombre) {
          items.push({
            nombre,
            tipo: item.querySelector('.personal-tipo').value,
            rol: item.querySelector('.personal-rol').value,
            telefono: item.querySelector('.personal-telefono').value
          });
        }
      });
      return items;
    }

    // Contactos din√°micos
    function addContactoItem(data = null) {
      const list = document.getElementById('contactos-list');
      const item = document.createElement('div');
      item.className = 'dynamic-item';
      item.innerHTML = `
        <button type="button" class="btn-remove-item" onclick="this.parentElement.remove()">üóëÔ∏è</button>
        <div class="dynamic-item-row">
          <input type="text" class="form-input contacto-nombre" placeholder="Nombre" value="${data?.nombre || ''}">
          <select class="form-input contacto-categoria">
            <option value="mantenimiento" ${data?.categoria === 'mantenimiento' ? 'selected' : ''}>üîß Mantenimiento</option>
            <option value="vecino" ${data?.categoria === 'vecino' ? 'selected' : ''}>üèòÔ∏è Vecino</option>
            <option value="emergencia" ${data?.categoria === 'emergencia' ? 'selected' : ''}>üö® Emergencia</option>
            <option value="otro" ${data?.categoria === 'otro' ? 'selected' : ''}>üìã Otro</option>
          </select>
        </div>
        <div class="dynamic-item-row">
          <input type="tel" class="form-input contacto-telefono" placeholder="Tel√©fono" value="${data?.telefono || ''}">
          <input type="text" class="form-input contacto-notas" placeholder="Notas" value="${data?.notas || ''}">
        </div>
      `;
      list.appendChild(item);
    }

    function getContactosFromForm() {
      const items = [];
      document.querySelectorAll('#contactos-list .dynamic-item').forEach(item => {
        const nombre = item.querySelector('.contacto-nombre').value;
        if (nombre) {
          items.push({
            nombre,
            categoria: item.querySelector('.contacto-categoria').value,
            telefono: item.querySelector('.contacto-telefono').value,
            notas: item.querySelector('.contacto-notas').value
          });
        }
      });
      return items;
    }

    // ========== HABITACIONES ==========
    function addHabitacionItem() {
      const input = document.getElementById('nueva-habitacion-nombre');
      const nombre = input.value.trim();
      if (!nombre) return;
      
      addHabitacionItemFromData({ nombre });
      input.value = '';
      input.focus();
    }

    function addHabitacionItemFromData(data) {
      const list = document.getElementById('habitaciones-list');
      const nombre = typeof data === 'string' ? data : data.nombre;
      
      const item = document.createElement('div');
      item.className = 'habitacion-item';
      item.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--cream);border-radius:var(--radius-md);';
      item.innerHTML = `
        <span style="font-size:1.2rem;">üõèÔ∏è</span>
        <span class="habitacion-nombre" style="flex:1;font-weight:500;">${nombre}</span>
        <button type="button" onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;font-size:1rem;opacity:0.5;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5">üóëÔ∏è</button>
      `;
      list.appendChild(item);
    }

    function getHabitacionesFromForm() {
      const items = [];
      document.querySelectorAll('#habitaciones-list .habitacion-item').forEach(item => {
        const nombre = item.querySelector('.habitacion-nombre').textContent;
        if (nombre) {
          items.push({ nombre });
        }
      });
      return items;
    }

    // Cerrar modal editar
    document.getElementById('modal-editar-close').addEventListener('click', () => {
      document.getElementById('modal-editar-bien').classList.remove('active');
    });
    document.getElementById('modal-editar-cancelar').addEventListener('click', () => {
      document.getElementById('modal-editar-bien').classList.remove('active');
    });
    document.getElementById('modal-editar-bien').addEventListener('click', (e) => {
      if (e.target.id === 'modal-editar-bien') {
        document.getElementById('modal-editar-bien').classList.remove('active');
      }
    });

    // Guardar cambios del bien
    document.getElementById('form-editar-bien').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('modal-editar-guardar');
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      try {
        const tipo = document.getElementById('edit-tipo').value;
        
        const updateData = {
          nombre: document.getElementById('edit-nombre').value,
          tipo: tipo,
          subtipo: document.getElementById('edit-subtipo').value,
          ubicacion: document.getElementById('edit-ubicacion').value,
          titularidad: document.getElementById('edit-titularidad').value,
          origen: document.getElementById('edit-origen').value,
          notas: document.getElementById('edit-notas').value,
          normasConvivencia: document.getElementById('edit-normas').value,
          personal: getPersonalFromForm(),
          contactos: getContactosFromForm(),
          habitaciones: getHabitacionesFromForm(),
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Si es terreno/r√∫stico, a√±adir campos espec√≠ficos
        if (tipo === 'terreno') {
          updateData.aprovechamiento = {
            agricola: document.getElementById('aprov-agricola').checked,
            forestal: document.getElementById('aprov-forestal').checked,
            cinegetico: document.getElementById('aprov-cinegetico').checked
          };
          updateData.fincas = getFincasFromForm();
          updateData.superficieTotal = calcularTotalSuperficie();
        }

        await db.collection('bienes').doc(bienId).update(updateData);
        
        // Actualizar datos locales
        Object.assign(bienData, updateData);

        document.getElementById('modal-editar-bien').classList.remove('active');
        
        // Re-renderizar todo el bien con los nuevos datos
        renderBien();
        
        alert('‚úÖ Cambios guardados');

      } catch (error) {
        console.error('Error guardando:', error);
        alert('Error al guardar: ' + error.message);
      }

      btn.disabled = false;
      btn.textContent = 'üíæ Guardar cambios';
    });

    document.getElementById('btn-editar').addEventListener('click', editarBien);

    // ========== INVENTARIO ==========
    const catIcons2 = {
      limpieza: 'üßπ',
      bano: 'üöø',
      cocina: 'üç≥',
      alimentos: 'ü•´',
      bebidas: 'üç∑',
      otro: 'üì¶'
    };

    const catLabels = {
      limpieza: 'Limpieza',
      bano: 'Ba√±o',
      cocina: 'Cocina',
      alimentos: 'Alimentos',
      bebidas: 'Bebidas',
      otro: 'Otro'
    };

    function renderInventario() {
      renderInventarioStats();
      renderInventarioCategorias();
      renderInventarioList();
    }

    function renderInventarioStats() {
      const container = document.getElementById('inventario-stats');
      if (!container) return;

      const total = inventarioData.length;
      const bajos = inventarioData.filter(i => i.stockActual <= i.stockMinimo).length;
      const ok = total - bajos;

      container.innerHTML = `
        <div class="inventario-stat">
          <div class="inventario-stat-valor">${total}</div>
          <div class="inventario-stat-label">Total</div>
        </div>
        <div class="inventario-stat">
          <div class="inventario-stat-valor alerta">${bajos}</div>
          <div class="inventario-stat-label">Bajo m√≠nimo</div>
        </div>
        <div class="inventario-stat">
          <div class="inventario-stat-valor" style="color:var(--success)">${ok}</div>
          <div class="inventario-stat-label">OK</div>
        </div>
      `;
    }

    function renderInventarioCategorias() {
      const container = document.getElementById('inventario-categorias');
      if (!container) return;

      // Obtener categor√≠as que tienen items
      const categoriasConItems = ['todos', ...new Set(inventarioData.map(i => i.categoria))];
      
      container.innerHTML = categoriasConItems.map(cat => `
        <button class="inventario-cat-btn ${inventarioFiltro === cat ? 'active' : ''}" onclick="filtrarInventario('${cat}')">
          ${cat === 'todos' ? 'üìã Todos' : (catIcons2[cat] || 'üì¶') + ' ' + (catLabels[cat] || cat)}
        </button>
      `).join('');
    }

    function filtrarInventario(cat) {
      inventarioFiltro = cat;
      renderInventarioCategorias();
      renderInventarioList();
    }

    function renderInventarioList() {
      const container = document.getElementById('inventario-list');
      if (!container) return;

      let items = inventarioData;
      
      // Filtrar por categor√≠a
      if (inventarioFiltro !== 'todos') {
        items = items.filter(i => i.categoria === inventarioFiltro);
      }

      // Ordenar: primero los bajo m√≠nimo
      items.sort((a, b) => {
        const aBajo = a.stockActual <= a.stockMinimo;
        const bBajo = b.stockActual <= b.stockMinimo;
        if (aBajo && !bBajo) return -1;
        if (!aBajo && bBajo) return 1;
        return a.nombre.localeCompare(b.nombre);
      });

      if (items.length === 0) {
        container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay art√≠culos en el inventario</div>';
        return;
      }

      container.innerHTML = items.map(item => {
        const bajo = item.stockActual <= item.stockMinimo;
        const icon = catIcons2[item.categoria] || 'üì¶';
        
        return `
          <div class="inventario-item ${bajo ? 'bajo' : 'ok'}" onclick="abrirModalInventario(inventarioData.find(x=>x.id==='${item.id}'))">
            <span class="inventario-item-icon">${icon}</span>
            <div class="inventario-item-info">
              <div class="inventario-item-nombre">${item.nombre}</div>
              <div class="inventario-item-meta">${item.unidad || 'uds'}${item.fechaCaducidad ? ' ¬∑ Cad: ' + formatDate(item.fechaCaducidad) : ''}</div>
            </div>
            <div class="inventario-item-stock">
              <div class="inventario-item-cantidad ${bajo ? 'bajo' : 'ok'}">${item.stockActual}</div>
              <div class="inventario-item-minimo">m√≠n. ${item.stockMinimo}</div>
            </div>
            <div class="inventario-quick-btns" onclick="event.stopPropagation()">
              <button class="inventario-quick-btn menos" onclick="ajustarStock('${item.id}', -1)">‚àí</button>
              <button class="inventario-quick-btn mas" onclick="ajustarStock('${item.id}', 1)">+</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function ajustarStock(itemId, delta) {
      const item = inventarioData.find(i => i.id === itemId);
      if (!item) return;

      const nuevoStock = Math.max(0, item.stockActual + delta);
      
      try {
        await db.collection('bienes').doc(bienId).collection('inventario').doc(itemId).update({
          stockActual: nuevoStock,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Actualizar localmente
        item.stockActual = nuevoStock;
        renderInventario();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // MODAL INVENTARIO
    const modalInventario = document.getElementById('modal-inventario');
    const formInventario = document.getElementById('form-inventario');

    function abrirModalInventario(item = null) {
      editingInventarioId = item?.id || null;
      formInventario.reset();
      document.getElementById('btn-eliminar-inventario').classList.toggle('hidden', !item);
      
      if (item) {
        document.getElementById('modal-inventario-title').textContent = '‚úèÔ∏è Editar art√≠culo';
        document.getElementById('inv-nombre').value = item.nombre || '';
        document.getElementById('inv-categoria').value = item.categoria || 'otro';
        document.getElementById('inv-unidad').value = item.unidad || 'uds';
        document.getElementById('inv-stock').value = item.stockActual || 0;
        document.getElementById('inv-minimo').value = item.stockMinimo || 1;
        document.getElementById('inv-caducidad').value = item.fechaCaducidad || '';
        document.getElementById('inv-notas').value = item.notas || '';
      } else {
        document.getElementById('modal-inventario-title').textContent = 'üì¶ Nuevo art√≠culo';
      }
      modalInventario.classList.add('active');
    }

    document.getElementById('modal-inventario-close').addEventListener('click', () => modalInventario.classList.remove('active'));
    document.getElementById('modal-inventario-cancelar').addEventListener('click', () => modalInventario.classList.remove('active'));
    modalInventario.addEventListener('click', (e) => { if (e.target === modalInventario) modalInventario.classList.remove('active'); });

    formInventario.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-inventario-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const data = {
          nombre: document.getElementById('inv-nombre').value,
          categoria: document.getElementById('inv-categoria').value,
          unidad: document.getElementById('inv-unidad').value,
          stockActual: parseInt(document.getElementById('inv-stock').value) || 0,
          stockMinimo: parseInt(document.getElementById('inv-minimo').value) || 1,
          fechaCaducidad: document.getElementById('inv-caducidad').value || null,
          notas: document.getElementById('inv-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('inventario');
        if (editingInventarioId) {
          await ref.doc(editingInventarioId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        
        modalInventario.classList.remove('active');
        await loadInventario();
        renderInventario();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-inventario').addEventListener('click', async () => {
      if (!editingInventarioId || !confirm('¬øEliminar este art√≠culo?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('inventario').doc(editingInventarioId).delete();
        modalInventario.classList.remove('active');
        await loadInventario();
        renderInventario();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ========== GASTOS ==========
    const gastoCatIcons = {
      luz: 'üí°',
      agua: 'üíß',
      gas: 'üî•',
      comunidad: 'üè¢',
      seguro: 'üõ°Ô∏è',
      mantenimiento: 'üîß',
      limpieza: 'üßπ',
      compras: 'üõí',
      otro: 'üìã'
    };

    const gastoCatLabels = {
      luz: 'Luz',
      agua: 'Agua',
      gas: 'Gas',
      comunidad: 'Comunidad',
      seguro: 'Seguro',
      mantenimiento: 'Mantenimiento',
      limpieza: 'Limpieza',
      compras: 'Compras',
      otro: 'Otro'
    };

    const coloresNidoHex = ['#7A9E7E', '#C17757', '#6B8E9F', '#9B8EA6'];

    function renderGastos() {
      renderGastosPeriodoSelector();
      renderGastosResumen();
      renderGastosCategorias();
      renderGastosList();
      renderRepartoTable();
      renderRepartoDesglose();
      
      // Popular selector de generador con nidos
      const selectGenerador = document.getElementById('gasto-generador');
      if (selectGenerador) {
        selectGenerador.innerHTML = '<option value="">Sin asignar</option>' +
          nidosData.map(n => `<option value="${n.id}">${n.nombre}</option>`).join('');
      }
    }

    function cambiarTabGastos(tab) {
      gastosTab = tab;
      document.querySelectorAll('.gastos-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.gastos-tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.gastos-tab:nth-child(${tab === 'registro' ? 1 : 2})`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    function renderGastosPeriodoSelector() {
      const container = document.getElementById('gastos-periodo-selector');
      if (!container) return;

      container.innerHTML = `
        <button class="gastos-periodo-btn ${gastosPeriodo === 'mes' ? 'active' : ''}" onclick="cambiarPeriodoGastos('mes')">Este mes</button>
        <button class="gastos-periodo-btn ${gastosPeriodo === 'a√±o' ? 'active' : ''}" onclick="cambiarPeriodoGastos('a√±o')">Este a√±o</button>
        <button class="gastos-periodo-btn ${gastosPeriodo === 'todos' ? 'active' : ''}" onclick="cambiarPeriodoGastos('todos')">Todos</button>
      `;
    }

    function cambiarPeriodoGastos(periodo) {
      gastosPeriodo = periodo;
      renderGastosPeriodoSelector();
      renderGastosResumen();
      renderGastosCategorias();
      renderGastosList();
      renderRepartoDesglose();
    }

    function getGastosFiltrados() {
      const hoy = new Date();
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const inicioA√±o = new Date(hoy.getFullYear(), 0, 1);

      return gastosData.filter(g => {
        if (!g.fecha) return false;
        const fechaGasto = new Date(g.fecha);
        
        if (gastosPeriodo === 'mes') {
          return fechaGasto >= inicioMes;
        } else if (gastosPeriodo === 'a√±o') {
          return fechaGasto >= inicioA√±o;
        }
        return true;
      });
    }

    function renderGastosResumen() {
      const container = document.getElementById('gastos-resumen');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      const total = gastosFiltrados.reduce((sum, g) => sum + (parseFloat(g.importe) || 0), 0);
      const numGastos = gastosFiltrados.length;

      const periodoLabel = gastosPeriodo === 'mes' ? 'Este mes' : gastosPeriodo === 'a√±o' ? 'Este a√±o' : 'Total';

      container.innerHTML = `
        <div class="gasto-stat">
          <div class="gasto-stat-valor">‚Ç¨${total.toFixed(2)}</div>
          <div class="gasto-stat-label">${periodoLabel}</div>
        </div>
        <div class="gasto-stat">
          <div class="gasto-stat-valor" style="color:var(--text)">${numGastos}</div>
          <div class="gasto-stat-label">Registros</div>
        </div>
      `;
    }

    function renderGastosCategorias() {
      const container = document.getElementById('gastos-categorias');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      
      const porCategoria = {};
      gastosFiltrados.forEach(g => {
        const cat = g.categoria || 'otro';
        if (!porCategoria[cat]) porCategoria[cat] = 0;
        porCategoria[cat] += parseFloat(g.importe) || 0;
      });

      const categorias = Object.entries(porCategoria).sort((a, b) => b[1] - a[1]);

      if (categorias.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = categorias.map(([cat, total]) => `
        <div class="gasto-cat-chip">
          <span>${gastoCatIcons[cat] || 'üìã'}</span>
          <span>${gastoCatLabels[cat] || cat}</span>
          <span class="gasto-cat-chip-valor">‚Ç¨${total.toFixed(0)}</span>
        </div>
      `).join('');
    }

    function renderGastosList() {
      const container = document.getElementById('gastos-list');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();

      if (gastosFiltrados.length === 0) {
        container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay gastos registrados</div>';
        return;
      }

      const gastosRecientes = gastosFiltrados.slice(0, 15);

      container.innerHTML = gastosRecientes.map(g => {
        const icon = gastoCatIcons[g.categoria] || 'üìã';
        const generador = g.generadorId ? nidosData.find(n => n.id === g.generadorId) : null;
        const fecha = g.fecha ? new Date(g.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }) : '';
        
        return `
          <div class="gasto-item" onclick="abrirModalGasto(gastosData.find(x=>x.id==='${g.id}'))">
            <span class="gasto-item-icon">${icon}</span>
            <div class="gasto-item-info">
              <div class="gasto-item-concepto">${g.concepto}</div>
              <div class="gasto-item-meta">${fecha}${g.proveedor ? ' ¬∑ ' + g.proveedor : ''}</div>
            </div>
            ${generador ? `<span class="gasto-item-generador">${generador.nombre}</span>` : ''}
            <span class="gasto-item-importe">‚Ç¨${parseFloat(g.importe).toFixed(2)}</span>
          </div>
        `;
      }).join('');
    }

    // TABLA DE REPARTO
    function renderRepartoTable() {
      const container = document.getElementById('reparto-table');
      if (!container) return;

      if (nidosData.length === 0) {
        container.innerHTML = '<tr><td>No hay nidos configurados</td></tr>';
        return;
      }

      let html = `
        <thead>
          <tr>
            <th>Nido</th>
            <th style="text-align:right">Porcentaje</th>
          </tr>
        </thead>
        <tbody>
      `;

      nidosData.forEach((nido, i) => {
        const color = coloresNidoHex[i % coloresNidoHex.length];
        const porcentaje = repartoData[nido.id] || 0;
        
        html += `
          <tr>
            <td>
              <div class="reparto-nido-nombre">
                <div class="reparto-nido-color" style="background:${color}"></div>
                <span>${nido.nombre}</span>
              </div>
            </td>
            <td style="text-align:right">
              <input type="number" class="reparto-input" 
                id="reparto-${nido.id}" 
                value="${porcentaje}" 
                min="0" max="100" 
                onchange="actualizarReparto('${nido.id}', this.value)"> %
            </td>
          </tr>
        `;
      });

      html += '</tbody>';
      container.innerHTML = html;

      actualizarTotalReparto();
    }

    function actualizarReparto(nidoId, valor) {
      repartoData[nidoId] = parseInt(valor) || 0;
      actualizarTotalReparto();
    }

    function actualizarTotalReparto() {
      const container = document.getElementById('reparto-total');
      if (!container) return;

      const total = Object.values(repartoData).reduce((sum, v) => sum + (parseInt(v) || 0), 0);
      const esValido = total === 100;

      container.innerHTML = `
        <span class="reparto-total-label">Total</span>
        <span class="reparto-total-valor ${esValido ? 'ok' : 'error'}">${total}%</span>
      `;
    }

    async function guardarReparto() {
      const total = Object.values(repartoData).reduce((sum, v) => sum + (parseInt(v) || 0), 0);
      
      if (total !== 100) {
        alert('El total debe sumar exactamente 100%');
        return;
      }

      try {
        await db.collection('bienes').doc(bienId).collection('config').doc('reparto').set({
          porcentajes: repartoData,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Reparto guardado');
        renderRepartoDesglose();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
    }

    function renderRepartoDesglose() {
      const container = document.getElementById('reparto-desglose');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      const total = gastosFiltrados.reduce((sum, g) => sum + (parseFloat(g.importe) || 0), 0);

      if (total === 0 || nidosData.length === 0) {
        container.innerHTML = '';
        return;
      }

      const periodoLabel = gastosPeriodo === 'mes' ? 'este mes' : gastosPeriodo === 'a√±o' ? 'este a√±o' : 'en total';

      let html = `<div class="reparto-desglose-title">Desglose ${periodoLabel} (‚Ç¨${total.toFixed(2)})</div>`;

      nidosData.forEach((nido, i) => {
        const porcentaje = repartoData[nido.id] || 0;
        const importe = (total * porcentaje / 100);
        const color = coloresNidoHex[i % coloresNidoHex.length];
        
        html += `
          <div class="reparto-desglose-item">
            <span style="display:flex;align-items:center;gap:6px;">
              <span style="width:8px;height:8px;border-radius:2px;background:${color}"></span>
              ${nido.nombre} (${porcentaje}%)
            </span>
            <span>‚Ç¨${importe.toFixed(2)}</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // MODAL GASTOS
    const modalGasto = document.getElementById('modal-gasto');
    const formGasto = document.getElementById('form-gasto');

    function abrirModalGasto(gasto = null) {
      editingGastoId = gasto?.id || null;
      formGasto.reset();
      document.getElementById('btn-eliminar-gasto').classList.toggle('hidden', !gasto);
      
      document.getElementById('gasto-fecha').value = formatDateInput(new Date());
      
      // Cargar miembros para reparto
      cargarMiembrosReparto(gasto?.repartos || null);
      
      if (gasto) {
        document.getElementById('modal-gasto-title').textContent = '‚úèÔ∏è Editar gasto';
        document.getElementById('gasto-fecha').value = gasto.fecha || '';
        document.getElementById('gasto-importe').value = gasto.importe || '';
        document.getElementById('gasto-concepto').value = gasto.concepto || '';
        document.getElementById('gasto-categoria').value = gasto.categoria || 'otro';
        document.getElementById('gasto-proveedor').value = gasto.proveedor || '';
        document.getElementById('gasto-generador').value = gasto.generadorId || '';
        document.getElementById('gasto-notas').value = gasto.notas || '';
      } else {
        document.getElementById('modal-gasto-title').textContent = 'üí∂ Nuevo gasto';
      }
      modalGasto.classList.add('active');
    }

    // ========== REPARTO DE GASTOS ==========
    let miembrosReparto = [];

    function cargarMiembrosReparto(repartosExistentes = null) {
      const container = document.getElementById('reparto-miembros');
      miembrosReparto = [];

      // Obtener miembros de todos los nidos
      nidosData.forEach(nido => {
        (nido.miembrosData || []).forEach(m => {
          const repartoExistente = repartosExistentes?.find(r => r.miembroId === m.visibleId);
          miembrosReparto.push({
            id: m.visibleId || m.id,
            nombre: m.nombre,
            nido: nido.nombre,
            nidoId: nido.id,
            selected: repartoExistente ? true : (repartosExistentes ? false : true),
            porcentaje: repartoExistente?.porcentaje || 0
          });
        });
      });

      // Si no hay repartos existentes, aplicar reparto lineal
      if (!repartosExistentes && miembrosReparto.length > 0) {
        const pctEach = Math.floor(100 / miembrosReparto.length);
        const resto = 100 - (pctEach * miembrosReparto.length);
        miembrosReparto.forEach((m, i) => {
          m.porcentaje = pctEach + (i < resto ? 1 : 0);
        });
      }

      renderMiembrosReparto();
    }

    function renderMiembrosReparto() {
      const container = document.getElementById('reparto-miembros');
      const importe = parseFloat(document.getElementById('gasto-importe')?.value) || 0;

      if (miembrosReparto.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:12px;">No hay miembros</div>';
        return;
      }

      container.innerHTML = miembrosReparto.map((m, i) => {
        const importeMiembro = (importe * m.porcentaje / 100).toFixed(2);
        return `
          <div class="reparto-miembro ${m.selected ? 'selected' : ''}">
            <input type="checkbox" class="reparto-miembro-check" ${m.selected ? 'checked' : ''} onchange="toggleMiembroReparto(${i})">
            <div class="reparto-miembro-info">
              <div class="reparto-miembro-nombre">${m.nombre}</div>
              <div class="reparto-miembro-nido">ü™∫ ${m.nido}</div>
            </div>
            <div class="reparto-miembro-pct">
              <input type="number" value="${m.porcentaje}" min="0" max="100" 
                     onchange="actualizarPorcentaje(${i}, this.value)" 
                     ${!m.selected ? 'disabled' : ''}>%
            </div>
            <div class="reparto-miembro-importe">${importeMiembro} ‚Ç¨</div>
          </div>
        `;
      }).join('');

      actualizarResumenReparto();
    }

    function toggleMiembroReparto(index) {
      miembrosReparto[index].selected = !miembrosReparto[index].selected;
      if (!miembrosReparto[index].selected) {
        miembrosReparto[index].porcentaje = 0;
      }
      repartoLineal();
    }

    function actualizarPorcentaje(index, valor) {
      miembrosReparto[index].porcentaje = parseFloat(valor) || 0;
      renderMiembrosReparto();
    }

    function repartoLineal() {
      const seleccionados = miembrosReparto.filter(m => m.selected);
      if (seleccionados.length === 0) {
        miembrosReparto.forEach(m => m.porcentaje = 0);
        renderMiembrosReparto();
        return;
      }

      const pctEach = Math.floor(100 / seleccionados.length);
      const resto = 100 - (pctEach * seleccionados.length);
      
      let idx = 0;
      miembrosReparto.forEach(m => {
        if (m.selected) {
          m.porcentaje = pctEach + (idx < resto ? 1 : 0);
          idx++;
        } else {
          m.porcentaje = 0;
        }
      });

      renderMiembrosReparto();
    }

    function actualizarResumenReparto() {
      const totalEl = document.getElementById('reparto-total');
      const pctEl = document.getElementById('reparto-pct-total');
      const warningEl = document.getElementById('reparto-warning');

      const suma = miembrosReparto.reduce((acc, m) => acc + m.porcentaje, 0);
      pctEl.textContent = suma + '%';

      if (suma !== 100) {
        totalEl.classList.add('error');
        warningEl.classList.remove('hidden');
      } else {
        totalEl.classList.remove('error');
        warningEl.classList.add('hidden');
      }
    }

    // Actualizar importes cuando cambia el importe total
    document.getElementById('gasto-importe')?.addEventListener('input', renderMiembrosReparto);

    function previsualizarReparto() {
      const suma = miembrosReparto.reduce((acc, m) => acc + m.porcentaje, 0);
      if (suma !== 100) {
        alert('Los porcentajes deben sumar exactamente 100%');
        return;
      }

      const importe = parseFloat(document.getElementById('gasto-importe')?.value) || 0;
      const concepto = document.getElementById('gasto-concepto')?.value || 'Sin concepto';

      if (importe <= 0) {
        alert('Introduce un importe v√°lido');
        return;
      }

      document.getElementById('preview-concepto').textContent = concepto;
      document.getElementById('preview-total').textContent = importe.toFixed(2) + ' ‚Ç¨';

      const lista = document.getElementById('preview-lista');
      lista.innerHTML = miembrosReparto
        .filter(m => m.selected && m.porcentaje > 0)
        .map(m => {
          const importeMiembro = (importe * m.porcentaje / 100).toFixed(2);
          return `
            <div class="preview-item">
              <span class="preview-nombre">${m.nombre}</span>
              <div>
                <span class="preview-importe">${importeMiembro} ‚Ç¨</span>
                <span class="preview-pct">(${m.porcentaje}%)</span>
              </div>
            </div>
          `;
        }).join('');

      document.getElementById('modal-reparto-preview').classList.add('active');
    }

    function cerrarPreviewReparto() {
      document.getElementById('modal-reparto-preview').classList.remove('active');
    }

    async function guardarGastoConReparto() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      try {
        const importe = parseFloat(document.getElementById('gasto-importe').value) || 0;
        const generadorId = document.getElementById('gasto-generador').value;
        const nido = generadorId ? nidosData.find(n => n.id === generadorId) : null;

        const repartos = miembrosReparto
          .filter(m => m.selected && m.porcentaje > 0)
          .map(m => ({
            miembroId: m.id,
            nombre: m.nombre,
            nidoId: m.nidoId,
            porcentaje: m.porcentaje,
            importe: parseFloat((importe * m.porcentaje / 100).toFixed(2))
          }));

        const data = {
          fecha: document.getElementById('gasto-fecha').value,
          importe: importe,
          concepto: document.getElementById('gasto-concepto').value,
          categoria: document.getElementById('gasto-categoria').value,
          proveedor: document.getElementById('gasto-proveedor').value,
          generadorId: generadorId || null,
          generadorNombre: nido?.nombre || null,
          notas: document.getElementById('gasto-notas').value,
          repartos: repartos,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };

        const ref = db.collection('bienes').doc(bienId).collection('gastos');
        if (editingGastoId) {
          await ref.doc(editingGastoId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }

        cerrarPreviewReparto();
        modalGasto.classList.remove('active');
        await loadGastos();
        renderGastos();
      } catch (error) {
        console.error(error);
        alert('Error al guardar: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üíæ Guardar';
      }
    }

    document.getElementById('modal-gasto-close').addEventListener('click', () => modalGasto.classList.remove('active'));
    document.getElementById('modal-gasto-cancelar').addEventListener('click', () => modalGasto.classList.remove('active'));
    modalGasto.addEventListener('click', (e) => { if (e.target === modalGasto) modalGasto.classList.remove('active'); });
    
    // Preview reparto modal
    document.getElementById('modal-reparto-preview')?.addEventListener('click', (e) => {
      if (e.target.id === 'modal-reparto-preview') cerrarPreviewReparto();
    });

    formGasto.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-gasto-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const generadorId = document.getElementById('gasto-generador').value;
        const nido = generadorId ? nidosData.find(n => n.id === generadorId) : null;
        
        const data = {
          fecha: document.getElementById('gasto-fecha').value,
          importe: parseFloat(document.getElementById('gasto-importe').value) || 0,
          concepto: document.getElementById('gasto-concepto').value,
          categoria: document.getElementById('gasto-categoria').value,
          proveedor: document.getElementById('gasto-proveedor').value,
          generadorId: generadorId || null,
          generadorNombre: nido?.nombre || null,
          notas: document.getElementById('gasto-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('gastos');
        if (editingGastoId) {
          await ref.doc(editingGastoId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        
        modalGasto.classList.remove('active');
        await loadGastos();
        renderGastos();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-gasto').addEventListener('click', async () => {
      if (!editingGastoId || !confirm('¬øEliminar este gasto?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('gastos').doc(editingGastoId).delete();
        modalGasto.classList.remove('active');
        await loadGastos();
        renderGastos();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ========== CASEROS - PERMISOS CVEB GRANULARES ==========
    
    // Estructura CASERO/MAYORDOMO: Bloque ‚Üí Cards (igual que admin-rama.html)
    const estructuraPermisosMayordomo = {
      // BLOQUE RESERVAS
      reservas: { 
        icon: 'üìÖ', 
        nombre: 'RESERVAS', 
        cards: [
          { id: 'calendario', nombre: 'Calendario' }
        ]
      },
      // BLOQUE INVENTARIO
      inventario: { 
        icon: 'üì¶', 
        nombre: 'INVENTARIO', 
        cards: [
          { id: 'tomaInventario', nombre: 'Toma inventario' },
          { id: 'reparaciones', nombre: 'Reparaciones' },
          { id: 'herramientas', nombre: 'Herramientas' }
        ]
      },
      // BLOQUE PLANES SEMANALES
      planesSem: { 
        icon: 'üìã', 
        nombre: 'PLANES SEMANALES', 
        cards: [
          { id: 'planSemanalMto', nombre: 'Plan de Mantenimiento' },
          { id: 'mtoProgramado', nombre: 'Mto. Programado' },
          { id: 'instalaciones', nombre: 'Instalaciones' },
          { id: 'planSemanalLimp', nombre: 'Plan de Limpieza' },
          { id: 'zonasTareas', nombre: 'Zonas y Tareas' },
          { id: 'limpiezaProg', nombre: 'Limpieza Programada' },
          { id: 'lavanderia', nombre: 'Lavander√≠a' },
          { id: 'informeEstancia', nombre: 'Informe de Estancia' }
        ]
      },
      // BLOQUE GASTOS
      gastos: { 
        icon: 'üí∂', 
        nombre: 'GASTOS', 
        cards: [
          { id: 'registro', nombre: 'Registro gastos' }
        ]
      }
    };

    // Estructura GERENTE: M√≥dulo ‚Üí Cards
    const estructuraPermisosGerente = {
      reservas: { icon: 'üìÖ', nombre: 'Reservas', cards: null },
      habitaciones: { icon: 'üè†', nombre: 'Zonas', cards: null },
      huespedes: { icon: 'üë•', nombre: 'Hu√©spedes', cards: null },
      tarifas: { icon: 'üí∂', nombre: 'Tarifas', cards: null },
      ventas: { icon: 'üí∞', nombre: 'Ventas', cards: null },
      inventario: { icon: 'üì¶', nombre: 'Inventarios', cards: [
        { id: 'gestionar', nombre: 'Gestionar inventario' },
        { id: 'toma', nombre: 'Toma de inventario' }
      ]},
      ajuar: { icon: 'ü™ë', nombre: 'Ajuar', cards: null },
      contratos: { icon: 'üìù', nombre: 'Contratos', cards: null },
      servicios: { icon: 'üöê', nombre: 'Otros servicios', cards: null },
      menus: { icon: 'üçΩÔ∏è', nombre: 'Men√∫s', cards: null }
    };

    // Estructura CAPATAZ: M√≥dulo ‚Üí Cards (sin cards por ahora)
    const estructuraPermisosCapataz = {
      parcelas: { icon: 'üó∫Ô∏è', nombre: 'Parcelas', cards: null },
      instalaciones: { icon: 'üè≠', nombre: 'Instalaciones', cards: null },
      maquinaria: { icon: 'üöú', nombre: 'Maquinaria', cards: null },
      personal: { icon: 'üë∑', nombre: 'Personal', cards: null },
      labores: { icon: 'üìã', nombre: 'Labores', cards: null },
      cosechas: { icon: 'üåª', nombre: 'Cosechas', cards: null }
    };

    function getEstructuraPermisos(tipoExterno = 'casero') {
      if (tipoExterno === 'hoster' || bienData?.gerenteActivo) return estructuraPermisosGerente;
      if (tipoExterno === 'guarda' || bienData?.capatazActivo) return estructuraPermisosCapataz;
      return estructuraPermisosMayordomo;
    }

    // Renderizar matriz de permisos CVEB
    function renderMatrizPermisos(containerId, prefix, permisosActuales = {}, tipoExterno = 'casero') {
      const container = document.getElementById(containerId);
      if (!container) return;

      const estructura = getEstructuraPermisos(tipoExterno);
      let html = '';

      for (const [modId, modInfo] of Object.entries(estructura)) {
        if (modInfo.cards && modInfo.cards.length > 0) {
          // M√≥dulo con cards: header del m√≥dulo
          html += `<div class="permisos-modulo-header">${modInfo.icon} ${modInfo.nombre}</div>`;
          
          // Cards del m√≥dulo
          modInfo.cards.forEach(card => {
            const permKey = `${modId}_${card.id}`;
            const perm = permisosActuales[permKey] || { c: false, v: true, e: false, b: false };
            
            html += `
              <div class="permisos-matrix-row card-row">
                <label>‚Ü≥ ${card.nombre}</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="${prefix}-${permKey}-c" ${perm.c ? 'checked' : ''}></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="${prefix}-${permKey}-v" ${perm.v ? 'checked' : ''}></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="${prefix}-${permKey}-e" ${perm.e ? 'checked' : ''}></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="${prefix}-${permKey}-b" ${perm.b ? 'checked' : ''}></div>
              </div>
            `;
          });
        } else {
          // M√≥dulo sin cards: fila simple
          const perm = permisosActuales[modId] || { c: false, v: true, e: false, b: false };
          
          html += `
            <div class="permisos-matrix-row">
              <label>${modInfo.icon} ${modInfo.nombre}</label>
              <div class="permisos-matrix-check"><input type="checkbox" id="${prefix}-${modId}-c" ${perm.c ? 'checked' : ''}></div>
              <div class="permisos-matrix-check"><input type="checkbox" id="${prefix}-${modId}-v" ${perm.v ? 'checked' : ''}></div>
              <div class="permisos-matrix-check"><input type="checkbox" id="${prefix}-${modId}-e" ${perm.e ? 'checked' : ''}></div>
              <div class="permisos-matrix-check"><input type="checkbox" id="${prefix}-${modId}-b" ${perm.b ? 'checked' : ''}></div>
            </div>
          `;
        }
      }

      container.innerHTML = html;
    }

    // Recoger permisos CVEB de la matriz
    function recogerPermisos(prefix, tipoExterno = 'casero') {
      const permisos = {};
      const estructura = getEstructuraPermisos(tipoExterno);

      for (const [modId, modInfo] of Object.entries(estructura)) {
        if (modInfo.cards && modInfo.cards.length > 0) {
          modInfo.cards.forEach(card => {
            const permKey = `${modId}_${card.id}`;
            const cEl = document.getElementById(`${prefix}-${permKey}-c`);
            if (cEl) {
              permisos[permKey] = {
                c: cEl.checked,
                v: document.getElementById(`${prefix}-${permKey}-v`)?.checked || false,
                e: document.getElementById(`${prefix}-${permKey}-e`)?.checked || false,
                b: document.getElementById(`${prefix}-${permKey}-b`)?.checked || false
              };
            }
          });
        } else {
          const cEl = document.getElementById(`${prefix}-${modId}-c`);
          if (cEl) {
            permisos[modId] = {
              c: cEl.checked,
              v: document.getElementById(`${prefix}-${modId}-v`)?.checked || false,
              e: document.getElementById(`${prefix}-${modId}-e`)?.checked || false,
              b: document.getElementById(`${prefix}-${modId}-b`)?.checked || false
            };
          }
        }
      }

      return permisos;
    }

    // Labels para badges en lista
    const seccionesLabels = {
      reservas: 'üìÖ', inventario: 'üì¶', planesSem: 'üìã', gastos: 'üí∂',
      calendario: 'üìÖ', tomaInventario: 'üì¶', reparaciones: 'üîß', herramientas: 'üîß',
      planSemanalMto: 'üîß', mtoProgramado: 'üîß', instalaciones: 'üè≠',
      planSemanalLimp: 'üßπ', zonasTareas: 'üßπ', limpiezaProg: 'üßπ',
      lavanderia: 'üß∫', informeEstancia: 'üìã', registro: 'üí∂',
      // Gerente
      habitaciones: 'üõèÔ∏è', huespedes: 'üë•', tarifas: 'üí∂', ventas: 'üí∞',
      contratos: 'üìù', servicios: 'üöê', ajuar: 'ü™ë', menus: 'üçΩÔ∏è',
      // Capataz
      parcelas: 'üó∫Ô∏è', maquinaria: 'üöú', personal: 'üë∑', labores: 'üìã', cosechas: 'üåª'
    };

    function renderCaserosList() {
      const container = document.getElementById('lista-caseros');
      if (!container) return;

      if (caserosData.length === 0) {
        container.innerHTML = '<div class="empty-mini">Sin caseros asignados</div>';
        return;
      }

      container.innerHTML = caserosData.map(c => {
        const iniciales = c.nombre ? c.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
        
        // Contar m√≥dulos con acceso (V=true)
        const permisos = c.permisos || {};
        const modulosConAcceso = new Set();
        Object.keys(permisos).forEach(key => {
          const modulo = key.split('_')[0];
          if (permisos[key]?.v) modulosConAcceso.add(modulo);
        });

        return `
          <div class="casero-card" onclick="abrirModalCasero(caserosData.find(x=>x.id==='${c.id}'))">
            <div class="casero-card-header">
              <div class="casero-avatar">${iniciales}</div>
              <div class="casero-info">
                <div class="casero-nombre">${c.nombre}</div>
                <div class="casero-email">${c.email}${c.telefono ? ' ¬∑ ' + c.telefono : ''}</div>
              </div>
            </div>
            <div class="casero-permisos">
              ${[...modulosConAcceso].slice(0, 5).map(m => `
                <span class="casero-permiso-badge">${seccionesLabels[m] || 'üìã'}</span>
              `).join('')}
              ${modulosConAcceso.size > 5 ? `<span class="casero-permiso-badge">+${modulosConAcceso.size - 5}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // MODAL CASERO
    const modalCasero = document.getElementById('modal-casero');
    const formCasero = document.getElementById('form-casero');

    function abrirModalCasero(casero = null) {
      // Si no es edici√≥n y no puede editar, bloquear creaci√≥n
      if (!casero && !puedeEditar) {
        alert('Solo el creador del bien o un administrador puede a√±adir caseros.');
        return;
      }
      
      editingCaseroId = casero?.id || null;
      formCasero.reset();
      document.getElementById('btn-eliminar-casero').classList.toggle('hidden', !casero || !puedeEditar);
      
      // Renderizar matriz de permisos
      const permisosActuales = casero?.permisos || {};
      renderMatrizPermisos('permisos-rows-casero', 'perm', permisosActuales, 'casero');
      
      // Reset libranzas a valores por defecto
      document.getElementById('casero-libranza-dias').value = '2';
      ['L','M','X','J','V'].forEach(d => document.getElementById(`casero-lib-${d}`).checked = false);
      ['S','D'].forEach(d => document.getElementById(`casero-lib-${d}`).checked = true);
      document.getElementById('casero-libranza-notas').value = '';
      document.getElementById('casero-vacaciones-dias').value = '30';
      document.getElementById('casero-vacaciones-notas').value = '';
      document.getElementById('casero-vac1-salida').value = '';
      document.getElementById('casero-vac1-vuelta').value = '';
      document.getElementById('casero-vac2-salida').value = '';
      document.getElementById('casero-vac2-vuelta').value = '';
      
      if (casero) {
        document.getElementById('modal-casero-title').textContent = puedeEditar ? '‚úèÔ∏è Editar casero' : 'üëÅÔ∏è Ver casero';
        document.getElementById('casero-nombre').value = casero.nombre || '';
        document.getElementById('casero-email').value = casero.email || '';
        document.getElementById('casero-email').disabled = true;
        document.getElementById('casero-telefono').value = casero.telefono || '';
        
        // Cargar libranzas
        if (casero.libranzas) {
          document.getElementById('casero-libranza-dias').value = casero.libranzas.diasSemana || '2';
          ['L','M','X','J','V','S','D'].forEach(d => {
            document.getElementById(`casero-lib-${d}`).checked = (casero.libranzas.cuales || []).includes(d);
          });
          document.getElementById('casero-libranza-notas').value = casero.libranzas.notas || '';
        }
        
        // Cargar vacaciones
        if (casero.vacaciones) {
          document.getElementById('casero-vacaciones-dias').value = casero.vacaciones.diasAnuales || '30';
          document.getElementById('casero-vacaciones-notas').value = casero.vacaciones.notas || '';
          if (casero.vacaciones.bloque1) {
            document.getElementById('casero-vac1-salida').value = casero.vacaciones.bloque1.salida || '';
            document.getElementById('casero-vac1-vuelta').value = casero.vacaciones.bloque1.vuelta || '';
          }
          if (casero.vacaciones.bloque2) {
            document.getElementById('casero-vac2-salida').value = casero.vacaciones.bloque2.salida || '';
            document.getElementById('casero-vac2-vuelta').value = casero.vacaciones.bloque2.vuelta || '';
          }
        }
      } else {
        document.getElementById('modal-casero-title').textContent = 'üë§ Nuevo casero';
        document.getElementById('casero-email').disabled = false;
      }
      
      // Deshabilitar campos si no puede editar (solo ver)
      const camposEditables = [
        'casero-nombre', 'casero-telefono', 
        'casero-libranza-dias', 'casero-libranza-notas',
        'casero-vacaciones-dias', 'casero-vacaciones-notas',
        'casero-vac1-salida', 'casero-vac1-vuelta',
        'casero-vac2-salida', 'casero-vac2-vuelta'
      ];
      camposEditables.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = !puedeEditar;
      });
      // Deshabilitar checkboxes de d√≠as
      ['L','M','X','J','V','S','D'].forEach(d => {
        const el = document.getElementById(`casero-lib-${d}`);
        if (el) el.disabled = !puedeEditar;
      });
      // Deshabilitar checkboxes de permisos CVEB
      document.querySelectorAll('#permisos-rows-casero input[type="checkbox"]').forEach(cb => {
        cb.disabled = !puedeEditar;
      });
      // Mostrar/ocultar bot√≥n guardar
      document.getElementById('modal-casero-guardar').style.display = puedeEditar ? '' : 'none';
      
      modalCasero.classList.add('active');
    }

    document.getElementById('modal-casero-close').addEventListener('click', () => modalCasero.classList.remove('active'));
    document.getElementById('modal-casero-cancelar').addEventListener('click', () => modalCasero.classList.remove('active'));
    modalCasero.addEventListener('click', (e) => { if (e.target === modalCasero) modalCasero.classList.remove('active'); });

    formCasero.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-casero-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        // Recoger permisos CVEB de la matriz
        const permisos = recogerPermisos('perm', 'casero');
        
        // Recoger d√≠as de libranza seleccionados
        const diasLibranza = [];
        ['L','M','X','J','V','S','D'].forEach(d => {
          if (document.getElementById(`casero-lib-${d}`).checked) diasLibranza.push(d);
        });

        const data = {
          nombre: document.getElementById('casero-nombre').value,
          email: document.getElementById('casero-email').value.toLowerCase().trim(),
          telefono: document.getElementById('casero-telefono').value,
          permisos: permisos,
          libranzas: {
            diasSemana: document.getElementById('casero-libranza-dias').value,
            cuales: diasLibranza,
            notas: document.getElementById('casero-libranza-notas').value
          },
          vacaciones: {
            diasAnuales: parseInt(document.getElementById('casero-vacaciones-dias').value) || 30,
            notas: document.getElementById('casero-vacaciones-notas').value,
            bloque1: {
              salida: document.getElementById('casero-vac1-salida').value || '',
              vuelta: document.getElementById('casero-vac1-vuelta').value || ''
            },
            bloque2: {
              salida: document.getElementById('casero-vac2-salida').value || '',
              vuelta: document.getElementById('casero-vac2-vuelta').value || ''
            }
          },
          bienId: bienId,
          bienNombre: bienData.nombre || '',
          familiaId: bienData.familiaId || familiaId,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (!data.email) {
          alert('El email es obligatorio');
          btn.disabled = false; btn.textContent = 'Guardar';
          return;
        }
        
        const ref = db.collection('bienes').doc(bienId).collection('caseros');
        
        if (editingCaseroId) {
          await ref.doc(editingCaseroId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          data.activo = true;
          
          // Crear en subcolecci√≥n del bien
          await ref.add(data);
        }
        
        modalCasero.classList.remove('active');
        await loadCaseros();
        document.getElementById('count-caseros').textContent = caserosData.length;
        renderCaserosList();
        
        if (!editingCaseroId) {
          alert('‚úÖ Casero a√±adido.\n\nEmail: ' + data.email);
        }
      } catch (error) {
        console.error('Error guardando casero:', error);
        alert('Error al guardar: ' + error.message);
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-casero').addEventListener('click', async () => {
      if (!editingCaseroId || !confirm('¬øEliminar este casero? Perder√° acceso a este bien.')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('caseros').doc(editingCaseroId).delete();
        modalCasero.classList.remove('active');
        await loadCaseros();
        document.getElementById('count-caseros').textContent = caserosData.length;
        renderCaserosList();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ========== HOSTERS (Gerente) ==========
    let hostersData = [];
    let editingHosterId = null;

    async function cargarHosters() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('hosters').get();
        hostersData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        document.getElementById('count-hosters').textContent = hostersData.length;
        renderHostersList();
      } catch (e) {
        console.error('Error cargando hosters:', e);
      }
    }

    function renderHostersList() {
      const container = document.getElementById('lista-hosters');
      if (!container) return;

      if (hostersData.length === 0) {
        container.innerHTML = '<div class="empty-mini">Sin hosters asignados</div>';
        return;
      }

      const rolesLabels = {
        recepcion: 'üõéÔ∏è Recepci√≥n',
        limpieza: 'üßπ Limpieza',
        mantenimiento: 'üîß Mantenimiento',
        atencion: 'üí¨ Atenci√≥n',
        completo: '‚≠ê Completo'
      };

      container.innerHTML = hostersData.map(h => {
        const iniciales = h.nombre ? h.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
        
        // Contar m√≥dulos con acceso
        const permisos = h.permisos || {};
        const modulosConAcceso = new Set();
        Object.keys(permisos).forEach(key => {
          const modulo = key.split('_')[0];
          if (permisos[key]?.v) modulosConAcceso.add(modulo);
        });

        return `
          <div class="casero-card" style="border-left: 3px solid #4A5568;" onclick="abrirModalHoster(hostersData.find(x=>x.id==='${h.id}'))">
            <div class="casero-card-header">
              <div class="casero-avatar" style="background: linear-gradient(135deg, #4A5568, #2D3748);">${iniciales}</div>
              <div class="casero-info">
                <div class="casero-nombre">${h.nombre}</div>
                <div class="casero-email">${h.email}${h.telefono ? ' ¬∑ ' + h.telefono : ''}</div>
                <div style="font-size:0.7rem;color:#4A5568;margin-top:2px;">${rolesLabels[h.rol] || h.rol}</div>
              </div>
            </div>
            <div class="casero-permisos">
              ${[...modulosConAcceso].slice(0, 5).map(m => `
                <span class="casero-permiso-badge" style="background: #4A5568; color: white;">${seccionesLabels[m] || 'üìã'}</span>
              `).join('')}
              ${modulosConAcceso.size > 5 ? `<span class="casero-permiso-badge">+${modulosConAcceso.size - 5}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // MODAL HOSTER
    const modalHoster = document.getElementById('modal-hoster');
    const formHoster = document.getElementById('form-hoster');

    function abrirModalHoster(hoster = null) {
      // Si no es edici√≥n y no puede editar, bloquear creaci√≥n
      if (!hoster && !puedeEditar) {
        alert('Solo el creador del bien o un administrador puede a√±adir hosters.');
        return;
      }
      
      editingHosterId = hoster?.id || null;
      formHoster.reset();
      document.getElementById('btn-eliminar-hoster').classList.toggle('hidden', !hoster || !puedeEditar);
      
      // Renderizar matriz de permisos CVEB para Gerente
      const permisosActuales = hoster?.permisos || {};
      renderMatrizPermisos('permisos-rows-hoster', 'hperm', permisosActuales, 'hoster');
      
      // Reset libranzas a valores por defecto
      document.getElementById('hoster-libranza-dias').value = '2';
      ['L','M','X','J','V'].forEach(d => document.getElementById(`hoster-lib-${d}`).checked = false);
      ['S','D'].forEach(d => document.getElementById(`hoster-lib-${d}`).checked = true);
      document.getElementById('hoster-libranza-notas').value = '';
      document.getElementById('hoster-vacaciones-dias').value = '30';
      document.getElementById('hoster-vacaciones-notas').value = '';
      document.getElementById('hoster-vac1-salida').value = '';
      document.getElementById('hoster-vac1-vuelta').value = '';
      document.getElementById('hoster-vac2-salida').value = '';
      document.getElementById('hoster-vac2-vuelta').value = '';
      
      if (hoster) {
        document.getElementById('modal-hoster-title').textContent = puedeEditar ? '‚úèÔ∏è Editar hoster' : 'üëÅÔ∏è Ver hoster';
        document.getElementById('hoster-nombre').value = hoster.nombre || '';
        document.getElementById('hoster-email').value = hoster.email || '';
        document.getElementById('hoster-email').disabled = true;
        document.getElementById('hoster-telefono').value = hoster.telefono || '';
        document.getElementById('hoster-rol').value = hoster.rol || 'recepcion';
        
        // Cargar libranzas
        if (hoster.libranzas) {
          document.getElementById('hoster-libranza-dias').value = hoster.libranzas.diasSemana || '2';
          ['L','M','X','J','V','S','D'].forEach(d => {
            document.getElementById(`hoster-lib-${d}`).checked = (hoster.libranzas.cuales || []).includes(d);
          });
          document.getElementById('hoster-libranza-notas').value = hoster.libranzas.notas || '';
        }
        
        // Cargar vacaciones
        if (hoster.vacaciones) {
          document.getElementById('hoster-vacaciones-dias').value = hoster.vacaciones.diasAnuales || '30';
          document.getElementById('hoster-vacaciones-notas').value = hoster.vacaciones.notas || '';
          if (hoster.vacaciones.bloque1) {
            document.getElementById('hoster-vac1-salida').value = hoster.vacaciones.bloque1.salida || '';
            document.getElementById('hoster-vac1-vuelta').value = hoster.vacaciones.bloque1.vuelta || '';
          }
          if (hoster.vacaciones.bloque2) {
            document.getElementById('hoster-vac2-salida').value = hoster.vacaciones.bloque2.salida || '';
            document.getElementById('hoster-vac2-vuelta').value = hoster.vacaciones.bloque2.vuelta || '';
          }
        }
      } else {
        document.getElementById('modal-hoster-title').textContent = 'üè® Nuevo hoster';
        document.getElementById('hoster-email').disabled = false;
      }
      
      // Deshabilitar campos si no puede editar (solo ver)
      const camposEditables = [
        'hoster-nombre', 'hoster-telefono', 'hoster-rol',
        'hoster-libranza-dias', 'hoster-libranza-notas',
        'hoster-vacaciones-dias', 'hoster-vacaciones-notas',
        'hoster-vac1-salida', 'hoster-vac1-vuelta',
        'hoster-vac2-salida', 'hoster-vac2-vuelta'
      ];
      camposEditables.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = !puedeEditar;
      });
      // Deshabilitar checkboxes de d√≠as
      ['L','M','X','J','V','S','D'].forEach(d => {
        const el = document.getElementById(`hoster-lib-${d}`);
        if (el) el.disabled = !puedeEditar;
      });
      // Deshabilitar checkboxes de permisos CVEB
      document.querySelectorAll('#permisos-rows-hoster input[type="checkbox"]').forEach(cb => {
        cb.disabled = !puedeEditar;
      });
      // Mostrar/ocultar bot√≥n guardar
      document.getElementById('modal-hoster-guardar').style.display = puedeEditar ? '' : 'none';
      
      modalHoster.classList.add('active');
    }

    document.getElementById('modal-hoster-close').addEventListener('click', () => modalHoster.classList.remove('active'));
    document.getElementById('modal-hoster-cancelar').addEventListener('click', () => modalHoster.classList.remove('active'));
    modalHoster.addEventListener('click', (e) => { if (e.target === modalHoster) modalHoster.classList.remove('active'); });

    formHoster.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-hoster-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        // Recoger permisos CVEB de la matriz
        const permisos = recogerPermisos('hperm', 'hoster');
        
        // Recoger d√≠as de libranza seleccionados
        const diasLibranza = [];
        ['L','M','X','J','V','S','D'].forEach(d => {
          if (document.getElementById(`hoster-lib-${d}`).checked) diasLibranza.push(d);
        });

        const data = {
          nombre: document.getElementById('hoster-nombre').value,
          email: document.getElementById('hoster-email').value.toLowerCase().trim(),
          telefono: document.getElementById('hoster-telefono').value,
          rol: document.getElementById('hoster-rol').value,
          permisos: permisos,
          libranzas: {
            diasSemana: document.getElementById('hoster-libranza-dias').value,
            cuales: diasLibranza,
            notas: document.getElementById('hoster-libranza-notas').value
          },
          vacaciones: {
            diasAnuales: parseInt(document.getElementById('hoster-vacaciones-dias').value) || 30,
            notas: document.getElementById('hoster-vacaciones-notas').value,
            bloque1: {
              salida: document.getElementById('hoster-vac1-salida').value || '',
              vuelta: document.getElementById('hoster-vac1-vuelta').value || ''
            },
            bloque2: {
              salida: document.getElementById('hoster-vac2-salida').value || '',
              vuelta: document.getElementById('hoster-vac2-vuelta').value || ''
            }
          },
          bienId: bienId,
          bienNombre: bienData.nombre || '',
          familiaId: bienData.familiaId || familiaId,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (!data.email) {
          alert('El email es obligatorio');
          btn.disabled = false; btn.textContent = 'Guardar';
          return;
        }
        
        const ref = db.collection('bienes').doc(bienId).collection('hosters');
        
        if (editingHosterId) {
          await ref.doc(editingHosterId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          data.activo = true;
          await ref.add(data);
        }
        
        modalHoster.classList.remove('active');
        await cargarHosters();
        
        if (!editingHosterId) {
          alert('‚úÖ Hoster a√±adido.\n\nEmail: ' + data.email);
        }
      } catch (error) {
        console.error('Error guardando hoster:', error);
        alert('Error al guardar: ' + error.message);
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-hoster').addEventListener('click', async () => {
      if (!editingHosterId || !confirm('¬øEliminar este hoster? Perder√° acceso a este bien.')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('hosters').doc(editingHosterId).delete();
        modalHoster.classList.remove('active');
        await cargarHosters();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ========== GUARDAS (Capataz) ==========
    let guardasData = [];
    let editingGuardaId = null;

    async function cargarGuardas() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('guardas').get();
        guardasData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderGuardasList();
      } catch (error) {
        console.error('Error cargando guardas:', error);
      }
    }

    function renderGuardasList() {
      const container = document.getElementById('lista-guardas');
      if (!container) return;

      if (guardasData.length === 0) {
        container.innerHTML = '<div class="empty-mini">Sin guardas asignados</div>';
        return;
      }

      const rolesLabels = {
        guarda: 'üåæ Guarda',
        vigilante: 'üëÅÔ∏è Vigilante',
        jardinero: 'üå± Jardinero',
        mantenimiento: 'üîß Mantenimiento',
        completo: '‚≠ê Completo'
      };

      container.innerHTML = guardasData.map(g => {
        const iniciales = g.nombre ? g.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
        
        const permisos = g.permisos || {};
        const modulosConAcceso = new Set();
        Object.keys(permisos).forEach(key => {
          const modulo = key.split('_')[0];
          if (permisos[key]?.v) modulosConAcceso.add(modulo);
        });

        return `
          <div class="casero-card" style="border-left: 3px solid #6B8E23;" onclick="abrirModalGuarda(guardasData.find(x=>x.id==='${g.id}'))">
            <div class="casero-card-header">
              <div class="casero-avatar" style="background: linear-gradient(135deg, #6B8E23, #556B2F);">${iniciales}</div>
              <div class="casero-info">
                <div class="casero-nombre">${g.nombre}</div>
                <div class="casero-email">${g.email}${g.telefono ? ' ¬∑ ' + g.telefono : ''}</div>
                <div style="font-size:0.7rem;color:#6B8E23;margin-top:2px;">${rolesLabels[g.rol] || g.rol}</div>
              </div>
            </div>
            <div class="casero-permisos">
              ${[...modulosConAcceso].slice(0, 5).map(m => `
                <span class="casero-permiso-badge" style="background: #6B8E23; color: white;">${seccionesLabels[m] || 'üìã'}</span>
              `).join('')}
              ${modulosConAcceso.size > 5 ? `<span class="casero-permiso-badge">+${modulosConAcceso.size - 5}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // MODAL GUARDA
    const modalGuarda = document.getElementById('modal-guarda');
    const formGuarda = document.getElementById('form-guarda');

    function abrirModalGuarda(guarda = null) {
      // Si no es edici√≥n y no puede editar, bloquear creaci√≥n
      if (!guarda && !puedeEditar) {
        alert('Solo el creador del bien o un administrador puede a√±adir guardas.');
        return;
      }
      
      editingGuardaId = guarda?.id || null;
      formGuarda.reset();
      document.getElementById('btn-eliminar-guarda').classList.toggle('hidden', !guarda || !puedeEditar);
      
      // Renderizar matriz de permisos CVEB para Capataz
      const permisosActuales = guarda?.permisos || {};
      renderMatrizPermisos('permisos-rows-guarda', 'gperm', permisosActuales, 'guarda');
      
      // Reset libranzas a valores por defecto
      document.getElementById('guarda-libranza-dias').value = '2';
      ['L','M','X','J','V'].forEach(d => document.getElementById(`guarda-lib-${d}`).checked = false);
      ['S','D'].forEach(d => document.getElementById(`guarda-lib-${d}`).checked = true);
      document.getElementById('guarda-libranza-notas').value = '';
      document.getElementById('guarda-vacaciones-dias').value = '30';
      document.getElementById('guarda-vacaciones-notas').value = '';
      document.getElementById('guarda-vac1-salida').value = '';
      document.getElementById('guarda-vac1-vuelta').value = '';
      document.getElementById('guarda-vac2-salida').value = '';
      document.getElementById('guarda-vac2-vuelta').value = '';
      
      if (guarda) {
        document.getElementById('modal-guarda-title').textContent = puedeEditar ? '‚úèÔ∏è Editar guarda' : 'üëÅÔ∏è Ver guarda';
        document.getElementById('guarda-nombre').value = guarda.nombre || '';
        document.getElementById('guarda-email').value = guarda.email || '';
        document.getElementById('guarda-email').disabled = true;
        document.getElementById('guarda-telefono').value = guarda.telefono || '';
        document.getElementById('guarda-rol').value = guarda.rol || 'guarda';
        
        // Cargar libranzas
        if (guarda.libranzas) {
          document.getElementById('guarda-libranza-dias').value = guarda.libranzas.diasSemana || '2';
          ['L','M','X','J','V','S','D'].forEach(d => {
            document.getElementById(`guarda-lib-${d}`).checked = (guarda.libranzas.cuales || []).includes(d);
          });
          document.getElementById('guarda-libranza-notas').value = guarda.libranzas.notas || '';
        }
        
        // Cargar vacaciones
        if (guarda.vacaciones) {
          document.getElementById('guarda-vacaciones-dias').value = guarda.vacaciones.diasAnuales || '30';
          document.getElementById('guarda-vacaciones-notas').value = guarda.vacaciones.notas || '';
          if (guarda.vacaciones.bloque1) {
            document.getElementById('guarda-vac1-salida').value = guarda.vacaciones.bloque1.salida || '';
            document.getElementById('guarda-vac1-vuelta').value = guarda.vacaciones.bloque1.vuelta || '';
          }
          if (guarda.vacaciones.bloque2) {
            document.getElementById('guarda-vac2-salida').value = guarda.vacaciones.bloque2.salida || '';
            document.getElementById('guarda-vac2-vuelta').value = guarda.vacaciones.bloque2.vuelta || '';
          }
        }
      } else {
        document.getElementById('modal-guarda-title').textContent = 'üåæ Nuevo guarda';
        document.getElementById('guarda-email').disabled = false;
      }
      
      // Deshabilitar campos si no puede editar (solo ver)
      const camposEditables = [
        'guarda-nombre', 'guarda-telefono', 'guarda-rol',
        'guarda-libranza-dias', 'guarda-libranza-notas',
        'guarda-vacaciones-dias', 'guarda-vacaciones-notas',
        'guarda-vac1-salida', 'guarda-vac1-vuelta',
        'guarda-vac2-salida', 'guarda-vac2-vuelta'
      ];
      camposEditables.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = !puedeEditar;
      });
      // Deshabilitar checkboxes de d√≠as
      ['L','M','X','J','V','S','D'].forEach(d => {
        const el = document.getElementById(`guarda-lib-${d}`);
        if (el) el.disabled = !puedeEditar;
      });
      // Deshabilitar checkboxes de permisos CVEB
      document.querySelectorAll('#permisos-rows-guarda input[type="checkbox"]').forEach(cb => {
        cb.disabled = !puedeEditar;
      });
      // Mostrar/ocultar bot√≥n guardar
      document.getElementById('modal-guarda-guardar').style.display = puedeEditar ? '' : 'none';
      
      modalGuarda.classList.add('active');
    }

    document.getElementById('modal-guarda-close').addEventListener('click', () => modalGuarda.classList.remove('active'));
    document.getElementById('modal-guarda-cancelar').addEventListener('click', () => modalGuarda.classList.remove('active'));
    modalGuarda.addEventListener('click', (e) => { if (e.target === modalGuarda) modalGuarda.classList.remove('active'); });

    formGuarda.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-guarda-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        // Recoger permisos CVEB de la matriz
        const permisos = recogerPermisos('gperm', 'guarda');
        
        // Recoger d√≠as de libranza seleccionados
        const diasLibranza = [];
        ['L','M','X','J','V','S','D'].forEach(d => {
          if (document.getElementById(`guarda-lib-${d}`).checked) diasLibranza.push(d);
        });

        const data = {
          nombre: document.getElementById('guarda-nombre').value,
          email: document.getElementById('guarda-email').value.toLowerCase().trim(),
          telefono: document.getElementById('guarda-telefono').value,
          rol: document.getElementById('guarda-rol').value,
          permisos: permisos,
          libranzas: {
            diasSemana: document.getElementById('guarda-libranza-dias').value,
            cuales: diasLibranza,
            notas: document.getElementById('guarda-libranza-notas').value
          },
          vacaciones: {
            diasAnuales: parseInt(document.getElementById('guarda-vacaciones-dias').value) || 30,
            notas: document.getElementById('guarda-vacaciones-notas').value,
            bloque1: {
              salida: document.getElementById('guarda-vac1-salida').value || '',
              vuelta: document.getElementById('guarda-vac1-vuelta').value || ''
            },
            bloque2: {
              salida: document.getElementById('guarda-vac2-salida').value || '',
              vuelta: document.getElementById('guarda-vac2-vuelta').value || ''
            }
          },
          bienId: bienId,
          bienNombre: bienData.nombre || '',
          familiaId: bienData.familiaId || familiaId,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (!data.email) {
          alert('El email es obligatorio');
          btn.disabled = false; btn.textContent = 'Guardar';
          return;
        }
        
        const ref = db.collection('bienes').doc(bienId).collection('guardas');
        
        if (editingGuardaId) {
          await ref.doc(editingGuardaId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          data.activo = true;
          
          await ref.add(data);
        }
        
        modalGuarda.classList.remove('active');
        await cargarGuardas();
        
        if (!editingGuardaId) {
          alert('‚úÖ Guarda a√±adido.\n\nEmail: ' + data.email);
        }
      } catch (error) {
        console.error('Error guardando guarda:', error);
        alert('Error al guardar: ' + error.message);
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-guarda').addEventListener('click', async () => {
      if (!editingGuardaId || !confirm('¬øEliminar este guarda? Perder√° acceso a este bien.')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('guardas').doc(editingGuardaId).delete();
        modalGuarda.classList.remove('active');
        await cargarGuardas();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ============ CAT√ÅLOGO AJUAR ============
    let gruposAjuar = [];
    let lugaresAjuar = []; // Lugares para el desplegable de ubicaci√≥n
    let editingGrupoId = null;
    let editingArticuloId = null;
    let articuloFotoBase64 = null;

    async function cargarCatalogoAjuar() {
      // Mostrar cat√°logo de ajuar si:
      // 1. El bien tiene Mayordomo activo Y el m√≥dulo ajuar est√° activo
      // 2. O es un inmueble (siempre puede tener ajuar)
      const tieneModuloAjuar = bienData.mayordomoActivo && bienData.mayordomoModulos?.ajuar;
      const esInmueble = bienData.tipo === 'inmueble';
      
      if (!tieneModuloAjuar && !esInmueble) {
        document.getElementById('section-catalogo-ajuar').classList.add('hidden');
        return;
      }
      
      document.getElementById('section-catalogo-ajuar').classList.remove('hidden');
      
      try {
        // Cargar lugares de ajuar
        const lugaresSnap = await db.collection('bienes').doc(bienId).collection('lugaresAjuar').orderBy('nombre').get();
        lugaresAjuar = lugaresSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Cargar grupos y art√≠culos
        const snap = await db.collection('bienes').doc(bienId).collection('gruposAjuar').get();
        gruposAjuar = [];
        
        for (const doc of snap.docs) {
          const grupo = { id: doc.id, ...doc.data(), articulos: [] };
          
          // Cargar art√≠culos del grupo
          const artSnap = await db.collection('bienes').doc(bienId)
            .collection('gruposAjuar').doc(doc.id)
            .collection('articulos').get();
          
          grupo.articulos = artSnap.docs.map(a => ({ id: a.id, ...a.data() }));
          gruposAjuar.push(grupo);
        }
        
        renderGruposAjuar();
      } catch (error) {
        console.error('Error cargando cat√°logo:', error);
      }
    }

    function renderGruposAjuar() {
      const container = document.getElementById('lista-grupos-ajuar');
      const countEl = document.getElementById('count-articulos-ajuar');
      
      const totalArticulos = gruposAjuar.reduce((sum, g) => sum + (g.articulos?.length || 0), 0);
      countEl.textContent = totalArticulos;
      
      if (gruposAjuar.length === 0) {
        container.innerHTML = '<div class="empty-mini">Sin grupos creados</div>';
        return;
      }
      
      container.innerHTML = gruposAjuar.map(grupo => `
        <div class="ajuar-grupo" id="grupo-${grupo.id}">
          <div class="ajuar-grupo-header" onclick="toggleGrupoAjuar('${grupo.id}')">
            <div class="ajuar-grupo-info">
              <div class="ajuar-grupo-icon">${grupo.icono || 'üì¶'}</div>
              <div>
                <div class="ajuar-grupo-nombre">${grupo.nombre}</div>
                <div class="ajuar-grupo-count">${grupo.articulos?.length || 0} art√≠culos</div>
              </div>
            </div>
            <span class="ajuar-grupo-toggle">‚ñº</span>
          </div>
          <div class="ajuar-grupo-body">
            <div class="ajuar-articulos">
              ${(grupo.articulos || []).map(art => {
                const detalles = [art.ubicacion, art.marca].filter(Boolean).join(' ¬∑ ') || art.descripcion || '';
                return `
                <div class="ajuar-articulo" onclick="editarArticuloAjuar('${grupo.id}', '${art.id}')">
                  <div class="ajuar-articulo-thumb">
                    ${art.foto ? `<img src="${art.foto}">` : 'ü™ë'}
                  </div>
                  <div class="ajuar-articulo-info">
                    <div class="ajuar-articulo-nombre">${art.nombre}</div>
                    <div class="ajuar-articulo-desc">${detalles}</div>
                  </div>
                </div>
              `}).join('')}
            </div>
            <div class="ajuar-btn-add" onclick="abrirModalArticuloAjuar('${grupo.id}')">+ A√±adir art√≠culo</div>
            <button class="btn btn-sm btn-secondary" style="width:100%;margin-top:8px;" onclick="editarGrupoAjuar('${grupo.id}')">‚úèÔ∏è Editar grupo</button>
          </div>
        </div>
      `).join('');
    }

    function toggleGrupoAjuar(grupoId) {
      const el = document.getElementById('grupo-' + grupoId);
      if (el) el.classList.toggle('open');
    }

    // Buscador de Ajuar
    function filtrarAjuar(query) {
      query = query.toLowerCase().trim();
      const resultsEl = document.getElementById('ajuar-search-results');
      let totalEncontrados = 0;
      let gruposConResultados = 0;
      
      gruposAjuar.forEach(grupo => {
        const grupoEl = document.getElementById('grupo-' + grupo.id);
        if (!grupoEl) return;
        
        let articulosVisibles = 0;
        const articulos = grupoEl.querySelectorAll('.ajuar-articulo');
        
        articulos.forEach(artEl => {
          const nombre = artEl.querySelector('.ajuar-articulo-nombre')?.textContent.toLowerCase() || '';
          const desc = artEl.querySelector('.ajuar-articulo-desc')?.textContent.toLowerCase() || '';
          
          if (query === '' || nombre.includes(query) || desc.includes(query)) {
            artEl.classList.remove('hidden');
            articulosVisibles++;
            totalEncontrados++;
          } else {
            artEl.classList.add('hidden');
          }
        });
        
        // Abrir/cerrar grupo seg√∫n resultados
        if (query !== '') {
          if (articulosVisibles > 0) {
            grupoEl.classList.add('open');
            grupoEl.classList.remove('no-results');
            gruposConResultados++;
          } else {
            grupoEl.classList.remove('open');
            grupoEl.classList.add('no-results');
          }
        } else {
          grupoEl.classList.remove('no-results');
        }
      });
      
      // Mostrar contador de resultados
      if (query !== '') {
        resultsEl.style.display = 'block';
        resultsEl.textContent = totalEncontrados === 0 
          ? 'Sin resultados para "' + query + '"'
          : totalEncontrados + ' art√≠culo' + (totalEncontrados !== 1 ? 's' : '') + ' en ' + gruposConResultados + ' grupo' + (gruposConResultados !== 1 ? 's' : '');
      } else {
        resultsEl.style.display = 'none';
      }
    }

    function limpiarBusquedaAjuar() {
      const input = document.getElementById('ajuar-search-input');
      input.value = '';
      filtrarAjuar('');
      input.focus();
    }

    // Modal Grupo
    function abrirModalGrupoAjuar() {
      editingGrupoId = null;
      document.getElementById('grupo-ajuar-id').value = '';
      document.getElementById('grupo-ajuar-nombre').value = '';
      document.getElementById('grupo-ajuar-desc').value = '';
      document.querySelector('input[name="grupo-icono"][value="ü™ë"]').checked = true;
      document.getElementById('btn-eliminar-grupo-ajuar').classList.add('hidden');
      document.getElementById('modal-grupo-ajuar-title').textContent = 'üì¶ Nuevo grupo';
      document.getElementById('modal-grupo-ajuar').classList.add('active');
    }

    function editarGrupoAjuar(grupoId) {
      const grupo = gruposAjuar.find(g => g.id === grupoId);
      if (!grupo) return;
      
      editingGrupoId = grupoId;
      document.getElementById('grupo-ajuar-id').value = grupoId;
      document.getElementById('grupo-ajuar-nombre').value = grupo.nombre || '';
      document.getElementById('grupo-ajuar-desc').value = grupo.descripcion || '';
      
      const iconRadio = document.querySelector(`input[name="grupo-icono"][value="${grupo.icono || 'üì¶'}"]`);
      if (iconRadio) iconRadio.checked = true;
      
      document.getElementById('btn-eliminar-grupo-ajuar').classList.remove('hidden');
      document.getElementById('modal-grupo-ajuar-title').textContent = '‚úèÔ∏è Editar grupo';
      document.getElementById('modal-grupo-ajuar').classList.add('active');
    }

    function cerrarModalGrupoAjuar() {
      document.getElementById('modal-grupo-ajuar').classList.remove('active');
    }

    async function guardarGrupoAjuar() {
      const nombre = document.getElementById('grupo-ajuar-nombre').value.trim();
      if (!nombre) { alert('Introduce un nombre'); return; }
      
      const icono = document.querySelector('input[name="grupo-icono"]:checked')?.value || 'üì¶';
      const descripcion = document.getElementById('grupo-ajuar-desc').value.trim();
      
      try {
        const data = { nombre, icono, descripcion, actualizadoEn: firebase.firestore.FieldValue.serverTimestamp() };
        
        if (editingGrupoId) {
          await db.collection('bienes').doc(bienId).collection('gruposAjuar').doc(editingGrupoId).update(data);
        } else {
          data.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('bienes').doc(bienId).collection('gruposAjuar').add(data);
        }
        
        cerrarModalGrupoAjuar();
        await cargarCatalogoAjuar();
      } catch (error) {
        console.error('Error guardando grupo:', error);
        alert('Error al guardar');
      }
    }

    async function eliminarGrupoAjuar() {
      if (!editingGrupoId || !confirm('¬øEliminar este grupo y todos sus art√≠culos?')) return;
      
      try {
        // Eliminar art√≠culos primero
        const artSnap = await db.collection('bienes').doc(bienId)
          .collection('gruposAjuar').doc(editingGrupoId)
          .collection('articulos').get();
        
        const batch = db.batch();
        artSnap.docs.forEach(doc => batch.delete(doc.ref));
        batch.delete(db.collection('bienes').doc(bienId).collection('gruposAjuar').doc(editingGrupoId));
        await batch.commit();
        
        cerrarModalGrupoAjuar();
        await cargarCatalogoAjuar();
      } catch (error) {
        console.error('Error eliminando grupo:', error);
        alert('Error al eliminar');
      }
    }

    // Modal Art√≠culo
    function abrirModalArticuloAjuar(grupoId) {
      editingArticuloId = null;
      articuloFotoBase64 = null;
      document.getElementById('articulo-ajuar-id').value = '';
      document.getElementById('articulo-ajuar-grupo-id').value = grupoId;
      document.getElementById('articulo-ajuar-nombre').value = '';
      document.getElementById('articulo-ajuar-desc').value = '';
      document.getElementById('articulo-ajuar-marca').value = '';
      document.getElementById('articulo-ajuar-procedencia').value = '';
      document.getElementById('articulo-foto-preview').innerHTML = 'üì∑ Click para subir foto';
      document.getElementById('btn-eliminar-articulo-ajuar').classList.add('hidden');
      document.getElementById('modal-articulo-ajuar-title').textContent = 'ü™ë Nuevo art√≠culo';
      
      // Cargar select de lugares
      cargarSelectLugares('');
      
      document.getElementById('modal-articulo-ajuar').classList.add('active');
    }

    function editarArticuloAjuar(grupoId, articuloId) {
      const grupo = gruposAjuar.find(g => g.id === grupoId);
      const articulo = grupo?.articulos?.find(a => a.id === articuloId);
      if (!articulo) return;
      
      editingArticuloId = articuloId;
      articuloFotoBase64 = articulo.foto || null;
      
      document.getElementById('articulo-ajuar-id').value = articuloId;
      document.getElementById('articulo-ajuar-grupo-id').value = grupoId;
      document.getElementById('articulo-ajuar-nombre').value = articulo.nombre || '';
      document.getElementById('articulo-ajuar-desc').value = articulo.descripcion || '';
      document.getElementById('articulo-ajuar-marca').value = articulo.marca || '';
      document.getElementById('articulo-ajuar-procedencia').value = articulo.procedencia || '';
      
      // Cargar select de lugares con el valor actual
      cargarSelectLugares(articulo.ubicacion || '');
      
      if (articulo.foto) {
        document.getElementById('articulo-foto-preview').innerHTML = `<img src="${articulo.foto}">`;
      } else {
        document.getElementById('articulo-foto-preview').innerHTML = 'üì∑ Click para subir foto';
      }
      
      document.getElementById('btn-eliminar-articulo-ajuar').classList.remove('hidden');
      document.getElementById('modal-articulo-ajuar-title').textContent = '‚úèÔ∏è Editar art√≠culo';
      document.getElementById('modal-articulo-ajuar').classList.add('active');
    }

    // Cargar select de lugares din√°micamente
    function cargarSelectLugares(valorActual) {
      const select = document.getElementById('articulo-ajuar-ubicacion');
      let html = '<option value="">-- Selecciona lugar --</option>';
      
      lugaresAjuar.forEach(lugar => {
        const selected = lugar.nombre === valorActual ? 'selected' : '';
        html += `<option value="${lugar.nombre}" ${selected}>${lugar.nombre}</option>`;
      });
      
      // Si hay un valor que no est√° en la lista, a√±adirlo
      if (valorActual && !lugaresAjuar.find(l => l.nombre === valorActual)) {
        html += `<option value="${valorActual}" selected>${valorActual} (sin guardar)</option>`;
      }
      
      select.innerHTML = html;
    }

    // Crear nuevo lugar desde el modal de art√≠culo
    async function crearNuevoLugarAjuar() {
      const nombre = prompt('Nombre del nuevo lugar:');
      if (!nombre || !nombre.trim()) return;
      
      const nombreTrim = nombre.trim();
      
      // Verificar si ya existe
      if (lugaresAjuar.find(l => l.nombre.toLowerCase() === nombreTrim.toLowerCase())) {
        alert('Ya existe un lugar con ese nombre');
        // Seleccionarlo en el dropdown
        document.getElementById('articulo-ajuar-ubicacion').value = nombreTrim;
        return;
      }
      
      try {
        // Guardar en Firebase
        await db.collection('bienes').doc(bienId).collection('lugaresAjuar').add({
          nombre: nombreTrim,
          creadoEn: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // A√±adir a la lista local
        lugaresAjuar.push({ nombre: nombreTrim });
        lugaresAjuar.sort((a, b) => a.nombre.localeCompare(b.nombre));
        
        // Recargar el select y seleccionar el nuevo
        cargarSelectLugares(nombreTrim);
        
      } catch (error) {
        console.error('Error creando lugar:', error);
        alert('Error al crear el lugar');
      }
    }

    // ========== MODAL GESTI√ìN DE LUGARES ==========
    function abrirModalLugaresAjuar() {
      renderLugaresAjuar();
      document.getElementById('nuevo-lugar-nombre').value = '';
      document.getElementById('modal-lugares-ajuar').classList.add('active');
    }

    function cerrarModalLugaresAjuar() {
      document.getElementById('modal-lugares-ajuar').classList.remove('active');
    }

    function renderLugaresAjuar() {
      const container = document.getElementById('lista-lugares-ajuar');
      
      if (lugaresAjuar.length === 0) {
        container.innerHTML = '<div class="empty-mini">Sin lugares definidos</div>';
        return;
      }
      
      // Contar art√≠culos por lugar
      const conteoLugares = {};
      gruposAjuar.forEach(grupo => {
        (grupo.articulos || []).forEach(art => {
          if (art.ubicacion) {
            conteoLugares[art.ubicacion] = (conteoLugares[art.ubicacion] || 0) + 1;
          }
        });
      });
      
      container.innerHTML = lugaresAjuar.map(lugar => `
        <div class="lugar-item">
          <div>
            <div class="lugar-item-nombre">üìç ${lugar.nombre}</div>
            <div class="lugar-item-count">${conteoLugares[lugar.nombre] || 0} art√≠culos</div>
          </div>
          <button class="lugar-item-del" onclick="confirmarEliminarLugar('${lugar.id}')" title="Eliminar">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    async function guardarNuevoLugar() {
      const input = document.getElementById('nuevo-lugar-nombre');
      const nombre = input.value.trim();
      
      if (!nombre) {
        alert('Introduce un nombre para el lugar');
        return;
      }
      
      // Verificar si ya existe
      if (lugaresAjuar.find(l => l.nombre.toLowerCase() === nombre.toLowerCase())) {
        alert('Ya existe un lugar con ese nombre');
        return;
      }
      
      try {
        // Guardar en Firebase
        const docRef = await db.collection('bienes').doc(bienId).collection('lugaresAjuar').add({
          nombre: nombre,
          creadoEn: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // A√±adir a la lista local
        lugaresAjuar.push({ id: docRef.id, nombre: nombre });
        lugaresAjuar.sort((a, b) => a.nombre.localeCompare(b.nombre));
        
        // Limpiar input y refrescar lista
        input.value = '';
        renderLugaresAjuar();
        
      } catch (error) {
        console.error('Error creando lugar:', error);
        alert('Error al crear el lugar');
      }
    }

    async function confirmarEliminarLugar(lugarId) {
      const lugar = lugaresAjuar.find(l => l.id === lugarId);
      if (!lugar) return;
      
      // Contar art√≠culos en este lugar
      let articulosEnLugar = 0;
      gruposAjuar.forEach(grupo => {
        (grupo.articulos || []).forEach(art => {
          if (art.ubicacion === lugar.nombre) articulosEnLugar++;
        });
      });
      
      let msg = `¬øEliminar el lugar "${lugar.nombre}"?`;
      if (articulosEnLugar > 0) {
        msg += `\n\n‚ö†Ô∏è Hay ${articulosEnLugar} art√≠culo(s) con esta ubicaci√≥n. Sus ubicaciones quedar√°n vac√≠as.`;
      }
      
      if (!confirm(msg)) return;
      
      try {
        await db.collection('bienes').doc(bienId).collection('lugaresAjuar').doc(lugarId).delete();
        
        // Remover de la lista local
        lugaresAjuar = lugaresAjuar.filter(l => l.id !== lugarId);
        renderLugaresAjuar();
        
      } catch (error) {
        console.error('Error eliminando lugar:', error);
        alert('Error al eliminar');
      }
    }

    function cerrarModalArticuloAjuar() {
      document.getElementById('modal-articulo-ajuar').classList.remove('active');
    }

    function previewArticuloFoto(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        articuloFotoBase64 = e.target.result;
        document.getElementById('articulo-foto-preview').innerHTML = `<img src="${articuloFotoBase64}">`;
      };
      reader.readAsDataURL(file);
    }

    async function guardarArticuloAjuar() {
      const grupoId = document.getElementById('articulo-ajuar-grupo-id').value;
      const nombre = document.getElementById('articulo-ajuar-nombre').value.trim();
      if (!nombre) { alert('Introduce un nombre'); return; }
      
      try {
        const data = {
          nombre,
          descripcion: document.getElementById('articulo-ajuar-desc').value.trim(),
          ubicacion: document.getElementById('articulo-ajuar-ubicacion').value.trim(),
          marca: document.getElementById('articulo-ajuar-marca').value.trim(),
          procedencia: document.getElementById('articulo-ajuar-procedencia').value.trim(),
          foto: articuloFotoBase64 || null,
          actualizadoEn: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('gruposAjuar').doc(grupoId).collection('articulos');
        
        if (editingArticuloId) {
          await ref.doc(editingArticuloId).update(data);
        } else {
          data.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        
        cerrarModalArticuloAjuar();
        await cargarCatalogoAjuar();
      } catch (error) {
        console.error('Error guardando art√≠culo:', error);
        alert('Error al guardar');
      }
    }

    async function eliminarArticuloAjuar() {
      const grupoId = document.getElementById('articulo-ajuar-grupo-id').value;
      if (!editingArticuloId || !confirm('¬øEliminar este art√≠culo?')) return;
      
      try {
        await db.collection('bienes').doc(bienId)
          .collection('gruposAjuar').doc(grupoId)
          .collection('articulos').doc(editingArticuloId).delete();
        
        cerrarModalArticuloAjuar();
        await cargarCatalogoAjuar();
      } catch (error) {
        console.error('Error eliminando art√≠culo:', error);
        alert('Error al eliminar');
      }
    }

    // ============ NORMAS PARA EXTERNOS ============
    
    // Variables temporales para apartados en bien.html
    let apartadosExternosTemp = [];
    let apartadosMiembrosTemp = [];
    
    async function cargarNormasExternos() {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('normasExternos')
          .orderBy('orden', 'asc')
          .get();
        
        normasExternosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderNormasExternos();
      } catch (e) {
        console.log('Sin normas de externos o error:', e.message);
        normasExternosData = [];
        renderNormasExternos();
      }
    }

    function renderNormasExternos() {
      const container = document.getElementById('normas-externos-container');
      const countEl = document.getElementById('count-normas');
      
      if (!container) return;
      
      // Contar total de preceptos (directos + en apartados)
      const totalPreceptos = normasExternosData.reduce((sum, cap) => {
        const directos = cap.preceptos?.length || 0;
        const enApartados = (cap.apartados || []).reduce((s, ap) => s + (ap.preceptos?.length || 0), 0);
        return sum + directos + enApartados;
      }, 0);
      if (countEl) countEl.textContent = totalPreceptos;
      
      if (normasExternosData.length === 0) {
        container.innerHTML = `
          <div class="normas-empty">
            <div class="normas-empty-icon">üìù</div>
            <p>Sin normas definidas</p>
            <p style="font-size: 0.8rem;">A√±ade cap√≠tulos o copia una plantilla base</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = normasExternosData.map((cap, capIdx) => {
        const preceptosDirectos = cap.preceptos || [];
        const apartados = cap.apartados || [];
        const totalApartados = apartados.reduce((s, ap) => s + (ap.preceptos?.length || 0), 0);
        const total = preceptosDirectos.length + totalApartados;
        
        return `
          <div class="normas-capitulo" id="norma-cap-${capIdx}">
            <div class="normas-capitulo-header" onclick="toggleCapituloNorma(${capIdx})">
              <div class="normas-capitulo-titulo">
                <span class="normas-capitulo-num">${capIdx + 1}</span>
                <span>${cap.titulo || 'Sin t√≠tulo'}</span>
                <span style="font-size: 0.75rem; color: var(--text-muted);">(${total}${apartados.length > 0 ? `, ${apartados.length} apt.` : ''})</span>
              </div>
              <div class="normas-capitulo-actions" onclick="event.stopPropagation()" ${!puedeEditar ? 'style="display:none;"' : ''}>
                <button onclick="editarCapituloNorma(${capIdx})" title="Editar">‚úèÔ∏è</button>
                <button onclick="moverCapituloNorma(${capIdx}, -1)" title="Subir" ${capIdx === 0 ? 'disabled style="opacity:0.3"' : ''}>‚¨ÜÔ∏è</button>
                <button onclick="moverCapituloNorma(${capIdx}, 1)" title="Bajar" ${capIdx === normasExternosData.length - 1 ? 'disabled style="opacity:0.3"' : ''}>‚¨áÔ∏è</button>
              </div>
            </div>
            <div class="normas-capitulo-body">
              ${preceptosDirectos.length > 0 ? preceptosDirectos.map((prec, pIdx) => `
                <div class="normas-precepto">
                  <span class="normas-precepto-num">${capIdx + 1}.${pIdx + 1}</span>
                  <span>${typeof prec === 'string' ? prec : prec.texto}</span>
                </div>
              `).join('') : ''}
              ${apartados.length > 0 ? apartados.map((ap, apIdx) => `
                <div class="normas-apartado">
                  <div class="normas-apartado-titulo">${capIdx + 1}.${apIdx + 1} ${ap.titulo}</div>
                  ${(ap.preceptos || []).map((prec, precIdx) => `
                    <div class="normas-precepto">
                      <span class="normas-precepto-num">${capIdx + 1}.${apIdx + 1}.${precIdx + 1}</span>
                      <span>${typeof prec === 'string' ? prec : prec.texto}</span>
                    </div>
                  `).join('') || '<p style="color:var(--text-muted);font-size:0.85rem;">Sin preceptos</p>'}
                </div>
              `).join('') : ''}
              ${preceptosDirectos.length === 0 && apartados.length === 0 ? '<p style="color: var(--text-muted); font-size: 0.85rem;">Sin contenido</p>' : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleCapituloNorma(idx) {
      const el = document.getElementById(`norma-cap-${idx}`);
      if (el) el.classList.toggle('open');
    }

    function abrirModalCapituloNorma() {
      if (!puedeEditar) {
        alert('Solo el creador del bien o un administrador puede editar esta informaci√≥n.');
        return;
      }
      
      editingCapituloNormaIdx = null;
      apartadosExternosTemp = [];
      document.getElementById('modal-capitulo-norma-titulo').textContent = '‚ûï Nuevo cap√≠tulo';
      document.getElementById('norma-capitulo-titulo').value = '';
      document.getElementById('norma-capitulo-preceptos').value = '';
      renderApartadosExternosModal();
      document.getElementById('btn-eliminar-capitulo-norma').classList.add('hidden');
      document.getElementById('modal-capitulo-norma').classList.add('active');
    }

    function editarCapituloNorma(idx) {
      if (!puedeEditar) {
        alert('Solo el creador del bien o un administrador puede editar esta informaci√≥n.');
        return;
      }
      
      const cap = normasExternosData[idx];
      if (!cap) return;
      
      editingCapituloNormaIdx = idx;
      apartadosExternosTemp = JSON.parse(JSON.stringify(cap.apartados || []));
      
      document.getElementById('modal-capitulo-norma-titulo').textContent = '‚úèÔ∏è Editar cap√≠tulo';
      document.getElementById('norma-capitulo-titulo').value = cap.titulo || '';
      
      const preceptosTexto = (cap.preceptos || [])
        .map(p => typeof p === 'string' ? p : p.texto)
        .join('\n');
      document.getElementById('norma-capitulo-preceptos').value = preceptosTexto;
      
      renderApartadosExternosModal();
      document.getElementById('btn-eliminar-capitulo-norma').classList.remove('hidden');
      document.getElementById('modal-capitulo-norma').classList.add('active');
    }

    function renderApartadosExternosModal() {
      const container = document.getElementById('bien-apartados-container-externos');
      if (!container) return;
      
      if (apartadosExternosTemp.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = apartadosExternosTemp.map((ap, idx) => {
        const preceptosTexto = (ap.preceptos || []).map(p => typeof p === 'string' ? p : p.texto).join('\n');
        return `
          <div class="bien-apartado-item">
            <div class="bien-apartado-header">
              <span class="bien-apartado-num">${idx + 1}</span>
              <input type="text" value="${ap.titulo || ''}" placeholder="T√≠tulo del apartado" onchange="actualizarApartadoExternosTitulo(${idx}, this.value)">
              <div class="bien-apartado-actions">
                <button type="button" onclick="moverApartadoExternos(${idx}, -1)" title="Subir" ${idx === 0 ? 'disabled style="opacity:0.3"' : ''}>‚¨ÜÔ∏è</button>
                <button type="button" onclick="moverApartadoExternos(${idx}, 1)" title="Bajar" ${idx === apartadosExternosTemp.length - 1 ? 'disabled style="opacity:0.3"' : ''}>‚¨áÔ∏è</button>
                <button type="button" onclick="eliminarApartadoExternos(${idx})" title="Eliminar" style="color:#dc3545;">üóëÔ∏è</button>
              </div>
            </div>
            <div class="bien-apartado-body">
              <p>Preceptos del apartado (uno por l√≠nea):</p>
              <textarea onchange="actualizarApartadoExternosPreceptos(${idx}, this.value)" placeholder="Precepto 1&#10;Precepto 2">${preceptosTexto}</textarea>
            </div>
          </div>
        `;
      }).join('');
    }

    function agregarApartadoExternos() {
      apartadosExternosTemp.push({ orden: apartadosExternosTemp.length + 1, titulo: '', preceptos: [] });
      renderApartadosExternosModal();
    }

    function eliminarApartadoExternos(idx) {
      apartadosExternosTemp.splice(idx, 1);
      apartadosExternosTemp = apartadosExternosTemp.map((ap, i) => ({ ...ap, orden: i + 1 }));
      renderApartadosExternosModal();
    }

    function moverApartadoExternos(idx, direccion) {
      const nuevoIdx = idx + direccion;
      if (nuevoIdx < 0 || nuevoIdx >= apartadosExternosTemp.length) return;
      [apartadosExternosTemp[idx], apartadosExternosTemp[nuevoIdx]] = [apartadosExternosTemp[nuevoIdx], apartadosExternosTemp[idx]];
      apartadosExternosTemp = apartadosExternosTemp.map((ap, i) => ({ ...ap, orden: i + 1 }));
      renderApartadosExternosModal();
    }

    function actualizarApartadoExternosTitulo(idx, valor) {
      apartadosExternosTemp[idx].titulo = valor;
    }

    function actualizarApartadoExternosPreceptos(idx, texto) {
      apartadosExternosTemp[idx].preceptos = texto.split('\n').map(l => l.trim()).filter(l => l).map((t, i) => ({ orden: i + 1, texto: t }));
    }

    function cerrarModalCapituloNorma() {
      document.getElementById('modal-capitulo-norma').classList.remove('active');
    }

    async function guardarCapituloNorma() {
      const titulo = document.getElementById('norma-capitulo-titulo').value.trim();
      const preceptosTexto = document.getElementById('norma-capitulo-preceptos').value.trim();
      
      if (!titulo) {
        alert('El t√≠tulo es obligatorio');
        return;
      }
      
      // Validar apartados
      for (let i = 0; i < apartadosExternosTemp.length; i++) {
        if (!apartadosExternosTemp[i].titulo.trim()) {
          alert(`El apartado ${i + 1} necesita un t√≠tulo`);
          return;
        }
      }
      
      const preceptos = preceptosTexto.split('\n').map(l => l.trim()).filter(l => l).map((texto, idx) => ({ orden: idx + 1, texto }));
      
      const dataCapitulo = {
        titulo,
        preceptos,
        apartados: apartadosExternosTemp.map((ap, i) => ({
          orden: i + 1,
          titulo: ap.titulo.trim(),
          preceptos: ap.preceptos || []
        })),
        actualizadoEn: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        if (editingCapituloNormaIdx !== null) {
          const capId = normasExternosData[editingCapituloNormaIdx].id;
          await db.collection('bienes').doc(bienId).collection('normasExternos').doc(capId).update(dataCapitulo);
        } else {
          dataCapitulo.orden = normasExternosData.length + 1;
          dataCapitulo.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('bienes').doc(bienId).collection('normasExternos').add(dataCapitulo);
        }
        
        cerrarModalCapituloNorma();
        await cargarNormasExternos();
      } catch (e) {
        console.error('Error guardando cap√≠tulo:', e);
        alert('Error al guardar: ' + e.message);
      }
    }

    async function eliminarCapituloNorma() {
      if (editingCapituloNormaIdx === null) return;
      if (!confirm('¬øEliminar este cap√≠tulo y todo su contenido?')) return;
      
      try {
        const capId = normasExternosData[editingCapituloNormaIdx].id;
        await db.collection('bienes').doc(bienId).collection('normasExternos').doc(capId).delete();
        cerrarModalCapituloNorma();
        await cargarNormasExternos();
        await reordenarCapitulosNormas();
      } catch (e) {
        console.error('Error eliminando cap√≠tulo:', e);
        alert('Error al eliminar');
      }
    }

    async function moverCapituloNorma(idx, direccion) {
      const nuevoIdx = idx + direccion;
      if (nuevoIdx < 0 || nuevoIdx >= normasExternosData.length) return;
      
      const temp = normasExternosData[idx];
      normasExternosData[idx] = normasExternosData[nuevoIdx];
      normasExternosData[nuevoIdx] = temp;
      
      await reordenarCapitulosNormas();
      renderNormasExternos();
    }

    async function reordenarCapitulosNormas() {
      try {
        const batch = db.batch();
        normasExternosData.forEach((cap, idx) => {
          const ref = db.collection('bienes').doc(bienId).collection('normasExternos').doc(cap.id);
          batch.update(ref, { orden: idx + 1 });
        });
        await batch.commit();
      } catch (e) {
        console.error('Error reordenando cap√≠tulos:', e);
      }
    }

    // ============ COPIAR PLANTILLA DE NORMAS ============
    
    function copiarPlantillaNormas() {
      if (!puedeEditar) {
        alert('Solo el creador del bien o un administrador puede editar esta informaci√≥n.');
        return;
      }
      
      document.getElementById('select-tipo-plantilla').value = '';
      document.getElementById('plantilla-preview').style.display = 'none';
      document.getElementById('check-reemplazar-normas').checked = false;
      document.getElementById('btn-confirmar-copiar').disabled = true;
      document.getElementById('modal-copiar-plantilla').classList.add('active');
      
      // Listener para cambio de tipo
      document.getElementById('select-tipo-plantilla').onchange = async function() {
        const tipo = this.value;
        if (!tipo) {
          document.getElementById('plantilla-preview').style.display = 'none';
          document.getElementById('btn-confirmar-copiar').disabled = true;
          return;
        }
        
        // Cargar plantilla
        await cargarPreviewPlantilla(tipo);
      };
    }

    function cerrarModalCopiarPlantilla() {
      document.getElementById('modal-copiar-plantilla').classList.remove('active');
    }

    async function cargarPreviewPlantilla(tipo) {
      const previewContainer = document.getElementById('plantilla-preview-content');
      previewContainer.innerHTML = '<p style="color: var(--text-muted);">Cargando...</p>';
      document.getElementById('plantilla-preview').style.display = 'block';
      
      try {
        // Verificar si ya est√° en cache
        if (!plantillasNormasCache[tipo]) {
          const doc = await db.collection('familias').doc(familiaId)
            .collection('plantillasNormasExternos').doc(tipo).get();
          
          if (doc.exists) {
            plantillasNormasCache[tipo] = doc.data();
          } else {
            plantillasNormasCache[tipo] = null;
          }
        }
        
        const plantilla = plantillasNormasCache[tipo];
        
        if (!plantilla || !plantilla.elementos || plantilla.elementos.length === 0) {
          previewContainer.innerHTML = '<p style="color: var(--text-muted);">No hay plantilla definida para este tipo</p><p style="font-size:0.8rem;color:var(--text-muted);">Puedes crearla en Admin Rama ‚Üí Plantillas ‚Üí Externos</p>';
          document.getElementById('btn-confirmar-copiar').disabled = true;
          return;
        }
        
        // Filtrar cap√≠tulos para preview
        const elementos = plantilla.elementos || [];
        const capitulos = elementos.filter(el => el.tipo === 'capitulo');
        
        previewContainer.innerHTML = capitulos.length > 0 
          ? capitulos.map((cap, idx) => {
              const siguientes = elementos.slice(elementos.indexOf(cap) + 1);
              const contenido = [];
              for (const el of siguientes) {
                if (el.tipo === 'capitulo') break;
                if (el.tipo === 'linea' || el.tipo === 'apartado') contenido.push(el);
              }
              return `
                <div style="margin-bottom: 10px;">
                  <strong>${idx + 1}. ${cap.texto}</strong>
                  <ul style="margin: 4px 0 0 20px; font-size: 0.8rem; color: var(--text-light);">
                    ${contenido.slice(0, 3).map(p => `<li>${p.texto}</li>`).join('')}
                    ${contenido.length > 3 ? `<li style="color:var(--text-muted);">... y ${contenido.length - 3} m√°s</li>` : ''}
                  </ul>
                </div>
              `;
            }).join('')
          : `<p style="color: var(--text-muted);">${elementos.length} elementos en la plantilla</p>`;
        
        document.getElementById('btn-confirmar-copiar').disabled = false;
        
      } catch (e) {
        console.error('Error cargando plantilla:', e);
        previewContainer.innerHTML = '<p style="color: var(--error);">Error al cargar la plantilla</p>';
        document.getElementById('btn-confirmar-copiar').disabled = true;
      }
    }

    async function confirmarCopiarPlantilla() {
      const tipo = document.getElementById('select-tipo-plantilla').value;
      const reemplazar = document.getElementById('check-reemplazar-normas').checked;
      
      if (!tipo || !plantillasNormasCache[tipo]) {
        alert('Selecciona una plantilla v√°lida');
        return;
      }
      
      const plantilla = plantillasNormasCache[tipo];
      const elementos = plantilla.elementos || [];
      
      if (elementos.length === 0) {
        alert('La plantilla est√° vac√≠a');
        return;
      }
      
      try {
        const batch = db.batch();
        
        // Si reemplazar, eliminar las existentes primero
        if (reemplazar && normasExternosData.length > 0) {
          for (const cap of normasExternosData) {
            const ref = db.collection('bienes').doc(bienId).collection('normasExternos').doc(cap.id);
            batch.delete(ref);
          }
        }
        
        // Determinar orden inicial
        const ordenInicial = reemplazar ? 1 : normasExternosData.length + 1;
        
        // Convertir elementos planos a estructura de cap√≠tulos
        const capitulos = [];
        let capituloActual = null;
        
        elementos.forEach(el => {
          if (el.tipo === 'capitulo') {
            if (capituloActual) capitulos.push(capituloActual);
            capituloActual = { titulo: el.texto, preceptos: [], apartados: [] };
          } else if (capituloActual) {
            if (el.tipo === 'apartado') {
              capituloActual.apartados.push({ titulo: el.texto, preceptos: [] });
            } else if (el.tipo === 'linea' || el.tipo === 'sublinea' || el.tipo === 'detalle') {
              if (capituloActual.apartados.length > 0) {
                capituloActual.apartados[capituloActual.apartados.length - 1].preceptos.push({ texto: el.texto });
              } else {
                capituloActual.preceptos.push({ texto: el.texto });
              }
            }
          }
        });
        if (capituloActual) capitulos.push(capituloActual);
        
        // A√±adir cap√≠tulos de la plantilla
        capitulos.forEach((cap, idx) => {
          const ref = db.collection('bienes').doc(bienId).collection('normasExternos').doc();
          batch.set(ref, {
            titulo: cap.titulo,
            orden: ordenInicial + idx,
            preceptos: cap.preceptos,
            apartados: cap.apartados.map((ap, apIdx) => ({
              orden: apIdx + 1,
              titulo: ap.titulo,
              preceptos: ap.preceptos
            })),
            copiadoDePlantilla: tipo,
            creadoEn: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        
        // Marcar el bien como usando esta plantilla
        const bienRef = db.collection('bienes').doc(bienId);
        batch.update(bienRef, { normasUsanPlantilla: tipo });
        
        await batch.commit();
        
        cerrarModalCopiarPlantilla();
        await cargarNormasExternos();
        
        alert(`‚úÖ Plantilla copiada: ${capitulos.length} cap√≠tulos`);
        
      } catch (e) {
        console.error('Error copiando plantilla:', e);
        alert('Error al copiar: ' + e.message);
      }
    }

    // ============ NORMAS DE USO PARA MIEMBROS ============
    
    async function cargarNormasMiembros() {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('normasMiembros')
          .orderBy('orden', 'asc')
          .get();
        
        normasMiembrosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderNormasMiembros();
      } catch (e) {
        console.log('Sin normas de miembros o error:', e.message);
        normasMiembrosData = [];
        renderNormasMiembros();
      }
    }

    function renderNormasMiembros() {
      const container = document.getElementById('normas-miembros-container');
      const countEl = document.getElementById('count-normas-uso');
      
      if (!container) return;
      
      // Contar total de preceptos (directos + en apartados)
      const totalPreceptos = normasMiembrosData.reduce((sum, cap) => {
        const directos = cap.preceptos?.length || 0;
        const enApartados = (cap.apartados || []).reduce((s, ap) => s + (ap.preceptos?.length || 0), 0);
        return sum + directos + enApartados;
      }, 0);
      if (countEl) countEl.textContent = totalPreceptos;
      
      if (normasMiembrosData.length === 0) {
        container.innerHTML = `
          <div class="normas-empty">
            <div class="normas-empty-icon">üìñ</div>
            <p>Sin pautas de uso y convivencia</p>
            <p style="font-size: 0.8rem;">A√±ade cap√≠tulos o copia una plantilla base</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = normasMiembrosData.map((cap, capIdx) => {
        const preceptosDirectos = cap.preceptos || [];
        const apartados = cap.apartados || [];
        const totalApartados = apartados.reduce((s, ap) => s + (ap.preceptos?.length || 0), 0);
        const total = preceptosDirectos.length + totalApartados;
        
        return `
          <div class="normas-capitulo open" id="norma-miembros-cap-${capIdx}">
            <div class="normas-capitulo-header" onclick="toggleCapituloNormaMiembros(${capIdx})">
              <div class="normas-capitulo-titulo">
                <span class="normas-capitulo-num" style="background: var(--terracotta);">${capIdx + 1}</span>
                <span>${cap.titulo || 'Sin t√≠tulo'}</span>
                <span style="font-size: 0.75rem; color: var(--text-muted);">(${total}${apartados.length > 0 ? `, ${apartados.length} apt.` : ''})</span>
              </div>
              <div class="normas-capitulo-actions" onclick="event.stopPropagation()" ${!puedeEditar ? 'style="display:none;"' : ''}>
                <button onclick="editarCapituloNormaMiembros(${capIdx})" title="Editar">‚úèÔ∏è</button>
                <button onclick="moverCapituloNormaMiembros(${capIdx}, -1)" title="Subir" ${capIdx === 0 ? 'disabled style="opacity:0.3"' : ''}>‚¨ÜÔ∏è</button>
                <button onclick="moverCapituloNormaMiembros(${capIdx}, 1)" title="Bajar" ${capIdx === normasMiembrosData.length - 1 ? 'disabled style="opacity:0.3"' : ''}>‚¨áÔ∏è</button>
              </div>
            </div>
            <div class="normas-capitulo-body" style="display:block;">
              ${preceptosDirectos.length > 0 ? preceptosDirectos.map((prec, pIdx) => `
                <div class="normas-precepto">
                  <span class="normas-precepto-num">${capIdx + 1}.${pIdx + 1}</span>
                  <span>${typeof prec === 'string' ? prec : prec.texto}</span>
                </div>
              `).join('') : ''}
              ${apartados.length > 0 ? apartados.map((ap, apIdx) => `
                <div class="normas-apartado miembros">
                  <div class="normas-apartado-titulo">${capIdx + 1}.${apIdx + 1} ${ap.titulo}</div>
                  ${(ap.preceptos || []).map((prec, precIdx) => `
                    <div class="normas-precepto">
                      <span class="normas-precepto-num">${capIdx + 1}.${apIdx + 1}.${precIdx + 1}</span>
                      <span>${typeof prec === 'string' ? prec : prec.texto}</span>
                    </div>
                  `).join('') || '<p style="color:var(--text-muted);font-size:0.85rem;">Sin preceptos</p>'}
                </div>
              `).join('') : ''}
              ${preceptosDirectos.length === 0 && apartados.length === 0 ? '<p style="color: var(--text-muted); font-size: 0.85rem;">Sin contenido</p>' : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleCapituloNormaMiembros(idx) {
      const el = document.getElementById(`norma-miembros-cap-${idx}`);
      if (el) el.classList.toggle('open');
    }

    function abrirModalCapituloNormaMiembros() {
      if (!puedeEditar) {
        alert('Solo el creador del bien o un administrador puede editar esta informaci√≥n.');
        return;
      }
      
      editingCapituloNormaMiembrosIdx = null;
      apartadosMiembrosTemp = [];
      document.getElementById('modal-capitulo-norma-miembros-titulo').textContent = '‚ûï Nuevo cap√≠tulo';
      document.getElementById('norma-miembros-capitulo-titulo').value = '';
      document.getElementById('norma-miembros-capitulo-preceptos').value = '';
      renderApartadosMiembrosModal();
      document.getElementById('btn-eliminar-capitulo-norma-miembros').classList.add('hidden');
      document.getElementById('modal-capitulo-norma-miembros').classList.add('active');
    }

    function editarCapituloNormaMiembros(idx) {
      if (!puedeEditar) {
        alert('Solo el creador del bien o un administrador puede editar esta informaci√≥n.');
        return;
      }
      
      const cap = normasMiembrosData[idx];
      if (!cap) return;
      
      editingCapituloNormaMiembrosIdx = idx;
      apartadosMiembrosTemp = JSON.parse(JSON.stringify(cap.apartados || []));
      
      document.getElementById('modal-capitulo-norma-miembros-titulo').textContent = '‚úèÔ∏è Editar cap√≠tulo';
      document.getElementById('norma-miembros-capitulo-titulo').value = cap.titulo || '';
      
      const preceptosTexto = (cap.preceptos || [])
        .map(p => typeof p === 'string' ? p : p.texto)
        .join('\n');
      document.getElementById('norma-miembros-capitulo-preceptos').value = preceptosTexto;
      
      renderApartadosMiembrosModal();
      document.getElementById('btn-eliminar-capitulo-norma-miembros').classList.remove('hidden');
      document.getElementById('modal-capitulo-norma-miembros').classList.add('active');
    }

    function renderApartadosMiembrosModal() {
      const container = document.getElementById('bien-apartados-container-miembros');
      if (!container) return;
      
      if (apartadosMiembrosTemp.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = apartadosMiembrosTemp.map((ap, idx) => {
        const preceptosTexto = (ap.preceptos || []).map(p => typeof p === 'string' ? p : p.texto).join('\n');
        return `
          <div class="bien-apartado-item">
            <div class="bien-apartado-header miembros">
              <span class="bien-apartado-num miembros">${idx + 1}</span>
              <input type="text" value="${ap.titulo || ''}" placeholder="T√≠tulo del apartado" onchange="actualizarApartadoMiembrosTitulo(${idx}, this.value)">
              <div class="bien-apartado-actions">
                <button type="button" onclick="moverApartadoMiembros(${idx}, -1)" title="Subir" ${idx === 0 ? 'disabled style="opacity:0.3"' : ''}>‚¨ÜÔ∏è</button>
                <button type="button" onclick="moverApartadoMiembros(${idx}, 1)" title="Bajar" ${idx === apartadosMiembrosTemp.length - 1 ? 'disabled style="opacity:0.3"' : ''}>‚¨áÔ∏è</button>
                <button type="button" onclick="eliminarApartadoMiembros(${idx})" title="Eliminar" style="color:#dc3545;">üóëÔ∏è</button>
              </div>
            </div>
            <div class="bien-apartado-body">
              <p>Preceptos del apartado (uno por l√≠nea):</p>
              <textarea onchange="actualizarApartadoMiembrosPreceptos(${idx}, this.value)" placeholder="Precepto 1&#10;Precepto 2">${preceptosTexto}</textarea>
            </div>
          </div>
        `;
      }).join('');
    }

    function agregarApartadoMiembros() {
      apartadosMiembrosTemp.push({ orden: apartadosMiembrosTemp.length + 1, titulo: '', preceptos: [] });
      renderApartadosMiembrosModal();
    }

    function eliminarApartadoMiembros(idx) {
      apartadosMiembrosTemp.splice(idx, 1);
      apartadosMiembrosTemp = apartadosMiembrosTemp.map((ap, i) => ({ ...ap, orden: i + 1 }));
      renderApartadosMiembrosModal();
    }

    function moverApartadoMiembros(idx, direccion) {
      const nuevoIdx = idx + direccion;
      if (nuevoIdx < 0 || nuevoIdx >= apartadosMiembrosTemp.length) return;
      [apartadosMiembrosTemp[idx], apartadosMiembrosTemp[nuevoIdx]] = [apartadosMiembrosTemp[nuevoIdx], apartadosMiembrosTemp[idx]];
      apartadosMiembrosTemp = apartadosMiembrosTemp.map((ap, i) => ({ ...ap, orden: i + 1 }));
      renderApartadosMiembrosModal();
    }

    function actualizarApartadoMiembrosTitulo(idx, valor) {
      apartadosMiembrosTemp[idx].titulo = valor;
    }

    function actualizarApartadoMiembrosPreceptos(idx, texto) {
      apartadosMiembrosTemp[idx].preceptos = texto.split('\n').map(l => l.trim()).filter(l => l).map((t, i) => ({ orden: i + 1, texto: t }));
    }

    function cerrarModalCapituloNormaMiembros() {
      document.getElementById('modal-capitulo-norma-miembros').classList.remove('active');
    }

    async function guardarCapituloNormaMiembros() {
      const titulo = document.getElementById('norma-miembros-capitulo-titulo').value.trim();
      const preceptosTexto = document.getElementById('norma-miembros-capitulo-preceptos').value.trim();
      
      if (!titulo) {
        alert('El t√≠tulo es obligatorio');
        return;
      }
      
      // Validar apartados
      for (let i = 0; i < apartadosMiembrosTemp.length; i++) {
        if (!apartadosMiembrosTemp[i].titulo.trim()) {
          alert(`El apartado ${i + 1} necesita un t√≠tulo`);
          return;
        }
      }
      
      const preceptos = preceptosTexto.split('\n').map(l => l.trim()).filter(l => l).map((texto, idx) => ({ orden: idx + 1, texto }));
      
      const dataCapitulo = {
        titulo,
        preceptos,
        apartados: apartadosMiembrosTemp.map((ap, i) => ({
          orden: i + 1,
          titulo: ap.titulo.trim(),
          preceptos: ap.preceptos || []
        })),
        actualizadoEn: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        if (editingCapituloNormaMiembrosIdx !== null) {
          const capId = normasMiembrosData[editingCapituloNormaMiembrosIdx].id;
          await db.collection('bienes').doc(bienId).collection('normasMiembros').doc(capId).update(dataCapitulo);
        } else {
          dataCapitulo.orden = normasMiembrosData.length + 1;
          dataCapitulo.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('bienes').doc(bienId).collection('normasMiembros').add(dataCapitulo);
        }
        
        cerrarModalCapituloNormaMiembros();
        await cargarNormasMiembros();
      } catch (e) {
        console.error('Error guardando cap√≠tulo miembros:', e);
        alert('Error al guardar: ' + e.message);
      }
    }

    async function eliminarCapituloNormaMiembros() {
      if (editingCapituloNormaMiembrosIdx === null) return;
      if (!confirm('¬øEliminar este cap√≠tulo y todo su contenido?')) return;
      
      try {
        const capId = normasMiembrosData[editingCapituloNormaMiembrosIdx].id;
        await db.collection('bienes').doc(bienId).collection('normasMiembros').doc(capId).delete();
        cerrarModalCapituloNormaMiembros();
        await cargarNormasMiembros();
        await reordenarCapitulosNormasMiembros();
      } catch (e) {
        console.error('Error eliminando cap√≠tulo:', e);
        alert('Error al eliminar');
      }
    }

    async function moverCapituloNormaMiembros(idx, direccion) {
      const nuevoIdx = idx + direccion;
      if (nuevoIdx < 0 || nuevoIdx >= normasMiembrosData.length) return;
      
      const temp = normasMiembrosData[idx];
      normasMiembrosData[idx] = normasMiembrosData[nuevoIdx];
      normasMiembrosData[nuevoIdx] = temp;
      
      await reordenarCapitulosNormasMiembros();
      renderNormasMiembros();
    }

    async function reordenarCapitulosNormasMiembros() {
      try {
        const batch = db.batch();
        normasMiembrosData.forEach((cap, idx) => {
          const ref = db.collection('bienes').doc(bienId).collection('normasMiembros').doc(cap.id);
          batch.update(ref, { orden: idx + 1 });
        });
        await batch.commit();
      } catch (e) {
        console.error('Error reordenando cap√≠tulos:', e);
      }
    }

    // ============ COPIAR PLANTILLA DE NORMAS PARA MIEMBROS ============
    
    function getAddonActivoParaPlantilla() {
      // Detectar qu√© add-on est√° activo en el bien
      if (bienData.mayordomo?.activo) return 'mayordomo';
      if (bienData.gerente?.activo) return 'gerente';
      if (bienData.capataz?.activo) return 'capataz';
      return 'mayordomo'; // Por defecto
    }

    async function copiarPlantillaNormasMiembros() {
      if (!puedeEditar) {
        alert('Solo el creador del bien o un administrador puede editar esta informaci√≥n.');
        return;
      }
      
      const addonActivo = getAddonActivoParaPlantilla();
      const addonsConfig = {
        mayordomo: { icono: 'üè†', nombre: 'Mayordomo' },
        gerente: { icono: 'üè®', nombre: 'Gerente' },
        capataz: { icono: 'üåæ', nombre: 'Capataz' }
      };
      const config = addonsConfig[addonActivo];
      
      document.getElementById('plantilla-miembros-tipo-label').textContent = `${config.icono} ${config.nombre}`;
      document.getElementById('check-reemplazar-normas-miembros').checked = false;
      document.getElementById('btn-confirmar-copiar-miembros').disabled = true;
      document.getElementById('plantilla-miembros-preview').style.display = 'none';
      document.getElementById('plantilla-miembros-empty').style.display = 'block';
      document.getElementById('plantilla-miembros-empty').innerHTML = '<p>Cargando plantilla...</p>';
      
      document.getElementById('modal-copiar-plantilla-miembros').classList.add('active');
      
      // Cargar plantilla
      await cargarPreviewPlantillaMiembros(addonActivo);
    }

    function cerrarModalCopiarPlantillaMiembros() {
      document.getElementById('modal-copiar-plantilla-miembros').classList.remove('active');
    }

    async function cargarPreviewPlantillaMiembros(addon) {
      const previewContainer = document.getElementById('plantilla-miembros-preview-content');
      const emptyContainer = document.getElementById('plantilla-miembros-empty');
      
      try {
        if (!plantillasNormasMiembrosCache[addon]) {
          const doc = await db.collection('familias').doc(familiaId)
            .collection('plantillasNormasFamiliares').doc(addon).get();
          
          plantillasNormasMiembrosCache[addon] = doc.exists ? doc.data() : null;
        }
        
        const plantilla = plantillasNormasMiembrosCache[addon];
        
        if (!plantilla || !plantilla.elementos || plantilla.elementos.length === 0) {
          emptyContainer.innerHTML = '<p style="color: var(--text-muted);">No hay plantilla definida para este add-on</p><p style="font-size:0.8rem;color:var(--text-muted);">Puedes crearla en Admin Rama ‚Üí Plantillas ‚Üí Familiares</p>';
          document.getElementById('btn-confirmar-copiar-miembros').disabled = true;
          return;
        }
        
        emptyContainer.style.display = 'none';
        document.getElementById('plantilla-miembros-preview').style.display = 'block';
        
        // Filtrar solo cap√≠tulos y apartados para preview
        const elementos = plantilla.elementos || [];
        const capitulos = elementos.filter(el => el.tipo === 'capitulo');
        
        previewContainer.innerHTML = capitulos.length > 0 
          ? capitulos.map((cap, idx) => {
              const siguientes = elementos.slice(elementos.indexOf(cap) + 1);
              const contenido = [];
              for (const el of siguientes) {
                if (el.tipo === 'capitulo') break;
                if (el.tipo === 'linea' || el.tipo === 'apartado') contenido.push(el);
              }
              return `
                <div style="margin-bottom: 10px;">
                  <strong>${idx + 1}. ${cap.texto}</strong>
                  <ul style="margin: 4px 0 0 20px; font-size: 0.8rem; color: var(--text-light);">
                    ${contenido.slice(0, 3).map(p => `<li>${p.texto}</li>`).join('')}
                    ${contenido.length > 3 ? `<li style="color:var(--text-muted);">... y ${contenido.length - 3} m√°s</li>` : ''}
                  </ul>
                </div>
              `;
            }).join('')
          : `<p style="color: var(--text-muted);">${elementos.length} elementos en la plantilla</p>`;
        
        document.getElementById('btn-confirmar-copiar-miembros').disabled = false;
        
      } catch (e) {
        console.error('Error cargando plantilla miembros:', e);
        emptyContainer.innerHTML = '<p style="color: var(--error);">Error al cargar la plantilla</p>';
        document.getElementById('btn-confirmar-copiar-miembros').disabled = true;
      }
    }

    async function confirmarCopiarPlantillaMiembros() {
      const addonActivo = getAddonActivoParaPlantilla();
      const reemplazar = document.getElementById('check-reemplazar-normas-miembros').checked;
      
      if (!plantillasNormasMiembrosCache[addonActivo]) {
        alert('No hay plantilla disponible');
        return;
      }
      
      const plantilla = plantillasNormasMiembrosCache[addonActivo];
      const elementos = plantilla.elementos || [];
      
      if (elementos.length === 0) {
        alert('La plantilla est√° vac√≠a');
        return;
      }
      
      try {
        const batch = db.batch();
        
        if (reemplazar && normasMiembrosData.length > 0) {
          for (const cap of normasMiembrosData) {
            const ref = db.collection('bienes').doc(bienId).collection('normasMiembros').doc(cap.id);
            batch.delete(ref);
          }
        }
        
        const ordenInicial = reemplazar ? 1 : normasMiembrosData.length + 1;
        
        // Convertir elementos planos a estructura de cap√≠tulos
        const capitulos = [];
        let capituloActual = null;
        
        elementos.forEach(el => {
          if (el.tipo === 'capitulo') {
            if (capituloActual) capitulos.push(capituloActual);
            capituloActual = { titulo: el.texto, preceptos: [], apartados: [] };
          } else if (capituloActual) {
            if (el.tipo === 'apartado') {
              capituloActual.apartados.push({ titulo: el.texto, preceptos: [] });
            } else if (el.tipo === 'linea' || el.tipo === 'sublinea' || el.tipo === 'detalle') {
              if (capituloActual.apartados.length > 0) {
                capituloActual.apartados[capituloActual.apartados.length - 1].preceptos.push({ texto: el.texto });
              } else {
                capituloActual.preceptos.push({ texto: el.texto });
              }
            }
          }
        });
        if (capituloActual) capitulos.push(capituloActual);
        
        capitulos.forEach((cap, idx) => {
          const ref = db.collection('bienes').doc(bienId).collection('normasMiembros').doc();
          batch.set(ref, {
            titulo: cap.titulo,
            orden: ordenInicial + idx,
            preceptos: cap.preceptos,
            apartados: cap.apartados.map((ap, apIdx) => ({
              orden: apIdx + 1,
              titulo: ap.titulo,
              preceptos: ap.preceptos
            })),
            copiadoDePlantilla: addonActivo,
            creadoEn: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        
        const bienRef = db.collection('bienes').doc(bienId);
        batch.update(bienRef, { normasMiembrosUsanPlantilla: addonActivo });
        
        await batch.commit();
        
        cerrarModalCopiarPlantillaMiembros();
        await cargarNormasMiembros();
        
        alert(`‚úÖ Plantilla copiada: ${capitulos.length} cap√≠tulos`);
        
      } catch (e) {
        console.error('Error copiando plantilla miembros:', e);
        alert('Error al copiar: ' + e.message);
      }
    }
  </script>
</body>
</html>
