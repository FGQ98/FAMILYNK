<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Bien</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: var(--cream-dark); color: var(--text); }
    .header-actions { display: flex; gap: 8px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      color: white;
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
      border: 1px solid var(--cream-dark);
    }

    .btn-secondary:hover { background: var(--cream-dark); }

    .btn-mayordomo {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%);
      color: white;
    }

    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
    .btn-danger { background: var(--error); color: white; }

    .main { max-width: 1200px; margin: 0 auto; padding: 24px; }

    .layout-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 24px;
    }

    @media (max-width: 900px) { .layout-grid { grid-template-columns: 1fr; } }

    .bien-hero {
      background: var(--white);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }

    .bien-hero-image {
      height: 200px;
      background: linear-gradient(135deg, var(--sage-light) 0%, var(--sage) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5rem;
      position: relative;
    }

    .bien-hero-image img { width: 100%; height: 100%; object-fit: cover; }

    .bien-hero-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--mayordomo);
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 700;
    }

    .bien-hero-body { padding: 20px; }

    .bien-tipo-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--sage-dark);
      font-weight: 700;
      margin-bottom: 4px;
    }

    .bien-nombre {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .bien-ubicacion {
      color: var(--text-light);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    .bien-meta { display: flex; gap: 16px; flex-wrap: wrap; }
    .bien-meta-item { font-size: 0.8rem; color: var(--text-muted); }
    .bien-meta-item strong { color: var(--text); }

    .collapsible-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .collapsible-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }

    .collapsible-header:hover { background: var(--cream-medium); }

    .collapsible-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .collapsible-count {
      font-size: 0.75rem;
      background: var(--sage-muted);
      color: var(--sage-dark);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .collapsible-toggle {
      font-size: 1.2rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .collapsible-section.open .collapsible-toggle { transform: rotate(180deg); }
    .collapsible-body { padding: 0 20px 20px; display: none; }
    .collapsible-section.open .collapsible-body { display: block; }

    .info-list { display: flex; flex-direction: column; gap: 8px; }

    .info-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .info-item-icon { font-size: 1.3rem; }
    .info-item-content { flex: 1; }
    .info-item-title { font-weight: 600; font-size: 0.9rem; }
    .info-item-subtitle { font-size: 0.75rem; color: var(--text-muted); }

    .info-item-action {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      opacity: 0.5;
      padding: 4px;
      text-decoration: none;
    }

    .info-item-action:hover { opacity: 1; }

    .normas-box {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-line;
    }

    .mayordomo-section { margin-bottom: 24px; }

    .mayordomo-header {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%);
      border-radius: var(--radius-lg);
      padding: 20px;
      color: white;
      margin-bottom: 16px;
    }

    .mayordomo-header h2 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      margin-bottom: 4px;
    }

    .mayordomo-header p { font-size: 0.85rem; opacity: 0.9; }

    .toggle-modulo {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--white);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .toggle-modulo:hover { transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    .toggle-modulo input { width: 16px; height: 16px; accent-color: var(--mayordomo); }
    .toggle-modulo input:checked + span { color: var(--mayordomo); font-weight: 600; }

    .modulos-operativos { display: flex; flex-direction: column; gap: 16px; }

    .modulo-panel {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .modulo-panel-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--cream-dark);
    }

    .modulo-panel-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modulo-panel-body { padding: 16px 20px; }

    /* CALENDARIO */
    .calendario-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .calendario-mes {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
    }

    .calendario-nav-btns { display: flex; gap: 4px; }

    .calendario-nav-btn {
      background: var(--cream);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1rem;
    }

    .calendario-nav-btn:hover { background: var(--cream-dark); }

    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .calendario-dia-header {
      text-align: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .calendario-dia {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
    }

    .calendario-dia:hover { background: var(--cream-dark); }
    .calendario-dia.otro-mes { color: var(--text-muted); opacity: 0.5; }
    .calendario-dia.hoy { background: var(--sage-muted); font-weight: 700; }
    .calendario-dia.reservado { background: var(--sage); color: white; }
    /* Colores por tipo de reserva - se generan din√°micamente */
    .calendario-dia.reservado { color: white; }

    .reservas-lista { margin-top: 16px; }

    .reservas-lista-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .reserva-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      border-left: 4px solid var(--sage);
      cursor: pointer;
      transition: all 0.2s;
    }

    .reserva-item:hover { background: var(--cream-dark); }
    /* Bordes lista reservas - se generan din√°micamente */

    .reserva-fecha { text-align: center; min-width: 50px; }
    .reserva-fecha-dia { font-size: 1.3rem; font-weight: 700; color: var(--sage-dark); }
    .reserva-fecha-mes { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); }
    .reserva-info { flex: 1; }
    .reserva-quien { font-weight: 600; font-size: 0.9rem; }
    .reserva-periodo { font-size: 0.75rem; color: var(--text-muted); }

    .nidos-leyenda {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--cream-dark);
    }

    .nido-leyenda-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; }
    .nido-leyenda-color { width: 12px; height: 12px; border-radius: 3px; }

    /* Otros m√≥dulos */
    .inventario-alerta {
      background: var(--warning);
      color: white;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      margin-bottom: 12px;
    }

    .inventario-list, .mantenimiento-list, .gastos-list, .servicios-list, .eventos-list, .limpieza-checklist {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .inventario-item, .mantenimiento-item, .gasto-item, .servicio-item, .evento-item, .limpieza-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .inventario-item.bajo { border-left: 3px solid var(--error); }
    .inventario-item-nombre, .servicio-nombre { flex: 1; font-size: 0.9rem; }
    .inventario-item-stock { font-size: 0.8rem; color: var(--text-muted); }
    .inventario-item-stock.bajo { color: var(--error); font-weight: 600; }

    .mantenimiento-tipo, .evento-icono, .servicio-icono { font-size: 1.3rem; }
    .mantenimiento-info, .evento-info { flex: 1; }
    .mantenimiento-titulo, .evento-nombre { font-weight: 600; font-size: 0.9rem; }
    .mantenimiento-fecha, .evento-fecha { font-size: 0.75rem; color: var(--text-muted); }

    .mantenimiento-badge, .evento-tipo {
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .mantenimiento-badge.programado { background: var(--sage-muted); color: var(--sage-dark); }
    .mantenimiento-badge.pendiente { background: var(--warning); color: white; }
    .evento-tipo { background: var(--terracotta-muted); color: var(--terracotta); }

    .limpieza-item { cursor: pointer; transition: all 0.2s; }
    .limpieza-item:hover { background: var(--cream-dark); }
    .limpieza-item.done { opacity: 0.5; }
    .limpieza-item.done .limpieza-texto { text-decoration: line-through; }

    .limpieza-check {
      width: 22px;
      height: 22px;
      border: 2px solid var(--sage);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: white;
    }

    .limpieza-item.done .limpieza-check { background: var(--sage); }
    .limpieza-texto { font-size: 0.9rem; }

    .gastos-resumen {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .gasto-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .gasto-stat-valor { font-size: 1.5rem; font-weight: 700; color: var(--sage-dark); }
    .gasto-stat-label { font-size: 0.75rem; color: var(--text-muted); }
    .gasto-item-nombre { flex: 1; font-size: 0.9rem; }
    .gasto-item-valor { font-weight: 600; color: var(--terracotta); }

    /* Gastos mejorado */
    .gastos-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--cream-dark);
    }

    .gastos-tab {
      padding: 10px 16px;
      background: none;
      border: none;
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .gastos-tab:hover { color: var(--text); }
    .gastos-tab.active { color: var(--terracotta); border-bottom-color: var(--terracotta); }

    .gastos-tab-content { display: none; }
    .gastos-tab-content.active { display: block; }

    .gastos-periodo-selector {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .gastos-periodo-btn {
      padding: 6px 12px;
      background: var(--cream-medium);
      border: none;
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gastos-periodo-btn:hover { background: var(--cream-dark); }
    .gastos-periodo-btn.active { background: var(--terracotta); color: white; }

    .gastos-resumen {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .gasto-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .gasto-stat-valor { font-size: 1.5rem; font-weight: 700; color: var(--terracotta); }
    .gasto-stat-label { font-size: 0.7rem; color: var(--text-muted); }

    .gastos-por-categoria {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .gasto-cat-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--cream-medium);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
    }

    .gasto-cat-chip-valor { font-weight: 700; color: var(--terracotta); }

    .gastos-list { display: flex; flex-direction: column; gap: 8px; }

    .gasto-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .gasto-item:hover { background: var(--cream-dark); }

    .gasto-item-icon { font-size: 1.3rem; }

    .gasto-item-info { flex: 1; }
    .gasto-item-concepto { font-weight: 600; font-size: 0.9rem; }
    .gasto-item-meta { font-size: 0.7rem; color: var(--text-muted); }

    .gasto-item-importe {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--terracotta);
    }

    .gasto-item-generador {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: var(--mayordomo-muted);
      color: var(--mayordomo);
      border-radius: var(--radius-sm);
    }

    /* Tabla de reparto */
    .reparto-info {
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      padding: 12px;
      margin-bottom: 16px;
      font-size: 0.8rem;
      color: var(--sage-dark);
    }

    .reparto-table {
      width: 100%;
      border-collapse: collapse;
    }

    .reparto-table th {
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 12px;
      border-bottom: 2px solid var(--cream-dark);
    }

    .reparto-table td {
      padding: 12px;
      border-bottom: 1px solid var(--cream-dark);
      font-size: 0.9rem;
    }

    .reparto-table tr:last-child td { border-bottom: none; }

    .reparto-nido-nombre {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .reparto-nido-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .reparto-input {
      width: 70px;
      padding: 6px 10px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      text-align: right;
    }

    .reparto-input:focus {
      outline: none;
      border-color: var(--sage);
    }

    .reparto-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      margin-top: 12px;
    }

    .reparto-total-label { font-weight: 600; }
    .reparto-total-valor { font-size: 1.1rem; font-weight: 700; }
    .reparto-total-valor.ok { color: var(--success); }
    .reparto-total-valor.error { color: var(--error); }

    .reparto-desglose {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--cream-dark);
    }

    .reparto-desglose-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .reparto-desglose-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 0.85rem;
    }

    .reparto-desglose-item span:last-child { font-weight: 600; color: var(--terracotta); }

    /* Caseros */
    .caseros-list { display: flex; flex-direction: column; gap: 10px; }

    .casero-card {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .casero-card:hover { background: var(--cream-dark); }

    .casero-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .casero-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--mayordomo);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
    }

    .casero-info { flex: 1; }
    .casero-nombre { font-weight: 600; font-size: 0.95rem; }
    .casero-email { font-size: 0.75rem; color: var(--text-muted); }

    .casero-permisos {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .casero-permiso-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: var(--sage-muted);
      color: var(--sage-dark);
      border-radius: var(--radius-sm);
    }

    .casero-permiso-badge.limitado {
      background: var(--terracotta-muted);
      color: var(--terracotta);
    }

    /* Matriz permisos en modal */
    .permisos-matrix {
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .permisos-matrix-header {
      display: grid;
      grid-template-columns: 1fr repeat(4, 40px);
      gap: 4px;
      padding: 10px 12px;
      background: var(--cream-dark);
      font-size: 0.7rem;
      font-weight: 600;
      text-align: center;
    }

    .permisos-matrix-header span:first-child { text-align: left; }

    .permisos-matrix-row {
      display: grid;
      grid-template-columns: 1fr repeat(4, 40px);
      gap: 4px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--cream-dark);
      align-items: center;
    }

    .permisos-matrix-row:last-child { border-bottom: none; }

    .permisos-matrix-row label {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .permisos-matrix-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--sage);
    }

    .permisos-matrix-check {
      display: flex;
      justify-content: center;
    }

    /* Inventario mejorado */
    .inventario-categorias {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .inventario-cat-btn {
      padding: 6px 12px;
      background: var(--cream-medium);
      border: none;
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .inventario-cat-btn:hover { background: var(--cream-dark); }
    .inventario-cat-btn.active { background: var(--sage); color: white; }

    .inventario-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .inventario-item:hover { background: var(--cream-dark); }
    .inventario-item.bajo { border-left: 3px solid var(--error); }
    .inventario-item.ok { border-left: 3px solid var(--success); }

    .inventario-item-icon { font-size: 1.3rem; }

    .inventario-item-info { flex: 1; }
    .inventario-item-nombre { font-weight: 600; font-size: 0.9rem; }
    .inventario-item-meta { font-size: 0.7rem; color: var(--text-muted); }

    .inventario-item-stock {
      text-align: right;
      min-width: 60px;
    }

    .inventario-item-cantidad {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .inventario-item-cantidad.bajo { color: var(--error); }
    .inventario-item-cantidad.ok { color: var(--success); }

    .inventario-item-minimo {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .inventario-quick-btns {
      display: flex;
      gap: 4px;
      margin-left: 8px;
    }

    .inventario-quick-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .inventario-quick-btn.menos {
      background: var(--terracotta-muted);
      color: var(--terracotta);
    }

    .inventario-quick-btn.mas {
      background: var(--sage-muted);
      color: var(--sage-dark);
    }

    .inventario-quick-btn:hover { transform: scale(1.1); }

    .inventario-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .inventario-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 12px;
      text-align: center;
    }

    .inventario-stat-valor {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .inventario-stat-valor.alerta { color: var(--error); }
    .inventario-stat-label { font-size: 0.65rem; color: var(--text-muted); }

    .sidebar { display: flex; flex-direction: column; gap: 16px; }

    .empty-mini {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .empty-mini-icon { font-size: 2rem; opacity: 0.3; margin-bottom: 8px; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 24px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 450px;
      transform: translateY(20px);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal { transform: translateY(0); }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .modal-close {
      background: var(--cream);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .modal-close:hover { background: var(--cream-dark); }
    .modal-body { padding: 24px; }

    .modal-footer {
      padding: 0 24px 24px;
      display: flex;
      gap: 12px;
      justify-content: space-between;
    }

    .form-group { margin-bottom: 16px; }
    .form-group:last-child { margin-bottom: 0; }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
      transition: all 0.2s;
      background: var(--white);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--sage);
      box-shadow: 0 0 0 3px var(--sage-muted);
    }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="bienes.html" class="back-btn"><span>‚Üê</span><span>El Com√∫n</span></a>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary btn-sm" id="btn-editar">‚úèÔ∏è Editar</button>
    </div>
  </header>

  <main class="main">
    <div id="page-loading" class="loading"><div class="spinner"></div></div>

    <div id="page-content" class="hidden">
      <div class="bien-hero">
        <div class="bien-hero-image" id="bien-hero-image">üè†</div>
        <div class="bien-hero-body">
          <div class="bien-tipo-label" id="bien-tipo">Inmueble</div>
          <h1 class="bien-nombre" id="bien-nombre">Cargando...</h1>
          <div class="bien-ubicacion" id="bien-ubicacion"></div>
          <div class="bien-meta">
            <div class="bien-meta-item"><strong>Titularidad:</strong> <span id="bien-titularidad">-</span></div>
            <div class="bien-meta-item"><strong>Origen:</strong> <span id="bien-origen">-</span></div>
          </div>
        </div>
      </div>

      <div class="layout-grid">
        <div class="main-column">
          <div class="mayordomo-section hidden" id="mayordomo-section">
            <div class="mayordomo-header">
              <h2>üé© Mayordomo</h2>
              <p>Gesti√≥n activa de este bien</p>
            </div>
            
            <!-- Toggles de subm√≥dulos -->
            <div class="modulos-config" id="modulos-config" style="background: var(--cream); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 12px; color: var(--text);">Subm√≥dulos activos:</div>
              <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                <label class="toggle-modulo">
                  <input type="checkbox" id="toggle-reservas" onchange="toggleModulo('reservas', this.checked)">
                  <span>üìÖ Reservas</span>
                </label>
                <label class="toggle-modulo">
                  <input type="checkbox" id="toggle-inventario" onchange="toggleModulo('inventario', this.checked)">
                  <span>üì¶ Inventario</span>
                </label>
                <label class="toggle-modulo">
                  <input type="checkbox" id="toggle-gastos" onchange="toggleModulo('gastos', this.checked)">
                  <span>üí∞ Gastos</span>
                </label>
                <label class="toggle-modulo">
                  <input type="checkbox" id="toggle-mantenimiento" onchange="toggleModulo('mantenimiento', this.checked)">
                  <span>üîß Mantenimiento</span>
                </label>
                <label class="toggle-modulo">
                  <input type="checkbox" id="toggle-limpieza" onchange="toggleModulo('limpieza', this.checked)">
                  <span>üßπ Limpieza</span>
                </label>
              </div>
            </div>
            
            <div class="modulos-operativos" id="modulos-operativos"></div>
          </div>

          <div class="collapsible-section" id="no-mayordomo-section">
            <div class="collapsible-header" style="cursor: default;">
              <div class="collapsible-title"><span>üé©</span><span>Mayordomo</span></div>
            </div>
            <div class="collapsible-body" style="display: block;">
              <div class="empty-mini">
                <div class="empty-mini-icon">üé©</div>
                <p>El Mayordomo no est√° activado.</p>
                <button class="btn btn-mayordomo btn-sm" style="margin-top: 12px;" onclick="activarMayordomo()">Activar Mayordomo</button>
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar">
          <div class="collapsible-section open" id="section-galeria">
            <div class="collapsible-header" onclick="toggleSection('galeria')">
              <div class="collapsible-title"><span>üì∑</span><span>Galer√≠a</span><span class="collapsible-count" id="count-galeria">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div id="galeria-fotos" style="display:flex;gap:8px;overflow-x:auto;"><div class="empty-mini" style="padding:12px;">Sin fotos</div></div></div>
          </div>

          <div class="collapsible-section" id="section-personal">
            <div class="collapsible-header" onclick="toggleSection('personal')">
              <div class="collapsible-title"><span>üë∑</span><span>Personal</span><span class="collapsible-count" id="count-personal">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-personal"><div class="empty-mini">Sin personal</div></div></div>
          </div>

          <div class="collapsible-section" id="section-mascotas">
            <div class="collapsible-header" onclick="toggleSection('mascotas')">
              <div class="collapsible-title"><span>üêæ</span><span>Mascotas</span><span class="collapsible-count" id="count-mascotas">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-mascotas"><div class="empty-mini">Sin mascotas</div></div></div>
          </div>

          <div class="collapsible-section" id="section-contactos">
            <div class="collapsible-header" onclick="toggleSection('contactos')">
              <div class="collapsible-title"><span>üìû</span><span>Contactos</span><span class="collapsible-count" id="count-contactos">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-contactos"><div class="empty-mini">Sin contactos</div></div></div>
          </div>

          <div class="collapsible-section" id="section-documentos">
            <div class="collapsible-header" onclick="toggleSection('documentos')">
              <div class="collapsible-title"><span>üìÑ</span><span>Documentos</span><span class="collapsible-count" id="count-documentos">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="info-list" id="lista-documentos"><div class="empty-mini">Sin documentos</div></div></div>
          </div>

          <div class="collapsible-section" id="section-normas">
            <div class="collapsible-header" onclick="toggleSection('normas')">
              <div class="collapsible-title"><span>üìú</span><span>Normas</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body"><div class="normas-box" id="normas-texto">Sin normas definidas</div></div>
          </div>

          <div class="collapsible-section" id="section-caseros">
            <div class="collapsible-header" onclick="toggleSection('caseros')">
              <div class="collapsible-title"><span>üë§</span><span>Caseros</span><span class="collapsible-count" id="count-caseros">0</span></div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="caseros-list" id="lista-caseros"><div class="empty-mini">Sin caseros asignados</div></div>
              <button class="btn btn-secondary btn-sm" style="width:100%;margin-top:10px;" onclick="abrirModalCasero()">+ A√±adir casero</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Reserva -->
  <div class="modal-overlay" id="modal-reserva">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-reserva-title">üìÖ Nueva reserva</h3>
        <button class="modal-close" id="modal-reserva-close">√ó</button>
      </div>
      <form id="form-reserva">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¬øQui√©n reserva?</label>
            <select class="form-select" id="reserva-tipo" required>
              <option value="">Cargando...</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha inicio</label>
              <input type="date" class="form-input" id="reserva-inicio" required>
            </div>
            <div class="form-group">
              <label class="form-label">Fecha fin</label>
              <input type="date" class="form-input" id="reserva-fin" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Nota breve</label>
            <input type="text" class="form-input" id="reserva-notas" placeholder="Ej: Cumplea√±os abuelo, cacer√≠a oto√±o..." maxlength="50">
            <div class="form-hint">Se muestra al pasar el rat√≥n sobre la reserva</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-reserva">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-reserva-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-reserva-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Inventario -->
  <div class="modal-overlay" id="modal-inventario">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-inventario-title">üì¶ Nuevo art√≠culo</h3>
        <button class="modal-close" id="modal-inventario-close">√ó</button>
      </div>
      <form id="form-inventario">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre del art√≠culo</label>
            <input type="text" class="form-input" id="inv-nombre" placeholder="Ej: Papel higi√©nico" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="inv-categoria" required>
                <option value="limpieza">üßπ Limpieza</option>
                <option value="bano">üöø Ba√±o</option>
                <option value="cocina">üç≥ Cocina</option>
                <option value="alimentos">ü•´ Alimentos</option>
                <option value="bebidas">üç∑ Bebidas</option>
                <option value="otro">üì¶ Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Unidad</label>
              <select class="form-select" id="inv-unidad">
                <option value="uds">Unidades</option>
                <option value="rollos">Rollos</option>
                <option value="botellas">Botellas</option>
                <option value="paquetes">Paquetes</option>
                <option value="kg">Kg</option>
                <option value="litros">Litros</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Stock actual</label>
              <input type="number" class="form-input" id="inv-stock" min="0" value="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Stock m√≠nimo</label>
              <input type="number" class="form-input" id="inv-minimo" min="0" value="1" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha caducidad (opcional)</label>
            <input type="date" class="form-input" id="inv-caducidad">
          </div>
          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="inv-notas" placeholder="Ej: Marca preferida, d√≥nde comprarlo...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-inventario">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-inventario-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-inventario-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Gastos -->
  <div class="modal-overlay" id="modal-gasto">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-gasto-title">üí∂ Nuevo gasto</h3>
        <button class="modal-close" id="modal-gasto-close">√ó</button>
      </div>
      <form id="form-gasto">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha</label>
              <input type="date" class="form-input" id="gasto-fecha" required>
            </div>
            <div class="form-group">
              <label class="form-label">Importe (‚Ç¨)</label>
              <input type="number" class="form-input" id="gasto-importe" min="0" step="0.01" placeholder="0.00" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Concepto</label>
            <input type="text" class="form-input" id="gasto-concepto" placeholder="Ej: Factura luz noviembre" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" id="gasto-categoria" required>
                <option value="luz">üí° Luz</option>
                <option value="agua">üíß Agua</option>
                <option value="gas">üî• Gas</option>
                <option value="comunidad">üè¢ Comunidad</option>
                <option value="seguro">üõ°Ô∏è Seguro</option>
                <option value="mantenimiento">üîß Mantenimiento</option>
                <option value="limpieza">üßπ Limpieza</option>
                <option value="compras">üõí Compras</option>
                <option value="otro">üìã Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Proveedor</label>
              <input type="text" class="form-input" id="gasto-proveedor" placeholder="Ej: Iberdrola, Ferreter√≠a...">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Generador (qui√©n lo ordena)</label>
            <select class="form-select" id="gasto-generador">
              <option value="">Sin asignar</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="gasto-notas" placeholder="Ej: N¬∫ factura, observaciones...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-gasto">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-gasto-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-gasto-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Casero -->
  <div class="modal-overlay" id="modal-casero">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-casero-title">üë§ Nuevo casero</h3>
        <button class="modal-close" id="modal-casero-close">√ó</button>
      </div>
      <form id="form-casero">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-input" id="casero-nombre" placeholder="Nombre completo" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Email (para login)</label>
              <input type="email" class="form-input" id="casero-email" placeholder="email@ejemplo.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Tel√©fono</label>
              <input type="tel" class="form-input" id="casero-telefono" placeholder="600 000 000">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" style="margin-bottom:12px;">Permisos en este bien</label>
            <div class="permisos-matrix">
              <div class="permisos-matrix-header">
                <span>Secci√≥n</span>
                <span>V</span>
                <span>C</span>
                <span>E</span>
                <span>B</span>
              </div>
              <div class="permisos-matrix-row">
                <label>üìÖ Reservas</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-reservas-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-reservas-c"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-reservas-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-reservas-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üì¶ Inventario</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-inventario-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-inventario-c" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-inventario-e" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-inventario-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üîß Mantenimiento</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-mantenimiento-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-mantenimiento-c" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-mantenimiento-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-mantenimiento-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üßπ Limpieza</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-limpieza-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-limpieza-c" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-limpieza-e" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-limpieza-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üí∂ Gastos</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-gastos-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-gastos-c" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-gastos-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-gastos-b"></div>
              </div>
              <div class="permisos-matrix-row">
                <label>üìÑ Documentos</label>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-documentos-v" checked></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-documentos-c"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-documentos-e"></div>
                <div class="permisos-matrix-check"><input type="checkbox" id="perm-documentos-b"></div>
              </div>
            </div>
            <div style="font-size:0.7rem;color:var(--text-muted);margin-top:6px;">V=Ver, C=Crear, E=Editar, B=Borrar</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm hidden" id="btn-eliminar-casero">üóëÔ∏è Eliminar</button>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-secondary" id="modal-casero-cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="modal-casero-guardar">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Editar Bien -->
  <div class="modal-overlay" id="modal-editar-bien">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Editar bien</h3>
        <button class="modal-close" id="modal-editar-close">√ó</button>
      </div>
      <form id="form-editar-bien">
        <!-- Tabs -->
        <div class="modal-tabs" style="display:flex;border-bottom:1px solid var(--cream-dark);padding:0 24px;">
          <button type="button" class="modal-tab active" data-tab="datos">üìã Datos</button>
          <button type="button" class="modal-tab" data-tab="personal">üë∑ Personal</button>
          <button type="button" class="modal-tab" data-tab="contactos">üìû Contactos</button>
          <button type="button" class="modal-tab" data-tab="normas">üìú Normas</button>
        </div>

        <div class="modal-body" style="max-height:60vh;overflow-y:auto;">
          <!-- Tab Datos -->
          <div class="tab-content active" id="tab-datos">
            <div class="form-group">
              <label class="form-label">Nombre del bien *</label>
              <input type="text" class="form-input" id="edit-nombre" required>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="form-group">
                <label class="form-label">Tipo</label>
                <select class="form-input" id="edit-tipo">
                  <option value="inmueble">üè† Inmueble</option>
                  <option value="terreno">üå≥ Terreno</option>
                  <option value="vehiculo">üöó Veh√≠culo</option>
                  <option value="ajuar">ü™ë Ajuar</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Subtipo</label>
                <input type="text" class="form-input" id="edit-subtipo" placeholder="Ej: Segunda residencia">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Ubicaci√≥n</label>
              <input type="text" class="form-input" id="edit-ubicacion" placeholder="Direcci√≥n o localizaci√≥n">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="form-group">
                <label class="form-label">Titularidad</label>
                <input type="text" class="form-input" id="edit-titularidad" placeholder="¬øDe qui√©n es?">
              </div>
              <div class="form-group">
                <label class="form-label">Origen</label>
                <input type="text" class="form-input" id="edit-origen" placeholder="Herencia, compra...">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Notas</label>
              <textarea class="form-input" id="edit-notas" rows="3" placeholder="Informaci√≥n adicional..."></textarea>
            </div>
          </div>

          <!-- Tab Personal -->
          <div class="tab-content" id="tab-personal">
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Personal de servicio asociado a este bien (limpieza, jardinero, etc.)</p>
            <div id="personal-list" style="display:flex;flex-direction:column;gap:12px;"></div>
            <button type="button" class="btn btn-secondary btn-sm" style="margin-top:12px;width:100%;" onclick="addPersonalItem()">+ A√±adir personal</button>
          </div>

          <!-- Tab Contactos -->
          <div class="tab-content" id="tab-contactos">
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Contactos √∫tiles: vecinos, cerrajero, emergencias locales...</p>
            <div id="contactos-list" style="display:flex;flex-direction:column;gap:12px;"></div>
            <button type="button" class="btn btn-secondary btn-sm" style="margin-top:12px;width:100%;" onclick="addContactoItem()">+ A√±adir contacto</button>
          </div>

          <!-- Tab Normas -->
          <div class="tab-content" id="tab-normas">
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Normas de convivencia y uso del bien</p>
            <div class="form-group">
              <textarea class="form-input" id="edit-normas" rows="10" placeholder="Escribe aqu√≠ las normas de uso..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:12px;padding:16px 24px;border-top:1px solid var(--cream-dark);">
          <button type="button" class="btn btn-secondary" id="modal-editar-cancelar">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="modal-editar-guardar">üíæ Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    /* Modal tabs */
    .modal-tab {
      padding: 12px 16px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .modal-tab:hover { color: var(--text); }
    .modal-tab.active { color: var(--sage-dark); border-bottom-color: var(--sage); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Dynamic items */
    .dynamic-item {
      background: var(--cream);
      border-radius: var(--radius-md);
      padding: 12px;
      position: relative;
    }
    .dynamic-item-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    .dynamic-item-row:last-child { margin-bottom: 0; }
    .btn-remove-item {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.5;
    }
    .btn-remove-item:hover { opacity: 1; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let familiaId = null;
    let nidosData = [];
    let reservasData = [];
    let inventarioData = [];
    let gastosData = [];
    let repartoData = {}; // {nidoId: porcentaje}
    let gastosPeriodo = 'mes';
    let gastosTab = 'registro';
    let inventarioFiltro = 'todos';
    let calendarioMes = new Date();
    let editingReservaId = null;
    let editingInventarioId = null;
    let editingGastoId = null;
    let caserosData = [];
    let editingCaseroId = null;

    const nidoColores = ['nido-1', 'nido-2', 'nido-3', 'nido-4'];
    const nidoColorMap = {};
    
    // Tipos de reserva - se cargan desde Firebase
    let tiposReserva = {};

    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    if (!bienId) window.location.href = 'bienes.html';

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await loadBien();
    });

    async function loadBien() {
      try {
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) { alert('Bien no encontrado'); window.location.href = 'bienes.html'; return; }

        bienData = { id: bienDoc.id, ...bienDoc.data() };
        familiaId = bienData.familiaId;
        
        await loadNidos();
        await loadTiposReserva();
        await loadReservas();
        await loadInventario();
        await loadGastos();
        await loadCaseros();
        renderBien();

        document.getElementById('page-loading').classList.add('hidden');
        document.getElementById('page-content').classList.remove('hidden');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar');
        window.location.href = 'bienes.html';
      }
    }

    async function loadNidos() {
      if (!familiaId) return;
      const snap = await db.collection('nidos').where('familiaId', '==', familiaId).get();
      nidosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Nidos se usan para gastos/reparto, no para reservas
    }

    async function loadTiposReserva() {
      try {
        const snap = await db.collection('familias').doc(familiaId).collection('tiposReserva').orderBy('orden', 'asc').get();
        
        if (snap.empty) {
          // Tipos por defecto si no hay configurados
          tiposReserva = {
            'toda-familia': { nombre: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Toda la familia', color: '#7A9E7E' },
            'otros': { nombre: 'üìã Otros', color: '#9A9A9A' }
          };
        } else {
          tiposReserva = {};
          snap.docs.forEach(doc => {
            const data = doc.data();
            tiposReserva[doc.id] = {
              nombre: (data.emoji ? data.emoji + ' ' : '') + data.nombre,
              color: data.color
            };
          });
        }
        
        // Actualizar el select del modal
        const select = document.getElementById('reserva-tipo');
        select.innerHTML = '<option value="">Selecciona...</option>' +
          Object.entries(tiposReserva).map(([id, tipo]) => 
            `<option value="${id}">${tipo.nombre}</option>`
          ).join('');
          
        // Generar estilos din√°micos para los colores
        generarEstilosReservas();
      } catch (error) {
        console.error('Error cargando tipos de reserva:', error);
      }
    }

    function generarEstilosReservas() {
      // Eliminar estilos previos si existen
      const oldStyle = document.getElementById('dynamic-reserva-styles');
      if (oldStyle) oldStyle.remove();
      
      let css = '';
      Object.entries(tiposReserva).forEach(([id, tipo]) => {
        css += `.calendario-dia.tipo-${id} { background: ${tipo.color}; }\n`;
        css += `.reserva-item.tipo-${id} { border-left-color: ${tipo.color}; }\n`;
      });
      
      const style = document.createElement('style');
      style.id = 'dynamic-reserva-styles';
      style.textContent = css;
      document.head.appendChild(style);
    }

    async function loadReservas() {
      const snap = await db.collection('bienes').doc(bienId).collection('reservas').orderBy('fechaInicio', 'asc').get();
      reservasData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function loadInventario() {
      const snap = await db.collection('bienes').doc(bienId).collection('inventario').orderBy('nombre', 'asc').get();
      inventarioData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function loadGastos() {
      const snap = await db.collection('bienes').doc(bienId).collection('gastos').orderBy('fecha', 'desc').get();
      gastosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // Cargar configuraci√≥n de reparto
      const repartoDoc = await db.collection('bienes').doc(bienId).collection('config').doc('reparto').get();
      if (repartoDoc.exists) {
        repartoData = repartoDoc.data().porcentajes || {};
      } else {
        // Inicializar reparto equitativo
        repartoData = {};
        const porcentajeBase = nidosData.length > 0 ? Math.floor(100 / nidosData.length) : 100;
        nidosData.forEach((n, i) => {
          repartoData[n.id] = i === 0 ? 100 - (porcentajeBase * (nidosData.length - 1)) : porcentajeBase;
        });
      }
    }

    async function loadCaseros() {
      const snap = await db.collection('bienes').doc(bienId).collection('caseros').get();
      caserosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    function renderBien() {
      const tipoIcons = { inmueble: 'üè†', terreno: 'üå≥', vehiculo: 'üöó', ajuar: 'ü™ë' };
      const tipoLabels = { inmueble: 'Inmueble', terreno: 'Terreno', vehiculo: 'Veh√≠culo', ajuar: 'Ajuar' };
      const rolIcons = { limpieza: 'üßπ', jardinero: 'üå±', cuidador: 'üë®‚Äç‚öïÔ∏è', mantenimiento: 'üîß', otro: 'üìã' };
      const mascotaIcons = { perro: 'üêï', gato: 'üêà', ave: 'üê¶', otro: 'üêæ' };
      const catIcons = { mantenimiento: 'üîß', vecino: 'üèòÔ∏è', emergencia: 'üö®', suministros: 'üí°', otro: 'üìã' };
      const docIcons = { escritura: 'üìú', seguro: 'üõ°Ô∏è', suministro: 'üí°', empleado: 'üë∑', itv: 'üöó', comunidad: 'üè¢', otro: 'üìÑ' };

      document.getElementById('bien-hero-image').innerHTML = bienData.fotos?.length > 0
        ? `<img src="${bienData.fotos[0].url}">${bienData.mayordomoActivo ? '<span class="bien-hero-badge">üé© Mayordomo</span>' : ''}`
        : tipoIcons[bienData.tipo] || 'üè†';
      
      document.getElementById('bien-tipo').textContent = tipoLabels[bienData.tipo] || bienData.tipo;
      document.getElementById('bien-nombre').textContent = bienData.nombre;
      document.getElementById('bien-ubicacion').innerHTML = bienData.ubicacion ? `<span>üìç</span><span>${bienData.ubicacion}</span>` : '';
      document.getElementById('bien-titularidad').textContent = bienData.titularidad || '-';
      document.getElementById('bien-origen').textContent = bienData.origen || '-';

      // Sidebar counts
      document.getElementById('count-galeria').textContent = (bienData.fotos?.length || 0) + (bienData.croquis?.length || 0) + (bienData.planos?.length || 0);

      const personal = bienData.personal || [];
      document.getElementById('count-personal').textContent = personal.length;
      if (personal.length > 0) {
        document.getElementById('lista-personal').innerHTML = personal.map(p => `
          <div class="info-item">
            <span class="info-item-icon">${rolIcons[p.rol] || 'üë∑'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${p.nombre}</div>
              <div class="info-item-subtitle">${p.tipo === 'residente' ? 'Residente' : 'Puntual'}${p.telefono ? ' ¬∑ ' + p.telefono : ''}</div>
            </div>
            ${p.telefono ? `<a href="tel:${p.telefono}" class="info-item-action">üìû</a>` : ''}
          </div>
        `).join('');
      }

      const mascotas = bienData.mascotas || [];
      document.getElementById('count-mascotas').textContent = mascotas.length;
      if (mascotas.length > 0) {
        document.getElementById('lista-mascotas').innerHTML = mascotas.map(m => `
          <div class="info-item">
            <span class="info-item-icon">${mascotaIcons[m.tipo] || 'üêæ'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${m.nombre}</div>
              <div class="info-item-subtitle">${m.raza || m.tipo}</div>
            </div>
          </div>
        `).join('');
      }

      const contactos = bienData.contactos || [];
      document.getElementById('count-contactos').textContent = contactos.length;
      if (contactos.length > 0) {
        document.getElementById('lista-contactos').innerHTML = contactos.map(c => `
          <div class="info-item">
            <span class="info-item-icon">${catIcons[c.categoria] || 'üìû'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${c.nombre}</div>
              <div class="info-item-subtitle">${c.telefono || ''}</div>
            </div>
            ${c.telefono ? `<a href="tel:${c.telefono}" class="info-item-action">üìû</a>` : ''}
          </div>
        `).join('');
      }

      const documentos = bienData.documentos || [];
      document.getElementById('count-documentos').textContent = documentos.length;
      if (documentos.length > 0) {
        document.getElementById('lista-documentos').innerHTML = documentos.map(d => `
          <div class="info-item">
            <span class="info-item-icon">${docIcons[d.tipo] || 'üìÑ'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${d.nombre}</div>
              <div class="info-item-subtitle">${d.fechaVencimiento ? 'Vence: ' + formatDate(d.fechaVencimiento) : ''}</div>
            </div>
          </div>
        `).join('');
      }

      if (bienData.normasConvivencia) document.getElementById('normas-texto').textContent = bienData.normasConvivencia;

      // Caseros
      document.getElementById('count-caseros').textContent = caserosData.length;
      renderCaserosList();

      // Mayordomo
      if (bienData.mayordomoActivo) {
        document.getElementById('mayordomo-section').classList.remove('hidden');
        document.getElementById('no-mayordomo-section').classList.add('hidden');
        renderMayordomoModulos();
      } else {
        document.getElementById('mayordomo-section').classList.add('hidden');
        document.getElementById('no-mayordomo-section').classList.remove('hidden');
      }
    }

    function renderMayordomoModulos() {
      const container = document.getElementById('modulos-operativos');
      const m = bienData.mayordomoModulos || {};
      
      // Sincronizar checkboxes
      document.getElementById('toggle-reservas').checked = !!m.reservas;
      document.getElementById('toggle-inventario').checked = !!m.inventario;
      document.getElementById('toggle-gastos').checked = !!m.gastos;
      document.getElementById('toggle-mantenimiento').checked = !!m.mantenimiento;
      document.getElementById('toggle-limpieza').checked = !!m.limpieza;
      
      let html = '';

      if (m.reservas) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header">
              <div class="modulo-panel-title">üìÖ Reservas</div>
              <button class="btn btn-sm btn-primary" onclick="abrirModalReserva()">+ Nueva</button>
            </div>
            <div class="modulo-panel-body">
              <div class="calendario-nav">
                <button class="calendario-nav-btn" onclick="cambiarMes(-1)">‚óÄ</button>
                <span class="calendario-mes" id="calendario-mes-label"></span>
                <button class="calendario-nav-btn" onclick="cambiarMes(1)">‚ñ∂</button>
              </div>
              <div class="calendario-grid" id="calendario-grid"></div>
              <div class="nidos-leyenda" id="nidos-leyenda"></div>
              <div class="reservas-lista">
                <div class="reservas-lista-title">Pr√≥ximas reservas</div>
                <div id="reservas-lista-items"></div>
              </div>
            </div>
          </div>
        `;
      }

      if (m.inventario) {
        html += `
          <div class="modulo-panel" id="panel-inventario">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üì¶ Inventario</div><button class="btn btn-sm btn-primary" onclick="abrirModalInventario()">+ A√±adir</button></div>
            <div class="modulo-panel-body">
              <div class="inventario-stats" id="inventario-stats"></div>
              <div class="inventario-categorias" id="inventario-categorias"></div>
              <div class="inventario-list" id="inventario-list"></div>
            </div>
          </div>
        `;
      }

      if (m.mantenimiento) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üîß Mantenimiento</div><button class="btn btn-sm btn-secondary">+ A√±adir</button></div>
            <div class="modulo-panel-body">
              <div class="mantenimiento-list">
                <div class="mantenimiento-item"><span class="mantenimiento-tipo">üî•</span><div class="mantenimiento-info"><div class="mantenimiento-titulo">Revisi√≥n caldera</div><div class="mantenimiento-fecha">15 diciembre</div></div><span class="mantenimiento-badge programado">Programado</span></div>
              </div>
            </div>
          </div>
        `;
      }

      if (m.limpieza) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üßπ Limpieza</div></div>
            <div class="modulo-panel-body">
              <div class="limpieza-checklist">
                <div class="limpieza-item done" onclick="toggleLimpieza(this)"><div class="limpieza-check">‚úì</div><span class="limpieza-texto">Cambiar s√°banas</span></div>
                <div class="limpieza-item" onclick="toggleLimpieza(this)"><div class="limpieza-check"></div><span class="limpieza-texto">Limpiar ba√±os</span></div>
                <div class="limpieza-item" onclick="toggleLimpieza(this)"><div class="limpieza-check"></div><span class="limpieza-texto">Fregar suelos</span></div>
              </div>
            </div>
          </div>
        `;
      }

      if (m.eventos) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üéâ Eventos</div><button class="btn btn-sm btn-secondary">+ Nuevo</button></div>
            <div class="modulo-panel-body">
              <div class="eventos-list">
                <div class="evento-item"><span class="evento-icono">üéÑ</span><div class="evento-info"><div class="evento-nombre">Cena de Navidad</div><div class="evento-fecha">24 dic ¬∑ 20:00</div></div><span class="evento-tipo">Familia</span></div>
              </div>
            </div>
          </div>
        `;
      }

      if (m.gastos) {
        html += `
          <div class="modulo-panel" id="panel-gastos">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üí∂ Gastos</div><button class="btn btn-sm btn-primary" onclick="abrirModalGasto()">+ A√±adir</button></div>
            <div class="modulo-panel-body">
              <div class="gastos-tabs">
                <button class="gastos-tab active" onclick="cambiarTabGastos('registro')">üìã Registro</button>
                <button class="gastos-tab" onclick="cambiarTabGastos('reparto')">üìä Reparto</button>
              </div>
              <div class="gastos-tab-content active" id="tab-registro">
                <div class="gastos-periodo-selector" id="gastos-periodo-selector"></div>
                <div class="gastos-resumen" id="gastos-resumen"></div>
                <div class="gastos-por-categoria" id="gastos-categorias"></div>
                <div class="gastos-list" id="gastos-list"></div>
              </div>
              <div class="gastos-tab-content" id="tab-reparto">
                <div class="reparto-info">üí° Define qu√© porcentaje del gasto asume cada nido. El total debe sumar 100%.</div>
                <table class="reparto-table" id="reparto-table"></table>
                <div class="reparto-total" id="reparto-total"></div>
                <button class="btn btn-primary btn-sm" style="margin-top:12px;width:100%;" onclick="guardarReparto()">üíæ Guardar reparto</button>
                <div class="reparto-desglose" id="reparto-desglose"></div>
              </div>
            </div>
          </div>
        `;
      }

      if (m.otrosServicios) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header"><div class="modulo-panel-title">üõéÔ∏è Otros Servicios</div></div>
            <div class="modulo-panel-body">
              <div class="servicios-list">
                <div class="servicio-item"><span class="servicio-icono">üçΩÔ∏è</span><span class="servicio-nombre">Catering</span></div>
                <div class="servicio-item"><span class="servicio-icono">üöê</span><span class="servicio-nombre">Transporte</span></div>
              </div>
            </div>
          </div>
        `;
      }

      if (!html) html = '<div class="empty-mini"><div class="empty-mini-icon">üìã</div><p>No hay subm√≥dulos activados.</p></div>';

      container.innerHTML = html;
      if (m.reservas) { renderCalendario(); renderReservasLista(); renderNidosLeyenda(); }
      if (m.inventario) { renderInventario(); }
      if (m.gastos) { renderGastos(); }
    }

    async function toggleModulo(modulo, activo) {
      try {
        const updateData = {};
        updateData[`mayordomoModulos.${modulo}`] = activo;
        
        await db.collection('bienes').doc(bienId).update(updateData);
        
        // Actualizar datos locales
        if (!bienData.mayordomoModulos) bienData.mayordomoModulos = {};
        bienData.mayordomoModulos[modulo] = activo;
        
        renderMayordomoModulos();
      } catch (error) {
        console.error('Error al cambiar m√≥dulo:', error);
        alert('Error al actualizar');
        // Revertir checkbox
        document.getElementById(`toggle-${modulo}`).checked = !activo;
      }
    }

    // CALENDARIO
    function renderCalendario() {
      const grid = document.getElementById('calendario-grid');
      const label = document.getElementById('calendario-mes-label');
      const year = calendarioMes.getFullYear();
      const month = calendarioMes.getMonth();
      
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      label.textContent = `${meses[month]} ${year}`;
      
      const primerDia = new Date(year, month, 1);
      const ultimoDia = new Date(year, month + 1, 0);
      let startDay = primerDia.getDay(); if (startDay === 0) startDay = 7; startDay--;
      const diasMes = ultimoDia.getDate();
      const hoy = new Date();
      
      let html = '';
      ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(d => { html += `<div class="calendario-dia-header">${d}</div>`; });
      
      const mesAnterior = new Date(year, month, 0);
      for (let i = startDay - 1; i >= 0; i--) {
        html += `<div class="calendario-dia otro-mes">${mesAnterior.getDate() - i}</div>`;
      }
      
      for (let dia = 1; dia <= diasMes; dia++) {
        const fecha = new Date(year, month, dia);
        const esHoy = fecha.toDateString() === hoy.toDateString();
        const reserva = getReservaParaDia(fecha);
        let clases = 'calendario-dia';
        if (esHoy) clases += ' hoy';
        if (reserva) clases += ` reservado tipo-${reserva.tipo || 'otros'}`;
        const tooltip = reserva ? (reserva.notas || tiposReserva[reserva.tipo]?.nombre || '') : '';
        html += `<div class="${clases}" onclick="clickDia(${dia})" title="${tooltip}">${dia}</div>`;
      }
      
      const totalCeldas = startDay + diasMes;
      const celdasFaltantes = totalCeldas % 7 === 0 ? 0 : 7 - (totalCeldas % 7);
      for (let i = 1; i <= celdasFaltantes; i++) {
        html += `<div class="calendario-dia otro-mes">${i}</div>`;
      }
      
      grid.innerHTML = html;
    }

    function getReservaParaDia(fecha) {
      const t = fecha.getTime();
      for (const r of reservasData) {
        if (!r.fechaInicio || !r.fechaFin) continue;
        const inicio = r.fechaInicio.toDate(); inicio.setHours(0,0,0,0);
        const fin = r.fechaFin.toDate(); fin.setHours(23,59,59,999);
        if (t >= inicio.getTime() && t <= fin.getTime()) return r;
      }
      return null;
    }

    function cambiarMes(delta) { calendarioMes.setMonth(calendarioMes.getMonth() + delta); renderCalendario(); }

    function clickDia(dia) {
      const fecha = new Date(calendarioMes.getFullYear(), calendarioMes.getMonth(), dia);
      const reserva = getReservaParaDia(fecha);
      abrirModalReserva(reserva ? reserva : null, reserva ? null : fecha);
    }

    function renderReservasLista() {
      const container = document.getElementById('reservas-lista-items');
      const hoy = new Date(); hoy.setHours(0,0,0,0);
      
      const proximas = reservasData.filter(r => r.fechaFin?.toDate() >= hoy).sort((a, b) => a.fechaInicio.toDate() - b.fechaInicio.toDate()).slice(0, 5);
      
      if (proximas.length === 0) { container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay reservas pr√≥ximas</div>'; return; }
      
      container.innerHTML = proximas.map(r => {
        const inicio = r.fechaInicio.toDate();
        const fin = r.fechaFin.toDate();
        const dias = Math.ceil((fin - inicio) / (1000*60*60*24)) + 1;
        const tipoInfo = tiposReserva[r.tipo] || { nombre: 'Otros', color: '#9A9A9A' };
        return `
          <div class="reserva-item tipo-${r.tipo || 'otros'}" onclick="abrirModalReserva(reservasData.find(x=>x.id==='${r.id}'))" title="${r.notas || ''}">
            <div class="reserva-fecha">
              <div class="reserva-fecha-dia">${inicio.getDate()}</div>
              <div class="reserva-fecha-mes">${inicio.toLocaleDateString('es-ES', {month: 'short'}).toUpperCase()}</div>
            </div>
            <div class="reserva-info">
              <div class="reserva-quien">${tipoInfo.nombre}</div>
              <div class="reserva-periodo">${formatDateRange(inicio, fin)} ¬∑ ${dias} noche${dias > 1 ? 's' : ''}${r.notas ? ' ¬∑ ' + r.notas : ''}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderNidosLeyenda() {
      const container = document.getElementById('nidos-leyenda');
      const tiposConReservas = [...new Set(reservasData.map(r => r.tipo))].filter(Boolean);
      if (tiposConReservas.length === 0) { container.innerHTML = ''; return; }
      
      container.innerHTML = tiposConReservas.map(tipo => {
        const info = tiposReserva[tipo] || { nombre: tipo, color: '#9A9A9A' };
        return `<div class="nido-leyenda-item"><div class="nido-leyenda-color" style="background:${info.color}"></div><span>${info.nombre}</span></div>`;
      }).join('');
    }

    // MODAL RESERVA
    const modalReserva = document.getElementById('modal-reserva');
    const formReserva = document.getElementById('form-reserva');

    function abrirModalReserva(reserva = null, fechaPre = null) {
      editingReservaId = reserva?.id || null;
      formReserva.reset();
      document.getElementById('btn-eliminar-reserva').classList.toggle('hidden', !reserva);
      
      if (reserva) {
        document.getElementById('modal-reserva-title').textContent = '‚úèÔ∏è Editar reserva';
        document.getElementById('reserva-tipo').value = reserva.tipo || '';
        document.getElementById('reserva-inicio').value = formatDateInput(reserva.fechaInicio.toDate());
        document.getElementById('reserva-fin').value = formatDateInput(reserva.fechaFin.toDate());
        document.getElementById('reserva-notas').value = reserva.notas || '';
      } else {
        document.getElementById('modal-reserva-title').textContent = 'üìÖ Nueva reserva';
        if (fechaPre) {
          document.getElementById('reserva-inicio').value = formatDateInput(fechaPre);
          const fin = new Date(fechaPre); fin.setDate(fin.getDate() + 1);
          document.getElementById('reserva-fin').value = formatDateInput(fin);
        }
      }
      modalReserva.classList.add('active');
    }

    document.getElementById('modal-reserva-close').addEventListener('click', () => modalReserva.classList.remove('active'));
    document.getElementById('modal-reserva-cancelar').addEventListener('click', () => modalReserva.classList.remove('active'));
    modalReserva.addEventListener('click', (e) => { if (e.target === modalReserva) modalReserva.classList.remove('active'); });

    formReserva.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-reserva-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const tipo = document.getElementById('reserva-tipo').value;
        const tipoInfo = tiposReserva[tipo] || { nombre: 'Otros' };
        
        const data = {
          tipo,
          tipoNombre: tipoInfo.nombre,
          fechaInicio: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('reserva-inicio').value + 'T00:00:00')),
          fechaFin: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('reserva-fin').value + 'T23:59:59')),
          notas: document.getElementById('reserva-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('reservas');
        if (editingReservaId) { await ref.doc(editingReservaId).update(data); }
        else { data.creadoPor = currentUser.uid; data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp(); await ref.add(data); }
        
        modalReserva.classList.remove('active');
        await loadReservas();
        renderCalendario(); renderReservasLista(); renderNidosLeyenda();
      } catch (error) { console.error(error); alert('Error al guardar'); }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-reserva').addEventListener('click', async () => {
      if (!editingReservaId || !confirm('¬øEliminar esta reserva?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('reservas').doc(editingReservaId).delete();
        modalReserva.classList.remove('active');
        await loadReservas();
        renderCalendario(); renderReservasLista(); renderNidosLeyenda();
      } catch (error) { console.error(error); alert('Error'); }
    });

    // UTILS
    function toggleSection(s) { document.getElementById(`section-${s}`).classList.toggle('open'); }
    function toggleLimpieza(item) { item.classList.toggle('done'); item.querySelector('.limpieza-check').textContent = item.classList.contains('done') ? '‚úì' : ''; }
    function formatDate(d) { return new Date(d).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }); }
    function formatDateInput(d) { return d.toISOString().split('T')[0]; }
    function formatDateRange(i, f) { const o = { day: 'numeric', month: 'short' }; return `${i.toLocaleDateString('es-ES', o)} - ${f.toLocaleDateString('es-ES', o)}`; }
    function editarBien() {
      // Abrir modal de edici√≥n
      const modal = document.getElementById('modal-editar-bien');
      
      // Cargar datos actuales en el formulario
      document.getElementById('edit-nombre').value = bienData.nombre || '';
      document.getElementById('edit-tipo').value = bienData.tipo || 'inmueble';
      document.getElementById('edit-subtipo').value = bienData.subtipo || '';
      document.getElementById('edit-ubicacion').value = bienData.ubicacion || '';
      document.getElementById('edit-titularidad').value = bienData.titularidad || '';
      document.getElementById('edit-origen').value = bienData.origen || '';
      document.getElementById('edit-notas').value = bienData.notas || '';
      document.getElementById('edit-normas').value = bienData.normasConvivencia || '';
      
      // Cargar personal
      document.getElementById('personal-list').innerHTML = '';
      if (bienData.personal && bienData.personal.length > 0) {
        bienData.personal.forEach(p => addPersonalItem(p));
      }
      
      // Cargar contactos
      document.getElementById('contactos-list').innerHTML = '';
      if (bienData.contactos && bienData.contactos.length > 0) {
        bienData.contactos.forEach(c => addContactoItem(c));
      }
      
      // Reset tabs
      document.querySelectorAll('#modal-editar-bien .modal-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('#modal-editar-bien .tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector('#modal-editar-bien .modal-tab[data-tab="datos"]').classList.add('active');
      document.getElementById('tab-datos').classList.add('active');
      
      modal.classList.add('active');
    }

    // Tabs del modal editar
    document.querySelectorAll('#modal-editar-bien .modal-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('#modal-editar-bien .modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#modal-editar-bien .tab-content').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // Personal din√°mico
    function addPersonalItem(data = null) {
      const list = document.getElementById('personal-list');
      const item = document.createElement('div');
      item.className = 'dynamic-item';
      item.innerHTML = `
        <button type="button" class="btn-remove-item" onclick="this.parentElement.remove()">üóëÔ∏è</button>
        <div class="dynamic-item-row">
          <input type="text" class="form-input personal-nombre" placeholder="Nombre" value="${data?.nombre || ''}">
          <select class="form-input personal-tipo">
            <option value="residente" ${data?.tipo === 'residente' ? 'selected' : ''}>Residente</option>
            <option value="puntual" ${data?.tipo === 'puntual' ? 'selected' : ''}>Puntual</option>
          </select>
        </div>
        <div class="dynamic-item-row">
          <select class="form-input personal-rol">
            <option value="limpieza" ${data?.rol === 'limpieza' ? 'selected' : ''}>üßπ Limpieza</option>
            <option value="jardinero" ${data?.rol === 'jardinero' ? 'selected' : ''}>üå± Jardinero</option>
            <option value="cuidador" ${data?.rol === 'cuidador' ? 'selected' : ''}>üë®‚Äç‚öïÔ∏è Cuidador</option>
            <option value="mantenimiento" ${data?.rol === 'mantenimiento' ? 'selected' : ''}>üîß Mantenimiento</option>
            <option value="otro" ${data?.rol === 'otro' ? 'selected' : ''}>üìã Otro</option>
          </select>
          <input type="tel" class="form-input personal-telefono" placeholder="Tel√©fono" value="${data?.telefono || ''}">
        </div>
      `;
      list.appendChild(item);
    }

    function getPersonalFromForm() {
      const items = [];
      document.querySelectorAll('#personal-list .dynamic-item').forEach(item => {
        const nombre = item.querySelector('.personal-nombre').value;
        if (nombre) {
          items.push({
            nombre,
            tipo: item.querySelector('.personal-tipo').value,
            rol: item.querySelector('.personal-rol').value,
            telefono: item.querySelector('.personal-telefono').value
          });
        }
      });
      return items;
    }

    // Contactos din√°micos
    function addContactoItem(data = null) {
      const list = document.getElementById('contactos-list');
      const item = document.createElement('div');
      item.className = 'dynamic-item';
      item.innerHTML = `
        <button type="button" class="btn-remove-item" onclick="this.parentElement.remove()">üóëÔ∏è</button>
        <div class="dynamic-item-row">
          <input type="text" class="form-input contacto-nombre" placeholder="Nombre" value="${data?.nombre || ''}">
          <select class="form-input contacto-categoria">
            <option value="mantenimiento" ${data?.categoria === 'mantenimiento' ? 'selected' : ''}>üîß Mantenimiento</option>
            <option value="vecino" ${data?.categoria === 'vecino' ? 'selected' : ''}>üèòÔ∏è Vecino</option>
            <option value="emergencia" ${data?.categoria === 'emergencia' ? 'selected' : ''}>üö® Emergencia</option>
            <option value="otro" ${data?.categoria === 'otro' ? 'selected' : ''}>üìã Otro</option>
          </select>
        </div>
        <div class="dynamic-item-row">
          <input type="tel" class="form-input contacto-telefono" placeholder="Tel√©fono" value="${data?.telefono || ''}">
          <input type="text" class="form-input contacto-notas" placeholder="Notas" value="${data?.notas || ''}">
        </div>
      `;
      list.appendChild(item);
    }

    function getContactosFromForm() {
      const items = [];
      document.querySelectorAll('#contactos-list .dynamic-item').forEach(item => {
        const nombre = item.querySelector('.contacto-nombre').value;
        if (nombre) {
          items.push({
            nombre,
            categoria: item.querySelector('.contacto-categoria').value,
            telefono: item.querySelector('.contacto-telefono').value,
            notas: item.querySelector('.contacto-notas').value
          });
        }
      });
      return items;
    }

    // Cerrar modal editar
    document.getElementById('modal-editar-close').addEventListener('click', () => {
      document.getElementById('modal-editar-bien').classList.remove('active');
    });
    document.getElementById('modal-editar-cancelar').addEventListener('click', () => {
      document.getElementById('modal-editar-bien').classList.remove('active');
    });
    document.getElementById('modal-editar-bien').addEventListener('click', (e) => {
      if (e.target.id === 'modal-editar-bien') {
        document.getElementById('modal-editar-bien').classList.remove('active');
      }
    });

    // Guardar cambios del bien
    document.getElementById('form-editar-bien').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('modal-editar-guardar');
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      try {
        const updateData = {
          nombre: document.getElementById('edit-nombre').value,
          tipo: document.getElementById('edit-tipo').value,
          subtipo: document.getElementById('edit-subtipo').value,
          ubicacion: document.getElementById('edit-ubicacion').value,
          titularidad: document.getElementById('edit-titularidad').value,
          origen: document.getElementById('edit-origen').value,
          notas: document.getElementById('edit-notas').value,
          normasConvivencia: document.getElementById('edit-normas').value,
          personal: getPersonalFromForm(),
          contactos: getContactosFromForm(),
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('bienes').doc(bienId).update(updateData);
        
        // Actualizar datos locales
        Object.assign(bienData, updateData);

        document.getElementById('modal-editar-bien').classList.remove('active');
        
        // Re-renderizar todo el bien con los nuevos datos
        renderBien();
        
        alert('‚úÖ Cambios guardados');

      } catch (error) {
        console.error('Error guardando:', error);
        alert('Error al guardar: ' + error.message);
      }

      btn.disabled = false;
      btn.textContent = 'üíæ Guardar cambios';
    });

    // Activar Mayordomo directamente
    async function activarMayordomo() {
      if (!confirm('¬øActivar el m√≥dulo Mayordomo para este bien?\n\nIncluye: Reservas, Inventario y Gastos')) return;

      try {
        await db.collection('bienes').doc(bienId).update({
          'mayordomo.activo': true,
          'mayordomo.reservas': true,
          'mayordomo.inventario': true,
          'mayordomo.gastos': true,
          mayordomoActivo: true,
          mayordomoModulos: {
            reservas: true,
            inventario: true,
            gastos: true
          }
        });

        // Actualizar UI
        bienData.mayordomo = { activo: true, reservas: true, inventario: true, gastos: true };
        bienData.mayordomoActivo = true;
        bienData.mayordomoModulos = { reservas: true, inventario: true, gastos: true };
        
        document.getElementById('mayordomo-section').classList.remove('hidden');
        document.getElementById('no-mayordomo-section').classList.add('hidden');
        renderMayordomoModulos();

        alert('‚úÖ Mayordomo activado correctamente');
      } catch (error) {
        console.error('Error activando Mayordomo:', error);
        alert('Error al activar Mayordomo');
      }
    }
    document.getElementById('btn-editar').addEventListener('click', editarBien);

    // ========== INVENTARIO ==========
    const catIcons2 = {
      limpieza: 'üßπ',
      bano: 'üöø',
      cocina: 'üç≥',
      alimentos: 'ü•´',
      bebidas: 'üç∑',
      otro: 'üì¶'
    };

    const catLabels = {
      limpieza: 'Limpieza',
      bano: 'Ba√±o',
      cocina: 'Cocina',
      alimentos: 'Alimentos',
      bebidas: 'Bebidas',
      otro: 'Otro'
    };

    function renderInventario() {
      renderInventarioStats();
      renderInventarioCategorias();
      renderInventarioList();
    }

    function renderInventarioStats() {
      const container = document.getElementById('inventario-stats');
      if (!container) return;

      const total = inventarioData.length;
      const bajos = inventarioData.filter(i => i.stockActual <= i.stockMinimo).length;
      const ok = total - bajos;

      container.innerHTML = `
        <div class="inventario-stat">
          <div class="inventario-stat-valor">${total}</div>
          <div class="inventario-stat-label">Total</div>
        </div>
        <div class="inventario-stat">
          <div class="inventario-stat-valor alerta">${bajos}</div>
          <div class="inventario-stat-label">Bajo m√≠nimo</div>
        </div>
        <div class="inventario-stat">
          <div class="inventario-stat-valor" style="color:var(--success)">${ok}</div>
          <div class="inventario-stat-label">OK</div>
        </div>
      `;
    }

    function renderInventarioCategorias() {
      const container = document.getElementById('inventario-categorias');
      if (!container) return;

      // Obtener categor√≠as que tienen items
      const categoriasConItems = ['todos', ...new Set(inventarioData.map(i => i.categoria))];
      
      container.innerHTML = categoriasConItems.map(cat => `
        <button class="inventario-cat-btn ${inventarioFiltro === cat ? 'active' : ''}" onclick="filtrarInventario('${cat}')">
          ${cat === 'todos' ? 'üìã Todos' : (catIcons2[cat] || 'üì¶') + ' ' + (catLabels[cat] || cat)}
        </button>
      `).join('');
    }

    function filtrarInventario(cat) {
      inventarioFiltro = cat;
      renderInventarioCategorias();
      renderInventarioList();
    }

    function renderInventarioList() {
      const container = document.getElementById('inventario-list');
      if (!container) return;

      let items = inventarioData;
      
      // Filtrar por categor√≠a
      if (inventarioFiltro !== 'todos') {
        items = items.filter(i => i.categoria === inventarioFiltro);
      }

      // Ordenar: primero los bajo m√≠nimo
      items.sort((a, b) => {
        const aBajo = a.stockActual <= a.stockMinimo;
        const bBajo = b.stockActual <= b.stockMinimo;
        if (aBajo && !bBajo) return -1;
        if (!aBajo && bBajo) return 1;
        return a.nombre.localeCompare(b.nombre);
      });

      if (items.length === 0) {
        container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay art√≠culos en el inventario</div>';
        return;
      }

      container.innerHTML = items.map(item => {
        const bajo = item.stockActual <= item.stockMinimo;
        const icon = catIcons2[item.categoria] || 'üì¶';
        
        return `
          <div class="inventario-item ${bajo ? 'bajo' : 'ok'}" onclick="abrirModalInventario(inventarioData.find(x=>x.id==='${item.id}'))">
            <span class="inventario-item-icon">${icon}</span>
            <div class="inventario-item-info">
              <div class="inventario-item-nombre">${item.nombre}</div>
              <div class="inventario-item-meta">${item.unidad || 'uds'}${item.fechaCaducidad ? ' ¬∑ Cad: ' + formatDate(item.fechaCaducidad) : ''}</div>
            </div>
            <div class="inventario-item-stock">
              <div class="inventario-item-cantidad ${bajo ? 'bajo' : 'ok'}">${item.stockActual}</div>
              <div class="inventario-item-minimo">m√≠n. ${item.stockMinimo}</div>
            </div>
            <div class="inventario-quick-btns" onclick="event.stopPropagation()">
              <button class="inventario-quick-btn menos" onclick="ajustarStock('${item.id}', -1)">‚àí</button>
              <button class="inventario-quick-btn mas" onclick="ajustarStock('${item.id}', 1)">+</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function ajustarStock(itemId, delta) {
      const item = inventarioData.find(i => i.id === itemId);
      if (!item) return;

      const nuevoStock = Math.max(0, item.stockActual + delta);
      
      try {
        await db.collection('bienes').doc(bienId).collection('inventario').doc(itemId).update({
          stockActual: nuevoStock,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Actualizar localmente
        item.stockActual = nuevoStock;
        renderInventario();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // MODAL INVENTARIO
    const modalInventario = document.getElementById('modal-inventario');
    const formInventario = document.getElementById('form-inventario');

    function abrirModalInventario(item = null) {
      editingInventarioId = item?.id || null;
      formInventario.reset();
      document.getElementById('btn-eliminar-inventario').classList.toggle('hidden', !item);
      
      if (item) {
        document.getElementById('modal-inventario-title').textContent = '‚úèÔ∏è Editar art√≠culo';
        document.getElementById('inv-nombre').value = item.nombre || '';
        document.getElementById('inv-categoria').value = item.categoria || 'otro';
        document.getElementById('inv-unidad').value = item.unidad || 'uds';
        document.getElementById('inv-stock').value = item.stockActual || 0;
        document.getElementById('inv-minimo').value = item.stockMinimo || 1;
        document.getElementById('inv-caducidad').value = item.fechaCaducidad || '';
        document.getElementById('inv-notas').value = item.notas || '';
      } else {
        document.getElementById('modal-inventario-title').textContent = 'üì¶ Nuevo art√≠culo';
      }
      modalInventario.classList.add('active');
    }

    document.getElementById('modal-inventario-close').addEventListener('click', () => modalInventario.classList.remove('active'));
    document.getElementById('modal-inventario-cancelar').addEventListener('click', () => modalInventario.classList.remove('active'));
    modalInventario.addEventListener('click', (e) => { if (e.target === modalInventario) modalInventario.classList.remove('active'); });

    formInventario.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-inventario-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const data = {
          nombre: document.getElementById('inv-nombre').value,
          categoria: document.getElementById('inv-categoria').value,
          unidad: document.getElementById('inv-unidad').value,
          stockActual: parseInt(document.getElementById('inv-stock').value) || 0,
          stockMinimo: parseInt(document.getElementById('inv-minimo').value) || 1,
          fechaCaducidad: document.getElementById('inv-caducidad').value || null,
          notas: document.getElementById('inv-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('inventario');
        if (editingInventarioId) {
          await ref.doc(editingInventarioId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        
        modalInventario.classList.remove('active');
        await loadInventario();
        renderInventario();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-inventario').addEventListener('click', async () => {
      if (!editingInventarioId || !confirm('¬øEliminar este art√≠culo?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('inventario').doc(editingInventarioId).delete();
        modalInventario.classList.remove('active');
        await loadInventario();
        renderInventario();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ========== GASTOS ==========
    const gastoCatIcons = {
      luz: 'üí°',
      agua: 'üíß',
      gas: 'üî•',
      comunidad: 'üè¢',
      seguro: 'üõ°Ô∏è',
      mantenimiento: 'üîß',
      limpieza: 'üßπ',
      compras: 'üõí',
      otro: 'üìã'
    };

    const gastoCatLabels = {
      luz: 'Luz',
      agua: 'Agua',
      gas: 'Gas',
      comunidad: 'Comunidad',
      seguro: 'Seguro',
      mantenimiento: 'Mantenimiento',
      limpieza: 'Limpieza',
      compras: 'Compras',
      otro: 'Otro'
    };

    const coloresNidoHex = ['#7A9E7E', '#C17757', '#6B8E9F', '#9B8EA6'];

    function renderGastos() {
      renderGastosPeriodoSelector();
      renderGastosResumen();
      renderGastosCategorias();
      renderGastosList();
      renderRepartoTable();
      renderRepartoDesglose();
      
      // Popular selector de generador con nidos
      const selectGenerador = document.getElementById('gasto-generador');
      if (selectGenerador) {
        selectGenerador.innerHTML = '<option value="">Sin asignar</option>' +
          nidosData.map(n => `<option value="${n.id}">${n.nombre}</option>`).join('');
      }
    }

    function cambiarTabGastos(tab) {
      gastosTab = tab;
      document.querySelectorAll('.gastos-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.gastos-tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.gastos-tab:nth-child(${tab === 'registro' ? 1 : 2})`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    function renderGastosPeriodoSelector() {
      const container = document.getElementById('gastos-periodo-selector');
      if (!container) return;

      container.innerHTML = `
        <button class="gastos-periodo-btn ${gastosPeriodo === 'mes' ? 'active' : ''}" onclick="cambiarPeriodoGastos('mes')">Este mes</button>
        <button class="gastos-periodo-btn ${gastosPeriodo === 'a√±o' ? 'active' : ''}" onclick="cambiarPeriodoGastos('a√±o')">Este a√±o</button>
        <button class="gastos-periodo-btn ${gastosPeriodo === 'todos' ? 'active' : ''}" onclick="cambiarPeriodoGastos('todos')">Todos</button>
      `;
    }

    function cambiarPeriodoGastos(periodo) {
      gastosPeriodo = periodo;
      renderGastosPeriodoSelector();
      renderGastosResumen();
      renderGastosCategorias();
      renderGastosList();
      renderRepartoDesglose();
    }

    function getGastosFiltrados() {
      const hoy = new Date();
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const inicioA√±o = new Date(hoy.getFullYear(), 0, 1);

      return gastosData.filter(g => {
        if (!g.fecha) return false;
        const fechaGasto = new Date(g.fecha);
        
        if (gastosPeriodo === 'mes') {
          return fechaGasto >= inicioMes;
        } else if (gastosPeriodo === 'a√±o') {
          return fechaGasto >= inicioA√±o;
        }
        return true;
      });
    }

    function renderGastosResumen() {
      const container = document.getElementById('gastos-resumen');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      const total = gastosFiltrados.reduce((sum, g) => sum + (parseFloat(g.importe) || 0), 0);
      const numGastos = gastosFiltrados.length;

      const periodoLabel = gastosPeriodo === 'mes' ? 'Este mes' : gastosPeriodo === 'a√±o' ? 'Este a√±o' : 'Total';

      container.innerHTML = `
        <div class="gasto-stat">
          <div class="gasto-stat-valor">‚Ç¨${total.toFixed(2)}</div>
          <div class="gasto-stat-label">${periodoLabel}</div>
        </div>
        <div class="gasto-stat">
          <div class="gasto-stat-valor" style="color:var(--text)">${numGastos}</div>
          <div class="gasto-stat-label">Registros</div>
        </div>
      `;
    }

    function renderGastosCategorias() {
      const container = document.getElementById('gastos-categorias');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      
      const porCategoria = {};
      gastosFiltrados.forEach(g => {
        const cat = g.categoria || 'otro';
        if (!porCategoria[cat]) porCategoria[cat] = 0;
        porCategoria[cat] += parseFloat(g.importe) || 0;
      });

      const categorias = Object.entries(porCategoria).sort((a, b) => b[1] - a[1]);

      if (categorias.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = categorias.map(([cat, total]) => `
        <div class="gasto-cat-chip">
          <span>${gastoCatIcons[cat] || 'üìã'}</span>
          <span>${gastoCatLabels[cat] || cat}</span>
          <span class="gasto-cat-chip-valor">‚Ç¨${total.toFixed(0)}</span>
        </div>
      `).join('');
    }

    function renderGastosList() {
      const container = document.getElementById('gastos-list');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();

      if (gastosFiltrados.length === 0) {
        container.innerHTML = '<div class="empty-mini" style="padding:16px;">No hay gastos registrados</div>';
        return;
      }

      const gastosRecientes = gastosFiltrados.slice(0, 15);

      container.innerHTML = gastosRecientes.map(g => {
        const icon = gastoCatIcons[g.categoria] || 'üìã';
        const generador = g.generadorId ? nidosData.find(n => n.id === g.generadorId) : null;
        const fecha = g.fecha ? new Date(g.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }) : '';
        
        return `
          <div class="gasto-item" onclick="abrirModalGasto(gastosData.find(x=>x.id==='${g.id}'))">
            <span class="gasto-item-icon">${icon}</span>
            <div class="gasto-item-info">
              <div class="gasto-item-concepto">${g.concepto}</div>
              <div class="gasto-item-meta">${fecha}${g.proveedor ? ' ¬∑ ' + g.proveedor : ''}</div>
            </div>
            ${generador ? `<span class="gasto-item-generador">${generador.nombre}</span>` : ''}
            <span class="gasto-item-importe">‚Ç¨${parseFloat(g.importe).toFixed(2)}</span>
          </div>
        `;
      }).join('');
    }

    // TABLA DE REPARTO
    function renderRepartoTable() {
      const container = document.getElementById('reparto-table');
      if (!container) return;

      if (nidosData.length === 0) {
        container.innerHTML = '<tr><td>No hay nidos configurados</td></tr>';
        return;
      }

      let html = `
        <thead>
          <tr>
            <th>Nido</th>
            <th style="text-align:right">Porcentaje</th>
          </tr>
        </thead>
        <tbody>
      `;

      nidosData.forEach((nido, i) => {
        const color = coloresNidoHex[i % coloresNidoHex.length];
        const porcentaje = repartoData[nido.id] || 0;
        
        html += `
          <tr>
            <td>
              <div class="reparto-nido-nombre">
                <div class="reparto-nido-color" style="background:${color}"></div>
                <span>${nido.nombre}</span>
              </div>
            </td>
            <td style="text-align:right">
              <input type="number" class="reparto-input" 
                id="reparto-${nido.id}" 
                value="${porcentaje}" 
                min="0" max="100" 
                onchange="actualizarReparto('${nido.id}', this.value)"> %
            </td>
          </tr>
        `;
      });

      html += '</tbody>';
      container.innerHTML = html;

      actualizarTotalReparto();
    }

    function actualizarReparto(nidoId, valor) {
      repartoData[nidoId] = parseInt(valor) || 0;
      actualizarTotalReparto();
    }

    function actualizarTotalReparto() {
      const container = document.getElementById('reparto-total');
      if (!container) return;

      const total = Object.values(repartoData).reduce((sum, v) => sum + (parseInt(v) || 0), 0);
      const esValido = total === 100;

      container.innerHTML = `
        <span class="reparto-total-label">Total</span>
        <span class="reparto-total-valor ${esValido ? 'ok' : 'error'}">${total}%</span>
      `;
    }

    async function guardarReparto() {
      const total = Object.values(repartoData).reduce((sum, v) => sum + (parseInt(v) || 0), 0);
      
      if (total !== 100) {
        alert('El total debe sumar exactamente 100%');
        return;
      }

      try {
        await db.collection('bienes').doc(bienId).collection('config').doc('reparto').set({
          porcentajes: repartoData,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Reparto guardado');
        renderRepartoDesglose();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
    }

    function renderRepartoDesglose() {
      const container = document.getElementById('reparto-desglose');
      if (!container) return;

      const gastosFiltrados = getGastosFiltrados();
      const total = gastosFiltrados.reduce((sum, g) => sum + (parseFloat(g.importe) || 0), 0);

      if (total === 0 || nidosData.length === 0) {
        container.innerHTML = '';
        return;
      }

      const periodoLabel = gastosPeriodo === 'mes' ? 'este mes' : gastosPeriodo === 'a√±o' ? 'este a√±o' : 'en total';

      let html = `<div class="reparto-desglose-title">Desglose ${periodoLabel} (‚Ç¨${total.toFixed(2)})</div>`;

      nidosData.forEach((nido, i) => {
        const porcentaje = repartoData[nido.id] || 0;
        const importe = (total * porcentaje / 100);
        const color = coloresNidoHex[i % coloresNidoHex.length];
        
        html += `
          <div class="reparto-desglose-item">
            <span style="display:flex;align-items:center;gap:6px;">
              <span style="width:8px;height:8px;border-radius:2px;background:${color}"></span>
              ${nido.nombre} (${porcentaje}%)
            </span>
            <span>‚Ç¨${importe.toFixed(2)}</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // MODAL GASTOS
    const modalGasto = document.getElementById('modal-gasto');
    const formGasto = document.getElementById('form-gasto');

    function abrirModalGasto(gasto = null) {
      editingGastoId = gasto?.id || null;
      formGasto.reset();
      document.getElementById('btn-eliminar-gasto').classList.toggle('hidden', !gasto);
      
      document.getElementById('gasto-fecha').value = formatDateInput(new Date());
      
      if (gasto) {
        document.getElementById('modal-gasto-title').textContent = '‚úèÔ∏è Editar gasto';
        document.getElementById('gasto-fecha').value = gasto.fecha || '';
        document.getElementById('gasto-importe').value = gasto.importe || '';
        document.getElementById('gasto-concepto').value = gasto.concepto || '';
        document.getElementById('gasto-categoria').value = gasto.categoria || 'otro';
        document.getElementById('gasto-proveedor').value = gasto.proveedor || '';
        document.getElementById('gasto-generador').value = gasto.generadorId || '';
        document.getElementById('gasto-notas').value = gasto.notas || '';
      } else {
        document.getElementById('modal-gasto-title').textContent = 'üí∂ Nuevo gasto';
      }
      modalGasto.classList.add('active');
    }

    document.getElementById('modal-gasto-close').addEventListener('click', () => modalGasto.classList.remove('active'));
    document.getElementById('modal-gasto-cancelar').addEventListener('click', () => modalGasto.classList.remove('active'));
    modalGasto.addEventListener('click', (e) => { if (e.target === modalGasto) modalGasto.classList.remove('active'); });

    formGasto.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-gasto-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        const generadorId = document.getElementById('gasto-generador').value;
        const nido = generadorId ? nidosData.find(n => n.id === generadorId) : null;
        
        const data = {
          fecha: document.getElementById('gasto-fecha').value,
          importe: parseFloat(document.getElementById('gasto-importe').value) || 0,
          concepto: document.getElementById('gasto-concepto').value,
          categoria: document.getElementById('gasto-categoria').value,
          proveedor: document.getElementById('gasto-proveedor').value,
          generadorId: generadorId || null,
          generadorNombre: nido?.nombre || null,
          notas: document.getElementById('gasto-notas').value,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const ref = db.collection('bienes').doc(bienId).collection('gastos');
        if (editingGastoId) {
          await ref.doc(editingGastoId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await ref.add(data);
        }
        
        modalGasto.classList.remove('active');
        await loadGastos();
        renderGastos();
      } catch (error) {
        console.error(error);
        alert('Error al guardar');
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-gasto').addEventListener('click', async () => {
      if (!editingGastoId || !confirm('¬øEliminar este gasto?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('gastos').doc(editingGastoId).delete();
        modalGasto.classList.remove('active');
        await loadGastos();
        renderGastos();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });

    // ========== CASEROS ==========
    const seccionesPermisos = ['reservas', 'inventario', 'mantenimiento', 'limpieza', 'gastos', 'documentos'];
    const seccionesLabels = {
      reservas: 'üìÖ',
      inventario: 'üì¶',
      mantenimiento: 'üîß',
      limpieza: 'üßπ',
      gastos: 'üí∂',
      documentos: 'üìÑ'
    };

    function renderCaserosList() {
      const container = document.getElementById('lista-caseros');
      if (!container) return;

      if (caserosData.length === 0) {
        container.innerHTML = '<div class="empty-mini">Sin caseros asignados</div>';
        return;
      }

      container.innerHTML = caserosData.map(c => {
        const iniciales = c.nombre ? c.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
        
        // Contar permisos activos
        const permisos = c.permisos || {};
        const permisosActivos = [];
        seccionesPermisos.forEach(sec => {
          if (permisos[sec]?.ver) {
            const tieneEdicion = permisos[sec].crear || permisos[sec].editar;
            permisosActivos.push({ sec, limitado: !tieneEdicion });
          }
        });

        return `
          <div class="casero-card" onclick="abrirModalCasero(caserosData.find(x=>x.id==='${c.id}'))">
            <div class="casero-card-header">
              <div class="casero-avatar">${iniciales}</div>
              <div class="casero-info">
                <div class="casero-nombre">${c.nombre}</div>
                <div class="casero-email">${c.email}${c.telefono ? ' ¬∑ ' + c.telefono : ''}</div>
              </div>
            </div>
            <div class="casero-permisos">
              ${permisosActivos.map(p => `
                <span class="casero-permiso-badge ${p.limitado ? 'limitado' : ''}">${seccionesLabels[p.sec]}</span>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // MODAL CASERO
    const modalCasero = document.getElementById('modal-casero');
    const formCasero = document.getElementById('form-casero');

    function abrirModalCasero(casero = null) {
      editingCaseroId = casero?.id || null;
      formCasero.reset();
      document.getElementById('btn-eliminar-casero').classList.toggle('hidden', !casero);
      
      // Reset checkboxes a valores por defecto
      seccionesPermisos.forEach(sec => {
        document.getElementById(`perm-${sec}-v`).checked = true;
        document.getElementById(`perm-${sec}-c`).checked = ['inventario', 'mantenimiento', 'limpieza', 'gastos'].includes(sec);
        document.getElementById(`perm-${sec}-e`).checked = ['inventario', 'limpieza'].includes(sec);
        document.getElementById(`perm-${sec}-b`).checked = false;
      });
      
      if (casero) {
        document.getElementById('modal-casero-title').textContent = '‚úèÔ∏è Editar casero';
        document.getElementById('casero-nombre').value = casero.nombre || '';
        document.getElementById('casero-email').value = casero.email || '';
        document.getElementById('casero-email').disabled = true; // No editar email
        document.getElementById('casero-telefono').value = casero.telefono || '';
        
        // Cargar permisos
        const permisos = casero.permisos || {};
        seccionesPermisos.forEach(sec => {
          document.getElementById(`perm-${sec}-v`).checked = permisos[sec]?.ver || false;
          document.getElementById(`perm-${sec}-c`).checked = permisos[sec]?.crear || false;
          document.getElementById(`perm-${sec}-e`).checked = permisos[sec]?.editar || false;
          document.getElementById(`perm-${sec}-b`).checked = permisos[sec]?.borrar || false;
        });
      } else {
        document.getElementById('modal-casero-title').textContent = 'üë§ Nuevo casero';
        document.getElementById('casero-email').disabled = false;
      }
      modalCasero.classList.add('active');
    }

    document.getElementById('modal-casero-close').addEventListener('click', () => modalCasero.classList.remove('active'));
    document.getElementById('modal-casero-cancelar').addEventListener('click', () => modalCasero.classList.remove('active'));
    modalCasero.addEventListener('click', (e) => { if (e.target === modalCasero) modalCasero.classList.remove('active'); });

    formCasero.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('modal-casero-guardar');
      btn.disabled = true; btn.textContent = 'Guardando...';
      
      try {
        // Recoger permisos de la matriz
        const permisos = {};
        seccionesPermisos.forEach(sec => {
          permisos[sec] = {
            ver: document.getElementById(`perm-${sec}-v`).checked,
            crear: document.getElementById(`perm-${sec}-c`).checked,
            editar: document.getElementById(`perm-${sec}-e`).checked,
            borrar: document.getElementById(`perm-${sec}-b`).checked
          };
        });

        const data = {
          nombre: document.getElementById('casero-nombre').value,
          email: document.getElementById('casero-email').value.toLowerCase().trim(),
          telefono: document.getElementById('casero-telefono').value,
          permisos: permisos,
          bienId: bienId,
          bienNombre: bienData.nombre || '',
          familiaId: bienData.familiaId || familiaId,
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (!data.email) {
          alert('El email es obligatorio');
          btn.disabled = false; btn.textContent = 'Guardar';
          return;
        }
        
        const ref = db.collection('bienes').doc(bienId).collection('caseros');
        
        if (editingCaseroId) {
          await ref.doc(editingCaseroId).update(data);
        } else {
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          data.activo = true;
          
          // Crear en subcolecci√≥n del bien
          await ref.add(data);
        }
        
        modalCasero.classList.remove('active');
        await loadCaseros();
        document.getElementById('count-caseros').textContent = caserosData.length;
        renderCaserosList();
        
        if (!editingCaseroId) {
          alert('‚úÖ Casero a√±adido.\n\nEmail: ' + data.email);
        }
      } catch (error) {
        console.error('Error guardando casero:', error);
        alert('Error al guardar: ' + error.message);
      }
      
      btn.disabled = false; btn.textContent = 'Guardar';
    });

    document.getElementById('btn-eliminar-casero').addEventListener('click', async () => {
      if (!editingCaseroId || !confirm('¬øEliminar este casero? Perder√° acceso a este bien.')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('caseros').doc(editingCaseroId).delete();
        modalCasero.classList.remove('active');
        await loadCaseros();
        document.getElementById('count-caseros').textContent = caserosData.length;
        renderCaserosList();
      } catch (error) {
        console.error(error);
        alert('Error');
      }
    });
  </script>
</body>
</html>
