<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Bien</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: var(--cream-dark);
      color: var(--text);
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-float);
    }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
      border: 1px solid var(--cream-dark);
    }

    .btn-secondary:hover {
      background: var(--cream-dark);
    }

    .btn-mayordomo {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%);
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    /* Main layout */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .layout-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Hero del bien */
    .bien-hero {
      background: var(--white);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }

    .bien-hero-image {
      height: 200px;
      background: linear-gradient(135deg, var(--sage-light) 0%, var(--sage) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5rem;
      position: relative;
    }

    .bien-hero-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .bien-hero-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--mayordomo);
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bien-hero-body {
      padding: 20px;
    }

    .bien-tipo-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--sage-dark);
      font-weight: 700;
      margin-bottom: 4px;
    }

    .bien-nombre {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .bien-ubicacion {
      color: var(--text-light);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    .bien-meta {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .bien-meta-item {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .bien-meta-item strong {
      color: var(--text);
    }

    /* Secciones colapsables */
    .collapsible-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .collapsible-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }

    .collapsible-header:hover {
      background: var(--cream-medium);
    }

    .collapsible-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .collapsible-count {
      font-size: 0.75rem;
      background: var(--sage-muted);
      color: var(--sage-dark);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .collapsible-toggle {
      font-size: 1.2rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .collapsible-section.open .collapsible-toggle {
      transform: rotate(180deg);
    }

    .collapsible-body {
      padding: 0 20px 20px;
      display: none;
    }

    .collapsible-section.open .collapsible-body {
      display: block;
    }

    /* Listas de items */
    .info-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .info-item-icon {
      font-size: 1.3rem;
    }

    .info-item-content {
      flex: 1;
    }

    .info-item-title {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .info-item-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .info-item-action {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      opacity: 0.5;
      padding: 4px;
    }

    .info-item-action:hover {
      opacity: 1;
    }

    /* Galer√≠a mini */
    .galeria-mini {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
    }

    .galeria-mini-item {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-md);
      overflow: hidden;
      flex-shrink: 0;
      background: var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .galeria-mini-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Normas box */
    .normas-box {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-line;
    }

    /* MAYORDOMO PANEL */
    .mayordomo-section {
      margin-bottom: 24px;
    }

    .mayordomo-header {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-light) 100%);
      border-radius: var(--radius-lg);
      padding: 20px;
      color: white;
      margin-bottom: 16px;
    }

    .mayordomo-header h2 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mayordomo-header p {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    /* M√≥dulos grid */
    .modulos-operativos {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .modulo-panel {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .modulo-panel-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--cream-dark);
    }

    .modulo-panel-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modulo-panel-body {
      padding: 16px 20px;
    }

    /* Reservas - Calendario mini */
    .reservas-proximas {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .reserva-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--sage);
    }

    .reserva-fecha {
      text-align: center;
      min-width: 50px;
    }

    .reserva-fecha-dia {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--sage-dark);
    }

    .reserva-fecha-mes {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .reserva-info {
      flex: 1;
    }

    .reserva-quien {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .reserva-periodo {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Inventario */
    .inventario-alerta {
      background: var(--warning);
      color: white;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .inventario-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .inventario-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .inventario-item.bajo {
      border-left: 3px solid var(--error);
    }

    .inventario-item-nombre {
      flex: 1;
      font-size: 0.9rem;
    }

    .inventario-item-stock {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .inventario-item-stock.bajo {
      color: var(--error);
      font-weight: 600;
    }

    /* Mantenimiento */
    .mantenimiento-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mantenimiento-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .mantenimiento-tipo {
      font-size: 1.3rem;
    }

    .mantenimiento-info {
      flex: 1;
    }

    .mantenimiento-titulo {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .mantenimiento-fecha {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .mantenimiento-badge {
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .mantenimiento-badge.programado {
      background: var(--sage-muted);
      color: var(--sage-dark);
    }

    .mantenimiento-badge.pendiente {
      background: var(--warning);
      color: white;
    }

    .mantenimiento-badge.averia {
      background: var(--error);
      color: white;
    }

    /* Limpieza */
    .limpieza-checklist {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .limpieza-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .limpieza-item:hover {
      background: var(--cream-dark);
    }

    .limpieza-item.done {
      opacity: 0.5;
    }

    .limpieza-item.done .limpieza-texto {
      text-decoration: line-through;
    }

    .limpieza-check {
      width: 22px;
      height: 22px;
      border: 2px solid var(--sage);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: white;
      flex-shrink: 0;
    }

    .limpieza-item.done .limpieza-check {
      background: var(--sage);
    }

    .limpieza-texto {
      font-size: 0.9rem;
    }

    /* Eventos */
    .eventos-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .evento-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .evento-icono {
      font-size: 1.5rem;
    }

    .evento-info {
      flex: 1;
    }

    .evento-nombre {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .evento-fecha {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .evento-tipo {
      font-size: 0.65rem;
      padding: 3px 8px;
      background: var(--terracotta-muted);
      color: var(--terracotta);
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    /* Gastos */
    .gastos-resumen {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .gasto-stat {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }

    .gasto-stat-valor {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--sage-dark);
    }

    .gasto-stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .gastos-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .gasto-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .gasto-item-nombre {
      font-size: 0.9rem;
    }

    .gasto-item-valor {
      font-weight: 600;
      color: var(--terracotta);
    }

    /* Otros servicios */
    .servicios-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .servicio-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }

    .servicio-icono {
      font-size: 1.3rem;
    }

    .servicio-nombre {
      flex: 1;
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Sidebar - Panel derecho */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Empty state */
    .empty-mini {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .empty-mini-icon {
      font-size: 2rem;
      opacity: 0.3;
      margin-bottom: 8px;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="bienes.html" class="back-btn">
        <span>‚Üê</span>
        <span>El Com√∫n</span>
      </a>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary btn-sm" id="btn-editar">‚úèÔ∏è Editar</button>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Loading -->
    <div id="page-loading" class="loading">
      <div class="spinner"></div>
    </div>

    <!-- Content -->
    <div id="page-content" class="hidden">
      
      <!-- Hero del bien -->
      <div class="bien-hero">
        <div class="bien-hero-image" id="bien-hero-image">
          üè†
        </div>
        <div class="bien-hero-body">
          <div class="bien-tipo-label" id="bien-tipo">Inmueble</div>
          <h1 class="bien-nombre" id="bien-nombre">Cargando...</h1>
          <div class="bien-ubicacion" id="bien-ubicacion">
            <span>üìç</span>
            <span>...</span>
          </div>
          <div class="bien-meta">
            <div class="bien-meta-item"><strong>Titularidad:</strong> <span id="bien-titularidad">-</span></div>
            <div class="bien-meta-item"><strong>Origen:</strong> <span id="bien-origen">-</span></div>
          </div>
        </div>
      </div>

      <div class="layout-grid">
        <!-- Columna principal: Mayordomo -->
        <div class="main-column">
          
          <!-- Secci√≥n Mayordomo -->
          <div class="mayordomo-section hidden" id="mayordomo-section">
            <div class="mayordomo-header">
              <h2>üé© Mayordomo</h2>
              <p>Gesti√≥n activa de este bien</p>
            </div>

            <div class="modulos-operativos" id="modulos-operativos">
              <!-- Los m√≥dulos activos se cargan din√°micamente -->
            </div>
          </div>

          <!-- Si no hay Mayordomo -->
          <div class="collapsible-section" id="no-mayordomo-section">
            <div class="collapsible-header" style="cursor: default;">
              <div class="collapsible-title">
                <span>üé©</span>
                <span>Mayordomo</span>
              </div>
            </div>
            <div class="collapsible-body" style="display: block;">
              <div class="empty-mini">
                <div class="empty-mini-icon">üé©</div>
                <p>El Mayordomo no est√° activado para este bien.</p>
                <button class="btn btn-mayordomo btn-sm" style="margin-top: 12px;" onclick="editarBien()">Activar Mayordomo</button>
              </div>
            </div>
          </div>

        </div>

        <!-- Sidebar: Ficha B√°sica -->
        <div class="sidebar">
          
          <!-- Galer√≠a -->
          <div class="collapsible-section open" id="section-galeria">
            <div class="collapsible-header" onclick="toggleSection('galeria')">
              <div class="collapsible-title">
                <span>üì∑</span>
                <span>Galer√≠a</span>
                <span class="collapsible-count" id="count-galeria">0</span>
              </div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="galeria-mini" id="galeria-fotos">
                <div class="empty-mini" style="padding: 12px;">Sin fotos</div>
              </div>
            </div>
          </div>

          <!-- Personal -->
          <div class="collapsible-section" id="section-personal">
            <div class="collapsible-header" onclick="toggleSection('personal')">
              <div class="collapsible-title">
                <span>üë∑</span>
                <span>Personal</span>
                <span class="collapsible-count" id="count-personal">0</span>
              </div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="info-list" id="lista-personal">
                <div class="empty-mini">Sin personal registrado</div>
              </div>
            </div>
          </div>

          <!-- Mascotas -->
          <div class="collapsible-section" id="section-mascotas">
            <div class="collapsible-header" onclick="toggleSection('mascotas')">
              <div class="collapsible-title">
                <span>üêæ</span>
                <span>Mascotas</span>
                <span class="collapsible-count" id="count-mascotas">0</span>
              </div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="info-list" id="lista-mascotas">
                <div class="empty-mini">Sin mascotas registradas</div>
              </div>
            </div>
          </div>

          <!-- Contactos -->
          <div class="collapsible-section" id="section-contactos">
            <div class="collapsible-header" onclick="toggleSection('contactos')">
              <div class="collapsible-title">
                <span>üìû</span>
                <span>Contactos</span>
                <span class="collapsible-count" id="count-contactos">0</span>
              </div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="info-list" id="lista-contactos">
                <div class="empty-mini">Sin contactos registrados</div>
              </div>
            </div>
          </div>

          <!-- Documentos -->
          <div class="collapsible-section" id="section-documentos">
            <div class="collapsible-header" onclick="toggleSection('documentos')">
              <div class="collapsible-title">
                <span>üìÑ</span>
                <span>Documentos</span>
                <span class="collapsible-count" id="count-documentos">0</span>
              </div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="info-list" id="lista-documentos">
                <div class="empty-mini">Sin documentos</div>
              </div>
            </div>
          </div>

          <!-- Normas -->
          <div class="collapsible-section" id="section-normas">
            <div class="collapsible-header" onclick="toggleSection('normas')">
              <div class="collapsible-title">
                <span>üìú</span>
                <span>Normas</span>
              </div>
              <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <div class="normas-box" id="normas-texto">
                Sin normas definidas
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;

    // Get bien ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');

    if (!bienId) {
      window.location.href = 'bienes.html';
    }

    // Check auth state
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      
      currentUser = user;
      await loadBien();
    });

    async function loadBien() {
      const loadingEl = document.getElementById('page-loading');
      const contentEl = document.getElementById('page-content');

      try {
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        
        if (!bienDoc.exists) {
          alert('Bien no encontrado');
          window.location.href = 'bienes.html';
          return;
        }

        bienData = { id: bienDoc.id, ...bienDoc.data() };
        
        renderBien();

        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');

      } catch (error) {
        console.error('Error loading bien:', error);
        alert('Error al cargar el bien');
        window.location.href = 'bienes.html';
      }
    }

    function renderBien() {
      const tipoIcons = { inmueble: 'üè†', terreno: 'üå≥', vehiculo: 'üöó', ajuar: 'ü™ë' };
      const tipoLabels = { inmueble: 'Inmueble', terreno: 'Terreno', vehiculo: 'Veh√≠culo', ajuar: 'Ajuar' };
      const rolIcons = { limpieza: 'üßπ', jardinero: 'üå±', cuidador: 'üë®‚Äç‚öïÔ∏è', mantenimiento: 'üîß', otro: 'üìã' };
      const mascotaIcons = { perro: 'üêï', gato: 'üêà', ave: 'üê¶', otro: 'üêæ' };
      const catIcons = { mantenimiento: 'üîß', vecino: 'üèòÔ∏è', emergencia: 'üö®', suministros: 'üí°', otro: 'üìã' };
      const docIcons = { escritura: 'üìú', seguro: 'üõ°Ô∏è', suministro: 'üí°', empleado: 'üë∑', itv: 'üöó', comunidad: 'üè¢', otro: 'üìÑ' };

      // Hero
      document.getElementById('bien-hero-image').innerHTML = bienData.fotos && bienData.fotos.length > 0
        ? `<img src="${bienData.fotos[0].url}" alt="${bienData.nombre}">${bienData.mayordomoActivo ? '<span class="bien-hero-badge">üé© Mayordomo</span>' : ''}`
        : tipoIcons[bienData.tipo] || 'üè†';
      
      document.getElementById('bien-tipo').textContent = tipoLabels[bienData.tipo] || bienData.tipo;
      document.getElementById('bien-nombre').textContent = bienData.nombre;
      document.getElementById('bien-ubicacion').innerHTML = bienData.ubicacion 
        ? `<span>üìç</span><span>${bienData.ubicacion}</span>` 
        : '';
      document.getElementById('bien-titularidad').textContent = bienData.titularidad || '-';
      document.getElementById('bien-origen').textContent = bienData.origen || '-';

      // Galer√≠a
      const fotos = [...(bienData.fotos || []), ...(bienData.croquis || []), ...(bienData.planos || [])];
      document.getElementById('count-galeria').textContent = fotos.length;
      if (fotos.length > 0) {
        document.getElementById('galeria-fotos').innerHTML = fotos.map(f => 
          `<div class="galeria-mini-item"><img src="${f.url}" alt=""></div>`
        ).join('');
      }

      // Personal
      const personal = bienData.personal || [];
      document.getElementById('count-personal').textContent = personal.length;
      if (personal.length > 0) {
        document.getElementById('lista-personal').innerHTML = personal.map(p => `
          <div class="info-item">
            <span class="info-item-icon">${rolIcons[p.rol] || 'üë∑'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${p.nombre}</div>
              <div class="info-item-subtitle">${p.tipo === 'residente' ? 'Residente' : 'Puntual'}${p.telefono ? ' ¬∑ ' + p.telefono : ''}</div>
            </div>
            ${p.telefono ? `<a href="tel:${p.telefono}" class="info-item-action">üìû</a>` : ''}
          </div>
        `).join('');
      }

      // Mascotas
      const mascotas = bienData.mascotas || [];
      document.getElementById('count-mascotas').textContent = mascotas.length;
      if (mascotas.length > 0) {
        document.getElementById('lista-mascotas').innerHTML = mascotas.map(m => `
          <div class="info-item">
            <span class="info-item-icon">${mascotaIcons[m.tipo] || 'üêæ'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${m.nombre}</div>
              <div class="info-item-subtitle">${m.raza || m.tipo}${m.residencia === 'visitante' ? ' ¬∑ Visitante' : ''}</div>
            </div>
          </div>
        `).join('');
      }

      // Contactos
      const contactos = bienData.contactos || [];
      document.getElementById('count-contactos').textContent = contactos.length;
      if (contactos.length > 0) {
        document.getElementById('lista-contactos').innerHTML = contactos.map(c => `
          <div class="info-item">
            <span class="info-item-icon">${catIcons[c.categoria] || 'üìû'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${c.nombre}</div>
              <div class="info-item-subtitle">${c.telefono || ''}${c.notas ? ' ¬∑ ' + c.notas : ''}</div>
            </div>
            ${c.telefono ? `<a href="tel:${c.telefono}" class="info-item-action">üìû</a>` : ''}
          </div>
        `).join('');
      }

      // Documentos
      const documentos = bienData.documentos || [];
      document.getElementById('count-documentos').textContent = documentos.length;
      if (documentos.length > 0) {
        document.getElementById('lista-documentos').innerHTML = documentos.map(d => `
          <div class="info-item">
            <span class="info-item-icon">${docIcons[d.tipo] || 'üìÑ'}</span>
            <div class="info-item-content">
              <div class="info-item-title">${d.nombre}</div>
              <div class="info-item-subtitle">${d.fechaVencimiento ? 'Vence: ' + formatDate(d.fechaVencimiento) : ''}</div>
            </div>
          </div>
        `).join('');
      }

      // Normas
      if (bienData.normasConvivencia) {
        document.getElementById('normas-texto').textContent = bienData.normasConvivencia;
      }

      // MAYORDOMO
      if (bienData.mayordomoActivo) {
        document.getElementById('mayordomo-section').classList.remove('hidden');
        document.getElementById('no-mayordomo-section').classList.add('hidden');
        renderMayordomoModulos();
      } else {
        document.getElementById('mayordomo-section').classList.add('hidden');
        document.getElementById('no-mayordomo-section').classList.remove('hidden');
      }
    }

    function renderMayordomoModulos() {
      const container = document.getElementById('modulos-operativos');
      const modulos = bienData.mayordomoModulos || {};
      let html = '';

      // Reservas
      if (modulos.reservas) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header">
              <div class="modulo-panel-title">üìÖ Reservas</div>
              <button class="btn btn-sm btn-secondary">+ Nueva</button>
            </div>
            <div class="modulo-panel-body">
              <div class="reservas-proximas">
                <div class="reserva-item">
                  <div class="reserva-fecha">
                    <div class="reserva-fecha-dia">14</div>
                    <div class="reserva-fecha-mes">DIC</div>
                  </div>
                  <div class="reserva-info">
                    <div class="reserva-quien">Familia Rodr√≠guez</div>
                    <div class="reserva-periodo">14-21 diciembre ¬∑ 7 noches</div>
                  </div>
                </div>
                <div class="reserva-item">
                  <div class="reserva-fecha">
                    <div class="reserva-fecha-dia">24</div>
                    <div class="reserva-fecha-mes">DIC</div>
                  </div>
                  <div class="reserva-info">
                    <div class="reserva-quien">Toda la familia</div>
                    <div class="reserva-periodo">24-26 diciembre ¬∑ Navidad</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Inventario
      if (modulos.inventario) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header">
              <div class="modulo-panel-title">üì¶ Inventario</div>
              <button class="btn btn-sm btn-secondary">Ver todo</button>
            </div>
            <div class="modulo-panel-body">
              <div class="inventario-alerta">
                ‚ö†Ô∏è 3 art√≠culos bajo m√≠nimo
              </div>
              <div class="inventario-list">
                <div class="inventario-item bajo">
                  <span>üßª</span>
                  <span class="inventario-item-nombre">Papel higi√©nico</span>
                  <span class="inventario-item-stock bajo">2 / 6</span>
                </div>
                <div class="inventario-item bajo">
                  <span>üß¥</span>
                  <span class="inventario-item-nombre">Jab√≥n manos</span>
                  <span class="inventario-item-stock bajo">1 / 3</span>
                </div>
                <div class="inventario-item bajo">
                  <span>üç∑</span>
                  <span class="inventario-item-nombre">Vino tinto</span>
                  <span class="inventario-item-stock bajo">0 / 2</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Mantenimiento
      if (modulos.mantenimiento) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header">
              <div class="modulo-panel-title">üîß Mantenimiento</div>
              <button class="btn btn-sm btn-secondary">+ A√±adir</button>
            </div>
            <div class="modulo-panel-body">
              <div class="mantenimiento-list">
                <div class="mantenimiento-item">
                  <span class="mantenimiento-tipo">üî•</span>
                  <div class="mantenimiento-info">
                    <div class="mantenimiento-titulo">Revisi√≥n caldera</div>
                    <div class="mantenimiento-fecha">15 diciembre 2025</div>
                  </div>
                  <span class="mantenimiento-badge programado">Programado</span>
                </div>
                <div class="mantenimiento-item">
                  <span class="mantenimiento-tipo">üí°</span>
                  <div class="mantenimiento-info">
                    <div class="mantenimiento-titulo">Cambiar bombilla terraza</div>
                    <div class="mantenimiento-fecha">Reportado hace 3 d√≠as</div>
                  </div>
                  <span class="mantenimiento-badge pendiente">Pendiente</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Limpieza
      if (modulos.limpieza) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header">
              <div class="modulo-panel-title">üßπ Limpieza</div>
              <span style="font-size: 0.8rem; color: var(--text-muted);">Entrada: 14 dic</span>
            </div>
            <div class="modulo-panel-body">
              <div class="limpieza-checklist">
                <div class="limpieza-item done" onclick="toggleLimpieza(this)">
                  <div class="limpieza-check">‚úì</div>
                  <span class="limpieza-texto">Cambiar s√°banas hab. principal</span>
                </div>
                <div class="limpieza-item done" onclick="toggleLimpieza(this)">
                  <div class="limpieza-check">‚úì</div>
                  <span class="limpieza-texto">Cambiar s√°banas hab. ni√±os</span>
                </div>
                <div class="limpieza-item" onclick="toggleLimpieza(this)">
                  <div class="limpieza-check"></div>
                  <span class="limpieza-texto">Limpiar ba√±os</span>
                </div>
                <div class="limpieza-item" onclick="toggleLimpieza(this)">
                  <div class="limpieza-check"></div>
                  <span class="limpieza-texto">Fregar suelos</span>
                </div>
                <div class="limpieza-item" onclick="toggleLimpieza(this)">
                  <div class="limpieza-check"></div>
                  <span class="limpieza-texto">Reponer amenities</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Eventos
      if (modulos.eventos) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header">
              <div class="modulo-panel-title">üéâ Eventos</div>
              <button class="btn btn-sm btn-secondary">+ Nuevo</button>
            </div>
            <div class="modulo-panel-body">
              <div class="eventos-list">
                <div class="evento-item">
                  <span class="evento-icono">üéÑ</span>
                  <div class="evento-info">
                    <div class="evento-nombre">Cena de Navidad</div>
                    <div class="evento-fecha">24 diciembre ¬∑ 20:00</div>
                  </div>
                  <span class="evento-tipo">Familia</span>
                </div>
                <div class="evento-item">
                  <span class="evento-icono">üéÇ</span>
                  <div class="evento-info">
                    <div class="evento-nombre">Cumple de Pablo</div>
                    <div class="evento-fecha">25 noviembre ¬∑ 17:00</div>
                  </div>
                  <span class="evento-tipo">Celebraci√≥n</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Gastos
      if (modulos.gastos) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header">
              <div class="modulo-panel-title">üí∂ Gastos</div>
              <button class="btn btn-sm btn-secondary">+ A√±adir</button>
            </div>
            <div class="modulo-panel-body">
              <div class="gastos-resumen">
                <div class="gasto-stat">
                  <div class="gasto-stat-valor">‚Ç¨245</div>
                  <div class="gasto-stat-label">Este mes</div>
                </div>
                <div class="gasto-stat">
                  <div class="gasto-stat-valor">‚Ç¨1,840</div>
                  <div class="gasto-stat-label">Este a√±o</div>
                </div>
              </div>
              <div class="gastos-list">
                <div class="gasto-item">
                  <span class="gasto-item-nombre">üí° Luz (nov)</span>
                  <span class="gasto-item-valor">‚Ç¨85</span>
                </div>
                <div class="gasto-item">
                  <span class="gasto-item-nombre">üíß Agua (nov)</span>
                  <span class="gasto-item-valor">‚Ç¨32</span>
                </div>
                <div class="gasto-item">
                  <span class="gasto-item-nombre">üè¢ Comunidad</span>
                  <span class="gasto-item-valor">‚Ç¨128</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Otros Servicios
      if (modulos.otrosServicios) {
        html += `
          <div class="modulo-panel">
            <div class="modulo-panel-header">
              <div class="modulo-panel-title">üõéÔ∏è Otros Servicios</div>
              <button class="btn btn-sm btn-secondary">+ A√±adir</button>
            </div>
            <div class="modulo-panel-body">
              <div class="servicios-list">
                <div class="servicio-item">
                  <span class="servicio-icono">üçΩÔ∏è</span>
                  <span class="servicio-nombre">Catering</span>
                </div>
                <div class="servicio-item">
                  <span class="servicio-icono">üöê</span>
                  <span class="servicio-nombre">Transporte</span>
                </div>
                <div class="servicio-item">
                  <span class="servicio-icono">‚õΩ</span>
                  <span class="servicio-nombre">Consumos</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Si no hay ning√∫n m√≥dulo activo
      if (!html) {
        html = `
          <div class="empty-mini">
            <div class="empty-mini-icon">üìã</div>
            <p>No hay subm√≥dulos activados. Edita el bien para activarlos.</p>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    function toggleSection(section) {
      const el = document.getElementById(`section-${section}`);
      el.classList.toggle('open');
    }

    function toggleLimpieza(item) {
      item.classList.toggle('done');
      const check = item.querySelector('.limpieza-check');
      check.textContent = item.classList.contains('done') ? '‚úì' : '';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function editarBien() {
      // Redirigir a bienes.html con par√°metro para abrir modal de edici√≥n
      window.location.href = `bienes.html?edit=${bienId}`;
    }

    // Bot√≥n editar
    document.getElementById('btn-editar').addEventListener('click', editarBien);
  </script>
</body>
</html>
