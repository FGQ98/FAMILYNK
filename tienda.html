<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK — Tienda</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-dark: #6B5A45;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --warning-muted: rgba(232, 180, 77, 0.15);
      --error: #D4695A;
      --error-muted: rgba(212, 105, 90, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    /* ========== HEADER ========== */
    .header {
      background: var(--white);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: var(--cream-dark); }

    .header-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-icon {
      width: 32px;
      height: 32px;
      background: var(--sage-muted);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: var(--sage-dark);
      font-weight: 700;
    }

    /* Selector de Nido */
    .nido-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nido-selector label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .nido-selector select {
      padding: 8px 12px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--white);
      cursor: pointer;
      min-width: 180px;
    }

    .nido-selector select:focus {
      outline: none;
      border-color: var(--sage);
    }

    /* ========== MAIN ========== */
    .main {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    /* ========== TABS ========== */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--cream-dark);
      padding: 4px;
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
    }

    .tab {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Quicksand', sans-serif;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .tab:hover { color: var(--text); }

    .tab.active {
      background: var(--white);
      color: var(--text);
      box-shadow: var(--shadow-soft);
    }

    .tab-badge {
      padding: 2px 8px;
      background: var(--warning);
      color: white;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 700;
    }

    .tab.active .tab-badge { background: var(--sage); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ========== SECTION HEADER ========== */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .section-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--text);
    }

    .section-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* ========== FILTROS GRUPO ========== */
    .filtros-grupo {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filtro-chip {
      padding: 8px 14px;
      background: var(--white);
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s;
    }

    .filtro-chip:hover {
      border-color: var(--sage-light);
      color: var(--text);
    }

    .filtro-chip.active {
      background: var(--sage);
      border-color: var(--sage);
      color: white;
    }

    .filtro-chip .count {
      margin-left: 6px;
      opacity: 0.7;
    }

    /* ========== LISTA PRODUCTOS ========== */
    .productos-lista {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .producto-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--white);
      border-radius: var(--radius-md);
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .producto-item:hover {
      box-shadow: var(--shadow-soft);
    }

    .producto-item.selected {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .producto-item.urgente {
      border-color: var(--warning);
      background: var(--warning-muted);
    }

    .producto-item.critico {
      border-color: var(--error);
      background: var(--error-muted);
    }

    .producto-check {
      width: 22px;
      height: 22px;
      accent-color: var(--sage);
      cursor: pointer;
      flex-shrink: 0;
    }

    .producto-info {
      flex: 1;
      min-width: 0;
    }

    .producto-nombre {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 2px;
    }

    .producto-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .producto-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .producto-cantidad {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .cantidad-label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .cantidad-input {
      width: 60px;
      padding: 8px 10px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
    }

    .cantidad-input:focus {
      outline: none;
      border-color: var(--sage);
    }

    .cantidad-unidad {
      font-size: 0.8rem;
      color: var(--text-muted);
      min-width: 30px;
    }

    /* ========== ESPECIALES ========== */
    .especiales-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      text-decoration: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--sage);
      color: white;
    }

    .btn-primary:hover {
      background: var(--sage-dark);
    }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
      border: 1px solid var(--cream-dark);
    }

    .btn-secondary:hover {
      background: var(--cream-dark);
    }

    .btn-terracotta {
      background: var(--terracotta);
      color: white;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 0.8rem;
    }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      background: var(--cream-dark);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 1.5rem;
      color: var(--text-muted);
    }

    .empty-state-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 8px;
    }

    .empty-state-text {
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    /* ========== CARRITO FLOTANTE ========== */
    .carrito-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--white);
      border-top: 1px solid var(--cream-dark);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 90;
    }

    .carrito-bar.visible {
      transform: translateY(0);
    }

    .carrito-info {
      flex: 1;
    }

    .carrito-titulo {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
    }

    .carrito-detalle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .carrito-actions {
      display: flex;
      gap: 10px;
    }

    .btn-enviar {
      background: var(--sage);
      color: white;
      padding: 12px 24px;
      font-size: 0.9rem;
    }

    .btn-enviar:hover {
      background: var(--sage-dark);
    }

    .btn-ver-carrito {
      background: var(--cream);
      color: var(--text);
      padding: 12px 18px;
    }

    /* ========== MODAL ========== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 20px;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 500px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 4px;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--cream-dark);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-shrink: 0;
    }

    /* ========== FORM ========== */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--sage);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .form-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ========== CARRITO MODAL ========== */
    .carrito-lista {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .carrito-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }

    .carrito-item-info {
      flex: 1;
    }

    .carrito-item-nombre {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .carrito-item-grupo {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .carrito-item-cantidad {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--sage-dark);
    }

    .carrito-item-remove {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      font-size: 1.2rem;
    }

    .carrito-item-remove:hover {
      color: var(--error);
    }

    .carrito-seccion {
      margin-bottom: 20px;
    }

    .carrito-seccion-titulo {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 10px;
      font-weight: 700;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 700px) {
      .header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .header-left {
        justify-content: space-between;
      }

      .nido-selector {
        width: 100%;
      }

      .nido-selector select {
        flex: 1;
      }

      .producto-item {
        flex-wrap: wrap;
      }

      .producto-cantidad {
        width: 100%;
        justify-content: flex-end;
        padding-top: 8px;
        border-top: 1px dashed var(--cream-dark);
        margin-top: 8px;
      }

      .carrito-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      .carrito-actions {
        justify-content: stretch;
      }

      .carrito-actions .btn {
        flex: 1;
        justify-content: center;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* ========== LOADING ========== */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 48px;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="javascript:history.back()" class="back-btn">← Volver</a>
      <div class="header-title">
        <div class="header-icon">T</div>
        <span>Tienda</span>
      </div>
    </div>
    <div class="nido-selector">
      <label>Pedir para:</label>
      <select id="select-nido">
        <option value="">Selecciona tu nido</option>
      </select>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Estado inicial: sin nido seleccionado -->
    <div id="estado-sin-nido" class="empty-state">
      <div class="empty-state-icon">N</div>
      <div class="empty-state-title">Selecciona tu nido</div>
      <p class="empty-state-text">Elige el nido para el que quieres hacer el pedido</p>
    </div>

    <!-- Contenido principal -->
    <div id="contenido-principal" class="hidden">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="reposicion" onclick="cambiarTab('reposicion')">
          Reposición
          <span class="tab-badge" id="badge-reposicion">0</span>
        </button>
        <button class="tab" data-tab="especiales" onclick="cambiarTab('especiales')">
          Especiales
          <span class="tab-badge" id="badge-especiales">0</span>
        </button>
      </div>

      <!-- Tab: Reposición -->
      <div class="tab-content active" id="tab-reposicion">
        <div class="section-header">
          <div>
            <div class="section-title">Productos bajo mínimo</div>
            <div class="section-subtitle">Selecciona lo que necesitas reponer</div>
          </div>
        </div>

        <!-- Filtros por grupo -->
        <div class="filtros-grupo" id="filtros-reposicion"></div>

        <!-- Lista productos -->
        <div id="loading-reposicion" class="loading"><div class="spinner"></div></div>
        <div id="lista-reposicion" class="productos-lista hidden"></div>
        <div id="empty-reposicion" class="empty-state hidden">
          <div class="empty-state-icon">✓</div>
          <div class="empty-state-title">Todo en orden</div>
          <p class="empty-state-text">No hay productos por debajo del mínimo</p>
        </div>
      </div>

      <!-- Tab: Especiales -->
      <div class="tab-content" id="tab-especiales">
        <div class="especiales-header">
          <div>
            <div class="section-title">Productos especiales</div>
            <div class="section-subtitle">Pedidos extra para tu visita</div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="abrirModalEspecial()">+ Añadir</button>
        </div>

        <!-- Filtros por grupo -->
        <div class="filtros-grupo" id="filtros-especiales"></div>

        <!-- Lista especiales -->
        <div id="loading-especiales" class="loading hidden"><div class="spinner"></div></div>
        <div id="lista-especiales" class="productos-lista"></div>
        <div id="empty-especiales" class="empty-state hidden">
          <div class="empty-state-icon">+</div>
          <div class="empty-state-title">Sin especiales guardados</div>
          <p class="empty-state-text">Añade productos para pedidos puntuales</p>
          <button class="btn btn-primary" onclick="abrirModalEspecial()">+ Añadir especial</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Carrito flotante -->
  <div class="carrito-bar" id="carrito-bar">
    <div class="carrito-info">
      <div class="carrito-titulo" id="carrito-titulo">0 productos</div>
      <div class="carrito-detalle" id="carrito-detalle">Reposición: 0 · Especiales: 0</div>
    </div>
    <div class="carrito-actions">
      <button class="btn btn-ver-carrito" onclick="abrirModalCarrito()">Ver pedido</button>
      <button class="btn btn-enviar" onclick="enviarPedido()">Enviar pedido</button>
    </div>
  </div>

  <!-- Modal: Añadir Especial -->
  <div class="modal-overlay" id="modal-especial">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Añadir producto especial</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-especial" onsubmit="guardarEspecial(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre del producto</label>
            <input type="text" class="form-input" id="especial-nombre" placeholder="Ej: Cava Freixenet, Jamón ibérico..." required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Grupo</label>
              <select class="form-select" id="especial-grupo" required>
                <option value="alimentos">Alimentos</option>
                <option value="bebidas">Bebidas</option>
                <option value="higiene">Higiene</option>
                <option value="limpieza">Limpieza</option>
                <option value="mantenimiento">Mantenimiento</option>
                <option value="otros">Otros</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Unidades</label>
              <input type="number" class="form-input" id="especial-unidades" value="1" min="1">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="especial-notas" placeholder="Marca preferida, tamaño...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Añadir</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Ver Carrito -->
  <div class="modal-overlay" id="modal-carrito">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Resumen del pedido</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <div class="modal-body" id="carrito-body">
        <!-- Se llena dinámicamente -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModales()">Seguir añadiendo</button>
        <button class="btn btn-primary" onclick="enviarPedido()">Enviar pedido</button>
      </div>
    </div>
  </div>

  <!-- Modal: Confirmación envío -->
  <div class="modal-overlay" id="modal-confirmacion">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Pedido enviado</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <div class="modal-body" style="text-align: center; padding: 40px;">
        <div style="width:64px;height:64px;background:var(--sage-muted);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:1.8rem;color:var(--sage);">✓</div>
        <div style="font-family:'Quicksand',sans-serif;font-weight:700;font-size:1.2rem;margin-bottom:8px;">Pedido enviado correctamente</div>
        <p style="color:var(--text-muted);font-size:0.9rem;">Los caseros han recibido la notificación</p>
      </div>
      <div class="modal-footer" style="justify-content: center;">
        <button class="btn btn-primary" onclick="cerrarModales(); location.reload();">Entendido</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDh8RJrq57lPmsLe39neiKy2PSGB2Qhny4",
      authDomain: "familynk-dfadb.firebaseapp.com",
      projectId: "familynk-dfadb",
      storageBucket: "familynk-dfadb.firebasestorage.app",
      messagingSenderId: "778921307320",
      appId: "1:778921307320:web:4cb3952ea374054409584d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Estado global
    let currentUser = null;
    let bienId = null;
    let nidoActual = null;
    let nidosUsuario = [];
    let productosReposicion = [];
    let productosEspeciales = [];
    let carrito = { reposicion: [], especiales: [] };
    let filtroGrupoReposicion = 'todos';
    let filtroGrupoEspeciales = 'todos';

    const GRUPOS = {
      alimentos: 'Alimentos',
      bebidas: 'Bebidas',
      higiene: 'Higiene',
      limpieza: 'Limpieza',
      mantenimiento: 'Mantenimiento',
      otros: 'Otros'
    };

    // ========== INIT ==========
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;

      // Obtener bienId de URL
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('bien');

      if (!bienId) {
        alert('No se especificó el bien');
        history.back();
        return;
      }

      // Verificar que Mayordomo esté activo
      const mayordomoActivo = await verificarMayordomo();
      if (!mayordomoActivo) {
        mostrarMayordomoInactivo();
        return;
      }

      await cargarNidosUsuario();
    });

    // ========== VERIFICAR MAYORDOMO ==========
    async function verificarMayordomo() {
      try {
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) return false;
        
        const bien = bienDoc.data();
        return bien.mayordomoActivo === true;
      } catch (error) {
        console.error('Error verificando Mayordomo:', error);
        return false;
      }
    }

    function mostrarMayordomoInactivo() {
      document.getElementById('estado-sin-nido').innerHTML = `
        <div class="empty-state-icon">M</div>
        <div class="empty-state-title">Mayordomo no activo</div>
        <p class="empty-state-text">Para usar la Tienda, el administrador debe activar Mayordomo en la ficha del bien.</p>
        <button class="btn btn-secondary" onclick="history.back()" style="margin-top: 16px;">Volver</button>
      `;
      document.getElementById('estado-sin-nido').classList.remove('hidden');
      document.getElementById('contenido-principal').classList.add('hidden');
    }

    // ========== CARGAR NIDOS ==========
    async function cargarNidosUsuario() {
      try {
        // Buscar nidos donde el usuario es miembro
        const nidosSnap = await db.collection('nidos')
          .where('miembros', 'array-contains', currentUser.uid)
          .get();

        nidosUsuario = [];
        nidosSnap.forEach(doc => {
          nidosUsuario.push({ id: doc.id, ...doc.data() });
        });

        renderSelectNido();

        // Si solo hay un nido, seleccionarlo automáticamente
        if (nidosUsuario.length === 1) {
          document.getElementById('select-nido').value = nidosUsuario[0].id;
          seleccionarNido(nidosUsuario[0].id);
        }
      } catch (error) {
        console.error('Error cargando nidos:', error);
      }
    }

    function renderSelectNido() {
      const select = document.getElementById('select-nido');
      select.innerHTML = '<option value="">Selecciona tu nido</option>' +
        nidosUsuario.map(n => `<option value="${n.id}">${n.nombre || 'Mi Nido'}</option>`).join('');

      select.addEventListener('change', (e) => {
        if (e.target.value) {
          seleccionarNido(e.target.value);
        }
      });
    }

    async function seleccionarNido(nidoId) {
      nidoActual = nidosUsuario.find(n => n.id === nidoId);
      
      document.getElementById('estado-sin-nido').classList.add('hidden');
      document.getElementById('contenido-principal').classList.remove('hidden');

      await Promise.all([
        cargarProductosReposicion(),
        cargarProductosEspeciales()
      ]);
    }

    // ========== CARGAR REPOSICIÓN (desde inventario Mayordomo) ==========
    async function cargarProductosReposicion() {
      document.getElementById('loading-reposicion').classList.remove('hidden');
      document.getElementById('lista-reposicion').classList.add('hidden');
      document.getElementById('empty-reposicion').classList.add('hidden');

      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('inventario')
          .orderBy('grupo')
          .get();

        productosReposicion = [];
        snap.forEach(doc => {
          const data = doc.data();
          // Solo mostrar productos bajo mínimo
          if (data.stock < data.minimo) {
            productosReposicion.push({
              id: doc.id,
              ...data,
              faltante: data.minimo - data.stock,
              tipo: 'reposicion'
            });
          }
        });

        document.getElementById('loading-reposicion').classList.add('hidden');
        renderFiltrosReposicion();
        renderListaReposicion();
        actualizarBadges();
      } catch (error) {
        console.error('Error cargando reposición:', error);
        document.getElementById('loading-reposicion').classList.add('hidden');
      }
    }

    function renderFiltrosReposicion() {
      const container = document.getElementById('filtros-reposicion');
      const conteo = {};

      productosReposicion.forEach(p => {
        conteo[p.grupo] = (conteo[p.grupo] || 0) + 1;
      });

      let html = `<button class="filtro-chip ${filtroGrupoReposicion === 'todos' ? 'active' : ''}" onclick="filtrarReposicion('todos')">Todos<span class="count">${productosReposicion.length}</span></button>`;

      Object.keys(GRUPOS).forEach(g => {
        if (conteo[g]) {
          html += `<button class="filtro-chip ${filtroGrupoReposicion === g ? 'active' : ''}" onclick="filtrarReposicion('${g}')">${GRUPOS[g]}<span class="count">${conteo[g]}</span></button>`;
        }
      });

      container.innerHTML = html;
    }

    function filtrarReposicion(grupo) {
      filtroGrupoReposicion = grupo;
      renderFiltrosReposicion();
      renderListaReposicion();
    }

    function renderListaReposicion() {
      const container = document.getElementById('lista-reposicion');
      const emptyState = document.getElementById('empty-reposicion');

      let productos = productosReposicion;
      if (filtroGrupoReposicion !== 'todos') {
        productos = productos.filter(p => p.grupo === filtroGrupoReposicion);
      }

      if (productos.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      container.classList.remove('hidden');

      container.innerHTML = productos.map(p => {
        const enCarrito = carrito.reposicion.find(c => c.id === p.id);
        const checked = enCarrito ? 'checked' : '';
        const selected = enCarrito ? 'selected' : '';
        const cantidad = enCarrito ? enCarrito.cantidad : p.faltante;
        const urgencia = p.stock === 0 ? 'critico' : 'urgente';

        return `
          <div class="producto-item ${selected} ${urgencia}" data-id="${p.id}" data-tipo="reposicion">
            <input type="checkbox" class="producto-check" ${checked} onchange="toggleCarrito('${p.id}', 'reposicion', this.checked)">
            <div class="producto-info">
              <div class="producto-nombre">${p.nombre}</div>
              <div class="producto-meta">
                <span>${GRUPOS[p.grupo] || p.grupo}</span>
                <span>Stock: ${p.stock}/${p.minimo}</span>
                ${p.subgrupo ? `<span>${p.subgrupo}</span>` : ''}
              </div>
            </div>
            <div class="producto-cantidad">
              <span class="cantidad-label">Pedir:</span>
              <input type="number" class="cantidad-input" value="${cantidad}" min="1" 
                     onchange="actualizarCantidad('${p.id}', 'reposicion', this.value)"
                     ${!enCarrito ? 'disabled' : ''}>
              <span class="cantidad-unidad">${p.unidad || 'uds'}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========== CARGAR ESPECIALES ==========
    async function cargarProductosEspeciales() {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('especiales')
          .where('nidoId', '==', nidoActual.id)
          .orderBy('grupo')
          .get();

        productosEspeciales = [];
        snap.forEach(doc => {
          productosEspeciales.push({
            id: doc.id,
            ...doc.data(),
            tipo: 'especial'
          });
        });

        renderFiltrosEspeciales();
        renderListaEspeciales();
        actualizarBadges();
      } catch (error) {
        console.error('Error cargando especiales:', error);
        // Si falla por índice, mostrar vacío
        renderListaEspeciales();
      }
    }

    function renderFiltrosEspeciales() {
      const container = document.getElementById('filtros-especiales');
      const conteo = {};

      productosEspeciales.forEach(p => {
        conteo[p.grupo] = (conteo[p.grupo] || 0) + 1;
      });

      if (productosEspeciales.length === 0) {
        container.innerHTML = '';
        return;
      }

      let html = `<button class="filtro-chip ${filtroGrupoEspeciales === 'todos' ? 'active' : ''}" onclick="filtrarEspeciales('todos')">Todos<span class="count">${productosEspeciales.length}</span></button>`;

      Object.keys(GRUPOS).forEach(g => {
        if (conteo[g]) {
          html += `<button class="filtro-chip ${filtroGrupoEspeciales === g ? 'active' : ''}" onclick="filtrarEspeciales('${g}')">${GRUPOS[g]}<span class="count">${conteo[g]}</span></button>`;
        }
      });

      container.innerHTML = html;
    }

    function filtrarEspeciales(grupo) {
      filtroGrupoEspeciales = grupo;
      renderFiltrosEspeciales();
      renderListaEspeciales();
    }

    function renderListaEspeciales() {
      const container = document.getElementById('lista-especiales');
      const emptyState = document.getElementById('empty-especiales');

      let productos = productosEspeciales;
      if (filtroGrupoEspeciales !== 'todos') {
        productos = productos.filter(p => p.grupo === filtroGrupoEspeciales);
      }

      if (productos.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      container.classList.remove('hidden');

      container.innerHTML = productos.map(p => {
        const enCarrito = carrito.especiales.find(c => c.id === p.id);
        const checked = enCarrito ? 'checked' : '';
        const selected = enCarrito ? 'selected' : '';
        const cantidad = enCarrito ? enCarrito.cantidad : (p.unidades || 1);

        return `
          <div class="producto-item ${selected}" data-id="${p.id}" data-tipo="especial">
            <input type="checkbox" class="producto-check" ${checked} onchange="toggleCarrito('${p.id}', 'especial', this.checked)">
            <div class="producto-info">
              <div class="producto-nombre">${p.nombre}</div>
              <div class="producto-meta">
                <span>${GRUPOS[p.grupo] || p.grupo}</span>
                ${p.notas ? `<span>${p.notas}</span>` : ''}
              </div>
            </div>
            <div class="producto-cantidad">
              <span class="cantidad-label">Pedir:</span>
              <input type="number" class="cantidad-input" value="${cantidad}" min="1" 
                     onchange="actualizarCantidad('${p.id}', 'especial', this.value)"
                     ${!enCarrito ? 'disabled' : ''}>
              <span class="cantidad-unidad">uds</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========== CARRITO ==========
    function toggleCarrito(id, tipo, añadir) {
      const lista = tipo === 'reposicion' ? productosReposicion : productosEspeciales;
      const producto = lista.find(p => p.id === id);
      
      if (!producto) return;

      const carritoTipo = tipo === 'reposicion' ? 'reposicion' : 'especiales';

      if (añadir) {
        // Añadir al carrito
        const cantidad = tipo === 'reposicion' ? producto.faltante : (producto.unidades || 1);
        carrito[carritoTipo].push({
          id: producto.id,
          nombre: producto.nombre,
          grupo: producto.grupo,
          cantidad: cantidad,
          unidad: producto.unidad || 'uds'
        });
      } else {
        // Quitar del carrito
        carrito[carritoTipo] = carrito[carritoTipo].filter(c => c.id !== id);
      }

      // Re-render
      if (tipo === 'reposicion') {
        renderListaReposicion();
      } else {
        renderListaEspeciales();
      }

      actualizarCarritoBar();
    }

    function actualizarCantidad(id, tipo, cantidad) {
      const carritoTipo = tipo === 'reposicion' ? 'reposicion' : 'especiales';
      const item = carrito[carritoTipo].find(c => c.id === id);
      
      if (item) {
        item.cantidad = Math.max(1, parseInt(cantidad) || 1);
      }

      actualizarCarritoBar();
    }

    function actualizarCarritoBar() {
      const totalReposicion = carrito.reposicion.length;
      const totalEspeciales = carrito.especiales.length;
      const total = totalReposicion + totalEspeciales;

      const bar = document.getElementById('carrito-bar');
      const titulo = document.getElementById('carrito-titulo');
      const detalle = document.getElementById('carrito-detalle');

      if (total > 0) {
        bar.classList.add('visible');
        titulo.textContent = `${total} producto${total !== 1 ? 's' : ''} en el pedido`;
        detalle.textContent = `Reposición: ${totalReposicion} · Especiales: ${totalEspeciales}`;
      } else {
        bar.classList.remove('visible');
      }
    }

    function actualizarBadges() {
      document.getElementById('badge-reposicion').textContent = productosReposicion.length;
      document.getElementById('badge-especiales').textContent = productosEspeciales.length;
    }

    // ========== TABS ==========
    function cambiarTab(tab) {
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });

      document.querySelectorAll('.tab-content').forEach(c => {
        c.classList.toggle('active', c.id === `tab-${tab}`);
      });
    }

    // ========== MODALES ==========
    function abrirModalEspecial() {
      document.getElementById('form-especial').reset();
      document.getElementById('modal-especial').classList.add('active');
    }

    function abrirModalCarrito() {
      const body = document.getElementById('carrito-body');
      let html = '';

      if (carrito.reposicion.length > 0) {
        html += `
          <div class="carrito-seccion">
            <div class="carrito-seccion-titulo">Reposición</div>
            <div class="carrito-lista">
              ${carrito.reposicion.map(item => `
                <div class="carrito-item">
                  <div class="carrito-item-info">
                    <div class="carrito-item-nombre">${item.nombre}</div>
                    <div class="carrito-item-grupo">${GRUPOS[item.grupo] || item.grupo}</div>
                  </div>
                  <div class="carrito-item-cantidad">${item.cantidad} ${item.unidad}</div>
                  <button class="carrito-item-remove" onclick="quitarDelCarrito('${item.id}', 'reposicion')">×</button>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      if (carrito.especiales.length > 0) {
        html += `
          <div class="carrito-seccion">
            <div class="carrito-seccion-titulo">Especiales</div>
            <div class="carrito-lista">
              ${carrito.especiales.map(item => `
                <div class="carrito-item">
                  <div class="carrito-item-info">
                    <div class="carrito-item-nombre">${item.nombre}</div>
                    <div class="carrito-item-grupo">${GRUPOS[item.grupo] || item.grupo}</div>
                  </div>
                  <div class="carrito-item-cantidad">${item.cantidad} ${item.unidad}</div>
                  <button class="carrito-item-remove" onclick="quitarDelCarrito('${item.id}', 'especiales')">×</button>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      if (!html) {
        html = '<div class="empty-state"><div class="empty-state-title">Pedido vacío</div><p class="empty-state-text">Selecciona productos para añadirlos</p></div>';
      }

      body.innerHTML = html;
      document.getElementById('modal-carrito').classList.add('active');
    }

    function quitarDelCarrito(id, tipo) {
      carrito[tipo] = carrito[tipo].filter(c => c.id !== id);
      
      // Re-render todo
      renderListaReposicion();
      renderListaEspeciales();
      actualizarCarritoBar();
      abrirModalCarrito(); // Refrescar modal
    }

    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    }

    // ========== GUARDAR ESPECIAL ==========
    async function guardarEspecial(e) {
      e.preventDefault();

      const nombre = document.getElementById('especial-nombre').value.trim();
      const grupo = document.getElementById('especial-grupo').value;
      const unidades = parseInt(document.getElementById('especial-unidades').value) || 1;
      const notas = document.getElementById('especial-notas').value.trim();

      try {
        await db.collection('bienes').doc(bienId).collection('especiales').add({
          nombre,
          grupo,
          unidades,
          notas: notas || null,
          nidoId: nidoActual.id,
          creadoPor: currentUser.uid,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        cerrarModales();
        await cargarProductosEspeciales();
      } catch (error) {
        console.error('Error guardando especial:', error);
        alert('Error al guardar: ' + error.message);
      }
    }

    // ========== ENVIAR PEDIDO ==========
    async function enviarPedido() {
      const totalItems = carrito.reposicion.length + carrito.especiales.length;
      
      if (totalItems === 0) {
        alert('Selecciona al menos un producto');
        return;
      }

      try {
        const pedido = {
          bienId,
          nidoId: nidoActual.id,
          nidoNombre: nidoActual.nombre || 'Mi Nido',
          solicitadoPor: currentUser.uid,
          solicitadoPorNombre: currentUser.displayName || currentUser.email,
          estado: 'pendiente',
          items: [
            ...carrito.reposicion.map(item => ({
              ...item,
              tipo: 'reposicion'
            })),
            ...carrito.especiales.map(item => ({
              ...item,
              tipo: 'especial'
            }))
          ],
          totalItems,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('bienes').doc(bienId).collection('pedidos').add(pedido);

        // Limpiar carrito
        carrito = { reposicion: [], especiales: [] };
        actualizarCarritoBar();

        cerrarModales();
        document.getElementById('modal-confirmacion').classList.add('active');

      } catch (error) {
        console.error('Error enviando pedido:', error);
        alert('Error al enviar pedido: ' + error.message);
      }
    }

    // Cerrar modales con click fuera
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
          cerrarModales();
        }
      });
    });
  </script>
</body>
</html>
