<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Encuestas</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E; --sage-light: #9BB89E; --sage-dark: #5C7D5F; --sage-muted: rgba(122,158,126,0.15);
      --cream: #FDF8F3; --cream-dark: #F5EDE4; --cream-medium: #FAF4ED;
      --terracotta: #C17757; --terracotta-muted: rgba(193,119,87,0.15);
      --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06); --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-full: 50px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header { background: var(--white); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-soft); position: sticky; top: 0; z-index: 100; }
    .back-btn { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--cream); border: none; border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.85rem; color: var(--text-light); cursor: pointer; text-decoration: none; transition: all 0.2s; }
    .back-btn:hover { background: var(--cream-dark); }

    .main { max-width: 800px; margin: 0 auto; padding: 24px; }

    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-family: 'Quicksand', sans-serif; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 12px; }
    .page-subtitle { color: var(--text-muted); font-size: 0.9rem; margin-top: 4px; }

    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: none; text-decoration: none; transition: all 0.2s; }
    .btn-primary { background: var(--sage); color: white; }
    .btn-primary:hover { background: var(--sage-dark); }
    .btn-secondary { background: var(--cream); color: var(--text); }
    .btn-secondary:hover { background: var(--cream-dark); }
    .btn-sm { padding: 8px 14px; font-size: 0.8rem; }
    .btn-danger { background: #D4695A; color: white; }
    .btn-danger:hover { background: #B94A3A; }
    .btn-publish { background: #5C6BC0; color: white; }
    .btn-publish:hover { background: #3F51B5; }

    /* === TABS === */
    .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: var(--white); border-radius: var(--radius-md); padding: 4px; box-shadow: var(--shadow-soft); }
    .tab { flex: 1; padding: 12px 16px; text-align: center; border: none; background: none; font-family: 'Nunito', sans-serif; font-size: 0.88rem; font-weight: 600; color: var(--text-muted); cursor: pointer; border-radius: var(--radius-sm); transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .tab:hover { background: var(--cream); color: var(--text); }
    .tab.active { background: var(--sage); color: white; }
    .tab-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 6px; border-radius: 10px; font-size: 0.72rem; font-weight: 700; }
    .tab.active .tab-badge { background: rgba(255,255,255,0.3); color: white; }
    .tab:not(.active) .tab-badge { background: var(--cream-dark); color: var(--text-muted); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* === CARDS BORRADORES === */
    .borrador-card {
      background: var(--white); border-radius: var(--radius-lg); overflow: hidden;
      box-shadow: var(--shadow-soft); margin-bottom: 16px; border-left: 4px solid #FFA726;
    }
    .borrador-body { padding: 20px; }
    .borrador-titulo { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; }
    .borrador-desc { font-size: 0.85rem; color: var(--text-light); margin-bottom: 10px; }
    .borrador-meta { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.78rem; color: var(--text-muted); margin-bottom: 14px; }
    .borrador-meta span { display: flex; align-items: center; gap: 4px; }
    .borrador-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 600; }
    .badge-alcance { background: var(--sage-muted); color: var(--sage-dark); }
    .badge-programada { background: #E8EAF6; color: #3F51B5; }
    .badge-manual { background: #FFF3E0; color: #E65100; }
    .badge-automatico { background: #E0F7FA; color: #00838F; }
    .badge-vinculacion { background: #F3E5F5; color: #7B1FA2; }
    .badge-solicitante { background: #E8F5E9; color: #2E7D32; }
    .borrador-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* === CARDS ACTIVAS === */
    .encuesta-card { background: var(--white); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-soft); margin-bottom: 20px; transition: all 0.2s; }
    .encuesta-card:hover { box-shadow: var(--shadow-float); }
    .encuesta-header { padding: 20px; border-bottom: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: flex-start; }
    .encuesta-titulo { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.15rem; margin-bottom: 4px; }
    .encuesta-descripcion { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }
    .encuesta-meta { display: flex; gap: 12px; margin-top: 8px; font-size: 0.8rem; color: var(--text-muted); }
    .encuesta-estado { padding: 4px 12px; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 700; white-space: nowrap; }
    .encuesta-estado.abierta { background: #E8F5E9; color: #2E7D32; }
    .encuesta-estado.cerrada { background: var(--cream-dark); color: var(--text-muted); }
    .encuesta-body { padding: 20px; }
    .encuesta-footer { padding: 14px 20px; border-top: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: center; }
    .participacion { font-size: 0.82rem; color: var(--text-muted); font-weight: 600; }

    .pregunta-item { margin-bottom: 20px; }
    .pregunta-numero { font-size: 0.78rem; font-weight: 700; color: var(--sage-dark); margin-bottom: 4px; }
    .pregunta-texto { font-weight: 600; font-size: 0.95rem; margin-bottom: 10px; }

    .respuestas-opciones { display: flex; flex-direction: column; gap: 6px; }
    .respuesta-opcion { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--cream); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; font-size: 0.9rem; }
    .respuesta-opcion:hover { background: var(--cream-dark); }
    .respuesta-opcion.selected { background: var(--sage-muted); border: 1px solid var(--sage-light); }
    .respuesta-opcion input { accent-color: var(--sage); }

    .escala-container { display: flex; gap: 8px; justify-content: center; margin: 8px 0; }
    .escala-opcion { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; background: var(--cream); border: 2px solid var(--cream-dark); transition: all 0.15s; }
    .escala-opcion:hover { border-color: var(--sage-light); }
    .escala-opcion.selected { background: var(--sage); color: white; border-color: var(--sage); }
    .escala-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); padding: 0 8px; }

    .respuesta-texto-input { width: 100%; padding: 10px 14px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.9rem; }
    .respuesta-texto-input:focus { outline: none; border-color: var(--sage); }

    /* Resultados barras */
    .resultado-barra-container { display: flex; flex-direction: column; gap: 8px; }
    .resultado-item { display: flex; align-items: center; gap: 10px; }
    .resultado-texto { font-size: 0.85rem; min-width: 100px; flex-shrink: 0; }
    .resultado-barra { flex: 1; height: 20px; background: var(--cream-dark); border-radius: 10px; overflow: hidden; }
    .resultado-barra-fill { height: 100%; background: linear-gradient(90deg, var(--sage-light), var(--sage)); border-radius: 10px; transition: width 0.5s ease; }
    .resultado-porcentaje { font-size: 0.8rem; font-weight: 700; color: var(--sage-dark); min-width: 60px; text-align: right; }

    /* === LISTADO REALIZADAS === */
    .realizadas-list { display: flex; flex-direction: column; gap: 8px; }
    .realizada-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; background: var(--white); border-radius: var(--radius-md);
      box-shadow: var(--shadow-soft); cursor: pointer; transition: all 0.2s; gap: 12px;
    }
    .realizada-item:hover { box-shadow: var(--shadow-float); transform: translateY(-1px); }
    .realizada-info { flex: 1; min-width: 0; }
    .realizada-titulo { font-weight: 700; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .realizada-meta { font-size: 0.78rem; color: var(--text-muted); margin-top: 2px; display: flex; gap: 12px; }
    .realizada-resp { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; font-weight: 700; color: var(--sage-dark); white-space: nowrap; }
    .realizada-arrow { color: var(--text-muted); font-size: 1.2rem; }

    /* === MODAL === */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s; padding: 20px;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: var(--white); border-radius: var(--radius-lg); width: 100%; max-width: 600px;
      max-height: 90vh; display: flex; flex-direction: column;
    }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .modal-title { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.1rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
    .modal-body { padding: 24px; overflow-y: auto; flex: 1; min-height: 0; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--cream-dark); display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; }

    /* Modal detalle resultados - m√°s ancho */
    .modal-detalle { max-width: 700px; }
    .modal-detalle .modal-body { padding: 24px 28px; }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
    .form-hint { font-weight: 400; color: var(--text-muted); font-size: 0.82rem; }
    .form-input, .form-textarea, .form-select {
      width: 100%; padding: 12px 14px; border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 1rem;
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--sage); }

    /* Checkboxes destinatarios */
    .destinatarios-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .destinatario-check { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--cream); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; font-size: 0.88rem; }
    .destinatario-check:hover { background: var(--cream-dark); }
    .destinatario-check.selected { background: var(--sage-muted); border: 1px solid var(--sage-light); }
    .destinatario-check input { accent-color: var(--sage); }

    /* Cascada vinculaci√≥n */
    .vincular-check { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--cream); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; font-size: 0.88rem; margin-bottom: 8px; }
    .vincular-check:hover { background: var(--cream-dark); }
    .vincular-check input { accent-color: var(--sage); }
    .cascada-wrapper { margin-left: 24px; margin-bottom: 8px; padding-left: 12px; border-left: 2px solid var(--cream-dark); }
    .cascada-hint { font-size: 0.8rem; color: #E65100; margin-top: 6px; padding: 6px 10px; background: #FFF3E0; border-radius: 6px; }

    /* Selector miembros */
    .miembros-selector { margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm); padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
    .miembro-check { display: flex; align-items: center; gap: 8px; padding: 6px 8px; font-size: 0.85rem; cursor: pointer; border-radius: 4px; }
    .miembro-check:hover { background: var(--cream); }
    .miembro-check input { accent-color: var(--sage); }
    .miembro-especial { background: #E8F5E9; border: 1px solid #81C784; width: 100%; padding: 10px 12px; }
    .miembro-especial:hover { background: #C8E6C9; }
    .miembro-especial.selected { background: #A5D6A7; }
    .miembros-separador { width: 100%; text-align: center; font-size: 0.75rem; color: var(--text-muted); margin: 8px 0 4px 0; }

    /* Publicacion radio */
    .publicacion-opciones { display: flex; flex-direction: column; gap: 8px; }
    .publicacion-opcion { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--cream); border-radius: var(--radius-sm); cursor: pointer; font-size: 0.88rem; }
    .publicacion-opcion:hover { background: var(--cream-dark); }
    .publicacion-opcion input[type="radio"] { accent-color: var(--sage); }
    .fecha-programada-wrapper { margin-top: 8px; padding-left: 32px; }

    /* Constructor de preguntas */
    .preguntas-constructor { display: flex; flex-direction: column; gap: 16px; }
    .pregunta-builder { background: var(--cream); border-radius: var(--radius-md); padding: 16px; }
    .pregunta-builder-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .pregunta-builder-num { font-weight: 700; color: var(--sage-dark); }
    .btn-remove-pregunta { width: 30px; height: 30px; border-radius: 50%; border: none; background: var(--white); color: var(--text-muted); cursor: pointer; font-size: 1rem; }
    .btn-remove-pregunta:hover { background: #D4695A; color: white; }
    .pregunta-builder-body { display: flex; flex-direction: column; gap: 12px; }
    .opciones-builder { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .opcion-builder-item { display: flex; gap: 6px; }
    .opcion-builder-item input { flex: 1; padding: 8px 10px; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm); font-family: 'Nunito', sans-serif; }
    .btn-add-opcion-sm { padding: 6px 12px; border: 1px dashed var(--cream-dark); border-radius: var(--radius-sm); background: none; cursor: pointer; font-size: 0.8rem; color: var(--text-muted); }
    .btn-add-opcion-sm:hover { border-color: var(--sage); color: var(--sage); }
    .btn-add-pregunta { padding: 14px; border: 2px dashed var(--cream-dark); border-radius: var(--radius-md); background: none; cursor: pointer; font-family: 'Nunito', sans-serif; font-size: 0.9rem; color: var(--text-muted); }
    .btn-add-pregunta:hover { border-color: var(--sage); color: var(--sage); }

    /* === GR√ÅFICOS DETALLE === */
    .grafico-container { display: flex; align-items: center; gap: 20px; margin-top: 12px; }
    .grafico-donut { flex-shrink: 0; }
    .grafico-leyenda { display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .leyenda-item { display: flex; align-items: center; gap: 8px; font-size: 0.82rem; }
    .leyenda-color { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
    .detalle-pregunta { margin-bottom: 28px; padding-bottom: 20px; border-bottom: 1px solid var(--cream-dark); }
    .detalle-pregunta:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .detalle-pregunta-num { font-size: 0.75rem; font-weight: 700; color: var(--sage-dark); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .detalle-pregunta-texto { font-weight: 700; font-size: 1rem; margin-bottom: 14px; }
    .detalle-promedio { text-align: center; padding: 16px; background: var(--cream); border-radius: var(--radius-md); }
    .detalle-promedio-num { font-size: 2rem; font-weight: 700; color: var(--sage-dark); }
    .detalle-textos { display: flex; flex-direction: column; gap: 6px; }
    .detalle-texto-item { padding: 10px 14px; background: var(--cream); border-radius: var(--radius-sm); font-size: 0.88rem; }
    .detalle-texto-autor { font-weight: 700; color: var(--sage-dark); }

    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-icon { font-size: 4rem; opacity: 0.3; margin-bottom: 16px; }
    .empty-text { color: var(--text-muted); margin-bottom: 20px; }

    .plan-required { text-align: center; padding: 60px 20px; max-width: 400px; margin: 40px auto; background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); }
    .plan-required-icon { width: 64px; height: 64px; margin: 0 auto 16px; background: var(--cream-dark); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .plan-required-title { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.2rem; margin-bottom: 12px; }
    .plan-required-text { color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px; }
    .plan-required-btn { display: inline-block; padding: 12px 24px; background: var(--sage); color: white; text-decoration: none; border-radius: var(--radius-md); font-weight: 600; font-size: 0.9rem; transition: background 0.2s; }
    .plan-required-btn:hover { background: var(--sage-dark); }

    .loading { display: flex; align-items: center; justify-content: center; min-height: 200px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--sage); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    @media (max-width: 600px) {
      .tabs { flex-direction: column; }
      .destinatarios-grid { grid-template-columns: 1fr; }
      .grafico-container { flex-direction: column; align-items: stretch; }
      .grafico-donut { align-self: center; }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="activacion.html" class="back-btn">‚Üê Activaci√≥n</a>
  </header>

  <main class="main">
    <div class="page-header">
      <div>
        <h1 class="page-title">üìä Encuestas</h1>
        <p class="page-subtitle">Recoge opiniones de la familia</p>
      </div>
      <button class="btn btn-primary" id="btn-nueva" onclick="abrirModal()">+ Nueva encuesta</button>
    </div>

    <div id="loading" class="loading"><div class="spinner"></div></div>

    <!-- Bloqueo por plan -->
    <div id="plan-required" class="plan-required hidden">
      <div class="plan-required-icon">+</div>
      <h2 class="plan-required-title">Funci√≥n Plus</h2>
      <p class="plan-required-text">Las encuestas est√°n disponibles en el plan Plus.</p>
      <a href="planes.html" class="plan-required-btn">Ver planes</a>
    </div>

    <!-- Contenido principal -->
    <div id="contenido-principal" class="hidden">
      <div class="tabs">
        <button class="tab active" onclick="cambiarTab('borradores')">
          üìù Borradores <span class="tab-badge" id="badge-borradores">0</span>
        </button>
        <button class="tab" onclick="cambiarTab('activas')">
          üü¢ Activas <span class="tab-badge" id="badge-activas">0</span>
        </button>
        <button class="tab" onclick="cambiarTab('realizadas')">
          üìä Realizadas <span class="tab-badge" id="badge-realizadas">0</span>
        </button>
      </div>

      <!-- TAB: Borradores -->
      <div class="tab-content active" id="tab-borradores">
        <div id="borradores-list"></div>
        <div id="empty-borradores" class="empty-state hidden">
          <div class="empty-icon">üìù</div>
          <p class="empty-text">No hay borradores.<br>Crea una encuesta y gu√°rdala como borrador.</p>
          <button class="btn btn-primary" onclick="abrirModal()">+ Nueva encuesta</button>
        </div>
      </div>

      <!-- TAB: Activas -->
      <div class="tab-content" id="tab-activas">
        <div id="activas-list"></div>
        <div id="empty-activas" class="empty-state hidden">
          <div class="empty-icon">üü¢</div>
          <p class="empty-text">No hay encuestas activas.<br>Publica un borrador o crea una nueva.</p>
        </div>
      </div>

      <!-- TAB: Realizadas -->
      <div class="tab-content" id="tab-realizadas">
        <div id="realizadas-list" class="realizadas-list"></div>
        <div id="empty-realizadas" class="empty-state hidden">
          <div class="empty-icon">üìä</div>
          <p class="empty-text">No hay encuestas realizadas todav√≠a.</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Nueva/Editar Encuesta -->
  <div class="modal-overlay" id="modal-encuesta">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-enc-titulo">üìä Nueva encuesta</h3>
        <button class="modal-close" onclick="cerrarModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">T√≠tulo de la encuesta *</label>
          <input type="text" class="form-input" id="enc-titulo" placeholder="Ej: Preferencias para vacaciones 2026" required>
        </div>

        <div class="form-group">
          <label class="form-label">Descripci√≥n <span class="form-hint">(opcional)</span></label>
          <textarea class="form-textarea" id="enc-descripcion" placeholder="Explica brevemente el objetivo..." rows="2"></textarea>
        </div>

        <!-- Destinatarios -->
        <div class="form-group">
          <label class="form-label">¬øA qui√©n va dirigida? *</label>
          <div class="destinatarios-grid" id="destinatarios-grid">
            <label class="destinatario-check">
              <input type="checkbox" value="rama" onchange="toggleDestinatario(this)"> üå≥ Toda la Rama
            </label>
            <label class="destinatario-check">
              <input type="checkbox" value="estirpe" onchange="toggleDestinatario(this)"> üèõÔ∏è Mi Estirpe
            </label>
            <label class="destinatario-check">
              <input type="checkbox" value="nido" onchange="toggleDestinatario(this)"> ü™∫ Mi Nido
            </label>
            <label class="destinatario-check">
              <input type="checkbox" value="especifico" onchange="toggleDestinatario(this)"> üë§ Miembros espec√≠ficos
            </label>
          </div>
          <div id="miembros-especificos" class="miembros-selector hidden">
            <!-- Se llena din√°micamente -->
          </div>
        </div>

        <!-- Vinculaci√≥n a bien/m√≥dulo -->
        <div class="form-group">
          <label class="form-label">Vinculaci√≥n <span class="form-hint">(opcional)</span></label>
          
          <label class="vincular-check" id="check-vincular-bien">
            <input type="checkbox" onchange="toggleVincularBien(this.checked)">
            üè† Vincular a un bien de Lo Com√∫n
          </label>

          <div id="bien-selector-wrapper" class="cascada-wrapper hidden">
            <select class="form-select" id="enc-bien" onchange="onBienSeleccionado()">
              <option value="">‚Äî Selecciona un bien ‚Äî</option>
            </select>
            <div id="bien-sin-addon" class="cascada-hint hidden">
              ‚ö†Ô∏è Este bien no tiene add-on activo
            </div>
          </div>

          <div id="modulo-check-wrapper" class="cascada-wrapper hidden">
            <label class="vincular-check">
              <input type="checkbox" id="check-vincular-modulo" onchange="toggleVincularModulo(this.checked)">
              üì¶ Vincular a un m√≥dulo del add-on
            </label>
          </div>

          <div id="modulo-selector-wrapper" class="cascada-wrapper hidden">
            <select class="form-select" id="enc-modulo" onchange="onModuloSeleccionado()">
              <option value="">‚Äî Selecciona un m√≥dulo ‚Äî</option>
            </select>
          </div>

          <div id="card-selector-wrapper" class="cascada-wrapper hidden">
            <label class="form-label" style="margin-top:8px; font-size:0.85rem;">Card espec√≠fico:</label>
            <select class="form-select" id="enc-card" onchange="onCardSeleccionado()">
              <option value="">‚Äî Selecciona un card ‚Äî</option>
            </select>
          </div>
        </div>

        <!-- Publicaci√≥n -->
        <div class="form-group">
          <label class="form-label">¬øCu√°ndo se env√≠a?</label>
          <div class="publicacion-opciones">
            <label class="publicacion-opcion">
              <input type="radio" name="publicacion" value="manual" checked onchange="togglePublicacionOpciones()">
              üì§ Publicar manualmente desde Borradores
            </label>
            <label class="publicacion-opcion">
              <input type="radio" name="publicacion" value="programada" onchange="togglePublicacionOpciones()">
              üìÖ Programar fecha de env√≠o
            </label>
            <label class="publicacion-opcion hidden" id="opcion-automatico">
              <input type="radio" name="publicacion" value="automatico" onchange="togglePublicacionOpciones()">
              üîÑ Autom√°tico ‚Äî al finalizar reserva/evento
            </label>
          </div>
          <div class="fecha-programada-wrapper hidden" id="fecha-programada-wrapper">
            <input type="datetime-local" class="form-input" id="enc-fecha-programada" style="margin-top:8px">
          </div>
          <div class="automatico-helper hidden" id="automatico-helper">
            <div class="form-hint" style="margin-top:8px; padding: 10px; background: #E0F7FA; border-radius: 8px;">
              üí° La encuesta se enviar√° autom√°ticamente cuando finalice la reserva/evento.
            </div>
          </div>
        </div>

        <!-- Preguntas -->
        <div class="form-group">
          <label class="form-label">Preguntas *</label>
          <div class="preguntas-constructor" id="preguntas-constructor"></div>
          <button type="button" class="btn-add-pregunta" onclick="agregarPregunta()">+ A√±adir pregunta</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="guardarEncuesta()">üíæ Guardar borrador</button>
      </div>
    </div>
  </div>

  <!-- Modal Detalle Resultados -->
  <div class="modal-overlay" id="modal-detalle">
    <div class="modal modal-detalle">
      <div class="modal-header">
        <h3 class="modal-title" id="detalle-titulo">üìä Resultados</h3>
        <button class="modal-close" onclick="cerrarDetalle()">√ó</button>
      </div>
      <div class="modal-body" id="detalle-body">
        <!-- Se llena din√°micamente -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarDetalle()">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let userData = null;
    let familiaId = null;
    let familiaData = null;
    let encuestasData = [];
    let miembrosData = [];
    let bienesData = [];
    let preguntasBuilder = [];
    
    // Vinculaci√≥n
    let vinculacionBien = null;      // { id, nombre, tieneAddon }
    let vinculacionModulo = null;    // { id, nombre, esReservaEvento }
    let vinculacionCard = null;      // { id, nombre }
    let modulosDelBien = [];
    let cardsDelModulo = [];
    let editandoId = null; // null = nueva, string = editando borrador
    let respuestasTemp = {};
    let destinatariosSeleccionados = [];
    let miembrosSeleccionados = [];

    const COLORES_GRAFICO = ['#7A9E7E', '#C17757', '#5C6BC0', '#FFA726', '#AB47BC', '#26A69A', '#EF5350', '#42A5F5', '#66BB6A', '#FF7043'];

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      console.log('Usuario logueado:', user.email);

      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists) {
        console.error('ERROR: No existe documento de usuario para uid:', user.uid);
        return;
      }
      userData = userDoc.data();
      familiaId = userData.familiaId;
      console.log('familiaId obtenido:', familiaId);

      // Verificar plan
      const familiaDoc = await db.collection('familias').doc(familiaId).get();
      familiaData = familiaDoc.exists ? familiaDoc.data() : {};
      const plan = familiaData.plan || 'gratuito';
      console.log('Plan de familia:', plan);

      if (plan === 'gratuito') {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('plan-required').classList.remove('hidden');
        return;
      }

      await cargarMiembros();
      await cargarBienes();
      await loadEncuestas();
    });

    async function cargarMiembros() {
      console.log('Cargando miembros para familiaId:', familiaId);
      const snap = await db.collection('usuarios').where('familiaId', '==', familiaId).get();
      miembrosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      console.log('Miembros cargados:', miembrosData.length, miembrosData.map(m => m.nombre || m.email));
    }

    async function cargarBienes() {
      try {
        const snap = await db.collection('bienes').where('familiaId', '==', familiaId).get();
        bienesData = snap.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            nombre: data.nombre || 'Sin nombre',
            tieneAddon: !!(data.mayordomoActivo || data.gerenteActivo || data.capatazActivo)
          };
        });
        console.log('Bienes cargados:', bienesData.length, bienesData);
      } catch (e) {
        console.error('Error cargando bienes:', e);
        bienesData = [];
      }
    }

    async function loadEncuestas() {
      try {
        const snap = await db.collection('encuestas').where('familiaId', '==', familiaId).get();
        encuestasData = snap.docs.map(doc => {
          const data = { id: doc.id, ...doc.data() };
          // RETROCOMPATIBILIDAD: normalizar estado para encuestas antiguas
          if (!data.estado) {
            if (data.cerrada === true) {
              data.estado = 'cerrada';
            } else {
              // Si tiene respuestas o fue publicada, es activa; si no, es borrador
              // Por defecto las tratamos como activas (comportamiento anterior)
              data.estado = 'activa';
            }
          }
          return data;
        });
        encuestasData.sort((a, b) => {
          const fa = a.fechaCreacion?.toDate?.() || new Date(0);
          const fb = b.fechaCreacion?.toDate?.() || new Date(0);
          return fb - fa;
        });

        // Auto-publicar las programadas que hayan vencido
        await autoPublicarProgramadas();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('contenido-principal').classList.remove('hidden');
        renderTodo();
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('contenido-principal').classList.remove('hidden');
      }
    }

    async function autoPublicarProgramadas() {
      const ahora = new Date();
      
      for (const enc of encuestasData) {
        if (enc.estado !== 'borrador') continue;
        
        const pubTipo = enc.publicacion?.tipo;
        
        // Tipo PROGRAMADA: fecha vencida
        if (pubTipo === 'programada' && enc.publicacion?.fechaProgramada) {
          const fechaProg = typeof enc.publicacion.fechaProgramada === 'string'
            ? new Date(enc.publicacion.fechaProgramada)
            : enc.publicacion.fechaProgramada.toDate?.() || new Date(enc.publicacion.fechaProgramada);
          if (fechaProg <= ahora) {
            try {
              await db.collection('encuestas').doc(enc.id).update({
                estado: 'activa',
                fechaPublicacion: firebase.firestore.FieldValue.serverTimestamp()
              });
              enc.estado = 'activa';
            } catch (e) { console.error('Error auto-publicar programada:', e); }
          }
        }
        
        // Tipo AUTOM√ÅTICO: cualquier reserva/solicitud finalizada
        if (pubTipo === 'automatico') {
          const tieneReservaFinalizada = await verificarReservaFinalizada(enc);
          if (tieneReservaFinalizada) {
            try {
              await db.collection('encuestas').doc(enc.id).update({
                estado: 'activa',
                fechaPublicacion: firebase.firestore.FieldValue.serverTimestamp()
              });
              enc.estado = 'activa';
            } catch (e) { console.error('Error auto-publicar autom√°tica:', e); }
          }
        }
      }
    }

    // Verifica si hay reservas/solicitudes finalizadas que a√∫n no tienen encuesta enviada
    async function verificarReservaFinalizada(encuesta) {
      const ahora = new Date();
      const encuestaCreacion = encuesta.fechaCreacion?.toDate?.() || new Date(0);
      
      try {
        // Buscar en solicitudes aprobadas de la familia
        const solicitudesSnap = await db.collection('solicitudes')
          .where('familiaId', '==', familiaId)
          .where('estado', '==', 'aprobada')
          .get();
        
        for (const doc of solicitudesSnap.docs) {
          const sol = doc.data();
          let fechaFin = sol.fechaFin || sol.fechaHasta || sol.fin;
          if (fechaFin) {
            fechaFin = typeof fechaFin === 'string' ? new Date(fechaFin) : fechaFin.toDate?.() || new Date(fechaFin);
            // La reserva finaliz√≥ Y fue despu√©s de crear la encuesta
            if (fechaFin <= ahora && fechaFin >= encuestaCreacion) {
              const reservasEnviadas = encuesta.reservasEnviadas || [];
              if (!reservasEnviadas.includes(doc.id)) {
                return true;
              }
            }
          }
        }
        
        // Buscar en reservas del add-on (si existe)
        try {
          const reservasSnap = await db.collection('reservas')
            .where('familiaId', '==', familiaId)
            .get();
          
          for (const doc of reservasSnap.docs) {
            const res = doc.data();
            let fechaFin = res.fechaFin || res.fechaHasta || res.fin || res.checkout;
            if (fechaFin) {
              fechaFin = typeof fechaFin === 'string' ? new Date(fechaFin) : fechaFin.toDate?.() || new Date(fechaFin);
              if (fechaFin <= ahora && fechaFin >= encuestaCreacion) {
                const reservasEnviadas = encuesta.reservasEnviadas || [];
                if (!reservasEnviadas.includes(doc.id)) {
                  return true;
                }
              }
            }
          }
        } catch (e) {
          // Colecci√≥n reservas puede no existir
        }
        
        return false;
      } catch (e) {
        console.error('Error verificando reservas finalizadas:', e);
        return false;
      }
    }

    // ========================================
    // TABS
    // ========================================
    function cambiarTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
    }

    // ========================================
    // RENDER
    // ========================================
    function renderTodo() {
      const borradores = encuestasData.filter(e => e.estado === 'borrador');
      const activas = encuestasData.filter(e => e.estado === 'activa');
      const realizadas = encuestasData.filter(e => e.estado === 'cerrada');

      // Badges
      document.getElementById('badge-borradores').textContent = borradores.length;
      document.getElementById('badge-activas').textContent = activas.length;
      document.getElementById('badge-realizadas').textContent = realizadas.length;

      renderBorradores(borradores);
      renderActivas(activas);
      renderRealizadas(realizadas);
    }

    function renderBorradores(lista) {
      const container = document.getElementById('borradores-list');
      const empty = document.getElementById('empty-borradores');

      if (lista.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      container.innerHTML = lista.map(enc => {
        const alcances = enc.destinatarios?.alcance || [];
        const alcanceLabels = { rama: 'üå≥ Rama', estirpe: 'üèõÔ∏è Estirpe', nido: 'ü™∫ Nido', especifico: 'üë§ Espec√≠ficos' };
        const badgesHTML = alcances.map(a => `<span class="badge badge-alcance">${alcanceLabels[a] || a}</span>`).join('');
        
        // Badge de vinculaci√≥n
        let vinculacionBadgeHTML = '';
        if (enc.vinculacion?.bienNombre) {
          let vinc = `üè† ${enc.vinculacion.bienNombre}`;
          if (enc.vinculacion.moduloNombre) {
            vinc += ` ‚Ä∫ ${enc.vinculacion.moduloNombre}`;
          }
          if (enc.vinculacion.cardNombre) {
            vinc += ` ‚Ä∫ ${enc.vinculacion.cardNombre}`;
          }
          vinculacionBadgeHTML = `<span class="badge badge-vinculacion">${vinc}</span>`;
        }
        
        // Badge de tipo de publicaci√≥n
        let publicacionBadgeHTML = '';
        const pubTipo = enc.publicacion?.tipo;
        if (pubTipo === 'programada' && enc.publicacion.fechaProgramada) {
          const fp = typeof enc.publicacion.fechaProgramada === 'string'
            ? new Date(enc.publicacion.fechaProgramada)
            : enc.publicacion.fechaProgramada.toDate?.() || new Date(0);
          publicacionBadgeHTML = `<span class="badge badge-programada">üìÖ Programada: ${fp.toLocaleDateString('es-ES')} ${fp.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit'})}</span>`;
        } else if (pubTipo === 'automatico') {
          publicacionBadgeHTML = `<span class="badge badge-automatico">üîÑ Auto: al finalizar reserva</span>`;
        } else {
          publicacionBadgeHTML = `<span class="badge badge-manual">üì§ Publicaci√≥n manual</span>`;
        }
        
        // Badge destinatario solicitante
        const solicitanteBadge = enc.destinatarios?.incluirSolicitante 
          ? `<span class="badge badge-solicitante">üìã Al solicitante</span>` 
          : '';

        return `
          <div class="borrador-card">
            <div class="borrador-body">
              <div class="borrador-titulo">${enc.titulo || 'Sin t√≠tulo'}</div>
              ${enc.descripcion ? `<div class="borrador-desc">${enc.descripcion}</div>` : ''}
              <div class="borrador-meta">
                <span>üìù ${enc.preguntas?.length || 0} pregunta${(enc.preguntas?.length || 0) !== 1 ? 's' : ''}</span>
                <span>üìÖ ${formatFecha(enc.fechaCreacion)}</span>
              </div>
              <div class="borrador-badges">${badgesHTML} ${solicitanteBadge} ${vinculacionBadgeHTML} ${publicacionBadgeHTML}</div>
              <div class="borrador-actions">
                <button class="btn btn-sm btn-secondary" onclick="editarBorrador('${enc.id}')">‚úèÔ∏è Editar</button>
                <button class="btn btn-sm btn-publish" onclick="publicarEncuesta('${enc.id}')">üì§ Publicar ahora</button>
                <button class="btn btn-sm btn-danger" onclick="eliminarEncuesta('${enc.id}')">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderActivas(lista) {
      const container = document.getElementById('activas-list');
      const empty = document.getElementById('empty-activas');

      if (lista.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      container.innerHTML = lista.map(enc => {
        const creador = miembrosData.find(m => m.id === enc.creadoPor);
        const respuestas = enc.respuestas || {};
        const totalRespuestas = Object.keys(respuestas).length;
        const yaRespondi = respuestas[currentUser.uid] !== undefined;

        let preguntasHTML = '';
        enc.preguntas.forEach((preg, pIdx) => {
          preguntasHTML += `<div class="pregunta-item">`;
          preguntasHTML += `<div class="pregunta-numero">Pregunta ${pIdx + 1}</div>`;
          preguntasHTML += `<div class="pregunta-texto">${preg.texto}</div>`;
          if (yaRespondi) {
            preguntasHTML += renderResultadosInline(enc, pIdx, preg);
          } else {
            preguntasHTML += renderOpciones(enc.id, pIdx, preg);
          }
          preguntasHTML += `</div>`;
        });

        return `
          <div class="encuesta-card">
            <div class="encuesta-header">
              <div>
                <div class="encuesta-titulo">${enc.titulo}</div>
                ${enc.descripcion ? `<div class="encuesta-descripcion">${enc.descripcion}</div>` : ''}
                <div class="encuesta-meta">
                  <span>üë§ ${creador?.nombre || 'Desconocido'}</span>
                  <span>üìù ${enc.preguntas.length} pregunta${enc.preguntas.length > 1 ? 's' : ''}</span>
                </div>
              </div>
              <span class="encuesta-estado abierta">üü¢ Abierta</span>
            </div>
            <div class="encuesta-body">
              ${preguntasHTML}
              ${!yaRespondi ? `
                <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="enviarRespuestas('${enc.id}')">
                  ‚úÖ Enviar mis respuestas
                </button>
              ` : ''}
            </div>
            <div class="encuesta-footer">
              <span class="participacion">${totalRespuestas} de ${miembrosData.length} han respondido</span>
              ${enc.creadoPor === currentUser.uid ? `
                <div style="display:flex;gap:8px;">
                  <button class="btn btn-sm btn-secondary" onclick="cerrarEncuesta('${enc.id}')">üîí Cerrar</button>
                  <button class="btn btn-sm btn-danger" onclick="eliminarEncuesta('${enc.id}')">üóëÔ∏è</button>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderRealizadas(lista) {
      const container = document.getElementById('realizadas-list');
      const empty = document.getElementById('empty-realizadas');

      if (lista.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      container.innerHTML = lista.map(enc => {
        const totalResp = Object.keys(enc.respuestas || {}).length;
        const fechaCierre = formatFecha(enc.fechaCierre || enc.fechaCreacion);
        return `
          <div class="realizada-item" onclick="abrirDetalle('${enc.id}')">
            <div class="realizada-info">
              <div class="realizada-titulo">${enc.titulo}</div>
              <div class="realizada-meta">
                <span>üìÖ ${fechaCierre}</span>
                <span>üìù ${enc.preguntas?.length || 0} preguntas</span>
              </div>
            </div>
            <div class="realizada-resp">
              üë• ${totalResp}/${miembrosData.length}
            </div>
            <span class="realizada-arrow">‚Ä∫</span>
          </div>
        `;
      }).join('');
    }

    // ========================================
    // RENDER OPCIONES (para responder)
    // ========================================
    function renderOpciones(encuestaId, pregIdx, preg) {
      const misResp = respuestasTemp[encuestaId] || {};
      const miRespuesta = misResp[pregIdx];
      let html = '<div class="respuestas-opciones">';

      if (preg.tipo === 'opciones' || preg.tipo === 'multiple') {
        const inputType = preg.tipo === 'multiple' ? 'checkbox' : 'radio';
        preg.opciones.forEach((op, oIdx) => {
          const checked = preg.tipo === 'multiple'
            ? (Array.isArray(miRespuesta) && miRespuesta.includes(oIdx))
            : miRespuesta === oIdx;
          html += `
            <label class="respuesta-opcion ${checked ? 'selected' : ''}" onclick="seleccionarOpcion('${encuestaId}', ${pregIdx}, ${oIdx}, '${preg.tipo}')">
              <input type="${inputType}" name="enc_${encuestaId}_p${pregIdx}" ${checked ? 'checked' : ''}>
              <span>${op}</span>
            </label>`;
        });
      } else if (preg.tipo === 'escala') {
        html += '<div class="escala-container">';
        for (let i = 1; i <= 5; i++) {
          html += `<div class="escala-opcion ${miRespuesta === i ? 'selected' : ''}" onclick="seleccionarEscala('${encuestaId}', ${pregIdx}, ${i})">${i}</div>`;
        }
        html += '</div><div class="escala-labels"><span>Nada</span><span>Mucho</span></div>';
      } else if (preg.tipo === 'texto') {
        html += `<input type="text" class="respuesta-texto-input" placeholder="Escribe tu respuesta..." data-encuesta="${encuestaId}" data-pregunta="${pregIdx}" value="${miRespuesta || ''}" onchange="guardarTexto('${encuestaId}', ${pregIdx}, this.value)">`;
      }

      html += '</div>';
      return html;
    }

    // Resultados inline (barras simples) para Activas
    function renderResultadosInline(enc, pregIdx, preg) {
      const respuestas = enc.respuestas || {};
      const total = Object.keys(respuestas).length;
      let html = '<div class="resultado-barra-container">';

      if (preg.tipo === 'opciones' || preg.tipo === 'multiple') {
        const conteo = {};
        preg.opciones.forEach((_, i) => conteo[i] = 0);
        Object.values(respuestas).forEach(r => {
          const resp = r[pregIdx];
          if (preg.tipo === 'multiple' && Array.isArray(resp)) {
            resp.forEach(idx => { if (conteo[idx] !== undefined) conteo[idx]++; });
          } else if (conteo[resp] !== undefined) { conteo[resp]++; }
        });
        preg.opciones.forEach((op, i) => {
          const pct = total > 0 ? (conteo[i] / total * 100) : 0;
          html += `<div class="resultado-item"><span class="resultado-texto">${op}</span><div class="resultado-barra"><div class="resultado-barra-fill" style="width:${pct}%"></div></div><span class="resultado-porcentaje">${conteo[i]} (${Math.round(pct)}%)</span></div>`;
        });
      } else if (preg.tipo === 'escala') {
        let suma = 0, count = 0;
        Object.values(respuestas).forEach(r => { if (r[pregIdx]) { suma += r[pregIdx]; count++; } });
        const promedio = count > 0 ? (suma / count).toFixed(1) : '‚Äì';
        html += `<div style="text-align:center;font-size:1.5rem;font-weight:700;color:var(--sage-dark)">Promedio: ${promedio} / 5</div>`;
      } else if (preg.tipo === 'texto') {
        Object.entries(respuestas).filter(([_, r]) => r[pregIdx]).forEach(([uid, r]) => {
          const m = miembrosData.find(x => x.id === uid);
          html += `<div style="padding:8px;background:var(--cream);border-radius:var(--radius-sm);margin-bottom:6px"><strong>${m?.nombre || 'An√≥nimo'}:</strong> ${r[pregIdx]}</div>`;
        });
      }

      html += '</div>';
      return html;
    }

    // ========================================
    // RESPUESTAS
    // ========================================
    function seleccionarOpcion(encuestaId, pregIdx, opcionIdx, tipo) {
      if (!respuestasTemp[encuestaId]) respuestasTemp[encuestaId] = {};
      if (tipo === 'multiple') {
        if (!Array.isArray(respuestasTemp[encuestaId][pregIdx])) respuestasTemp[encuestaId][pregIdx] = [];
        const arr = respuestasTemp[encuestaId][pregIdx];
        const idx = arr.indexOf(opcionIdx);
        if (idx > -1) arr.splice(idx, 1); else arr.push(opcionIdx);
      } else {
        respuestasTemp[encuestaId][pregIdx] = opcionIdx;
      }
      renderTodo();
    }

    function seleccionarEscala(encuestaId, pregIdx, valor) {
      if (!respuestasTemp[encuestaId]) respuestasTemp[encuestaId] = {};
      respuestasTemp[encuestaId][pregIdx] = valor;
      renderTodo();
    }

    function guardarTexto(encuestaId, pregIdx, valor) {
      if (!respuestasTemp[encuestaId]) respuestasTemp[encuestaId] = {};
      respuestasTemp[encuestaId][pregIdx] = valor;
    }

    async function enviarRespuestas(encuestaId) {
      const encuesta = encuestasData.find(e => e.id === encuestaId);
      if (!encuesta) return;
      const misResp = respuestasTemp[encuestaId] || {};

      for (let i = 0; i < encuesta.preguntas.length; i++) {
        if (misResp[i] === undefined || misResp[i] === '' || (Array.isArray(misResp[i]) && misResp[i].length === 0)) {
          alert('Por favor responde la pregunta ' + (i + 1));
          return;
        }
      }

      try {
        const respActuales = encuesta.respuestas || {};
        respActuales[currentUser.uid] = misResp;
        await db.collection('encuestas').doc(encuestaId).update({ respuestas: respActuales });
        delete respuestasTemp[encuestaId];
        await loadEncuestas();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar respuestas');
      }
    }

    // ========================================
    // ACCIONES: PUBLICAR / CERRAR / ELIMINAR
    // ========================================
    async function publicarEncuesta(id) {
      if (!confirm('¬øPublicar esta encuesta? Los destinatarios podr√°n verla y responder.')) return;
      try {
        await db.collection('encuestas').doc(id).update({
          estado: 'activa',
          fechaPublicacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        await loadEncuestas();
      } catch (e) { console.error(e); alert('Error al publicar'); }
    }

    async function cerrarEncuesta(id) {
      if (!confirm('¬øCerrar esta encuesta? Ya no se podr√° responder.')) return;
      try {
        await db.collection('encuestas').doc(id).update({
          estado: 'cerrada',
          fechaCierre: firebase.firestore.FieldValue.serverTimestamp()
        });
        await loadEncuestas();
      } catch (e) { console.error(e); }
    }

    async function eliminarEncuesta(id) {
      if (!confirm('¬øEliminar esta encuesta definitivamente?')) return;
      try {
        await db.collection('encuestas').doc(id).delete();
        await loadEncuestas();
      } catch (e) { console.error(e); }
    }

    // ========================================
    // MODAL: CREAR / EDITAR
    // ========================================
    async function abrirModal(id) {
      editandoId = id || null;
      destinatariosSeleccionados = [];
      miembrosSeleccionados = [];

      // Reset cascada vinculaci√≥n
      vinculacionBien = null;
      vinculacionModulo = null;
      vinculacionCard = null;
      modulosDelBien = [];
      cardsDelModulo = [];

      // Reset UI
      document.getElementById('enc-titulo').value = '';
      document.getElementById('enc-descripcion').value = '';
      document.querySelectorAll('.destinatario-check').forEach(d => { d.classList.remove('selected'); d.querySelector('input').checked = false; });
      document.getElementById('miembros-especificos').classList.add('hidden');
      
      // Reset vinculaci√≥n UI
      const checkVincularBien = document.querySelector('#check-vincular-bien input');
      if (checkVincularBien) checkVincularBien.checked = false;
      document.getElementById('bien-selector-wrapper').classList.add('hidden');
      document.getElementById('bien-sin-addon').classList.add('hidden');
      document.getElementById('modulo-check-wrapper').classList.add('hidden');
      document.getElementById('modulo-selector-wrapper').classList.add('hidden');
      document.getElementById('card-selector-wrapper').classList.add('hidden');
      const checkModulo = document.getElementById('check-vincular-modulo');
      if (checkModulo) checkModulo.checked = false;
      
      // Reset publicaci√≥n
      document.querySelector('input[name="publicacion"][value="manual"]').checked = true;
      document.getElementById('fecha-programada-wrapper').classList.add('hidden');
      document.getElementById('enc-fecha-programada').value = '';
      document.getElementById('automatico-helper').classList.add('hidden');
      document.getElementById('opcion-automatico').classList.add('hidden');

      if (editandoId) {
        // Editar borrador
        const enc = encuestasData.find(e => e.id === editandoId);
        if (!enc) return;
        document.getElementById('modal-enc-titulo').textContent = '‚úèÔ∏è Editar encuesta';
        document.getElementById('enc-titulo').value = enc.titulo || '';
        document.getElementById('enc-descripcion').value = enc.descripcion || '';

        // Destinatarios
        const alcances = enc.destinatarios?.alcance || [];
        destinatariosSeleccionados = [...alcances];
        document.querySelectorAll('#destinatarios-grid input[type="checkbox"]').forEach(inp => {
          if (alcances.includes(inp.value)) {
            inp.checked = true;
            inp.closest('.destinatario-check').classList.add('selected');
          }
        });
        if (alcances.includes('especifico')) {
          miembrosSeleccionados = [...(enc.destinatarios?.miembrosIds || [])];
          // Restaurar selecci√≥n de solicitante si aplica
          if (enc.destinatarios?.incluirSolicitante) {
            miembrosSeleccionados.push('__solicitante__');
          }
          renderMiembrosSelector();
          document.getElementById('miembros-especificos').classList.remove('hidden');
        }

        // Restaurar vinculaci√≥n si existe (esto actualizar√° el selector de miembros)
        if (enc.vinculacion?.bienId) {
          await restaurarVinculacion(enc);
        }

        // Publicaci√≥n
        let pubTipo = enc.publicacion?.tipo || 'manual';
        // Si era autom√°tico pero ya no hay vinculaci√≥n v√°lida, defaultear a manual
        if (pubTipo === 'automatico' && !enc.vinculacion?.moduloId) {
          pubTipo = 'manual';
        }
        document.querySelector(`input[name="publicacion"][value="${pubTipo}"]`).checked = true;
        
        if (pubTipo === 'programada') {
          document.getElementById('fecha-programada-wrapper').classList.remove('hidden');
          if (enc.publicacion.fechaProgramada) {
            const fp = typeof enc.publicacion.fechaProgramada === 'string'
              ? enc.publicacion.fechaProgramada
              : enc.publicacion.fechaProgramada.toDate?.().toISOString().slice(0, 16) || '';
            document.getElementById('enc-fecha-programada').value = fp;
          }
        } else if (pubTipo === 'automatico') {
          document.getElementById('automatico-helper').classList.remove('hidden');
        }

        // Preguntas
        preguntasBuilder = (enc.preguntas || []).map((p, i) => ({
          id: Date.now() + i,
          texto: p.texto,
          tipo: p.tipo,
          opciones: p.opciones ? [...p.opciones] : ['', '']
        }));
      } else {
        document.getElementById('modal-enc-titulo').textContent = 'üìä Nueva encuesta';
        preguntasBuilder = [{ id: Date.now(), texto: '', tipo: 'opciones', opciones: ['', ''] }];
      }

      renderPreguntasBuilder();
      document.getElementById('modal-encuesta').classList.add('active');
    }

    function cerrarModal() {
      document.getElementById('modal-encuesta').classList.remove('active');
      editandoId = null;
    }

    function editarBorrador(id) { abrirModal(id); }

    // Destinatarios
    function toggleDestinatario(input) {
      const valor = input.value;
      const label = input.closest('.destinatario-check');
      const checked = input.checked;
      
      console.log('toggleDestinatario:', valor, checked, 'miembros disponibles:', miembrosData.length);
      
      label.classList.toggle('selected', checked);

      if (checked && !destinatariosSeleccionados.includes(valor)) {
        destinatariosSeleccionados.push(valor);
      } else if (!checked) {
        destinatariosSeleccionados = destinatariosSeleccionados.filter(d => d !== valor);
      }

      if (valor === 'especifico') {
        const wrapper = document.getElementById('miembros-especificos');
        if (checked) {
          console.log('Mostrando selector miembros, miembrosData:', miembrosData);
          renderMiembrosSelector();
          wrapper.classList.remove('hidden');
        } else {
          wrapper.classList.add('hidden');
          miembrosSeleccionados = [];
        }
      }
    }

    function renderMiembrosSelector() {
      const container = document.getElementById('miembros-especificos');
      console.log('renderMiembrosSelector - container:', container, 'miembrosData:', miembrosData.length, 'vinculacionModulo:', vinculacionModulo);
      
      // Opci√≥n especial si hay vinculaci√≥n a m√≥dulo de reservas/eventos
      let opcionSolicitante = '';
      if (vinculacionModulo?.esReservaEvento) {
        const checked = miembrosSeleccionados.includes('__solicitante__');
        opcionSolicitante = `
          <label class="miembro-check miembro-especial ${checked ? 'selected' : ''}">
            <input type="checkbox" value="__solicitante__" ${checked ? 'checked' : ''} onchange="toggleMiembro('__solicitante__', this.checked)">
            üìã Quien solicit√≥ el evento/reserva
          </label>
          <div class="miembros-separador">‚Äî o miembros espec√≠ficos ‚Äî</div>
        `;
      }
      
      const miembrosHTML = miembrosData
        .filter(m => m.id !== currentUser.uid)
        .map(m => {
          const checked = miembrosSeleccionados.includes(m.id);
          return `<label class="miembro-check">
            <input type="checkbox" value="${m.id}" ${checked ? 'checked' : ''} onchange="toggleMiembro('${m.id}', this.checked)">
            ${m.nombre || m.email || m.id}
          </label>`;
        }).join('');
      
      container.innerHTML = opcionSolicitante + miembrosHTML;
      console.log('Selector miembros HTML generado:', container.innerHTML.length, 'chars');
    }

    function toggleMiembro(id, checked) {
      if (checked && !miembrosSeleccionados.includes(id)) miembrosSeleccionados.push(id);
      else miembrosSeleccionados = miembrosSeleccionados.filter(m => m !== id);
    }
    
    // Actualiza el selector de miembros cuando cambia la vinculaci√≥n
    function actualizarSelectorMiembros() {
      if (destinatariosSeleccionados.includes('especifico')) {
        renderMiembrosSelector();
      }
    }

    // Publicaci√≥n
    function togglePublicacionOpciones() {
      const tipo = document.querySelector('input[name="publicacion"]:checked').value;
      document.getElementById('fecha-programada-wrapper').classList.toggle('hidden', tipo !== 'programada');
      document.getElementById('automatico-helper').classList.toggle('hidden', tipo !== 'automatico');
    }

    // ========================================
    // CASCADA DE VINCULACI√ìN
    // ========================================
    function toggleVincularBien(checked) {
      console.log('toggleVincularBien:', checked, 'bienes disponibles:', bienesData.length);
      const wrapper = document.getElementById('bien-selector-wrapper');
      wrapper.classList.toggle('hidden', !checked);
      
      if (checked) {
        // Poblar selector de bienes
        const select = document.getElementById('enc-bien');
        select.innerHTML = '<option value="">‚Äî Selecciona un bien ‚Äî</option>' +
          bienesData.map(b => `<option value="${b.id}" data-addon="${b.tieneAddon}">${b.nombre}</option>`).join('');
        console.log('Selector poblado con', bienesData.length, 'bienes');
      } else {
        // Reset cascada
        resetCascadaBien();
      }
    }

    function resetCascadaBien() {
      vinculacionBien = null;
      vinculacionModulo = null;
      vinculacionCard = null;
      modulosDelBien = [];
      cardsDelModulo = [];
      
      document.getElementById('enc-bien').value = '';
      document.getElementById('bien-sin-addon').classList.add('hidden');
      document.getElementById('modulo-check-wrapper').classList.add('hidden');
      document.getElementById('modulo-selector-wrapper').classList.add('hidden');
      document.getElementById('card-selector-wrapper').classList.add('hidden');
      
      const checkModulo = document.getElementById('check-vincular-modulo');
      if (checkModulo) checkModulo.checked = false;
      
      ocultarOpcionAutomatico();
    }

    async function onBienSeleccionado() {
      const select = document.getElementById('enc-bien');
      const bienId = select.value;
      
      // Reset niveles inferiores
      vinculacionModulo = null;
      vinculacionCard = null;
      modulosDelBien = [];
      cardsDelModulo = [];
      document.getElementById('modulo-check-wrapper').classList.add('hidden');
      document.getElementById('modulo-selector-wrapper').classList.add('hidden');
      document.getElementById('card-selector-wrapper').classList.add('hidden');
      const checkModulo = document.getElementById('check-vincular-modulo');
      if (checkModulo) checkModulo.checked = false;
      ocultarOpcionAutomatico();
      
      if (!bienId) {
        vinculacionBien = null;
        document.getElementById('bien-sin-addon').classList.add('hidden');
        return;
      }
      
      const bien = bienesData.find(b => b.id === bienId);
      vinculacionBien = bien;
      
      if (!bien.tieneAddon) {
        document.getElementById('bien-sin-addon').classList.remove('hidden');
        return;
      }
      
      document.getElementById('bien-sin-addon').classList.add('hidden');
      document.getElementById('modulo-check-wrapper').classList.remove('hidden');
    }

    function toggleVincularModulo(checked) {
      const wrapper = document.getElementById('modulo-selector-wrapper');
      wrapper.classList.toggle('hidden', !checked);
      
      if (checked && vinculacionBien) {
        cargarModulosDelBien(vinculacionBien.id);
      } else {
        vinculacionModulo = null;
        vinculacionCard = null;
        cardsDelModulo = [];
        document.getElementById('card-selector-wrapper').classList.add('hidden');
        ocultarOpcionAutomatico();
        // Quitar opci√≥n solicitante si estaba seleccionada
        miembrosSeleccionados = miembrosSeleccionados.filter(m => m !== '__solicitante__');
        actualizarSelectorMiembros();
      }
    }

    async function cargarModulosDelBien(bienId) {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('modulos').get();
        modulosDelBien = snap.docs.map(doc => {
          const data = doc.data();
          const nombre = data.nombre || '';
          return {
            id: doc.id,
            nombre: nombre,
            esReservaEvento: /reserva|evento/i.test(nombre)
          };
        });
        
        const select = document.getElementById('enc-modulo');
        select.innerHTML = '<option value="">‚Äî Selecciona un m√≥dulo ‚Äî</option>' +
          modulosDelBien.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
        
      } catch (e) {
        console.error('Error cargando m√≥dulos:', e);
        modulosDelBien = [];
      }
    }

    async function onModuloSeleccionado() {
      const select = document.getElementById('enc-modulo');
      const moduloId = select.value;
      
      // Reset card
      vinculacionCard = null;
      cardsDelModulo = [];
      document.getElementById('card-selector-wrapper').classList.add('hidden');
      
      if (!moduloId) {
        vinculacionModulo = null;
        ocultarOpcionAutomatico();
        actualizarSelectorMiembros(); // Actualizar para quitar opci√≥n solicitante
        return;
      }
      
      const modulo = modulosDelBien.find(m => m.id === moduloId);
      vinculacionModulo = modulo;
      
      // Mostrar/ocultar opci√≥n Autom√°tico seg√∫n tipo de m√≥dulo
      if (modulo.esReservaEvento) {
        mostrarOpcionAutomatico();
      } else {
        ocultarOpcionAutomatico();
      }
      
      // Actualizar selector de miembros para mostrar/quitar opci√≥n solicitante
      actualizarSelectorMiembros();
      
      // Cargar cards del m√≥dulo
      await cargarCardsDelModulo(vinculacionBien.id, moduloId);
    }

    async function cargarCardsDelModulo(bienId, moduloId) {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('modulos').doc(moduloId)
          .collection('cards').get();
        
        cardsDelModulo = snap.docs.map(doc => ({
          id: doc.id,
          nombre: doc.data().nombre || doc.id
        }));
        
        // Solo mostrar selector si hay m√°s de 1 card
        if (cardsDelModulo.length > 1) {
          const select = document.getElementById('enc-card');
          select.innerHTML = '<option value="">‚Äî Todos los cards ‚Äî</option>' +
            cardsDelModulo.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
          document.getElementById('card-selector-wrapper').classList.remove('hidden');
        } else if (cardsDelModulo.length === 1) {
          // Auto-seleccionar el √∫nico card
          vinculacionCard = cardsDelModulo[0];
        }
        
      } catch (e) {
        console.error('Error cargando cards:', e);
        cardsDelModulo = [];
      }
    }

    function onCardSeleccionado() {
      const cardId = document.getElementById('enc-card').value;
      if (cardId) {
        vinculacionCard = cardsDelModulo.find(c => c.id === cardId);
      } else {
        vinculacionCard = null;
      }
    }

    function mostrarOpcionAutomatico() {
      document.getElementById('opcion-automatico').classList.remove('hidden');
    }

    function ocultarOpcionAutomatico() {
      const opcion = document.getElementById('opcion-automatico');
      opcion.classList.add('hidden');
      // Si estaba seleccionado, cambiar a manual
      const input = opcion.querySelector('input');
      if (input && input.checked) {
        document.querySelector('input[name="publicacion"][value="manual"]').checked = true;
        togglePublicacionOpciones();
      }
    }

    // Restaurar vinculaci√≥n al editar borrador
    async function restaurarVinculacion(enc) {
      const v = enc.vinculacion;
      if (!v?.bienId) return;
      
      // Marcar checkbox y mostrar selector de bien
      const checkVincularBien = document.querySelector('#check-vincular-bien input');
      if (checkVincularBien) checkVincularBien.checked = true;
      document.getElementById('bien-selector-wrapper').classList.remove('hidden');
      
      // Poblar y seleccionar bien
      const selectBien = document.getElementById('enc-bien');
      selectBien.innerHTML = '<option value="">‚Äî Selecciona un bien ‚Äî</option>' +
        bienesData.map(b => `<option value="${b.id}">${b.nombre}</option>`).join('');
      selectBien.value = v.bienId;
      
      const bien = bienesData.find(b => b.id === v.bienId);
      vinculacionBien = bien;
      
      if (!bien?.tieneAddon) {
        document.getElementById('bien-sin-addon').classList.remove('hidden');
        return;
      }
      
      document.getElementById('modulo-check-wrapper').classList.remove('hidden');
      
      if (v.moduloId) {
        // Marcar checkbox y cargar m√≥dulos
        const checkModulo = document.getElementById('check-vincular-modulo');
        if (checkModulo) checkModulo.checked = true;
        document.getElementById('modulo-selector-wrapper').classList.remove('hidden');
        
        await cargarModulosDelBien(v.bienId);
        document.getElementById('enc-modulo').value = v.moduloId;
        
        const modulo = modulosDelBien.find(m => m.id === v.moduloId);
        vinculacionModulo = modulo;
        
        if (modulo?.esReservaEvento) {
          mostrarOpcionAutomatico();
        }
        
        if (v.cardId) {
          await cargarCardsDelModulo(v.bienId, v.moduloId);
          if (cardsDelModulo.length > 1) {
            document.getElementById('enc-card').value = v.cardId;
          }
          vinculacionCard = cardsDelModulo.find(c => c.id === v.cardId);
        }
      }
    }

    // ========================================
    // CONSTRUCTOR PREGUNTAS
    // ========================================
    function agregarPregunta() {
      preguntasBuilder.push({ id: Date.now(), texto: '', tipo: 'opciones', opciones: ['', ''] });
      renderPreguntasBuilder();
    }

    function eliminarPreguntaBuilder(id) {
      if (preguntasBuilder.length <= 1) { alert('Necesitas al menos 1 pregunta'); return; }
      preguntasBuilder = preguntasBuilder.filter(p => p.id !== id);
      renderPreguntasBuilder();
    }

    function renderPreguntasBuilder() {
      document.getElementById('preguntas-constructor').innerHTML = preguntasBuilder.map((p, idx) => `
        <div class="pregunta-builder">
          <div class="pregunta-builder-header">
            <span class="pregunta-builder-num">Pregunta ${idx + 1}</span>
            <button type="button" class="btn-remove-pregunta" onclick="eliminarPreguntaBuilder(${p.id})">√ó</button>
          </div>
          <div class="pregunta-builder-body">
            <input type="text" class="form-input" placeholder="Escribe la pregunta..." value="${p.texto}" onchange="actualizarPregunta(${p.id}, 'texto', this.value)">
            <select class="form-select" onchange="actualizarPregunta(${p.id}, 'tipo', this.value)" style="margin-top:8px">
              <option value="opciones" ${p.tipo === 'opciones' ? 'selected' : ''}>Opci√≥n √∫nica</option>
              <option value="multiple" ${p.tipo === 'multiple' ? 'selected' : ''}>Opci√≥n m√∫ltiple</option>
              <option value="escala" ${p.tipo === 'escala' ? 'selected' : ''}>Escala 1-5</option>
              <option value="texto" ${p.tipo === 'texto' ? 'selected' : ''}>Texto libre</option>
            </select>
            ${(p.tipo === 'opciones' || p.tipo === 'multiple') ? `
              <div class="opciones-builder">
                ${p.opciones.map((op, oIdx) => `
                  <div class="opcion-builder-item">
                    <input type="text" placeholder="Opci√≥n ${oIdx + 1}" value="${op}" onchange="actualizarOpcion(${p.id}, ${oIdx}, this.value)">
                    <button type="button" class="btn-remove-pregunta" style="width:30px;height:30px" onclick="eliminarOpcionBuilder(${p.id}, ${oIdx})">√ó</button>
                  </div>
                `).join('')}
                <button type="button" class="btn-add-opcion-sm" onclick="agregarOpcionBuilder(${p.id})">+ Opci√≥n</button>
              </div>` : ''}
          </div>
        </div>
      `).join('');
    }

    function actualizarPregunta(id, campo, valor) {
      const p = preguntasBuilder.find(x => x.id === id);
      if (p) { p[campo] = valor; if (campo === 'tipo') renderPreguntasBuilder(); }
    }
    function actualizarOpcion(pregId, opIdx, valor) {
      const p = preguntasBuilder.find(x => x.id === pregId);
      if (p?.opciones) p.opciones[opIdx] = valor;
    }
    function agregarOpcionBuilder(pregId) {
      const p = preguntasBuilder.find(x => x.id === pregId);
      if (p?.opciones) { p.opciones.push(''); renderPreguntasBuilder(); }
    }
    function eliminarOpcionBuilder(pregId, opIdx) {
      const p = preguntasBuilder.find(x => x.id === pregId);
      if (p?.opciones?.length > 2) { p.opciones.splice(opIdx, 1); renderPreguntasBuilder(); }
      else alert('Necesitas al menos 2 opciones');
    }

    // ========================================
    // GUARDAR ENCUESTA (borrador)
    // ========================================
    async function guardarEncuesta() {
      const titulo = document.getElementById('enc-titulo').value.trim();
      if (!titulo) { alert('Escribe un t√≠tulo'); return; }

      if (destinatariosSeleccionados.length === 0) { alert('Selecciona al menos un destinatario'); return; }
      if (destinatariosSeleccionados.includes('especifico') && miembrosSeleccionados.length === 0) {
        alert('Selecciona al menos un miembro espec√≠fico'); return;
      }

      // Validar preguntas
      let preguntas;
      try {
        preguntas = preguntasBuilder.map(p => {
          if (!p.texto.trim()) throw new Error('Todas las preguntas necesitan texto');
          const preg = { texto: p.texto, tipo: p.tipo };
          if (p.tipo === 'opciones' || p.tipo === 'multiple') {
            preg.opciones = p.opciones.filter(o => o.trim());
            if (preg.opciones.length < 2) throw new Error('Cada pregunta de opciones necesita al menos 2 opciones');
          }
          return preg;
        });
      } catch (error) {
        alert(error.message);
        return;
      }

      if (preguntas.length === 0) { alert('A√±ade al menos una pregunta'); return; }

      const publicacionTipo = document.querySelector('input[name="publicacion"]:checked').value;
      const fechaProgramada = publicacionTipo === 'programada'
        ? document.getElementById('enc-fecha-programada').value || null
        : null;

      if (publicacionTipo === 'programada' && !fechaProgramada) {
        alert('Selecciona la fecha de env√≠o programada'); return;
      }

      // Construir objeto vinculaci√≥n
      const vinculacion = {};
      if (vinculacionBien) {
        vinculacion.bienId = vinculacionBien.id;
        vinculacion.bienNombre = vinculacionBien.nombre;
      }
      if (vinculacionModulo) {
        vinculacion.moduloId = vinculacionModulo.id;
        vinculacion.moduloNombre = vinculacionModulo.nombre;
        vinculacion.esReservaEvento = vinculacionModulo.esReservaEvento;
      }
      if (vinculacionCard) {
        vinculacion.cardId = vinculacionCard.id;
        vinculacion.cardNombre = vinculacionCard.nombre;
      }

      const data = {
        titulo,
        descripcion: document.getElementById('enc-descripcion').value.trim(),
        preguntas,
        destinatarios: {
          alcance: [...destinatariosSeleccionados],
          incluirSolicitante: miembrosSeleccionados.includes('__solicitante__'),
          miembrosIds: destinatariosSeleccionados.includes('especifico') 
            ? miembrosSeleccionados.filter(m => m !== '__solicitante__') 
            : []
        },
        vinculacion: Object.keys(vinculacion).length > 0 ? vinculacion : null,
        publicacion: {
          tipo: publicacionTipo,
          fechaProgramada: fechaProgramada,
          hito: publicacionTipo === 'automatico' ? 'fin' : null
        },
        estado: 'borrador',
        familiaId,
        creadoPor: currentUser.uid
      };

      try {
        if (editandoId) {
          await db.collection('encuestas').doc(editandoId).update(data);
        } else {
          data.respuestas = {};
          data.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('encuestas').add(data);
        }
        cerrarModal();
        await loadEncuestas();
      } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'Error al guardar');
      }
    }

    // ========================================
    // DETALLE RESULTADOS (modal con gr√°ficos)
    // ========================================
    function abrirDetalle(id) {
      const enc = encuestasData.find(e => e.id === id);
      if (!enc) return;

      document.getElementById('detalle-titulo').textContent = 'üìä ' + enc.titulo;
      const body = document.getElementById('detalle-body');
      const respuestas = enc.respuestas || {};
      const total = Object.keys(respuestas).length;

      let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:14px 18px;background:var(--cream);border-radius:var(--radius-md);">
        <span style="font-weight:700;font-size:0.95rem;">üë• Participaci√≥n: ${total} de ${miembrosData.length}</span>
        <span style="font-size:0.85rem;color:var(--text-muted);">üìÖ Cerrada: ${formatFecha(enc.fechaCierre || enc.fechaCreacion)}</span>
      </div>`;

      enc.preguntas.forEach((preg, pIdx) => {
        html += `<div class="detalle-pregunta">`;
        html += `<div class="detalle-pregunta-num">Pregunta ${pIdx + 1}</div>`;
        html += `<div class="detalle-pregunta-texto">${preg.texto}</div>`;

        if (preg.tipo === 'opciones' || preg.tipo === 'multiple') {
          const conteo = {};
          preg.opciones.forEach((_, i) => conteo[i] = 0);
          Object.values(respuestas).forEach(r => {
            const resp = r[pIdx];
            if (preg.tipo === 'multiple' && Array.isArray(resp)) {
              resp.forEach(idx => { if (conteo[idx] !== undefined) conteo[idx]++; });
            } else if (conteo[resp] !== undefined) { conteo[resp]++; }
          });

          // Donut SVG + leyenda
          html += '<div class="grafico-container">';
          html += generarDonutSVG(preg.opciones, conteo, total);
          html += '<div class="grafico-leyenda">';
          preg.opciones.forEach((op, i) => {
            const pct = total > 0 ? Math.round(conteo[i] / total * 100) : 0;
            html += `<div class="leyenda-item">
              <span class="leyenda-color" style="background:${COLORES_GRAFICO[i % COLORES_GRAFICO.length]}"></span>
              <span style="flex:1">${op}</span>
              <strong>${conteo[i]}</strong>
              <span style="color:var(--text-muted);min-width:40px;text-align:right">${pct}%</span>
            </div>`;
          });
          html += '</div></div>';

        } else if (preg.tipo === 'escala') {
          let suma = 0, count = 0;
          const distrib = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
          Object.values(respuestas).forEach(r => {
            if (r[pIdx]) { suma += r[pIdx]; count++; distrib[r[pIdx]]++; }
          });
          const promedio = count > 0 ? (suma / count).toFixed(1) : '‚Äì';

          html += `<div class="detalle-promedio">
            <div class="detalle-promedio-num">${promedio} / 5</div>
            <div style="font-size:0.85rem;color:var(--text-muted);margin-top:4px">${count} respuesta${count !== 1 ? 's' : ''}</div>
          </div>`;
          // Mini barras de distribuci√≥n
          html += '<div style="margin-top:12px;">';
          for (let i = 5; i >= 1; i--) {
            const pct = count > 0 ? (distrib[i] / count * 100) : 0;
            html += `<div class="resultado-item" style="margin-bottom:4px">
              <span class="resultado-texto" style="min-width:30px">${i} ‚≠ê</span>
              <div class="resultado-barra"><div class="resultado-barra-fill" style="width:${pct}%"></div></div>
              <span class="resultado-porcentaje">${distrib[i]}</span>
            </div>`;
          }
          html += '</div>';

        } else if (preg.tipo === 'texto') {
          html += '<div class="detalle-textos">';
          Object.entries(respuestas).filter(([_, r]) => r[pIdx]).forEach(([uid, r]) => {
            const m = miembrosData.find(x => x.id === uid);
            html += `<div class="detalle-texto-item"><span class="detalle-texto-autor">${m?.nombre || 'An√≥nimo'}:</span> ${r[pIdx]}</div>`;
          });
          if (Object.entries(respuestas).filter(([_, r]) => r[pIdx]).length === 0) {
            html += '<div style="color:var(--text-muted);font-size:0.85rem;">Sin respuestas de texto</div>';
          }
          html += '</div>';
        }

        html += `</div>`;
      });

      body.innerHTML = html;
      document.getElementById('modal-detalle').classList.add('active');
    }

    function cerrarDetalle() {
      document.getElementById('modal-detalle').classList.remove('active');
    }

    // ========================================
    // DONUT SVG
    // ========================================
    function generarDonutSVG(opciones, conteo, total) {
      const size = 120;
      const cx = size / 2, cy = size / 2;
      const outerR = 52, innerR = 30;

      if (total === 0) {
        return `<svg class="grafico-donut" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
          <circle cx="${cx}" cy="${cy}" r="${outerR}" fill="none" stroke="#F5EDE4" stroke-width="${outerR - innerR}"/>
          <text x="${cx}" y="${cy}" text-anchor="middle" dy="5" fill="#9A9A9A" font-size="14" font-weight="700">0</text>
        </svg>`;
      }

      let paths = '';
      let startAngle = -90; // Start from top

      opciones.forEach((_, i) => {
        const value = conteo[i] || 0;
        if (value === 0) return;
        const pct = value / total;
        const angle = pct * 360;
        const endAngle = startAngle + angle;
        const largeArc = angle > 180 ? 1 : 0;

        const x1 = cx + outerR * Math.cos(startAngle * Math.PI / 180);
        const y1 = cy + outerR * Math.sin(startAngle * Math.PI / 180);
        const x2 = cx + outerR * Math.cos(endAngle * Math.PI / 180);
        const y2 = cy + outerR * Math.sin(endAngle * Math.PI / 180);
        const x3 = cx + innerR * Math.cos(endAngle * Math.PI / 180);
        const y3 = cy + innerR * Math.sin(endAngle * Math.PI / 180);
        const x4 = cx + innerR * Math.cos(startAngle * Math.PI / 180);
        const y4 = cy + innerR * Math.sin(startAngle * Math.PI / 180);

        // Handle full circle
        if (pct >= 0.999) {
          paths += `<circle cx="${cx}" cy="${cy}" r="${(outerR + innerR) / 2}" fill="none" stroke="${COLORES_GRAFICO[i % COLORES_GRAFICO.length]}" stroke-width="${outerR - innerR}"/>`;
        } else {
          paths += `<path d="M ${x1} ${y1} A ${outerR} ${outerR} 0 ${largeArc} 1 ${x2} ${y2} L ${x3} ${y3} A ${innerR} ${innerR} 0 ${largeArc} 0 ${x4} ${y4} Z" fill="${COLORES_GRAFICO[i % COLORES_GRAFICO.length]}"/>`;
        }

        startAngle = endAngle;
      });

      return `<svg class="grafico-donut" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
        ${paths}
        <text x="${cx}" y="${cy}" text-anchor="middle" dy="5" fill="var(--text)" font-size="16" font-weight="700" font-family="Nunito">${total}</text>
      </svg>`;
    }

    // ========================================
    // UTILIDADES
    // ========================================
    function formatFecha(ts) {
      if (!ts) return '‚Äî';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    // Click fuera cierra modales
    document.getElementById('modal-encuesta').addEventListener('click', (e) => {
      if (e.target.id === 'modal-encuesta') cerrarModal();
    });
    document.getElementById('modal-detalle').addEventListener('click', (e) => {
      if (e.target.id === 'modal-detalle') cerrarDetalle();
    });
  </script>
</body>
</html>
