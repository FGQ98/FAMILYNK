rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // FUNCIONES AUXILIARES
    // ============================================================
    
    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Obtener datos del usuario actual
    function getUserData() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
    }
    
    // Verificar si es SuperAdmin
    function isSuperAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             getUserData().superAdmin == true;
    }
    
    // Verificar si es AdminSistema
    function isAdminSistema() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             getUserData().rol == 'AdminSistema';
    }
    
    // Verificar si es admin de una rama específica
    function isAdminRama(ramaId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             getUserData().ramaId == ramaId &&
             getUserData().rol == 'AdminRama';
    }
    
    // Verificar si es admin-rama (sin ramaId específico)
    function isAnyAdminRama() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             (getUserData().rol == 'AdminRama' || getUserData().credencial == 'admin-rama');
    }
    
    // Verificar si pertenece a una familia
    function belongsToFamilia(familiaId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             getUserData().familiaId == familiaId;
    }
    
    // ============================================================
    // COLECCIÓN: usuarios
    // ============================================================
    match /usuarios/{userId} {
      // Permitir leer: tu propio doc, superadmin, adminsistema, o miembros de tu misma familia
      allow read: if isAuthenticated() && 
                    (request.auth.uid == userId || 
                     isSuperAdmin() || 
                     isAdminSistema() ||
                     (resource.data.familiaId != null && belongsToFamilia(resource.data.familiaId)));
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      (request.auth.uid == userId || isSuperAdmin() || isAdminSistema());
      allow delete: if isSuperAdmin();
    }
    
    // ============================================================
    // COLECCIÓN: externos (caseros, hosters, guardas)
    // ============================================================
    match /externos/{externoId} {
      // Leer: autenticado y de tu familia
      allow read: if isAuthenticated() && 
                    (isSuperAdmin() || 
                     isAdminSistema() || 
                     belongsToFamilia(resource.data.familiaId));
      // Escribir: superadmin, adminsistema, o miembro de la familia
      allow create: if isAuthenticated() && 
                      (isSuperAdmin() || isAdminSistema() || belongsToFamilia(request.resource.data.familiaId));
      allow update, delete: if isAuthenticated() && 
                              (isSuperAdmin() || isAdminSistema() || belongsToFamilia(resource.data.familiaId));
    }
    
    // ============================================================
    // COLECCIÓN: familias
    // ============================================================
    match /familias/{familiaId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isAdminSistema() || belongsToFamilia(familiaId);
    }
    
    // ============================================================
    // COLECCIÓN: ramas
    // ============================================================
    match /ramas/{ramaId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isAdminSistema() || isAdminRama(ramaId);
    }
    
    // ============================================================
    // COLECCIÓN: nidos
    // ============================================================
    match /nidos/{nidoId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                     (isSuperAdmin() || isAdminSistema() || belongsToFamilia(resource.data.familiaId));
    }
    
    // ============================================================
    // COLECCIÓN: bienes (con todas sus subcolecciones)
    // ============================================================
    match /bienes/{bienId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                     (isSuperAdmin() || isAdminSistema() || belongsToFamilia(resource.data.familiaId));
      
      // Subcolecciones de bienes - acceso para usuarios autenticados de la familia
      match /{subcollection}/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // ============================================================
    // COLLECTION GROUP QUERIES para externos (caseros, hosters, guardas)
    // Permite consultas collectionGroup para login de externos
    // ============================================================
    match /{path=**}/caseros/{caseroId} {
      allow read: if isAuthenticated() && 
                    request.auth.token.email == resource.data.email;
    }
    
    match /{path=**}/hosters/{hosterId} {
      allow read: if isAuthenticated() && 
                    request.auth.token.email == resource.data.email;
    }
    
    match /{path=**}/guardas/{guardaId} {
      allow read: if isAuthenticated() && 
                    request.auth.token.email == resource.data.email;
    }
    
    // ============================================================
    // COLECCIÓN: invitaciones-email
    // ============================================================
    match /invitaciones-email/{invId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isSuperAdmin() || isAdminSistema();
    }
    
    // ============================================================
    // COLECCIÓN: config
    // ============================================================
    match /config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }
    
    // ============================================================
    // COLECCIÓN: eventos_uso (Análisis de comportamiento)
    // ============================================================
    // Solo escritura autenticada, lectura solo para admin-rama de su familia
    match /eventos_uso/{eventoId} {
      // Cualquier usuario autenticado puede crear eventos de tracking
      allow create: if isAuthenticated()
                    && request.resource.data.ramaId is string
                    && request.resource.data.accion is string
                    && request.resource.data.seccion is string;
      
      // Lectura solo para admin-rama de su propia familia (para dashboard Cerebro)
      allow read: if isAuthenticated() 
                  && isAnyAdminRama()
                  && resource.data.ramaId == getUserData().familiaId;
      
      // Nadie puede actualizar ni borrar (inmutabilidad de logs)
      allow update, delete: if false;
    }
    
    // ============================================================
    // COLECCIONES ADICIONALES (queos, notificaciones, etc.)
    // ============================================================
    match /queos/{queoId} {
      allow read: if isAuthenticated() && 
                    (request.auth.uid in resource.data.destinatarios || 
                     request.auth.uid == resource.data.remitente);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      (request.auth.uid in resource.data.destinatarios || 
                       request.auth.uid == resource.data.remitente);
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.remitente;
    }
    
    match /notificaciones/{notifId} {
      allow read: if isAuthenticated() && 
                    request.auth.uid in resource.data.destinatarios;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      request.auth.uid in resource.data.destinatarios;
      allow delete: if isSuperAdmin() || isAdminSistema();
    }
    
    match /convocatorias/{convId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.creadoPor;
    }
    
    match /citas/{citaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.creadoPor;
    }
    
    match /eventos/{eventoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.creadoPor;
    }
    
    match /tareas/{tareaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    match /mensajes/{mensajeId} {
      allow read: if isAuthenticated() && 
                    (request.auth.uid == resource.data.de || 
                     request.auth.uid == resource.data.para);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && request.auth.uid == resource.data.para;
      allow delete: if isAuthenticated() && 
                      (request.auth.uid == resource.data.de || 
                       request.auth.uid == resource.data.para);
    }
    
    match /anuncios/{anuncioId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.autor;
    }
    
    match /menus/{menuId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
  }
}
