rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // FUNCIONES AUXILIARES
    // ============================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             getUserData().superAdmin == true;
    }
    
    function isAdminSistema() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             getUserData().rol == 'AdminSistema';
    }
    
    function isAdminRama(ramaId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             getUserData().ramaId == ramaId &&
             getUserData().rol == 'AdminRama';
    }
    
    function isAnyAdminRama() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             (getUserData().rol == 'AdminRama' || 
              getUserData().rol == 'adminRama' || 
              getUserData().rol == 'admin-rama' ||
              getUserData().credencial == 'admin-rama');
    }
    
    function isPatriarcaOrMatriarca() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             (getUserData().rol == 'patriarca' || 
              getUserData().rol == 'matriarca');
    }
    
    function belongsToFamilia(familiaId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             getUserData().familiaId == familiaId;
    }
    
    function isAdminOfFamilia(familiaId) {
      return isAuthenticated() &&
             belongsToFamilia(familiaId) &&
             (isAnyAdminRama() || isPatriarcaOrMatriarca());
    }
    
    // ============================================================
    // COLECCIÓN: usuarios
    // ============================================================
    match /usuarios/{userId} {
      allow read: if isAuthenticated() && 
                    (request.auth.uid == userId || 
                     isSuperAdmin() || 
                     isAdminSistema() ||
                     (resource.data.familiaId != null && belongsToFamilia(resource.data.familiaId)));
      
      allow create: if isAuthenticated();
      
      allow update: if isAuthenticated() && 
                      (request.auth.uid == userId || 
                       isSuperAdmin() || 
                       isAdminSistema() ||
                       (resource.data.familiaId != null && isAdminOfFamilia(resource.data.familiaId)));
      
      allow delete: if isSuperAdmin();
    }
    
    // ============================================================
    // COLECCIÓN: externos
    // ============================================================
    match /externos/{externoId} {
      allow read: if isAuthenticated() && 
                    (isSuperAdmin() || 
                     isAdminSistema() || 
                     belongsToFamilia(resource.data.familiaId));
      allow create: if isAuthenticated() && 
                      (isSuperAdmin() || isAdminSistema() || belongsToFamilia(request.resource.data.familiaId));
      allow update, delete: if isAuthenticated() && 
                              (isSuperAdmin() || isAdminSistema() || belongsToFamilia(resource.data.familiaId));
    }
    
    // ============================================================
    // COLECCIÓN: familias (con subcolecciones)
    // ============================================================
    match /familias/{familiaId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isAdminSistema() || belongsToFamilia(familiaId);
      
      match /{subcollection}/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && 
                       (isSuperAdmin() || isAdminSistema() || belongsToFamilia(familiaId));
      }
    }
    
    // ============================================================
    // COLECCIÓN: ramas
    // ============================================================
    match /ramas/{ramaId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isAdminSistema() || isAdminRama(ramaId);
    }
    
    // ============================================================
    // COLECCIÓN: nidos
    // ============================================================
    match /nidos/{nidoId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                     (isSuperAdmin() || isAdminSistema() || belongsToFamilia(resource.data.familiaId));
      
      match /{subcollection}/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // ============================================================
    // COLECCIÓN: bienes (con subcolecciones)
    // ============================================================
    match /bienes/{bienId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                     (isSuperAdmin() || isAdminSistema() || belongsToFamilia(resource.data.familiaId));
      
      // Subcolecciones de primer nivel (caseros, hosters, guardas, reservas, etc.)
      match /{subcollection}/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
        
        // Subcolecciones de segundo nivel (gruposAjuar/{id}/articulos, etc.)
        match /{nestedCollection}/{nestedDocId} {
          allow read: if isAuthenticated();
          allow write: if isAuthenticated();
        }
      }
    }
    
    // ============================================================
    // COLLECTION GROUP QUERIES para externos
    // ============================================================
    match /{path=**}/caseros/{caseroId} {
      allow read: if isAuthenticated() && 
                    request.auth.token.email == resource.data.email;
    }
    
    match /{path=**}/hosters/{hosterId} {
      allow read: if isAuthenticated() && 
                    request.auth.token.email == resource.data.email;
    }
    
    match /{path=**}/guardas/{guardaId} {
      allow read: if isAuthenticated() && 
                    request.auth.token.email == resource.data.email;
    }
    
    // ============================================================
    // COLECCIÓN: invitaciones
    // ============================================================
    match /invitaciones/{invId} {
      allow read: if isAuthenticated() && 
                    (isSuperAdmin() || 
                     isAdminSistema() || 
                     belongsToFamilia(resource.data.familiaId));
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      (isSuperAdmin() || 
                       isAdminSistema() || 
                       belongsToFamilia(resource.data.familiaId));
      allow delete: if isAuthenticated() && 
                      (isSuperAdmin() || 
                       isAdminSistema() || 
                       belongsToFamilia(resource.data.familiaId));
    }
    
    // ============================================================
    // COLECCIÓN: invitaciones-email
    // ============================================================
    match /invitaciones-email/{invId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isSuperAdmin() || isAdminSistema();
    }
    
    // ============================================================
    // COLECCIÓN: config
    // ============================================================
    match /config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }
    
    // ============================================================
    // COLECCIÓN: eventos_uso
    // ============================================================
    match /eventos_uso/{eventoId} {
      allow create: if isAuthenticated()
                    && request.resource.data.ramaId is string
                    && request.resource.data.accion is string
                    && request.resource.data.seccion is string;
      
      allow read: if isAuthenticated() 
                  && isAnyAdminRama()
                  && resource.data.ramaId == getUserData().familiaId;
      
      allow update, delete: if false;
    }
    
    // ============================================================
    // COLECCIÓN: queos
    // ============================================================
    match /queos/{queoId} {
      allow read: if isAuthenticated() && 
                    (request.auth.uid in resource.data.destinatarios || 
                     request.auth.uid == resource.data.remitente);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      (request.auth.uid in resource.data.destinatarios || 
                       request.auth.uid == resource.data.remitente);
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.remitente;
    }
    
    // ============================================================
    // COLECCIÓN: notificaciones
    // ============================================================
    match /notificaciones/{notifId} {
      allow read: if isAuthenticated() && 
                    (request.auth.uid in resource.data.destinatarios ||
                     belongsToFamilia(resource.data.familiaId));
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                      (request.auth.uid in resource.data.destinatarios ||
                       belongsToFamilia(resource.data.familiaId));
      allow delete: if isSuperAdmin() || isAdminSistema();
    }
    
    // ============================================================
    // COLECCIÓN: solicitudes (reservas, eventos, iniciativas, averías)
    // ============================================================
    match /solicitudes/{solicitudId} {
      allow read: if isAuthenticated() && 
                    (request.auth.uid == resource.data.solicitadoPor ||
                     belongsToFamilia(resource.data.familiaId) ||
                     isSuperAdmin() || isAdminSistema());
      allow create: if isAuthenticated() && 
                      request.resource.data.solicitadoPor == request.auth.uid;
      allow update: if isAuthenticated() && 
                      (belongsToFamilia(resource.data.familiaId) ||
                       request.auth.uid == resource.data.solicitadoPor ||
                       isSuperAdmin() || isAdminSistema());
      allow delete: if isAuthenticated() && 
                      (request.auth.uid == resource.data.solicitadoPor ||
                       belongsToFamilia(resource.data.familiaId) ||
                       isSuperAdmin() || isAdminSistema());
    }
    
    // ============================================================
    // COLECCIONES ADICIONALES
    // ============================================================
    match /convocatorias/{convId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.creadoPor;
    }
    
    match /citas/{citaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.creadoPor;
    }
    
    match /eventos/{eventoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.creadoPor;
    }
    
    match /tareas/{tareaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    match /mensajes/{mensajeId} {
      allow read: if isAuthenticated() && 
                    (request.auth.uid == resource.data.de || 
                     request.auth.uid == resource.data.para);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && request.auth.uid == resource.data.para;
      allow delete: if isAuthenticated() && 
                      (request.auth.uid == resource.data.de || 
                       request.auth.uid == resource.data.para);
    }
    
    match /anuncios/{anuncioId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.autor;
    }
    
    match /menus/{menuId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
  }
}
