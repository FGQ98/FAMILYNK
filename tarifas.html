<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Tarifas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage:#7A9E7E; --cream:#FDF8F3; --cream-dark:#F5EDE4; --cream-medium:#FAF5EF;
      --text:#3D3D3D; --text-light:#6B6B6B; --text-muted:#9A9A9A; --white:#FFFFFF;
      --capataz:#6B8E23; --capataz-light:#8FBC3C; --capataz-dark:#4A6B10; --capataz-muted:rgba(107,142,35,0.15);
      --gerente:#2D4A5C; --gerente-light:#4A6B7C; --gerente-dark:#1D3544; --gerente-muted:rgba(45,74,92,0.15);
      --success:#7DB59A; --success-muted:rgba(125,181,154,0.15);
      --warning:#E8B44D; --warning-muted:rgba(232,180,77,0.15);
      --error:#D4695A; --error-muted:rgba(212,105,90,0.15);
      --info:#5B9BD5;
      --shadow-soft:0 2px 8px rgba(0,0,0,0.06); --shadow-medium:0 4px 16px rgba(0,0,0,0.08);
      --radius-sm:8px; --radius-md:12px; --radius-lg:16px; --radius-full:50px;
      --addon-color:var(--capataz); --addon-light:var(--capataz-light);
      --addon-dark:var(--capataz-dark); --addon-muted:var(--capataz-muted);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--text);min-height:100vh;}

    /* Header */
    .header{background:linear-gradient(135deg,var(--addon-color) 0%,var(--addon-dark) 100%);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow-medium);position:sticky;top:0;z-index:100;}
    .header-left{display:flex;align-items:center;gap:16px;}
    .back-btn{display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(255,255,255,0.15);border:none;border-radius:var(--radius-md);color:white;font-family:'Nunito';font-size:0.85rem;cursor:pointer;text-decoration:none;transition:all 0.2s;}
    .back-btn:hover{background:rgba(255,255,255,0.25);}
    .header-info h1{color:white;font-family:'Quicksand';font-size:1.2rem;font-weight:700;}
    .header-info p{color:rgba(255,255,255,0.7);font-size:0.8rem;}
    .header-actions{display:flex;gap:8px;}

    .main{max-width:960px;margin:0 auto;padding:24px;}

    /* Tabs */
    .tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--white);padding:4px;border-radius:var(--radius-full);box-shadow:var(--shadow-soft);overflow-x:auto;-webkit-overflow-scrolling:touch;}
    .tab{flex:1;padding:10px 12px;border:none;background:none;border-radius:var(--radius-full);font-family:'Nunito';font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s;color:var(--text-muted);white-space:nowrap;}
    .tab:hover{color:var(--text);}
    .tab.active{background:var(--addon-color);color:white;}
    .tab-content{display:none;}
    .tab-content.active{display:block;}

    /* Buttons */
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border-radius:var(--radius-md);font-family:'Nunito';font-size:0.85rem;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;text-decoration:none;}
    .btn-addon{background:var(--addon-color);color:white;}
    .btn-addon:hover{background:var(--addon-dark);}
    .btn-secondary{background:var(--cream);color:var(--text);}
    .btn-secondary:hover{background:var(--cream-dark);}
    .btn-danger{background:var(--error);color:white;}
    .btn-sm{padding:7px 12px;font-size:0.8rem;}
    .btn-ghost{background:none;color:var(--text-muted);padding:4px 8px;font-size:0.75rem;}
    .btn-ghost:hover{color:var(--text);background:var(--cream);}

    /* Cards */
    .card{background:var(--white);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;box-shadow:var(--shadow-soft);}
    .card-title{font-family:'Quicksand';font-weight:700;font-size:1rem;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}

    /* Servicios - Categor√≠as & Items */
    .cat-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--addon-muted);border-radius:var(--radius-md);margin-bottom:8px;cursor:pointer;transition:background 0.15s;}
    .cat-header:hover{filter:brightness(0.96);}
    .cat-name{font-family:'Quicksand';font-weight:700;font-size:0.95rem;display:flex;align-items:center;gap:8px;}
    .cat-actions{display:flex;gap:4px;}

    .srv-list{margin-bottom:16px;padding-left:8px;}
    .srv-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--cream-dark);transition:background 0.1s;}
    .srv-item:hover{background:var(--cream);}
    .srv-item:last-child{border-bottom:none;}
    .srv-info{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}
    .srv-icon{font-size:1.3rem;width:32px;text-align:center;flex-shrink:0;}
    .srv-name{font-weight:600;font-size:0.9rem;}
    .srv-desc{font-size:0.78rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .srv-unit{font-size:0.72rem;color:var(--text-light);background:var(--cream-dark);padding:2px 8px;border-radius:var(--radius-full);white-space:nowrap;}
    .srv-actions{display:flex;gap:2px;margin-left:8px;}

    .add-row{padding:10px 14px;text-align:center;}

    /* Precios - Tabla din√°mica */
    .precio-scroll{overflow-x:auto;border-radius:var(--radius-md);box-shadow:var(--shadow-soft);}
    .tabla-precios{width:100%;border-collapse:collapse;min-width:500px;background:var(--white);}
    .tabla-precios th{padding:10px 12px;font-size:0.72rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);background:var(--cream-medium);border-bottom:2px solid var(--cream-dark);text-align:center;white-space:nowrap;}
    .tabla-precios th:first-child{text-align:left;min-width:200px;position:sticky;left:0;background:var(--cream-medium);z-index:2;}
    .tabla-precios td{padding:8px 12px;border-bottom:1px solid var(--cream-dark);text-align:center;font-variant-numeric:tabular-nums;}
    .tabla-precios td:first-child{text-align:left;position:sticky;left:0;background:var(--white);z-index:1;font-weight:600;font-size:0.85rem;}
    .tabla-precios tr:hover td{background:var(--cream);}
    .tabla-precios tr:hover td:first-child{background:var(--cream);}

    .precio-input{width:80px;padding:6px 8px;border:1px solid var(--cream-dark);border-radius:var(--radius-sm);text-align:right;font-family:'Nunito';font-size:0.85rem;font-weight:600;background:transparent;transition:border-color 0.2s;}
    .precio-input:focus{outline:none;border-color:var(--addon-color);background:var(--white);}
    .precio-input:hover{border-color:var(--addon-light);}

    .col-header{position:relative;}
    .col-header-text{cursor:pointer;}
    .col-header-text:hover{color:var(--addon-color);}
    .col-del{position:absolute;top:2px;right:2px;font-size:0.6rem;cursor:pointer;opacity:0.3;background:none;border:none;color:var(--error);}
    .col-del:hover{opacity:1;}

    .cat-separator td{background:var(--addon-muted);font-family:'Quicksand';font-weight:700;font-size:0.82rem;padding:8px 12px !important;}

    /* Ofertas */
    .oferta-card{background:var(--white);border-radius:var(--radius-md);padding:16px;margin-bottom:12px;border:2px solid var(--cream-dark);transition:border-color 0.2s;}
    .oferta-card.activa{border-color:var(--success);}
    .oferta-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .oferta-nombre{font-family:'Quicksand';font-weight:700;font-size:0.95rem;}
    .oferta-badge{font-size:0.7rem;padding:3px 10px;border-radius:var(--radius-full);font-weight:600;}
    .oferta-badge.activa{background:var(--success-muted);color:var(--success);}
    .oferta-badge.inactiva{background:var(--cream-dark);color:var(--text-muted);}
    .oferta-detalle{font-size:0.83rem;color:var(--text-light);line-height:1.5;}
    .oferta-valor{font-family:'Quicksand';font-weight:700;font-size:1.1rem;color:var(--addon-color);margin-top:6px;}
    .oferta-interno{display:flex;align-items:center;gap:6px;margin-top:8px;font-size:0.7rem;color:var(--text-muted);background:var(--cream);padding:6px 10px;border-radius:var(--radius-sm);}

    /* Propuestas */
    .prop-card{background:var(--white);border-radius:var(--radius-md);padding:16px;margin-bottom:12px;border:2px solid var(--cream-dark);cursor:pointer;transition:all 0.2s;}
    .prop-card:hover{border-color:var(--addon-color);box-shadow:var(--shadow-soft);}
    .prop-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;}
    .prop-cliente{font-family:'Quicksand';font-weight:700;font-size:0.95rem;}
    .prop-fechas{font-size:0.78rem;color:var(--text-muted);}
    .prop-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:8px;}
    .prop-total{font-family:'Quicksand';font-weight:700;font-size:1.1rem;color:var(--addon-color);}
    .prop-estado{font-size:0.7rem;padding:3px 10px;border-radius:var(--radius-full);font-weight:600;}
    .prop-estado.borrador{background:var(--cream-dark);color:var(--text-muted);}
    .prop-estado.enviada{background:var(--warning-muted);color:#B8860B;}
    .prop-estado.aceptada{background:var(--success-muted);color:var(--success);}
    .prop-estado.rechazada{background:var(--error-muted);color:var(--error);}
    .prop-lineas-info{font-size:0.78rem;color:var(--text-muted);}

    /* L√≠neas propuesta/factura */
    .lineas-table{width:100%;border-collapse:collapse;font-size:0.82rem;margin-top:8px;}
    .lineas-table th{text-align:left;padding:6px 8px;font-size:0.7rem;text-transform:uppercase;color:var(--text-muted);border-bottom:2px solid var(--cream-dark);}
    .lineas-table th:nth-child(n+2){text-align:right;}
    .lineas-table td{padding:6px 8px;border-bottom:1px solid var(--cream-dark);}
    .lineas-table td:nth-child(n+2){text-align:right;}
    .lineas-table input,.lineas-table select{font-size:0.82rem;padding:4px 6px;border:1px solid var(--cream-dark);border-radius:6px;width:100%;font-family:'Nunito';}
    .lineas-table input[type=number]{width:70px;text-align:right;}
    .linea-del{background:none;border:none;color:var(--error);cursor:pointer;font-size:0.9rem;opacity:0.5;}
    .linea-del:hover{opacity:1;}
    .linea-total{font-weight:700;font-family:'Quicksand';}

    /* Facturas */
    .fact-card{background:var(--white);border-radius:var(--radius-md);padding:16px;margin-bottom:12px;border:2px solid var(--cream-dark);cursor:pointer;transition:all 0.2s;}
    .fact-card:hover{border-color:var(--addon-color);box-shadow:var(--shadow-soft);}
    .fact-numero{font-family:'Quicksand';font-weight:700;font-size:0.95rem;}
    .fact-estado{font-size:0.7rem;padding:3px 10px;border-radius:var(--radius-full);font-weight:600;}
    .fact-estado.pendiente{background:var(--warning-muted);color:#B8860B;}
    .fact-estado.pagada{background:var(--success-muted);color:var(--success);}
    .fact-estado.anulada{background:var(--error-muted);color:var(--error);}

    /* Modales */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;align-items:center;justify-content:center;padding:20px;}
    .modal-overlay.active{display:flex;}
    .modal{background:var(--white);border-radius:var(--radius-lg);width:100%;max-width:480px;overflow:hidden;box-shadow:var(--shadow-medium);}
    .modal.modal-wide{max-width:720px;}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:var(--cream-medium);}
    .modal-title{font-family:'Quicksand';font-size:1rem;font-weight:700;}
    .modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--text-muted);padding:0 4px;}
    .modal-body{padding:20px;max-height:60vh;overflow-y:auto;}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:16px 20px;border-top:1px solid var(--cream-dark);}
    .form-group{margin-bottom:14px;}
    .form-label{display:block;font-size:0.8rem;font-weight:600;margin-bottom:4px;}
    .form-input,.form-select,.form-textarea{width:100%;padding:10px 12px;border:2px solid var(--cream-dark);border-radius:var(--radius-sm);font-family:'Nunito';font-size:0.9rem;background:var(--white);}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--addon-color);}
    .form-textarea{resize:vertical;min-height:60px;}
    .form-hint{font-size:0.72rem;color:var(--text-muted);margin-top:3px;}
    .form-row{display:flex;gap:12px;}

    /* Empty & Loading */
    .empty-state{text-align:center;padding:40px 20px;}
    .empty-state-icon{font-size:3rem;opacity:0.3;margin-bottom:12px;}
    .empty-state-title{font-family:'Quicksand';font-weight:700;margin-bottom:8px;}
    .empty-state-text{color:var(--text-muted);font-size:0.9rem;}
    .loading{display:flex;align-items:center;justify-content:center;min-height:200px;}
    .spinner{width:40px;height:40px;border:3px solid var(--cream-dark);border-top-color:var(--addon-color);border-radius:50%;animation:spin 0.8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}

    @media(max-width:600px){
      .form-row{flex-direction:column;gap:0;}
      .tabla-precios{font-size:0.8rem;}
      .precio-input{width:65px;font-size:0.8rem;}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a id="btn-volver" class="back-btn">‚Üê Volver</a>
      <div class="header-info">
        <h1>üí∂ Tarifas</h1>
        <p id="nombre-bien">Cargando...</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-sm" style="background:rgba(255,255,255,0.15);color:white;" onclick="exportarPDF()">üìÑ PDF</button>
    </div>
  </header>

  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>
    <div id="contenido" style="display:none;">

      <div class="tabs">
        <button class="tab active" onclick="cambiarTab('servicios')">üè∑Ô∏è Servicios</button>
        <button class="tab" onclick="cambiarTab('precios')">üí∂ Precios</button>
        <button class="tab" onclick="cambiarTab('ofertas')">üéÅ Ofertas</button>
        <button class="tab" onclick="cambiarTab('propuestas')">üìÑ Propuestas</button>
        <button class="tab" onclick="cambiarTab('facturas')">üßæ Facturas</button>
      </div>

      <!-- ============ TAB SERVICIOS ============ -->
      <div class="tab-content active" id="tab-servicios">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <span style="font-size:0.83rem;color:var(--text-muted);">Organiza tus servicios por categor√≠as</span>
          <button class="btn btn-addon btn-sm" onclick="abrirModalCat()">+ Categor√≠a</button>
        </div>
        <div id="srv-container"></div>
        <div id="srv-vacio" style="display:none;">
          <div class="empty-state">
            <div class="empty-state-icon">üè∑Ô∏è</div>
            <div class="empty-state-title">Sin servicios</div>
            <div class="empty-state-text">Crea una categor√≠a y empieza a a√±adir servicios</div>
          </div>
        </div>
      </div>

      <!-- ============ TAB PRECIOS ============ -->
      <div class="tab-content" id="tab-precios">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <span style="font-size:0.83rem;color:var(--text-muted);">Define columnas (temporadas, tipos...) y asigna precios</span>
          <button class="btn btn-addon btn-sm" onclick="abrirModalCol()">+ Columna</button>
        </div>
        <div class="precio-scroll">
          <table class="tabla-precios" id="tabla-precios">
            <thead><tr id="precios-thead"></tr></thead>
            <tbody id="precios-tbody"></tbody>
          </table>
        </div>
        <div id="precios-vacio" style="display:none;">
          <div class="empty-state">
            <div class="empty-state-icon">üí∂</div>
            <div class="empty-state-title">Sin precios</div>
            <div class="empty-state-text">A√±ade servicios y columnas para crear tu tabla de precios</div>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;" id="precios-actions" class="hidden">
          <button class="btn btn-addon btn-sm" onclick="guardarPrecios()">üíæ Guardar precios</button>
        </div>
      </div>

      <!-- ============ TAB OFERTAS ============ -->
      <div class="tab-content" id="tab-ofertas">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <span style="font-size:0.83rem;color:var(--text-muted);">Descuentos y paquetes ‚Äî solo uso interno</span>
          <button class="btn btn-addon btn-sm" onclick="abrirModalOferta()">+ Oferta</button>
        </div>
        <div id="ofertas-container"></div>
        <div id="ofertas-vacio" style="display:none;">
          <div class="empty-state">
            <div class="empty-state-icon">üéÅ</div>
            <div class="empty-state-title">Sin ofertas</div>
            <div class="empty-state-text">Crea descuentos, paquetes o condiciones especiales</div>
          </div>
        </div>
      </div>

      <!-- ============ TAB PROPUESTAS ============ -->
      <div class="tab-content" id="tab-propuestas">
        <div class="card-title" style="padding:0 0 12px;">
          üìÑ Propuestas comerciales <span style="flex:1"></span>
          <button class="btn btn-addon btn-sm" onclick="abrirModalPropuesta()">+ Propuesta</button>
        </div>
        <div id="propuestas-container"></div>
        <div id="propuestas-vacio" style="display:none;">
          <div class="empty-state">
            <div class="empty-state-icon">üìÑ</div>
            <div class="empty-state-title">Sin propuestas</div>
            <div class="empty-state-text">Crea ofertas personalizadas para tus clientes</div>
          </div>
        </div>
      </div>

      <!-- ============ TAB FACTURAS ============ -->
      <div class="tab-content" id="tab-facturas">
        <div class="card-title" style="padding:0 0 12px;">
          üßæ Facturas <span style="flex:1"></span>
          <button class="btn btn-addon btn-sm" onclick="abrirModalFactura()">+ Factura</button>
        </div>
        <div id="facturas-container"></div>
        <div id="facturas-vacio" style="display:none;">
          <div class="empty-state">
            <div class="empty-state-icon">üßæ</div>
            <div class="empty-state-title">Sin facturas</div>
            <div class="empty-state-text">Genera facturas a partir de propuestas o cr√©alas directamente</div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Datalist para autocompletar servicios en propuestas/facturas -->
  <datalist id="srv-list"></datalist>

  <!-- ===== MODAL CATEGOR√çA ===== -->
  <div class="modal-overlay" id="modal-cat">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="modal-cat-title">üìÅ Nueva categor√≠a</h3><button class="modal-close" onclick="cerrarModal('modal-cat')">√ó</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="cat-nombre" placeholder="Ej: Alojamiento, Aceite, Actividades..."></div>
        <div class="form-group"><label class="form-label">Icono</label><input type="text" class="form-input" id="cat-icono" placeholder="üè†" style="width:80px;text-align:center;font-size:1.3rem;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-cat')">Cancelar</button>
        <button class="btn btn-danger btn-sm" id="btn-del-cat" onclick="eliminarCat()" style="display:none;">Eliminar</button>
        <button class="btn btn-addon" onclick="guardarCat()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL SERVICIO ===== -->
  <div class="modal-overlay" id="modal-srv">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="modal-srv-title">üè∑Ô∏è Nuevo servicio</h3><button class="modal-close" onclick="cerrarModal('modal-srv')">√ó</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Categor√≠a</label><select class="form-select" id="srv-cat" disabled></select></div>
        <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="srv-nombre" placeholder="Ej: Suite Principal, Aceite virgen extra..."></div>
        <div class="form-group"><label class="form-label">Descripci√≥n</label><input type="text" class="form-input" id="srv-desc" placeholder="Breve descripci√≥n"></div>
        <div class="form-row">
          <div class="form-group" style="flex:0 0 80px;"><label class="form-label">Icono</label><input type="text" class="form-input" id="srv-icono" placeholder="üõèÔ∏è" style="text-align:center;font-size:1.3rem;"></div>
          <div class="form-group" style="flex:1;"><label class="form-label">Unidad *</label>
            <select class="form-select" id="srv-unidad">
              <option value="noche">/ noche</option><option value="persona">/ persona</option>
              <option value="persona/noche">/ persona¬∑noche</option><option value="d√≠a">/ d√≠a</option>
              <option value="trayecto">/ trayecto</option><option value="kg">/ kg</option>
              <option value="litro">/ litro</option><option value="unidad">/ unidad</option>
              <option value="sesi√≥n">/ sesi√≥n</option><option value="hora">/ hora</option>
              <option value="servicio">/ servicio</option><option value="pack">/ pack</option>
            </select>
          </div>
          <div class="form-group" style="flex:0 0 110px;"><label class="form-label">IVA aplicable</label>
            <select class="form-select" id="srv-iva">
              <option value="">‚Äî Sin IVA ‚Äî</option>
              <option value="0">Exento (0%)</option>
              <option value="4">Superreducido (4%)</option>
              <option value="10">Reducido (10%)</option>
              <option value="21">General (21%)</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-srv')">Cancelar</button>
        <button class="btn btn-danger btn-sm" id="btn-del-srv" onclick="eliminarSrv()" style="display:none;">Eliminar</button>
        <button class="btn btn-addon" onclick="guardarSrv()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL COLUMNA ===== -->
  <div class="modal-overlay" id="modal-col">
    <div class="modal" style="max-width:380px;">
      <div class="modal-header"><h3 class="modal-title">üìä Nueva columna de precio</h3><button class="modal-close" onclick="cerrarModal('modal-col')">√ó</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="col-nombre" placeholder="Ej: Temporada Alta, PVP, Familia..."></div>
        <div class="form-hint">Define columnas para tus diferentes tarifas: temporadas, tipos de cliente, canales...</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-col')">Cancelar</button>
        <button class="btn btn-addon" onclick="guardarCol()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL OFERTA ===== -->
  <div class="modal-overlay" id="modal-oferta">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="modal-oferta-title">üéÅ Nueva oferta</h3><button class="modal-close" onclick="cerrarModal('modal-oferta')">√ó</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="oferta-nombre" placeholder="Ej: Descuento familia, Pack fin de semana..."></div>
        <div class="form-row">
          <div class="form-group" style="flex:1;">
            <label class="form-label">Tipo</label>
            <select class="form-select" id="oferta-tipo">
              <option value="porcentaje">% Descuento</option>
              <option value="fijo">‚Ç¨ Importe fijo</option>
              <option value="pack">Pack / Paquete</option>
              <option value="gratis">Gratuidad</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;">
            <label class="form-label">Valor</label>
            <input type="text" class="form-input" id="oferta-valor" placeholder="Ej: 15%, 50‚Ç¨, 2x1...">
          </div>
        </div>
        <div class="form-group"><label class="form-label">Condiciones / Descripci√≥n</label><textarea class="form-textarea" id="oferta-condiciones" placeholder="Ej: Aplicable a estancias de 3+ noches. Solo familiares directos."></textarea></div>
        <div class="form-group">
          <label class="form-label">Estado</label>
          <select class="form-select" id="oferta-activa">
            <option value="true">‚úÖ Activa</option>
            <option value="false">‚è∏Ô∏è Inactiva</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-oferta')">Cancelar</button>
        <button class="btn btn-danger btn-sm" id="btn-del-oferta" onclick="eliminarOferta()" style="display:none;">Eliminar</button>
        <button class="btn btn-addon" onclick="guardarOferta()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL PROPUESTA ===== -->
  <div class="modal-overlay" id="modal-propuesta">
    <div class="modal modal-wide">
      <div class="modal-header"><h3 class="modal-title" id="modal-propuesta-title">üìÑ Nueva propuesta</h3><button class="modal-close" onclick="cerrarModal('modal-propuesta')">√ó</button></div>
      <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
        <div class="form-row">
          <div class="form-group" style="flex:1;"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="prop-cliente" placeholder="Nombre del cliente"></div>
          <div class="form-group" style="flex:1;"><label class="form-label">Contacto</label><input type="text" class="form-input" id="prop-contacto" placeholder="Persona de contacto"></div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:1;"><label class="form-label">Tel√©fono</label><input type="tel" class="form-input" id="prop-tel" placeholder="+34 600 000 000"></div>
          <div class="form-group" style="flex:1;"><label class="form-label">Email</label><input type="email" class="form-input" id="prop-email" placeholder="email@cliente.com"></div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:1;"><label class="form-label">Fecha inicio</label><input type="date" class="form-input" id="prop-inicio"></div>
          <div class="form-group" style="flex:1;"><label class="form-label">Fecha fin</label><input type="date" class="form-input" id="prop-fin"></div>
          <div class="form-group" style="flex:0 0 140px;">
            <label class="form-label">Estado</label>
            <select class="form-select" id="prop-estado">
              <option value="borrador">üìù Borrador</option>
              <option value="enviada">üì§ Enviada</option>
              <option value="aceptada">‚úÖ Aceptada</option>
              <option value="rechazada">‚ùå Rechazada</option>
            </select>
          </div>
        </div>
        <hr style="border:none;border-top:1px solid var(--cream-dark);margin:16px 0 12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label class="form-label" style="margin:0;font-weight:700;">Partidas</label>
          <button class="btn btn-sm btn-secondary" onclick="addLineaProp()">+ L√≠nea</button>
        </div>
        <div style="overflow-x:auto;">
          <table class="lineas-table" id="prop-lineas-table">
            <thead><tr>
              <th style="min-width:160px;">Concepto</th><th>Uds</th><th>D√≠as</th><th>Precio</th><th>Dto%</th><th>IVA%</th><th>Total</th><th></th>
            </tr></thead>
            <tbody id="prop-lineas-body"></tbody>
            <tfoot>
              <tr><td colspan="5"></td><td style="text-align:right;font-size:0.75rem;color:var(--text-muted);">Base:</td><td class="linea-total" id="prop-subtotal">0,00 ‚Ç¨</td><td></td></tr>
              <tr><td colspan="5"></td><td style="text-align:right;font-size:0.75rem;color:var(--text-muted);">IVA:</td><td class="linea-total" id="prop-totaliva">0,00 ‚Ç¨</td><td></td></tr>
              <tr><td colspan="5"></td><td style="text-align:right;font-weight:700;">TOTAL:</td><td class="linea-total" style="font-size:1rem;color:var(--addon-color);" id="prop-total">0,00 ‚Ç¨</td><td></td></tr>
            </tfoot>
          </table>
        </div>
        <div class="form-group" style="margin-top:12px;"><label class="form-label">Notas</label><textarea class="form-textarea" id="prop-notas" rows="2" placeholder="Condiciones, observaciones..."></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-propuesta')">Cancelar</button>
        <button class="btn btn-danger btn-sm" id="btn-del-prop" onclick="eliminarPropuesta()" style="display:none;">Eliminar</button>
        <button class="btn btn-addon" onclick="guardarPropuesta()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL FACTURA ===== -->
  <div class="modal-overlay" id="modal-factura">
    <div class="modal modal-wide">
      <div class="modal-header"><h3 class="modal-title" id="modal-factura-title">üßæ Nueva factura</h3><button class="modal-close" onclick="cerrarModal('modal-factura')">√ó</button></div>
      <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
        <div class="form-row">
          <div class="form-group" style="flex:0 0 140px;"><label class="form-label">N¬∫ Factura *</label><input type="text" class="form-input" id="fact-numero" placeholder="F-2026/001"></div>
          <div class="form-group" style="flex:1;"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="fact-cliente" placeholder="Nombre del cliente"></div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:1;"><label class="form-label">Fecha emisi√≥n</label><input type="date" class="form-input" id="fact-fecha"></div>
          <div class="form-group" style="flex:1;"><label class="form-label">Fecha vencimiento</label><input type="date" class="form-input" id="fact-vence"></div>
          <div class="form-group" style="flex:0 0 140px;">
            <label class="form-label">Estado</label>
            <select class="form-select" id="fact-estado">
              <option value="pendiente">‚è≥ Pendiente</option>
              <option value="pagada">‚úÖ Pagada</option>
              <option value="anulada">‚ùå Anulada</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Importar de propuesta</label>
          <select class="form-select" id="fact-de-prop" onchange="importarDePropuesta()">
            <option value="">‚Äî Manual (sin propuesta) ‚Äî</option>
          </select>
        </div>
        <hr style="border:none;border-top:1px solid var(--cream-dark);margin:16px 0 12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label class="form-label" style="margin:0;font-weight:700;">Partidas</label>
          <button class="btn btn-sm btn-secondary" onclick="addLineaFact()">+ L√≠nea</button>
        </div>
        <div style="overflow-x:auto;">
          <table class="lineas-table" id="fact-lineas-table">
            <thead><tr>
              <th style="min-width:160px;">Concepto</th><th>Uds</th><th>D√≠as</th><th>Precio</th><th>Dto%</th><th>IVA%</th><th>Total</th><th></th>
            </tr></thead>
            <tbody id="fact-lineas-body"></tbody>
            <tfoot>
              <tr><td colspan="5"></td><td style="text-align:right;font-size:0.75rem;color:var(--text-muted);">Base:</td><td class="linea-total" id="fact-subtotal">0,00 ‚Ç¨</td><td></td></tr>
              <tr><td colspan="5"></td><td style="text-align:right;font-size:0.75rem;color:var(--text-muted);">IVA:</td><td class="linea-total" id="fact-totaliva">0,00 ‚Ç¨</td><td></td></tr>
              <tr><td colspan="5"></td><td style="text-align:right;font-weight:700;">TOTAL:</td><td class="linea-total" style="font-size:1rem;color:var(--addon-color);" id="fact-total">0,00 ‚Ç¨</td><td></td></tr>
            </tfoot>
          </table>
        </div>
        <div class="form-group" style="margin-top:12px;"><label class="form-label">Notas</label><textarea class="form-textarea" id="fact-notas" rows="2" placeholder="Observaciones..."></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-factura')">Cancelar</button>
        <button class="btn btn-danger btn-sm" id="btn-del-fact" onclick="eliminarFactura()" style="display:none;">Eliminar</button>
        <button class="btn btn-addon" onclick="guardarFactura()">Guardar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ===== CONFIG =====
    const params = new URLSearchParams(window.location.search);
    const bienId = params.get('id');
    const origen = params.get('origen') || 'gerente';

    if (origen === 'gerente') {
      document.documentElement.style.setProperty('--addon-color','var(--gerente)');
      document.documentElement.style.setProperty('--addon-light','var(--gerente-light)');
      document.documentElement.style.setProperty('--addon-dark','var(--gerente-dark)');
      document.documentElement.style.setProperty('--addon-muted','var(--gerente-muted)');
    }

    if (!bienId) { alert('Falta bien'); window.location.href = 'lo-comun.html'; }
    document.getElementById('btn-volver').href = `${origen}.html?id=${bienId}`;

    let currentUser = null, bienData = null;
    let categorias = [], servicios = [], columnas = [], precios = {}, ofertas = [];
    let propuestas = [], facturas = [];
    let editCatId = null, editSrvId = null, editOfertaId = null;
    let editPropId = null, propLineas = [];
    let editFactId = null, factLineas = [];

    auth.onAuthStateChanged(async user => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarDatos();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('contenido').style.display = '';
    });

    // ===== DATA =====
    async function cargarDatos() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (!doc.exists) { alert('Bien no encontrado'); return; }
        bienData = doc.data();
        document.getElementById('nombre-bien').textContent = bienData.nombre || '';
        categorias = bienData.tarifasCategorias || [];
        servicios = bienData.tarifasServicios || [];
        columnas = bienData.tarifasColumnas || [];
        precios = bienData.tarifasPrecios || {};
        ofertas = bienData.tarifasOfertas || [];
        propuestas = bienData.tarifasPropuestas || [];
        facturas = bienData.tarifasFacturas || [];
        renderServicios();
        renderPrecios();
        renderOfertas();
        renderPropuestas();
        renderFacturas();
      } catch(e) { console.error(e); alert('Error: ' + e.message); }
    }

    async function guardarTarifas() {
      try {
        await db.collection('bienes').doc(bienId).update({
          tarifasCategorias: categorias,
          tarifasServicios: servicios,
          tarifasColumnas: columnas,
          tarifasPrecios: precios,
          tarifasOfertas: ofertas,
          tarifasPropuestas: propuestas,
          tarifasFacturas: facturas
        });
      } catch(e) { console.error(e); alert('Error al guardar'); }
    }

    // ===== TABS =====
    function cambiarTab(t) {
      const tabs = ['servicios','precios','ofertas','propuestas','facturas'];
      document.querySelectorAll('.tab').forEach((b,i) => b.classList.toggle('active', tabs[i] === t));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('tab-' + t).classList.add('active');
      if (t === 'precios') renderPrecios();
    }

    // ===== TAB SERVICIOS =====
    function renderServicios() {
      const c = document.getElementById('srv-container');
      const v = document.getElementById('srv-vacio');
      if (!categorias.length) { c.innerHTML = ''; v.style.display = ''; return; }
      v.style.display = 'none';
      let html = '';
      categorias.sort((a,b) => (a.orden||0) - (b.orden||0)).forEach(cat => {
        const items = servicios.filter(s => s.categoriaId === cat.id);
        html += `<div class="cat-header" onclick="toggleCat('${cat.id}')">
          <div class="cat-name">${cat.icono||'üìÅ'} ${cat.nombre} <span style="font-size:0.75rem;color:var(--text-muted);font-weight:400;">(${items.length})</span></div>
          <div class="cat-actions">
            <button class="btn-ghost" onclick="event.stopPropagation();editarCat('${cat.id}')">‚úèÔ∏è</button>
            <button class="btn-ghost" onclick="event.stopPropagation();abrirModalSrv('${cat.id}')">+ servicio</button>
          </div>
        </div>`;
        html += `<div class="srv-list" id="cat-items-${cat.id}">`;
        if (!items.length) {
          html += '<div class="add-row"><button class="btn btn-sm btn-secondary" onclick="abrirModalSrv(\'' + cat.id + '\')">+ A√±adir primer servicio</button></div>';
        } else {
          items.forEach(s => {
            html += `<div class="srv-item">
              <div class="srv-info">
                <div class="srv-icon">${s.icono||'‚Ä¢'}</div>
                <div style="min-width:0;">
                  <div class="srv-name">${s.nombre}</div>
                  ${s.descripcion ? `<div class="srv-desc">${s.descripcion}</div>` : ''}
                </div>
              </div>
              <span class="srv-unit">/${s.unidad||'unidad'}${s.iva ? ` ¬∑ ${s.iva}% IVA` : ''}</span>
              <div class="srv-actions">
                <button class="btn-ghost" onclick="editarSrv('${s.id}')">‚úèÔ∏è</button>
              </div>
            </div>`;
          });
        }
        html += '</div>';
      });
      c.innerHTML = html;
      // Actualizar datalist para propuestas/facturas
      const dl = document.getElementById('srv-list');
      if (dl) dl.innerHTML = servicios.map(s => `<option value="${s.nombre}">`).join('');
    }

    function toggleCat(catId) {
      const el = document.getElementById('cat-items-' + catId);
      if (el) el.style.display = el.style.display === 'none' ? '' : 'none';
    }

    // Categor√≠a CRUD
    function abrirModalCat(data) {
      editCatId = data ? data.id : null;
      document.getElementById('modal-cat-title').textContent = data ? '‚úèÔ∏è Editar categor√≠a' : 'üìÅ Nueva categor√≠a';
      document.getElementById('btn-del-cat').style.display = data ? '' : 'none';
      document.getElementById('cat-nombre').value = data?.nombre || '';
      document.getElementById('cat-icono').value = data?.icono || '';
      document.getElementById('modal-cat').classList.add('active');
    }

    function editarCat(id) { abrirModalCat(categorias.find(c => c.id === id)); }

    async function guardarCat() {
      const nombre = document.getElementById('cat-nombre').value.trim();
      if (!nombre) { alert('Nombre obligatorio'); return; }
      const icono = document.getElementById('cat-icono').value.trim() || 'üìÅ';
      if (editCatId) {
        const idx = categorias.findIndex(c => c.id === editCatId);
        if (idx >= 0) Object.assign(categorias[idx], { nombre, icono });
      } else {
        categorias.push({ id: 'cat_' + Date.now(), nombre, icono, orden: categorias.length });
      }
      await guardarTarifas();
      cerrarModal('modal-cat');
      renderServicios();
    }

    async function eliminarCat() {
      if (!editCatId) return;
      const items = servicios.filter(s => s.categoriaId === editCatId);
      if (items.length && !confirm(`Tiene ${items.length} servicios. ¬øEliminar categor√≠a y todos sus servicios?`)) return;
      servicios = servicios.filter(s => s.categoriaId !== editCatId);
      // Limpiar precios hu√©rfanos
      items.forEach(s => { columnas.forEach(col => { delete precios[s.id + '_' + col.id]; }); });
      categorias = categorias.filter(c => c.id !== editCatId);
      await guardarTarifas();
      cerrarModal('modal-cat');
      renderServicios();
    }

    // Servicio CRUD
    function abrirModalSrv(catId, data) {
      editSrvId = data ? data.id : null;
      document.getElementById('modal-srv-title').textContent = data ? '‚úèÔ∏è Editar servicio' : 'üè∑Ô∏è Nuevo servicio';
      document.getElementById('btn-del-srv').style.display = data ? '' : 'none';
      const sel = document.getElementById('srv-cat');
      sel.innerHTML = categorias.map(c => `<option value="${c.id}">${c.icono||''} ${c.nombre}</option>`).join('');
      sel.value = data?.categoriaId || catId;
      sel.disabled = !data; // al editar permite mover de categor√≠a
      if (data) sel.disabled = false;
      document.getElementById('srv-nombre').value = data?.nombre || '';
      document.getElementById('srv-desc').value = data?.descripcion || '';
      document.getElementById('srv-icono').value = data?.icono || '';
      document.getElementById('srv-unidad').value = data?.unidad || 'noche';
      document.getElementById('srv-iva').value = data?.iva ?? '';
      document.getElementById('modal-srv').classList.add('active');
    }

    function editarSrv(id) { const s = servicios.find(x => x.id === id); if (s) abrirModalSrv(s.categoriaId, s); }

    async function guardarSrv() {
      const nombre = document.getElementById('srv-nombre').value.trim();
      if (!nombre) { alert('Nombre obligatorio'); return; }
      const catId = document.getElementById('srv-cat').value;
      const data = {
        nombre,
        categoriaId: catId,
        descripcion: document.getElementById('srv-desc').value.trim(),
        icono: document.getElementById('srv-icono').value.trim() || '‚Ä¢',
        unidad: document.getElementById('srv-unidad').value,
        iva: document.getElementById('srv-iva').value
      };
      if (editSrvId) {
        const idx = servicios.findIndex(s => s.id === editSrvId);
        if (idx >= 0) Object.assign(servicios[idx], data);
      } else {
        servicios.push({ id: 'srv_' + Date.now(), ...data });
      }
      await guardarTarifas();
      cerrarModal('modal-srv');
      renderServicios();
    }

    async function eliminarSrv() {
      if (!editSrvId || !confirm('¬øEliminar servicio?')) return;
      columnas.forEach(col => { delete precios[editSrvId + '_' + col.id]; });
      servicios = servicios.filter(s => s.id !== editSrvId);
      await guardarTarifas();
      cerrarModal('modal-srv');
      renderServicios();
    }

    // ===== TAB PRECIOS =====
    function renderPrecios() {
      const allSrv = servicios.length;
      const allCol = columnas.length;
      const vacio = document.getElementById('precios-vacio');
      const actions = document.getElementById('precios-actions');
      const table = document.querySelector('.precio-scroll');

      if (!allSrv || !allCol) {
        vacio.style.display = '';
        table.style.display = 'none';
        actions.style.display = 'none';
        return;
      }
      vacio.style.display = 'none';
      table.style.display = '';
      actions.style.display = 'flex';

      // Thead
      let th = '<th>Servicio</th>';
      columnas.sort((a,b) => (a.orden||0) - (b.orden||0)).forEach(col => {
        th += `<th class="col-header"><span class="col-header-text" onclick="editarCol('${col.id}')">${col.nombre}</span><button class="col-del" onclick="eliminarCol('${col.id}')" title="Eliminar">‚úï</button></th>`;
      });
      document.getElementById('precios-thead').innerHTML = th;

      // Tbody por categor√≠as
      let html = '';
      categorias.sort((a,b) => (a.orden||0) - (b.orden||0)).forEach(cat => {
        const items = servicios.filter(s => s.categoriaId === cat.id);
        if (!items.length) return;
        html += `<tr class="cat-separator"><td colspan="${columnas.length + 1}">${cat.icono||'üìÅ'} ${cat.nombre}</td></tr>`;
        items.forEach(s => {
          html += `<tr><td>${s.icono||'‚Ä¢'} ${s.nombre} <span style="color:var(--text-muted);font-size:0.7rem;">/${s.unidad}${s.iva ? ` ¬∑ ${s.iva}%` : ''}</span></td>`;
          columnas.forEach(col => {
            const key = s.id + '_' + col.id;
            const val = precios[key] ?? '';
            html += `<td><input class="precio-input" type="number" step="0.01" value="${val}" data-key="${key}" onchange="precioChanged(this)"></td>`;
          });
          html += '</tr>';
        });
      });
      document.getElementById('precios-tbody').innerHTML = html;
    }

    function precioChanged(input) {
      const key = input.dataset.key;
      const val = parseFloat(input.value);
      if (isNaN(val) || val === 0) { delete precios[key]; }
      else { precios[key] = val; }
    }

    async function guardarPrecios() {
      // Recoger todos los inputs
      document.querySelectorAll('.precio-input').forEach(inp => { precioChanged(inp); });
      await guardarTarifas();
      alert('‚úÖ Precios guardados');
    }

    // Columna CRUD
    function abrirModalCol() {
      document.getElementById('col-nombre').value = '';
      document.getElementById('modal-col').classList.add('active');
    }

    async function guardarCol() {
      const nombre = document.getElementById('col-nombre').value.trim();
      if (!nombre) { alert('Nombre obligatorio'); return; }
      columnas.push({ id: 'col_' + Date.now(), nombre, orden: columnas.length });
      await guardarTarifas();
      cerrarModal('modal-col');
      renderPrecios();
    }

    function editarCol(id) {
      const col = columnas.find(c => c.id === id);
      if (!col) return;
      const nuevo = prompt('Renombrar columna:', col.nombre);
      if (nuevo && nuevo.trim()) { col.nombre = nuevo.trim(); guardarTarifas(); renderPrecios(); }
    }

    async function eliminarCol(id) {
      if (!confirm('¬øEliminar esta columna de precios?')) return;
      // Limpiar precios de esa columna
      servicios.forEach(s => { delete precios[s.id + '_' + id]; });
      columnas = columnas.filter(c => c.id !== id);
      await guardarTarifas();
      renderPrecios();
    }

    // ===== TAB OFERTAS =====
    function renderOfertas() {
      const c = document.getElementById('ofertas-container');
      const v = document.getElementById('ofertas-vacio');
      if (!ofertas.length) { c.innerHTML = ''; v.style.display = ''; return; }
      v.style.display = 'none';
      let html = '';
      ofertas.forEach(o => {
        const activa = o.activa !== false;
        html += `<div class="oferta-card ${activa ? 'activa' : ''}" onclick="editarOferta('${o.id}')">
          <div class="oferta-header">
            <span class="oferta-nombre">${o.nombre}</span>
            <span class="oferta-badge ${activa ? 'activa' : 'inactiva'}">${activa ? '‚úÖ Activa' : '‚è∏Ô∏è Inactiva'}</span>
          </div>
          ${o.condiciones ? `<div class="oferta-detalle">${o.condiciones}</div>` : ''}
          <div class="oferta-valor">${o.valor || ''} ${tipoLabel(o.tipo)}</div>
          <div class="oferta-interno">üîí Solo uso interno ‚Äî No se muestra al hu√©sped ni se exporta a PDF</div>
        </div>`;
      });
      c.innerHTML = html;
    }

    function tipoLabel(t) {
      const m = { porcentaje:'descuento', fijo:'dto. fijo', pack:'pack', gratis:'gratuidad' };
      return m[t] || '';
    }

    function abrirModalOferta(data) {
      editOfertaId = data ? data.id : null;
      document.getElementById('modal-oferta-title').textContent = data ? '‚úèÔ∏è Editar oferta' : 'üéÅ Nueva oferta';
      document.getElementById('btn-del-oferta').style.display = data ? '' : 'none';
      document.getElementById('oferta-nombre').value = data?.nombre || '';
      document.getElementById('oferta-tipo').value = data?.tipo || 'porcentaje';
      document.getElementById('oferta-valor').value = data?.valor || '';
      document.getElementById('oferta-condiciones').value = data?.condiciones || '';
      document.getElementById('oferta-activa').value = data?.activa !== false ? 'true' : 'false';
      document.getElementById('modal-oferta').classList.add('active');
    }

    function editarOferta(id) { abrirModalOferta(ofertas.find(o => o.id === id)); }

    async function guardarOferta() {
      const nombre = document.getElementById('oferta-nombre').value.trim();
      if (!nombre) { alert('Nombre obligatorio'); return; }
      const data = {
        nombre,
        tipo: document.getElementById('oferta-tipo').value,
        valor: document.getElementById('oferta-valor').value.trim(),
        condiciones: document.getElementById('oferta-condiciones').value.trim(),
        activa: document.getElementById('oferta-activa').value === 'true'
      };
      if (editOfertaId) {
        const idx = ofertas.findIndex(o => o.id === editOfertaId);
        if (idx >= 0) Object.assign(ofertas[idx], data);
      } else {
        ofertas.push({ id: 'ofe_' + Date.now(), ...data });
      }
      await guardarTarifas();
      cerrarModal('modal-oferta');
      renderOfertas();
    }

    async function eliminarOferta() {
      if (!editOfertaId || !confirm('¬øEliminar oferta?')) return;
      ofertas = ofertas.filter(o => o.id !== editOfertaId);
      await guardarTarifas();
      cerrarModal('modal-oferta');
      renderOfertas();
    }

    // ===== PDF (sin ofertas) =====
    // ===== TAB PROPUESTAS =====
    function renderPropuestas() {
      const c = document.getElementById('propuestas-container');
      const v = document.getElementById('propuestas-vacio');
      if (!propuestas.length) { c.innerHTML = ''; v.style.display = ''; return; }
      v.style.display = 'none';
      c.innerHTML = propuestas.sort((a,b) => (b.fechaCreacion||'').localeCompare(a.fechaCreacion||'')).map(p => {
        const total = calcTotalLineas(p.lineas || []);
        const nLineas = (p.lineas || []).length;
        return `<div class="prop-card" onclick="editarPropuesta('${p.id}')">
          <div class="prop-top">
            <div>
              <div class="prop-cliente">${p.cliente || 'Sin cliente'}</div>
              <div class="prop-fechas">${p.fechaInicio ? fFecha(p.fechaInicio) : ''} ${p.fechaInicio && p.fechaFin ? '‚Üí' : ''} ${p.fechaFin ? fFecha(p.fechaFin) : ''}</div>
            </div>
            <span class="prop-estado ${p.estado || 'borrador'}">${estadoPropLabel(p.estado)}</span>
          </div>
          <div class="prop-bottom">
            <span class="prop-lineas-info">${nLineas} partida${nLineas !== 1 ? 's' : ''}</span>
            <span class="prop-total">${fN(total.total)} ‚Ç¨</span>
          </div>
        </div>`;
      }).join('');
    }

    function estadoPropLabel(e) {
      return { borrador:'üìù Borrador', enviada:'üì§ Enviada', aceptada:'‚úÖ Aceptada', rechazada:'‚ùå Rechazada' }[e] || 'üìù Borrador';
    }

    function abrirModalPropuesta(data) {
      editPropId = data ? data.id : null;
      document.getElementById('modal-propuesta-title').textContent = data ? '‚úèÔ∏è Editar propuesta' : 'üìÑ Nueva propuesta';
      document.getElementById('btn-del-prop').style.display = data ? '' : 'none';
      document.getElementById('prop-cliente').value = data?.cliente || '';
      document.getElementById('prop-contacto').value = data?.contacto || '';
      document.getElementById('prop-tel').value = data?.telefono || '';
      document.getElementById('prop-email').value = data?.email || '';
      document.getElementById('prop-inicio').value = data?.fechaInicio || '';
      document.getElementById('prop-fin').value = data?.fechaFin || '';
      document.getElementById('prop-estado').value = data?.estado || 'borrador';
      document.getElementById('prop-notas').value = data?.notas || '';
      propLineas = data?.lineas ? JSON.parse(JSON.stringify(data.lineas)) : [];
      if (!propLineas.length) addLineaProp();
      renderLineasProp();
      document.getElementById('modal-propuesta').classList.add('active');
    }

    function editarPropuesta(id) { abrirModalPropuesta(propuestas.find(p => p.id === id)); }

    function addLineaProp() {
      propLineas.push({ concepto: '', uds: 1, dias: 1, precio: 0, descuento: 0, iva: 21, nota: '' });
      renderLineasProp();
    }

    function removeLineaProp(i) { propLineas.splice(i, 1); renderLineasProp(); }

    function renderLineasProp() {
      const tbody = document.getElementById('prop-lineas-body');
      const srvOptions = servicios.map(s => `<option value="${s.nombre}">${s.icono||''} ${s.nombre}</option>`).join('');
      tbody.innerHTML = propLineas.map((l, i) => `<tr>
        <td><input list="srv-list" class="form-input" value="${l.concepto}" onchange="propLineas[${i}].concepto=this.value" style="min-width:140px;"></td>
        <td><input type="number" min="0" step="1" value="${l.uds}" onchange="propLineas[${i}].uds=+this.value;calcPropTotales()"></td>
        <td><input type="number" min="0" step="1" value="${l.dias}" onchange="propLineas[${i}].dias=+this.value;calcPropTotales()"></td>
        <td><input type="number" min="0" step="0.01" value="${l.precio}" onchange="propLineas[${i}].precio=+this.value;calcPropTotales()"></td>
        <td><input type="number" min="0" max="100" step="1" value="${l.descuento}" onchange="propLineas[${i}].descuento=+this.value;calcPropTotales()" style="width:55px;"></td>
        <td><select onchange="propLineas[${i}].iva=+this.value;calcPropTotales()" style="width:65px;">
          <option value="0" ${l.iva==0?'selected':''}>0%</option><option value="4" ${l.iva==4?'selected':''}>4%</option>
          <option value="10" ${l.iva==10?'selected':''}>10%</option><option value="21" ${l.iva==21?'selected':''}>21%</option>
        </select></td>
        <td style="text-align:right;">${fN(lineaTotal(l).total)}</td>
        <td><button class="linea-del" onclick="removeLineaProp(${i})">‚úï</button></td>
      </tr>`).join('');
      calcPropTotales();
    }

    function lineaTotal(l) {
      const base = (l.uds || 1) * (l.dias || 1) * (l.precio || 0) * (1 - (l.descuento || 0) / 100);
      const iva = base * (l.iva || 0) / 100;
      return { base, iva, total: base + iva };
    }

    function calcTotalLineas(lineas) {
      let base = 0, iva = 0;
      (lineas || []).forEach(l => { const t = lineaTotal(l); base += t.base; iva += t.iva; });
      return { base, iva, total: base + iva };
    }

    function calcPropTotales() {
      const t = calcTotalLineas(propLineas);
      document.getElementById('prop-subtotal').textContent = fN(t.base) + ' ‚Ç¨';
      document.getElementById('prop-totaliva').textContent = fN(t.iva) + ' ‚Ç¨';
      document.getElementById('prop-total').textContent = fN(t.total) + ' ‚Ç¨';
    }

    async function guardarPropuesta() {
      const cliente = document.getElementById('prop-cliente').value.trim();
      if (!cliente) { alert('Cliente obligatorio'); return; }
      const data = {
        cliente,
        contacto: document.getElementById('prop-contacto').value.trim(),
        telefono: document.getElementById('prop-tel').value.trim(),
        email: document.getElementById('prop-email').value.trim(),
        fechaInicio: document.getElementById('prop-inicio').value,
        fechaFin: document.getElementById('prop-fin').value,
        estado: document.getElementById('prop-estado').value,
        notas: document.getElementById('prop-notas').value.trim(),
        lineas: propLineas.filter(l => l.concepto || l.precio > 0)
      };
      if (editPropId) {
        const idx = propuestas.findIndex(p => p.id === editPropId);
        if (idx >= 0) Object.assign(propuestas[idx], data);
      } else {
        propuestas.push({ id: 'prop_' + Date.now(), fechaCreacion: new Date().toISOString(), ...data });
      }
      await guardarTarifas();
      cerrarModal('modal-propuesta');
      renderPropuestas();
    }

    async function eliminarPropuesta() {
      if (!editPropId || !confirm('¬øEliminar propuesta?')) return;
      propuestas = propuestas.filter(p => p.id !== editPropId);
      await guardarTarifas();
      cerrarModal('modal-propuesta');
      renderPropuestas();
    }

    // ===== TAB FACTURAS =====
    function renderFacturas() {
      const c = document.getElementById('facturas-container');
      const v = document.getElementById('facturas-vacio');
      if (!facturas.length) { c.innerHTML = ''; v.style.display = ''; return; }
      v.style.display = 'none';
      c.innerHTML = facturas.sort((a,b) => (b.fecha||'').localeCompare(a.fecha||'')).map(f => {
        const total = calcTotalLineas(f.lineas || []);
        return `<div class="fact-card" onclick="editarFactura('${f.id}')">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div>
              <div class="fact-numero">${f.numero || '‚Äî'}</div>
              <div style="font-size:0.85rem;">${f.cliente || ''}</div>
              <div class="prop-fechas">${f.fecha ? fFecha(f.fecha) : ''}${f.vencimiento ? ' ¬∑ Vto: ' + fFecha(f.vencimiento) : ''}</div>
            </div>
            <span class="fact-estado ${f.estado || 'pendiente'}">${estadoFactLabel(f.estado)}</span>
          </div>
          <div class="prop-bottom">
            <span class="prop-lineas-info">${(f.lineas||[]).length} partida${(f.lineas||[]).length!==1?'s':''}</span>
            <span class="prop-total">${fN(total.total)} ‚Ç¨</span>
          </div>
        </div>`;
      }).join('');
    }

    function estadoFactLabel(e) {
      return { pendiente:'‚è≥ Pendiente', pagada:'‚úÖ Pagada', anulada:'‚ùå Anulada' }[e] || '‚è≥ Pendiente';
    }

    function abrirModalFactura(data) {
      editFactId = data ? data.id : null;
      document.getElementById('modal-factura-title').textContent = data ? '‚úèÔ∏è Editar factura' : 'üßæ Nueva factura';
      document.getElementById('btn-del-fact').style.display = data ? '' : 'none';
      document.getElementById('fact-numero').value = data?.numero || autoNumeroFactura();
      document.getElementById('fact-cliente').value = data?.cliente || '';
      document.getElementById('fact-fecha').value = data?.fecha || new Date().toISOString().split('T')[0];
      document.getElementById('fact-vence').value = data?.vencimiento || '';
      document.getElementById('fact-estado').value = data?.estado || 'pendiente';
      document.getElementById('fact-notas').value = data?.notas || '';
      // Poblar select de propuestas
      const sel = document.getElementById('fact-de-prop');
      sel.innerHTML = '<option value="">‚Äî Manual (sin propuesta) ‚Äî</option>' +
        propuestas.filter(p => p.estado === 'aceptada').map(p =>
          `<option value="${p.id}">${p.cliente} (${fN(calcTotalLineas(p.lineas).total)} ‚Ç¨)</option>`
        ).join('');
      sel.value = data?.propuestaId || '';
      factLineas = data?.lineas ? JSON.parse(JSON.stringify(data.lineas)) : [];
      if (!factLineas.length) addLineaFact();
      renderLineasFact();
      document.getElementById('modal-factura').classList.add('active');
    }

    function editarFactura(id) { abrirModalFactura(facturas.find(f => f.id === id)); }

    function autoNumeroFactura() {
      const year = new Date().getFullYear();
      const n = facturas.filter(f => (f.numero||'').includes(String(year))).length + 1;
      return `F-${year}/${String(n).padStart(3,'0')}`;
    }

    function importarDePropuesta() {
      const propId = document.getElementById('fact-de-prop').value;
      if (!propId) return;
      const prop = propuestas.find(p => p.id === propId);
      if (!prop) return;
      document.getElementById('fact-cliente').value = prop.cliente || '';
      factLineas = JSON.parse(JSON.stringify(prop.lineas || []));
      if (!factLineas.length) addLineaFact();
      renderLineasFact();
    }

    function addLineaFact() {
      factLineas.push({ concepto: '', uds: 1, dias: 1, precio: 0, descuento: 0, iva: 21, nota: '' });
      renderLineasFact();
    }

    function removeLineaFact(i) { factLineas.splice(i, 1); renderLineasFact(); }

    function renderLineasFact() {
      const tbody = document.getElementById('fact-lineas-body');
      tbody.innerHTML = factLineas.map((l, i) => `<tr>
        <td><input list="srv-list" class="form-input" value="${l.concepto}" onchange="factLineas[${i}].concepto=this.value" style="min-width:140px;"></td>
        <td><input type="number" min="0" step="1" value="${l.uds}" onchange="factLineas[${i}].uds=+this.value;calcFactTotales()"></td>
        <td><input type="number" min="0" step="1" value="${l.dias}" onchange="factLineas[${i}].dias=+this.value;calcFactTotales()"></td>
        <td><input type="number" min="0" step="0.01" value="${l.precio}" onchange="factLineas[${i}].precio=+this.value;calcFactTotales()"></td>
        <td><input type="number" min="0" max="100" step="1" value="${l.descuento}" onchange="factLineas[${i}].descuento=+this.value;calcFactTotales()" style="width:55px;"></td>
        <td><select onchange="factLineas[${i}].iva=+this.value;calcFactTotales()" style="width:65px;">
          <option value="0" ${l.iva==0?'selected':''}>0%</option><option value="4" ${l.iva==4?'selected':''}>4%</option>
          <option value="10" ${l.iva==10?'selected':''}>10%</option><option value="21" ${l.iva==21?'selected':''}>21%</option>
        </select></td>
        <td style="text-align:right;">${fN(lineaTotal(l).total)}</td>
        <td><button class="linea-del" onclick="removeLineaFact(${i})">‚úï</button></td>
      </tr>`).join('');
      calcFactTotales();
    }

    function calcFactTotales() {
      const t = calcTotalLineas(factLineas);
      document.getElementById('fact-subtotal').textContent = fN(t.base) + ' ‚Ç¨';
      document.getElementById('fact-totaliva').textContent = fN(t.iva) + ' ‚Ç¨';
      document.getElementById('fact-total').textContent = fN(t.total) + ' ‚Ç¨';
    }

    async function guardarFactura() {
      const numero = document.getElementById('fact-numero').value.trim();
      const cliente = document.getElementById('fact-cliente').value.trim();
      if (!numero || !cliente) { alert('N¬∫ Factura y Cliente obligatorios'); return; }
      const data = {
        numero, cliente,
        fecha: document.getElementById('fact-fecha').value,
        vencimiento: document.getElementById('fact-vence').value,
        estado: document.getElementById('fact-estado').value,
        propuestaId: document.getElementById('fact-de-prop').value || null,
        notas: document.getElementById('fact-notas').value.trim(),
        lineas: factLineas.filter(l => l.concepto || l.precio > 0)
      };
      if (editFactId) {
        const idx = facturas.findIndex(f => f.id === editFactId);
        if (idx >= 0) Object.assign(facturas[idx], data);
      } else {
        facturas.push({ id: 'fact_' + Date.now(), ...data });
      }
      await guardarTarifas();
      cerrarModal('modal-factura');
      renderFacturas();
    }

    async function eliminarFactura() {
      if (!editFactId || !confirm('¬øEliminar factura?')) return;
      facturas = facturas.filter(f => f.id !== editFactId);
      await guardarTarifas();
      cerrarModal('modal-factura');
      renderFacturas();
    }

    // ===== HELPERS =====
    function fFecha(d) {
      if (!d) return '';
      const p = d.split('-');
      return p.length === 3 ? `${p[2]}/${p[1]}/${p[0]}` : d;
    }

    // ===== PDF TARIFAS =====
    function exportarPDF() {
      if (!servicios.length) { alert('Sin servicios para exportar'); return; }
      const ac = origen === 'gerente' ? '#2D4A5C' : '#6B8E23';

      let cols = '<th style="text-align:left;padding:8px 10px;">Servicio</th>';
      columnas.forEach(c => { cols += `<th style="text-align:center;padding:8px 10px;">${c.nombre}</th>`; });

      let rows = '';
      categorias.sort((a,b) => (a.orden||0) - (b.orden||0)).forEach(cat => {
        const items = servicios.filter(s => s.categoriaId === cat.id);
        if (!items.length) return;
        rows += `<tr style="background:${ac}10;"><td colspan="${columnas.length + 1}" style="padding:8px 10px;font-weight:700;">${cat.icono||'üìÅ'} ${cat.nombre}</td></tr>`;
        items.forEach(s => {
          rows += `<tr><td style="padding:6px 10px;">${s.icono||'‚Ä¢'} ${s.nombre} <span style="color:#9A9A9A;font-size:0.75rem;">/${s.unidad}${s.iva ? ` ¬∑ ${s.iva}%` : ''}</span></td>`;
          columnas.forEach(col => {
            const v = precios[s.id + '_' + col.id];
            rows += `<td style="text-align:center;padding:6px 10px;">${v ? fN(v) + ' ‚Ç¨' : '‚Äî'}</td>`;
          });
          rows += '</tr>';
        });
      });

      const pdf = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Tarifas - ${bienData?.nombre||''}</title>
<style>@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Nunito',sans-serif;color:#3D3D3D;padding:40px;max-width:900px;margin:0 auto}
table{width:100%;border-collapse:collapse}th{font-size:0.72rem;text-transform:uppercase;color:#9A9A9A;border-bottom:2px solid #F5EDE4;}
td{border-bottom:1px solid #F5EDE4;font-size:0.85rem}
@media print{body{padding:20px}}</style></head><body>
<div style="display:flex;justify-content:space-between;margin-bottom:24px;padding-bottom:14px;border-bottom:3px solid ${ac};">
  <div><h1 style="font-family:'Quicksand';font-size:1.4rem;color:${ac};">TARIFAS</h1>
  <div style="font-size:0.88rem;color:#6B6B6B;">${bienData?.nombre||''}</div></div>
  <div style="text-align:right;font-size:0.85rem;color:#6B6B6B;">${new Date().toLocaleDateString('es-ES')}</div>
</div>
<table><thead><tr>${cols}</tr></thead><tbody>${rows}</tbody></table>
<div style="margin-top:40px;text-align:center;font-size:0.7rem;color:#9A9A9A;">FAMILYNK ¬∑ ${new Date().toLocaleDateString('es-ES')}</div>
<script>window.onload=()=>window.print();<\/script></body></html>`;
      const w = window.open('','_blank'); w.document.write(pdf); w.document.close();
    }

    // ===== UTILS =====
    function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
    function fN(n) { return (parseFloat(n)||0).toLocaleString('es-ES', { minimumFractionDigits:2, maximumFractionDigits:2 }); }
  </script>
</body>
</html>
