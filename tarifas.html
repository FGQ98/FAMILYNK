<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Tarifas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --gerente: #2D4A5C;
      --gerente-light: #4A6B7C;
      --gerente-dark: #1D3544;
      --gerente-muted: rgba(45, 74, 92, 0.12);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --gold: #B8965C;
      --gold-muted: rgba(184, 150, 92, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* ===== HEADER ===== */
    .header {
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      padding: 14px 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky; top: 0; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 14px; background: rgba(255,255,255,0.15);
      border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem;
      color: white; cursor: pointer; text-decoration: none; transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.25); }
    .header-title { display: flex; align-items: center; gap: 12px; color: white; }
    .header-icon {
      width: 40px; height: 40px; background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md); display: flex; align-items: center;
      justify-content: center; font-size: 1.3rem;
    }
    .header-info h1 { font-family: 'Quicksand', sans-serif; font-size: 1.15rem; font-weight: 700; }
    .header-info p { font-size: 0.8rem; opacity: 0.85; }

    /* ===== MAIN ===== */
    .main { max-width: 960px; margin: 0 auto; padding: 24px 20px; }

    /* ===== TABS ===== */
    .tabs {
      display: flex; gap: 4px; margin-bottom: 24px;
      background: var(--cream-dark); border-radius: var(--radius-md); padding: 4px;
    }
    .tab {
      flex: 1; padding: 10px 12px; border: none; border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 600;
      background: transparent; color: var(--text-light); cursor: pointer; transition: all 0.2s;
      text-align: center;
    }
    .tab:hover { color: var(--text); }
    .tab.active { background: var(--gerente); color: white; box-shadow: var(--shadow-soft); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ===== CARDS ===== */
    .card {
      background: var(--white); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft); padding: 20px; margin-bottom: 20px;
    }
    .card-title {
      font-family: 'Quicksand', sans-serif; font-weight: 700;
      font-size: 1rem; margin-bottom: 16px; display: flex;
      align-items: center; gap: 8px;
    }

    /* ===== GRUPO DE SERVICIOS ===== */
    .grupo {
      margin-bottom: 24px;
    }
    .grupo-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; background: var(--gerente-muted);
      border-radius: var(--radius-sm); margin-bottom: 8px;
    }
    .grupo-nombre {
      font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;
    }
    .grupo-acciones { display: flex; gap: 6px; }

    /* ===== TABLA SERVICIOS ===== */
    .tabla-servicios {
      width: 100%; border-collapse: separate; border-spacing: 0;
      font-size: 0.85rem;
    }
    .tabla-servicios th {
      text-align: left; padding: 8px 12px; font-size: 0.75rem;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 2px solid var(--cream-dark); font-weight: 600;
    }
    .tabla-servicios td {
      padding: 10px 12px; border-bottom: 1px solid var(--cream-dark); vertical-align: top;
    }
    .tabla-servicios tr:last-child td { border-bottom: none; }
    .tabla-servicios tr:hover td { background: var(--cream); }
    .servicio-nombre { font-weight: 600; }
    .servicio-desc { color: var(--text-light); font-size: 0.8rem; margin-top: 2px; }
    .servicio-unidad { color: var(--text-muted); font-size: 0.8rem; }

    /* ===== TABLA TARIFAS ===== */
    .tabla-tarifas {
      width: 100%; border-collapse: separate; border-spacing: 0;
      font-size: 0.85rem;
    }
    .tabla-tarifas th {
      padding: 8px 10px; font-size: 0.75rem; text-align: center;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 2px solid var(--cream-dark); font-weight: 600;
    }
    .tabla-tarifas th:first-child { text-align: left; }
    .tabla-tarifas td {
      padding: 8px 10px; border-bottom: 1px solid var(--cream-dark);
      text-align: center; vertical-align: middle;
    }
    .tabla-tarifas td:first-child { text-align: left; }
    .tabla-tarifas tr:last-child td { border-bottom: none; }
    .tabla-tarifas tr:hover td { background: var(--cream); }
    .tarifa-input {
      width: 80px; padding: 6px 8px; border: 1px solid var(--cream-dark);
      border-radius: 6px; text-align: right; font-family: 'Nunito', sans-serif;
      font-size: 0.85rem; background: var(--white); transition: border-color 0.2s;
    }
    .tarifa-input:focus { border-color: var(--gerente); outline: none; }
    .tarifa-grupo-row td {
      background: var(--gerente-muted); font-weight: 700; font-size: 0.85rem;
      padding: 8px 12px;
    }

    /* ===== TEMPORADAS CONFIG ===== */
    .temporadas-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px; margin-bottom: 20px;
    }
    .temporada-card {
      background: var(--cream); border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md); padding: 14px; transition: all 0.2s;
    }
    .temporada-card.activa { border-color: var(--gerente-light); }
    .temporada-card .form-row { display: flex; gap: 8px; margin-top: 8px; }
    .temporada-card .form-row > div { flex: 1; }
    .temporada-label {
      font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; display: block;
    }
    .temporada-input {
      width: 100%; padding: 7px 10px; border: 1px solid var(--cream-dark);
      border-radius: 6px; font-family: 'Nunito', sans-serif; font-size: 0.85rem;
      transition: border-color 0.2s;
    }
    .temporada-input:focus { border-color: var(--gerente); outline: none; }
    .temporada-toggle {
      display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
    }
    .toggle-switch {
      position: relative; width: 36px; height: 20px;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; inset: 0; background: var(--cream-dark);
      border-radius: 20px; cursor: pointer; transition: 0.3s;
    }
    .toggle-slider::before {
      content: ''; position: absolute; width: 16px; height: 16px;
      left: 2px; bottom: 2px; background: white; border-radius: 50%;
      transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch input:checked + .toggle-slider { background: var(--gerente); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(16px); }
    .temporada-numero { font-weight: 700; font-size: 0.9rem; }
    .temporada-fechas { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

    /* ===== DESCUENTOS ===== */
    .descuento-row {
      display: grid; grid-template-columns: 1fr 120px 80px 36px;
      gap: 8px; align-items: center; padding: 8px 0;
      border-bottom: 1px solid var(--cream-dark);
    }
    .descuento-row:last-child { border-bottom: none; }

    /* ===== PLANES ===== */
    .plan-card {
      background: var(--cream); border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px;
    }
    .plan-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 10px;
    }
    .plan-nombre { font-weight: 700; font-size: 0.95rem; }
    .plan-precio { font-weight: 700; color: var(--gerente); font-size: 1.1rem; }
    .plan-detalles { font-size: 0.8rem; color: var(--text-light); line-height: 1.6; }
    .plan-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
    .plan-tag {
      padding: 3px 10px; border-radius: 20px; font-size: 0.72rem;
      font-weight: 600; background: var(--gerente-muted); color: var(--gerente);
    }

    /* ===== BOTONES ===== */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; border: none; border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; text-decoration: none;
    }
    .btn-gerente { background: var(--gerente); color: white; }
    .btn-gerente:hover { background: var(--gerente-dark); }
    .btn-sm { padding: 5px 12px; font-size: 0.8rem; }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-secondary:hover { background: #ede5db; }
    .btn-danger { background: var(--error); color: white; }
    .btn-danger:hover { opacity: 0.9; }
    .btn-icon {
      width: 28px; height: 28px; border-radius: 6px; border: none;
      background: transparent; cursor: pointer; font-size: 0.9rem;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .btn-icon:hover { background: var(--cream-dark); }
    .btn-icon.danger:hover { background: rgba(212, 105, 90, 0.15); }

    /* ===== MODAL ===== */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      z-index: 200; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--white); border-radius: var(--radius-lg);
      width: 100%; max-width: 520px; max-height: 85vh; overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    .modal-header {
      padding: 16px 20px; background: var(--gerente); color: white;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-header h3 { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1rem; }
    .modal-close {
      background: rgba(255,255,255,0.2); border: none; color: white;
      width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
      font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
    }
    .modal-body { padding: 20px; }
    .modal-footer {
      padding: 12px 20px; border-top: 1px solid var(--cream-dark);
      display: flex; justify-content: flex-end; gap: 8px;
    }

    .form-group { margin-bottom: 14px; }
    .form-label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: var(--text-light); }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 9px 12px; border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm); font-family: 'Nunito', sans-serif;
      font-size: 0.88rem; transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: var(--gerente); outline: none;
    }
    .form-textarea { resize: vertical; min-height: 60px; }
    .form-row { display: flex; gap: 12px; }
    .form-row > .form-group { flex: 1; }

    /* ===== EMPTY ===== */
    .empty-state {
      text-align: center; padding: 40px 20px; color: var(--text-muted);
    }
    .empty-state-icon { font-size: 2.5rem; margin-bottom: 12px; }
    .empty-state-title { font-weight: 700; font-size: 1rem; margin-bottom: 6px; color: var(--text-light); }
    .empty-state-text { font-size: 0.85rem; margin-bottom: 16px; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 640px) {
      .tabs { flex-direction: column; }
      .tarifa-input { width: 65px; font-size: 0.8rem; }
      .descuento-row { grid-template-columns: 1fr 90px 70px 36px; font-size: 0.82rem; }
      .temporadas-grid { grid-template-columns: 1fr; }
      .form-row { flex-direction: column; gap: 0; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="gerente.html" class="back-btn" id="btn-volver">‚Üê Gerente</a>
      <div class="header-title">
        <div class="header-icon">üí∂</div>
        <div class="header-info">
          <h1>Tarifas</h1>
          <p id="bien-nombre">Cargando...</p>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="cambiarTab('servicios')">üìã Servicios</button>
      <button class="tab" onclick="cambiarTab('tarifas')">üí∂ Tarifas</button>
      <button class="tab" onclick="cambiarTab('planes')">üéÅ Planes y Descuentos</button>
    </div>

    <!-- ==================== TAB 1: SERVICIOS ==================== -->
    <div class="tab-content active" id="tab-servicios">
      <div class="card">
        <div class="card-title">üìã Cat√°logo de Servicios
          <span style="flex:1;"></span>
          <button class="btn btn-gerente btn-sm" onclick="abrirModalServicio()">+ Servicio</button>
        </div>
        <div id="servicios-container">
          <div class="empty-state" id="empty-servicios">
            <div class="empty-state-icon">üìã</div>
            <div class="empty-state-title">Sin servicios definidos</div>
            <div class="empty-state-text">A√±ade servicios agrupados por categor√≠a</div>
            <button class="btn btn-gerente" onclick="abrirModalServicio()">+ A√±adir primer servicio</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 2: TARIFAS ==================== -->
    <div class="tab-content" id="tab-tarifas">
      <!-- Temporadas -->
      <div class="card">
        <div class="card-title">üìÖ Temporadas</div>
        <div class="temporadas-grid" id="temporadas-grid"></div>
        <button class="btn btn-gerente btn-sm" onclick="guardarTemporadas()" id="btn-guardar-temporadas">üíæ Guardar temporadas</button>
      </div>

      <!-- Tabla de precios -->
      <div class="card">
        <div class="card-title">üí∂ Precios por temporada
          <span style="flex:1;"></span>
          <button class="btn btn-gerente btn-sm" onclick="guardarTarifas()">üíæ Guardar precios</button>
        </div>
        <div id="tarifas-container">
          <div class="empty-state" id="empty-tarifas">
            <div class="empty-state-icon">üí∂</div>
            <div class="empty-state-title">Define servicios primero</div>
            <div class="empty-state-text">Los precios se asignan a los servicios del cat√°logo</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 3: PLANES Y DESCUENTOS ==================== -->
    <div class="tab-content" id="tab-planes">
      <!-- Descuentos -->
      <div class="card">
        <div class="card-title">üè∑Ô∏è Descuentos por tipo de cliente
          <span style="flex:1;"></span>
          <button class="btn btn-gerente btn-sm" onclick="abrirModalDescuento()">+ Descuento</button>
        </div>
        <div id="descuentos-container">
          <div class="empty-state" id="empty-descuentos">
            <div class="empty-state-icon">üè∑Ô∏è</div>
            <div class="empty-state-title">Sin descuentos configurados</div>
            <div class="empty-state-text">Crea descuentos para tipos de clientes o grupos</div>
          </div>
        </div>
      </div>

      <!-- Planes -->
      <div class="card">
        <div class="card-title">üéÅ Planes y paquetes
          <span style="flex:1;"></span>
          <button class="btn btn-gerente btn-sm" onclick="abrirModalPlan()">+ Plan</button>
        </div>
        <div id="planes-container">
          <div class="empty-state" id="empty-planes">
            <div class="empty-state-icon">üéÅ</div>
            <div class="empty-state-title">Sin planes configurados</div>
            <div class="empty-state-text">Crea paquetes combinando servicios, d√≠as y personas</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== MODAL SERVICIO ===== -->
  <div class="modal-overlay" id="modal-servicio">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-servicio-titulo">Nuevo servicio</h3>
        <button class="modal-close" onclick="cerrarModal('modal-servicio')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Grupo</label>
          <select class="form-select" id="serv-grupo">
            <option value="alojamiento">üè† Alojamiento</option>
            <option value="manutencion">üçΩÔ∏è Manutenci√≥n</option>
            <option value="actividades">üéØ Actividades</option>
            <option value="extras">‚ú® Extras</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Nombre del servicio</label>
          <input type="text" class="form-input" id="serv-nombre" placeholder="Ej: Habitaci√≥n doble">
        </div>
        <div class="form-group">
          <label class="form-label">Descripci√≥n</label>
          <textarea class="form-textarea" id="serv-descripcion" placeholder="Qu√© incluye este servicio..." rows="2"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Unidad de cobro</label>
            <select class="form-select" id="serv-unidad">
              <option value="noche">Por noche</option>
              <option value="persona">Por persona</option>
              <option value="persona-noche">Por persona/noche</option>
              <option value="servicio">Por servicio</option>
              <option value="hora">Por hora</option>
              <option value="unidad">Por unidad</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Orden</label>
            <input type="number" class="form-input" id="serv-orden" value="0" min="0">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-servicio')">Cancelar</button>
        <button class="btn btn-danger" id="btn-eliminar-servicio" onclick="eliminarServicio()" style="display:none;">Eliminar</button>
        <button class="btn btn-gerente" onclick="guardarServicio()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL DESCUENTO ===== -->
  <div class="modal-overlay" id="modal-descuento">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-descuento-titulo">Nuevo descuento</h3>
        <button class="modal-close" onclick="cerrarModal('modal-descuento')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Tipo / grupo de cliente</label>
          <input type="text" class="form-input" id="desc-tipo" placeholder="Ej: Repetidores, Familias numerosas, Amigos del propietario">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Descuento (%)</label>
            <input type="number" class="form-input" id="desc-porcentaje" min="0" max="100" value="10">
          </div>
          <div class="form-group">
            <label class="form-label">Aplicable a</label>
            <select class="form-select" id="desc-aplicable">
              <option value="todo">Todo</option>
              <option value="alojamiento">Solo alojamiento</option>
              <option value="manutencion">Solo manutenci√≥n</option>
              <option value="actividades">Solo actividades</option>
              <option value="extras">Solo extras</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notas</label>
          <textarea class="form-textarea" id="desc-notas" rows="2" placeholder="Condiciones, vigencia..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-descuento')">Cancelar</button>
        <button class="btn btn-danger" id="btn-eliminar-descuento" onclick="eliminarDescuento()" style="display:none;">Eliminar</button>
        <button class="btn btn-gerente" onclick="guardarDescuento()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL PLAN ===== -->
  <div class="modal-overlay" id="modal-plan">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-plan-titulo">Nuevo plan</h3>
        <button class="modal-close" onclick="cerrarModal('modal-plan')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nombre del plan</label>
          <input type="text" class="form-input" id="plan-nombre" placeholder="Ej: Pack Caza 5 noches">
        </div>
        <div class="form-group">
          <label class="form-label">Descripci√≥n</label>
          <textarea class="form-textarea" id="plan-descripcion" rows="2" placeholder="Qu√© incluye este plan..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">N¬∫ noches</label>
            <input type="number" class="form-input" id="plan-noches" min="0" value="0" placeholder="0 = sin l√≠mite">
          </div>
          <div class="form-group">
            <label class="form-label">N¬∫ personas</label>
            <input type="number" class="form-input" id="plan-personas" min="0" value="0" placeholder="0 = sin l√≠mite">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Servicios incluidos</label>
          <div id="plan-servicios-checks" style="max-height:160px;overflow-y:auto;padding:8px;background:var(--cream);border-radius:8px;">
            <div style="color:var(--text-muted);font-size:0.85rem;">Carga servicios primero</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Precio del plan (‚Ç¨)</label>
            <input type="number" class="form-input" id="plan-precio" min="0" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label class="form-label">Temporada aplicable</label>
            <select class="form-select" id="plan-temporada">
              <option value="todas">Todas</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notas</label>
          <textarea class="form-textarea" id="plan-notas" rows="2" placeholder="Condiciones, restricciones..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-plan')">Cancelar</button>
        <button class="btn btn-danger" id="btn-eliminar-plan" onclick="eliminarPlan()" style="display:none;">Eliminar</button>
        <button class="btn btn-gerente" onclick="guardarPlan()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let origen = 'gerente';

    // Datos
    let serviciosData = [];
    let temporadasData = [
      { activa: true, nombre: '', desde: '', hasta: '' },
      { activa: false, nombre: '', desde: '', hasta: '' },
      { activa: false, nombre: '', desde: '', hasta: '' }
    ];
    let tarifasData = {};    // { servicioId: { temp0: precio, temp1: precio, temp2: precio } }
    let descuentosData = [];
    let planesData = [];

    let editingServicioId = null;
    let editingDescuentoId = null;
    let editingPlanId = null;

    const GRUPOS = {
      alojamiento: { icon: 'üè†', nombre: 'Alojamiento' },
      manutencion: { icon: 'üçΩÔ∏è', nombre: 'Manutenci√≥n' },
      actividades: { icon: 'üéØ', nombre: 'Actividades' },
      extras:      { icon: '‚ú®', nombre: 'Extras' }
    };

    const UNIDADES = {
      noche: '/noche', persona: '/persona', 'persona-noche': '/pers¬∑noche',
      servicio: '/servicio', hora: '/hora', unidad: '/ud'
    };

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');
      origen = params.get('origen') || 'gerente';

      if (!bienId) {
        alert('No se ha especificado el bien');
        window.location.href = 'lo-comun.html';
        return;
      }

      auth.onAuthStateChanged(async (user) => {
        if (!user) { window.location.href = 'login.html'; return; }
        currentUser = user;
        await cargarBien();
        await cargarServicios();
        await cargarTarifasData();
        await cargarDescuentos();
        await cargarPlanes();
        renderTemporadas();
        renderServicios();
        renderTarifas();
        renderDescuentos();
        renderPlanes();
      });
    });

    // ========== CARGAR DATOS ==========
    async function cargarBien() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (doc.exists) {
          bienData = doc.data();
          document.getElementById('bien-nombre').textContent = bienData.nombre || 'Sin nombre';
          document.getElementById('btn-volver').href = `${origen}.html?id=${bienId}`;

          // Cargar temporadas guardadas
          if (bienData.temporadas && bienData.temporadas.length > 0) {
            bienData.temporadas.forEach((t, i) => {
              if (i < 3) temporadasData[i] = { ...temporadasData[i], ...t };
            });
          }
        }
      } catch (error) {
        console.error('Error cargando bien:', error);
      }
    }

    async function cargarServicios() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('servicios').orderBy('orden', 'asc').get();
        serviciosData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.error('Error cargando servicios:', e); }
    }

    async function cargarTarifasData() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (doc.exists && doc.data().tarifasPrecios) {
          tarifasData = doc.data().tarifasPrecios;
        }
      } catch (e) { console.error('Error cargando tarifas:', e); }
    }

    async function cargarDescuentos() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('descuentos').orderBy('tipo', 'asc').get();
        descuentosData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.error('Error cargando descuentos:', e); }
    }

    async function cargarPlanes() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('planes').get();
        planesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.error('Error cargando planes:', e); }
    }

    // ========== TABS ==========
    function cambiarTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
    }

    // ========== RENDER SERVICIOS ==========
    function renderServicios() {
      const container = document.getElementById('servicios-container');
      const empty = document.getElementById('empty-servicios');

      if (serviciosData.length === 0) {
        container.innerHTML = '';
        container.appendChild(empty);
        empty.style.display = '';
        return;
      }
      empty.style.display = 'none';

      // Agrupar
      const grupos = {};
      Object.keys(GRUPOS).forEach(g => grupos[g] = []);
      serviciosData.forEach(s => {
        const g = s.grupo || 'extras';
        if (!grupos[g]) grupos[g] = [];
        grupos[g].push(s);
      });

      let html = '';
      Object.entries(grupos).forEach(([key, items]) => {
        if (items.length === 0) return;
        const grupo = GRUPOS[key] || { icon: 'üì¶', nombre: key };
        html += `<div class="grupo">
          <div class="grupo-header">
            <span class="grupo-nombre">${grupo.icon} ${grupo.nombre}</span>
            <span style="font-size:0.8rem;color:var(--text-muted);">${items.length} servicio${items.length !== 1 ? 's' : ''}</span>
          </div>
          <table class="tabla-servicios">
            <thead><tr>
              <th>Servicio</th>
              <th>Unidad</th>
              <th style="width:50px;"></th>
            </tr></thead>
            <tbody>`;
        items.forEach(s => {
          html += `<tr>
            <td>
              <div class="servicio-nombre">${s.nombre}</div>
              ${s.descripcion ? `<div class="servicio-desc">${s.descripcion}</div>` : ''}
            </td>
            <td class="servicio-unidad">${UNIDADES[s.unidad] || s.unidad}</td>
            <td><button class="btn-icon" onclick='abrirModalServicio(${JSON.stringify(s).replace(/'/g, "&#39;")})'>‚úèÔ∏è</button></td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
      });

      container.innerHTML = html;
    }

    // ========== RENDER TEMPORADAS ==========
    function renderTemporadas() {
      const grid = document.getElementById('temporadas-grid');
      let html = '';
      temporadasData.forEach((t, i) => {
        html += `
          <div class="temporada-card ${t.activa ? 'activa' : ''}">
            <div class="temporada-toggle">
              <label class="toggle-switch">
                <input type="checkbox" ${t.activa ? 'checked' : ''} onchange="temporadasData[${i}].activa = this.checked; this.closest('.temporada-card').classList.toggle('activa', this.checked);">
                <span class="toggle-slider"></span>
              </label>
              <span class="temporada-numero">Temporada ${i + 1}</span>
            </div>
            <div class="form-group" style="margin-bottom:8px;">
              <label class="temporada-label">Nombre</label>
              <input type="text" class="temporada-input" value="${t.nombre || ''}" placeholder="Ej: Caza" 
                onchange="temporadasData[${i}].nombre = this.value">
            </div>
            <div class="form-row">
              <div>
                <label class="temporada-label">Desde</label>
                <input type="date" class="temporada-input" value="${t.desde || ''}" 
                  onchange="temporadasData[${i}].desde = this.value">
              </div>
              <div>
                <label class="temporada-label">Hasta</label>
                <input type="date" class="temporada-input" value="${t.hasta || ''}" 
                  onchange="temporadasData[${i}].hasta = this.value">
              </div>
            </div>
          </div>`;
      });
      grid.innerHTML = html;
    }

    async function guardarTemporadas() {
      const btn = document.getElementById('btn-guardar-temporadas');
      btn.disabled = true; btn.textContent = 'Guardando...';
      try {
        await db.collection('bienes').doc(bienId).update({ temporadas: temporadasData });
        btn.textContent = '‚úÖ Guardado';
        setTimeout(() => { btn.textContent = 'üíæ Guardar temporadas'; btn.disabled = false; }, 1500);
        renderTarifas(); // Actualizar columnas
      } catch (e) {
        console.error('Error:', e);
        alert('Error al guardar temporadas');
        btn.textContent = 'üíæ Guardar temporadas'; btn.disabled = false;
      }
    }

    // ========== RENDER TARIFAS ==========
    function renderTarifas() {
      const container = document.getElementById('tarifas-container');
      const empty = document.getElementById('empty-tarifas');

      if (serviciosData.length === 0) {
        container.innerHTML = '';
        container.appendChild(empty);
        empty.style.display = '';
        return;
      }
      empty.style.display = 'none';

      const temporadasActivas = temporadasData.filter(t => t.activa && t.nombre);
      if (temporadasActivas.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Configura al menos una temporada arriba</div>';
        return;
      }

      // Header columnas
      let html = `<div style="overflow-x:auto;"><table class="tabla-tarifas">
        <thead><tr>
          <th style="min-width:180px;">Servicio</th>`;
      temporadasActivas.forEach((t, i) => {
        const idx = temporadasData.indexOf(t);
        html += `<th>${t.nombre}<br><span style="font-size:0.65rem;font-weight:400;text-transform:none;">${formatFecha(t.desde)} ‚Äî ${formatFecha(t.hasta)}</span></th>`;
      });
      html += `</tr></thead><tbody>`;

      // Filas por grupo
      const grupos = {};
      Object.keys(GRUPOS).forEach(g => grupos[g] = []);
      serviciosData.forEach(s => {
        const g = s.grupo || 'extras';
        if (!grupos[g]) grupos[g] = [];
        grupos[g].push(s);
      });

      Object.entries(grupos).forEach(([key, items]) => {
        if (items.length === 0) return;
        const grupo = GRUPOS[key];
        html += `<tr class="tarifa-grupo-row"><td colspan="${temporadasActivas.length + 1}">${grupo.icon} ${grupo.nombre}</td></tr>`;

        items.forEach(s => {
          html += `<tr><td>
            <span style="font-weight:600;">${s.nombre}</span>
            <span style="color:var(--text-muted);font-size:0.75rem;"> ${UNIDADES[s.unidad] || ''}</span>
          </td>`;
          temporadasActivas.forEach(t => {
            const idx = temporadasData.indexOf(t);
            const precio = tarifasData[s.id]?.[`temp${idx}`] || '';
            html += `<td><input type="number" class="tarifa-input" step="0.01" min="0" 
              value="${precio}" data-servicio="${s.id}" data-temp="${idx}" 
              placeholder="‚Ç¨" onchange="actualizarTarifa(this)"></td>`;
          });
          html += `</tr>`;
        });
      });

      html += `</tbody></table></div>`;
      container.innerHTML = html;
    }

    function actualizarTarifa(input) {
      const sid = input.dataset.servicio;
      const tidx = input.dataset.temp;
      if (!tarifasData[sid]) tarifasData[sid] = {};
      tarifasData[sid][`temp${tidx}`] = parseFloat(input.value) || 0;
    }

    async function guardarTarifas() {
      try {
        await db.collection('bienes').doc(bienId).update({ tarifasPrecios: tarifasData });
        alert('‚úÖ Precios guardados');
      } catch (e) {
        console.error('Error:', e);
        alert('Error al guardar precios');
      }
    }

    // ========== RENDER DESCUENTOS ==========
    function renderDescuentos() {
      const container = document.getElementById('descuentos-container');
      const empty = document.getElementById('empty-descuentos');

      if (descuentosData.length === 0) {
        container.innerHTML = '';
        container.appendChild(empty);
        empty.style.display = '';
        return;
      }
      empty.style.display = 'none';

      const aplicableLabel = { todo: 'Todo', alojamiento: 'Alojamiento', manutencion: 'Manutenci√≥n', actividades: 'Actividades', extras: 'Extras' };

      let html = `<div style="font-size:0.75rem;color:var(--text-muted);display:grid;grid-template-columns:1fr 120px 80px 36px;gap:8px;padding:0 0 6px 0;border-bottom:2px solid var(--cream-dark);">
        <span>TIPO / GRUPO</span><span>APLICA A</span><span style="text-align:right;">DTO.</span><span></span>
      </div>`;
      descuentosData.forEach(d => {
        html += `<div class="descuento-row">
          <div>
            <div style="font-weight:600;">${d.tipo}</div>
            ${d.notas ? `<div style="font-size:0.75rem;color:var(--text-muted);">${d.notas}</div>` : ''}
          </div>
          <div style="font-size:0.82rem;">${aplicableLabel[d.aplicable] || d.aplicable}</div>
          <div style="text-align:right;font-weight:700;color:var(--gerente);">-${d.porcentaje}%</div>
          <button class="btn-icon" onclick='abrirModalDescuento(${JSON.stringify(d).replace(/'/g, "&#39;")})'>‚úèÔ∏è</button>
        </div>`;
      });
      container.innerHTML = html;
    }

    // ========== RENDER PLANES ==========
    function renderPlanes() {
      const container = document.getElementById('planes-container');
      const empty = document.getElementById('empty-planes');

      if (planesData.length === 0) {
        container.innerHTML = '';
        container.appendChild(empty);
        empty.style.display = '';
        return;
      }
      empty.style.display = 'none';

      let html = '';
      planesData.forEach(p => {
        const tags = [];
        if (p.noches > 0) tags.push(`${p.noches} noches`);
        if (p.personas > 0) tags.push(`${p.personas} personas`);
        if (p.temporada && p.temporada !== 'todas') tags.push(p.temporada);
        const serviciosIncluidos = (p.serviciosIncluidos || []).map(sid => {
          const s = serviciosData.find(x => x.id === sid);
          return s ? s.nombre : sid;
        });
        if (serviciosIncluidos.length > 0) tags.push(`${serviciosIncluidos.length} servicio${serviciosIncluidos.length > 1 ? 's' : ''}`);

        html += `<div class="plan-card" onclick='abrirModalPlan(${JSON.stringify(p).replace(/'/g, "&#39;")})' style="cursor:pointer;">
          <div class="plan-header">
            <div class="plan-nombre">üéÅ ${p.nombre}</div>
            <div class="plan-precio">${p.precio > 0 ? p.precio.toFixed(2) + ' ‚Ç¨' : 'Consultar'}</div>
          </div>
          ${p.descripcion ? `<div class="plan-detalles">${p.descripcion}</div>` : ''}
          ${serviciosIncluidos.length > 0 ? `<div class="plan-detalles" style="margin-top:4px;">Incluye: ${serviciosIncluidos.join(', ')}</div>` : ''}
          ${tags.length > 0 ? `<div class="plan-tags">${tags.map(t => `<span class="plan-tag">${t}</span>`).join('')}</div>` : ''}
        </div>`;
      });
      container.innerHTML = html;
    }

    // ========== MODALES ==========
    function cerrarModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // --- SERVICIO ---
    function abrirModalServicio(servicio = null) {
      editingServicioId = servicio?.id || null;
      document.getElementById('modal-servicio-titulo').textContent = servicio ? 'Editar servicio' : 'Nuevo servicio';
      document.getElementById('serv-grupo').value = servicio?.grupo || 'alojamiento';
      document.getElementById('serv-nombre').value = servicio?.nombre || '';
      document.getElementById('serv-descripcion').value = servicio?.descripcion || '';
      document.getElementById('serv-unidad').value = servicio?.unidad || 'noche';
      document.getElementById('serv-orden').value = servicio?.orden || 0;
      document.getElementById('btn-eliminar-servicio').style.display = servicio ? '' : 'none';
      document.getElementById('modal-servicio').classList.add('active');
    }

    async function guardarServicio() {
      const data = {
        grupo: document.getElementById('serv-grupo').value,
        nombre: document.getElementById('serv-nombre').value.trim(),
        descripcion: document.getElementById('serv-descripcion').value.trim(),
        unidad: document.getElementById('serv-unidad').value,
        orden: parseInt(document.getElementById('serv-orden').value) || 0
      };
      if (!data.nombre) { alert('El nombre es obligatorio'); return; }

      try {
        const ref = db.collection('bienes').doc(bienId).collection('servicios');
        if (editingServicioId) {
          await ref.doc(editingServicioId).update(data);
        } else {
          await ref.add(data);
        }
        cerrarModal('modal-servicio');
        await cargarServicios();
        renderServicios();
        renderTarifas();
      } catch (e) {
        console.error('Error:', e); alert('Error al guardar');
      }
    }

    async function eliminarServicio() {
      if (!editingServicioId || !confirm('¬øEliminar este servicio?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('servicios').doc(editingServicioId).delete();
        // Limpiar tarifas del servicio eliminado
        if (tarifasData[editingServicioId]) {
          delete tarifasData[editingServicioId];
          await db.collection('bienes').doc(bienId).update({ tarifasPrecios: tarifasData });
        }
        cerrarModal('modal-servicio');
        await cargarServicios();
        renderServicios();
        renderTarifas();
      } catch (e) { console.error('Error:', e); alert('Error al eliminar'); }
    }

    // --- DESCUENTO ---
    function abrirModalDescuento(descuento = null) {
      editingDescuentoId = descuento?.id || null;
      document.getElementById('modal-descuento-titulo').textContent = descuento ? 'Editar descuento' : 'Nuevo descuento';
      document.getElementById('desc-tipo').value = descuento?.tipo || '';
      document.getElementById('desc-porcentaje').value = descuento?.porcentaje || 10;
      document.getElementById('desc-aplicable').value = descuento?.aplicable || 'todo';
      document.getElementById('desc-notas').value = descuento?.notas || '';
      document.getElementById('btn-eliminar-descuento').style.display = descuento ? '' : 'none';
      document.getElementById('modal-descuento').classList.add('active');
    }

    async function guardarDescuento() {
      const data = {
        tipo: document.getElementById('desc-tipo').value.trim(),
        porcentaje: parseInt(document.getElementById('desc-porcentaje').value) || 0,
        aplicable: document.getElementById('desc-aplicable').value,
        notas: document.getElementById('desc-notas').value.trim()
      };
      if (!data.tipo) { alert('El tipo de cliente es obligatorio'); return; }

      try {
        const ref = db.collection('bienes').doc(bienId).collection('descuentos');
        if (editingDescuentoId) {
          await ref.doc(editingDescuentoId).update(data);
        } else {
          await ref.add(data);
        }
        cerrarModal('modal-descuento');
        await cargarDescuentos();
        renderDescuentos();
      } catch (e) { console.error('Error:', e); alert('Error al guardar'); }
    }

    async function eliminarDescuento() {
      if (!editingDescuentoId || !confirm('¬øEliminar este descuento?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('descuentos').doc(editingDescuentoId).delete();
        cerrarModal('modal-descuento');
        await cargarDescuentos();
        renderDescuentos();
      } catch (e) { console.error('Error:', e); alert('Error al eliminar'); }
    }

    // --- PLAN ---
    function abrirModalPlan(plan = null) {
      editingPlanId = plan?.id || null;
      document.getElementById('modal-plan-titulo').textContent = plan ? 'Editar plan' : 'Nuevo plan';
      document.getElementById('plan-nombre').value = plan?.nombre || '';
      document.getElementById('plan-descripcion').value = plan?.descripcion || '';
      document.getElementById('plan-noches').value = plan?.noches || 0;
      document.getElementById('plan-personas').value = plan?.personas || 0;
      document.getElementById('plan-precio').value = plan?.precio || 0;
      document.getElementById('plan-notas').value = plan?.notas || '';
      document.getElementById('btn-eliminar-plan').style.display = plan ? '' : 'none';

      // Servicios checks
      const checksContainer = document.getElementById('plan-servicios-checks');
      if (serviciosData.length === 0) {
        checksContainer.innerHTML = '<div style="color:var(--text-muted);font-size:0.85rem;">Crea servicios primero</div>';
      } else {
        const seleccionados = plan?.serviciosIncluidos || [];
        checksContainer.innerHTML = serviciosData.map(s => `
          <label style="display:flex;align-items:center;gap:8px;padding:4px 0;cursor:pointer;">
            <input type="checkbox" value="${s.id}" ${seleccionados.includes(s.id) ? 'checked' : ''}>
            <span style="font-size:0.85rem;">${GRUPOS[s.grupo]?.icon || ''} ${s.nombre}</span>
          </label>
        `).join('');
      }

      // Temporadas en select
      const selectTemp = document.getElementById('plan-temporada');
      selectTemp.innerHTML = '<option value="todas">Todas las temporadas</option>';
      temporadasData.forEach((t, i) => {
        if (t.activa && t.nombre) {
          selectTemp.innerHTML += `<option value="${t.nombre}" ${plan?.temporada === t.nombre ? 'selected' : ''}>${t.nombre}</option>`;
        }
      });
      if (plan?.temporada) selectTemp.value = plan.temporada;

      document.getElementById('modal-plan').classList.add('active');
    }

    async function guardarPlan() {
      const serviciosChecks = document.querySelectorAll('#plan-servicios-checks input[type="checkbox"]:checked');
      const data = {
        nombre: document.getElementById('plan-nombre').value.trim(),
        descripcion: document.getElementById('plan-descripcion').value.trim(),
        noches: parseInt(document.getElementById('plan-noches').value) || 0,
        personas: parseInt(document.getElementById('plan-personas').value) || 0,
        precio: parseFloat(document.getElementById('plan-precio').value) || 0,
        temporada: document.getElementById('plan-temporada').value,
        serviciosIncluidos: Array.from(serviciosChecks).map(c => c.value),
        notas: document.getElementById('plan-notas').value.trim()
      };
      if (!data.nombre) { alert('El nombre del plan es obligatorio'); return; }

      try {
        const ref = db.collection('bienes').doc(bienId).collection('planes');
        if (editingPlanId) {
          await ref.doc(editingPlanId).update(data);
        } else {
          await ref.add(data);
        }
        cerrarModal('modal-plan');
        await cargarPlanes();
        renderPlanes();
      } catch (e) { console.error('Error:', e); alert('Error al guardar'); }
    }

    async function eliminarPlan() {
      if (!editingPlanId || !confirm('¬øEliminar este plan?')) return;
      try {
        await db.collection('bienes').doc(bienId).collection('planes').doc(editingPlanId).delete();
        cerrarModal('modal-plan');
        await cargarPlanes();
        renderPlanes();
      } catch (e) { console.error('Error:', e); alert('Error al eliminar'); }
    }

    // ========== HELPERS ==========
    function formatFecha(dateStr) {
      if (!dateStr) return '‚Äî';
      const [y, m, d] = dateStr.split('-');
      const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
      return `${parseInt(d)} ${meses[parseInt(m) - 1]}`;
    }

    // Cerrar modales con click fuera
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
          modal.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>
