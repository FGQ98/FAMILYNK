<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK â€” HuÃ©spedes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --gerente: #2D4A5C;
      --gerente-light: #4A6B7C;
      --gerente-dark: #1D3544;
      --gerente-muted: rgba(45, 74, 92, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --success-muted: rgba(125, 181, 154, 0.15);
      --warning: #E8B44D;
      --warning-muted: rgba(232, 180, 77, 0.15);
      --error: #D4695A;
      --error-muted: rgba(212, 105, 90, 0.15);
      --gold: #B8965C;
      --gold-muted: rgba(184, 150, 92, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem;
      color: white; cursor: pointer; text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title { display: flex; align-items: center; gap: 12px; color: white; }
    .header-icon {
      width: 40px; height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem;
    }
    .header-info h1 { font-family: 'Quicksand', sans-serif; font-size: 1.2rem; font-weight: 700; }
    .header-info p { font-size: 0.8rem; opacity: 0.85; }

    .header-actions { display: flex; gap: 8px; }

    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-primary { background: rgba(255,255,255,0.2); color: white; }
    .btn-primary:hover { background: rgba(255,255,255,0.3); }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

    /* ========== CONTAINER ========== */
    .container { max-width: 1100px; margin: 0 auto; padding: 24px 20px; }

    /* ========== TABS ========== */
    .main-tabs {
      display: flex; gap: 4px;
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 4px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }
    .main-tab {
      flex: 1;
      padding: 12px 16px;
      border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.9rem; font-weight: 600;
      color: var(--text-muted); background: transparent;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .main-tab:hover { color: var(--text); background: var(--cream); }
    .main-tab.active { background: var(--gerente); color: white; }
    .main-tab-count {
      font-size: 0.75rem; padding: 2px 8px;
      background: rgba(0,0,0,0.08); border-radius: 10px;
    }
    .main-tab.active .main-tab-count { background: rgba(255,255,255,0.2); }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ========== BARRA HERRAMIENTAS ========== */
    .toolbar {
      display: flex; gap: 10px; align-items: center;
      flex-wrap: wrap; margin-bottom: 20px;
    }
    .search-box {
      flex: 1; min-width: 200px;
      padding: 10px 14px 10px 36px;
      border: 2px solid var(--cream-dark); border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.9rem;
      background: var(--white); transition: border-color 0.2s;
      position: relative;
    }
    .search-box:focus { outline: none; border-color: var(--gerente); }
    .search-wrapper { position: relative; flex: 1; min-width: 200px; }
    .search-icon {
      position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
      color: var(--text-muted); font-size: 0.9rem; pointer-events: none;
    }
    .filter-select {
      padding: 10px 14px; border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md); font-family: 'Nunito', sans-serif;
      font-size: 0.85rem; background: var(--white); color: var(--text);
      cursor: pointer;
    }
    .filter-select:focus { outline: none; border-color: var(--gerente); }
    .btn-nuevo {
      padding: 10px 18px; background: var(--gerente); color: white;
      border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 700;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    .btn-nuevo:hover { background: var(--gerente-dark); transform: translateY(-1px); }

    /* ========== LISTA HUÃ‰SPEDES ========== */
    .huesped-list { display: flex; flex-direction: column; gap: 8px; }

    .huesped-card {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 18px;
      background: var(--white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-soft);
      cursor: pointer; transition: all 0.2s;
      border-left: 4px solid transparent;
    }
    .huesped-card:hover { transform: translateX(4px); box-shadow: var(--shadow-medium); border-left-color: var(--gerente); }

    .huesped-num {
      font-family: 'Quicksand', sans-serif; font-size: 0.7rem; font-weight: 700;
      color: var(--text-muted); background: var(--cream);
      padding: 4px 8px; border-radius: 6px; white-space: nowrap;
    }
    .huesped-avatar {
      width: 42px; height: 42px; border-radius: 50%;
      background: var(--gerente-muted); color: var(--gerente);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 1rem; flex-shrink: 0;
    }
    .huesped-data { flex: 1; min-width: 0; }
    .huesped-nombre { font-weight: 700; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .huesped-meta { font-size: 0.78rem; color: var(--text-muted); display: flex; gap: 12px; flex-wrap: wrap; margin-top: 2px; }
    .huesped-badge {
      font-size: 0.72rem; font-weight: 600; padding: 3px 10px;
      border-radius: 10px; white-space: nowrap;
    }
    .badge-activo { background: var(--success-muted); color: var(--success); }
    .badge-historico { background: var(--cream-dark); color: var(--text-muted); }
    .badge-vip { background: var(--gold-muted); color: var(--gold); }
    .huesped-estancias {
      font-size: 0.75rem; color: var(--text-muted); text-align: right;
      white-space: nowrap;
    }
    .huesped-estancias strong { color: var(--gerente); }

    .empty-state {
      text-align: center; padding: 60px 20px;
      background: var(--white); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
    }
    .empty-icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-title { font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 700; margin-bottom: 6px; }
    .empty-text { color: var(--text-muted); font-size: 0.9rem; }

    /* ========== STATS ========== */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px; margin-bottom: 24px;
    }
    .stat-card {
      background: var(--white); border-radius: var(--radius-md);
      padding: 16px; text-align: center; box-shadow: var(--shadow-soft);
    }
    .stat-value {
      font-family: 'Quicksand', sans-serif; font-size: 1.8rem; font-weight: 700;
      color: var(--gerente);
    }
    .stat-label { font-size: 0.78rem; color: var(--text-muted); margin-top: 2px; }

    .stats-section {
      background: var(--white); border-radius: var(--radius-lg);
      padding: 20px; box-shadow: var(--shadow-soft); margin-bottom: 16px;
    }
    .stats-section-title {
      font-family: 'Quicksand', sans-serif; font-size: 1rem; font-weight: 700;
      margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
    }

    .ranking-row {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 0; border-bottom: 1px solid var(--cream-dark);
    }
    .ranking-row:last-child { border: none; }
    .ranking-pos {
      width: 26px; height: 26px; border-radius: 50%;
      background: var(--gerente-muted); color: var(--gerente);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem; font-weight: 700; flex-shrink: 0;
    }
    .ranking-pos.top { background: var(--gold-muted); color: var(--gold); }
    .ranking-name { flex: 1; font-size: 0.88rem; font-weight: 600; }
    .ranking-value { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }
    .ranking-bar-bg {
      flex: 1; height: 8px; background: var(--cream-dark);
      border-radius: 4px; overflow: hidden;
    }
    .ranking-bar {
      height: 100%; background: var(--gerente);
      border-radius: 4px; transition: width 0.5s ease;
    }

    .stats-filter-bar {
      display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;
    }
    .stats-filter {
      padding: 6px 14px; border: 2px solid var(--cream-dark);
      border-radius: var(--radius-full); font-family: 'Nunito', sans-serif;
      font-size: 0.8rem; font-weight: 600; background: var(--white);
      color: var(--text-muted); cursor: pointer; transition: all 0.2s;
    }
    .stats-filter:hover { border-color: var(--gerente); color: var(--text); }
    .stats-filter.active { background: var(--gerente); color: white; border-color: var(--gerente); }

    /* ========== MODAL ========== */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 200;
      justify-content: center; align-items: flex-start;
      padding: 20px; overflow-y: auto;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--white); border-radius: var(--radius-xl);
      width: 100%; max-width: 640px;
      box-shadow: var(--shadow-float);
      margin: 20px auto;
      animation: modalIn 0.25s ease;
    }
    @keyframes modalIn { from { opacity: 0; transform: translateY(20px); } }

    .modal-header {
      padding: 20px 24px;
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      display: flex; align-items: center; justify-content: space-between;
      color: white;
    }
    .modal-header h2 {
      font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 700;
      display: flex; align-items: center; gap: 8px;
    }
    .modal-close {
      width: 32px; height: 32px; border-radius: 50%;
      background: rgba(255,255,255,0.2); border: none;
      color: white; font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .modal-close:hover { background: rgba(255,255,255,0.35); }

    .modal-body { padding: 24px; max-height: 65vh; overflow-y: auto; }

    .form-section-title {
      font-family: 'Quicksand', sans-serif; font-size: 0.88rem; font-weight: 700;
      color: var(--gerente); margin: 20px 0 10px 0;
      padding-bottom: 6px; border-bottom: 2px solid var(--gerente-muted);
      display: flex; align-items: center; gap: 6px;
    }
    .form-section-title:first-child { margin-top: 0; }

    .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
    .form-group { flex: 1; }
    .form-group label {
      display: block; font-size: 0.78rem; font-weight: 600;
      color: var(--text-light); margin-bottom: 4px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 9px 12px;
      border: 2px solid var(--cream-dark); border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif; font-size: 0.88rem;
      background: var(--white); color: var(--text); transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: var(--gerente);
    }
    .form-group input:read-only { background: var(--cream); color: var(--text-muted); }
    .form-group textarea { resize: vertical; }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--cream-dark);
      display: flex; justify-content: space-between; align-items: center; gap: 10px;
    }
    .btn-guardar {
      padding: 10px 24px; background: var(--gerente); color: white;
      border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.9rem; font-weight: 700;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-guardar:hover { background: var(--gerente-dark); }
    .btn-cancelar {
      padding: 10px 20px; background: var(--cream); color: var(--text);
      border: 1px solid var(--cream-dark); border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 600;
      cursor: pointer;
    }
    .btn-cancelar:hover { background: var(--cream-dark); }
    .btn-eliminar {
      padding: 8px 14px; background: var(--error-muted); color: var(--error);
      border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.8rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-eliminar:hover { background: var(--error); color: white; }

    /* ========== PERFIL INLINE ========== */
    .perfil-header {
      display: flex; align-items: center; gap: 14px;
      padding: 16px; background: var(--cream); border-radius: var(--radius-md);
      margin-bottom: 16px;
    }
    .perfil-avatar {
      width: 52px; height: 52px; border-radius: 50%;
      background: var(--gerente); color: white;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem; font-weight: 700; flex-shrink: 0;
    }
    .perfil-num { font-size: 0.72rem; color: var(--text-muted); }
    .perfil-nombre { font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 700; }
    .perfil-badges { display: flex; gap: 6px; margin-top: 4px; }
    .perfil-mini-badge {
      font-size: 0.7rem; padding: 2px 8px; border-radius: 8px;
      background: var(--gerente-muted); color: var(--gerente); font-weight: 600;
    }

    /* ========== HISTORIAL ========== */
    .historial-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 0; border-bottom: 1px solid var(--cream-dark);
      font-size: 0.85rem;
    }
    .historial-item:last-child { border: none; }
    .historial-fecha { color: var(--text-muted); min-width: 90px; font-size: 0.8rem; }
    .historial-zona { font-weight: 600; }
    .historial-noches { color: var(--gerente); font-weight: 600; font-size: 0.8rem; }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 640px) {
      .header { padding: 12px 16px; }
      .container { padding: 16px 12px; }
      .form-row { flex-direction: column; gap: 8px; }
      .toolbar { flex-direction: column; }
      .search-wrapper { min-width: 100%; }
      .huesped-card { padding: 12px; gap: 10px; }
      .huesped-meta { flex-direction: column; gap: 2px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .stats-filter-bar { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 4px; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <a href="gerente.html" class="back-btn" id="btn-volver">â† Gerente</a>
      <div class="header-title">
        <div class="header-icon">ğŸ‘¥</div>
        <div class="header-info">
          <h1>HuÃ©spedes</h1>
          <p id="nombre-bien">Cargando...</p>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary btn-sm" onclick="exportarCSV()">ğŸ“¥ Exportar</button>
    </div>
  </header>

  <div class="container">

    <!-- TABS -->
    <div class="main-tabs">
      <button class="main-tab active" data-tab="directorio" onclick="cambiarTab('directorio')">
        ğŸ‘¥ Directorio <span class="main-tab-count" id="count-total">0</span>
      </button>
      <button class="main-tab" data-tab="estadisticas" onclick="cambiarTab('estadisticas')">
        ğŸ“Š EstadÃ­sticas
      </button>
    </div>

    <!-- ==================== TAB DIRECTORIO ==================== -->
    <div class="tab-panel active" id="tab-directorio">
      <div class="toolbar">
        <div class="search-wrapper">
          <span class="search-icon">ğŸ”</span>
          <input type="text" class="search-box" id="search-input" placeholder="Buscar por nombre, documento, nacionalidad..." oninput="filtrarLista()">
        </div>
        <select class="filter-select" id="filtro-estado" onchange="filtrarLista()">
          <option value="todos">Todos</option>
          <option value="activo">Alojados ahora</option>
          <option value="historico">HistÃ³ricos</option>
          <option value="vip">Repetidores</option>
        </select>
        <select class="filter-select" id="filtro-orden" onchange="filtrarLista()">
          <option value="reciente">MÃ¡s recientes</option>
          <option value="nombre">A â†’ Z</option>
          <option value="numeral">NÂº registro</option>
          <option value="estancias">MÃ¡s estancias</option>
        </select>
        <button class="btn-nuevo" onclick="abrirModal()">+ Nuevo huÃ©sped</button>
      </div>

      <div id="huespedes-lista" class="huesped-list"></div>
      <div id="empty-state" class="empty-state" style="display:none;">
        <div class="empty-icon">ğŸ‘¥</div>
        <div class="empty-title">Sin huÃ©spedes registrados</div>
        <div class="empty-text">AÃ±ade el primer huÃ©sped para empezar el directorio</div>
      </div>
    </div>

    <!-- ==================== TAB ESTADÃSTICAS ==================== -->
    <div class="tab-panel" id="tab-estadisticas">

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">Total registrados</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-nacionalidades">0</div>
          <div class="stat-label">Nacionalidades</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-repetidores">0</div>
          <div class="stat-label">Repetidores</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-estancias-media">0</div>
          <div class="stat-label">Media estancias</div>
        </div>
      </div>

      <!-- Ranking nacionalidades -->
      <div class="stats-section">
        <div class="stats-section-title">ğŸŒ Por nacionalidad</div>
        <div id="ranking-nacionalidades"></div>
      </div>

      <!-- Ranking repetidores -->
      <div class="stats-section">
        <div class="stats-section-title">â­ Repetidores (2+ estancias)</div>
        <div id="ranking-repetidores"></div>
      </div>

      <!-- Altas por mes -->
      <div class="stats-section">
        <div class="stats-section-title">ğŸ“… Altas por mes</div>
        <div class="stats-filter-bar" id="filtro-anio"></div>
        <div id="chart-altas-mes"></div>
      </div>

    </div>

  </div>

  <!-- ==================== MODAL HUÃ‰SPED ==================== -->
  <div class="modal-overlay" id="modal-huesped">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-titulo">ğŸ‘¥ Nuevo huÃ©sped</h2>
        <button class="modal-close" onclick="cerrarModal()">âœ•</button>
      </div>
      <div class="modal-body">

        <!-- Perfil header (solo en ediciÃ³n) -->
        <div id="perfil-header-section" style="display:none;"></div>

        <!-- IDENTIFICACIÃ“N -->
        <div class="form-section-title">ğŸªª IdentificaciÃ³n</div>
        <div class="form-row">
          <div class="form-group" style="flex:0 0 90px;">
            <label>NÂº Registro</label>
            <input type="text" id="h-numeral" readonly>
          </div>
          <div class="form-group" style="flex:0 0 120px;">
            <label>Fecha alta</label>
            <input type="date" id="h-fecha-alta" readonly>
          </div>
          <div class="form-group">
            <label>CategorÃ­a</label>
            <select id="h-categoria">
              <option value="titular">Titular</option>
              <option value="acompaÃ±ante">AcompaÃ±ante</option>
              <option value="invitado">Invitado</option>
            </select>
          </div>
        </div>

        <!-- DATOS PERSONALES -->
        <div class="form-section-title">ğŸ‘¤ Datos personales</div>
        <div class="form-row">
          <div class="form-group"><label>Nombre *</label><input type="text" id="h-nombre" required></div>
          <div class="form-group"><label>Primer apellido *</label><input type="text" id="h-apellido1" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Segundo apellido</label><input type="text" id="h-apellido2"></div>
          <div class="form-group" style="flex:0 0 120px;">
            <label>Sexo</label>
            <select id="h-sexo">
              <option value="">â€”</option>
              <option value="M">Masculino</option>
              <option value="F">Femenino</option>
              <option value="O">Otro</option>
            </select>
          </div>
          <div class="form-group">
            <label>Fecha nacimiento</label>
            <input type="date" id="h-nacimiento">
          </div>
        </div>

        <!-- DOCUMENTO -->
        <div class="form-section-title">ğŸ“„ Documento</div>
        <div class="form-row">
          <div class="form-group" style="flex:0 0 150px;">
            <label>Tipo documento *</label>
            <select id="h-doc-tipo">
              <option value="DNI">DNI</option>
              <option value="NIE">NIE</option>
              <option value="Pasaporte">Pasaporte</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div class="form-group">
            <label>NÃºmero *</label>
            <input type="text" id="h-doc-numero" placeholder="12345678A">
          </div>
          <div class="form-group">
            <label>Fecha caducidad</label>
            <input type="date" id="h-doc-caducidad">
          </div>
        </div>

        <!-- NACIONALIDAD / PROCEDENCIA -->
        <div class="form-section-title">ğŸŒ Procedencia</div>
        <div class="form-row">
          <div class="form-group">
            <label>Nacionalidad *</label>
            <select id="h-nacionalidad">
              <option value="">Seleccionar...</option>
              <option value="ES">ğŸ‡ªğŸ‡¸ EspaÃ±a</option>
              <option value="FR">ğŸ‡«ğŸ‡· Francia</option>
              <option value="DE">ğŸ‡©ğŸ‡ª Alemania</option>
              <option value="GB">ğŸ‡¬ğŸ‡§ Reino Unido</option>
              <option value="IT">ğŸ‡®ğŸ‡¹ Italia</option>
              <option value="PT">ğŸ‡µğŸ‡¹ Portugal</option>
              <option value="NL">ğŸ‡³ğŸ‡± PaÃ­ses Bajos</option>
              <option value="BE">ğŸ‡§ğŸ‡ª BÃ©lgica</option>
              <option value="US">ğŸ‡ºğŸ‡¸ Estados Unidos</option>
              <option value="MX">ğŸ‡²ğŸ‡½ MÃ©xico</option>
              <option value="AR">ğŸ‡¦ğŸ‡· Argentina</option>
              <option value="CO">ğŸ‡¨ğŸ‡´ Colombia</option>
              <option value="CL">ğŸ‡¨ğŸ‡± Chile</option>
              <option value="BR">ğŸ‡§ğŸ‡· Brasil</option>
              <option value="CH">ğŸ‡¨ğŸ‡­ Suiza</option>
              <option value="AT">ğŸ‡¦ğŸ‡¹ Austria</option>
              <option value="SE">ğŸ‡¸ğŸ‡ª Suecia</option>
              <option value="NO">ğŸ‡³ğŸ‡´ Noruega</option>
              <option value="DK">ğŸ‡©ğŸ‡° Dinamarca</option>
              <option value="PL">ğŸ‡µğŸ‡± Polonia</option>
              <option value="IE">ğŸ‡®ğŸ‡ª Irlanda</option>
              <option value="JP">ğŸ‡¯ğŸ‡µ JapÃ³n</option>
              <option value="CN">ğŸ‡¨ğŸ‡³ China</option>
              <option value="AU">ğŸ‡¦ğŸ‡º Australia</option>
              <option value="CA">ğŸ‡¨ğŸ‡¦ CanadÃ¡</option>
              <option value="RU">ğŸ‡·ğŸ‡º Rusia</option>
              <option value="MA">ğŸ‡²ğŸ‡¦ Marruecos</option>
              <option value="OTHER">Otra</option>
            </select>
          </div>
          <div class="form-group" id="group-otra-nacionalidad" style="display:none;">
            <label>Especificar</label>
            <input type="text" id="h-otra-nacionalidad" placeholder="PaÃ­s...">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>DirecciÃ³n habitual</label>
            <input type="text" id="h-direccion" placeholder="Calle, nÂº, ciudad, CP">
          </div>
        </div>

        <!-- CONTACTO -->
        <div class="form-section-title">ğŸ“ Contacto</div>
        <div class="form-row">
          <div class="form-group"><label>Email</label><input type="email" id="h-email"></div>
          <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="h-telefono"></div>
        </div>

        <!-- OBSERVACIONES -->
        <div class="form-section-title">ğŸ“ Observaciones</div>
        <div class="form-row">
          <div class="form-group">
            <textarea id="h-notas" rows="3" placeholder="Preferencias, alergias, necesidades especiales..."></textarea>
          </div>
        </div>

        <!-- HISTORIAL (solo en ediciÃ³n) -->
        <div id="historial-section" style="display:none;">
          <div class="form-section-title">ğŸ“… Historial de estancias</div>
          <div id="historial-lista"></div>
        </div>

      </div>
      <div class="modal-footer">
        <div>
          <button class="btn-eliminar" id="btn-eliminar" style="display:none;" onclick="eliminarHuesped()">ğŸ—‘ï¸ Eliminar</button>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
          <button class="btn-guardar" onclick="guardarHuesped()">ğŸ’¾ Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAi_l6yCGiHQ2WQMaS2sVjqJ5VjRrKl_mU",
      authDomain: "familynk-f93e8.firebaseapp.com",
      projectId: "familynk-f93e8",
      storageBucket: "familynk-f93e8.firebasestorage.app",
      messagingSenderId: "271953793018",
      appId: "1:271953793018:web:f7c548f98bda953f8bd498"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let huespedesData = [];
    let editandoId = null;

    // Mapa de paÃ­ses
    const PAISES = {
      ES:'EspaÃ±a', FR:'Francia', DE:'Alemania', GB:'Reino Unido', IT:'Italia',
      PT:'Portugal', NL:'PaÃ­ses Bajos', BE:'BÃ©lgica', US:'Estados Unidos',
      MX:'MÃ©xico', AR:'Argentina', CO:'Colombia', CL:'Chile', BR:'Brasil',
      CH:'Suiza', AT:'Austria', SE:'Suecia', NO:'Noruega', DK:'Dinamarca',
      PL:'Polonia', IE:'Irlanda', JP:'JapÃ³n', CN:'China', AU:'Australia',
      CA:'CanadÃ¡', RU:'Rusia', MA:'Marruecos'
    };

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');
      const origen = params.get('origen') || 'gerente';

      if (!bienId) {
        alert('No se ha especificado el bien');
        window.location.href = 'lo-comun.html';
        return;
      }

      document.getElementById('btn-volver').href = `${origen}.html?id=${bienId}`;
      document.getElementById('btn-volver').textContent = origen === 'bien' ? 'â† Bien' : 'â† Gerente';

      // Mostrar/ocultar "Otra nacionalidad"
      document.getElementById('h-nacionalidad').addEventListener('change', (e) => {
        document.getElementById('group-otra-nacionalidad').style.display =
          e.target.value === 'OTHER' ? '' : 'none';
      });

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await cargarBien();
          await cargarHuespedes();
          renderLista();
          renderStats();
        } else {
          window.location.href = 'login.html';
        }
      });
    });

    // ========== CARGAR DATOS ==========
    async function cargarBien() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (doc.exists) {
          bienData = doc.data();
          document.getElementById('nombre-bien').textContent = bienData.nombre || 'Sin nombre';
        }
      } catch (error) {
        console.error('Error cargando bien:', error);
      }
    }

    async function cargarHuespedes() {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('huespedes')
          .orderBy('numeral', 'desc')
          .get();
        huespedesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        document.getElementById('count-total').textContent = huespedesData.length;
      } catch (error) {
        console.error('Error cargando huÃ©spedes:', error);
        // Si falla por Ã­ndice, cargar sin orden
        try {
          const snap = await db.collection('bienes').doc(bienId).collection('huespedes').get();
          huespedesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          huespedesData.sort((a, b) => (b.numeral || 0) - (a.numeral || 0));
          document.getElementById('count-total').textContent = huespedesData.length;
        } catch (e2) { console.error(e2); }
      }
    }

    // ========== TABS ==========
    function cambiarTab(tab) {
      document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');
      if (tab === 'estadisticas') renderStats();
    }

    // ========== RENDER LISTA ==========
    function filtrarLista() {
      renderLista();
    }

    function renderLista() {
      const container = document.getElementById('huespedes-lista');
      const empty = document.getElementById('empty-state');
      const busqueda = (document.getElementById('search-input').value || '').toLowerCase();
      const filtroEstado = document.getElementById('filtro-estado').value;
      const filtroOrden = document.getElementById('filtro-orden').value;

      let lista = [...huespedesData];

      // Filtro bÃºsqueda
      if (busqueda) {
        lista = lista.filter(h => {
          const nombre = `${h.nombre || ''} ${h.apellido1 || ''} ${h.apellido2 || ''}`.toLowerCase();
          const doc = (h.docNumero || '').toLowerCase();
          const nac = (PAISES[h.nacionalidad] || h.otraNacionalidad || '').toLowerCase();
          return nombre.includes(busqueda) || doc.includes(busqueda) || nac.includes(busqueda);
        });
      }

      // Filtro estado
      if (filtroEstado === 'activo') {
        lista = lista.filter(h => h.estado === 'checkin');
      } else if (filtroEstado === 'historico') {
        lista = lista.filter(h => h.estado !== 'checkin');
      } else if (filtroEstado === 'vip') {
        lista = lista.filter(h => (h.totalEstancias || 0) >= 2);
      }

      // Ordenar
      if (filtroOrden === 'nombre') {
        lista.sort((a, b) => `${a.apellido1} ${a.nombre}`.localeCompare(`${b.apellido1} ${b.nombre}`));
      } else if (filtroOrden === 'numeral') {
        lista.sort((a, b) => (a.numeral || 0) - (b.numeral || 0));
      } else if (filtroOrden === 'estancias') {
        lista.sort((a, b) => (b.totalEstancias || 0) - (a.totalEstancias || 0));
      } else {
        lista.sort((a, b) => {
          const fa = a.fechaAlta ? new Date(a.fechaAlta) : new Date(0);
          const fb = b.fechaAlta ? new Date(b.fechaAlta) : new Date(0);
          return fb - fa;
        });
      }

      if (lista.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      container.innerHTML = lista.map(h => {
        const nombreCompleto = [h.nombre, h.apellido1, h.apellido2].filter(Boolean).join(' ');
        const inicial = (h.nombre || '?').charAt(0).toUpperCase();
        const numStr = String(h.numeral || 0).padStart(3, '0');
        const nac = PAISES[h.nacionalidad] || h.otraNacionalidad || 'â€”';
        const estancias = h.totalEstancias || 0;
        const esRepetidor = estancias >= 2;
        const esActivo = h.estado === 'checkin';

        let badgeClass = 'badge-historico';
        let badgeText = 'HistÃ³rico';
        if (esActivo) { badgeClass = 'badge-activo'; badgeText = 'Alojado'; }
        else if (esRepetidor) { badgeClass = 'badge-vip'; badgeText = `â­ ${estancias}x`; }

        return `
          <div class="huesped-card" onclick="abrirModal('${h.id}')">
            <div class="huesped-num">HUE-${numStr}</div>
            <div class="huesped-avatar">${inicial}</div>
            <div class="huesped-data">
              <div class="huesped-nombre">${nombreCompleto}</div>
              <div class="huesped-meta">
                <span>${h.docTipo || ''} ${h.docNumero || ''}</span>
                <span>ğŸŒ ${nac}</span>
              </div>
            </div>
            <span class="huesped-badge ${badgeClass}">${badgeText}</span>
            <div class="huesped-estancias">
              <strong>${estancias}</strong><br>estancia${estancias !== 1 ? 's' : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // ========== MODAL ==========
    function abrirModal(id = null) {
      editandoId = id;
      const modal = document.getElementById('modal-huesped');
      const titulo = document.getElementById('modal-titulo');
      const btnEliminar = document.getElementById('btn-eliminar');
      const perfilSection = document.getElementById('perfil-header-section');
      const historialSection = document.getElementById('historial-section');

      // Reset
      document.querySelectorAll('#modal-huesped input:not([readonly]), #modal-huesped select, #modal-huesped textarea').forEach(el => {
        if (el.type === 'checkbox') el.checked = false;
        else el.value = el.tagName === 'SELECT' ? el.options[0]?.value || '' : '';
      });
      document.getElementById('group-otra-nacionalidad').style.display = 'none';

      if (id) {
        // EDITAR
        const h = huespedesData.find(x => x.id === id);
        if (!h) return;

        titulo.textContent = 'ğŸ‘¥ Editar huÃ©sped';
        btnEliminar.style.display = '';

        document.getElementById('h-numeral').value = 'HUE-' + String(h.numeral || 0).padStart(3, '0');
        document.getElementById('h-fecha-alta').value = h.fechaAlta || '';
        document.getElementById('h-categoria').value = h.categoria || 'titular';
        document.getElementById('h-nombre').value = h.nombre || '';
        document.getElementById('h-apellido1').value = h.apellido1 || '';
        document.getElementById('h-apellido2').value = h.apellido2 || '';
        document.getElementById('h-sexo').value = h.sexo || '';
        document.getElementById('h-nacimiento').value = h.nacimiento || '';
        document.getElementById('h-doc-tipo').value = h.docTipo || 'DNI';
        document.getElementById('h-doc-numero').value = h.docNumero || '';
        document.getElementById('h-doc-caducidad').value = h.docCaducidad || '';
        document.getElementById('h-nacionalidad').value = h.nacionalidad || '';
        if (h.nacionalidad === 'OTHER') {
          document.getElementById('group-otra-nacionalidad').style.display = '';
          document.getElementById('h-otra-nacionalidad').value = h.otraNacionalidad || '';
        }
        document.getElementById('h-direccion').value = h.direccion || '';
        document.getElementById('h-email').value = h.email || '';
        document.getElementById('h-telefono').value = h.telefono || '';
        document.getElementById('h-notas').value = h.notas || '';

        // Perfil header
        const nombreCompleto = [h.nombre, h.apellido1, h.apellido2].filter(Boolean).join(' ');
        const estancias = h.totalEstancias || 0;
        perfilSection.style.display = '';
        perfilSection.innerHTML = `
          <div class="perfil-header">
            <div class="perfil-avatar">${(h.nombre || '?').charAt(0).toUpperCase()}</div>
            <div>
              <div class="perfil-num">HUE-${String(h.numeral || 0).padStart(3, '0')}</div>
              <div class="perfil-nombre">${nombreCompleto}</div>
              <div class="perfil-badges">
                <span class="perfil-mini-badge">${PAISES[h.nacionalidad] || h.otraNacionalidad || 'â€”'}</span>
                <span class="perfil-mini-badge">${estancias} estancia${estancias !== 1 ? 's' : ''}</span>
                ${estancias >= 2 ? '<span class="perfil-mini-badge" style="background:var(--gold-muted);color:var(--gold);">â­ Repetidor</span>' : ''}
              </div>
            </div>
          </div>
        `;

        // Historial
        renderHistorial(h);

      } else {
        // NUEVO
        titulo.textContent = 'ğŸ‘¥ Nuevo huÃ©sped';
        btnEliminar.style.display = 'none';
        perfilSection.style.display = 'none';
        historialSection.style.display = 'none';

        // Auto numeral
        const maxNum = huespedesData.reduce((max, h) => Math.max(max, h.numeral || 0), 0);
        document.getElementById('h-numeral').value = 'HUE-' + String(maxNum + 1).padStart(3, '0');
        document.getElementById('h-fecha-alta').value = new Date().toISOString().split('T')[0];
      }

      modal.classList.add('active');
    }

    function cerrarModal() {
      document.getElementById('modal-huesped').classList.remove('active');
      editandoId = null;
    }

    function renderHistorial(huesped) {
      const section = document.getElementById('historial-section');
      const lista = document.getElementById('historial-lista');
      const historial = huesped.historialEstancias || [];

      if (historial.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = '';
      lista.innerHTML = historial.sort((a, b) => new Date(b.entrada) - new Date(a.entrada)).map(est => {
        const noches = est.noches || 'â€”';
        return `
          <div class="historial-item">
            <div class="historial-fecha">${est.entrada || 'â€”'}</div>
            <div class="historial-zona">${est.zona || 'General'}</div>
            <div style="flex:1;"></div>
            <div class="historial-noches">${noches} noche${noches !== 1 ? 's' : ''}</div>
          </div>
        `;
      }).join('');
    }

    // ========== GUARDAR ==========
    async function guardarHuesped() {
      const nombre = document.getElementById('h-nombre').value.trim();
      const apellido1 = document.getElementById('h-apellido1').value.trim();

      if (!nombre || !apellido1) {
        alert('Nombre y primer apellido son obligatorios');
        return;
      }

      const docTipo = document.getElementById('h-doc-tipo').value;
      const docNumero = document.getElementById('h-doc-numero').value.trim();
      const nacionalidad = document.getElementById('h-nacionalidad').value;

      if (!docNumero) {
        alert('El nÃºmero de documento es obligatorio');
        return;
      }

      if (!nacionalidad) {
        alert('La nacionalidad es obligatoria');
        return;
      }

      const data = {
        nombre,
        apellido1,
        apellido2: document.getElementById('h-apellido2').value.trim(),
        sexo: document.getElementById('h-sexo').value,
        nacimiento: document.getElementById('h-nacimiento').value,
        categoria: document.getElementById('h-categoria').value,
        docTipo,
        docNumero: docNumero.toUpperCase(),
        docCaducidad: document.getElementById('h-doc-caducidad').value,
        nacionalidad,
        otraNacionalidad: nacionalidad === 'OTHER' ? document.getElementById('h-otra-nacionalidad').value.trim() : '',
        direccion: document.getElementById('h-direccion').value.trim(),
        email: document.getElementById('h-email').value.trim(),
        telefono: document.getElementById('h-telefono').value.trim(),
        notas: document.getElementById('h-notas').value.trim(),
        modificadoPor: currentUser.uid,
        fechaModificacion: new Date().toISOString()
      };

      try {
        const ref = db.collection('bienes').doc(bienId).collection('huespedes');

        if (editandoId) {
          await ref.doc(editandoId).update(data);
          console.log('âœ… HuÃ©sped actualizado:', editandoId);
        } else {
          // Calcular numeral
          const maxNum = huespedesData.reduce((max, h) => Math.max(max, h.numeral || 0), 0);
          data.numeral = maxNum + 1;
          data.fechaAlta = document.getElementById('h-fecha-alta').value;
          data.totalEstancias = 0;
          data.historialEstancias = [];
          data.estado = 'registrado';
          data.creadoPor = currentUser.uid;
          data.fechaCreacion = new Date().toISOString();

          const newDoc = await ref.add(data);
          console.log('âœ… HuÃ©sped creado:', newDoc.id);
        }

        cerrarModal();
        await cargarHuespedes();
        renderLista();
        renderStats();
      } catch (error) {
        console.error('Error guardando huÃ©sped:', error);
        alert('Error al guardar: ' + error.message);
      }
    }

    // ========== ELIMINAR ==========
    async function eliminarHuesped() {
      if (!editandoId) return;
      const h = huespedesData.find(x => x.id === editandoId);
      const nombre = [h?.nombre, h?.apellido1].filter(Boolean).join(' ');

      if (!confirm(`Â¿Eliminar a "${nombre}" del directorio?\n\nEsta acciÃ³n no se puede deshacer.`)) return;

      try {
        await db.collection('bienes').doc(bienId).collection('huespedes').doc(editandoId).delete();
        console.log('ğŸ—‘ï¸ HuÃ©sped eliminado:', editandoId);
        cerrarModal();
        await cargarHuespedes();
        renderLista();
        renderStats();
      } catch (error) {
        console.error('Error eliminando:', error);
        alert('Error al eliminar');
      }
    }

    // ========== ESTADÃSTICAS ==========
    function renderStats() {
      const total = huespedesData.length;
      const nacionalidades = new Set(huespedesData.map(h => h.nacionalidad || 'unknown')).size;
      const repetidores = huespedesData.filter(h => (h.totalEstancias || 0) >= 2).length;
      const totalEstancias = huespedesData.reduce((sum, h) => sum + (h.totalEstancias || 0), 0);
      const media = total > 0 ? (totalEstancias / total).toFixed(1) : '0';

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-nacionalidades').textContent = nacionalidades;
      document.getElementById('stat-repetidores').textContent = repetidores;
      document.getElementById('stat-estancias-media').textContent = media;

      renderRankingNacionalidades();
      renderRankingRepetidores();
      renderAltasMes();
    }

    function renderRankingNacionalidades() {
      const container = document.getElementById('ranking-nacionalidades');
      const conteo = {};
      huespedesData.forEach(h => {
        const nac = PAISES[h.nacionalidad] || h.otraNacionalidad || 'Sin definir';
        conteo[nac] = (conteo[nac] || 0) + 1;
      });

      const ranking = Object.entries(conteo).sort((a, b) => b[1] - a[1]);
      const max = ranking.length > 0 ? ranking[0][1] : 1;

      if (ranking.length === 0) {
        container.innerHTML = '<div style="color:var(--text-muted);font-size:0.85rem;padding:12px 0;">Sin datos</div>';
        return;
      }

      container.innerHTML = ranking.map(([pais, count], i) => `
        <div class="ranking-row">
          <div class="ranking-pos ${i < 3 ? 'top' : ''}">${i + 1}</div>
          <div class="ranking-name">${pais}</div>
          <div class="ranking-bar-bg">
            <div class="ranking-bar" style="width:${(count / max * 100).toFixed(0)}%"></div>
          </div>
          <div class="ranking-value">${count}</div>
        </div>
      `).join('');
    }

    function renderRankingRepetidores() {
      const container = document.getElementById('ranking-repetidores');
      const repetidores = huespedesData
        .filter(h => (h.totalEstancias || 0) >= 2)
        .sort((a, b) => (b.totalEstancias || 0) - (a.totalEstancias || 0));

      if (repetidores.length === 0) {
        container.innerHTML = '<div style="color:var(--text-muted);font-size:0.85rem;padding:12px 0;">AÃºn no hay huÃ©spedes repetidores</div>';
        return;
      }

      const max = repetidores[0].totalEstancias || 1;
      container.innerHTML = repetidores.map((h, i) => {
        const nombre = [h.nombre, h.apellido1].filter(Boolean).join(' ');
        return `
          <div class="ranking-row">
            <div class="ranking-pos ${i < 3 ? 'top' : ''}">${i + 1}</div>
            <div class="ranking-name">${nombre}</div>
            <div class="ranking-bar-bg">
              <div class="ranking-bar" style="width:${((h.totalEstancias || 0) / max * 100).toFixed(0)}%;background:var(--gold);"></div>
            </div>
            <div class="ranking-value">${h.totalEstancias}x</div>
          </div>
        `;
      }).join('');
    }

    function renderAltasMes() {
      const container = document.getElementById('chart-altas-mes');
      const filtroContainer = document.getElementById('filtro-anio');

      // Extraer aÃ±os
      const anios = new Set();
      huespedesData.forEach(h => {
        if (h.fechaAlta) anios.add(new Date(h.fechaAlta).getFullYear());
      });
      const aniosOrdenados = [...anios].sort((a, b) => b - a);

      if (aniosOrdenados.length === 0) {
        filtroContainer.innerHTML = '';
        container.innerHTML = '<div style="color:var(--text-muted);font-size:0.85rem;">Sin datos de altas</div>';
        return;
      }

      const anioActivo = aniosOrdenados[0];
      filtroContainer.innerHTML = aniosOrdenados.map(a =>
        `<button class="stats-filter ${a === anioActivo ? 'active' : ''}" onclick="renderAltasMesAnio(${a})">${a}</button>`
      ).join('');

      renderAltasMesAnio(anioActivo);
    }

    function renderAltasMesAnio(anio) {
      // Update filter buttons
      document.querySelectorAll('#filtro-anio .stats-filter').forEach(b => {
        b.classList.toggle('active', parseInt(b.textContent) === anio);
      });

      const container = document.getElementById('chart-altas-mes');
      const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
      const conteo = new Array(12).fill(0);

      huespedesData.forEach(h => {
        if (h.fechaAlta) {
          const d = new Date(h.fechaAlta);
          if (d.getFullYear() === anio) conteo[d.getMonth()]++;
        }
      });

      const max = Math.max(...conteo, 1);

      container.innerHTML = `
        <div style="display:flex;align-items:flex-end;gap:6px;height:120px;padding-top:10px;">
          ${conteo.map((c, i) => `
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;">
              <div style="font-size:0.7rem;font-weight:600;color:var(--gerente);">${c || ''}</div>
              <div style="width:100%;background:${c > 0 ? 'var(--gerente)' : 'var(--cream-dark)'};border-radius:4px 4px 0 0;height:${Math.max(c / max * 80, 4)}px;transition:height 0.4s;"></div>
              <div style="font-size:0.65rem;color:var(--text-muted);">${meses[i]}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // ========== EXPORTAR CSV ==========
    function exportarCSV() {
      if (huespedesData.length === 0) { alert('No hay datos para exportar'); return; }

      const cabeceras = ['NÂº','Nombre','Apellido1','Apellido2','DocTipo','DocNÃºmero','Nacionalidad','Email','TelÃ©fono','FechaAlta','Estancias'];
      const filas = huespedesData.map(h => [
        h.numeral || '',
        h.nombre || '',
        h.apellido1 || '',
        h.apellido2 || '',
        h.docTipo || '',
        h.docNumero || '',
        PAISES[h.nacionalidad] || h.otraNacionalidad || '',
        h.email || '',
        h.telefono || '',
        h.fechaAlta || '',
        h.totalEstancias || 0
      ]);

      const csv = [cabeceras, ...filas].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `huespedes_${bienData?.nombre || 'bien'}_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Cerrar modal con click fuera
    document.getElementById('modal-huesped').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) cerrarModal();
    });
  </script>
</body>
</html>
