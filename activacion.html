<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Activaci√≥n</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    :root {
      --sage: #7A9E7E; --sage-light: #9BB89E; --sage-dark: #5C7D5F; --sage-muted: rgba(122,158,126,0.15);
      --cream: #FDF8F3; --cream-dark: #F5EDE4;
      --terracotta: #C17757; --terracotta-muted: rgba(193,119,87,0.15);
      --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06); --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-full: 50px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header { background: var(--white); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-soft); position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 32px; }
    .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--sage), var(--sage-light)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .logo-text { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.3rem; color: var(--sage-dark); }
    .header-nav { display: flex; gap: 4px; }
    .nav-link { padding: 8px 14px; border-radius: var(--radius-md); text-decoration: none; font-weight: 600; font-size: 0.85rem; color: var(--text-light); transition: all 0.2s; }
    .nav-link:hover { background: var(--cream); }
    .nav-link.active { background: var(--sage); color: white; }
    .user-menu { display: flex; align-items: center; gap: 10px; padding: 6px 12px 6px 6px; background: var(--cream); border-radius: var(--radius-full); text-decoration: none; color: var(--text); }
    .user-avatar { width: 32px; height: 32px; background: linear-gradient(135deg, var(--sage), var(--sage-light)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85rem; }

    /* Home button */
    .home-btn {
      width: 36px;
      height: 36px;
      background: var(--cream);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
      margin-right: 12px;
    }
    .home-btn:hover { background: var(--sage); }
    .home-btn:hover .home-icon { stroke: white; }
    .home-icon { width: 20px; height: 20px; stroke: var(--text-light); stroke-width: 2; fill: none; transition: stroke 0.2s; }

    .header-right { display: flex; align-items: center; }

    .main { max-width: 1100px; margin: 0 auto; padding: 24px; }

    .page-header { margin-bottom: 24px; }
    .page-title { font-family: 'Quicksand', sans-serif; font-size: 1.6rem; font-weight: 700; display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }
    .page-subtitle { color: var(--text-muted); font-size: 0.9rem; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--cream-dark);
      padding-bottom: 4px;
    }

    .tab {
      padding: 10px 18px;
      background: none;
      border: none;
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab:hover { color: var(--text); background: var(--cream); }
    .tab.active { color: var(--sage-dark); background: var(--sage-muted); }

    /* Tab content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Dashboard grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
    }

    @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title { font-family: 'Quicksand', sans-serif; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .card-body { padding: 20px; }

    /* Calendario mini */
    .calendario-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .calendario-mes { font-weight: 700; }
    .calendario-nav { display: flex; gap: 8px; }
    .calendario-nav button {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--cream);
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      text-align: center;
    }

    .calendario-day-header { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; padding: 4px; }

    .calendario-day {
      padding: 8px 4px;
      font-size: 0.85rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
    }

    .calendario-day:hover { background: var(--cream); }
    .calendario-day.today { background: var(--sage); color: white; font-weight: 700; }
    .calendario-day.has-event { position: relative; }
    .calendario-day.has-event::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      background: var(--terracotta);
      border-radius: 50%;
    }

    /* Lista eventos */
    .eventos-list { display: flex; flex-direction: column; gap: 10px; }

    .evento-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .evento-item:hover { background: var(--cream-dark); }

    .evento-fecha {
      text-align: center;
      min-width: 50px;
    }

    .evento-fecha-dia { font-size: 1.3rem; font-weight: 700; color: var(--sage-dark); }
    .evento-fecha-mes { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }

    .evento-info { flex: 1; }
    .evento-titulo { font-weight: 600; }
    .evento-detalle { font-size: 0.8rem; color: var(--text-muted); }

    .evento-tipo {
      font-size: 1.2rem;
    }

    /* Categor√≠as cards */
    .categorias-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }

    .categoria-card {
      background: var(--white);
      border-radius: var(--radius-md);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: var(--text);
    }

    .categoria-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-float); }
    .categoria-icon { font-size: 2rem; margin-bottom: 10px; }
    .categoria-nombre { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }
    .categoria-desc { font-size: 0.75rem; color: var(--text-muted); }

    /* Herramientas */
    .herramientas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .herramienta-card {
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: var(--text);
    }

    .herramienta-card:hover { background: var(--sage); color: white; }
    .herramienta-icon { font-size: 1.8rem; margin-bottom: 8px; }
    .herramienta-nombre { font-weight: 600; font-size: 0.85rem; }

    /* Invitaciones */
    .invitar-form {
      max-width: 500px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--sage);
      box-shadow: 0 0 0 3px var(--sage-muted);
    }

    .form-input-group {
      display: flex;
      gap: 8px;
    }

    .form-input-group .form-input {
      flex: 1;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--sage);
      color: white;
    }

    .btn-primary:hover {
      background: var(--sage-dark);
    }

    .btn-primary:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--cream-dark);
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 0.8rem;
    }

    .password-display {
      background: var(--cream);
      padding: 14px 18px;
      border-radius: var(--radius-md);
      font-family: monospace;
      font-size: 1.1rem;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .alert {
      padding: 14px 18px;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .alert-success {
      background: rgba(122, 158, 126, 0.15);
      color: var(--sage-dark);
      border: 1px solid var(--sage);
    }

    .alert-error {
      background: rgba(193, 119, 87, 0.15);
      color: #a84a32;
      border: 1px solid var(--terracotta);
    }

    .invitaciones-list {
      margin-top: 24px;
    }

    .invitacion-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
    }

    .invitacion-email {
      font-weight: 600;
    }

    .invitacion-fecha {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .invitacion-estado {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .invitacion-estado.pendiente {
      background: rgba(193, 119, 87, 0.15);
      color: var(--terracotta);
    }

    .invitacion-estado.activado {
      background: var(--sage-muted);
      color: var(--sage-dark);
    }

    .hidden { display: none !important; }

    .empty-state { text-align: center; padding: 30px; color: var(--text-muted); }
    .empty-icon { font-size: 2.5rem; opacity: 0.4; margin-bottom: 10px; }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: none; text-decoration: none; }
    .btn-sm { padding: 6px 10px; font-size: 0.75rem; }
    .btn-primary { background: var(--sage); color: white; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="cgi.html" class="logo"><div class="logo-icon">ü™∫</div><span class="logo-text">FAMILYNK</span></a>
      <nav class="header-nav">
        <a href="mi-nido.html" class="nav-link">Mi Nido</a>
        <a href="arbol.html" class="nav-link">√Årbol</a>
        <a href="lo-comun.html" class="nav-link">Lo Com√∫n</a>
        <a href="legado.html" class="nav-link">Legado</a>
        <a href="cerebro.html" class="nav-link">Cerebro</a>
        <a href="activacion.html" class="nav-link active">Activaci√≥n</a>
      </nav>
    </div>
    <div class="header-right">
      <a href="index.html" class="home-btn" title="Inicio">
        <svg class="home-icon" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <polygon points="12,2 14,10 12,12 10,10" fill="currentColor" stroke="none"/>
          <polygon points="12,22 10,14 12,12 14,14" fill="#C17757" stroke="none"/>
          <circle cx="12" cy="12" r="2"/>
        </svg>
      </a>
      <a href="cgi.html" class="user-menu">
        <div class="user-avatar" id="user-avatar">?</div>
        <span id="user-name">...</span>
      </a>
    </div>
  </header>

  <main class="main">
    <div class="page-header">
      <h1 class="page-title">üéØ Activaci√≥n</h1>
      <p class="page-subtitle">Calendario, iniciativas, hitos y herramientas para la familia</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="cambiarTab('calendario')">üìÖ Calendario</button>
      <button class="tab" onclick="cambiarTab('invitar')">üë• Invitar</button>
      <button class="tab" onclick="cambiarTab('iniciativas')">üéØ Iniciativas</button>
      <button class="tab" onclick="cambiarTab('hitos')">üéâ Hitos</button>
      <button class="tab" onclick="cambiarTab('herramientas')">üõ†Ô∏è Herramientas</button>
    </div>

    <!-- CALENDARIO -->
    <div class="tab-content active" id="tab-calendario">
      <div class="dashboard-grid">
        <div class="main-col">
          <div class="card">
            <div class="card-header">
              <span class="card-title">üìÖ Pr√≥ximos eventos</span>
              <button class="btn btn-sm btn-primary">+ Evento</button>
            </div>
            <div class="card-body">
              <div class="eventos-list" id="eventos-list">
                <div class="empty-state">
                  <div class="empty-icon">üìÖ</div>
                  <p>No hay eventos pr√≥ximos</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar-col">
          <div class="card">
            <div class="card-body">
              <div class="calendario-header">
                <span class="calendario-mes" id="calendario-mes">Diciembre 2025</span>
                <div class="calendario-nav">
                  <button onclick="cambiarMes(-1)">‚óÄ</button>
                  <button onclick="cambiarMes(1)">‚ñ∂</button>
                </div>
              </div>
              <div class="calendario-grid" id="calendario-grid">
                <div class="calendario-day-header">L</div>
                <div class="calendario-day-header">M</div>
                <div class="calendario-day-header">X</div>
                <div class="calendario-day-header">J</div>
                <div class="calendario-day-header">V</div>
                <div class="calendario-day-header">S</div>
                <div class="calendario-day-header">D</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- INVITAR -->
    <div class="tab-content" id="tab-invitar">
      <div class="dashboard-grid">
        <div class="main-col">
          <div class="card">
            <div class="card-header">
              <span class="card-title">‚úâÔ∏è Invitar nuevo miembro</span>
            </div>
            <div class="card-body">
              <div id="invitar-alert" class="alert hidden"></div>
              
              <form class="invitar-form" id="invitar-form" onsubmit="enviarInvitacion(event)">
                <div class="form-group">
                  <label class="form-label">Email del invitado *</label>
                  <input type="email" class="form-input" id="invitado-email" placeholder="correo@ejemplo.com" required>
                </div>

                <div class="form-group">
                  <label class="form-label">Contrase√±a provisional</label>
                  <div class="form-input-group">
                    <div class="password-display">
                      <span id="password-generada">--------</span>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="generarPassword()">üîÑ Nueva</button>
                    <button type="button" class="btn btn-secondary" onclick="copiarPassword()">üìã</button>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Nombre del invitado (opcional)</label>
                  <input type="text" class="form-input" id="invitado-nombre" placeholder="Nombre para el email">
                </div>

                <button type="submit" class="btn btn-primary" id="btn-enviar">
                  <span id="btn-enviar-texto">‚úâÔ∏è Enviar invitaci√≥n</span>
                </button>
              </form>
            </div>
          </div>

          <!-- Historial de invitaciones -->
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <span class="card-title">üìã Invitaciones enviadas</span>
            </div>
            <div class="card-body">
              <div id="invitaciones-list">
                <div class="empty-state">
                  <div class="empty-icon">üì≠</div>
                  <p>No hay invitaciones enviadas</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar-col">
          <div class="card">
            <div class="card-header">
              <span class="card-title">‚ÑπÔ∏è C√≥mo funciona</span>
            </div>
            <div class="card-body" style="font-size: 0.9rem; color: var(--text-light);">
              <p style="margin-bottom: 12px;"><strong>1.</strong> Introduce el email del familiar que quieres invitar.</p>
              <p style="margin-bottom: 12px;"><strong>2.</strong> Se genera una contrase√±a provisional autom√°ticamente.</p>
              <p style="margin-bottom: 12px;"><strong>3.</strong> Al pulsar "Enviar", el invitado recibe un email con sus credenciales.</p>
              <p><strong>4.</strong> En su primer acceso, el sistema le pedir√° cambiar la contrase√±a.</p>
            </div>
          </div>

          <div class="card" style="margin-top: 16px;">
            <div class="card-header">
              <span class="card-title">üìä Resumen</span>
            </div>
            <div class="card-body">
              <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--sage);" id="stat-enviadas">0</div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">Enviadas</div>
                </div>
                <div>
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--terracotta);" id="stat-pendientes">0</div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">Pendientes</div>
                </div>
                <div>
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--sage-dark);" id="stat-activos">0</div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">Activos</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- INICIATIVAS -->
    <div class="tab-content" id="tab-iniciativas">
      <div class="categorias-grid">
        <a href="iniciativas-quedadas.html" class="categoria-card">
          <div class="categoria-icon">üçª</div>
          <div class="categoria-nombre">Quedadas</div>
          <div class="categoria-desc">Reuniones informales</div>
        </a>
        <a href="iniciativas-eventos.html" class="categoria-card">
          <div class="categoria-icon">üé™</div>
          <div class="categoria-nombre">Eventos</div>
          <div class="categoria-desc">Actividades organizadas</div>
        </a>
        <a href="iniciativas-retos.html" class="categoria-card">
          <div class="categoria-icon">üèÜ</div>
          <div class="categoria-nombre">Retos</div>
          <div class="categoria-desc">Desaf√≠os familiares</div>
        </a>
        <a href="iniciativas-viajes.html" class="categoria-card">
          <div class="categoria-icon">‚úàÔ∏è</div>
          <div class="categoria-nombre">Viajes</div>
          <div class="categoria-desc">Escapadas y vacaciones</div>
        </a>
      </div>
    </div>

    <!-- HITOS -->
    <div class="tab-content" id="tab-hitos">
      <div class="categorias-grid">
        <a href="hitos-cumples.html" class="categoria-card">
          <div class="categoria-icon">üéÇ</div>
          <div class="categoria-nombre">Cumplea√±os</div>
          <div class="categoria-desc">Pr√≥ximos cumples</div>
        </a>
        <a href="hitos-celebraciones.html" class="categoria-card">
          <div class="categoria-icon">üéä</div>
          <div class="categoria-nombre">Celebraciones</div>
          <div class="categoria-desc">Bodas, bautizos, etc.</div>
        </a>
        <a href="hitos-especiales.html" class="categoria-card">
          <div class="categoria-icon">‚≠ê</div>
          <div class="categoria-nombre">D√≠as Especiales</div>
          <div class="categoria-desc">Aniversarios, santos</div>
        </a>
        <a href="hitos-torneos.html" class="categoria-card">
          <div class="categoria-icon">üèÖ</div>
          <div class="categoria-nombre">Torneos</div>
          <div class="categoria-desc">Competiciones familiares</div>
        </a>
      </div>
    </div>

    <!-- HERRAMIENTAS -->
    <div class="tab-content" id="tab-herramientas">
      <div class="herramientas-grid">
        <a href="herramienta-botes.html" class="herramienta-card">
          <div class="herramienta-icon">ü´ô</div>
          <div class="herramienta-nombre">Botes</div>
        </a>
        <a href="herramienta-porras.html" class="herramienta-card">
          <div class="herramienta-icon">üé≤</div>
          <div class="herramienta-nombre">Porras</div>
        </a>
        <a href="herramienta-amigo.html" class="herramienta-card">
          <div class="herramienta-icon">üéÅ</div>
          <div class="herramienta-nombre">Amigo Invisible</div>
        </a>
        <a href="herramienta-encuestas.html" class="herramienta-card">
          <div class="herramienta-icon">üìä</div>
          <div class="herramienta-nombre">Encuestas</div>
        </a>
        <a href="herramienta-votaciones.html" class="herramienta-card">
          <div class="herramienta-icon">üó≥Ô∏è</div>
          <div class="herramienta-nombre">Votaciones</div>
        </a>
        <a href="herramienta-listas.html" class="herramienta-card">
          <div class="herramienta-icon">üìã</div>
          <div class="herramienta-nombre">Listas</div>
        </a>
      </div>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ============ EMAILJS CONFIG ============
    emailjs.init('eWMtiJpUqrLsA5Nel');
    const EMAILJS_SERVICE = 'service_fcfx5od';
    const EMAILJS_TEMPLATE = 'template_my2n26t';

    let mesActual = new Date();
    let currentUser = null;
    let userData = null;
    let familiaData = null;

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }

      currentUser = user;
      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists) return;
      userData = userDoc.data();

      // Cargar datos de la familia
      if (userData.familiaId) {
        const familiaDoc = await db.collection('familias').doc(userData.familiaId).get();
        if (familiaDoc.exists) {
          familiaData = { id: familiaDoc.id, ...familiaDoc.data() };
        }
      }

      const nombre = userData.nombre || user.email.split('@')[0];
      document.getElementById('user-name').textContent = nombre.split(' ')[0];
      document.getElementById('user-avatar').textContent = nombre.charAt(0).toUpperCase();

      renderCalendario();
      generarPassword();
      cargarInvitaciones();
    });

    function cambiarTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    // ============ INVITACIONES ============
    function generarPassword() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
      let password = '';
      for (let i = 0; i < 8; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('password-generada').textContent = password;
      return password;
    }

    function copiarPassword() {
      const password = document.getElementById('password-generada').textContent;
      navigator.clipboard.writeText(password).then(() => {
        mostrarAlerta('Contrase√±a copiada al portapapeles', 'success');
      });
    }

    function mostrarAlerta(mensaje, tipo) {
      const alert = document.getElementById('invitar-alert');
      alert.textContent = mensaje;
      alert.className = `alert alert-${tipo}`;
      alert.classList.remove('hidden');
      
      setTimeout(() => {
        alert.classList.add('hidden');
      }, 5000);
    }

    async function enviarInvitacion(event) {
      event.preventDefault();
      
      const email = document.getElementById('invitado-email').value.trim();
      const password = document.getElementById('password-generada').textContent;
      const nombreInvitado = document.getElementById('invitado-nombre').value.trim() || 'Nuevo miembro';
      const btn = document.getElementById('btn-enviar');
      const btnTexto = document.getElementById('btn-enviar-texto');

      if (!email) {
        mostrarAlerta('Introduce un email v√°lido', 'error');
        return;
      }

      if (password === '--------') {
        mostrarAlerta('Genera una contrase√±a primero', 'error');
        return;
      }

      // Deshabilitar bot√≥n
      btn.disabled = true;
      btnTexto.textContent = '‚è≥ Enviando...';

      try {
        // 1. Crear usuario en Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const nuevoUsuarioId = userCredential.user.uid;

        // 2. Crear documento de usuario en Firestore
        await db.collection('usuarios').doc(nuevoUsuarioId).set({
          email: email,
          nombre: nombreInvitado,
          familiaId: userData.familiaId,
          requiereCambioPassword: true,
          invitadoPor: currentUser.uid,
          fechaInvitacion: firebase.firestore.FieldValue.serverTimestamp(),
          activo: false
        });

        // 3. Enviar email con EmailJS
        const templateParams = {
          email: email,
          passcode: password,
          familia_nombre: familiaData?.nombre || 'Tu familia',
          admin_nombre: userData.nombre || 'El administrador'
        };

        await emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, templateParams);

        // 4. Registrar invitaci√≥n en Firestore
        await db.collection('invitaciones-email').add({
          email: email,
          usuarioId: nuevoUsuarioId,
          familiaId: userData.familiaId,
          invitadoPor: currentUser.uid,
          fechaEnvio: firebase.firestore.FieldValue.serverTimestamp(),
          estado: 'pendiente'
        });

        // 5. Cerrar sesi√≥n del usuario reci√©n creado y volver a logear al admin
        await auth.signOut();
        // El admin tendr√° que volver a iniciar sesi√≥n... 
        // Mejor opci√≥n: usar Admin SDK en backend, pero para MVP esto funciona
        
        mostrarAlerta(`‚úÖ Invitaci√≥n enviada a ${email}`, 'success');
        document.getElementById('invitar-form').reset();
        generarPassword();
        
        // Recargar p√°gina para que el admin vuelva a logear
        setTimeout(() => {
          window.location.reload();
        }, 2000);

      } catch (error) {
        console.error('Error:', error);
        
        if (error.code === 'auth/email-already-in-use') {
          mostrarAlerta('Este email ya est√° registrado', 'error');
        } else if (error.code === 'auth/invalid-email') {
          mostrarAlerta('Email no v√°lido', 'error');
        } else {
          mostrarAlerta(`Error: ${error.message}`, 'error');
        }
      } finally {
        btn.disabled = false;
        btnTexto.textContent = '‚úâÔ∏è Enviar invitaci√≥n';
      }
    }

    async function cargarInvitaciones() {
      if (!userData?.familiaId) return;

      try {
        const snap = await db.collection('invitaciones-email')
          .where('familiaId', '==', userData.familiaId)
          .orderBy('fechaEnvio', 'desc')
          .limit(20)
          .get();

        const container = document.getElementById('invitaciones-list');
        
        if (snap.empty) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üì≠</div>
              <p>No hay invitaciones enviadas</p>
            </div>
          `;
          return;
        }

        let enviadas = 0, pendientes = 0, activos = 0;
        let html = '';

        snap.forEach(doc => {
          const inv = doc.data();
          enviadas++;
          if (inv.estado === 'pendiente') pendientes++;
          if (inv.estado === 'activado') activos++;

          const fecha = inv.fechaEnvio?.toDate();
          const fechaStr = fecha ? fecha.toLocaleDateString('es-ES') : '-';

          html += `
            <div class="invitacion-item">
              <div>
                <div class="invitacion-email">${inv.email}</div>
                <div class="invitacion-fecha">Enviada: ${fechaStr}</div>
              </div>
              <span class="invitacion-estado ${inv.estado}">${inv.estado === 'pendiente' ? '‚è≥ Pendiente' : '‚úÖ Activado'}</span>
            </div>
          `;
        });

        container.innerHTML = html;
        document.getElementById('stat-enviadas').textContent = enviadas;
        document.getElementById('stat-pendientes').textContent = pendientes;
        document.getElementById('stat-activos').textContent = activos;

      } catch (error) {
        console.error('Error cargando invitaciones:', error);
      }
    }

    // ============ CALENDARIO ============
    function cambiarMes(delta) {
      mesActual.setMonth(mesActual.getMonth() + delta);
      renderCalendario();
    }

    function renderCalendario() {
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      document.getElementById('calendario-mes').textContent = `${meses[mesActual.getMonth()]} ${mesActual.getFullYear()}`;

      const grid = document.getElementById('calendario-grid');
      
      // Headers
      let html = `
        <div class="calendario-day-header">L</div>
        <div class="calendario-day-header">M</div>
        <div class="calendario-day-header">X</div>
        <div class="calendario-day-header">J</div>
        <div class="calendario-day-header">V</div>
        <div class="calendario-day-header">S</div>
        <div class="calendario-day-header">D</div>
      `;

      const primerDia = new Date(mesActual.getFullYear(), mesActual.getMonth(), 1);
      const ultimoDia = new Date(mesActual.getFullYear(), mesActual.getMonth() + 1, 0);
      
      let diaInicio = primerDia.getDay();
      if (diaInicio === 0) diaInicio = 7;
      diaInicio--;

      // D√≠as vac√≠os antes
      for (let i = 0; i < diaInicio; i++) {
        html += '<div class="calendario-day"></div>';
      }

      // D√≠as del mes
      const hoy = new Date();
      for (let d = 1; d <= ultimoDia.getDate(); d++) {
        const esHoy = d === hoy.getDate() && mesActual.getMonth() === hoy.getMonth() && mesActual.getFullYear() === hoy.getFullYear();
        html += `<div class="calendario-day ${esHoy ? 'today' : ''}">${d}</div>`;
      }

      grid.innerHTML = html;
    }
  </script>
</body>
</html>
