<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Confirmar Asistencia</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;

      --asistencia: #9C27B0;
      --asistencia-muted: rgba(156, 39, 176, 0.1);
      --confirmado: #4CAF50;
      --rechazado: #F44336;
      --pendiente: #FF9800;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--asistencia) 0%, #7B1FA2 100%);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: white;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: rgba(255,255,255,0.3); }

    .header-title { display: flex; align-items: center; gap: 10px; color: white; }
    .header-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }
    .header-info h1 { font-family: 'Quicksand', sans-serif; font-size: 1.2rem; font-weight: 700; }
    .header-info p { font-size: 0.75rem; opacity: 0.9; }

    .btn-nueva {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      background: white;
      border: none;
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--asistencia);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-nueva:hover { transform: scale(1.05); box-shadow: var(--shadow-medium); }

    /* Main */
    .main { max-width: 800px; margin: 0 auto; padding: 20px; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      background: var(--white);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
    }

    .tab-btn {
      flex: 1;
      padding: 12px;
      border: none;
      background: none;
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:hover { background: var(--cream); }
    .tab-btn.active { background: var(--asistencia); color: white; }

    /* Convocatorias list */
    .convocatorias-list { display: flex; flex-direction: column; gap: 12px; }

    .convocatoria-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      border-left: 4px solid var(--asistencia);
      transition: all 0.2s;
    }

    .convocatoria-card:hover {
      box-shadow: var(--shadow-medium);
    }

    .convocatoria-card.pasada {
      opacity: 0.6;
      border-left-color: var(--text-muted);
    }

    .convocatoria-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .convocatoria-titulo {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .convocatoria-estado {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 700;
    }

    .convocatoria-estado.pendiente { background: rgba(255, 152, 0, 0.15); color: var(--pendiente); }
    .convocatoria-estado.confirmado { background: rgba(76, 175, 80, 0.15); color: var(--confirmado); }
    .convocatoria-estado.rechazado { background: rgba(244, 67, 54, 0.15); color: var(--rechazado); }
    .convocatoria-estado.pasada { background: var(--cream-dark); color: var(--text-muted); }

    .convocatoria-fecha {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .convocatoria-fecha span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .convocatoria-lugar {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .convocatoria-notas {
      font-size: 0.85rem;
      color: var(--text-light);
      background: var(--cream);
      padding: 10px;
      border-radius: var(--radius-sm);
      margin-bottom: 12px;
    }

    .convocatoria-autor {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    /* Acciones */
    .convocatoria-acciones {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-size: 0.85rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-confirmar { background: var(--confirmado); color: white; }
    .btn-confirmar:hover { background: #43A047; }
    .btn-rechazar { background: var(--cream); color: var(--rechazado); border: 2px solid var(--rechazado); }
    .btn-rechazar:hover { background: rgba(244, 67, 54, 0.1); }
    .btn-secondary { background: var(--cream); color: var(--text); }
    .btn-secondary:hover { background: var(--cream-dark); }

    /* Resumen de asistencia */
    .asistencia-resumen {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--cream-dark);
    }

    .asistencia-grupo {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }

    .asistencia-count {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.75rem;
    }

    .asistencia-count.confirmados { background: rgba(76, 175, 80, 0.15); color: var(--confirmado); }
    .asistencia-count.rechazados { background: rgba(244, 67, 54, 0.15); color: var(--rechazado); }
    .asistencia-count.pendientes { background: rgba(255, 152, 0, 0.15); color: var(--pendiente); }

    /* Lista de confirmados expandible */
    .confirmados-lista {
      margin-top: 12px;
      padding: 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }

    .confirmados-titulo {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-light);
    }

    .confirmado-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--white);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      margin: 2px;
    }

    .confirmado-item.si { border-left: 3px solid var(--confirmado); }
    .confirmado-item.no { border-left: 3px solid var(--rechazado); }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
    .empty-state-title { font-family: 'Quicksand', sans-serif; font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; color: var(--text-light); }
    .empty-state-text { font-size: 0.9rem; margin-bottom: 20px; }

    /* Detalle convocatoria (cuando viene de notificaci√≥n) */
    .convocatoria-detalle {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-medium);
      border-top: 4px solid var(--asistencia);
    }

    .detalle-titulo {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
    }

    .detalle-info {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .detalle-row {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1rem;
    }

    .detalle-icon {
      width: 40px;
      height: 40px;
      background: var(--asistencia-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .detalle-acciones {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .detalle-acciones .btn {
      padding: 14px 28px;
      font-size: 1rem;
    }

    .ya-respondido {
      text-align: center;
      padding: 20px;
      background: var(--cream);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
    }

    .ya-respondido.confirmado { color: var(--confirmado); }
    .ya-respondido.rechazado { color: var(--rechazado); }

    /* Loading */
    .loading { display: flex; align-items: center; justify-content: center; min-height: 200px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--asistencia); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* Responsive */
    @media (max-width: 600px) {
      .convocatoria-acciones { flex-direction: column; }
      .asistencia-resumen { flex-wrap: wrap; }
      .detalle-acciones { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="activacion.html" class="back-btn">‚Üê Activaci√≥n</a>
      <div class="header-title">
        <div class="header-icon">‚úã</div>
        <div class="header-info">
          <h1>Confirmar Asistencia</h1>
          <p id="contador">Cargando...</p>
        </div>
      </div>
    </div>
    <button class="btn-nueva" onclick="abrirModalConvocatoria()">
      + Nueva convocatoria
    </button>
  </header>

  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>

    <!-- Vista de detalle (cuando viene de notificaci√≥n) -->
    <div id="detalle-view" class="hidden">
      <div class="convocatoria-detalle">
        <div class="detalle-titulo" id="detalle-titulo"></div>
        <div class="detalle-info" id="detalle-info"></div>
        <div id="detalle-respuesta"></div>
      </div>
    </div>

    <!-- Vista de lista -->
    <div id="lista-view" class="hidden">
      <div class="tabs">
        <button class="tab-btn active" data-tab="pendientes" onclick="cambiarTab('pendientes')">‚è≥ Pendientes</button>
        <button class="tab-btn" data-tab="mis" onclick="cambiarTab('mis')">üì§ Mis convocatorias</button>
        <button class="tab-btn" data-tab="todas" onclick="cambiarTab('todas')">üìã Historial</button>
      </div>

      <div class="convocatorias-list" id="convocatorias-list"></div>

      <div class="empty-state hidden" id="empty-state">
        <div class="empty-state-icon">‚úã</div>
        <div class="empty-state-title">Sin convocatorias</div>
        <div class="empty-state-text">No hay convocatorias pendientes de confirmar</div>
      </div>
    </div>
  </main>

  <!-- Modal Nueva Convocatoria -->
  <div class="modal-overlay" id="modal-convocatoria">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">‚úã Nueva Convocatoria</h3>
        <button class="modal-close" onclick="cerrarModal()">√ó</button>
      </div>
      <form id="form-convocatoria" onsubmit="guardarConvocatoria(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">T√≠tulo del evento *</label>
            <input type="text" class="form-input" id="conv-titulo" required placeholder="Ej: Cena de Navidad">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha *</label>
              <input type="date" class="form-input" id="conv-fecha" required>
            </div>
            <div class="form-group">
              <label class="form-label">Hora</label>
              <input type="time" class="form-input" id="conv-hora">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Lugar</label>
            <input type="text" class="form-input" id="conv-lugar" placeholder="Ej: Casa de los abuelos">
          </div>
          <div class="form-group">
            <label class="form-label">Notas adicionales</label>
            <textarea class="form-input" id="conv-notas" rows="2" placeholder="Informaci√≥n extra..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Enviar a *</label>
            <div class="destinatarios-opciones">
              <label class="destinatario-option">
                <input type="radio" name="destino" value="todos" checked onchange="toggleDestinatarios()">
                <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Toda la familia</span>
              </label>
              <label class="destinatario-option">
                <input type="radio" name="destino" value="seleccionar" onchange="toggleDestinatarios()">
                <span>‚úã Seleccionar miembros</span>
              </label>
            </div>
            <div id="lista-miembros" class="lista-miembros hidden"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="btn-crear">Crear convocatoria</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      padding: 20px;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
      transform: translateY(20px);
      transition: transform 0.2s;
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--asistencia);
    }
    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--cream);
      border-radius: var(--radius-sm);
      font-size: 1.2rem;
      cursor: pointer;
    }
    .modal-body { padding: 20px; overflow-y: auto; max-height: 60vh; }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--cream-dark);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }
    .form-input:focus { outline: none; border-color: var(--asistencia); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn {
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--asistencia); color: white; }
    .btn-primary:hover { background: #7B1FA2; }
    .btn-primary:disabled { background: var(--text-muted); cursor: not-allowed; }
    .btn-secondary { background: var(--cream); color: var(--text); }
    .btn-secondary:hover { background: var(--cream-dark); }
    .destinatarios-opciones { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .destinatario-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }
    .destinatario-option:has(input:checked) { background: var(--asistencia-muted); border: 2px solid var(--asistencia); }
    .destinatario-option input { margin: 0; }
    .lista-miembros {
      max-height: 200px;
      overflow-y: auto;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      padding: 8px;
    }
    .miembro-check {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.2s;
    }
    .miembro-check:hover { background: var(--cream); }
    .miembro-check input { margin: 0; width: 18px; height: 18px; }
    .miembro-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--asistencia), #7B1FA2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.8rem;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let userData = null;
    let convocatorias = [];
    let tabActual = 'pendientes';
    let convocatoriaId = null;

    // Obtener ID de URL si viene de notificaci√≥n
    const urlParams = new URLSearchParams(window.location.search);
    convocatoriaId = urlParams.get('id');

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;

      try {
        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        if (userDoc.exists) {
          userData = userDoc.data();
        }

        if (convocatoriaId) {
          // Vista de detalle para responder
          await cargarDetalle();
        } else {
          // Vista de lista
          await cargarMiembros();
          await cargarConvocatorias();
          document.getElementById('lista-view').classList.remove('hidden');
        }

      } catch (e) {
        console.error('Error:', e);
      }

      document.getElementById('loading').classList.add('hidden');
    });

    async function cargarDetalle() {
      try {
        const doc = await db.collection('convocatorias').doc(convocatoriaId).get();
        
        if (!doc.exists) {
          alert('Convocatoria no encontrada');
          window.location.href = 'herramienta-asistencia.html';
          return;
        }

        const c = doc.data();
        const hoy = new Date();
        const fechaEvento = new Date(c.fecha);
        const pasada = fechaEvento < hoy;

        document.getElementById('detalle-titulo').textContent = c.titulo;

        // Info
        let infoHTML = `
          <div class="detalle-row">
            <div class="detalle-icon">üìÖ</div>
            <div>
              <strong>${formatearFecha(c.fecha)}</strong>
              ${c.hora ? ' a las ' + c.hora : ''}
            </div>
          </div>
        `;

        if (c.lugar) {
          infoHTML += `
            <div class="detalle-row">
              <div class="detalle-icon">üìç</div>
              <div>${c.lugar}</div>
            </div>
          `;
        }

        if (c.notas) {
          infoHTML += `
            <div class="detalle-row">
              <div class="detalle-icon">üìù</div>
              <div>${c.notas}</div>
            </div>
          `;
        }

        infoHTML += `
          <div class="detalle-row">
            <div class="detalle-icon">üë§</div>
            <div>Organiza: ${c.creadoPorNombre}</div>
          </div>
        `;

        document.getElementById('detalle-info').innerHTML = infoHTML;

        // Respuesta
        const yaConfirmado = c.confirmados?.includes(currentUser.uid);
        const yaRechazado = c.rechazados?.includes(currentUser.uid);

        let respuestaHTML = '';

        if (pasada) {
          respuestaHTML = `<div class="ya-respondido">Esta convocatoria ya ha pasado</div>`;
        } else if (yaConfirmado) {
          respuestaHTML = `
            <div class="ya-respondido confirmado">
              ‚úÖ Has confirmado tu asistencia
            </div>
            <div class="detalle-acciones" style="margin-top: 12px;">
              <button class="btn btn-rechazar" onclick="cambiarRespuesta('${convocatoriaId}', 'rechazar')">Cambiar a No asistir√©</button>
            </div>
          `;
        } else if (yaRechazado) {
          respuestaHTML = `
            <div class="ya-respondido rechazado">
              ‚ùå Has indicado que no asistir√°s
            </div>
            <div class="detalle-acciones" style="margin-top: 12px;">
              <button class="btn btn-confirmar" onclick="cambiarRespuesta('${convocatoriaId}', 'confirmar')">Cambiar a S√≠ asistir√©</button>
            </div>
          `;
        } else {
          respuestaHTML = `
            <div class="detalle-acciones">
              <button class="btn btn-confirmar" onclick="responder('${convocatoriaId}', 'confirmar')">‚úì S√≠, asistir√©</button>
              <button class="btn btn-rechazar" onclick="responder('${convocatoriaId}', 'rechazar')">‚úó No podr√© ir</button>
            </div>
          `;
        }

        document.getElementById('detalle-respuesta').innerHTML = respuestaHTML;
        document.getElementById('detalle-view').classList.remove('hidden');
        document.getElementById('contador').textContent = 'Responder';

      } catch (error) {
        console.error('Error cargando detalle:', error);
      }
    }

    async function cargarConvocatorias() {
      if (!userData?.familiaId) return;

      try {
        // Cargar todas las convocatorias de la familia
        const snap = await db.collection('convocatorias')
          .where('familiaId', '==', userData.familiaId)
          .orderBy('fecha', 'desc')
          .get();

        convocatorias = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderConvocatorias();

      } catch (error) {
        console.error('Error cargando convocatorias:', error);
      }
    }

    function renderConvocatorias() {
      const container = document.getElementById('convocatorias-list');
      const empty = document.getElementById('empty-state');
      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);

      // Filtrar seg√∫n tab
      let lista = convocatorias;

      if (tabActual === 'pendientes') {
        lista = convocatorias.filter(c => {
          const fechaEvento = new Date(c.fecha);
          const pasada = fechaEvento < hoy;
          const yaRespondio = c.confirmados?.includes(currentUser.uid) || c.rechazados?.includes(currentUser.uid);
          const esDestinatario = c.pendientes?.includes(currentUser.uid) || 
                                 c.confirmados?.includes(currentUser.uid) || 
                                 c.rechazados?.includes(currentUser.uid);
          return !pasada && !yaRespondio && esDestinatario;
        });
      } else if (tabActual === 'mis') {
        lista = convocatorias.filter(c => c.creadoPor === currentUser.uid);
      }
      // 'todas' muestra todo

      // Contador
      const pendientes = convocatorias.filter(c => {
        const fechaEvento = new Date(c.fecha);
        const pasada = fechaEvento < hoy;
        const yaRespondio = c.confirmados?.includes(currentUser.uid) || c.rechazados?.includes(currentUser.uid);
        return !pasada && !yaRespondio;
      }).length;

      document.getElementById('contador').textContent = pendientes > 0 
        ? `${pendientes} pendiente${pendientes !== 1 ? 's' : ''}` 
        : 'Sin pendientes';

      if (lista.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');

      container.innerHTML = lista.map(c => {
        const fechaEvento = new Date(c.fecha);
        const pasada = fechaEvento < hoy;
        const yaConfirmado = c.confirmados?.includes(currentUser.uid);
        const yaRechazado = c.rechazados?.includes(currentUser.uid);
        const esMio = c.creadoPor === currentUser.uid;

        let estadoClass = 'pendiente';
        let estadoText = '‚è≥ Pendiente';

        if (pasada) {
          estadoClass = 'pasada';
          estadoText = 'üìÖ Pasada';
        } else if (yaConfirmado) {
          estadoClass = 'confirmado';
          estadoText = '‚úì Confirmado';
        } else if (yaRechazado) {
          estadoClass = 'rechazado';
          estadoText = '‚úó Rechazado';
        }

        // Resumen de asistencia
        const numConfirmados = c.confirmados?.length || 0;
        const numRechazados = c.rechazados?.length || 0;
        const numPendientes = c.pendientes?.length || 0;

        let accionesHTML = '';
        if (!pasada && !yaConfirmado && !yaRechazado && !esMio) {
          accionesHTML = `
            <div class="convocatoria-acciones">
              <button class="btn btn-confirmar" onclick="responder('${c.id}', 'confirmar')">‚úì S√≠, asistir√©</button>
              <button class="btn btn-rechazar" onclick="responder('${c.id}', 'rechazar')">‚úó No podr√© ir</button>
            </div>
          `;
        }

        // Lista de confirmados (para organizador)
        let confirmadosHTML = '';
        if (esMio && (numConfirmados > 0 || numRechazados > 0)) {
          confirmadosHTML = `
            <div class="confirmados-lista">
              <div class="confirmados-titulo">Respuestas:</div>
              ${(c.confirmadosNombres || []).map(n => `<span class="confirmado-item si">‚úì ${n}</span>`).join('')}
              ${(c.rechazadosNombres || []).map(n => `<span class="confirmado-item no">‚úó ${n}</span>`).join('')}
            </div>
          `;
        }

        return `
          <div class="convocatoria-card ${pasada ? 'pasada' : ''}">
            <div class="convocatoria-header">
              <div class="convocatoria-titulo">${c.titulo}</div>
              <span class="convocatoria-estado ${estadoClass}">${estadoText}</span>
            </div>
            <div class="convocatoria-fecha">
              <span>üìÖ ${formatearFecha(c.fecha)}</span>
              ${c.hora ? `<span>üïê ${c.hora}</span>` : ''}
            </div>
            ${c.lugar ? `<div class="convocatoria-lugar">üìç ${c.lugar}</div>` : ''}
            ${c.notas ? `<div class="convocatoria-notas">${c.notas}</div>` : ''}
            <div class="convocatoria-autor">Organiza: ${c.creadoPorNombre}</div>
            
            <div class="asistencia-resumen">
              <div class="asistencia-grupo">
                <span class="asistencia-count confirmados">${numConfirmados}</span>
                <span>Confirmados</span>
              </div>
              <div class="asistencia-grupo">
                <span class="asistencia-count rechazados">${numRechazados}</span>
                <span>No asisten</span>
              </div>
              <div class="asistencia-grupo">
                <span class="asistencia-count pendientes">${numPendientes}</span>
                <span>Pendientes</span>
              </div>
            </div>

            ${confirmadosHTML}
            ${accionesHTML}
          </div>
        `;
      }).join('');
    }

    function cambiarTab(tab) {
      tabActual = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      renderConvocatorias();
    }

    async function responder(id, tipo) {
      try {
        const convRef = db.collection('convocatorias').doc(id);
        const miNombre = userData?.nombre || currentUser.email.split('@')[0];

        if (tipo === 'confirmar') {
          await convRef.update({
            confirmados: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
            confirmadosNombres: firebase.firestore.FieldValue.arrayUnion(miNombre),
            pendientes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
          });
        } else {
          await convRef.update({
            rechazados: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
            rechazadosNombres: firebase.firestore.FieldValue.arrayUnion(miNombre),
            pendientes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
          });
        }

        // Marcar notificaci√≥n como completada
        const notifSnap = await db.collection('notificaciones')
          .where('origen.id', '==', id)
          .where('destinatarios', 'array-contains', currentUser.uid)
          .get();

        for (const doc of notifSnap.docs) {
          await doc.ref.update({
            completadoPor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
          });
        }

        if (convocatoriaId) {
          await cargarDetalle();
        } else {
          await cargarConvocatorias();
        }

      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar tu respuesta');
      }
    }

    async function cambiarRespuesta(id, nuevoTipo) {
      try {
        const convRef = db.collection('convocatorias').doc(id);
        const miNombre = userData?.nombre || currentUser.email.split('@')[0];

        if (nuevoTipo === 'confirmar') {
          await convRef.update({
            confirmados: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
            confirmadosNombres: firebase.firestore.FieldValue.arrayUnion(miNombre),
            rechazados: firebase.firestore.FieldValue.arrayRemove(currentUser.uid),
            rechazadosNombres: firebase.firestore.FieldValue.arrayRemove(miNombre)
          });
        } else {
          await convRef.update({
            rechazados: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
            rechazadosNombres: firebase.firestore.FieldValue.arrayUnion(miNombre),
            confirmados: firebase.firestore.FieldValue.arrayRemove(currentUser.uid),
            confirmadosNombres: firebase.firestore.FieldValue.arrayRemove(miNombre)
          });
        }

        await cargarDetalle();

      } catch (error) {
        console.error('Error:', error);
        alert('Error al cambiar tu respuesta');
      }
    }

    function formatearFecha(fechaStr) {
      const fecha = new Date(fechaStr);
      const opciones = { weekday: 'long', day: 'numeric', month: 'long' };
      return fecha.toLocaleDateString('es-ES', opciones);
    }

    // ============ CREAR CONVOCATORIA ============
    let miembrosData = [];

    async function cargarMiembros() {
      if (!userData?.familiaId) return;
      try {
        const snap = await db.collection('usuarios')
          .where('familiaId', '==', userData.familiaId)
          .get();
        miembrosData = snap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(m => m.id !== currentUser.uid); // Excluir al creador
      } catch (e) {
        console.error('Error cargando miembros:', e);
      }
    }

    function abrirModalConvocatoria() {
      document.getElementById('form-convocatoria').reset();
      document.getElementById('conv-fecha').value = new Date().toISOString().split('T')[0];
      renderMiembros();
      toggleDestinatarios();
      document.getElementById('modal-convocatoria').classList.add('active');
    }

    function cerrarModal() {
      document.getElementById('modal-convocatoria').classList.remove('active');
    }

    function renderMiembros() {
      const lista = document.getElementById('lista-miembros');
      if (miembrosData.length === 0) {
        lista.innerHTML = '<p style="color: var(--text-muted); padding: 12px; text-align: center;">No hay otros miembros en la familia</p>';
        return;
      }
      lista.innerHTML = miembrosData.map(m => {
        const inicial = (m.nombre || m.email || '?').charAt(0).toUpperCase();
        const nombre = m.nombre || m.email?.split('@')[0] || 'Sin nombre';
        return `
          <label class="miembro-check">
            <input type="checkbox" value="${m.id}" data-nombre="${nombre}">
            <div class="miembro-avatar">${inicial}</div>
            <span>${nombre}</span>
          </label>
        `;
      }).join('');
    }

    function toggleDestinatarios() {
      const seleccionar = document.querySelector('input[name="destino"][value="seleccionar"]').checked;
      document.getElementById('lista-miembros').classList.toggle('hidden', !seleccionar);
    }

    async function guardarConvocatoria(e) {
      e.preventDefault();
      
      const titulo = document.getElementById('conv-titulo').value.trim();
      const fecha = document.getElementById('conv-fecha').value;
      const hora = document.getElementById('conv-hora').value;
      const lugar = document.getElementById('conv-lugar').value.trim();
      const notas = document.getElementById('conv-notas').value.trim();
      const enviarATodos = document.querySelector('input[name="destino"][value="todos"]').checked;

      // Obtener destinatarios
      let pendientes = [];
      let pendientesNombres = [];

      if (enviarATodos) {
        pendientes = miembrosData.map(m => m.id);
        pendientesNombres = miembrosData.map(m => m.nombre || m.email?.split('@')[0]);
      } else {
        const checkboxes = document.querySelectorAll('#lista-miembros input:checked');
        checkboxes.forEach(cb => {
          pendientes.push(cb.value);
          pendientesNombres.push(cb.dataset.nombre);
        });
      }

      if (pendientes.length === 0) {
        alert('Selecciona al menos un destinatario');
        return;
      }

      const btn = document.getElementById('btn-crear');
      btn.disabled = true;
      btn.textContent = 'Creando...';

      try {
        const miNombre = userData?.nombre || currentUser.email.split('@')[0];

        await db.collection('convocatorias').add({
          titulo,
          fecha,
          hora: hora || null,
          lugar: lugar || null,
          notas: notas || null,
          familiaId: userData.familiaId,
          creadoPor: currentUser.uid,
          creadoPorNombre: miNombre,
          pendientes,
          pendientesNombres,
          confirmados: [],
          confirmadosNombres: [],
          rechazados: [],
          rechazadosNombres: [],
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        cerrarModal();
        await cargarConvocatorias();
        cambiarTab('mis');
        alert('‚úÖ Convocatoria creada');

      } catch (error) {
        console.error('Error:', error);
        alert('Error al crear la convocatoria');
      }

      btn.disabled = false;
      btn.textContent = 'Crear convocatoria';
    }

    // Cerrar modal con click fuera
    document.getElementById('modal-convocatoria').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) cerrarModal();
    });
  </script>
</body>
</html>
