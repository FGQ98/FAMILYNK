<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Mis Reservas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --solicitud: #7E57C2;
      --solicitud-muted: rgba(126, 87, 194, 0.12);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* ========== HEADER ========== */
    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky; top: 0; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 14px; background: var(--cream); border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem; color: var(--text-light);
      cursor: pointer; text-decoration: none; transition: all 0.2s;
    }
    .back-btn:hover { background: var(--cream-dark); color: var(--text); }
    .header-title {
      font-family: 'Quicksand', sans-serif; font-size: 1.3rem; font-weight: 700;
      display: flex; align-items: center; gap: 10px;
    }
    .header-count {
      background: var(--sage); color: white;
      padding: 2px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
    }

    /* ========== MAIN ========== */
    .main { max-width: 800px; margin: 0 auto; padding: 24px; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 80px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--sage); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* ========== FILTROS ========== */
    .filtros {
      display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;
    }
    .filtro-btn {
      padding: 8px 16px; border-radius: 20px; border: 1.5px solid var(--cream-dark);
      background: var(--white); font-family: 'Nunito', sans-serif; font-size: 0.8rem;
      font-weight: 600; color: var(--text-light); cursor: pointer; transition: all 0.2s;
    }
    .filtro-btn:hover { border-color: var(--sage); color: var(--sage-dark); }
    .filtro-btn.active { background: var(--sage); color: white; border-color: var(--sage); }
    .filtro-count {
      display: inline-block; padding: 0 6px; margin-left: 4px;
      background: rgba(255,255,255,0.3); border-radius: 10px; font-size: 0.7rem;
    }

    /* ========== RESERVA CARD ========== */
    .reserva-card {
      background: var(--white); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft); margin-bottom: 16px;
      overflow: hidden; transition: all 0.2s;
      border-left: 4px solid var(--sage);
    }
    .reserva-card:hover { box-shadow: var(--shadow-medium); }
    .reserva-card.pendiente { border-left-color: var(--warning); }
    .reserva-card.aprobada, .reserva-card.aceptada, .reserva-card.confirmada { border-left-color: var(--success); }
    .reserva-card.rechazada, .reserva-card.denegada { border-left-color: var(--error); }
    .reserva-card.cancelada { border-left-color: var(--text-muted); opacity: 0.7; }
    .reserva-card.borrador { border-left-color: var(--cream-dark); border-left-style: dashed; }

    .reserva-header {
      padding: 16px 20px; display: flex; align-items: flex-start;
      justify-content: space-between; gap: 12px;
    }
    .reserva-info { flex: 1; }
    .reserva-nombre {
      font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.05rem;
      margin-bottom: 4px;
    }
    .reserva-bien {
      font-size: 0.85rem; color: var(--text-light);
      display: flex; align-items: center; gap: 4px;
    }
    .reserva-fechas {
      font-size: 0.85rem; color: var(--text-light); margin-top: 6px;
      display: flex; align-items: center; gap: 6px;
    }
    .reserva-meta {
      display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;
    }

    /* Estado badge */
    .estado-badge {
      padding: 4px 12px; border-radius: 20px; font-size: 0.72rem;
      font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px;
      white-space: nowrap;
    }
    .estado-badge.pendiente { background: #FFF3E0; color: #E65100; }
    .estado-badge.aprobada, .estado-badge.aceptada, .estado-badge.confirmada { background: #E8F5E9; color: #2E7D32; }
    .estado-badge.rechazada, .estado-badge.denegada { background: #FFEBEE; color: #C62828; }
    .estado-badge.cancelada { background: var(--cream-dark); color: var(--text-muted); }
    .estado-badge.borrador { background: var(--cream); color: var(--text-muted); border: 1px dashed var(--text-muted); }
    .estado-badge.enviado { background: #E3F2FD; color: #1565C0; }

    /* Tipo badge */
    .tipo-badge {
      padding: 3px 10px; border-radius: 12px; font-size: 0.7rem;
      font-weight: 600; background: var(--sage-muted); color: var(--sage-dark);
    }

    /* Acciones */
    .reserva-actions {
      padding: 0 20px 16px; display: flex; gap: 8px; justify-content: flex-end;
      border-top: 1px solid var(--cream-dark); padding-top: 12px; margin: 0 20px;
    }
    .btn-action {
      padding: 8px 16px; border-radius: var(--radius-md); border: none;
      font-family: 'Nunito', sans-serif; font-size: 0.8rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .btn-ver {
      background: var(--cream); color: var(--text-light);
    }
    .btn-ver:hover { background: var(--cream-dark); color: var(--text); }
    .btn-editar {
      background: var(--sage-muted); color: var(--sage-dark);
    }
    .btn-editar:hover { background: var(--sage); color: white; }
    .btn-cancelar-reserva {
      background: transparent; color: var(--error); border: 1px solid var(--error);
    }
    .btn-cancelar-reserva:hover { background: var(--error); color: white; }

    /* ========== DETALLE EXPANDIDO ========== */
    .reserva-detalle {
      display: none; padding: 0 20px 16px;
    }
    .reserva-detalle.visible { display: block; }

    .detalle-section {
      padding: 12px; background: var(--cream); border-radius: var(--radius-md);
      margin-bottom: 10px;
    }
    .detalle-section-title {
      font-family: 'Quicksand', sans-serif; font-weight: 600; font-size: 0.85rem;
      margin-bottom: 8px; color: var(--sage-dark);
    }
    .detalle-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 4px 0; font-size: 0.85rem;
    }
    .detalle-label { color: var(--text-muted); }
    .detalle-value { font-weight: 600; }
    .detalle-text { font-size: 0.85rem; color: var(--text-light); line-height: 1.5; }
    .detalle-chips { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
    .detalle-chip {
      padding: 2px 8px; background: var(--white); border-radius: 8px;
      font-size: 0.75rem; color: var(--text-light);
    }

    .respuesta-admin {
      padding: 12px; border-radius: var(--radius-md); margin-top: 10px;
    }
    .respuesta-admin.aprobada { background: #E8F5E9; border-left: 3px solid var(--success); }
    .respuesta-admin.rechazada { background: #FFEBEE; border-left: 3px solid var(--error); }
    .respuesta-admin-title { font-weight: 700; font-size: 0.85rem; margin-bottom: 4px; }
    .respuesta-admin-text { font-size: 0.85rem; color: var(--text-light); }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      background: var(--white); border-radius: var(--radius-lg);
      padding: 60px 32px; text-align: center;
    }
    .empty-icon { font-size: 3.5rem; margin-bottom: 16px; opacity: 0.5; }
    .empty-title {
      font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 1.15rem;
      margin-bottom: 8px;
    }
    .empty-text { color: var(--text-light); font-size: 0.9rem; margin-bottom: 24px; }
    .btn-nueva-reserva {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 12px 24px; border-radius: var(--radius-md); border: none;
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      color: white; font-family: 'Nunito', sans-serif; font-size: 0.9rem;
      font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none;
    }
    .btn-nueva-reserva:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }

    /* ========== MODAL CANCELAR ========== */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; padding: 24px;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: var(--white); border-radius: var(--radius-lg);
      width: 100%; max-width: 420px; padding: 28px;
      transform: translateY(20px); transition: transform 0.3s;
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-title {
      font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 700;
      margin-bottom: 12px;
    }
    .modal-text { font-size: 0.9rem; color: var(--text-light); margin-bottom: 8px; line-height: 1.5; }
    .modal-reserva-name {
      font-weight: 700; padding: 10px 14px; background: var(--cream);
      border-radius: var(--radius-sm); margin: 12px 0 20px; font-size: 0.95rem;
    }
    .modal-motivo {
      width: 100%; padding: 12px 14px; border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md); font-family: 'Nunito', sans-serif;
      font-size: 0.9rem; resize: vertical; min-height: 80px; margin-bottom: 20px;
    }
    .modal-motivo:focus { outline: none; border-color: var(--sage); }
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
    .btn-modal {
      padding: 10px 20px; border-radius: var(--radius-md); border: none;
      font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-modal-cancel { background: var(--cream); color: var(--text-light); }
    .btn-modal-cancel:hover { background: var(--cream-dark); }
    .btn-modal-confirm { background: var(--error); color: white; }
    .btn-modal-confirm:hover { opacity: 0.9; }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      .header { padding: 12px 16px; }
      .header-title { font-size: 1.1rem; }
      .main { padding: 16px; }
      .reserva-header { padding: 14px 16px; flex-direction: column; }
      .reserva-actions { flex-direction: column; margin: 0 16px; padding: 12px 16px 14px; }
      .btn-action { justify-content: center; }
      .filtros { gap: 6px; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="cgi.html" class="back-btn">
        <span>‚Üê</span>
        <span>Volver al CGI</span>
      </a>
      <h1 class="header-title">
        <span>üìã</span>
        <span>Mis Reservas</span>
        <span class="header-count hidden" id="total-count">0</span>
      </h1>
    </div>
    <a href="solicitud-preparacion.html" class="btn-nueva-reserva" style="padding: 8px 16px; font-size: 0.8rem;">
      + Nueva
    </a>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Loading -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>

    <!-- Content -->
    <div id="content" class="hidden">
      <!-- Filtros -->
      <div class="filtros" id="filtros">
        <button class="filtro-btn active" data-filtro="todas" onclick="filtrar('todas')">
          Todas <span class="filtro-count" id="count-todas">0</span>
        </button>
        <button class="filtro-btn" data-filtro="pendiente" onclick="filtrar('pendiente')">
          ‚è≥ Pendientes <span class="filtro-count" id="count-pendiente">0</span>
        </button>
        <button class="filtro-btn" data-filtro="aprobada" onclick="filtrar('aprobada')">
          ‚úÖ Aprobadas <span class="filtro-count" id="count-aprobada">0</span>
        </button>
        <button class="filtro-btn" data-filtro="rechazada" onclick="filtrar('rechazada')">
          ‚ùå Rechazadas <span class="filtro-count" id="count-rechazada">0</span>
        </button>
        <button class="filtro-btn" data-filtro="cancelada" onclick="filtrar('cancelada')">
          üö´ Canceladas <span class="filtro-count" id="count-cancelada">0</span>
        </button>
      </div>

      <!-- Lista de reservas -->
      <div id="reservas-list"></div>

      <!-- Empty state -->
      <div id="empty-state" class="empty-state hidden">
        <div class="empty-icon">üìã</div>
        <h3 class="empty-title">No tienes reservas</h3>
        <p class="empty-text">Cuando solicites una reserva para un bien familiar, aparecer√° aqu√≠ para que puedas seguir su estado.</p>
        <a href="solicitud-preparacion.html" class="btn-nueva-reserva">
          <span>+</span>
          <span>Solicitar reserva</span>
        </a>
      </div>

      <!-- Empty filtro -->
      <div id="empty-filtro" class="empty-state hidden">
        <div class="empty-icon">üîç</div>
        <h3 class="empty-title">Sin resultados</h3>
        <p class="empty-text">No tienes reservas con ese estado.</p>
      </div>
    </div>
  </main>

  <!-- Modal cancelar reserva -->
  <div class="modal-overlay" id="modal-cancelar">
    <div class="modal">
      <h3 class="modal-title">üö´ Cancelar reserva</h3>
      <p class="modal-text">¬øSeguro que quieres cancelar esta reserva? Se notificar√° a los administradores.</p>
      <div class="modal-reserva-name" id="modal-reserva-nombre"></div>
      <textarea class="modal-motivo" id="modal-motivo" placeholder="Motivo de cancelaci√≥n (opcional)..."></textarea>
      <div class="modal-actions">
        <button class="btn-modal btn-modal-cancel" onclick="cerrarModal()">Volver</button>
        <button class="btn-modal btn-modal-confirm" id="btn-confirmar-cancelar" onclick="confirmarCancelacion()">Cancelar reserva</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ========================================
    // ESTADO
    // ========================================
    let currentUser = null;
    let userData = null;
    let currentFamilia = null;
    let reservas = [];
    let filtroActivo = 'todas';
    let cancelandoId = null;
    let cancelandoBienId = null;

    // ========================================
    // AUTH + INIT
    // ========================================
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;

      try {
        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        if (!userDoc.exists || !userDoc.data().familiaId) {
          window.location.href = 'cgi.html'; return;
        }
        userData = userDoc.data();

        // Cargar familia (estirpe activa o principal)
        const estirpeActiva = userData.estirpeActiva || userData.familiaId;
        const estirpeDoc = await db.collection('familias').doc(estirpeActiva).get();
        if (estirpeDoc.exists) {
          currentFamilia = { id: estirpeDoc.id, ...estirpeDoc.data() };
        } else {
          const fallbackDoc = await db.collection('familias').doc(userData.familiaId).get();
          currentFamilia = fallbackDoc.exists ? { id: fallbackDoc.id, ...fallbackDoc.data() } : null;
        }

        if (!currentFamilia) { alert('Error: No se encontr√≥ la familia'); return; }

        await cargarReservas();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

      } catch (error) {
        console.error('Error inicializando:', error);
        alert('Error al cargar datos');
      }
    });

    // ========================================
    // CARGAR RESERVAS DEL USUARIO
    // ========================================
    async function cargarReservas() {
      try {
        console.log('üîÑ Cargando mis reservas con collectionGroup...');
        reservas = [];

        // DATO √öNICO: leer con collectionGroup('reservas') ‚Äî todas las subcollections de bienes
        // Requiere √≠ndice en Firestore: collectionGroup 'reservas' + campo 'solicitadoPor' + 'familiaId'
        const snap = await db.collectionGroup('reservas')
          .where('solicitadoPor', '==', currentUser.uid)
          .where('familiaId', '==', currentFamilia.id)
          .get();

        snap.docs.forEach(doc => {
          const data = doc.data();
          // Extraer bienId de la ruta: bienes/{bienId}/reservas/{reservaId}
          const pathParts = doc.ref.path.split('/');
          const bienId = pathParts.length >= 2 ? pathParts[1] : null;

          reservas.push({
            id: doc.id,
            bienId: bienId,
            bienNombre: data.bienNombre || 'Bien',
            ...data
          });
        });

        console.log('üì¶ Reservas encontradas:', reservas.length);

        // Ordenar: m√°s recientes primero
        reservas.sort((a, b) => {
          const fa = toTimestamp(a.fechaCreacion);
          const fb = toTimestamp(b.fechaCreacion);
          return fb - fa;
        });

        console.log('‚úÖ Total mis reservas:', reservas.length);
        actualizarContadores();
        renderReservas();

      } catch (error) {
        console.error('‚ùå Error cargando reservas:', error);
        // Si falla collectionGroup (√≠ndice no creado), informar
        if (error.code === 'failed-precondition') {
          console.error('‚ö†Ô∏è Falta crear el √≠ndice de collectionGroup en Firebase Console');
          alert('Se necesita crear un √≠ndice en Firebase. Revisa la consola del navegador para el enlace.');
        }
      }
    }

    // ========================================
    // RENDER
    // ========================================
    function renderReservas() {
      const list = document.getElementById('reservas-list');
      const emptyState = document.getElementById('empty-state');
      const emptyFiltro = document.getElementById('empty-filtro');

      if (reservas.length === 0) {
        list.innerHTML = '';
        emptyState.classList.remove('hidden');
        emptyFiltro.classList.add('hidden');
        return;
      }

      emptyState.classList.add('hidden');

      // Filtrar
      const filtradas = filtroActivo === 'todas'
        ? reservas
        : reservas.filter(r => normalizarEstado(r.estado) === filtroActivo);

      if (filtradas.length === 0) {
        list.innerHTML = '';
        emptyFiltro.classList.remove('hidden');
        return;
      }

      emptyFiltro.classList.add('hidden');

      list.innerHTML = filtradas.map((r, idx) => {
        const estado = normalizarEstado(r.estado);
        const estadoLabel = getEstadoLabel(r.estado);
        const nombre = r.nombre || r.titulo || r.tipoReservaNombre || 'Reserva';
        const bienNombre = r.bienNombre || 'Bien';
        const fechas = `${formatFecha(r.fechaInicio)} ‚Üí ${formatFecha(r.fechaFin)}`;
        const tipoLabel = r.tipoReservaNombre || r.categoria || '';
        const puedeEditar = ['pendiente', 'borrador'].includes(estado);
        const puedeCancelar = ['pendiente', 'borrador', 'aprobada'].includes(estado);

        return `
          <div class="reserva-card ${estado}" id="card-${r.id}">
            <div class="reserva-header" onclick="toggleDetalle('${r.id}')">
              <div class="reserva-info">
                <div class="reserva-nombre">${nombre}</div>
                <div class="reserva-bien">üè† ${bienNombre}</div>
                <div class="reserva-fechas">üìÖ ${fechas}</div>
                <div class="reserva-meta">
                  <span class="estado-badge ${estado}">${estadoLabel}</span>
                  ${tipoLabel ? `<span class="tipo-badge">${tipoLabel}</span>` : ''}
                </div>
              </div>
            </div>

            <!-- Detalle expandible -->
            <div class="reserva-detalle" id="detalle-${r.id}">
              ${renderDetalle(r)}
            </div>

            <!-- Acciones -->
            <div class="reserva-actions">
              <button class="btn-action btn-ver" onclick="toggleDetalle('${r.id}')">
                üëÅÔ∏è Ver detalle
              </button>
              ${puedeEditar ? `
                <button class="btn-action btn-editar" onclick="editarReserva('${r.id}')">
                  ‚úèÔ∏è Editar
                </button>
              ` : ''}
              ${puedeCancelar ? `
                <button class="btn-action btn-cancelar-reserva" onclick="abrirCancelacion('${r.id}')">
                  üö´ Cancelar
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderDetalle(r) {
      let html = '';

      // Info b√°sica
      html += `
        <div class="detalle-section">
          <div class="detalle-section-title">üìç Informaci√≥n</div>
          <div class="detalle-row">
            <span class="detalle-label">Bien</span>
            <span class="detalle-value">${r.bienNombre || '‚Äî'}</span>
          </div>
          <div class="detalle-row">
            <span class="detalle-label">Fechas</span>
            <span class="detalle-value">${formatFecha(r.fechaInicio)} ‚Üí ${formatFecha(r.fechaFin)}</span>
          </div>
          ${r.nidoReservaNombre ? `
          <div class="detalle-row">
            <span class="detalle-label">Nido</span>
            <span class="detalle-value">${r.nidoReservaNombre}</span>
          </div>` : ''}
          ${r.visibilidad ? `
          <div class="detalle-row">
            <span class="detalle-label">Visibilidad</span>
            <span class="detalle-value">${r.visibilidad}</span>
          </div>` : ''}
        </div>
      `;

      // Motivo/descripci√≥n
      if (r.descripcion || r.motivo) {
        html += `
          <div class="detalle-section">
            <div class="detalle-section-title">üìù Descripci√≥n</div>
            <div class="detalle-text">${r.descripcion || r.motivo}</div>
          </div>
        `;
      }

      // Preparaci√≥n (si existe)
      const prep = r.preparacion;
      if (prep) {
        // Zonas
        if (prep.zonas && prep.zonas.length > 0) {
          html += `
            <div class="detalle-section">
              <div class="detalle-section-title">üè† Zonas solicitadas</div>
              <div class="detalle-chips">
                ${prep.zonas.map(z => `<span class="detalle-chip">${z}</span>`).join('')}
              </div>
            </div>
          `;
        }

        // Menaje
        if (prep.menaje && prep.menaje.length > 0) {
          html += `
            <div class="detalle-section">
              <div class="detalle-section-title">üçΩÔ∏è Menaje solicitado</div>
              <div class="detalle-chips">
                ${prep.menaje.map(m => `<span class="detalle-chip">${m.nombre || m}</span>`).join('')}
              </div>
            </div>
          `;
        }

        // Productos
        const productos = [...(prep.productosAportados || []), ...(prep.productosSolicitados || [])];
        if (productos.length > 0) {
          html += `
            <div class="detalle-section">
              <div class="detalle-section-title">üõí Productos</div>
              <div class="detalle-chips">
                ${productos.map(p => `<span class="detalle-chip">${p.nombre || p}</span>`).join('')}
              </div>
            </div>
          `;
        }

        // Tareas
        if (prep.tareas && prep.tareas.length > 0) {
          html += `
            <div class="detalle-section">
              <div class="detalle-section-title">‚úÖ Tareas</div>
              <div class="detalle-chips">
                ${prep.tareas.map(t => `<span class="detalle-chip">${t.nombre || t}</span>`).join('')}
              </div>
            </div>
          `;
        }

        // Notas
        if (prep.notas) {
          html += `
            <div class="detalle-section">
              <div class="detalle-section-title">üìé Notas</div>
              <div class="detalle-text">${prep.notas}</div>
            </div>
          `;
        }
      }

      // Respuesta del admin
      if (r.respuesta) {
        const estadoResp = normalizarEstado(r.estado);
        html += `
          <div class="respuesta-admin ${estadoResp}">
            <div class="respuesta-admin-title">
              ${estadoResp === 'aprobada' ? '‚úÖ' : '‚ùå'} Respuesta del administrador
            </div>
            <div class="respuesta-admin-text">${r.respuesta}</div>
          </div>
        `;
      }

      // Motivo cancelaci√≥n
      if (r.motivoCancelacion) {
        html += `
          <div class="detalle-section" style="background: #FFEBEE;">
            <div class="detalle-section-title">üö´ Motivo de cancelaci√≥n</div>
            <div class="detalle-text">${r.motivoCancelacion}</div>
          </div>
        `;
      }

      return html;
    }

    // ========================================
    // FILTROS
    // ========================================
    function filtrar(filtro) {
      filtroActivo = filtro;
      document.querySelectorAll('.filtro-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filtro === filtro);
      });
      renderReservas();
    }

    function actualizarContadores() {
      const conteos = { todas: reservas.length, pendiente: 0, aprobada: 0, rechazada: 0, cancelada: 0 };

      reservas.forEach(r => {
        const estado = normalizarEstado(r.estado);
        if (conteos[estado] !== undefined) conteos[estado]++;
      });

      Object.keys(conteos).forEach(key => {
        const el = document.getElementById(`count-${key}`);
        if (el) el.textContent = conteos[key];
      });

      // Header count
      const totalEl = document.getElementById('total-count');
      totalEl.textContent = reservas.length;
      totalEl.classList.toggle('hidden', reservas.length === 0);
    }

    // ========================================
    // ACCIONES
    // ========================================
    function toggleDetalle(id) {
      const detalle = document.getElementById(`detalle-${id}`);
      if (detalle) detalle.classList.toggle('visible');
    }

    function editarReserva(id) {
      const reserva = reservas.find(r => r.id === id);
      if (!reserva) return;

      // Redirigir a solicitud-preparacion con par√°metros para editar
      const params = new URLSearchParams();
      if (reserva.bienId) params.set('bienId', reserva.bienId);
      params.set('editId', reserva.id); // ID directo en bienes/{bienId}/reservas/{id}

      window.location.href = `solicitud-preparacion.html?${params.toString()}`;
    }

    function abrirCancelacion(id) {
      const reserva = reservas.find(r => r.id === id);
      if (!reserva) return;

      cancelandoId = id;
      cancelandoBienId = reserva.bienId;

      const nombre = reserva.nombre || reserva.titulo || 'Reserva';
      const fechas = `${formatFecha(reserva.fechaInicio)} ‚Üí ${formatFecha(reserva.fechaFin)}`;
      document.getElementById('modal-reserva-nombre').textContent = `${nombre} ¬∑ ${fechas}`;
      document.getElementById('modal-motivo').value = '';
      document.getElementById('modal-cancelar').classList.add('active');
    }

    function cerrarModal() {
      document.getElementById('modal-cancelar').classList.remove('active');
      cancelandoId = null;
      cancelandoBienId = null;
    }

    async function confirmarCancelacion() {
      if (!cancelandoId) return;

      const btn = document.getElementById('btn-confirmar-cancelar');
      btn.disabled = true;
      btn.textContent = 'Cancelando...';

      try {
        const motivo = document.getElementById('modal-motivo').value.trim();
        const updateData = {
          estado: 'cancelada',
          motivoCancelacion: motivo || 'Cancelada por el usuario',
          canceladoPor: currentUser.uid,
          fechaCancelacion: firebase.firestore.FieldValue.serverTimestamp()
        };

        // DATO √öNICO: actualizar solo en bienes/{bienId}/reservas/{id}
        if (cancelandoBienId && cancelandoId) {
          await db.collection('bienes').doc(cancelandoBienId)
            .collection('reservas').doc(cancelandoId)
            .update(updateData);
          console.log('‚úÖ Reserva cancelada');
        }

        // Notificar a admins
        try {
          const reserva = reservas.find(r => r.id === cancelandoId);
          const nombre = reserva?.nombre || reserva?.titulo || 'Reserva';

          await db.collection('notificaciones').add({
            tipo: 'info',
            categoria: 'cancelacion',
            titulo: `üö´ Reserva cancelada: ${nombre}`,
            mensaje: `${userData?.nombre || 'Usuario'} ha cancelado su reserva${motivo ? ': ' + motivo : ''}`,
            familiaId: currentFamilia.id,
            destinatarios: [],
            leidoPor: [],
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            estado: 'activa',
            origen: { tipo: 'cancelacion', reservaId: cancelandoId, bienId: cancelandoBienId }
          });
        } catch (e) { console.warn('Error creando notificaci√≥n:', e); }

        cerrarModal();
        await cargarReservas();

      } catch (error) {
        console.error('Error cancelando reserva:', error);
        alert('Error al cancelar: ' + error.message);
      }

      btn.disabled = false;
      btn.textContent = 'Cancelar reserva';
    }

    // ========================================
    // UTILS
    // ========================================
    function normalizarEstado(estado) {
      if (!estado) return 'pendiente';
      const e = estado.toLowerCase();
      if (['aceptada', 'aprobada', 'confirmada'].includes(e)) return 'aprobada';
      if (['rechazada', 'denegada'].includes(e)) return 'rechazada';
      if (e === 'cancelada') return 'cancelada';
      if (e === 'borrador') return 'borrador';
      if (e === 'enviado') return 'pendiente';
      return 'pendiente';
    }

    function getEstadoLabel(estado) {
      if (!estado) return 'Pendiente';
      const e = estado.toLowerCase();
      if (['aceptada', 'aprobada', 'confirmada'].includes(e)) return 'Aprobada';
      if (['rechazada', 'denegada'].includes(e)) return 'Rechazada';
      if (e === 'cancelada') return 'Cancelada';
      if (e === 'borrador') return 'Borrador';
      if (e === 'enviado') return 'Enviada';
      return 'Pendiente';
    }

    function formatFecha(val) {
      if (!val) return '‚Äî';
      let str = val;
      if (val.toDate) str = val.toDate().toISOString().split('T')[0];
      if (typeof str !== 'string') return '‚Äî';
      const [y, m, d] = str.split('-');
      return `${parseInt(d)}/${parseInt(m)}/${y}`;
    }

    function toTimestamp(val) {
      if (!val) return 0;
      if (val.toDate) return val.toDate().getTime();
      if (val.seconds) return val.seconds * 1000;
      return new Date(val).getTime() || 0;
    }

    // Cerrar modal con clic fuera
    document.getElementById('modal-cancelar').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) cerrarModal();
    });
  </script>
</body>
</html>
