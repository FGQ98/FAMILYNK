<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Gerente</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      /* Gerente: Azul petr√≥leo */
      --gerente: #2D4A5C;
      --gerente-light: #4A6B7C;
      --gerente-dark: #1D3544;
      --gerente-muted: rgba(45, 74, 92, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --warning-muted: rgba(232, 180, 77, 0.15);
      --error: #D4695A;
      --error-muted: rgba(212, 105, 90, 0.15);
      --gold: #B8965C;
      --gold-muted: rgba(184, 150, 92, 0.15);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: white;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    .header-info h1 {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .header-info p {
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .header-badge {
      padding: 4px 12px;
      background: var(--gold);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
    }

    /* ========== MOBILE MENU ========== */
    .mobile-menu-btn {
      display: none;
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      font-size: 1.3rem;
      cursor: pointer;
      align-items: center;
      justify-content: center;
    }

    .mobile-menu-btn:hover { background: rgba(255,255,255,0.25); }

    /* ========== LAYOUT ========== */
    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: calc(100vh - 72px);
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      background: var(--white);
      border-right: 1px solid var(--cream-dark);
      padding: 20px 0;
      overflow-y: auto;
    }

    .sidebar-section { margin-bottom: 24px; }

    .sidebar-title {
      padding: 0 20px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      font-weight: 700;
      margin-bottom: 8px;
    }

    .sidebar-nav { list-style: none; }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-light);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .sidebar-link:hover { background: var(--cream); color: var(--text); }

    .sidebar-link.active {
      background: var(--gerente-muted);
      color: var(--gerente);
      border-right: 3px solid var(--gerente);
    }

    .sidebar-link-icon { font-size: 1.1rem; width: 24px; text-align: center; }

    .sidebar-link-badge {
      margin-left: auto;
      padding: 2px 8px;
      background: var(--error);
      color: white;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 700;
    }

    .sidebar-link-badge.gold { background: var(--gold); }
    .sidebar-link-badge.warning { background: var(--warning); }

    .sidebar-divider {
      height: 1px;
      background: var(--cream-dark);
      margin: 12px 20px;
    }

    /* ========== MAIN CONTENT ========== */
    .main {
      padding: 24px;
      max-width: 1200px;
    }

    .section { display: none; }
    .section.active { display: block; }

    .section-header { margin-bottom: 24px; }

    .section-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .section-description {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* ========== DASHBOARD CARDS ========== */
    .dashboard-group {
      margin-bottom: 32px;
    }

    .dashboard-group-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
    }

    .dashboard-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      transition: all 0.25s;
      border: 2px solid transparent;
      text-decoration: none;
      color: var(--text);
    }

    .dashboard-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-float);
      border-color: var(--gerente-light);
    }

    .dashboard-card.disabled {
      opacity: 0.45;
      pointer-events: none;
      cursor: default;
    }

    .dashboard-card-icon {
      width: 48px;
      height: 48px;
      background: var(--gerente-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 12px;
    }

    .dashboard-card-icon.gold { background: var(--gold-muted); }
    .dashboard-card-icon.terracotta { background: var(--terracotta-muted); }

    .dashboard-card-name {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .dashboard-card-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .dashboard-card-status {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--cream-dark);
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .status-dot.pending { background: var(--warning); }
    .status-dot.inactive { background: var(--text-muted); }

    /* ========== STATS RESUMEN ========== */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 28px;
    }

    .stat-mini {
      background: var(--white);
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-soft);
      text-align: center;
    }

    .stat-mini.highlight {
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      color: white;
    }

    .stat-mini.gold-bg {
      background: linear-gradient(135deg, var(--gold) 0%, #96783F 100%);
      color: white;
    }

    .stat-mini-value {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.6rem;
      font-weight: 700;
    }

    .stat-mini-label {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-top: 2px;
    }

    /* ========== HOSTER SECTION ========== */
    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      margin-bottom: 20px;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body { padding: 20px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-gerente {
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      color: white;
    }
    .btn-gerente:hover { transform: translateY(-2px); box-shadow: var(--shadow-float); }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
      border: 1px solid var(--cream-dark);
    }
    .btn-secondary:hover { background: var(--cream-dark); }

    .btn-sm { padding: 8px 14px; font-size: 0.8rem; }

    .info-box {
      background: var(--gerente-muted);
      border-radius: var(--radius-md);
      padding: 16px;
      font-size: 0.85rem;
      line-height: 1.6;
      color: var(--text);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-title { font-size: 1rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
    .empty-state-text { font-size: 0.85rem; margin-bottom: 16px; }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .sidebar.mobile-open {
        display: block;
        position: fixed;
        top: 72px;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 99;
        background: var(--white);
      }
      .mobile-menu-btn { display: flex; }
      .header-badge { display: none; }
      .dashboard-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
    }
  </style>
</head>
<body>
  <!-- ========== HEADER ========== -->
  <header class="header">
    <div class="header-left">
      <a href="bien.html" class="back-btn" id="btn-volver">‚Üê Volver al bien</a>
      <div class="header-title">
        <div class="header-icon">üëî</div>
        <div class="header-info">
          <h1>GERENTE</h1>
          <p id="nombre-bien">Cargando...</p>
        </div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <span class="header-badge" id="header-badge">Explotaci√≥n activa</span>
      <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
    </div>
  </header>

  <!-- ========== LAYOUT ========== -->
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <!-- PANEL DE CONTROL -->
      <div class="sidebar-section">
        <nav class="sidebar-nav">
          <button class="sidebar-link active" data-section="dashboard">
            <span class="sidebar-link-icon">üìä</span>
            Panel de Control
          </button>
        </nav>
      </div>

      <!-- OPERACIONES -->
      <div class="sidebar-section">
        <div class="sidebar-title">Operaciones</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link" onclick="irAModulo('reservas-gerente')">
            <span class="sidebar-link-icon">üìÖ</span>
            Reservas
          </button>
          <button class="sidebar-link" onclick="irAModulo('huespedes-gerente')">
            <span class="sidebar-link-icon">üõèÔ∏è</span>
            Hu√©spedes
          </button>
          <button class="sidebar-link" onclick="irAModulo('actividades-gerente')">
            <span class="sidebar-link-icon">üéØ</span>
            Actividades
          </button>
          <button class="sidebar-link" onclick="irAModulo('servicios-externos-gerente')">
            <span class="sidebar-link-icon">üöê</span>
            Servicios Externos
          </button>
        </nav>
      </div>

      <div class="sidebar-divider"></div>

      <!-- MANTENIMIENTO DEL BIEN -->
      <div class="sidebar-section">
        <div class="sidebar-title">Mantenimiento del bien</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link" onclick="irAModulo('mantenimiento')">
            <span class="sidebar-link-icon">üîß</span>
            Mantenimiento
          </button>
          <button class="sidebar-link" onclick="irAModulo('limpieza')">
            <span class="sidebar-link-icon">üßπ</span>
            Limpieza
          </button>
          <button class="sidebar-link" onclick="irAModulo('inventario-config')">
            <span class="sidebar-link-icon">üì¶</span>
            Inventario
          </button>
        </nav>
      </div>

      <div class="sidebar-divider"></div>

      <!-- ECON√ìMICO -->
      <div class="sidebar-section">
        <div class="sidebar-title">Econ√≥mico</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link" onclick="irAModulo('ingresos-gerente')">
            <span class="sidebar-link-icon">üí∞</span>
            Ingresos
          </button>
          <button class="sidebar-link" onclick="irAModulo('gastos-gerente')">
            <span class="sidebar-link-icon">üí∂</span>
            Gastos
          </button>
          <button class="sidebar-link" onclick="irAModulo('estadisticas-gerente')">
            <span class="sidebar-link-icon">üìà</span>
            Estad√≠sticas
          </button>
        </nav>
      </div>

      <div class="sidebar-divider"></div>

      <!-- CONFIGURACI√ìN -->
      <div class="sidebar-section">
        <div class="sidebar-title">Configuraci√≥n</div>
        <nav class="sidebar-nav">
          <button class="sidebar-link" onclick="irAModulo('habitaciones-gerente')">
            <span class="sidebar-link-icon">üè®</span>
            Habitaciones
          </button>
          <button class="sidebar-link" onclick="irAModulo('tarifas-gerente')">
            <span class="sidebar-link-icon">üí≤</span>
            Tarifas
          </button>
          <button class="sidebar-link" onclick="irAModulo('plantilla')">
            <span class="sidebar-link-icon">üìã</span>
            Plantilla B√°sica
          </button>
          <button class="sidebar-link" data-section="hosters">
            <span class="sidebar-link-icon">üè†</span>
            Hosters
          </button>
          <button class="sidebar-link" onclick="irAModulo('informes-gerente')">
            <span class="sidebar-link-icon">üìÑ</span>
            Informes
          </button>
        </nav>
      </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main">

      <!-- ==================== DASHBOARD ==================== -->
      <section class="section active" id="section-dashboard">
        <div class="section-header">
          <h2 class="section-title">üëî Panel de Control</h2>
          <p class="section-description">Acceso r√°pido a todos los m√≥dulos del Gerente</p>
        </div>

        <!-- Stats resumen r√°pido -->
        <div class="stats-bar" id="stats-bar">
          <div class="stat-mini highlight">
            <div class="stat-mini-value" id="stat-reservas-mes">‚Äî</div>
            <div class="stat-mini-label">Reservas este mes</div>
          </div>
          <div class="stat-mini gold-bg">
            <div class="stat-mini-value" id="stat-ingresos-mes">‚Äî</div>
            <div class="stat-mini-label">Ingresos mes</div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini-value" id="stat-ocupacion">‚Äî</div>
            <div class="stat-mini-label">Ocupaci√≥n</div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini-value" id="stat-pendientes">‚Äî</div>
            <div class="stat-mini-label">Pendientes</div>
          </div>
        </div>

        <!-- OPERACIONES -->
        <div class="dashboard-group">
          <div class="dashboard-group-title">üè® Operaciones</div>
          <div class="dashboard-grid" id="grid-operaciones">
            <!-- Se genera din√°micamente seg√∫n m√≥dulos activados -->
          </div>
        </div>

        <!-- MANTENIMIENTO DEL BIEN -->
        <div class="dashboard-group">
          <div class="dashboard-group-title">üîß Mantenimiento del bien</div>
          <div class="dashboard-grid" id="grid-mantenimiento">
          </div>
        </div>

        <!-- ECON√ìMICO -->
        <div class="dashboard-group">
          <div class="dashboard-group-title">üí∞ Econ√≥mico</div>
          <div class="dashboard-grid" id="grid-economico">
          </div>
        </div>

        <!-- CONFIGURACI√ìN -->
        <div class="dashboard-group">
          <div class="dashboard-group-title">‚öôÔ∏è Configuraci√≥n</div>
          <div class="dashboard-grid" id="grid-configuracion">
          </div>
        </div>
      </section>

      <!-- ==================== HOSTERS (secci√≥n interna) ==================== -->
      <section class="section" id="section-hosters">
        <div class="section-header">
          <h2 class="section-title">üè† Hosters</h2>
          <p class="section-description">Personal externo con acceso a gesti√≥n de reservas y hu√©spedes</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üë• Hosters activos</h3>
            <button class="btn btn-gerente btn-sm" onclick="irAGestionHosters()">‚öôÔ∏è Gestionar en Bien</button>
          </div>
          <div class="card-body">
            <div id="lista-hosters">
              <div class="empty-state">
                <div class="empty-state-icon">üè†</div>
                <div class="empty-state-title">No hay hosters configurados</div>
                <div class="empty-state-text">Los hosters se crean y gestionan desde la ficha del bien.</div>
                <button class="btn btn-gerente" onclick="irAGestionHosters()">Ir a gesti√≥n de Hosters</button>
              </div>
            </div>
          </div>
        </div>

        <div class="info-box" style="margin-top: 20px;">
          <strong>üí° ¬øQu√© es un Hoster?</strong><br>
          Persona externa (gestor de alquileres, conserje, administrador) con acceso limitado para gestionar reservas, check-in/out, comunicarse con hu√©spedes y registrar incidencias. El Hoster accede a trav√©s de <strong>hoster.html</strong> con su propia cuenta y permisos VCEB configurables.
        </div>
      </section>

    </main>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    // ========== CONFIG ==========
    const firebaseConfig = {
      apiKey: "AIzaSyCprj6aJPl0dSYsv5xvLdJLylPEyFKpMPw",
      authDomain: "familynk-f93e8.firebaseapp.com",
      projectId: "familynk-f93e8",
      storageBucket: "familynk-f93e8.firebasestorage.app",
      messagingSenderId: "271953793018",
      appId: "1:271953793018:web:f7c548f98bda953f8bd498"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ========== VARIABLES ==========
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let esAdminRama = false;
    let modulosActivados = {};

    // ========== DEFINICI√ìN DE M√ìDULOS ==========
    const MODULOS_GERENTE = {
      // OPERACIONES
      'reservas-gerente': {
        icon: 'üìÖ', nombre: 'Reservas',
        desc: 'Gesti√≥n de estancias comerciales con tarifas, confirmaci√≥n y calendario de ocupaci√≥n.',
        grupo: 'operaciones', iconClass: ''
      },
      'huespedes-gerente': {
        icon: 'üõèÔ∏è', nombre: 'Hu√©spedes',
        desc: 'Registro de titulares, acompa√±antes e invitados. Control de estancias activas.',
        grupo: 'operaciones', iconClass: ''
      },
      'actividades-gerente': {
        icon: 'üéØ', nombre: 'Actividades',
        desc: 'Excursiones, visitas, eventos y experiencias vinculadas a reservas.',
        grupo: 'operaciones', iconClass: ''
      },
      'servicios-externos-gerente': {
        icon: 'üöê', nombre: 'Servicios Externos',
        desc: 'Traslados, catering, gu√≠as y otros servicios contratados bajo demanda.',
        grupo: 'operaciones', iconClass: 'terracotta'
      },

      // MANTENIMIENTO DEL BIEN
      'mantenimiento': {
        icon: 'üîß', nombre: 'Mantenimiento',
        desc: 'Reparaciones, mantenimiento programado e incidencias del inmueble.',
        grupo: 'mantenimiento', iconClass: ''
      },
      'limpieza': {
        icon: 'üßπ', nombre: 'Limpieza',
        desc: 'Planificaci√≥n de limpiezas vinculadas a check-out y calendario.',
        grupo: 'mantenimiento', iconClass: ''
      },
      'inventario-config': {
        icon: 'üì¶', nombre: 'Inventario',
        desc: 'Control de productos consumibles, lencer√≠a, vajilla y stock.',
        grupo: 'mantenimiento', iconClass: ''
      },

      // ECON√ìMICO
      'ingresos-gerente': {
        icon: 'üí∞', nombre: 'Ingresos',
        desc: 'Facturaci√≥n por estancias, hospitalidad, actividades y servicios.',
        grupo: 'economico', iconClass: 'gold'
      },
      'gastos-gerente': {
        icon: 'üí∂', nombre: 'Gastos',
        desc: 'Registro de costes operativos: suministros, personal, mantenimiento.',
        grupo: 'economico', iconClass: ''
      },
      'estadisticas-gerente': {
        icon: 'üìà', nombre: 'Estad√≠sticas',
        desc: 'Ocupaci√≥n, rentabilidad, margen operativo y an√°lisis por per√≠odo.',
        grupo: 'economico', iconClass: 'gold'
      },

      // CONFIGURACI√ìN
      'habitaciones-gerente': {
        icon: 'üè®', nombre: 'Habitaciones',
        desc: 'Configuraci√≥n de alojamientos, espacios y servicios por habitaci√≥n.',
        grupo: 'configuracion', iconClass: ''
      },
      'tarifas-gerente': {
        icon: 'üí≤', nombre: 'Tarifas',
        desc: 'Precios base por noche, hospitalidad, actividades y descuentos familiares.',
        grupo: 'configuracion', iconClass: 'gold'
      },
      'plantilla': {
        icon: 'üìã', nombre: 'Plantilla B√°sica',
        desc: 'Subgrupos para organizar productos del inventario.',
        grupo: 'configuracion', iconClass: ''
      },
      'informes-gerente': {
        icon: 'üìÑ', nombre: 'Informes',
        desc: 'Resumen de estancias, informes de hosters y encuestas de satisfacci√≥n.',
        grupo: 'configuracion', iconClass: ''
      }
    };

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');

      if (!bienId) {
        alert('No se ha especificado el bien');
        window.location.href = 'lo-comun.html';
        return;
      }

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await cargarBien();
          await cargarModulosActivados();
          renderDashboard();
          initEventListeners();
        } else {
          window.location.href = 'login.html';
        }
      });
    });

    // ========== CARGAR DATOS ==========
    async function cargarBien() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (doc.exists) {
          bienData = doc.data();
          document.getElementById('nombre-bien').textContent = bienData.nombre || 'Sin nombre';
          document.getElementById('btn-volver').href = `bien.html?id=${bienId}`;

          // Verificar si es admin
          const userDoc = await db.collection('usuarios').doc(currentUser.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            esAdminRama = userData.rol === 'adminRama' || userData.rol === 'adminSistema';
          }
        }
      } catch (error) {
        console.error('Error cargando bien:', error);
      }
    }

    async function cargarModulosActivados() {
      try {
        // Leer m√≥dulos activados del bien para Gerente
        if (bienData && bienData.modulosGerente) {
          modulosActivados = bienData.modulosGerente;
        } else {
          // Si no hay config, activar todos por defecto
          Object.keys(MODULOS_GERENTE).forEach(key => {
            modulosActivados[key] = true;
          });
        }
      } catch (error) {
        console.error('Error cargando m√≥dulos:', error);
      }
    }

    async function cargarStatsResumen() {
      // Stats r√°pidas del dashboard
      try {
        const bienRef = db.collection('bienes').doc(bienId);

        // Reservas del mes actual
        const ahora = new Date();
        const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
        const finMes = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 0, 23, 59, 59);

        const reservasSnap = await bienRef.collection('reservas')
          .where('fechaInicio', '>=', firebase.firestore.Timestamp.fromDate(inicioMes))
          .where('fechaInicio', '<=', firebase.firestore.Timestamp.fromDate(finMes))
          .get();

        document.getElementById('stat-reservas-mes').textContent = reservasSnap.size;

        // Pendientes de confirmar
        const pendientesSnap = await bienRef.collection('solicitudes')
          .where('estado', '==', 'pendiente')
          .get();
        document.getElementById('stat-pendientes').textContent = pendientesSnap.size;

      } catch (error) {
        console.log('Stats pendientes de datos:', error.message);
        // Dejar los valores por defecto (‚Äî)
      }
    }

    // ========== RENDER DASHBOARD ==========
    function renderDashboard() {
      const grupos = {
        operaciones: document.getElementById('grid-operaciones'),
        mantenimiento: document.getElementById('grid-mantenimiento'),
        economico: document.getElementById('grid-economico'),
        configuracion: document.getElementById('grid-configuracion')
      };

      // Limpiar
      Object.values(grupos).forEach(g => g.innerHTML = '');

      // Generar cards por grupo
      Object.entries(MODULOS_GERENTE).forEach(([key, mod]) => {
        const activo = modulosActivados[key] !== false;
        const card = document.createElement('div');
        card.className = `dashboard-card ${!activo ? 'disabled' : ''}`;
        card.onclick = activo ? () => irAModulo(key) : null;

        card.innerHTML = `
          <div class="dashboard-card-icon ${mod.iconClass || ''}">${mod.icon}</div>
          <div class="dashboard-card-name">${mod.nombre}</div>
          <div class="dashboard-card-desc">${mod.desc}</div>
          <div class="dashboard-card-status">
            <span class="status-dot ${activo ? '' : 'inactive'}"></span>
            ${activo ? 'Activo' : 'No activado'}
          </div>
        `;

        if (grupos[mod.grupo]) {
          grupos[mod.grupo].appendChild(card);
        }
      });

      // A√±adir card de Hosters al grupo configuraci√≥n
      const hosterCard = document.createElement('div');
      hosterCard.className = 'dashboard-card';
      hosterCard.onclick = () => cambiarSeccion('hosters');
      hosterCard.innerHTML = `
        <div class="dashboard-card-icon">üè†</div>
        <div class="dashboard-card-name">Hosters</div>
        <div class="dashboard-card-desc">Personal externo con acceso a gesti√≥n de reservas y hu√©spedes.</div>
        <div class="dashboard-card-status">
          <span class="status-dot"></span>
          Configuraci√≥n
        </div>
      `;
      grupos.configuracion.appendChild(hosterCard);

      // Cargar stats
      cargarStatsResumen();
    }

    // ========== NAVEGACI√ìN ==========
    function irAModulo(modulo) {
      if (!bienId) {
        alert('Error: no se ha identificado el bien');
        return;
      }
      window.location.href = `${modulo}.html?id=${bienId}&origen=gerente`;
    }

    function cambiarSeccion(seccion) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));

      const section = document.getElementById(`section-${seccion}`);
      const link = document.querySelector(`[data-section="${seccion}"]`);

      if (section) section.classList.add('active');
      if (link) link.classList.add('active');

      // Cerrar men√∫ m√≥vil
      document.getElementById('sidebar').classList.remove('mobile-open');
    }

    function irAGestionHosters() {
      window.location.href = `bien.html?id=${bienId}#hosters`;
    }

    function initEventListeners() {
      // Links con data-section (navegaci√≥n interna)
      document.querySelectorAll('.sidebar-link[data-section]').forEach(link => {
        link.addEventListener('click', () => {
          cambiarSeccion(link.dataset.section);
        });
      });
    }

    // ========== MOBILE ==========
    function toggleMobileMenu() {
      document.getElementById('sidebar').classList.toggle('mobile-open');
    }

    // Cerrar men√∫ al hacer click fuera en m√≥vil
    document.addEventListener('click', (e) => {
      const sidebar = document.getElementById('sidebar');
      const btn = document.getElementById('mobile-menu-btn');
      if (sidebar.classList.contains('mobile-open') &&
          !sidebar.contains(e.target) &&
          !btn.contains(e.target)) {
        sidebar.classList.remove('mobile-open');
      }
    });
  </script>
</body>
</html>
