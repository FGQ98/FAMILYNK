<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Configurar tu familia</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header minimalista */
    .header {
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-light) 100%);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .logo-text {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--sage-dark);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .logout-btn {
      padding: 6px 12px;
      background: var(--white);
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: var(--cream-dark);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .onboarding-container {
      width: 100%;
      max-width: 560px;
    }

    /* Progress */
    .progress-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .progress-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      background: var(--cream-dark);
      color: var(--text-muted);
      transition: all 0.3s;
    }

    .progress-dot.active {
      background: var(--sage);
      color: white;
    }

    .progress-dot.completed {
      background: var(--sage-dark);
      color: white;
    }

    .progress-line {
      width: 60px;
      height: 3px;
      background: var(--cream-dark);
      border-radius: 2px;
      transition: all 0.3s;
    }

    .progress-line.completed {
      background: var(--sage);
    }

    /* Card */
    .onboarding-card {
      background: var(--white);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-float);
      overflow: hidden;
    }

    .card-header {
      padding: 32px 32px 0;
      text-align: center;
    }

    .card-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .card-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .card-subtitle {
      color: var(--text-light);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .card-body {
      padding: 32px;
    }

    .card-footer {
      padding: 0 32px 32px;
      display: flex;
      gap: 12px;
      justify-content: space-between;
    }

    /* Forms */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .form-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--sage);
      box-shadow: 0 0 0 3px var(--sage-muted);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    /* Generaciones selector */
    .gen-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .gen-option {
      position: relative;
    }

    .gen-option input {
      position: absolute;
      opacity: 0;
    }

    .gen-option label {
      display: block;
      padding: 16px;
      background: var(--cream-medium);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .gen-option input:checked + label {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .gen-option label:hover {
      border-color: var(--sage-light);
    }

    .gen-emoji {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 4px;
    }

    .gen-name {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .gen-desc {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* Buttons */
    .btn {
      padding: 14px 24px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      color: white;
      flex: 1;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-float);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--cream);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--cream-dark);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-light);
      padding: 14px 16px;
    }

    .btn-ghost:hover {
      color: var(--text);
    }

    /* Steps */
    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    /* Success */
    .success-animation {
      text-align: center;
      padding: 20px 0;
    }

    .success-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      animation: bounce 0.6s ease;
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .success-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .success-subtitle {
      color: var(--text-light);
      margin-bottom: 24px;
    }

    /* Miembros preview */
    .miembros-preview {
      background: var(--cream-medium);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-top: 16px;
    }

    .miembros-preview-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 12px;
    }

    .miembros-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .miembro-tag {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px 6px 6px;
      background: var(--white);
      border-radius: 20px;
      font-size: 0.85rem;
    }

    .miembro-tag-avatar {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-light) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
    }

    .miembro-tag-remove {
      margin-left: 4px;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }

    .miembro-tag-remove:hover {
      color: var(--terracotta);
    }

    .add-miembro-inline {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .add-miembro-inline input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
    }

    .add-miembro-inline button {
      padding: 8px 16px;
      background: var(--sage);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">ü™∫</div>
      <span class="logo-text">FAMILYNK</span>
    </div>
    <div class="user-info">
      <span id="user-email">...</span>
      <button class="logout-btn" id="logout-btn">Salir</button>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <div class="onboarding-container">
      <!-- Progress -->
      <div class="progress-bar">
        <div class="progress-step">
          <div class="progress-dot active" id="dot-1">1</div>
        </div>
        <div class="progress-line" id="line-1"></div>
        <div class="progress-step">
          <div class="progress-dot" id="dot-2">2</div>
        </div>
        <div class="progress-line" id="line-2"></div>
        <div class="progress-step">
          <div class="progress-dot" id="dot-3">3</div>
        </div>
      </div>

      <!-- Card -->
      <div class="onboarding-card">
        <!-- PASO 1: Crear Familia -->
        <div class="step active" id="step-1">
          <div class="card-header">
            <div class="card-icon">üå≥</div>
            <h1 class="card-title">Crea tu familia</h1>
            <p class="card-subtitle">Dale un nombre a tu √°rbol familiar. Ser√° el paraguas que agrupe todos los nidos.</p>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Nombre de la familia</label>
              <input type="text" class="form-input" id="familia-nombre" placeholder="Ej: Garc√≠a-L√≥pez, Los Mart√≠nez...">
            </div>
            <div class="form-group">
              <label class="form-label">
                Descripci√≥n 
                <span class="form-hint">(opcional)</span>
              </label>
              <input type="text" class="form-input" id="familia-descripcion" placeholder="Ej: Nuestra familia desde 1950">
            </div>
          </div>
          <div class="card-footer">
            <div></div>
            <button class="btn btn-primary" id="btn-step1-next" disabled>
              Continuar ‚Üí
            </button>
          </div>
        </div>

        <!-- PASO 2: Tu generaci√≥n -->
        <div class="step" id="step-2">
          <div class="card-header">
            <div class="card-icon">üë§</div>
            <h1 class="card-title">¬øEn qu√© generaci√≥n est√°s t√∫?</h1>
            <p class="card-subtitle">Esto nos ayuda a organizar el √°rbol. Podr√°s crear nidos de otras generaciones despu√©s.</p>
          </div>
          <div class="card-body">
            <div class="gen-selector">
              <div class="gen-option">
                <input type="radio" name="mi-generacion" id="gen-1" value="1-bisabuelos">
                <label for="gen-1">
                  <span class="gen-emoji">üë¥üëµ</span>
                  <span class="gen-name">Gen. 1</span>
                  <span class="gen-desc">Bisabuelos</span>
                </label>
              </div>
              <div class="gen-option">
                <input type="radio" name="mi-generacion" id="gen-2" value="2-padres">
                <label for="gen-2">
                  <span class="gen-emoji">üë®üë©</span>
                  <span class="gen-name">Gen. 2</span>
                  <span class="gen-desc">Padres</span>
                </label>
              </div>
              <div class="gen-option">
                <input type="radio" name="mi-generacion" id="gen-3" value="3-nietos">
                <label for="gen-3">
                  <span class="gen-emoji">üßëüßí</span>
                  <span class="gen-name">Gen. 3</span>
                  <span class="gen-desc">Nietos</span>
                </label>
              </div>
              <div class="gen-option">
                <input type="radio" name="mi-generacion" id="gen-4" value="4-bisnietos">
                <label for="gen-4">
                  <span class="gen-emoji">üë∂</span>
                  <span class="gen-name">Gen. 4</span>
                  <span class="gen-desc">Bisnietos</span>
                </label>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn btn-ghost" id="btn-step2-back">‚Üê Volver</button>
            <button class="btn btn-primary" id="btn-step2-next" disabled>
              Continuar ‚Üí
            </button>
          </div>
        </div>

        <!-- PASO 3: Tu primer nido -->
        <div class="step" id="step-3">
          <div class="card-header">
            <div class="card-icon">ü™∫</div>
            <h1 class="card-title">Crea tu primer nido</h1>
            <p class="card-subtitle">Un nido es tu unidad familiar (t√∫ solo, con pareja, con hijos...). Puedes a√±adir m√°s despu√©s.</p>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Nombre del nido</label>
              <input type="text" class="form-input" id="nido-nombre" placeholder="Ej: Nido Felipe, Casa Madrid...">
            </div>
            <div class="form-group">
              <label class="form-label">
                Relaci√≥n 
                <span class="form-hint">(opcional)</span>
              </label>
              <select class="form-input" id="nido-relacion">
                <option value="">Sin especificar</option>
                <option value="soltero">Soltero/a</option>
                <option value="novios">Novios</option>
                <option value="prometidos">Prometidos</option>
                <option value="de-hecho">Pareja de hecho</option>
                <option value="matrimonio">Matrimonio</option>
                <option value="separados">Separados</option>
                <option value="divorciados">Divorciados</option>
              </select>
            </div>

            <!-- Miembros -->
            <div class="miembros-preview">
              <div class="miembros-preview-title">Miembros del nido</div>
              <div class="miembros-list" id="miembros-list">
                <!-- Se a√±ade el usuario autom√°ticamente -->
              </div>
              <div class="add-miembro-inline">
                <input type="text" id="nuevo-miembro-nombre" placeholder="Nombre (ej: Elena)">
                <input type="text" id="nuevo-miembro-iniciales" placeholder="Inic." style="width: 60px;">
                <button type="button" id="btn-add-miembro">+ A√±adir</button>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn btn-ghost" id="btn-step3-back">‚Üê Volver</button>
            <button class="btn btn-primary" id="btn-step3-finish">
              üöÄ Crear y empezar
            </button>
          </div>
        </div>

        <!-- PASO FINAL: √âxito -->
        <div class="step" id="step-success">
          <div class="card-body">
            <div class="success-animation">
              <div class="success-icon">üéâ</div>
              <h2 class="success-title">¬°Tu familia est√° lista!</h2>
              <p class="success-subtitle">Has creado "<span id="success-familia-nombre"></span>" con tu primer nido.</p>
              <button class="btn btn-primary" id="btn-go-dashboard" style="width: 100%;">
                Ir a mi dashboard ‚Üí
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let miembrosNido = [];

    // Estado del onboarding
    let onboardingData = {
      familia: {
        nombre: '',
        descripcion: ''
      },
      miGeneracion: '',
      nido: {
        nombre: '',
        relacion: ''
      }
    };

    // Check auth
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;
      document.getElementById('user-email').textContent = user.email;

      // Verificar si ya tiene familia
      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (userDoc.exists && userDoc.data().familiaId) {
        // Ya tiene familia, ir al dashboard
        window.location.href = 'app.html';
        return;
      }

      // A√±adir usuario como primer miembro del nido
      const nombre = user.displayName || user.email.split('@')[0];
      miembrosNido.push({
        nombre: nombre,
        iniciales: nombre.substring(0, 2).toUpperCase(),
        esAdmin: true,
        esCreador: true
      });
      renderMiembros();
    });

    // ===================
    // STEP NAVIGATION
    // ===================
    function showStep(stepNum) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(`step-${stepNum}`).classList.add('active');

      // Update progress
      for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById(`dot-${i}`);
        const line = document.getElementById(`line-${i}`);
        
        dot.classList.remove('active', 'completed');
        if (i < stepNum) {
          dot.classList.add('completed');
          dot.textContent = '‚úì';
        } else if (i === stepNum) {
          dot.classList.add('active');
          dot.textContent = i;
        } else {
          dot.textContent = i;
        }

        if (line) {
          line.classList.toggle('completed', i < stepNum);
        }
      }
    }

    // ===================
    // STEP 1: Familia
    // ===================
    const familiaNombreInput = document.getElementById('familia-nombre');
    const btnStep1Next = document.getElementById('btn-step1-next');

    familiaNombreInput.addEventListener('input', () => {
      btnStep1Next.disabled = familiaNombreInput.value.trim().length < 2;
    });

    btnStep1Next.addEventListener('click', () => {
      onboardingData.familia.nombre = familiaNombreInput.value.trim();
      onboardingData.familia.descripcion = document.getElementById('familia-descripcion').value.trim();
      showStep(2);
    });

    // ===================
    // STEP 2: Generaci√≥n
    // ===================
    const genRadios = document.querySelectorAll('input[name="mi-generacion"]');
    const btnStep2Next = document.getElementById('btn-step2-next');

    genRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        btnStep2Next.disabled = false;
      });
    });

    document.getElementById('btn-step2-back').addEventListener('click', () => showStep(1));

    btnStep2Next.addEventListener('click', () => {
      const selected = document.querySelector('input[name="mi-generacion"]:checked');
      onboardingData.miGeneracion = selected.value;
      showStep(3);
    });

    // ===================
    // STEP 3: Nido
    // ===================
    document.getElementById('btn-step3-back').addEventListener('click', () => showStep(2));

    // Render miembros
    function renderMiembros() {
      const list = document.getElementById('miembros-list');
      list.innerHTML = miembrosNido.map((m, idx) => `
        <div class="miembro-tag">
          <div class="miembro-tag-avatar">${m.iniciales}</div>
          <span>${m.nombre}</span>
          ${m.esCreador ? '' : `<span class="miembro-tag-remove" onclick="removeMiembro(${idx})">√ó</span>`}
        </div>
      `).join('');
    }

    window.removeMiembro = function(idx) {
      miembrosNido.splice(idx, 1);
      renderMiembros();
    };

    // A√±adir miembro
    document.getElementById('btn-add-miembro').addEventListener('click', () => {
      const nombre = document.getElementById('nuevo-miembro-nombre').value.trim();
      let iniciales = document.getElementById('nuevo-miembro-iniciales').value.trim().toUpperCase();
      
      if (!nombre) return;
      if (!iniciales) iniciales = nombre.substring(0, 2).toUpperCase();

      miembrosNido.push({
        nombre: nombre,
        iniciales: iniciales,
        esAdmin: false,
        esCreador: false
      });

      document.getElementById('nuevo-miembro-nombre').value = '';
      document.getElementById('nuevo-miembro-iniciales').value = '';
      renderMiembros();
    });

    // ===================
    // CREAR TODO
    // ===================
    document.getElementById('btn-step3-finish').addEventListener('click', async () => {
      const btn = document.getElementById('btn-step3-finish');
      btn.disabled = true;
      btn.textContent = 'Creando...';

      const nidoNombre = document.getElementById('nido-nombre').value.trim() || 'Mi Nido';
      const nidoRelacion = document.getElementById('nido-relacion').value;

      try {
        // 1. Crear la FAMILIA
        const familiaRef = await db.collection('familias').add({
          nombre: onboardingData.familia.nombre,
          descripcion: onboardingData.familia.descripcion,
          creador: currentUser.uid,
          adminsGenerales: [currentUser.uid],
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Crear el primer NIDO
        const miembrosData = miembrosNido.map(m => ({
          iniciales: m.iniciales,
          nombre: m.nombre,
          fechaNacimiento: null,
          fechaDefuncion: null,
          esAdmin: m.esAdmin,
          fechaCreacion: new Date().toISOString()
        }));

        await db.collection('nidos').add({
          familiaId: familiaRef.id,
          nombre: nidoNombre,
          generacion: onboardingData.miGeneracion,
          relacion: nidoRelacion,
          descripcion: '',
          creador: currentUser.uid,
          miembros: [currentUser.uid],
          admins: [currentUser.uid],
          miembrosData: miembrosData,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 3. Actualizar el USUARIO con la familiaId
        await db.collection('usuarios').doc(currentUser.uid).set({
          email: currentUser.email,
          nombre: currentUser.displayName || currentUser.email.split('@')[0],
          familiaId: familiaRef.id,
          fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // 4. Mostrar √©xito
        document.getElementById('success-familia-nombre').textContent = onboardingData.familia.nombre;
        showStep('success');

      } catch (error) {
        console.error('Error en onboarding:', error);
        alert('Error al crear la familia. Int√©ntalo de nuevo.');
        btn.disabled = false;
        btn.textContent = 'üöÄ Crear y empezar';
      }
    });

    // Ir al dashboard
    document.getElementById('btn-go-dashboard').addEventListener('click', () => {
      window.location.href = 'app.html';
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await auth.signOut();
      window.location.href = 'login.html';
    });
  </script>
</body>
</html>
