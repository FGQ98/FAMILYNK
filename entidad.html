<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Entidad</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --gerente: #2D4A5C;
      --gerente-light: #4A6B7C;
      --gerente-dark: #1D3544;
      --gerente-muted: rgba(45, 74, 92, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, var(--gerente) 0%, var(--gerente-dark) 100%);
      padding: 16px 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky; top: 0; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 14px; background: rgba(255,255,255,0.15);
      border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem; color: white;
      cursor: pointer; text-decoration: none; transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.25); }
    .header-title { display: flex; align-items: center; gap: 12px; color: white; }
    .header-title h1 { font-family: 'Quicksand', sans-serif; font-size: 1.2rem; font-weight: 700; }
    .header-title .icon { font-size: 1.4rem; }
    .header-subtitle { font-size: 0.78rem; opacity: 0.8; }

    .btn {
      padding: 10px 18px; border: none; border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 0.85rem;
      cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-primary { background: var(--gerente); color: white; }
    .btn-primary:hover { background: var(--gerente-dark); }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-secondary:hover { background: #EDE5DB; }
    .btn-white { background: rgba(255,255,255,0.2); color: white; }
    .btn-white:hover { background: rgba(255,255,255,0.35); }

    .content { max-width: 800px; margin: 0 auto; padding: 24px; }

    /* ========== CARDS ========== */
    .section-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .section-card-header {
      padding: 14px 20px;
      font-family: 'Quicksand', sans-serif;
      font-weight: 700; font-size: 0.9rem;
      color: white;
      background: linear-gradient(135deg, var(--gerente), var(--gerente-dark));
      display: flex; align-items: center; gap: 10px;
    }
    .section-card-body { padding: 20px; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .form-group { margin-bottom: 14px; }
    .form-label {
      display: block; font-size: 0.78rem; font-weight: 600;
      color: var(--text-light); margin-bottom: 4px;
    }
    .form-input, .form-textarea, .form-select {
      width: 100%; padding: 10px 12px;
      border: 1px solid var(--cream-dark); border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif; font-size: 0.85rem;
      background: var(--cream-medium); transition: border 0.2s;
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none; border-color: var(--gerente); background: var(--white);
    }
    .form-textarea { resize: vertical; min-height: 60px; }

    /* ========== TITULARES TABLA ========== */
    .titulares-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .titulares-table th {
      text-align: left; padding: 8px 10px;
      font-size: 0.72rem; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.3px;
      border-bottom: 2px solid var(--cream-dark);
    }
    .titulares-table td { padding: 6px 4px; vertical-align: middle; }
    .titulares-table input {
      width: 100%; padding: 7px 8px;
      border: 1px solid var(--cream-dark); border-radius: 6px;
      font-family: 'Nunito', sans-serif; font-size: 0.82rem;
      background: var(--cream-medium);
    }
    .titulares-table input:focus { outline: none; border-color: var(--gerente); background: var(--white); }
    .btn-remove-row {
      background: none; border: none; cursor: pointer;
      font-size: 1rem; color: var(--error); opacity: 0.6; transition: opacity 0.2s;
    }
    .btn-remove-row:hover { opacity: 1; }
    .btn-add-row {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 6px 12px; margin-top: 8px;
      background: var(--gerente-muted); border: 1px dashed var(--gerente-light);
      border-radius: var(--radius-sm); color: var(--gerente);
      font-family: 'Nunito', sans-serif; font-size: 0.78rem; font-weight: 700;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-add-row:hover { background: rgba(45,74,92,0.2); }

    /* ========== FOOTER ACTIONS ========== */
    .footer-actions {
      position: sticky; bottom: 0;
      background: var(--white); border-top: 1px solid var(--cream-dark);
      padding: 16px 24px;
      display: flex; justify-content: flex-end; gap: 8px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
    }

    /* ========== EMPTY STATE ========== */
    .empty-note {
      text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;
    }

    /* ========== BADGE ========== */
    .badge-tipo {
      display: inline-block; padding: 3px 10px;
      border-radius: var(--radius-full); font-size: 0.72rem; font-weight: 700;
      background: var(--gerente-muted); color: var(--gerente);
    }

    @media (max-width: 600px) {
      .header { padding: 12px 16px; }
      .content { padding: 16px; }
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-left">
      <a id="btn-volver" href="gerente.html" class="back-btn">‚Üê Gerente</a>
      <div class="header-title">
        <span class="icon">üèõÔ∏è</span>
        <div>
          <h1>Entidad</h1>
          <div class="header-subtitle" id="nombre-bien">Cargando...</div>
        </div>
      </div>
    </div>
  </header>

  <div class="content">

    <!-- 1. DATOS DE LA ENTIDAD -->
    <div class="section-card">
      <div class="section-card-header">üèõÔ∏è Datos de la entidad</div>
      <div class="section-card-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Tipo de entidad</label>
            <select class="form-select" id="ent-tipo">
              <option value="">‚Äî Seleccionar ‚Äî</option>
              <option value="persona_fisica">Persona f√≠sica</option>
              <option value="autonomo">Aut√≥nomo</option>
              <option value="sociedad_limitada">Sociedad Limitada (SL)</option>
              <option value="sociedad_anonima">Sociedad An√≥nima (SA)</option>
              <option value="comunidad_bienes">Comunidad de Bienes (CB)</option>
              <option value="sociedad_civil">Sociedad Civil</option>
              <option value="cooperativa">Cooperativa</option>
              <option value="asociacion">Asociaci√≥n</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">NIF / CIF</label>
            <input type="text" class="form-input" id="ent-nif" placeholder="B12345678">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Nombre / Raz√≥n social</label>
          <input type="text" class="form-input" id="ent-razonSocial" placeholder="Nombre completo o denominaci√≥n social">
        </div>
        <div class="form-group">
          <label class="form-label">Domicilio social / fiscal</label>
          <input type="text" class="form-input" id="ent-domicilio" placeholder="Direcci√≥n completa">
        </div>
      </div>
    </div>

    <!-- 2. DATOS FISCALES -->
    <div class="section-card">
      <div class="section-card-header">üí∂ Datos fiscales</div>
      <div class="section-card-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">R√©gimen fiscal</label>
            <select class="form-select" id="ent-regimenFiscal">
              <option value="">‚Äî Seleccionar ‚Äî</option>
              <option value="general">R√©gimen General</option>
              <option value="simplificado">Simplificado</option>
              <option value="estimacion_directa">Estimaci√≥n Directa</option>
              <option value="estimacion_objetiva">Estimaci√≥n Objetiva (M√≥dulos)</option>
              <option value="exento">Exento</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Ep√≠grafe IAE</label>
            <input type="text" class="form-input" id="ent-epigrafeIAE" placeholder="Ej: 861.1 ‚Äî Alquiler viviendas">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">N¬∫ Licencia tur√≠stica</label>
            <input type="text" class="form-input" id="ent-licenciaTuristica" placeholder="Si aplica">
          </div>
          <div class="form-group">
            <label class="form-label">N¬∫ Registro explotaci√≥n</label>
            <input type="text" class="form-input" id="ent-registroExplotacion" placeholder="Si aplica (agr√≠cola, ganadera...)">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Observaciones fiscales</label>
          <textarea class="form-textarea" id="ent-notasFiscales" rows="2" placeholder="IVA, retenciones, particularidades..."></textarea>
        </div>
      </div>
    </div>

    <!-- 3. TITULARES / SOCIOS -->
    <div class="section-card">
      <div class="section-card-header">üë• Titulares / Socios</div>
      <div class="section-card-body">
        <table class="titulares-table">
          <thead>
            <tr>
              <th style="width:40%;">Nombre</th>
              <th style="width:18%;">NIF</th>
              <th style="width:15%;">% Participaci√≥n</th>
              <th style="width:20%;">Rol</th>
              <th style="width:7%;"></th>
            </tr>
          </thead>
          <tbody id="titulares-body"></tbody>
        </table>
        <button class="btn-add-row" onclick="addTitular()">+ A√±adir titular</button>
      </div>
    </div>

    <!-- 4. T√çTULO DE PROPIEDAD -->
    <div class="section-card">
      <div class="section-card-header">üìú T√≠tulo de propiedad</div>
      <div class="section-card-body">
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label">Tipo de t√≠tulo</label>
            <select class="form-select" id="ent-tipoTitulo">
              <option value="">‚Äî Seleccionar ‚Äî</option>
              <option value="escritura_publica">Escritura p√∫blica</option>
              <option value="contrato_privado">Contrato privado</option>
              <option value="herencia">Herencia / Adjudicaci√≥n</option>
              <option value="donacion">Donaci√≥n</option>
              <option value="concesion">Concesi√≥n administrativa</option>
              <option value="arrendamiento">Arrendamiento</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha</label>
            <input type="date" class="form-input" id="ent-fechaTitulo">
          </div>
          <div class="form-group">
            <label class="form-label">Notario / Fedatario</label>
            <input type="text" class="form-input" id="ent-notario" placeholder="Nombre del notario">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">N¬∫ Protocolo</label>
            <input type="text" class="form-input" id="ent-protocolo" placeholder="N¬∫ de protocolo notarial">
          </div>
          <div class="form-group">
            <label class="form-label">Ref. Catastral / Registro</label>
            <input type="text" class="form-input" id="ent-refCatastral" placeholder="Referencia catastral o registral">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Observaciones</label>
          <textarea class="form-textarea" id="ent-notasTitulo" rows="2" placeholder="Cargas, servidumbres, anotaciones..."></textarea>
        </div>
      </div>
    </div>

    <!-- 5. CONTACTO PROFESIONAL -->
    <div class="section-card">
      <div class="section-card-header">üìû Contacto profesional</div>
      <div class="section-card-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Gestor√≠a / Asesor√≠a</label>
            <input type="text" class="form-input" id="ent-gestoria" placeholder="Nombre de la gestor√≠a">
          </div>
          <div class="form-group">
            <label class="form-label">Contacto gestor√≠a</label>
            <input type="text" class="form-input" id="ent-contactoGestoria" placeholder="Tel√©fono o email">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Representante legal</label>
            <input type="text" class="form-input" id="ent-representante" placeholder="Nombre del representante">
          </div>
          <div class="form-group">
            <label class="form-label">Administrador</label>
            <input type="text" class="form-input" id="ent-administrador" placeholder="Si difiere del titular">
          </div>
        </div>
      </div>
    </div>

    <!-- 6. NOTAS -->
    <div class="section-card">
      <div class="section-card-header">üìù Notas generales</div>
      <div class="section-card-body">
        <div class="form-group">
          <textarea class="form-textarea" id="ent-notas" rows="3" placeholder="Cualquier dato relevante sobre la entidad..."></textarea>
        </div>
      </div>
    </div>

  </div>

  <!-- FOOTER ACCIONES -->
  <div class="footer-actions">
    <button class="btn btn-secondary" onclick="window.location.href=document.getElementById('btn-volver').href">Cancelar</button>
    <button class="btn btn-primary" onclick="guardar()">üíæ Guardar</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let titularCounter = 0;

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      bienId = params.get('id');
      const origen = params.get('origen') || 'gerente';

      if (!bienId) {
        alert('No se ha especificado el bien');
        window.location.href = 'lo-comun.html';
        return;
      }

      document.getElementById('btn-volver').href = `gerente.html?id=${bienId}`;

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await cargarBien();
          await cargarEntidad();
        } else {
          window.location.href = 'login.html';
        }
      });
    });

    // ========== CARGAR DATOS ==========
    async function cargarBien() {
      try {
        const doc = await db.collection('bienes').doc(bienId).get();
        if (doc.exists) {
          bienData = doc.data();
          document.getElementById('nombre-bien').textContent = bienData.nombre || 'Sin nombre';
        }
      } catch (error) {
        console.error('Error cargando bien:', error);
      }
    }

    async function cargarEntidad() {
      try {
        const doc = await db.collection('bienes').doc(bienId)
          .collection('entidad').doc('datos').get();

        if (doc.exists) {
          const d = doc.data();

          // Datos entidad
          document.getElementById('ent-tipo').value = d.tipo || '';
          document.getElementById('ent-nif').value = d.nif || '';
          document.getElementById('ent-razonSocial').value = d.razonSocial || '';
          document.getElementById('ent-domicilio').value = d.domicilio || '';

          // Fiscales
          document.getElementById('ent-regimenFiscal').value = d.regimenFiscal || '';
          document.getElementById('ent-epigrafeIAE').value = d.epigrafeIAE || '';
          document.getElementById('ent-licenciaTuristica').value = d.licenciaTuristica || '';
          document.getElementById('ent-registroExplotacion').value = d.registroExplotacion || '';
          document.getElementById('ent-notasFiscales').value = d.notasFiscales || '';

          // T√≠tulo de propiedad
          document.getElementById('ent-tipoTitulo').value = d.tipoTitulo || '';
          document.getElementById('ent-fechaTitulo').value = d.fechaTitulo || '';
          document.getElementById('ent-notario').value = d.notario || '';
          document.getElementById('ent-protocolo').value = d.protocolo || '';
          document.getElementById('ent-refCatastral').value = d.refCatastral || '';
          document.getElementById('ent-notasTitulo').value = d.notasTitulo || '';

          // Contacto profesional
          document.getElementById('ent-gestoria').value = d.gestoria || '';
          document.getElementById('ent-contactoGestoria').value = d.contactoGestoria || '';
          document.getElementById('ent-representante').value = d.representante || '';
          document.getElementById('ent-administrador').value = d.administrador || '';

          // Notas
          document.getElementById('ent-notas').value = d.notas || '';

          // Titulares
          const titulares = d.titulares || [];
          titulares.forEach(t => addTitular(t.nombre, t.nif, t.participacion, t.rol));
        }

        // Si no hay titulares, a√±adir fila vac√≠a
        if (document.querySelectorAll('#titulares-body tr').length === 0) {
          addTitular();
        }

      } catch (error) {
        console.error('Error cargando entidad:', error);
        addTitular();
      }
    }

    // ========== TITULARES DIN√ÅMICOS ==========
    function addTitular(nombre = '', nif = '', participacion = '', rol = '') {
      const idx = titularCounter++;
      const row = document.createElement('tr');
      row.id = `tit-row-${idx}`;
      row.innerHTML = `
        <td><input type="text" id="tit-nombre-${idx}" value="${nombre}" placeholder="Nombre completo"></td>
        <td><input type="text" id="tit-nif-${idx}" value="${nif}" placeholder="NIF"></td>
        <td><input type="text" id="tit-part-${idx}" value="${participacion}" placeholder="%" style="text-align:center;"></td>
        <td><input type="text" id="tit-rol-${idx}" value="${rol}" placeholder="Ej: Socio, Admin..."></td>
        <td style="text-align:center;"><button class="btn-remove-row" onclick="removeTitular(${idx})" title="Eliminar">‚úï</button></td>
      `;
      document.getElementById('titulares-body').appendChild(row);
    }

    function removeTitular(idx) {
      const row = document.getElementById(`tit-row-${idx}`);
      if (row) row.remove();
    }

    function recogerTitulares() {
      const rows = document.querySelectorAll('#titulares-body tr');
      const result = [];
      rows.forEach(row => {
        const idx = row.id.replace('tit-row-', '');
        const nombre = document.getElementById(`tit-nombre-${idx}`)?.value?.trim() || '';
        const nif = document.getElementById(`tit-nif-${idx}`)?.value?.trim() || '';
        const participacion = document.getElementById(`tit-part-${idx}`)?.value?.trim() || '';
        const rol = document.getElementById(`tit-rol-${idx}`)?.value?.trim() || '';
        if (nombre || nif) {
          result.push({ nombre, nif, participacion, rol });
        }
      });
      return result;
    }

    // ========== GUARDAR ==========
    async function guardar() {
      const data = {
        // Entidad
        tipo: document.getElementById('ent-tipo').value,
        nif: document.getElementById('ent-nif').value.trim(),
        razonSocial: document.getElementById('ent-razonSocial').value.trim(),
        domicilio: document.getElementById('ent-domicilio').value.trim(),

        // Fiscales
        regimenFiscal: document.getElementById('ent-regimenFiscal').value,
        epigrafeIAE: document.getElementById('ent-epigrafeIAE').value.trim(),
        licenciaTuristica: document.getElementById('ent-licenciaTuristica').value.trim(),
        registroExplotacion: document.getElementById('ent-registroExplotacion').value.trim(),
        notasFiscales: document.getElementById('ent-notasFiscales').value.trim(),

        // T√≠tulo
        tipoTitulo: document.getElementById('ent-tipoTitulo').value,
        fechaTitulo: document.getElementById('ent-fechaTitulo').value,
        notario: document.getElementById('ent-notario').value.trim(),
        protocolo: document.getElementById('ent-protocolo').value.trim(),
        refCatastral: document.getElementById('ent-refCatastral').value.trim(),
        notasTitulo: document.getElementById('ent-notasTitulo').value.trim(),

        // Contacto
        gestoria: document.getElementById('ent-gestoria').value.trim(),
        contactoGestoria: document.getElementById('ent-contactoGestoria').value.trim(),
        representante: document.getElementById('ent-representante').value.trim(),
        administrador: document.getElementById('ent-administrador').value.trim(),

        // Notas
        notas: document.getElementById('ent-notas').value.trim(),

        // Titulares
        titulares: recogerTitulares(),

        // Meta
        modificadoPor: currentUser.email,
        modificadoEn: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection('bienes').doc(bienId)
          .collection('entidad').doc('datos').set(data, { merge: true });
        alert('‚úÖ Datos de la entidad guardados');
      } catch (error) {
        console.error('Error guardando:', error);
        alert('Error al guardar. Revisa la consola.');
      }
    }
  </script>
</body>
</html>
