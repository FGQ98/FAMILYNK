<!DOCTYPE html>
<html lang="es">
<head>
  <!-- FAMILYNK Icons & PWA -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7A9E7E">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="FAMILYNK">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK — Mi Espacio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --tablon: #5B7BA3;
      --tablon-muted: rgba(91, 123, 163, 0.15);
      --tienda: #9C27B0;
      --tienda-muted: rgba(156, 39, 176, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* ============ HEADER ============ */
    .header {
      background: var(--white);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5em; /* Una letra de distancia */
      text-decoration: none;
    }

    .logo-icon {
      height: 2.4rem; /* Doble altura que las letras (1.2rem) */
      width: auto;
      filter: hue-rotate(20deg) saturate(0.65) brightness(1.1); /* Ajustar al sage */
    }

    .logo-text {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--sage-dark);
    }

    /* Familia badge en header */
    .familia-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--sage-muted);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--sage-dark);
    }

    .familia-badge-stats { display: flex; gap: 8px; }
    .familia-badge-stat { display: flex; align-items: center; gap: 2px; }

    /* Selector de estirpes */
    .estirpe-selector {
      position: relative;
    }
    .estirpe-selector-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--sage);
      border: none;
      border-radius: var(--radius-full);
      color: white;
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .estirpe-selector-btn:hover { background: var(--sage-dark); }
    .estirpe-arrow { font-size: 0.7rem; transition: transform 0.2s; }
    .estirpe-selector.open .estirpe-arrow { transform: rotate(180deg); }
    
    .estirpe-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      min-width: 220px;
      background: var(--white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-medium);
      z-index: 1000;
      overflow: hidden;
    }
    .estirpe-dropdown-list { padding: 8px 0; }
    .estirpe-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .estirpe-dropdown-item:hover { background: var(--cream); }
    .estirpe-dropdown-item.active { background: var(--sage-muted); }
    .estirpe-dropdown-item-icon { font-size: 1.2rem; }
    .estirpe-dropdown-item-name { font-weight: 600; font-size: 0.9rem; }
    .estirpe-dropdown-item-check { margin-left: auto; color: var(--sage); }
    
    .estirpe-dropdown-divider { height: 1px; background: var(--cream-dark); margin: 4px 0; }
    .estirpe-dropdown-action {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      color: var(--sage);
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 600;
      transition: background 0.2s;
    }
    .estirpe-dropdown-action:hover { background: var(--cream); }

    /* Nav desktop */
    .header-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .nav-link {
      padding: 8px 12px;
      border-radius: var(--radius-md);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--text-light);
      transition: all 0.2s;
    }

    .nav-link:hover { background: var(--cream); color: var(--text); }

    /* Header right */
    .header-right { display: flex; align-items: center; gap: 10px; }

    /* Carrito tienda */
    .cart-btn {
      width: 36px;
      height: 36px;
      background: var(--tienda-muted);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    .cart-btn:hover { background: var(--tienda); color: white; }
    .cart-btn .cart-icon { font-size: 1.1rem; }

    .cart-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background: var(--terracotta);
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Help button */
    .help-btn {
      width: 36px;
      height: 36px;
      background: var(--cream);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      font-size: 1rem;
    }
    .help-btn:hover { background: var(--sage); }
    .help-btn:hover .help-icon { filter: brightness(10); }
    .help-icon { transition: filter 0.2s; }

    /* Home button (brújula) */
    .home-btn {
      width: 36px;
      height: 36px;
      background: var(--cream);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .home-btn:hover { background: var(--sage); }
    .home-btn:hover .home-icon { stroke: white; }

    .home-icon {
      width: 20px;
      height: 20px;
      stroke: var(--text-light);
      stroke-width: 2;
      fill: none;
      transition: stroke 0.2s;
    }

    /* Chat button */
    .chat-btn {
      width: 36px;
      height: 36px;
      background: var(--sage-muted);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    .chat-btn:hover { background: var(--sage); color: white; }
    .chat-btn .chat-icon { font-size: 1.1rem; }

    .chat-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background: var(--terracotta);
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Chat Panel */
    .chat-panel {
      position: fixed;
      top: 0;
      right: -380px;
      width: 380px;
      height: 100vh;
      background: var(--white);
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      z-index: 300;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .chat-panel.active { right: 0; }

    .chat-panel-header {
      padding: 16px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-panel-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-panel-close {
      width: 32px;
      height: 32px;
      background: var(--cream);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .chat-panel-body {
      flex: 1;
      overflow-y: auto;
    }

    .chat-panel-conv {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--cream);
    }

    .chat-panel-conv:hover { background: var(--cream); }
    .chat-panel-conv.unread { background: rgba(193, 119, 87, 0.08); }

    .chat-panel-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--sage-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .chat-panel-avatar.grupo { background: var(--sage); color: white; }

    .chat-panel-info { flex: 1; min-width: 0; }

    .chat-panel-name {
      font-weight: 600;
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-panel-conv.unread .chat-panel-name { font-weight: 700; }

    .chat-panel-preview {
      font-size: 0.75rem;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-panel-time {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .chat-panel-conv.unread .chat-panel-time { color: var(--terracotta); font-weight: 600; }

    .chat-panel-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--cream-dark);
    }

    .chat-panel-footer a {
      display: block;
      text-align: center;
      padding: 10px;
      background: var(--sage);
      color: white;
      text-decoration: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.85rem;
    }

    .chat-panel-footer a:hover { background: var(--sage-dark); }

    .chat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 299;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .chat-overlay.active { opacity: 1; visibility: visible; }

    /* User menu */
    .user-menu {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px 4px 4px;
      background: var(--cream);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-menu:hover { background: var(--cream-dark); }

    .user-avatar {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-light) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.75rem;
    }

    .user-name { font-weight: 600; font-size: 0.8rem; }

    /* Hamburger */
    .hamburger {
      display: none;
      flex-direction: column;
      gap: 4px;
      padding: 8px;
      background: none;
      border: none;
      cursor: pointer;
    }

    .hamburger span {
      width: 20px;
      height: 2px;
      background: var(--text);
      border-radius: 2px;
      transition: all 0.3s;
    }

    .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(4px, 4px); }
    .hamburger.active span:nth-child(2) { opacity: 0; }
    .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(4px, -4px); }

    /* Mobile nav */
    .mobile-nav {
      display: none;
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      background: var(--white);
      box-shadow: var(--shadow-medium);
      padding: 16px;
      z-index: 99;
      transform: translateY(-100%);
      opacity: 0;
      transition: all 0.3s ease;
      max-height: calc(100vh - 56px);
      overflow-y: auto;
    }

    .mobile-nav.active {
      transform: translateY(0);
      opacity: 1;
    }

    /* Stats de rama en el menú móvil */
    .nav-rama-stats {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }
    .nav-rama-nombre {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--sage-dark);
    }
    .nav-rama-badges {
      display: flex;
      gap: 10px;
    }
    .nav-rama-badge {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--sage-dark);
    }

    /* Secciones del menú */
    .nav-section {
      margin-bottom: 16px;
    }
    .nav-section:last-child {
      margin-bottom: 0;
    }
    .nav-section-title {
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding-left: 4px;
    }

    /* Grid 2 columnas */
    .mobile-nav-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .mobile-nav-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 14px 8px;
      background: var(--cream);
      border-radius: var(--radius-md);
      text-decoration: none;
      color: var(--text);
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .mobile-nav-link:hover { 
      background: var(--sage-muted); 
      transform: scale(1.02);
    }
    .mobile-nav-link span:first-child { font-size: 1.4rem; }

    /* Separador del menú */
    .nav-divider {
      height: 1px;
      background: var(--cream-dark);
      margin: 12px 0;
    }

    /* Admin buttons en mobile nav - 2 columnas */
    .mobile-admin-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    /* Links de utilidad */
    .nav-utility-links {
      display: flex;
      gap: 8px;
    }
    .nav-utility-link {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px;
      background: var(--cream);
      border-radius: var(--radius-md);
      text-decoration: none;
      color: var(--text-light);
      font-size: 0.75rem;
      font-weight: 600;
    }
    .nav-utility-link:hover {
      background: var(--sage-muted);
      color: var(--text);
    }

    /* ============ MAIN ============ */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Welcome */
    .welcome {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .welcome-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .welcome-title span { color: var(--sage); }

    /* Admin buttons desktop */
    .admin-buttons { display: flex; gap: 6px; }

    .admin-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: var(--radius-md);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.7rem;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s;
      border: none;
      cursor: pointer;
    }

    .admin-btn:hover { transform: translateY(-1px); }
    .admin-btn.sistema { background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: white; }
    .admin-btn.rama { background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: white; }
    .admin-btn.crear-rama { background: linear-gradient(135deg, var(--sage-dark) 0%, var(--sage) 100%); color: white; }
    .admin-btn.nido { background: linear-gradient(135deg, var(--terracotta) 0%, var(--terracotta-light) 100%); color: white; }
    .admin-btn.mayordomo { background: linear-gradient(135deg, var(--mayordomo) 0%, #A69076 100%); color: white; }
    .admin-btn.comunicado { background: linear-gradient(135deg, #5B7BA3 0%, #7B9BC3 100%); color: white; border: none; cursor: pointer; }

    /* Botón comunicado circular en móvil */
    .mobile-admin-buttons .admin-btn.comunicado {
      width: 48px;
      height: 48px;
      min-width: 48px;
      border-radius: 50%;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      justify-self: end;
      grid-column: 2;
    }
    .mobile-admin-buttons .admin-btn.comunicado .admin-btn-icon {
      font-size: 1.3rem;
    }
    .mobile-admin-buttons .admin-btn.comunicado .admin-btn-text {
      display: none;
    }

    .hidden { display: none !important; }

    /* ============ ACCIONES RÁPIDAS (CTAs) ============ */
    .acciones-rapidas {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .cta-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 18px;
      background: var(--white);
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-soft);
    }

    .cta-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .cta-btn .cta-icon {
      font-size: 1.1rem;
    }

    .cta-averia { border-color: #E57373; }
    .cta-averia:hover { background: #FFEBEE; border-color: #EF5350; }

    .cta-iniciativa { border-color: #FFD54F; }
    .cta-iniciativa:hover { background: #FFFDE7; border-color: #FFCA28; }

    .cta-evento { border-color: #FF9800; }
    .cta-evento:hover { background: #FFF3E0; border-color: #F57C00; }

    .cta-reserva { border-color: #42A5F5; }
    .cta-reserva:hover { background: #E3F2FD; border-color: #1E88E5; }

    .cta-encargo { border-color: var(--tienda); }
    .cta-encargo:hover { background: var(--tienda-muted); border-color: var(--tienda); }

    .cta-asistencia { border-color: #9C27B0; }
    .cta-asistencia:hover { background: rgba(156, 39, 176, 0.1); border-color: #7B1FA2; }

    /* ============ MODALES ============ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      padding: 20px;
    }

    .modal-overlay.active { opacity: 1; pointer-events: auto; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 450px;
      max-height: 90vh;
      overflow: hidden;
      transform: translateY(20px);
      transition: transform 0.2s;
    }

    .modal-overlay.active .modal { transform: translateY(0); }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--cream);
      border-radius: var(--radius-sm);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .modal-body { padding: 20px; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid var(--cream-dark); display: flex; gap: 12px; justify-content: flex-end; }

    .form-group { margin-bottom: 16px; }

    /* Selector de visibilidad */
    .visibilidad-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .visibilidad-option {
      flex: 1;
      min-width: 90px;
      padding: 10px 8px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .visibilidad-option:hover {
      border-color: var(--sage-light);
      background: var(--sage-muted);
    }

    .visibilidad-option.active {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .visibilidad-option input {
      display: none;
    }

    .visibilidad-icon {
      font-size: 1.3rem;
      display: block;
      margin-bottom: 4px;
    }

    .visibilidad-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text);
    }

    .visibilidad-option.active .visibilidad-label {
      color: var(--sage-dark);
    }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    .form-input, .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
    }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--sage); }

    .btn { 
      padding: 10px 18px; 
      border-radius: var(--radius-md); 
      font-family: 'Nunito', sans-serif; 
      font-weight: 600; 
      cursor: pointer; 
      border: none;
      font-size: 0.85rem;
    }
    .btn-primary { background: var(--sage); color: white; }
    .btn-secondary { background: var(--cream); color: var(--text); }

    .urgencia-options { display: flex; gap: 10px; flex-wrap: wrap; }
    .urgencia-option { cursor: pointer; }
    .urgencia-option input { display: none; }
    .urgencia-badge {
      display: inline-block;
      padding: 8px 14px;
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 600;
      border: 2px solid var(--cream-dark);
      transition: all 0.2s;
    }
    .urgencia-option input:checked + .urgencia-badge.baja { background: #E8F5E9; border-color: #4CAF50; }
    .urgencia-option input:checked + .urgencia-badge.media { background: #FFF8E1; border-color: #FFC107; }
    .urgencia-option input:checked + .urgencia-badge.alta { background: #FFEBEE; border-color: #F44336; }

    /* ============ DASHBOARD GRID ============ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 260px 1fr 1fr 1fr;
      gap: 16px;
    }

    /* ============ CARDS ============ */
    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .card-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-body { padding: 10px 14px; }

    .card-action {
      font-size: 0.7rem;
      color: var(--sage);
      text-decoration: none;
      font-weight: 600;
    }

    .card-action:hover { text-decoration: underline; }

    /* ============ MI NIDO ============ */
    .nido-col { grid-row: 1 / 3; }
    .nido-card { border-left: 4px solid var(--terracotta); }

    /* Stats de rama (solo visible en móvil, dentro de la card de Nido) */
    .rama-stats-mobile {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: var(--sage-muted);
      border-radius: var(--radius-sm);
      margin-bottom: 10px;
    }
    .rama-stats-nombre {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.8rem;
      color: var(--sage-dark);
    }
    .rama-stats-badges {
      display: flex;
      gap: 8px;
    }
    .rama-stat-badge {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--sage-dark);
    }

    @media (max-width: 768px) {
      .rama-stats-mobile { display: flex; }
    }

    .nido-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .nido-icon {
      width: 36px;
      height: 36px;
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .nido-info { flex: 1; }
    .nido-nombre { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 0.95rem; }
    .nido-desc { font-size: 0.7rem; color: var(--text-muted); }

    .miembros-compact { display: flex; flex-direction: column; gap: 5px; }

    .miembro-mini {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 7px;
      background: var(--cream);
      border-radius: var(--radius-sm);
    }

    .miembro-mini-avatar {
      width: 26px;
      height: 26px;
      background: var(--sage);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.6rem;
    }

    .miembro-mini-avatar.fallecido { background: var(--text-muted); opacity: 0.5; }
    .miembro-mini-info { flex: 1; line-height: 1.2; }
    .miembro-mini-name { font-weight: 600; font-size: 0.75rem; }
    .miembro-mini-rel { font-size: 0.6rem; color: var(--text-muted); }

    /* ============ CALENDARIO ============ */
    .calendario-mini {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      text-align: center;
    }

    .cal-header { font-size: 0.6rem; color: var(--text-muted); font-weight: 600; padding: 3px 0; }

    .cal-day {
      padding: 5px 2px;
      font-size: 0.7rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .cal-day:hover { background: var(--cream); }
    .cal-day.today { background: var(--sage); color: white; font-weight: 700; }
    .cal-day.other-month { color: var(--text-muted); opacity: 0.4; }
    .cal-day.has-events { position: relative; }
    .cal-day-dots { display: flex; gap: 2px; justify-content: center; margin-top: 2px; }
    .cal-dot { width: 4px; height: 4px; border-radius: 50%; }
    .cal-dot.cumple { background: #E91E63; }
    .cal-dot.especial { background: #4CAF50; }
    .cal-dot.evento { background: #FF9800; }
    .cal-dot.cita { background: #2196F3; }
    .cal-dot.reserva { background: #9C27B0; }

    .eventos-hoy {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--cream-dark);
    }

    .evento-mini {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      font-size: 0.7rem;
    }

    .evento-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .evento-dot.cumple { background: #E91E63; }
    .evento-dot.especial { background: #4CAF50; }
    .evento-dot.evento { background: #FF9800; }
    .evento-dot.cita { background: #2196F3; }
    .evento-dot.reserva { background: #9C27B0; }

    /* ============ TABLÓN ============ */
    .tablon-card { border-left: 4px solid var(--sage); }

    .anuncio-item {
      padding: 8px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
    }

    .anuncio-item:last-child { margin-bottom: 0; }

    .anuncio-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .anuncio-tipo {
      font-size: 0.6rem;
      padding: 2px 5px;
      border-radius: 4px;
      font-weight: 600;
    }

    .anuncio-tipo.info { background: var(--sage-muted); color: var(--sage-dark); }
    .anuncio-tipo.convocatoria { background: var(--terracotta-muted); color: var(--terracotta); }

    .anuncio-fecha { font-size: 0.6rem; color: var(--text-muted); margin-left: auto; }
    .anuncio-titulo { font-weight: 600; font-size: 0.8rem; }
    .anuncio-texto { font-size: 0.7rem; color: var(--text-light); }

    /* Notificaciones de herramientas */
    .notif-item {
      padding: 10px;
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .notif-item:hover { transform: translateX(2px); }
    .notif-item:last-child { margin-bottom: 0; }

    .notif-item.accion {
      background: var(--terracotta-muted);
      border-left: 3px solid var(--terracotta);
    }
    .notif-item.info-notif {
      background: rgba(33, 150, 243, 0.1);
      border-left: 3px solid #2196F3;
    }

    .notif-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .notif-badge {
      font-size: 0.55rem;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .notif-badge.accion { background: var(--terracotta); color: white; }
    .notif-badge.info-notif { background: #2196F3; color: white; }

    .notif-tiempo { font-size: 0.6rem; color: var(--text-muted); margin-left: auto; }
    .notif-titulo { font-weight: 600; font-size: 0.8rem; margin-bottom: 2px; }
    .notif-texto { font-size: 0.7rem; color: var(--text-light); }
    .notif-origen { font-size: 0.6rem; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 4px; }

    .notif-marcar {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid var(--text-muted);
      background: transparent;
      cursor: pointer;
      font-size: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.5;
      transition: all 0.2s;
    }
    .notif-marcar:hover { opacity: 1; border-color: var(--sage); background: var(--sage); color: white; }

    .tablon-separator {
      font-size: 0.65rem;
      color: var(--text-muted);
      padding: 8px 0 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ============ TAREAS ============ */


    .tarea-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      border-radius: var(--radius-sm);
      margin-bottom: 4px;
      cursor: pointer;
    }

    .tarea-item:hover { background: var(--cream); }

    .tarea-check {
      width: 18px;
      height: 18px;
      border: 2px solid var(--cream-dark);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 0.65rem;
    }

    .tarea-check:hover { border-color: var(--sage); }
    .tarea-check.done { background: var(--sage); border-color: var(--sage); color: white; }

    .tarea-content { flex: 1; }
    .tarea-titulo { font-size: 0.75rem; font-weight: 600; }
    .tarea-titulo.done { text-decoration: line-through; color: var(--text-muted); }
    .tarea-asignado { font-size: 0.6rem; color: var(--text-muted); }

    .tarea-prioridad { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .tarea-prioridad.alta { background: #E53935; }
    .tarea-prioridad.media { background: #FB8C00; }
    .tarea-prioridad.baja { background: var(--sage); }

    /* ============ BUZÓN ============ */
    .tablon-card { border-left: 4px solid var(--tablon); }
    
    /* Ocultar Plan si no es admin */
    .plan-col.hidden-no-admin { display: none; }

    .mensajes-card { border-left: 4px solid var(--sage); }

    .mensaje-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      cursor: pointer;
    }

    .mensaje-item:hover { background: var(--cream-dark); }
    .mensaje-item.no-leido { background: var(--tablon-muted); }

    .mensaje-avatar {
      width: 28px;
      height: 28px;
      background: var(--tablon);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.65rem;
      flex-shrink: 0;
    }

    .mensaje-content { flex: 1; min-width: 0; }
    .mensaje-from { font-weight: 600; font-size: 0.75rem; }
    .mensaje-preview { font-size: 0.7rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mensaje-time { font-size: 0.6rem; color: var(--text-muted); }

    .mensaje-badge {
      width: 6px;
      height: 6px;
      background: var(--terracotta);
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 4px;
    }

    /* ============ BUZÓN UNIFICADO ============ */
    .buzon-card { border-left: 4px solid var(--tablon); }

    .buzon-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--cream-dark);
      padding-bottom: 8px;
    }

    .buzon-tab {
      flex: 1;
      padding: 8px 12px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .buzon-tab:hover { background: var(--sage-muted); color: var(--text); }
    .buzon-tab.active { background: var(--sage); color: white; }

    .buzon-tab-badge {
      background: var(--terracotta);
      color: white;
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    .buzon-tab.active .buzon-tab-badge {
      background: white;
      color: var(--sage-dark);
    }

    .buzon-content { display: none; }
    .buzon-content.active { display: block; }

    /* ============ MIS BIENES ============ */
    .mis-bienes-section {
      margin-top: 16px;
    }

    .mis-bienes-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--text);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bien-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-soft);
      margin-bottom: 10px;
      text-decoration: none;
      color: var(--text);
      transition: all 0.2s;
      border-left: 4px solid var(--sage);
    }

    .bien-card:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-medium);
    }

    .bien-card.mayordomo { border-left-color: var(--mayordomo); }
    .bien-card.gerente { border-left-color: #5B7BA3; }
    .bien-card.capataz { border-left-color: #6B8E23; }

    .bien-icon {
      width: 40px;
      height: 40px;
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    .bien-card.mayordomo .bien-icon { background: rgba(139, 115, 85, 0.15); }
    .bien-card.gerente .bien-icon { background: rgba(91, 123, 163, 0.15); }
    .bien-card.capataz .bien-icon { background: rgba(107, 142, 35, 0.15); }

    .bien-info { flex: 1; }
    .bien-nombre { font-weight: 700; font-size: 0.9rem; }
    .bien-addon { font-size: 0.7rem; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
    .bien-arrow { color: var(--text-muted); font-size: 1.2rem; }

    /* ============ MI PLAN ============ */
    .plan-card { border-left: 4px solid var(--sage); }

    .plan-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .plan-icon {
      width: 36px;
      height: 36px;
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--sage-dark);
    }

    .plan-details {
      flex: 1;
    }

    .plan-nombre {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
    }

    .plan-tipo {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .plan-stats {
      display: flex;
      gap: 12px;
      font-size: 0.75rem;
    }

    .plan-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .plan-stat-label {
      color: var(--text-muted);
      font-size: 0.65rem;
    }

    .plan-stat-value {
      font-weight: 700;
      color: var(--text);
    }

    .plan-upgrade {
      display: block;
      width: 100%;
      padding: 8px;
      background: var(--sage-muted);
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--sage-dark);
      text-decoration: none;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
    }

    .plan-upgrade:hover {
      background: var(--sage);
      color: white;
    }

    /* ============ BTN NUEVO ============ */
    .btn-nuevo {
      width: 100%;
      padding: 6px;
      background: var(--cream);
      border: 2px dashed var(--cream-dark);
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.7rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .btn-nuevo:hover {
      border-color: var(--sage);
      color: var(--sage-dark);
      background: var(--sage-muted);
    }

    /* ============ LOADING ============ */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-mini {
      text-align: center;
      padding: 16px;
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .empty-mini-icon { font-size: 1.3rem; opacity: 0.4; margin-bottom: 4px; }

    /* Dropdown */
    .dropdown { position: relative; }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 6px;
      background: var(--white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-float);
      min-width: 140px;
      padding: 5px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
      z-index: 200;
    }

    .dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-menu a,
    .dropdown-menu button {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: var(--radius-sm);
      text-decoration: none;
      color: var(--text);
      font-size: 0.75rem;
      width: 100%;
      border: none;
      background: none;
      cursor: pointer;
    }

    .dropdown-menu a:hover,
    .dropdown-menu button:hover { background: var(--sage-muted); }

    .dropdown-divider { height: 1px; background: var(--cream-dark); margin: 4px 0; }

    /* ============ TIENDA PANEL ============ */
    .tienda-panel {
      position: fixed;
      top: 0;
      right: -350px;
      width: 350px;
      height: 100vh;
      background: var(--white);
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      z-index: 300;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .tienda-panel.active { right: 0; }

    .tienda-header {
      padding: 16px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .tienda-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tienda-close {
      width: 32px;
      height: 32px;
      background: var(--cream);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .tienda-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .tienda-categoria {
      margin-bottom: 16px;
    }

    .tienda-cat-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--cream);
      border-radius: var(--radius-md);
      cursor: pointer;
      margin-bottom: 8px;
    }

    .tienda-cat-header:hover { background: var(--cream-dark); }
    .tienda-cat-icon { font-size: 1.1rem; }
    .tienda-cat-name { font-weight: 600; font-size: 0.85rem; flex: 1; }
    .tienda-cat-arrow { font-size: 0.8rem; color: var(--text-muted); transition: transform 0.2s; }
    .tienda-cat-header.open .tienda-cat-arrow { transform: rotate(90deg); }

    .tienda-subcats {
      display: none;
      padding-left: 20px;
    }

    .tienda-subcats.open { display: block; }

    .tienda-subcat {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      margin-bottom: 4px;
      background: var(--white);
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.8rem;
    }

    .tienda-subcat:hover { border-color: var(--sage); background: var(--sage-muted); }

    .tienda-subcat-add {
      width: 24px;
      height: 24px;
      background: var(--sage);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tienda-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 299;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .tienda-overlay.active { opacity: 1; visibility: visible; }

    /* Tienda Tabs */
    .tienda-tabs {
      display: flex;
      border-bottom: 1px solid var(--cream-dark);
    }

    .tienda-tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
      position: relative;
    }

    .tienda-tab.active {
      color: var(--tienda);
    }

    .tienda-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--tienda);
    }

    .tienda-tab-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      background: var(--tienda);
      color: white;
      font-size: 0.65rem;
      border-radius: 9px;
      margin-left: 4px;
    }

    .tienda-tab-content {
      display: none;
    }

    .tienda-tab-content.active {
      display: block;
    }

    /* Input rápido */
    .tienda-input-rapido {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .tienda-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
    }

    .tienda-input:focus {
      outline: none;
      border-color: var(--tienda);
    }

    .tienda-select {
      width: 120px;
      padding: 10px 8px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      background: var(--white);
    }

    .tienda-btn-add {
      width: 40px;
      background: var(--tienda);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .tienda-btn-add:hover {
      background: #7B1FA2;
    }

    /* Categorías rápidas */
    .tienda-cats-rapidas {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .tienda-cat-chip {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--cream);
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.2s;
    }

    .tienda-cat-chip:hover {
      background: var(--tienda-muted);
      transform: scale(1.1);
    }

    /* Items recientes */
    .tienda-recientes {
      border-top: 1px solid var(--cream-dark);
      padding-top: 12px;
    }

    .tienda-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.8rem;
      padding: 24px;
    }

    /* Lista de compra */
    .tienda-lista {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .tienda-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }

    .tienda-item.comprado {
      opacity: 0.5;
    }

    .tienda-item-check {
      width: 20px;
      height: 20px;
      border: 2px solid var(--cream-dark);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      flex-shrink: 0;
    }

    .tienda-item-check:hover {
      border-color: var(--tienda);
    }

    .tienda-item-check.done {
      background: var(--tienda);
      border-color: var(--tienda);
      color: white;
    }

    .tienda-item-info {
      flex: 1;
    }

    .tienda-item-nombre {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .tienda-item.comprado .tienda-item-nombre {
      text-decoration: line-through;
    }

    .tienda-item-cat {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .tienda-item-delete {
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .tienda-item-delete:hover {
      color: var(--error);
    }

    .tienda-lista-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--cream-dark);
    }

    /* Selector de bien */
    .tienda-bien-selector {
      padding: 12px 16px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .tienda-bien-selector select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      background: var(--white);
    }

    .tienda-bien-selector select:focus {
      outline: none;
      border-color: var(--tienda);
    }

    /* Productos grid */
    .tienda-productos {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tienda-producto {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .tienda-producto:hover {
      border-color: var(--tienda);
    }

    .tienda-producto.en-carrito {
      background: var(--tienda-muted);
      border-color: var(--tienda);
    }

    .tienda-producto-icon {
      width: 32px;
      height: 32px;
      background: var(--white);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .tienda-producto-info {
      flex: 1;
    }

    .tienda-producto-nombre {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .tienda-producto-formato {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .tienda-producto-cantidad {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tienda-cantidad-btn {
      width: 24px;
      height: 24px;
      border: 1px solid var(--cream-dark);
      background: var(--white);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .tienda-cantidad-btn:hover {
      background: var(--tienda);
      color: white;
      border-color: var(--tienda);
    }

    .tienda-cantidad-num {
      min-width: 24px;
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
    }

    /* Formulario añadir especial */
    .tienda-add-especial {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .especial-row {
      display: flex;
      gap: 6px;
    }

    .tienda-input-sm {
      max-width: 80px;
    }

    .tienda-input-xs {
      max-width: 50px;
    }

    /* Pedidos */
    .pedidos-filtros {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .pedido-filtro {
      padding: 6px 12px;
      border: 1px solid var(--cream-dark);
      background: var(--white);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pedido-filtro:hover {
      border-color: var(--tienda);
    }

    .pedido-filtro.active {
      background: var(--tienda);
      color: white;
      border-color: var(--tienda);
    }

    .pedidos-lista {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pedido-card {
      background: var(--cream);
      border-radius: var(--radius-md);
      padding: 12px;
      border-left: 4px solid var(--text-muted);
    }

    .pedido-card.pendiente { border-left-color: #FFC107; }
    .pedido-card.en-curso { border-left-color: #2196F3; }
    .pedido-card.realizado { border-left-color: #4CAF50; }

    .pedido-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .pedido-fecha {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .pedido-estado {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .pedido-estado.pendiente { background: #FFF8E1; color: #F9A825; }
    .pedido-estado.en-curso { background: #E3F2FD; color: #1976D2; }
    .pedido-estado.realizado { background: #E8F5E9; color: #388E3C; }

    .pedido-items {
      font-size: 0.8rem;
      color: var(--text);
    }

    .pedido-items-count {
      font-weight: 600;
    }

    .pedido-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    .pedido-actions button {
      flex: 1;
      padding: 6px;
      font-size: 0.75rem;
      border: 1px solid var(--cream-dark);
      background: var(--white);
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .pedido-actions button:hover {
      background: var(--cream);
    }

    /* Footer tienda */
    .tienda-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--cream-dark);
      background: var(--cream);
    }

    .carrito-resumen {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .carrito-items {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .btn-tienda {
      padding: 10px 18px;
      background: var(--tienda);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn-tienda:hover {
      background: #7B1FA2;
    }

    .btn-tienda:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Categoría grupo */
    .tienda-categoria-grupo {
      margin-bottom: 16px;
    }

    .tienda-categoria-titulo {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 8px;
      padding-left: 4px;
    }

    /* ============ FOOTER ============ */
    .app-footer {
      text-align: center;
      padding: 16px 24px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .app-footer a {
      color: var(--sage-dark);
      text-decoration: none;
      margin: 0 8px;
    }

    .app-footer a:hover { text-decoration: underline; }

    /* ============ RESPONSIVE ============ */
    @media (max-width: 1100px) {
      .dashboard-grid {
        grid-template-columns: 1fr 1fr;
      }
      .nido-col { grid-row: auto; }
    }

    @media (max-width: 768px) {
      .header-nav { display: none; }
      .hamburger { display: flex; }
      .mobile-nav { display: block; }
      .user-name { display: none; }
      .admin-buttons { display: none; }
      .welcome { flex-direction: column; align-items: flex-start; gap: 8px; }
      .welcome-title { font-size: 1.1rem; }

      /* Botones de acción en grid 3x2 */
      .acciones-rapidas {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 16px;
        overflow-x: visible;
        flex-wrap: nowrap;
        padding-bottom: 0;
      }

      .cta-btn {
        flex-direction: column;
        padding: 12px 8px;
        font-size: 0.7rem;
        gap: 4px;
        border-radius: var(--radius-md);
      }

      .cta-btn .cta-label { 
        display: block; 
        font-size: 0.65rem;
        text-align: center;
      }
      .cta-btn .cta-icon { font-size: 1.4rem; }

      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      /* Orden móvil: Calendario, Buzón, Bienes (Nido y Plan ocultos en primera vista) */
      .calendario-col { order: 0; }
      .buzon-col { order: 1; }
      .mis-bienes-col { order: 2; }
      .nido-col { order: 3; }
      .tablon-col { display: none; } /* Integrado en buzón */
      .mensajes-col { display: none; } /* Integrado en buzón */
      .plan-col { order: 4; }
      
      /* Header móvil: ocultar elementos que no caben (Ayuda SÍ visible) */
      .familia-badge { display: none; }
      .home-btn { display: none; }

      .tienda-panel { width: 100%; right: -100%; }
      .chat-panel { width: 100%; right: -100%; }

      .card-body { padding: 10px 12px; }

      /* Sección de bienes visible solo en móvil como parte del scroll */
      .mis-bienes-section { display: block; }
    }

    /* En desktop, ocultar la sección de bienes duplicada */
    @media (min-width: 769px) {
      .mis-bienes-col { display: none; }
      .buzon-col { display: none; }
    }

    /* ============ MODAL COMUNICADO ============ */
    .comunicado-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--sage);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .comunicado-btn:hover {
      background: var(--sage-dark);
      transform: translateY(-1px);
    }

    .modal-comunicado {
      max-width: 540px;
    }

    .modal-comunicado .modal-header {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: none;
    }

    .modal-comunicado .modal-logo {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .modal-comunicado .modal-header-info { flex: 1; }

    .modal-comunicado .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      margin-bottom: 2px;
    }

    .modal-comunicado .modal-subtitle {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.85);
    }

    .modal-comunicado .modal-close {
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
    }

    .modal-comunicado .modal-close:hover {
      background: rgba(255,255,255,0.25);
    }

    .modal-comunicado .modal-body {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .modal-comunicado .form-group { margin-bottom: 20px; }

    .modal-comunicado .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .modal-comunicado .form-label-hint {
      font-weight: 400;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    /* Destinatarios grid */
    .destinatarios-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .destinatario-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--cream);
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .destinatario-option:hover {
      border-color: var(--sage-light);
      background: var(--sage-muted);
    }

    .destinatario-option.selected {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .destinatario-option.hidden { display: none; }

    .destinatario-option input { display: none; }

    .destinatario-check {
      width: 20px;
      height: 20px;
      border: 2px solid var(--cream-dark);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--white);
      transition: all 0.2s;
      font-size: 0.7rem;
      color: white;
    }

    .destinatario-option.selected .destinatario-check {
      background: var(--sage);
      border-color: var(--sage);
    }

    .destinatario-info { flex: 1; }
    .destinatario-nombre { font-weight: 600; font-size: 0.85rem; }
    .destinatario-desc { font-size: 0.7rem; color: var(--text-muted); }
    .destinatario-icon { font-size: 1.2rem; }

    /* Textarea contador */
    .char-counter {
      text-align: right;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .char-counter.warning { color: var(--terracotta); }
    .char-counter.limit { color: #D4695A; font-weight: 600; }

    /* Upload área */
    .upload-area {
      border: 2px dashed var(--cream-dark);
      border-radius: var(--radius-md);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--cream);
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .upload-icon { font-size: 2rem; margin-bottom: 8px; }
    .upload-text { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; }
    .upload-hint { font-size: 0.75rem; color: var(--text-muted); }
    .upload-input { display: none; }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--cream);
    }

    .preview-item img { width: 100%; height: 100%; object-fit: cover; }

    .preview-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 22px;
      height: 22px;
      background: rgba(0,0,0,0.6);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-remove:hover { background: var(--terracotta); }

    /* Tipo selector */
    .tipo-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .tipo-option {
      padding: 16px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .tipo-option:hover { border-color: var(--sage-light); }
    .tipo-option input { display: none; }

    .tipo-option.info.selected {
      border-color: #5B7BA3;
      background: rgba(91, 123, 163, 0.15);
    }

    .tipo-option.accion.selected {
      border-color: #E8B44D;
      background: rgba(232, 180, 77, 0.15);
    }

    .tipo-icon { font-size: 1.8rem; margin-bottom: 8px; }
    .tipo-nombre { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }
    .tipo-desc { font-size: 0.75rem; color: var(--text-muted); }

    .tipo-option.info.selected .tipo-nombre { color: #5B7BA3; }
    .tipo-option.accion.selected .tipo-nombre { color: #B8922E; }

    .modal-comunicado .modal-footer {
      background: var(--cream);
    }

    @media (max-width: 540px) {
      .destinatarios-grid { grid-template-columns: 1fr; }
      .tipo-selector { grid-template-columns: 1fr; }
      .preview-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- ============ HEADER ============ -->
  <header class="header">
    <div class="header-left">
      <button class="hamburger" id="hamburger" onclick="toggleMobileNav()">
        <span></span><span></span><span></span>
      </button>

      <a href="cgi.html" class="logo">
        <img src="logo_familynk.png" alt="FAMILYNK" class="logo-icon">
        <span class="logo-text">FAMILYNK</span>
      </a>

      <div class="familia-badge" id="familia-badge">
        <span id="familia-badge-nombre">Mi Rama</span>
        <div class="familia-badge-stats">
          <span class="familia-badge-stat"><span id="badge-nidos">0</span>🪺</span>
          <span class="familia-badge-stat"><span id="badge-miembros">0</span>👥</span>
        </div>
      </div>

      <!-- Selector de estirpes (oculto por defecto, visible si tiene más de 1) -->
      <div class="estirpe-selector hidden" id="estirpe-selector">
        <button class="estirpe-selector-btn" onclick="toggleEstirpeDropdown()">
          <span id="estirpe-actual-nombre">Mi Rama</span>
          <span class="estirpe-arrow">▼</span>
        </button>
        <div class="estirpe-dropdown hidden" id="estirpe-dropdown">
          <div class="estirpe-dropdown-list" id="estirpe-dropdown-list">
            <!-- Se llena dinámicamente -->
          </div>
          <div class="estirpe-dropdown-divider"></div>
          <a href="mi-perfil.html#crear-rama" class="estirpe-dropdown-action">
            <span>➕</span> Crear/vincular rama
          </a>
        </div>
      </div>

      <nav class="header-nav">
        <a href="mi-nido.html" class="nav-link">Mi Nido</a>
        <a href="arbol.html" class="nav-link">Árbol</a>
        <a href="lo-comun.html" class="nav-link">Lo Común</a>
        <a href="legado.html" class="nav-link">Legado</a>
        <a href="cerebro.html" class="nav-link">Cerebro</a>
        <a href="activacion.html" class="nav-link">Activación</a>
      </nav>
    </div>

    <div class="header-right">
      <a href="ayuda.html" class="help-btn" title="Ayuda">
        <span class="help-icon">❓</span>
      </a>

      <a href="index.html" class="home-btn" title="Inicio">
        <svg class="home-icon" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <polygon points="12,2 14,10 12,12 10,10" fill="currentColor" stroke="none"/>
          <polygon points="12,22 10,14 12,12 14,14" fill="var(--terracotta)" stroke="none"/>
          <line x1="12" y1="12" x2="12" y2="5"/>
          <circle cx="12" cy="12" r="2"/>
        </svg>
      </a>

      <button class="chat-btn" onclick="toggleChatPanel()">
        <span class="chat-icon">💬</span>
        <span class="chat-badge hidden" id="chat-badge">0</span>
      </button>

      <button class="cart-btn hidden" id="cart-btn" onclick="toggleTienda()">
        <span class="cart-icon">🛒</span>
        <span class="cart-badge hidden" id="cart-badge">0</span>
      </button>

      <div class="dropdown">
        <div class="user-menu">
          <div class="user-avatar" id="user-avatar">?</div>
          <span class="user-name" id="user-name">...</span>
        </div>
        <div class="dropdown-menu">
          <a href="mi-perfil.html"><span>👤</span> Mi perfil</a>
          <a href="configuracion.html"><span>⚙️</span> Configuración</a>
          <div class="dropdown-divider"></div>
          <button id="logout-btn"><span>🚪</span> Cerrar sesión</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Nav -->
  <nav class="mobile-nav" id="mobile-nav">
    <!-- Stats de la rama -->
    <div class="nav-rama-stats">
      <span class="nav-rama-nombre" id="nav-rama-nombre">Mi Rama</span>
      <div class="nav-rama-badges">
        <span class="nav-rama-badge"><span id="nav-badge-nidos">0</span> 🪺</span>
        <span class="nav-rama-badge"><span id="nav-badge-miembros">0</span> 👥</span>
      </div>
    </div>

    <!-- Sección: Explorar -->
    <div class="nav-section">
      <div class="nav-section-title">📖 Explorar</div>
      <div class="mobile-nav-links">
        <a href="mi-nido.html" class="mobile-nav-link"><span>🪺</span>Mi Nido</a>
        <a href="arbol.html" class="mobile-nav-link"><span>🌳</span>Árbol</a>
        <a href="lo-comun.html" class="mobile-nav-link"><span>🏠</span>Lo Común</a>
        <a href="legado.html" class="mobile-nav-link"><span>📜</span>Legado</a>
        <a href="cerebro.html" class="mobile-nav-link"><span>🧠</span>Cerebro</a>
        <a href="activacion.html" class="mobile-nav-link"><span>🎯</span>Activación</a>
      </div>
    </div>

    <!-- Sección: Administrar (condicional) -->
    <div class="nav-section" id="nav-admin-section" style="display: none;">
      <div class="nav-divider"></div>
      <div class="nav-section-title">⚙️ Administrar</div>
      <div class="mobile-admin-buttons" id="mobile-admin-buttons"></div>
    </div>

    <!-- Sección: Utilidades -->
    <div class="nav-section">
      <div class="nav-divider"></div>
      <div class="nav-utility-links">
        <a href="index.html" class="nav-utility-link"><span>🧭</span> Inicio</a>
        <a href="configuracion.html" class="nav-utility-link"><span>⚙️</span> Config</a>
      </div>
    </div>
  </nav>

  <!-- Chat Panel -->
  <div class="chat-overlay" id="chat-overlay" onclick="toggleChatPanel()"></div>
  <div class="chat-panel" id="chat-panel">
    <div class="chat-panel-header">
      <span class="chat-panel-title">💬 Mensajes</span>
      <button class="chat-panel-close" onclick="toggleChatPanel()">×</button>
    </div>
    <div class="chat-panel-body" id="chat-panel-body">
      <div style="padding: 40px; text-align: center; color: var(--text-muted);">
        <div style="font-size: 2rem; margin-bottom: 8px;">💬</div>
        <div>Cargando conversaciones...</div>
      </div>
    </div>
    <div class="chat-panel-footer">
      <a href="chat.html">Abrir chat completo →</a>
    </div>
  </div>

  <!-- Tienda Panel -->
  <div class="tienda-overlay" id="tienda-overlay" onclick="toggleTienda()"></div>
  <div class="tienda-panel" id="tienda-panel">
    <div class="tienda-header">
      <span class="tienda-title">🛒 Tienda</span>
      <button class="tienda-close" onclick="toggleTienda()">×</button>
    </div>
    
    <!-- Selector de Bien -->
    <div class="tienda-bien-selector">
      <select id="tienda-bien-select" onchange="cambiarBienTienda()">
        <option value="">Selecciona un bien...</option>
      </select>
    </div>
    
    <!-- Tabs -->
    <div class="tienda-tabs">
      <button class="tienda-tab active" data-tab="basicos" onclick="cambiarTabTienda('basicos')">📦 Básicos</button>
      <button class="tienda-tab" data-tab="especiales" onclick="cambiarTabTienda('especiales')">⭐ Especiales</button>
      <button class="tienda-tab" data-tab="pedidos" onclick="cambiarTabTienda('pedidos')">📋 Pedidos <span class="tienda-tab-count" id="pedidos-count">0</span></button>
    </div>

    <div class="tienda-body">
      <!-- Tab Básicos -->
      <div class="tienda-tab-content active" id="tab-basicos">
        <div class="tienda-productos" id="productos-basicos">
          <div class="tienda-empty">Selecciona un bien para ver su inventario</div>
        </div>
      </div>

      <!-- Tab Especiales -->
      <div class="tienda-tab-content" id="tab-especiales">
        <!-- Formulario añadir especial -->
        <div class="tienda-add-especial">
          <div class="especial-row">
            <input type="text" id="especial-articulo" placeholder="Artículo" class="tienda-input">
            <input type="text" id="especial-formato" placeholder="Formato" class="tienda-input tienda-input-sm">
            <input type="number" id="especial-unidades" placeholder="Uds" class="tienda-input tienda-input-xs" min="1" value="1">
            <button class="tienda-btn-add" onclick="añadirEspecial()">+</button>
          </div>
        </div>
        <div class="tienda-productos" id="productos-especiales">
          <div class="tienda-empty">Sin artículos especiales</div>
        </div>
      </div>

      <!-- Tab Pedidos -->
      <div class="tienda-tab-content" id="tab-pedidos">
        <div class="pedidos-filtros">
          <button class="pedido-filtro active" data-estado="todos" onclick="filtrarPedidos('todos')">Todos</button>
          <button class="pedido-filtro" data-estado="pendiente" onclick="filtrarPedidos('pendiente')">🟡 Pendiente</button>
          <button class="pedido-filtro" data-estado="en-curso" onclick="filtrarPedidos('en-curso')">🔵 En curso</button>
          <button class="pedido-filtro" data-estado="realizado" onclick="filtrarPedidos('realizado')">🟢 Realizado</button>
        </div>
        <div class="pedidos-lista" id="pedidos-lista">
          <div class="tienda-empty">Sin pedidos</div>
        </div>
      </div>
    </div>

    <!-- Footer con carrito -->
    <div class="tienda-footer" id="tienda-footer">
      <div class="carrito-resumen">
        <span class="carrito-items"><span id="carrito-count">0</span> artículos</span>
        <button class="btn btn-tienda" onclick="crearPedido()">Crear pedido →</button>
      </div>
    </div>
  </div>

  <!-- ============ MAIN ============ -->
  <main class="main">
    <div id="page-loading" class="loading">
      <div class="spinner"></div>
    </div>

    <div id="page-content" class="hidden">
      <div class="welcome">
        <h1 class="welcome-title" id="welcome-title">Buenos días 👋</h1>
        <div class="admin-buttons" id="admin-buttons"></div>
      </div>

      <!-- Acciones Rápidas (CTAs) -->
      <div class="acciones-rapidas">
        <button class="cta-btn cta-averia" onclick="abrirModalAveria()">
          <span class="cta-icon">🔧</span>
          <span class="cta-label">Avisar avería</span>
        </button>
        <button class="cta-btn cta-iniciativa" onclick="abrirModalIniciativa()">
          <span class="cta-icon">💡</span>
          <span class="cta-label">Proponer idea</span>
        </button>
        <button class="cta-btn cta-evento" onclick="abrirModalSolicitarEvento()">
          <span class="cta-icon">🎉</span>
          <span class="cta-label">Solicitar evento</span>
        </button>
        <button class="cta-btn cta-reserva" onclick="abrirModalSolicitarReserva()">
          <span class="cta-icon">📅</span>
          <span class="cta-label">Solicitar reserva</span>
        </button>
        <button class="cta-btn cta-encargo" onclick="abrirModalEncargo()">
          <span class="cta-icon">🛒</span>
          <span class="cta-label">Hacer encargo</span>
        </button>
        <button class="cta-btn cta-asistencia" onclick="abrirModalConvocatoria()">
          <span class="cta-icon">✋</span>
          <span class="cta-label">Convocar</span>
        </button>
      </div>

      <div class="dashboard-grid">
        <!-- Mi Nido (con stats de rama integrados) -->
        <div class="nido-col">
          <div class="card nido-card">
            <div class="card-header">
              <span class="card-title">🪺 Mi Nido</span>
              <a href="mi-nido.html" class="card-action">Ver →</a>
            </div>
            <div class="card-body">
              <!-- Stats de la Rama (visible en móvil) -->
              <div class="rama-stats-mobile" id="rama-stats-mobile">
                <span class="rama-stats-nombre" id="rama-nombre-mobile">Mi Rama</span>
                <div class="rama-stats-badges">
                  <span class="rama-stat-badge"><span id="badge-nidos-mobile">0</span> 🪺</span>
                  <span class="rama-stat-badge"><span id="badge-miembros-mobile">0</span> 👥</span>
                </div>
              </div>
              <div class="nido-header">
                <div class="nido-icon">🪺</div>
                <div class="nido-info">
                  <div class="nido-nombre" id="nido-nombre">Cargando...</div>
                  <div class="nido-desc" id="nido-desc"></div>
                </div>
              </div>
              <div class="miembros-compact" id="miembros-compact"></div>
            </div>
          </div>
        </div>

        <!-- Calendario -->
        <div class="calendario-col">
          <div class="card">
            <div class="card-header">
              <span class="card-title">📅 <span id="mes-actual">Diciembre</span></span>
              <a href="activacion.html" class="card-action">Ver todo →</a>
            </div>
            <div class="card-body">
              <div class="calendario-mini" id="calendario-mini"></div>
              <div class="eventos-hoy" id="eventos-hoy"></div>
            </div>
          </div>
        </div>

        <!-- Buzón Unificado (Chat + Notificaciones) - MÓVIL -->
        <div class="buzon-col">
          <div class="card buzon-card">
            <div class="card-header">
              <span class="card-title">📬 Buzón</span>
              <a href="chat.html" class="card-action">Ver todo →</a>
            </div>
            <div class="card-body">
              <!-- Pestañas -->
              <div class="buzon-tabs">
                <button class="buzon-tab active" onclick="cambiarPestanaBuzon('chat')">
                  💬 Chat
                  <span class="buzon-tab-badge" id="badge-chat-count">0</span>
                </button>
                <button class="buzon-tab" onclick="cambiarPestanaBuzon('notificaciones')">
                  🔔 Avisos
                  <span class="buzon-tab-badge" id="badge-notif-count">0</span>
                </button>
              </div>
              
              <!-- Contenido Chat -->
              <div class="buzon-content active" id="buzon-chat">
                <div id="buzon-mensajes-list"></div>
                <a href="chat.html" class="btn-nuevo" style="text-decoration: none; display: inline-block;">+ Nuevo chat</a>
              </div>
              
              <!-- Contenido Notificaciones -->
              <div class="buzon-content" id="buzon-notificaciones">
                <div id="buzon-tablon-list"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensajes (DESKTOP - se oculta en móvil) -->
        <div class="mensajes-col">
          <div class="card mensajes-card">
            <div class="card-header">
              <span class="card-title">💬 Mensajes</span>
              <a href="chat.html" class="card-action">Ver todos →</a>
            </div>
            <div class="card-body">
              <div id="mensajes-list"></div>
              <a href="chat.html" class="btn-nuevo" style="text-decoration: none; display: inline-block;">+ Nuevo chat</a>
            </div>
          </div>
        </div>

        <!-- Tablón (DESKTOP - se oculta en móvil, integrado en buzón) -->
        <div class="tablon-col">
          <div class="card tablon-card">
            <div class="card-header">
              <span class="card-title">📌 Tablón</span>
              <a href="tablon.html" class="card-action">Ver todo →</a>
            </div>
            <div class="card-body">
              <div id="tablon-list"></div>
            </div>
          </div>
        </div>

        <!-- Mis Bienes (MÓVIL - acceso directo a Lo Común) -->
        <div class="mis-bienes-col">
          <div class="mis-bienes-section">
            <div class="mis-bienes-title">🏠 Mis Bienes</div>
            <div id="mis-bienes-list">
              <!-- Se llena dinámicamente -->
            </div>
            <a href="lo-comun.html" class="btn-nuevo" style="text-decoration: none; display: block; text-align: center; margin-top: 8px;">
              Ver todos en Lo Común →
            </a>
          </div>
        </div>

        <!-- Mi Plan (oculto si no es admin de rama) -->
        <div class="plan-col" id="plan-col">
          <div class="card plan-card">
            <div class="card-header">
              <span class="card-title">📋 Mi Plan</span>
              <a href="planes.html" class="card-action">Ver planes →</a>
            </div>
            <div class="card-body">
              <div class="plan-info">
                <div class="plan-icon" id="plan-icon">G</div>
                <div class="plan-details">
                  <div class="plan-nombre" id="plan-nombre">Gratuito</div>
                  <div class="plan-tipo" id="plan-tipo">Plan base</div>
                </div>
              </div>
              <div class="plan-stats">
                <div class="plan-stat">
                  <span class="plan-stat-label">Fotos</span>
                  <span class="plan-stat-value" id="plan-fotos">0 / 150</span>
                </div>
                <div class="plan-stat">
                  <span class="plan-stat-label">Generaciones</span>
                  <span class="plan-stat-value" id="plan-generaciones">3</span>
                </div>
              </div>
              <a href="planes.html" class="plan-upgrade" id="plan-upgrade">Mejorar plan</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Avería -->
  <div class="modal-overlay" id="modal-averia">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">🔧 Avisar avería</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-averia">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¿Dónde está el problema? *</label>
            <select class="form-select" id="averia-bien" required>
              <option value="">Selecciona un bien...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Describe la avería *</label>
            <textarea class="form-input" id="averia-descripcion" rows="3" placeholder="Ej: El grifo del baño gotea..." required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Urgencia</label>
            <div class="urgencia-options">
              <label class="urgencia-option">
                <input type="radio" name="averia-urgencia" value="baja" checked>
                <span class="urgencia-badge baja">🟢 Baja</span>
              </label>
              <label class="urgencia-option">
                <input type="radio" name="averia-urgencia" value="media">
                <span class="urgencia-badge media">🟡 Media</span>
              </label>
              <label class="urgencia-option">
                <input type="radio" name="averia-urgencia" value="alta">
                <span class="urgencia-badge alta">🔴 Alta</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién puede verlo?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'averia')">
                <input type="radio" name="averia-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'averia')">
                <input type="radio" name="averia-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'averia')">
                <input type="radio" name="averia-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar aviso</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Iniciativa -->
  <div class="modal-overlay" id="modal-iniciativa">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">💡 Proponer idea</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-iniciativa">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Título de la propuesta *</label>
            <input type="text" class="form-input" id="iniciativa-titulo" placeholder="Ej: Organizar barbacoa familiar" required>
          </div>
          <div class="form-group">
            <label class="form-label">Descripción *</label>
            <textarea class="form-input" id="iniciativa-descripcion" rows="3" placeholder="Explica tu idea con más detalle..." required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Categoría</label>
            <select class="form-select" id="iniciativa-categoria">
              <option value="evento">🎉 Evento</option>
              <option value="mejora">🔧 Mejora</option>
              <option value="compra">🛒 Compra</option>
              <option value="viaje">✈️ Viaje</option>
              <option value="otro">📋 Otro</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién puede verlo?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'iniciativa')">
                <input type="radio" name="iniciativa-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'iniciativa')">
                <input type="radio" name="iniciativa-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'iniciativa')">
                <input type="radio" name="iniciativa-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar propuesta</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Encargo -->
  <div class="modal-overlay" id="modal-encargo">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">🛒 Hacer encargo</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-encargo">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¿Para qué bien? *</label>
            <select class="form-select" id="encargo-bien" required>
              <option value="">Selecciona un bien...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">¿Qué necesitas? *</label>
            <textarea class="form-input" id="encargo-items" rows="3" placeholder="Ej: Papel higiénico, jabón, bombillas..." required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Notas adicionales</label>
            <input type="text" class="form-input" id="encargo-notas" placeholder="Ej: Marca preferida, cantidad...">
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién puede verlo?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'encargo')">
                <input type="radio" name="encargo-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'encargo')">
                <input type="radio" name="encargo-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'encargo')">
                <input type="radio" name="encargo-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar encargo</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Solicitar Evento -->
  <div class="modal-overlay" id="modal-evento">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">🎉 Solicitar evento</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-evento">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre del evento *</label>
            <input type="text" class="form-input" id="evento-nombre" placeholder="Ej: Cumpleaños de Juan, Barbacoa familiar..." required>
          </div>
          <div class="form-group">
            <label class="form-label">¿Dónde? *</label>
            <select class="form-select" id="evento-bien" required>
              <option value="">Selecciona un lugar...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha propuesta *</label>
            <input type="date" class="form-input" id="evento-fecha" required>
          </div>
          <div class="form-group">
            <label class="form-label">Descripción / Motivo</label>
            <textarea class="form-input" id="evento-descripcion" rows="2" placeholder="Cuéntanos más sobre el evento..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién puede verlo?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'evento')">
                <input type="radio" name="evento-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'evento')">
                <input type="radio" name="evento-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'evento')">
                <input type="radio" name="evento-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #FF9800, #F57C00);">Enviar solicitud</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Solicitar Reserva -->
  <div class="modal-overlay" id="modal-reserva">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">📅 Solicitar reserva</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-reserva">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¿Qué quieres reservar? *</label>
            <select class="form-select" id="reserva-bien" required>
              <option value="">Selecciona un bien...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha inicio *</label>
            <input type="date" class="form-input" id="reserva-inicio" required>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha fin *</label>
            <input type="date" class="form-input" id="reserva-fin" required>
          </div>
          <div class="form-group">
            <label class="form-label">Motivo / Notas</label>
            <textarea class="form-input" id="reserva-motivo" rows="2" placeholder="Ej: Fin de semana con amigos..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién puede verlo?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'reserva')">
                <input type="radio" name="reserva-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'reserva')">
                <input type="radio" name="reserva-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'reserva')">
                <input type="radio" name="reserva-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #42A5F5, #1E88E5);">Enviar solicitud</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Convocatoria -->
  <div class="modal-overlay" id="modal-convocatoria">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">✋ Convocar asistencia</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-convocatoria" onsubmit="enviarConvocatoria(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Evento o actividad *</label>
            <input type="text" class="form-input" id="convocatoria-titulo" required placeholder="Ej: Comida de Navidad, Excursión al monte...">
          </div>
          <div class="form-group">
            <label class="form-label">Fecha *</label>
            <input type="date" class="form-input" id="convocatoria-fecha" required>
          </div>
          <div class="form-group">
            <label class="form-label">Hora (opcional)</label>
            <input type="time" class="form-input" id="convocatoria-hora">
          </div>
          <div class="form-group">
            <label class="form-label">Lugar (opcional)</label>
            <input type="text" class="form-input" id="convocatoria-lugar" placeholder="Ej: Casa de los abuelos">
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-input" id="convocatoria-notas" rows="2" placeholder="Detalles adicionales..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién debe confirmar?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'convocatoria')">
                <input type="radio" name="convocatoria-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'convocatoria')">
                <input type="radio" name="convocatoria-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'convocatoria')">
                <input type="radio" name="convocatoria-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">Enviar convocatoria</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Queo -->
  <div class="modal-overlay" id="modal-comunicado">
    <div class="modal modal-comunicado">
      <!-- Header -->
      <div class="modal-header">
        <div class="modal-logo">📣</div>
        <div class="modal-header-info">
          <h2 class="modal-title">Nuevo Queo</h2>
          <p class="modal-subtitle">Envía una notificación a los miembros</p>
        </div>
        <button class="modal-close" onclick="cerrarModalComunicado()">×</button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <form id="form-comunicado">
          
          <!-- Destinatarios -->
          <div class="form-group">
            <label class="form-label">
              Destinatarios
              <span class="form-label-hint">(selecciona uno o varios)</span>
            </label>
            <div class="destinatarios-grid" id="destinatarios-grid">
              <label class="destinatario-option" data-dest="toda-rama" onclick="toggleDestinatario(this)">
                <input type="checkbox" name="destinatarios" value="toda-rama">
                <span class="destinatario-check">✓</span>
                <div class="destinatario-info">
                  <div class="destinatario-nombre">Toda la Rama</div>
                  <div class="destinatario-desc">Todos los miembros</div>
                </div>
                <span class="destinatario-icon">🌳</span>
              </label>
              <label class="destinatario-option" data-dest="admins" onclick="toggleDestinatario(this)">
                <input type="checkbox" name="destinatarios" value="admins">
                <span class="destinatario-check">✓</span>
                <div class="destinatario-info">
                  <div class="destinatario-nombre">Administradores</div>
                  <div class="destinatario-desc">Admins de rama y nidos</div>
                </div>
                <span class="destinatario-icon">👑</span>
              </label>
              <label class="destinatario-option" data-dest="mi-nido" onclick="toggleDestinatario(this)">
                <input type="checkbox" name="destinatarios" value="mi-nido">
                <span class="destinatario-check">✓</span>
                <div class="destinatario-info">
                  <div class="destinatario-nombre">Mi Nido</div>
                  <div class="destinatario-desc">Solo mi núcleo familiar</div>
                </div>
                <span class="destinatario-icon">🪺</span>
              </label>
              <label class="destinatario-option" data-dest="mi-estirpe" onclick="toggleDestinatario(this)">
                <input type="checkbox" name="destinatarios" value="mi-estirpe">
                <span class="destinatario-check">✓</span>
                <div class="destinatario-info">
                  <div class="destinatario-nombre">Mi Estirpe</div>
                  <div class="destinatario-desc">Ascendientes y descendientes</div>
                </div>
                <span class="destinatario-icon">👨‍👩‍👧‍👦</span>
              </label>
            </div>
          </div>

          <!-- Asunto -->
          <div class="form-group">
            <label class="form-label" for="comunicado-asunto">Asunto</label>
            <input 
              type="text" 
              class="form-input" 
              id="comunicado-asunto" 
              placeholder="Ej: Recordatorio reunión familiar"
              maxlength="100"
              required
              oninput="validarFormularioComunicado()"
            >
          </div>

          <!-- Cuerpo del mensaje -->
          <div class="form-group">
            <label class="form-label" for="comunicado-mensaje">Mensaje</label>
            <textarea 
              class="form-input" 
              id="comunicado-mensaje" 
              placeholder="Escribe el contenido del comunicado..."
              maxlength="600"
              required
              oninput="actualizarContadorComunicado()"
              style="min-height: 120px; resize: vertical;"
            ></textarea>
            <div class="char-counter" id="comunicado-char-counter">0 / 600 caracteres</div>
          </div>

          <!-- Subir imágenes -->
          <div class="form-group">
            <label class="form-label">
              Imágenes
              <span class="form-label-hint">(opcional, máx. 3)</span>
            </label>
            <div class="upload-area" id="comunicado-upload-area" onclick="document.getElementById('comunicado-upload-input').click()">
              <div class="upload-icon">📷</div>
              <div class="upload-text">Haz clic o arrastra imágenes aquí</div>
              <div class="upload-hint">JPG, PNG • Máximo 3 imágenes • 5MB cada una</div>
            </div>
            <input 
              type="file" 
              class="upload-input" 
              id="comunicado-upload-input" 
              accept="image/jpeg,image/png,image/webp"
              multiple
              onchange="handleComunicadoFiles(this.files)"
            >
            <div class="preview-grid" id="comunicado-preview-grid"></div>
          </div>

          <!-- Tipo de queo -->
          <div class="form-group">
            <label class="form-label">Tipo de queo</label>
            <div class="tipo-selector">
              <label class="tipo-option info selected" onclick="selectTipoComunicado(this, 'info')">
                <input type="radio" name="comunicado-tipo" value="info" checked>
                <div class="tipo-icon">ℹ️</div>
                <div class="tipo-nombre">Información</div>
                <div class="tipo-desc">Aviso o noticia general</div>
              </label>
              <label class="tipo-option accion" onclick="selectTipoComunicado(this, 'accion')">
                <input type="radio" name="comunicado-tipo" value="accion">
                <div class="tipo-icon">⚡</div>
                <div class="tipo-nombre">Acción requerida</div>
                <div class="tipo-desc">Requiere respuesta o acción</div>
              </label>
            </div>
          </div>

        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModalComunicado()">Cancelar</button>
        <button class="btn btn-primary" onclick="enviarComunicado()" id="btn-enviar-comunicado" disabled>
          <span>📤</span> Enviar queo
        </button>
      </div>
    </div>
  </div>

  <footer class="app-footer">
    <a href="planes.html">Planes</a>
    <a href="#">Privacidad</a>
    <a href="#">Términos</a>
    <span>© 2025 FAMILYNK</span>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let userData = null;
    let currentFamilia = null;
    let estirpesUsuario = []; // Array de estirpes a las que pertenece
    let allNidos = [];
    let miNidoPrincipal = null;

    // ============ AUTH ============
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      
      currentUser = user;

      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists || !userDoc.data().familiaId) {
        window.location.href = 'onboarding.html';
        return;
      }

      userData = userDoc.data();

      if (userData.primerAcceso === true) {
        window.location.href = 'cambiar-password.html';
        return;
      }

      // ========================================
      // SINCRONIZACIÓN DE MIEMBRO INVITADO
      // Si el usuario no tiene nidoId, buscar si está en miembrosData de algún nido
      // ========================================
      if (!userData.nidoId) {
        await sincronizarMiembroInvitado();
      }

      // Cargar estirpes del usuario
      const estirpesIds = userData.estirpes || [userData.familiaId];
      const estirpeActiva = userData.estirpeActiva || userData.familiaId;
      
      // Cargar todas las estirpes
      estirpesUsuario = [];
      for (const estirpeId of estirpesIds) {
        const estirpeDoc = await db.collection('familias').doc(estirpeId).get();
        if (estirpeDoc.exists) {
          estirpesUsuario.push({ id: estirpeDoc.id, ...estirpeDoc.data() });
        }
      }
      
      // Establecer estirpe activa
      currentFamilia = estirpesUsuario.find(e => e.id === estirpeActiva) || estirpesUsuario[0];
      
      // Mostrar selector si tiene más de 1 estirpe
      if (estirpesUsuario.length > 1) {
        document.getElementById('familia-badge').classList.add('hidden');
        document.getElementById('estirpe-selector').classList.remove('hidden');
        renderEstirpeSelector();
      }

      await initApp();
    });

    // ============ SINCRONIZACIÓN DE MIEMBRO INVITADO ============
    async function sincronizarMiembroInvitado() {
      try {
        console.log('🔄 Buscando datos pre-registrados para:', currentUser.email);
        
        // Buscar en todos los nidos de la familia del usuario
        const nidosSnapshot = await db.collection('nidos')
          .where('familiaId', '==', userData.familiaId)
          .get();
        
        let nidoEncontrado = null;
        let miembroEncontrado = null;
        let miembroIndex = -1;
        
        // Buscar el miembro por email en miembrosData de cada nido
        for (const doc of nidosSnapshot.docs) {
          const nido = { id: doc.id, ...doc.data() };
          const miembrosData = nido.miembrosData || [];
          
          const idx = miembrosData.findIndex(m => 
            m.email && m.email.toLowerCase() === currentUser.email.toLowerCase()
          );
          
          if (idx !== -1) {
            nidoEncontrado = nido;
            miembroEncontrado = miembrosData[idx];
            miembroIndex = idx;
            console.log('✅ Encontrado en nido:', nido.nombre, 'como:', miembroEncontrado.nombre);
            break;
          }
        }
        
        if (!nidoEncontrado || !miembroEncontrado) {
          console.log('ℹ️ No se encontraron datos pre-registrados');
          return;
        }
        
        // Preparar actualizaciones
        const batch = db.batch();
        
        // 1. Actualizar documento del usuario con datos del nido
        const userRef = db.collection('usuarios').doc(currentUser.uid);
        const userUpdates = {
          nidoId: nidoEncontrado.id,
          nidoNombre: nidoEncontrado.nombre
        };
        
        // Si el usuario no tiene nombre, usar el pre-registrado
        if (!userData.nombre && miembroEncontrado.nombre) {
          userUpdates.nombre = miembroEncontrado.nombre;
        }
        
        // Copiar otros datos pre-registrados si existen
        if (miembroEncontrado.tipo) userUpdates.tipoMiembro = miembroEncontrado.tipo;
        if (miembroEncontrado.telefono && !userData.telefono) userUpdates.telefono = miembroEncontrado.telefono;
        if (miembroEncontrado.fechaNacimiento && !userData.fechaNacimiento) userUpdates.fechaNacimiento = miembroEncontrado.fechaNacimiento;
        
        batch.update(userRef, userUpdates);
        console.log('📝 Actualizando usuario con:', userUpdates);
        
        // 2. Actualizar miembrosData del nido con el uid del usuario
        const nidoRef = db.collection('nidos').doc(nidoEncontrado.id);
        const miembrosActualizados = [...(nidoEncontrado.miembrosData || [])];
        miembrosActualizados[miembroIndex] = {
          ...miembroEncontrado,
          uid: currentUser.uid,
          registrado: true,
          fechaRegistro: new Date().toISOString()
        };
        
        batch.update(nidoRef, { 
          miembrosData: miembrosActualizados,
          miembros: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        console.log('📝 Actualizando nido con uid del usuario');
        
        // Ejecutar batch
        await batch.commit();
        console.log('✅ Sincronización completada');
        
        // Actualizar userData local con los nuevos datos
        Object.assign(userData, userUpdates);
        
      } catch (error) {
        console.error('❌ Error en sincronización:', error);
      }
    }

    // ============ INIT ============
    async function initApp() {
      const nombre = userData.nombre || currentUser.displayName || currentUser.email.split('@')[0];
      const primerNombre = nombre.split(' ')[0];
      
      document.getElementById('user-name').textContent = primerNombre;
      document.getElementById('user-avatar').textContent = primerNombre.charAt(0).toUpperCase();
      
      const hora = new Date().getHours();
      let saludo = 'Buenos días';
      if (hora >= 14 && hora < 21) saludo = 'Buenas tardes';
      else if (hora >= 21 || hora < 6) saludo = 'Buenas noches';
      
      document.getElementById('welcome-title').textContent = `${saludo}, ${primerNombre} 👋`;

      renderAdminButtons();
      await loadNidos();
      await verificarTiendaDisponible();
      
      await cargarEventosCalendario();
      renderCalendario();
      renderMensajes();
      renderTablon();
      // Renderizar buzón unificado después de mensajes y tablón
      setTimeout(() => renderBuzonUnificado(), 500);
      renderMisBienes();
      cargarBadgeChat();
      renderPlan();
    }

    // ============ MI PLAN ============
    let planesConfig = null;
    
    async function cargarPlanesConfig() {
      if (planesConfig) return planesConfig;
      try {
        const doc = await db.collection('config').doc('planes').get();
        if (doc.exists) {
          planesConfig = doc.data();
        }
      } catch (e) {
        console.warn('Error cargando config planes:', e);
      }
      return planesConfig;
    }

    async function renderPlan() {
      // Cargar config desde Firestore
      await cargarPlanesConfig();
      
      // Datos del plan desde familia o usuario
      const plan = currentFamilia?.plan || userData?.plan || 'gratuito';
      const fotos = currentFamilia?.fotosUsadas || 0;
      
      // Defaults por si no hay config en Firestore
      const planesDefault = {
        'gratuito': { nombre: 'Gratuito', icon: 'G', descripcion: 'Plan base', maxFotos: 100, maxGeneraciones: 3 },
        'plus': { nombre: 'Plus', icon: '+', descripcion: 'Plan familiar', maxFotos: 500, maxGeneraciones: 4 },
        'premium': { nombre: 'Premium', icon: 'P', descripcion: 'Todo incluido', maxFotos: 9999, maxGeneraciones: 99 }
      };
      
      // Usar config de Firestore si existe, sino defaults
      let planData;
      if (planesConfig && planesConfig[plan]) {
        const p = planesConfig[plan];
        planData = {
          nombre: p.nombre || planesDefault[plan].nombre,
          icon: p.icon || planesDefault[plan].icon,
          tipo: p.descripcion || planesDefault[plan].descripcion,
          maxFotos: p.maxFotos || planesDefault[plan].maxFotos,
          generaciones: p.maxGeneraciones || planesDefault[plan].maxGeneraciones
        };
      } else {
        const d = planesDefault[plan] || planesDefault['gratuito'];
        planData = { nombre: d.nombre, icon: d.icon, tipo: d.descripcion, maxFotos: d.maxFotos, generaciones: d.maxGeneraciones };
      }

      document.getElementById('plan-icon').textContent = planData.icon;
      document.getElementById('plan-nombre').textContent = planData.nombre;
      document.getElementById('plan-tipo').textContent = planData.tipo;
      document.getElementById('plan-fotos').textContent = `${fotos} / ${planData.maxFotos === 9999 ? '∞' : planData.maxFotos}`;
      document.getElementById('plan-generaciones').textContent = planData.generaciones >= 99 ? '∞' : planData.generaciones;

      // Ocultar botón mejorar si ya tiene Premium
      if (plan === 'premium') {
        document.getElementById('plan-upgrade').style.display = 'none';
      }
    }

    // ============ SELECTOR DE ESTIRPES ============
    function renderEstirpeSelector() {
      const nombreEstirpe = currentFamilia?.nombre || currentFamilia?.apellidoPrincipal || currentFamilia?.nombreFamilia || 'Mi Estirpe';
      document.getElementById('estirpe-actual-nombre').textContent = nombreEstirpe;
      
      const list = document.getElementById('estirpe-dropdown-list');
      list.innerHTML = estirpesUsuario.map(e => `
        <div class="estirpe-dropdown-item ${e.id === currentFamilia?.id ? 'active' : ''}" onclick="cambiarEstirpe('${e.id}')">
          <span class="estirpe-dropdown-item-icon">🪺</span>
          <span class="estirpe-dropdown-item-name">${e.nombre || e.apellidoPrincipal || e.nombreFamilia || 'Estirpe'}</span>
          ${e.id === currentFamilia?.id ? '<span class="estirpe-dropdown-item-check">✓</span>' : ''}
        </div>
      `).join('');
    }

    function toggleEstirpeDropdown() {
      const selector = document.getElementById('estirpe-selector');
      const dropdown = document.getElementById('estirpe-dropdown');
      selector.classList.toggle('open');
      dropdown.classList.toggle('hidden');
    }

    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', (e) => {
      const selector = document.getElementById('estirpe-selector');
      if (selector && !selector.contains(e.target)) {
        selector.classList.remove('open');
        document.getElementById('estirpe-dropdown')?.classList.add('hidden');
      }
    });

    async function cambiarEstirpe(estirpeId) {
      if (estirpeId === currentFamilia?.id) {
        toggleEstirpeDropdown();
        return;
      }
      
      try {
        // Guardar estirpe activa en Firebase
        await db.collection('usuarios').doc(currentUser.uid).update({
          estirpeActiva: estirpeId
        });
        
        // Recargar página para cargar nueva estirpe
        window.location.reload();
      } catch (error) {
        console.error('Error cambiando estirpe:', error);
        alert('Error al cambiar de estirpe');
      }
    }

    // ============ ADMIN BUTTONS ============
    let esAdminRama = false;
    let esAdminNido = false;

    function renderAdminButtons() {
      const container = document.getElementById('admin-buttons');
      const mobileContainer = document.getElementById('mobile-admin-buttons');
      let html = '';

      // Super Admin (Diseñador del sistema) - tiene acceso total
      const isSuperAdmin = userData.superAdmin === true;

      // Admin Rama Familiar (antes "Admin Sistema")
      const isAdminRama = userData.rol === 'adminRama' || 
        userData.rol === 'adminSistema' || // compatibilidad
        (currentFamilia?.adminsGenerales?.includes(currentUser.uid)) ||
        (currentFamilia?.fundador === currentUser.uid) ||
        (currentFamilia?.creador === currentUser.uid);

      const miNidoId = userData.nidoId;
      
      // Guardar en variables globales para el comunicado
      esAdminRama = isAdminRama || isSuperAdmin;
      esAdminNido = !!miNidoId;

      // 1. Botón TERRACOTTA - Admin Nido
      if (miNidoId) {
        html += `<a href="admin-nido.html" class="admin-btn nido"><span>⚙️</span> Admin Nido</a>`;
      }

      // 2. Botón MARRÓN - Gestión Activa
      if (isAdminRama || miNidoId) {
        html += `<a href="lo-comun.html" class="admin-btn mayordomo"><span>🎩</span> Gestión Activa</a>`;
      }

      // 3. Botón ROJO - Admin Rama Familiar
      if (isAdminRama) {
        html += `<a href="admin-rama.html" class="admin-btn rama"><span>🔧</span> Admin Rama</a>`;
        html += `<a href="crear-rama.html" class="admin-btn crear-rama"><span>🌳</span> Crear/Fusionar Rama</a>`;
      }

      // 4. Botón NEGRO - Admin Sistema (solo superAdmin/Diseñador)
      if (isSuperAdmin) {
        html += `<a href="admin-sistema.html" class="admin-btn sistema"><span>⚡</span> Admin Sistema</a>`;
      }

      // 5. Botón COMUNICADO - Para admins de rama o nido
      if (isAdminRama || miNidoId) {
        html += `<button class="admin-btn comunicado" onclick="abrirModalComunicado()"><span class="admin-btn-icon">📣</span><span class="admin-btn-text">Queo</span></button>`;
      }

      container.innerHTML = html;
      mobileContainer.innerHTML = html;
      
      // Mostrar/ocultar sección de admin en menú móvil
      const adminSection = document.getElementById('nav-admin-section');
      if (adminSection) {
        adminSection.style.display = html ? 'block' : 'none';
      }

      // Configurar destinatarios del modal comunicado según rol
      if (isAdminRama || miNidoId) {
        configurarDestinatariosComunicado(isAdminRama);
      }
    }

    // ============ LOAD NIDOS ============
    async function loadNidos() {
      const loadingEl = document.getElementById('page-loading');
      const contentEl = document.getElementById('page-content');

      try {
        const nidosSnapshot = await db.collection('nidos')
          .where('familiaId', '==', currentFamilia.id)
          .get();
        
        allNidos = [];
        let generaciones = new Set();
        
        // Set para contar miembros únicos (evitar duplicidades)
        const miembrosUnicos = new Set();

        nidosSnapshot.forEach(doc => {
          const nido = { id: doc.id, ...doc.data() };
          allNidos.push(nido);
          
          // Contar miembros únicos por email o nombre (evitando duplicidades)
          if (nido.miembrosData) {
            nido.miembrosData.forEach(m => {
              // Usar email como identificador único, o nombre si no hay email
              const identificador = m.email || m.uid || m.nombre;
              if (identificador) {
                miembrosUnicos.add(identificador.toLowerCase().trim());
              }
            });
          }
          
          if (nido.generacion) generaciones.add(nido.generacion);
        });
        
        const totalMiembros = miembrosUnicos.size;

        // ========================================
        // LÓGICA MEJORADA PARA ENCONTRAR MI NIDO
        // ========================================
        // 1. PRIMERO: El nido asignado específicamente al usuario (userData.nidoId)
        // 2. SEGUNDO: Un nido donde el usuario aparezca en miembrosData (por email o uid)
        // 3. TERCERO: Un nido donde aparezca en el array miembros
        // 4. CUARTO: Si es admin de algún nido, mostrar ese
        // 5. ÚLTIMO: El primero disponible (fallback)
        
        miNidoPrincipal = null;
        
        // Opción 1: nidoId directo del usuario
        if (userData.nidoId) {
          miNidoPrincipal = allNidos.find(n => n.id === userData.nidoId);
          console.log('Nido por userData.nidoId:', miNidoPrincipal?.nombre);
        }
        
        // Opción 2: Buscar en miembrosData por email
        if (!miNidoPrincipal) {
          const userEmail = currentUser.email;
          miNidoPrincipal = allNidos.find(n => 
            n.miembrosData?.some(m => m.email === userEmail || m.uid === currentUser.uid)
          );
          console.log('Nido por miembrosData:', miNidoPrincipal?.nombre);
        }
        
        // Opción 3: Buscar en array miembros
        if (!miNidoPrincipal) {
          miNidoPrincipal = allNidos.find(n => n.miembros?.includes(currentUser.uid));
          console.log('Nido por miembros[]:', miNidoPrincipal?.nombre);
        }
        
        // Opción 4: Nido donde sea admin (menos prioridad)
        if (!miNidoPrincipal) {
          miNidoPrincipal = allNidos.find(n => n.admins?.includes(currentUser.uid));
          console.log('Nido por admins[]:', miNidoPrincipal?.nombre);
        }
        
        // Opción 5: Fallback al primero
        if (!miNidoPrincipal && allNidos.length > 0) {
          miNidoPrincipal = allNidos[0];
          console.log('⚠️ Fallback al primer nido:', miNidoPrincipal?.nombre);
        }

        // Stats para badge
        const nombreRama = currentFamilia.nombre || currentFamilia.apellidoPrincipal || currentFamilia.nombreFamilia || 'Mi Rama';
        document.getElementById('familia-badge-nombre').textContent = nombreRama;
        document.getElementById('badge-nidos').textContent = allNidos.length;
        document.getElementById('badge-miembros').textContent = totalMiembros;
        
        // Sincronizar stats en la card de Nido (versión móvil)
        document.getElementById('rama-nombre-mobile').textContent = nombreRama;
        document.getElementById('badge-nidos-mobile').textContent = allNidos.length;
        document.getElementById('badge-miembros-mobile').textContent = totalMiembros;
        
        // Sincronizar stats en el menú hamburguesa
        document.getElementById('nav-rama-nombre').textContent = nombreRama;
        document.getElementById('nav-badge-nidos').textContent = allNidos.length;
        document.getElementById('nav-badge-miembros').textContent = totalMiembros;
        
        // Ocultar Plan si no es admin de rama
        const isAdminRama = userData.rol === 'adminRama' || 
          userData.rol === 'adminSistema' ||
          (currentFamilia?.adminsGenerales?.includes(currentUser.uid)) ||
          (currentFamilia?.fundador === currentUser.uid) ||
          (currentFamilia?.creador === currentUser.uid);
        
        const planCol = document.getElementById('plan-col');
        if (planCol && !isAdminRama) {
          planCol.classList.add('hidden-no-admin');
        }

        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');

        // Mostrar modal de Primeros Pasos si es necesario
        verificarPrimerosPasos();

        if (miNidoPrincipal) {
          renderMiNido(miNidoPrincipal);
        }

      } catch (error) {
        console.error('Error loading nidos:', error);
        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
      }
    }

    // ============ RENDER MI NIDO ============
    function renderMiNido(nido) {
      const genLabels = {
        '1-bisabuelos': 'Bisabuelos',
        '2-abuelos': 'Abuelos',
        '3-padres': 'Padres',
        '4-hijos': 'Hijos'
      };

      document.getElementById('nido-nombre').textContent = nido.nombre || 'Mi Nido';
      document.getElementById('nido-desc').textContent = genLabels[nido.generacion] || '';

      const relacionLabels = {
        'progenitor': 'Prog.', 'descendiente': 'Hijo/a', 'hijo': 'Hijo/a',
        'ascendiente': 'Asc.', 'colateral': 'Col.', 'otros': ''
      };

      const container = document.getElementById('miembros-compact');
      
      if (!nido.miembrosData || nido.miembrosData.length === 0) {
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">👥</div>Sin miembros</div>';
        return;
      }

      container.innerHTML = nido.miembrosData.slice(0, 6).map(m => {
        const fallecido = m.fechaDefuncion ? 'fallecido' : '';
        const rel = relacionLabels[m.relacion || m.rol] || '';
        return `
          <div class="miembro-mini">
            <div class="miembro-mini-avatar ${fallecido}">${m.iniciales || '?'}</div>
            <div class="miembro-mini-info">
              <div class="miembro-mini-name">${m.nombre || m.iniciales}</div>
              <div class="miembro-mini-rel">${rel}</div>
            </div>
          </div>
        `;
      }).join('');

      if (nido.miembrosData.length > 6) {
        container.innerHTML += `<div style="text-align:center;font-size:0.7rem;color:var(--text-muted);padding:4px;">+${nido.miembrosData.length - 6} más</div>`;
      }
    }

    // ============ CALENDARIO ============
    let eventosCalendario = [];

    // Helper para verificar visibilidad de un elemento
    function esVisibleParaUsuario(item, nidosMap) {
      const visibilidad = item.visibilidad || 'rama';
      
      // Rama: visible para todos
      if (visibilidad === 'rama') return true;
      
      // Nido: solo visible si es del mismo nido
      if (visibilidad === 'nido') {
        return item.nidoId === miNidoPrincipal?.id;
      }
      
      // Estirpe: visible si mi nido desciende del nido creador
      if (visibilidad === 'estirpe') {
        if (!miNidoPrincipal) return false;
        // Construir cadena de ancestros de mi nido
        const misAncestros = new Set();
        let nidoActual = miNidoPrincipal.id;
        misAncestros.add(nidoActual);
        while (nidoActual && nidosMap[nidoActual]?.nidoOrigen) {
          nidoActual = nidosMap[nidoActual].nidoOrigen;
          misAncestros.add(nidoActual);
        }
        // También incluir mis descendientes
        const misDescendientes = new Set([miNidoPrincipal.id]);
        Object.values(nidosMap).forEach(n => {
          if (n.nidoOrigen === miNidoPrincipal.id) misDescendientes.add(n.id);
        });
        // El item es visible si su nidoId está en mis ancestros o descendientes
        return misAncestros.has(item.nidoId) || misDescendientes.has(item.nidoId);
      }
      
      return true;
    }

    async function cargarEventosCalendario() {
      if (!currentFamilia) return;
      eventosCalendario = [];
      const añoActual = new Date().getFullYear();

      try {
        // Cargar mapa de nidos para verificar estirpes
        const nidosSnap = await db.collection('nidos').where('familiaId', '==', currentFamilia.id).get();
        const nidosMap = {};
        nidosSnap.docs.forEach(doc => {
          nidosMap[doc.id] = { id: doc.id, ...doc.data() };
        });

        // 1. CUMPLEAÑOS desde miembros de nidos (solo de nidos visibles según estirpe)
        nidosSnap.docs.forEach(doc => {
          const nido = { id: doc.id, ...doc.data() };
          // Verificar si este nido es visible (usando visibilidad 'estirpe')
          const nidoVisible = esVisibleParaUsuario({ visibilidad: 'estirpe', nidoId: nido.id }, nidosMap);
          if (!nidoVisible) return;
          
          (nido.miembrosData || []).forEach(m => {
            if (m.fechaNacimiento) {
              const partes = m.fechaNacimiento.split('-');
              if (partes.length >= 3) {
                const mes = partes[1], dia = partes[2];
                [añoActual, añoActual+1].forEach(y => {
                  eventosCalendario.push({ tipo:'cumple', titulo:`🎂 ${m.nombre || 'Cumpleaños'}`, fecha:`${y}-${mes}-${dia}` });
                });
              }
            }
          });
        });

        // 2. DÍAS ESPECIALES (filtrar por visibilidad)
        const diasSnap = await db.collection('diasEspeciales').where('familiaId', '==', currentFamilia.id).get();
        diasSnap.docs.forEach(doc => {
          const d = { id: doc.id, ...doc.data() };
          if (!esVisibleParaUsuario(d, nidosMap)) return;
          
          [añoActual, añoActual+1].forEach(y => {
            eventosCalendario.push({ 
              tipo: d.tipo === 'cumple' ? 'cumple' : 'especial', 
              titulo: d.nombre, 
              fecha: `${y}-${String(d.mes).padStart(2,'0')}-${String(d.dia).padStart(2,'0')}` 
            });
          });
        });

        // 3. EVENTOS (filtrar por visibilidad)
        const eventosSnap = await db.collection('eventos').where('familiaId', '==', currentFamilia.id).get();
        eventosSnap.docs.forEach(doc => {
          const e = { id: doc.id, ...doc.data() };
          if (!esVisibleParaUsuario(e, nidosMap)) return;
          
          if (e.fecha) eventosCalendario.push({ tipo:'evento', titulo: e.nombre, fecha: e.fecha, hora: e.hora });
        });

        // 4. CITAS (filtrar por visibilidad)
        const citasSnap = await db.collection('citas').where('familiaId', '==', currentFamilia.id).get();
        citasSnap.docs.forEach(doc => {
          const c = { id: doc.id, ...doc.data() };
          if (!esVisibleParaUsuario(c, nidosMap)) return;
          
          if (c.fecha) eventosCalendario.push({ tipo:'cita', titulo: c.titulo, fecha: c.fecha, hora: c.hora });
        });

        // 5. RESERVAS de bienes (filtrar por visibilidad)
        const bienesSnap = await db.collection('bienes').where('familiaId', '==', currentFamilia.id).get();
        for (const bienDoc of bienesSnap.docs) {
          const bien = bienDoc.data();
          const reservasSnap = await db.collection('bienes').doc(bienDoc.id).collection('reservas').get();
          reservasSnap.docs.forEach(resDoc => {
            const r = { id: resDoc.id, ...resDoc.data() };
            if (!esVisibleParaUsuario(r, nidosMap)) return;
            
            if (r.entrada) {
              eventosCalendario.push({ 
                tipo: 'reserva', 
                titulo: `🏠 ${bien.nombre || 'Reserva'}`, 
                fecha: r.entrada,
                fechaFin: r.salida
              });
            }
          });
        }
      } catch (error) {
        console.error('Error cargando eventos calendario:', error);
      }
    }

    function renderCalendario() {
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const hoy = new Date();
      
      document.getElementById('mes-actual').textContent = meses[hoy.getMonth()];

      const container = document.getElementById('calendario-mini');
      const dias = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
      
      let html = dias.map(d => `<div class="cal-header">${d}</div>`).join('');

      const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
      
      let diaInicio = primerDia.getDay();
      if (diaInicio === 0) diaInicio = 7;
      diaInicio--;

      // Agrupar eventos por fecha
      const eventosPorFecha = {};
      eventosCalendario.forEach(e => {
        if (!eventosPorFecha[e.fecha]) eventosPorFecha[e.fecha] = [];
        eventosPorFecha[e.fecha].push(e);
      });

      const diasMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth(), 0).getDate();
      for (let i = diaInicio - 1; i >= 0; i--) {
        html += `<div class="cal-day other-month">${diasMesAnterior - i}</div>`;
      }

      for (let d = 1; d <= ultimoDia.getDate(); d++) {
        const esHoy = d === hoy.getDate();
        const fechaStr = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const eventosDelDia = eventosPorFecha[fechaStr] || [];
        
        // Generar dots únicos por tipo
        const tiposUnicos = [...new Set(eventosDelDia.map(e => e.tipo))];
        const dotsHtml = tiposUnicos.length > 0 
          ? `<div class="cal-day-dots">${tiposUnicos.slice(0,3).map(t => `<div class="cal-dot ${t}"></div>`).join('')}</div>` 
          : '';
        
        html += `<div class="cal-day ${esHoy ? 'today' : ''} ${eventosDelDia.length > 0 ? 'has-events' : ''}">${d}${dotsHtml}</div>`;
      }

      container.innerHTML = html;

      // Mostrar eventos de hoy
      renderEventosHoy(hoy);
    }

    function renderEventosHoy(fecha) {
      const container = document.getElementById('eventos-hoy');
      const fechaStr = `${fecha.getFullYear()}-${String(fecha.getMonth()+1).padStart(2,'0')}-${String(fecha.getDate()).padStart(2,'0')}`;
      
      const eventosHoy = eventosCalendario.filter(e => e.fecha === fechaStr);
      
      if (eventosHoy.length === 0) {
        container.innerHTML = `<div class="evento-mini"><div class="evento-dot cita"></div><span style="color:var(--text-muted);">Sin eventos hoy</span></div>`;
        return;
      }

      container.innerHTML = eventosHoy.slice(0, 3).map(e => `
        <div class="evento-mini" style="margin-bottom:4px;">
          <div class="evento-dot ${e.tipo}"></div>
          <span>${e.titulo}${e.hora ? ` · ${e.hora}` : ''}</span>
        </div>
      `).join('') + (eventosHoy.length > 3 ? `<div style="font-size:0.65rem;color:var(--text-muted);text-align:center;">+${eventosHoy.length - 3} más</div>` : '');
    }

    // ============ TAREAS (REAL) ============
    let tareasData = [];

    async function renderTareas() {
      const container = document.getElementById('tareas-list');
      
      if (!miNidoPrincipal || !currentFamilia || !currentUser) {
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">📋</div>Selecciona un nido</div>';
        return;
      }

      try {
        // Cargar tareas asignadas al usuario actual
        const snap = await db.collection('tareas')
          .where('familiaId', '==', currentFamilia.id)
          .where('completada', '==', false)
          .orderBy('fechaCreacion', 'desc')
          .limit(20)
          .get();

        // Filtrar solo las asignadas a mí (por UID o por nombre/email)
        const userData = (await db.collection('usuarios').doc(currentUser.uid).get()).data() || {};
        const miNombre = userData.nombre || userData.displayName || '';
        const miEmail = currentUser.email || '';

        tareasData = snap.docs
          .map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(t => {
            // Si no tiene asignadoA, no la muestro
            if (!t.asignadoA && !t.asignadoUID) return false;
            // Coincide por UID
            if (t.asignadoUID === currentUser.uid) return true;
            // Coincide por nombre o email
            const asignado = (t.asignadoA || '').toLowerCase();
            return asignado === miNombre.toLowerCase() || 
                   asignado === miEmail.toLowerCase() ||
                   asignado.includes(miNombre.toLowerCase());
          })
          .slice(0, 5);

        if (tareasData.length === 0) {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">✅</div>Sin tareas asignadas</div>';
          return;
        }

        container.innerHTML = tareasData.map(t => `
          <div class="tarea-item" onclick="toggleTarea('${t.id}')">
            <div class="tarea-check ${t.completada ? 'done' : ''}">${t.completada ? '✓' : ''}</div>
            <div class="tarea-content">
              <div class="tarea-titulo ${t.completada ? 'done' : ''}">${t.titulo}</div>
              <div class="tarea-asignado">${t.asignadoA || 'Para mí'}</div>
            </div>
            <div class="tarea-prioridad ${t.prioridad || 'media'}"></div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error cargando tareas:', error);
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">⚠️</div>Error al cargar</div>';
      }
    }

    async function toggleTarea(tareaId) {
      try {
        const tarea = tareasData.find(t => t.id === tareaId);
        if (!tarea) return;

        await db.collection('tareas').doc(tareaId).update({
          completada: !tarea.completada,
          fechaCompletada: !tarea.completada ? firebase.firestore.FieldValue.serverTimestamp() : null
        });

        renderTareas();
      } catch (error) {
        console.error('Error actualizando tarea:', error);
      }
    }

    // ============ BUZÓN (REAL) ============
    let mensajesData = [];

    async function renderMensajes() {
      const container = document.getElementById('mensajes-list');
      
      if (!currentUser || !currentFamilia) {
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">💬</div>Sin conversaciones</div>';
        return;
      }

      try {
        // Cargar conversaciones del chat
        const snap = await db.collection('conversaciones')
          .where('participantes', 'array-contains', currentUser.uid)
          .limit(4)
          .get();

        let conversaciones = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Ordenar por último mensaje
        conversaciones.sort((a, b) => {
          const fechaA = a.ultimoMensaje?.fecha?.toDate?.() || new Date(0);
          const fechaB = b.ultimoMensaje?.fecha?.toDate?.() || new Date(0);
          return fechaB - fechaA;
        });

        if (conversaciones.length === 0) {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">💬</div>Sin conversaciones</div>';
          return;
        }

        container.innerHTML = conversaciones.map(c => {
          const tieneNoLeidos = c.noLeidosPor?.includes(currentUser.uid);
          let avatar = '👤';
          if (c.tipo === 'nido') avatar = '🪺';
          else if (c.tipo === 'grupo') avatar = '👥';
          
          const nombre = c.nombre || 'Chat';
          const tiempo = formatearTiempo(c.ultimoMensaje?.fecha);
          const preview = c.ultimoMensaje?.texto || 'Sin mensajes';
          
          return `
            <div class="mensaje-item ${tieneNoLeidos ? 'no-leido' : ''}" onclick="abrirChat('${c.id}')">
              <div class="mensaje-avatar">${avatar}</div>
              <div class="mensaje-content">
                <div class="mensaje-from">${nombre}</div>
                <div class="mensaje-preview">${preview.substring(0, 35)}...</div>
              </div>
              <span class="mensaje-time">${tiempo}</span>
              ${tieneNoLeidos ? '<div class="mensaje-badge"></div>' : ''}
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error cargando conversaciones:', error);
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">💬</div>Sin conversaciones</div>';
      }
    }

    function abrirChat(convId) {
      window.location.href = `chat.html?conv=${convId}`;
    }

    function formatearTiempo(timestamp) {
      if (!timestamp) return '';
      const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const hoy = new Date();
      
      if (fecha.toDateString() === hoy.toDateString()) {
        return fecha.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
      }
      
      const ayer = new Date(hoy);
      ayer.setDate(ayer.getDate() - 1);
      if (fecha.toDateString() === ayer.toDateString()) {
        return 'Ayer';
      }
      
      return fecha.toLocaleDateString('es', { day: 'numeric', month: 'short' });
    }

    // ============ TABLÓN (REAL) ============
    let anunciosData = [];
    let notificacionesData = [];

    async function renderTablon() {
      const container = document.getElementById('tablon-list');
      
      if (!currentFamilia) {
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">📢</div>Sin novedades</div>';
        return;
      }

      try {
        // 1. Cargar notificaciones de herramientas (para este usuario)
        const ahora = new Date();
        const notifSnap = await db.collection('notificaciones')
          .where('familiaId', '==', currentFamilia.id)
          .where('destinatarios', 'array-contains', currentUser.uid)
          .where('estado', '==', 'activa')
          .orderBy('fechaCreacion', 'desc')
          .limit(5)
          .get();

        notificacionesData = notifSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(n => {
            // Filtrar expiradas
            if (n.fechaExpiracion) {
              const expira = n.fechaExpiracion.toDate ? n.fechaExpiracion.toDate() : new Date(n.fechaExpiracion);
              if (expira < ahora) return false;
            }
            // Filtrar ya completadas por este usuario
            if (n.tipo === 'accion' && n.completadoPor?.includes(currentUser.uid)) return false;
            return true;
          });

        // 2. Cargar anuncios generales
        const anunciosSnap = await db.collection('anuncios')
          .where('familiaId', '==', currentFamilia.id)
          .where('activo', '==', true)
          .orderBy('fechaCreacion', 'desc')
          .limit(3)
          .get();

        anunciosData = anunciosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // 3. Renderizar
        let html = '';

        // Notificaciones de acción primero (más urgentes)
        const acciones = notificacionesData.filter(n => n.tipo === 'accion');
        const infos = notificacionesData.filter(n => n.tipo === 'info');

        if (acciones.length > 0) {
          html += '<div class="tablon-separator">⚡ Requiere tu acción</div>';
          html += acciones.map(n => renderNotificacion(n)).join('');
        }

        if (infos.length > 0) {
          html += '<div class="tablon-separator">ℹ️ Información</div>';
          html += infos.map(n => renderNotificacion(n)).join('');
        }

        if (anunciosData.length > 0) {
          if (acciones.length > 0 || infos.length > 0) {
            html += '<div class="tablon-separator">📢 Anuncios</div>';
          }
          html += anunciosData.map(a => {
            const tiempo = formatearTiempo(a.fechaCreacion);
            return `
              <div class="anuncio-item">
                <div class="anuncio-header">
                  <span class="anuncio-tipo ${a.tipo}">${a.tipo === 'convocatoria' ? '📣' : a.tipo === 'urgente' ? '🚨' : 'ℹ️'} ${a.tipo}</span>
                  <span class="anuncio-fecha">${tiempo}</span>
                </div>
                <div class="anuncio-titulo">${a.titulo}</div>
                <div class="anuncio-texto">${a.contenido?.substring(0, 60) || ''}${a.contenido?.length > 60 ? '...' : ''}</div>
              </div>
            `;
          }).join('');
        }

        if (html === '') {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">📢</div>Sin novedades</div>';
          return;
        }

        container.innerHTML = html;

      } catch (error) {
        console.error('Error cargando tablón:', error);
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">📢</div>Sin novedades</div>';
      }
    }

    function renderNotificacion(n) {
      const tiempo = formatearTiempo(n.fechaCreacion);
      const iconos = {
        mercadillo: '🏪',
        votacion: '🗳️',
        encuesta: '📊',
        'amigo-invisible': '🎁',
        'elegir-fecha': '📆',
        turnos: '🔄',
        porra: '🎯',
        convocatoria: '✋',
        general: '📌'
      };
      const icono = iconos[n.categoria] || '📌';
      const tipoClass = n.tipo === 'accion' ? 'accion' : 'info-notif';

      return `
        <div class="notif-item ${tipoClass}" onclick="abrirNotificacion('${n.id}', '${n.enlace || ''}')">
          <button class="notif-marcar" onclick="event.stopPropagation(); marcarNotificacion('${n.id}', '${n.tipo}')" title="${n.tipo === 'accion' ? 'Marcar como hecho' : 'Descartar'}">✓</button>
          <div class="notif-header">
            <span class="notif-badge ${tipoClass}">${n.tipo === 'accion' ? '⚡ Acción' : 'ℹ️ Info'}</span>
            <span class="notif-tiempo">${tiempo}</span>
          </div>
          <div class="notif-titulo">${n.titulo}</div>
          ${n.mensaje ? `<div class="notif-texto">${n.mensaje.substring(0, 80)}${n.mensaje.length > 80 ? '...' : ''}</div>` : ''}
          <div class="notif-origen">${icono} ${n.categoria || 'General'}</div>
        </div>
      `;
    }

    async function abrirNotificacion(notifId, enlace) {
      // Marcar como leída
      try {
        await db.collection('notificaciones').doc(notifId).update({
          leidoPor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
      } catch(e) {}

      // Navegar si hay enlace
      if (enlace) {
        window.location.href = enlace;
      }
    }

    async function marcarNotificacion(notifId, tipo) {
      try {
        if (tipo === 'accion') {
          // Marcar como completada
          await db.collection('notificaciones').doc(notifId).update({
            completadoPor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
          });
        } else {
          // Para info, marcar como leída (la ocultará)
          await db.collection('notificaciones').doc(notifId).update({
            leidoPor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
            // Si todos los destinatarios la han leído, marcar como completada
          });
        }
        
        // Refrescar tablón
        await renderTablon();
      } catch (error) {
        console.error('Error marcando notificación:', error);
      }
    }

    // Función auxiliar para crear notificaciones (usada por herramientas)
    async function crearNotificacion(datos) {
      /*
        datos = {
          tipo: 'accion' | 'info',
          categoria: 'mercadillo' | 'votacion' | etc,
          titulo: string,
          mensaje: string (opcional),
          destinatarios: [uid, uid...],
          enlace: string (opcional),
          origen: { tipo: string, id: string } (opcional)
        }
      */
      const ahora = new Date();
      const expiracion = new Date(ahora);
      
      if (datos.tipo === 'info') {
        expiracion.setDate(expiracion.getDate() + 7); // Info expira en 7 días
      } else {
        expiracion.setFullYear(expiracion.getFullYear() + 1); // Acción no expira (1 año)
      }

      const notif = {
        tipo: datos.tipo,
        categoria: datos.categoria,
        titulo: datos.titulo,
        mensaje: datos.mensaje || null,
        familiaId: currentFamilia?.id || userData?.familiaId,
        destinatarios: datos.destinatarios,
        leidoPor: [],
        completadoPor: [],
        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
        fechaExpiracion: expiracion,
        enlace: datos.enlace || null,
        origen: datos.origen || null,
        estado: 'activa',
        recordatorioEnviado: false
      };

      return await db.collection('notificaciones').add(notif);
    }

    // ============ MENÚS (REAL) ============
    let menusData = [];

    async function renderMenus() {
      const container = document.getElementById('menus-list');
      const dias = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
      
      if (!miNidoPrincipal || !currentFamilia) {
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">🍽️</div>Sin menús</div>';
        return;
      }

      try {
        // Obtener próximos 3 días
        const hoy = new Date();
        const fechas = [];
        for (let i = 0; i < 3; i++) {
          const d = new Date(hoy);
          d.setDate(d.getDate() + i);
          fechas.push(d.toISOString().split('T')[0]);
        }

        const snap = await db.collection('menus')
          .where('familiaId', '==', currentFamilia.id)
          .where('fecha', 'in', fechas)
          .get();

        const menusMap = {};
        snap.docs.forEach(doc => {
          const data = doc.data();
          menusMap[data.fecha] = { id: doc.id, ...data };
        });

        container.innerHTML = fechas.map((fecha, i) => {
          const menu = menusMap[fecha];
          const d = new Date(fecha);
          const esHoy = i === 0;
          const diaLabel = esHoy ? 'HOY' : dias[d.getDay()];
          
          return `
            <div class="menu-dia">
              <div class="menu-dia-label ${esHoy ? 'hoy' : ''}">${diaLabel}</div>
              <div class="menu-comidas">
                <div class="menu-comida"><span class="menu-comida-tipo">🍽️</span> ${menu?.comida || '-'}</div>
                <div class="menu-comida"><span class="menu-comida-tipo">🌙</span> ${menu?.cena || '-'}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error cargando menús:', error);
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">🍽️</div>Sin menús</div>';
      }
    }

    // ============ ACCIONES - MODALES ============
    async function nuevaTarea() {
      const titulo = prompt('📋 Nueva tarea:\n\n¿Qué hay que hacer?');
      if (!titulo) return;

      const prioridad = prompt('Prioridad (alta/media/baja):', 'media') || 'media';
      const asignado = prompt('¿A quién se asigna? (nombre o vacío):', '') || null;

      try {
        await db.collection('tareas').add({
          titulo,
          prioridad: ['alta', 'media', 'baja'].includes(prioridad) ? prioridad : 'media',
          asignadoA: asignado,
          asignadoPor: currentUser.uid,
          nidoId: miNidoPrincipal?.id || null,
          familiaId: currentFamilia.id,
          completada: false,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('✅ Tarea creada');
        renderTareas();
      } catch (error) {
        console.error('Error creando tarea:', error);
        alert('Error al crear tarea');
      }
    }

    async function nuevoMensaje() {
      // Obtener miembros de la estirpe para seleccionar destinatario
      const miembros = [];
      allNidos.forEach(n => {
        (n.miembrosData || []).forEach(m => {
          if (m.email && m.email !== currentUser.email) {
            miembros.push(m);
          }
        });
      });

      if (miembros.length === 0) {
        alert('No hay miembros con email a quienes enviar mensaje');
        return;
      }

      const listaDestinatarios = miembros.map((m, i) => `${i + 1}. ${m.nombre || m.iniciales}`).join('\n');
      const seleccion = prompt(`📬 Nuevo mensaje\n\nSelecciona destinatario (número):\n${listaDestinatarios}`);
      
      if (!seleccion) return;
      const idx = parseInt(seleccion) - 1;
      if (idx < 0 || idx >= miembros.length) {
        alert('Selección inválida');
        return;
      }

      const destinatario = miembros[idx];
      const contenido = prompt(`Mensaje para ${destinatario.nombre || destinatario.iniciales}:`);
      if (!contenido) return;

      try {
        await db.collection('mensajes').add({
          de: currentUser.uid,
          deNombre: userData.nombre || currentUser.email.split('@')[0],
          para: destinatario.email, // Usamos email como ID temporal
          paraNombre: destinatario.nombre || destinatario.iniciales,
          contenido,
          familiaId: currentFamilia.id,
          leido: false,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('✅ Mensaje enviado');
      } catch (error) {
        console.error('Error enviando mensaje:', error);
        alert('Error al enviar mensaje');
      }
    }

    async function nuevoAnuncio() {
      const titulo = prompt('📢 Nuevo anuncio\n\nTítulo:');
      if (!titulo) return;

      const contenido = prompt('Contenido del anuncio:');
      if (!contenido) return;

      const tipoSeleccion = prompt('Tipo (1=Info, 2=Convocatoria, 3=Urgente):', '1');
      const tipos = { '1': 'info', '2': 'convocatoria', '3': 'urgente' };
      const tipo = tipos[tipoSeleccion] || 'info';

      try {
        await db.collection('anuncios').add({
          titulo,
          contenido,
          tipo,
          familiaId: currentFamilia.id,
          nidoId: null, // Visible para toda la estirpe
          autor: currentUser.uid,
          autorNombre: userData.nombre || currentUser.email.split('@')[0],
          activo: true,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('✅ Anuncio publicado');
        renderTablon();
      } catch (error) {
        console.error('Error publicando anuncio:', error);
        alert('Error al publicar anuncio');
      }
    }

    // ============ MOBILE NAV ============
    function toggleMobileNav() {
      const hamburger = document.getElementById('hamburger');
      const nav = document.getElementById('mobile-nav');
      hamburger.classList.toggle('active');
      nav.classList.toggle('active');
    }

    // ============ CHAT PANEL ============
    let conversacionesRecientes = [];

    function toggleChatPanel() {
      const panel = document.getElementById('chat-panel');
      const overlay = document.getElementById('chat-overlay');
      panel.classList.toggle('active');
      overlay.classList.toggle('active');

      if (panel.classList.contains('active') && currentFamilia) {
        cargarConversacionesRecientes();
      }
    }

    async function cargarConversacionesRecientes() {
      const container = document.getElementById('chat-panel-body');

      try {
        const snap = await db.collection('conversaciones')
          .where('participantes', 'array-contains', currentUser.uid)
          .limit(10)
          .get();

        conversacionesRecientes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Ordenar por último mensaje
        conversacionesRecientes.sort((a, b) => {
          const fechaA = a.ultimoMensaje?.fecha?.toDate?.() || new Date(0);
          const fechaB = b.ultimoMensaje?.fecha?.toDate?.() || new Date(0);
          return fechaB - fechaA;
        });

        renderConversacionesPanel();
        actualizarBadgeChat();

      } catch (error) {
        console.error('Error cargando conversaciones:', error);
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--text-muted);">
            <div>Error al cargar</div>
          </div>
        `;
      }
    }

    function renderConversacionesPanel() {
      const container = document.getElementById('chat-panel-body');

      if (conversacionesRecientes.length === 0) {
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--text-muted);">
            <div style="font-size: 2rem; margin-bottom: 8px;">💬</div>
            <div>No hay conversaciones</div>
            <a href="chat.html" style="display: inline-block; margin-top: 12px; color: var(--sage);">Iniciar un chat →</a>
          </div>
        `;
        return;
      }

      container.innerHTML = conversacionesRecientes.map(conv => {
        const tieneNoLeidos = conv.noLeidosPor?.includes(currentUser.uid);
        let avatar = '👤';
        let avatarClass = '';
        if (conv.tipo === 'nido') {
          avatar = '🪺';
          avatarClass = 'grupo';
        } else if (conv.tipo === 'grupo') {
          avatar = '👥';
          avatarClass = 'grupo';
        }

        const nombre = conv.nombre || 'Chat';
        const tiempo = formatearTiempoChat(conv.ultimoMensaje?.fecha);
        const preview = conv.ultimoMensaje?.texto || 'Sin mensajes';

        return `
          <div class="chat-panel-conv ${tieneNoLeidos ? 'unread' : ''}" onclick="abrirChatDesdePanel('${conv.id}')">
            <div class="chat-panel-avatar ${avatarClass}">${avatar}</div>
            <div class="chat-panel-info">
              <div class="chat-panel-name">${nombre}</div>
              <div class="chat-panel-preview">${preview.substring(0, 40)}${preview.length > 40 ? '...' : ''}</div>
            </div>
            <div class="chat-panel-time">${tiempo}</div>
          </div>
        `;
      }).join('');
    }

    function formatearTiempoChat(timestamp) {
      if (!timestamp) return '';
      const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const hoy = new Date();

      if (fecha.toDateString() === hoy.toDateString()) {
        return fecha.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
      }

      const ayer = new Date(hoy);
      ayer.setDate(ayer.getDate() - 1);
      if (fecha.toDateString() === ayer.toDateString()) {
        return 'Ayer';
      }

      return fecha.toLocaleDateString('es', { day: 'numeric', month: 'short' });
    }

    function abrirChatDesdePanel(convId) {
      window.location.href = `chat.html?conv=${convId}`;
    }

    function actualizarBadgeChat() {
      const badge = document.getElementById('chat-badge');
      const noLeidos = conversacionesRecientes.filter(c => c.noLeidosPor?.includes(currentUser.uid)).length;

      if (noLeidos > 0) {
        badge.textContent = noLeidos;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    // Cargar badge de chat al inicio
    async function cargarBadgeChat() {
      if (!currentUser) return;

      try {
        const snap = await db.collection('conversaciones')
          .where('participantes', 'array-contains', currentUser.uid)
          .where('noLeidosPor', 'array-contains', currentUser.uid)
          .get();

        const badge = document.getElementById('chat-badge');
        if (snap.size > 0) {
          badge.textContent = snap.size;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      } catch (error) {
        // Fallback si no hay índice
        console.warn('No se pudo cargar badge de chat');
      }
    }

    // ============ TIENDA ============
    let tiendaBienActual = null;
    let tiendaInventario = [];
    let tiendaEspeciales = [];
    let tiendaPedidos = [];
    let tiendaCarrito = [];
    let bienesConTienda = [];

    // Verificar si hay bienes con Mayordomo/Gerente activo
    async function verificarTiendaDisponible() {
      if (!currentFamilia) return;
      
      try {
        const snap = await db.collection('bienes')
          .where('familiaId', '==', currentFamilia.id)
          .get();
        
        bienesConTienda = snap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(b => b.mayordomoActivo || b.gerenteActivo);
        
        const cartBtn = document.getElementById('cart-btn');
        if (bienesConTienda.length > 0) {
          cartBtn.classList.remove('hidden');
          popularSelectBienesTienda();
        } else {
          cartBtn.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error verificando tienda:', error);
      }
    }

    function popularSelectBienesTienda() {
      const select = document.getElementById('tienda-bien-select');
      if (!select) return;
      
      select.innerHTML = '<option value="">Selecciona un bien...</option>' +
        bienesConTienda.map(b => `<option value="${b.id}">${b.nombre}</option>`).join('');
    }

    function toggleTienda() {
      const panel = document.getElementById('tienda-panel');
      const overlay = document.getElementById('tienda-overlay');
      panel.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    async function cambiarBienTienda() {
      const bienId = document.getElementById('tienda-bien-select').value;
      if (!bienId) {
        tiendaBienActual = null;
        tiendaInventario = [];
        tiendaEspeciales = [];
        tiendaPedidos = [];
        renderProductosBasicos();
        renderProductosEspeciales();
        renderPedidos();
        return;
      }

      tiendaBienActual = bienesConTienda.find(b => b.id === bienId);
      await cargarInventarioTienda(bienId);
      await cargarEspecialesTienda(bienId);
      await cargarPedidosTienda(bienId);
    }

    async function cargarInventarioTienda(bienId) {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('inventario-config').get();
        
        tiendaInventario = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderProductosBasicos();
      } catch (error) {
        console.error('Error cargando inventario:', error);
        tiendaInventario = [];
        renderProductosBasicos();
      }
    }

    async function cargarEspecialesTienda(bienId) {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('productos-especiales').orderBy('nombre').get();
        
        tiendaEspeciales = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderProductosEspeciales();
      } catch (error) {
        console.error('Error cargando especiales:', error);
        tiendaEspeciales = [];
        renderProductosEspeciales();
      }
    }

    async function cargarPedidosTienda(bienId) {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('pedidos').orderBy('fechaCreacion', 'desc').limit(20).get();
        
        tiendaPedidos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderPedidos();
        actualizarContadorPedidos();
      } catch (error) {
        console.error('Error cargando pedidos:', error);
        tiendaPedidos = [];
        renderPedidos();
      }
    }

    const catIconsTienda = {
      limpieza: '🧹', bano: '🚿', cocina: '🍳', alimentos: '🥫', bebidas: '🍷', otro: '📦'
    };

    function renderProductosBasicos() {
      const container = document.getElementById('productos-basicos');
      
      if (!tiendaBienActual || tiendaInventario.length === 0) {
        container.innerHTML = '<div class="tienda-empty">Selecciona un bien para ver su inventario</div>';
        return;
      }

      // Agrupar por categoría
      const porCategoria = {};
      tiendaInventario.forEach(item => {
        const cat = item.categoria || 'otro';
        if (!porCategoria[cat]) porCategoria[cat] = [];
        porCategoria[cat].push(item);
      });

      let html = '';
      Object.entries(porCategoria).forEach(([cat, items]) => {
        html += `
          <div class="tienda-categoria-grupo">
            <div class="tienda-categoria-titulo">${catIconsTienda[cat] || '📦'} ${cat}</div>
            ${items.map(item => renderProductoItem(item, 'basico')).join('')}
          </div>
        `;
      });

      container.innerHTML = html || '<div class="tienda-empty">Sin productos en inventario</div>';
    }

    function renderProductoItem(item, tipo) {
      const enCarrito = tiendaCarrito.find(c => c.itemId === item.id && c.tipo === tipo);
      const cantidad = enCarrito ? enCarrito.cantidad : 0;

      return `
        <div class="tienda-producto ${cantidad > 0 ? 'en-carrito' : ''}" data-id="${item.id}" data-tipo="${tipo}">
          <div class="tienda-producto-icon">${catIconsTienda[item.categoria] || '📦'}</div>
          <div class="tienda-producto-info">
            <div class="tienda-producto-nombre">${item.nombre || item.articulo}</div>
            <div class="tienda-producto-formato">${item.formato || item.unidad || ''}</div>
          </div>
          <div class="tienda-producto-cantidad">
            <button class="tienda-cantidad-btn" onclick="modificarCarrito('${item.id}', '${tipo}', -1)">−</button>
            <span class="tienda-cantidad-num">${cantidad}</span>
            <button class="tienda-cantidad-btn" onclick="modificarCarrito('${item.id}', '${tipo}', 1)">+</button>
          </div>
        </div>
      `;
    }

    function renderProductosEspeciales() {
      const container = document.getElementById('productos-especiales');
      
      if (!tiendaBienActual) {
        container.innerHTML = '<div class="tienda-empty">Selecciona un bien</div>';
        return;
      }

      if (tiendaEspeciales.length === 0) {
        container.innerHTML = '<div class="tienda-empty">Sin artículos especiales. ¡Añade uno arriba!</div>';
        return;
      }

      container.innerHTML = tiendaEspeciales.map(item => `
        <div class="tienda-producto ${tiendaCarrito.find(c => c.itemId === item.id) ? 'en-carrito' : ''}" data-id="${item.id}" data-tipo="especial">
          <div class="tienda-producto-icon">⭐</div>
          <div class="tienda-producto-info">
            <div class="tienda-producto-nombre">${item.articulo}</div>
            <div class="tienda-producto-formato">${item.formato || ''} ${item.unidades ? `(${item.unidades} uds)` : ''}</div>
          </div>
          <div class="tienda-producto-cantidad">
            <button class="tienda-cantidad-btn" onclick="modificarCarrito('${item.id}', 'especial', -1)">−</button>
            <span class="tienda-cantidad-num">${tiendaCarrito.find(c => c.itemId === item.id)?.cantidad || 0}</span>
            <button class="tienda-cantidad-btn" onclick="modificarCarrito('${item.id}', 'especial', 1)">+</button>
          </div>
        </div>
      `).join('');
    }

    function modificarCarrito(itemId, tipo, delta) {
      let item = tiendaCarrito.find(c => c.itemId === itemId && c.tipo === tipo);
      
      if (!item && delta > 0) {
        // Buscar datos del producto
        let producto;
        if (tipo === 'basico') {
          producto = tiendaInventario.find(p => p.id === itemId);
        } else {
          producto = tiendaEspeciales.find(p => p.id === itemId);
        }
        
        if (producto) {
          tiendaCarrito.push({
            itemId,
            tipo,
            nombre: producto.nombre || producto.articulo,
            formato: producto.formato || producto.unidad || '',
            cantidad: 1
          });
        }
      } else if (item) {
        item.cantidad += delta;
        if (item.cantidad <= 0) {
          tiendaCarrito = tiendaCarrito.filter(c => !(c.itemId === itemId && c.tipo === tipo));
        }
      }

      actualizarContadorCarrito();
      renderProductosBasicos();
      renderProductosEspeciales();
    }

    function actualizarContadorCarrito() {
      const count = tiendaCarrito.reduce((sum, item) => sum + item.cantidad, 0);
      document.getElementById('carrito-count').textContent = count;
      
      const badge = document.getElementById('cart-badge');
      badge.textContent = count;
      badge.classList.toggle('hidden', count === 0);
    }

    async function añadirEspecial() {
      if (!tiendaBienActual) {
        alert('Selecciona primero un bien');
        return;
      }

      const articulo = document.getElementById('especial-articulo').value.trim();
      const formato = document.getElementById('especial-formato').value.trim();
      const unidades = parseInt(document.getElementById('especial-unidades').value) || 1;

      if (!articulo) {
        alert('Escribe el nombre del artículo');
        return;
      }

      try {
        await db.collection('bienes').doc(tiendaBienActual.id)
          .collection('productos-especiales').add({
            articulo,
            formato,
            unidades,
            creadoPor: currentUser.uid,
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
          });

        document.getElementById('especial-articulo').value = '';
        document.getElementById('especial-formato').value = '';
        document.getElementById('especial-unidades').value = '1';

        await cargarEspecialesTienda(tiendaBienActual.id);
      } catch (error) {
        console.error('Error añadiendo especial:', error);
        alert('Error al añadir artículo');
      }
    }

    function cambiarTabTienda(tab) {
      document.querySelectorAll('.tienda-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tienda-tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.tienda-tab[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    let filtroEstadoActual = 'todos';

    function filtrarPedidos(estado) {
      filtroEstadoActual = estado;
      document.querySelectorAll('.pedido-filtro').forEach(f => f.classList.remove('active'));
      document.querySelector(`.pedido-filtro[data-estado="${estado}"]`).classList.add('active');
      renderPedidos();
    }

    function renderPedidos() {
      const container = document.getElementById('pedidos-lista');
      
      if (!tiendaBienActual) {
        container.innerHTML = '<div class="tienda-empty">Selecciona un bien</div>';
        return;
      }

      let pedidosFiltrados = tiendaPedidos;
      if (filtroEstadoActual !== 'todos') {
        pedidosFiltrados = tiendaPedidos.filter(p => p.estado === filtroEstadoActual);
      }

      if (pedidosFiltrados.length === 0) {
        container.innerHTML = '<div class="tienda-empty">Sin pedidos</div>';
        return;
      }

      container.innerHTML = pedidosFiltrados.map(pedido => {
        const fecha = pedido.fechaCreacion?.toDate?.() || new Date(pedido.fechaCreacion);
        const fechaStr = fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        
        return `
          <div class="pedido-card ${pedido.estado}">
            <div class="pedido-header">
              <span class="pedido-fecha">${fechaStr}</span>
              <span class="pedido-estado ${pedido.estado}">${getEstadoLabel(pedido.estado)}</span>
            </div>
            <div class="pedido-items">
              <span class="pedido-items-count">${pedido.items?.length || 0} artículos</span>
              ${pedido.items?.slice(0, 3).map(i => i.nombre).join(', ') || ''}
              ${pedido.items?.length > 3 ? '...' : ''}
            </div>
            <div class="pedido-actions">
              ${pedido.estado === 'pendiente' ? `<button onclick="cambiarEstadoPedido('${pedido.id}', 'en-curso')">🔵 En curso</button>` : ''}
              ${pedido.estado === 'en-curso' ? `<button onclick="cambiarEstadoPedido('${pedido.id}', 'realizado')">🟢 Completar</button>` : ''}
              <button onclick="verDetallePedido('${pedido.id}')">👁️ Ver</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function getEstadoLabel(estado) {
      const labels = {
        'pendiente': '🟡 Pendiente',
        'en-curso': '🔵 En curso',
        'realizado': '🟢 Realizado'
      };
      return labels[estado] || estado;
    }

    async function cambiarEstadoPedido(pedidoId, nuevoEstado) {
      if (!tiendaBienActual) return;

      try {
        await db.collection('bienes').doc(tiendaBienActual.id)
          .collection('pedidos').doc(pedidoId).update({
            estado: nuevoEstado,
            fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
          });

        await cargarPedidosTienda(tiendaBienActual.id);
      } catch (error) {
        console.error('Error actualizando pedido:', error);
      }
    }

    function verDetallePedido(pedidoId) {
      const pedido = tiendaPedidos.find(p => p.id === pedidoId);
      if (!pedido) return;

      const items = pedido.items?.map(i => `• ${i.nombre} x${i.cantidad}`).join('\n') || 'Sin items';
      alert(`📋 Pedido\n\n${items}\n\nEstado: ${getEstadoLabel(pedido.estado)}`);
    }

    function actualizarContadorPedidos() {
      const pendientes = tiendaPedidos.filter(p => p.estado === 'pendiente' || p.estado === 'en-curso').length;
      document.getElementById('pedidos-count').textContent = pendientes;
    }

    async function crearPedido() {
      if (!tiendaBienActual) {
        alert('Selecciona un bien primero');
        return;
      }

      if (tiendaCarrito.length === 0) {
        alert('El carrito está vacío');
        return;
      }

      try {
        await db.collection('bienes').doc(tiendaBienActual.id)
          .collection('pedidos').add({
            items: tiendaCarrito.map(item => ({
              nombre: item.nombre,
              formato: item.formato,
              cantidad: item.cantidad,
              tipo: item.tipo
            })),
            estado: 'pendiente',
            creadoPor: currentUser.uid,
            creadoPorNombre: userData?.nombre || userData?.email,
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
          });

        tiendaCarrito = [];
        actualizarContadorCarrito();
        renderProductosBasicos();
        renderProductosEspeciales();
        
        await cargarPedidosTienda(tiendaBienActual.id);
        cambiarTabTienda('pedidos');
        
        alert('✅ Pedido creado correctamente');
      } catch (error) {
        console.error('Error creando pedido:', error);
        alert('Error al crear pedido');
      }
    }

    // ============ CTAs (ACCIONES RÁPIDAS) ============
    let bienesUsuario = [];
    let bienesConGestion = []; // Solo bienes con add-on activo para reservas
    let adminsEstirpe = [];

    // Cargar bienes filtrados por visibilidad del usuario
    async function cargarBienesUsuario() {
      if (bienesUsuario.length > 0) return;
      try {
        const snap = await db.collection('bienes').where('familiaId', '==', currentFamilia.id).get();
        const todosBienes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Cargar mapa de nidos para verificar visibilidad
        const nidosSnap = await db.collection('nidos').where('familiaId', '==', currentFamilia.id).get();
        const nidosMap = {};
        nidosSnap.docs.forEach(doc => {
          nidosMap[doc.id] = { id: doc.id, ...doc.data() };
        });
        
        // Filtrar bienes por visibilidad
        bienesUsuario = todosBienes.filter(bien => {
          return esVisibleParaUsuario(bien, nidosMap);
        });
      } catch (e) { console.error('Error cargando bienes:', e); }
    }

    // Cargar bienes que tienen add-on de gestión activo (Mayordomo, Gerente o Capataz)
    async function cargarBienesConGestion() {
      await cargarBienesUsuario(); // Primero cargar bienes visibles
      
      // Filtrar solo los que tienen gestión activa
      bienesConGestion = bienesUsuario.filter(bien => {
        return bien.mayordomoActivo || bien.gerenteActivo || bien.capatazActivo;
      });
      
      return bienesConGestion;
    }

    // Popular select con bienes que tienen gestión (para reservas)
    function popularSelectBienesConGestion(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      
      if (bienesConGestion.length === 0) {
        select.innerHTML = '<option value="">No hay bienes con gestión activa</option>';
        return;
      }
      
      select.innerHTML = '<option value="">Selecciona un bien...</option>' +
        bienesConGestion.map(b => {
          const gestion = b.mayordomoActivo ? '🎩' : b.gerenteActivo ? '💼' : '🚜';
          return `<option value="${b.id}">${gestion} ${b.nombre}</option>`;
        }).join('');
    }

    async function cargarBienesUsuario() {
      if (bienesUsuario.length > 0) return;
      try {
        const snap = await db.collection('bienes').where('familiaId', '==', currentFamilia.id).get();
        bienesUsuario = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.error('Error cargando bienes:', e); }
    }

    async function cargarAdminsEstirpe() {
      if (adminsEstirpe.length > 0) return adminsEstirpe;
      try {
        // Cargar admins de la familia (AdminRama y AdminNido)
        const usuariosSnap = await db.collection('usuarios')
          .where('familiaId', '==', currentFamilia.id)
          .get();
        
        adminsEstirpe = usuariosSnap.docs
          .map(d => ({ uid: d.id, ...d.data() }))
          .filter(u => u.rol === 'AdminRama' || u.rol === 'AdminNido' || u.esAdmin);
        
        return adminsEstirpe;
      } catch (e) { 
        console.error('Error cargando admins:', e);
        return [];
      }
    }

    async function enviarNotificacionAdmins(tipo, datos) {
      const admins = await cargarAdminsEstirpe();
      const remitente = userData.nombre || userData.email;
      
      const solicitud = {
        tipo, // 'iniciativa', 'evento', 'reserva'
        ...datos,
        estado: 'pendiente', // pendiente (amarillo) -> respondido (verde)
        solicitadoPor: currentUser.uid,
        solicitadoPorNombre: remitente,
        solicitadoPorNido: miNidoPrincipal?.nombre || '',
        familiaId: currentFamilia.id,
        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
        respuesta: null,
        respondidoPor: null,
        fechaRespuesta: null
      };

      // Guardar solicitud en colección central
      const solicitudRef = await db.collection('solicitudes').add(solicitud);

      // Crear notificación para cada admin
      for (const admin of admins) {
        if (admin.uid === currentUser.uid) continue; // No notificar al propio usuario
        
        await db.collection('usuarios').doc(admin.uid).collection('notificaciones').add({
          tipo: 'solicitud',
          subtipo: tipo,
          solicitudId: solicitudRef.id,
          titulo: getTituloNotificacion(tipo, datos),
          mensaje: `${remitente} ha enviado una solicitud`,
          leido: false,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      return solicitudRef.id;
    }

    function getTituloNotificacion(tipo, datos) {
      switch(tipo) {
        case 'iniciativa': return `💡 Nueva propuesta: ${datos.titulo}`;
        case 'evento': return `🎉 Solicitud de evento: ${datos.nombre}`;
        case 'reserva': return `📅 Solicitud de reserva`;
        default: return 'Nueva solicitud';
      }
    }

    function popularSelectBienes(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = '<option value="">Selecciona un bien...</option>' +
        bienesUsuario.map(b => `<option value="${b.id}">${b.nombre}</option>`).join('');
    }

    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    }

    function seleccionarVisibilidad(elemento, formulario) {
      // Quitar active de todas las opciones del mismo formulario
      const contenedor = elemento.closest('.visibilidad-selector');
      contenedor.querySelectorAll('.visibilidad-option').forEach(opt => opt.classList.remove('active'));
      // Activar la seleccionada
      elemento.classList.add('active');
      elemento.querySelector('input').checked = true;
    }

    function obtenerVisibilidad(formulario) {
      const radio = document.querySelector(`input[name="${formulario}-visibilidad"]:checked`);
      return radio ? radio.value : 'rama';
    }

    // Resetear selector de visibilidad a 'rama' en un modal
    function resetVisibilidad(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      modal.querySelectorAll('.visibilidad-option').forEach(opt => {
        opt.classList.remove('active');
        const input = opt.querySelector('input');
        if (input && input.value === 'rama') {
          opt.classList.add('active');
          input.checked = true;
        }
      });
    }

    async function abrirModalAveria() {
      await cargarBienesUsuario();
      popularSelectBienes('averia-bien');
      document.getElementById('form-averia').reset();
      resetVisibilidad('modal-averia');
      document.getElementById('modal-averia').classList.add('active');
    }

    async function abrirModalIniciativa() {
      document.getElementById('form-iniciativa').reset();
      resetVisibilidad('modal-iniciativa');
      document.getElementById('modal-iniciativa').classList.add('active');
    }

    async function abrirModalSolicitarEvento() {
      await cargarBienesUsuario();
      popularSelectBienes('evento-bien');
      document.getElementById('form-evento').reset();
      resetVisibilidad('modal-evento');
      document.getElementById('evento-fecha').min = new Date().toISOString().split('T')[0];
      document.getElementById('modal-evento').classList.add('active');
    }

    async function abrirModalSolicitarReserva() {
      await cargarBienesConGestion();
      popularSelectBienesConGestion('reserva-bien');
      document.getElementById('form-reserva').reset();
      resetVisibilidad('modal-reserva');
      const hoy = new Date().toISOString().split('T')[0];
      document.getElementById('reserva-inicio').min = hoy;
      document.getElementById('reserva-fin').min = hoy;
      document.getElementById('modal-reserva').classList.add('active');
    }

    async function abrirModalEncargo() {
      await cargarBienesUsuario();
      popularSelectBienes('encargo-bien');
      document.getElementById('form-encargo').reset();
      resetVisibilidad('modal-encargo');
      document.getElementById('modal-encargo').classList.add('active');
    }

    function abrirModalConvocatoria() {
      document.getElementById('form-convocatoria').reset();
      resetVisibilidad('modal-convocatoria');
      document.getElementById('convocatoria-fecha').min = new Date().toISOString().split('T')[0];
      document.getElementById('modal-convocatoria').classList.add('active');
    }

    async function enviarConvocatoria(e) {
      e.preventDefault();
      
      const titulo = document.getElementById('convocatoria-titulo').value.trim();
      const fecha = document.getElementById('convocatoria-fecha').value;
      const hora = document.getElementById('convocatoria-hora').value || null;
      const lugar = document.getElementById('convocatoria-lugar').value.trim() || null;
      const notas = document.getElementById('convocatoria-notas').value.trim() || null;
      const visibilidad = obtenerVisibilidad('convocatoria');

      try {
        // 1. Determinar destinatarios según visibilidad
        let destinatarios = [];
        
        if (visibilidad === 'rama') {
          // Todos los usuarios de la familia
          const usuariosSnap = await db.collection('usuarios')
            .where('familiaId', '==', currentFamilia.id)
            .get();
          destinatarios = usuariosSnap.docs.map(doc => doc.id).filter(uid => uid !== currentUser.uid);
        } else if (visibilidad === 'estirpe') {
          // Usuarios de mi estirpe (mi nido y descendientes)
          const nidosSnap = await db.collection('nidos').where('familiaId', '==', currentFamilia.id).get();
          const nidosMap = {};
          nidosSnap.docs.forEach(doc => { nidosMap[doc.id] = { id: doc.id, ...doc.data() }; });
          
          // Encontrar nidos de mi estirpe
          const nidosEstirpe = new Set([miNidoPrincipal?.id]);
          Object.values(nidosMap).forEach(n => {
            if (n.nidoOrigen === miNidoPrincipal?.id) nidosEstirpe.add(n.id);
          });
          
          // Obtener usuarios de esos nidos
          const usuariosSnap = await db.collection('usuarios')
            .where('familiaId', '==', currentFamilia.id)
            .get();
          destinatarios = usuariosSnap.docs
            .filter(doc => nidosEstirpe.has(doc.data().nidoId) && doc.id !== currentUser.uid)
            .map(doc => doc.id);
        } else {
          // Solo miembros de mi nido
          if (miNidoPrincipal) {
            const miembros = miNidoPrincipal.miembrosData || [];
            for (const m of miembros) {
              if (m.email) {
                const userSnap = await db.collection('usuarios')
                  .where('email', '==', m.email.toLowerCase())
                  .get();
                if (!userSnap.empty && userSnap.docs[0].id !== currentUser.uid) {
                  destinatarios.push(userSnap.docs[0].id);
                }
              }
            }
          }
        }

        // 2. Crear la convocatoria
        const convocatoriaRef = await db.collection('convocatorias').add({
          titulo: titulo,
          fecha: fecha,
          hora: hora,
          lugar: lugar,
          notas: notas,
          visibilidad: visibilidad,
          familiaId: currentFamilia.id,
          nidoId: miNidoPrincipal?.id || null,
          creadoPor: currentUser.uid,
          creadoPorNombre: userData?.nombre || currentUser.email.split('@')[0],
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
          estado: 'activa',
          confirmados: [],
          rechazados: [],
          pendientes: destinatarios
        });

        // 3. Crear notificación de ACCIÓN para cada destinatario
        const miNombre = userData?.nombre || currentUser.email.split('@')[0];
        const fechaEvento = new Date(fecha + 'T23:59:59');

        if (destinatarios.length > 0) {
          await db.collection('notificaciones').add({
            tipo: 'accion',
            categoria: 'convocatoria',
            titulo: `✋ ${miNombre} te convoca: "${titulo}"`,
            mensaje: `${fecha}${hora ? ' a las ' + hora : ''}${lugar ? ' en ' + lugar : ''}`,
            familiaId: currentFamilia.id,
            nidoId: miNidoPrincipal?.id || null,
            visibilidad: visibilidad,
            destinatarios: destinatarios,
            leidoPor: [],
            completadoPor: [],
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            fechaExpiracion: fechaEvento, // Caduca pasada la fecha del evento
            enlace: `herramienta-asistencia.html?id=${convocatoriaRef.id}`,
            origen: { tipo: 'convocatoria', id: convocatoriaRef.id },
            estado: 'activa',
            recordatorioEnviado: false,
            fechaRecordatorio: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000)
          });
        }

        cerrarModales();
        alert(`✅ Convocatoria enviada a ${destinatarios.length} persona${destinatarios.length !== 1 ? 's' : ''}`);
        
        // Refrescar tablón
        await renderTablon();

      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar la convocatoria');
      }
    }

    // Enviar avería
    document.getElementById('form-averia').addEventListener('submit', async (e) => {
      e.preventDefault();
      const bienId = document.getElementById('averia-bien').value;
      const descripcion = document.getElementById('averia-descripcion').value;
      const urgencia = document.querySelector('input[name="averia-urgencia"]:checked').value;
      const visibilidad = obtenerVisibilidad('averia');

      try {
        await db.collection('bienes').doc(bienId).collection('reparaciones').add({
          descripcion,
          urgencia,
          estado: 'pendiente',
          reportadoPor: currentUser.uid,
          reportadoPorNombre: userData.nombre || userData.email,
          nidoId: miNidoPrincipal?.id || null,
          visibilidad,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        cerrarModales();
        alert('✅ Avería reportada correctamente');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar el aviso');
      }
    });

    // Enviar iniciativa (con notificación a admins)
    document.getElementById('form-iniciativa').addEventListener('submit', async (e) => {
      e.preventDefault();
      const titulo = document.getElementById('iniciativa-titulo').value;
      const descripcion = document.getElementById('iniciativa-descripcion').value;
      const categoria = document.getElementById('iniciativa-categoria').value;
      const visibilidad = obtenerVisibilidad('iniciativa');

      try {
        // Guardar iniciativa y notificar admins
        await enviarNotificacionAdmins('iniciativa', {
          titulo,
          descripcion,
          categoria,
          visibilidad,
          nidoId: miNidoPrincipal?.id || null
        });

        // También guardar en colección de iniciativas para votos
        await db.collection('familias').doc(currentFamilia.id).collection('iniciativas').add({
          titulo,
          descripcion,
          categoria,
          estado: 'pendiente',
          votos: [],
          propuestoPor: currentUser.uid,
          propuestoPorNombre: userData.nombre || userData.email,
          nidoId: miNidoPrincipal?.id || null,
          visibilidad,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        cerrarModales();
        alert('✅ Propuesta enviada a los administradores');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar la propuesta');
      }
    });

    // Enviar solicitud de evento
    document.getElementById('form-evento').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nombre = document.getElementById('evento-nombre').value;
      const bienId = document.getElementById('evento-bien').value;
      const bien = bienesUsuario.find(b => b.id === bienId);
      const fecha = document.getElementById('evento-fecha').value;
      const descripcion = document.getElementById('evento-descripcion').value;
      const visibilidad = obtenerVisibilidad('evento');

      try {
        await enviarNotificacionAdmins('evento', {
          nombre,
          bienId,
          bienNombre: bien?.nombre || '',
          fecha,
          descripcion,
          visibilidad,
          nidoId: miNidoPrincipal?.id || null
        });

        cerrarModales();
        alert('✅ Solicitud de evento enviada a los administradores');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar la solicitud');
      }
    });

    // Enviar solicitud de reserva
    document.getElementById('form-reserva').addEventListener('submit', async (e) => {
      e.preventDefault();
      const bienId = document.getElementById('reserva-bien').value;
      const bien = bienesConGestion.find(b => b.id === bienId) || bienesUsuario.find(b => b.id === bienId);
      const fechaInicio = document.getElementById('reserva-inicio').value;
      const fechaFin = document.getElementById('reserva-fin').value;
      const motivo = document.getElementById('reserva-motivo').value;
      const visibilidad = obtenerVisibilidad('reserva');

      if (fechaFin < fechaInicio) {
        alert('La fecha de fin debe ser posterior a la de inicio');
        return;
      }

      try {
        await enviarNotificacionAdmins('reserva', {
          bienId,
          bienNombre: bien?.nombre || '',
          fechaInicio,
          fechaFin,
          motivo,
          visibilidad,
          nidoId: miNidoPrincipal?.id || null
        });

        cerrarModales();
        alert('✅ Solicitud de reserva enviada a los administradores');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar la solicitud');
      }
    });

    // Enviar encargo
    document.getElementById('form-encargo').addEventListener('submit', async (e) => {
      e.preventDefault();
      const bienId = document.getElementById('encargo-bien').value;
      const items = document.getElementById('encargo-items').value;
      const notas = document.getElementById('encargo-notas').value;
      const visibilidad = obtenerVisibilidad('encargo');

      try {
        await db.collection('bienes').doc(bienId).collection('encargos').add({
          items,
          notas,
          estado: 'pendiente',
          solicitadoPor: currentUser.uid,
          solicitadoPorNombre: userData.nombre || userData.email,
          nidoId: miNidoPrincipal?.id || null,
          visibilidad,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        cerrarModales();
        alert('✅ Encargo registrado');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar el encargo');
      }
    });

    // Cerrar modales al hacer clic fuera
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) cerrarModales();
      });
    });

    // ============ LOGOUT ============
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await auth.signOut();
      window.location.href = 'login.html';
    });

    // ============ BUZÓN UNIFICADO (MÓVIL) ============
    function cambiarPestanaBuzon(pestaña) {
      // Actualizar pestañas
      document.querySelectorAll('.buzon-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.buzon-tab[onclick*="${pestaña}"]`)?.classList.add('active');
      
      // Actualizar contenido
      document.querySelectorAll('.buzon-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`buzon-${pestaña}`)?.classList.add('active');
    }

    async function renderBuzonUnificado() {
      // Renderizar mensajes en buzón móvil
      const chatContainer = document.getElementById('buzon-mensajes-list');
      const tablonContainer = document.getElementById('buzon-tablon-list');
      
      if (!chatContainer || !tablonContainer) return;
      
      // Copiar contenido de mensajes desktop
      const mensajesDesktop = document.getElementById('mensajes-list');
      if (mensajesDesktop) {
        chatContainer.innerHTML = mensajesDesktop.innerHTML;
      }
      
      // Copiar contenido de tablón desktop
      const tablonDesktop = document.getElementById('tablon-list');
      if (tablonDesktop) {
        tablonContainer.innerHTML = tablonDesktop.innerHTML;
      }
      
      // Actualizar badges
      const chatBadge = document.getElementById('badge-chat-count');
      const notifBadge = document.getElementById('badge-notif-count');
      
      // Contar mensajes no leídos
      const mensajesNoLeidos = chatContainer.querySelectorAll('.mensaje-item.no-leido').length;
      if (chatBadge) {
        chatBadge.textContent = mensajesNoLeidos;
        chatBadge.style.display = mensajesNoLeidos > 0 ? 'inline-block' : 'none';
      }
      
      // Contar notificaciones de acción
      const notifAccion = tablonContainer.querySelectorAll('.notif-item.accion').length;
      if (notifBadge) {
        notifBadge.textContent = notifAccion;
        notifBadge.style.display = notifAccion > 0 ? 'inline-block' : 'none';
      }
    }

    // ============ MIS BIENES (MÓVIL) ============
    async function renderMisBienes() {
      const container = document.getElementById('mis-bienes-list');
      if (!container) return;
      
      await cargarBienesUsuario();
      
      if (bienesUsuario.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--text-muted);">
            <div style="font-size: 2rem; margin-bottom: 8px;">🏠</div>
            <div>No tienes bienes asignados</div>
          </div>
        `;
        return;
      }
      
      // Mapeo de iconos para tipos de bienes
      const iconosTipo = {
        'vivienda': '🏠',
        'vehiculo': '🚗',
        'terreno': '🌳',
        'local': '🏪',
        'garaje': '🅿️',
        'trastero': '📦',
        'otro': '📋'
      };
      
      container.innerHTML = bienesUsuario.map(bien => {
        // Determinar el add-on activo y la URL de destino
        let addon = '';
        let addonClass = '';
        let addonLabel = '';
        let urlDestino = `lo-comun.html?bien=${bien.id}`; // Por defecto
        
        if (bien.mayordomoActivo) {
          addon = '🎩';
          addonClass = 'mayordomo';
          addonLabel = 'Mayordomo';
          urlDestino = `mayordomo.html?id=${bien.id}`;
        } else if (bien.gerenteActivo) {
          addon = '💼';
          addonClass = 'gerente';
          addonLabel = 'Gerente';
          urlDestino = `gerente.html?id=${bien.id}`;
        } else if (bien.capatazActivo) {
          addon = '🚜';
          addonClass = 'capataz';
          addonLabel = 'Capataz';
          urlDestino = `capataz.html?id=${bien.id}`;
        }
        
        const iconoBien = iconosTipo[bien.tipo] || '🏠';
        
        return `
          <a href="${urlDestino}" class="bien-card ${addonClass}">
            <div class="bien-icon">${iconoBien}</div>
            <div class="bien-info">
              <div class="bien-nombre">${bien.nombre || 'Sin nombre'}</div>
              ${addon ? `<div class="bien-addon">${addon} ${addonLabel}</div>` : '<div class="bien-addon">Sin gestión activa</div>'}
            </div>
            <span class="bien-arrow">›</span>
          </a>
        `;
      }).join('');
    }

    // ============ PRIMEROS PASOS ============
    function verificarPrimerosPasos() {
      const noMostrar = localStorage.getItem('familynk_no_mostrar_primeros_pasos');
      if (noMostrar !== 'true') {
        document.getElementById('modal-primeros-pasos').classList.add('active');
      }
    }

    // ============ MODAL COMUNICADO ============
    let comunicadoImagenes = [];
    const COMUNICADO_MAX_IMAGENES = 3;
    const COMUNICADO_MAX_SIZE_MB = 5;

    function configurarDestinatariosComunicado(isAdminRama) {
      // Admin Rama: puede enviar a todos
      // Admin Nido: solo puede enviar a Mi Nido y Mi Estirpe
      const opcionesTodas = document.querySelectorAll('.destinatario-option');
      
      opcionesTodas.forEach(opt => {
        const dest = opt.dataset.dest;
        if (!isAdminRama && (dest === 'toda-rama' || dest === 'admins')) {
          opt.classList.add('hidden');
        } else {
          opt.classList.remove('hidden');
        }
      });
    }

    function abrirModalComunicado() {
      document.getElementById('modal-comunicado').classList.add('active');
      validarFormularioComunicado();
    }

    function cerrarModalComunicado() {
      document.getElementById('modal-comunicado').classList.remove('active');
      // Resetear formulario
      document.getElementById('form-comunicado').reset();
      comunicadoImagenes = [];
      renderComunicadoPreviews();
      document.querySelectorAll('.destinatario-option').forEach(el => el.classList.remove('selected'));
      document.querySelector('.tipo-option.info').classList.add('selected');
      document.querySelector('.tipo-option.accion').classList.remove('selected');
      document.getElementById('comunicado-char-counter').textContent = '0 / 600 caracteres';
      document.getElementById('comunicado-char-counter').classList.remove('warning', 'limit');
      document.getElementById('comunicado-upload-area').style.display = 'block';
    }

    function toggleDestinatario(element) {
      const checkbox = element.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      element.classList.toggle('selected', checkbox.checked);
      validarFormularioComunicado();
    }

    function actualizarContadorComunicado() {
      const textarea = document.getElementById('comunicado-mensaje');
      const counter = document.getElementById('comunicado-char-counter');
      const length = textarea.value.length;
      
      counter.textContent = `${length} / 600 caracteres`;
      
      counter.classList.remove('warning', 'limit');
      if (length >= 600) {
        counter.classList.add('limit');
      } else if (length >= 500) {
        counter.classList.add('warning');
      }
      
      validarFormularioComunicado();
    }

    function selectTipoComunicado(element, tipo) {
      document.querySelectorAll('.tipo-option').forEach(opt => {
        opt.classList.remove('selected');
        opt.querySelector('input').checked = false;
      });
      element.classList.add('selected');
      element.querySelector('input').checked = true;
    }

    // Drag & drop para imágenes
    const comunicadoUploadArea = document.getElementById('comunicado-upload-area');
    if (comunicadoUploadArea) {
      comunicadoUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        comunicadoUploadArea.classList.add('dragover');
      });

      comunicadoUploadArea.addEventListener('dragleave', () => {
        comunicadoUploadArea.classList.remove('dragover');
      });

      comunicadoUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        comunicadoUploadArea.classList.remove('dragover');
        handleComunicadoFiles(e.dataTransfer.files);
      });
    }

    function handleComunicadoFiles(files) {
      const remaining = COMUNICADO_MAX_IMAGENES - comunicadoImagenes.length;
      const filesToProcess = Array.from(files).slice(0, remaining);
      
      filesToProcess.forEach(file => {
        // Validar tipo
        if (!file.type.match(/image\/(jpeg|png|webp)/)) {
          alert(`${file.name} no es un formato válido. Usa JPG, PNG o WebP.`);
          return;
        }
        
        // Validar tamaño
        if (file.size > COMUNICADO_MAX_SIZE_MB * 1024 * 1024) {
          alert(`${file.name} excede el límite de ${COMUNICADO_MAX_SIZE_MB}MB.`);
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          comunicadoImagenes.push({
            nombre: file.name,
            data: e.target.result
          });
          renderComunicadoPreviews();
        };
        reader.readAsDataURL(file);
      });
      
      // Limpiar input
      document.getElementById('comunicado-upload-input').value = '';
    }

    function renderComunicadoPreviews() {
      const grid = document.getElementById('comunicado-preview-grid');
      const uploadArea = document.getElementById('comunicado-upload-area');
      
      if (comunicadoImagenes.length === 0) {
        grid.innerHTML = '';
        uploadArea.style.display = 'block';
        return;
      }
      
      grid.innerHTML = comunicadoImagenes.map((img, idx) => `
        <div class="preview-item">
          <img src="${img.data}" alt="${img.nombre}">
          <button class="preview-remove" onclick="eliminarComunicadoImagen(${idx})" type="button">×</button>
        </div>
      `).join('');
      
      // Ocultar área de upload si ya hay 3
      uploadArea.style.display = comunicadoImagenes.length >= COMUNICADO_MAX_IMAGENES ? 'none' : 'block';
    }

    function eliminarComunicadoImagen(idx) {
      comunicadoImagenes.splice(idx, 1);
      renderComunicadoPreviews();
    }

    function validarFormularioComunicado() {
      const btnEnviar = document.getElementById('btn-enviar-comunicado');
      const destinatarios = document.querySelectorAll('input[name="destinatarios"]:checked');
      const asunto = document.getElementById('comunicado-asunto').value.trim();
      const mensaje = document.getElementById('comunicado-mensaje').value.trim();
      
      const valido = destinatarios.length > 0 && asunto.length > 0 && mensaje.length > 0;
      btnEnviar.disabled = !valido;
    }

    async function enviarComunicado() {
      const btnEnviar = document.getElementById('btn-enviar-comunicado');
      btnEnviar.disabled = true;
      btnEnviar.innerHTML = '<span>⏳</span> Enviando...';

      const destinatariosSeleccionados = Array.from(document.querySelectorAll('input[name="destinatarios"]:checked')).map(el => el.value);
      const asunto = document.getElementById('comunicado-asunto').value.trim();
      const mensaje = document.getElementById('comunicado-mensaje').value.trim();
      const tipoInput = document.querySelector('input[name="comunicado-tipo"]:checked');
      const tipo = tipoInput ? tipoInput.value : 'info';
      
      console.log('=== ENVIANDO QUEO ===');
      console.log('Destinatarios seleccionados:', destinatariosSeleccionados);
      console.log('Asunto:', asunto);
      console.log('Mensaje:', mensaje);
      console.log('Tipo:', tipo);
      
      if (destinatariosSeleccionados.length === 0) {
        alert('Selecciona al menos un destinatario');
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = '<span>📤</span> Enviar queo';
        return;
      }

      if (!asunto || !mensaje) {
        alert('Completa el asunto y el mensaje');
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = '<span>📤</span> Enviar queo';
        return;
      }
      
      try {
        // Resolver destinatarios a UIDs
        let destinatariosUIDs = await resolverDestinatarios(destinatariosSeleccionados);
        console.log('UIDs resueltos:', destinatariosUIDs);
        
        // Si no hay destinatarios, al menos incluir al remitente para que el queo se guarde
        if (destinatariosUIDs.length === 0) {
          console.warn('No se encontraron destinatarios, incluyendo al remitente');
          destinatariosUIDs = [currentUser.uid];
        }
        
        // Crear queo en Firestore
        const queoData = {
          asunto,
          mensaje,
          tipo,
          imagenes: comunicadoImagenes.map(img => img.data),
          destinatariosGrupos: destinatariosSeleccionados,
          destinatarios: destinatariosUIDs,
          remitente: currentUser.uid,
          remitenteNombre: userData?.nombre || userData?.email || currentUser.email,
          remitenteNido: miNidoPrincipal?.nombre || '',
          familiaId: currentFamilia?.id || userData?.familiaId,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
          leidoPor: [],
          completadoPor: [],
          estado: 'enviado'
        };
        
        console.log('Guardando queo:', queoData);
        const docRef = await db.collection('queos').add(queoData);
        console.log('✅ Queo guardado con ID:', docRef.id);
        
        // Crear notificación
        try {
          const notifData = {
            tipo: tipo,
            categoria: 'queo',
            titulo: asunto,
            mensaje: mensaje.substring(0, 100) + (mensaje.length > 100 ? '...' : ''),
            destinatarios: destinatariosUIDs,
            familiaId: currentFamilia?.id || userData?.familiaId,
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            leidoPor: [],
            completadoPor: [],
            enlace: null,
            origen: { tipo: 'queo', id: docRef.id },
            estado: 'activa'
          };
          
          await db.collection('notificaciones').add(notifData);
          console.log('✅ Notificación creada');
        } catch (notifError) {
          console.warn('Error creando notificación (no crítico):', notifError);
        }
        
        alert('✅ Queo enviado correctamente');
        cerrarModalComunicado();
        
        // Actualizar tablón si está visible
        if (typeof renderTablon === 'function') {
          renderTablon();
        }
        
      } catch (error) {
        console.error('❌ Error enviando queo:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        alert('Error al enviar el queo: ' + (error.message || 'Error desconocido'));
      }
      
      btnEnviar.disabled = false;
      btnEnviar.innerHTML = '<span>📤</span> Enviar queo';
    }

    async function resolverDestinatarios(grupos) {
      const uidsSet = new Set();
      
      console.log('Resolviendo destinatarios para grupos:', grupos);
      console.log('currentFamilia:', currentFamilia?.id);
      console.log('miNidoPrincipal:', miNidoPrincipal?.id, miNidoPrincipal?.nombre);
      
      try {
        for (const grupo of grupos) {
          console.log('Procesando grupo:', grupo);
          
          switch (grupo) {
            case 'toda-rama':
              // Todos los usuarios de la familia
              if (currentFamilia?.id) {
                const todosSnap = await db.collection('usuarios')
                  .where('familiaId', '==', currentFamilia.id)
                  .get();
                console.log('Usuarios en rama:', todosSnap.size);
                todosSnap.docs.forEach(doc => uidsSet.add(doc.id));
              }
              break;
              
            case 'admins':
              // Admins de rama y nidos
              if (currentFamilia?.id) {
                const adminsSnap = await db.collection('usuarios')
                  .where('familiaId', '==', currentFamilia.id)
                  .get();
                adminsSnap.docs.forEach(doc => {
                  const data = doc.data();
                  if (data.rol === 'adminRama' || data.rol === 'AdminNido' || data.rol === 'adminNido' || data.esAdmin) {
                    uidsSet.add(doc.id);
                  }
                });
                // También admins de la familia
                if (currentFamilia.adminsGenerales) {
                  currentFamilia.adminsGenerales.forEach(uid => uidsSet.add(uid));
                }
                if (currentFamilia.fundador) uidsSet.add(currentFamilia.fundador);
                if (currentFamilia.creador) uidsSet.add(currentFamilia.creador);
              }
              console.log('Admins encontrados:', uidsSet.size);
              break;
              
            case 'mi-nido':
              // Miembros de mi nido
              if (miNidoPrincipal) {
                // Intentar miembrosData
                if (miNidoPrincipal.miembrosData && Array.isArray(miNidoPrincipal.miembrosData)) {
                  miNidoPrincipal.miembrosData.forEach(m => {
                    if (m.uid) uidsSet.add(m.uid);
                  });
                }
                // Intentar miembros array
                if (miNidoPrincipal.miembros && Array.isArray(miNidoPrincipal.miembros)) {
                  miNidoPrincipal.miembros.forEach(uid => uidsSet.add(uid));
                }
                // Intentar admins del nido
                if (miNidoPrincipal.admins && Array.isArray(miNidoPrincipal.admins)) {
                  miNidoPrincipal.admins.forEach(uid => uidsSet.add(uid));
                }
              }
              console.log('Miembros nido encontrados:', uidsSet.size);
              break;
              
            case 'mi-estirpe':
              // Por ahora, igual que mi-nido + descendientes
              if (miNidoPrincipal) {
                // Miembros del nido actual
                if (miNidoPrincipal.miembrosData && Array.isArray(miNidoPrincipal.miembrosData)) {
                  miNidoPrincipal.miembrosData.forEach(m => {
                    if (m.uid) uidsSet.add(m.uid);
                  });
                }
                if (miNidoPrincipal.miembros && Array.isArray(miNidoPrincipal.miembros)) {
                  miNidoPrincipal.miembros.forEach(uid => uidsSet.add(uid));
                }
                
                // Buscar nidos descendientes
                if (currentFamilia?.id && miNidoPrincipal.id) {
                  try {
                    const descendientesSnap = await db.collection('nidos')
                      .where('familiaId', '==', currentFamilia.id)
                      .where('nidoOrigen', '==', miNidoPrincipal.id)
                      .get();
                    descendientesSnap.docs.forEach(doc => {
                      const nido = doc.data();
                      if (nido.miembrosData) {
                        nido.miembrosData.forEach(m => {
                          if (m.uid) uidsSet.add(m.uid);
                        });
                      }
                      if (nido.miembros) {
                        nido.miembros.forEach(uid => uidsSet.add(uid));
                      }
                    });
                  } catch (e) {
                    console.warn('Error buscando descendientes:', e);
                  }
                }
              }
              console.log('Miembros estirpe encontrados:', uidsSet.size);
              break;
          }
        }
      } catch (error) {
        console.error('Error en resolverDestinatarios:', error);
      }
      
      // Excluir al remitente
      uidsSet.delete(currentUser.uid);
      
      console.log('UIDs finales:', Array.from(uidsSet));
      return Array.from(uidsSet);
    }

    // ============ PRIMEROS PASOS ============
    function cerrarPrimerosPasos() {
      document.getElementById('modal-primeros-pasos').classList.remove('active');
    }

    function noMostrarPrimerosPasos() {
      localStorage.setItem('familynk_no_mostrar_primeros_pasos', 'true');
      cerrarPrimerosPasos();
    }

    function verVideoPrimerosPasos() {
      // Abrir video en nueva ventana o modal de video
      window.open('https://www.youtube.com/watch?v=VIDEO_ID', '_blank');
    }
  </script>

  <!-- Modal Primeros Pasos -->
  <div class="modal-overlay" id="modal-primeros-pasos">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">🎬 Bienvenido a FAMILYNK</h3>
        <button class="modal-close" onclick="cerrarPrimerosPasos()">&times;</button>
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 16px;">🏠</div>
        <p style="font-size: 1.1rem; margin-bottom: 16px;">
          ¿Es tu primera vez aquí?
        </p>
        <p style="color: var(--text-muted); margin-bottom: 24px;">
          Te recomendamos ver nuestro video de introducción para sacar el máximo partido a FAMILYNK.
        </p>
        <button class="btn btn-primary" onclick="verVideoPrimerosPasos()" style="width: 100%; margin-bottom: 12px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px; vertical-align: middle;">
            <path d="M8 5v14l11-7z"/>
          </svg>
          Ver Primeros Pasos
        </button>
        <button class="btn btn-secondary" onclick="cerrarPrimerosPasos()" style="width: 100%;">
          Ahora no, gracias
        </button>
      </div>
      <div class="modal-footer" style="justify-content: center; border-top: none; padding-top: 0;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem; color: var(--text-muted);">
          <input type="checkbox" onchange="if(this.checked) noMostrarPrimerosPasos()">
          No volver a mostrar
        </label>
      </div>
    </div>
  </div>
</body>
</html>
