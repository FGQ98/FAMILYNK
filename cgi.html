<!DOCTYPE html>
<html lang="es">
<head>
  <!-- FAMILYNK Icons & PWA -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7A9E7E">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="FAMILYNK">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK — Mi Espacio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C17757;
      --terracotta-light: #D4927A;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --tablon: #5B7BA3;
      --tablon-muted: rgba(91, 123, 163, 0.15);
      --calendario: #5B7BA3;
      --tienda: #9C27B0;
      --tienda-muted: rgba(156, 39, 176, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* ============ HEADER ============ */
    .header {
      background: var(--white);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5em; /* Una letra de distancia */
      text-decoration: none;
    }

    .logo-icon {
      height: 2.4rem; /* Doble altura que las letras (1.2rem) */
      width: auto;
      filter: hue-rotate(20deg) saturate(0.65) brightness(1.1); /* Ajustar al sage */
    }

    .logo-text {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--sage-dark);
    }

    /* Familia badge en header */
    .familia-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--sage-muted);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--sage-dark);
    }

    .familia-badge-stats { display: flex; gap: 8px; }
    .familia-badge-stat { display: flex; align-items: center; gap: 2px; }

    /* Selector de estirpes */
    .estirpe-selector {
      position: relative;
    }
    .estirpe-selector-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--sage);
      border: none;
      border-radius: var(--radius-full);
      color: white;
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .estirpe-selector-btn:hover { background: var(--sage-dark); }
    .estirpe-arrow { font-size: 0.7rem; transition: transform 0.2s; }
    .estirpe-selector.open .estirpe-arrow { transform: rotate(180deg); }
    
    .estirpe-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      min-width: 220px;
      background: var(--white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-medium);
      z-index: 1000;
      overflow: hidden;
    }
    .estirpe-dropdown-list { padding: 8px 0; }
    .estirpe-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .estirpe-dropdown-item:hover { background: var(--cream); }
    .estirpe-dropdown-item.active { background: var(--sage-muted); }
    .estirpe-dropdown-item-icon { font-size: 1.2rem; }
    .estirpe-dropdown-item-name { font-weight: 600; font-size: 0.9rem; }
    .estirpe-dropdown-item-check { margin-left: auto; color: var(--sage); }
    
    .estirpe-dropdown-divider { height: 1px; background: var(--cream-dark); margin: 4px 0; }
    .estirpe-dropdown-action {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      color: var(--sage);
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 600;
      transition: background 0.2s;
    }
    .estirpe-dropdown-action:hover { background: var(--cream); }

    /* Nav desktop */
    .header-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .nav-link {
      padding: 8px 12px;
      border-radius: var(--radius-md);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--text-light);
      transition: all 0.2s;
    }

    .nav-link:hover { background: var(--cream); color: var(--text); }

    /* Header right */
    .header-right { display: flex; align-items: center; gap: 10px; }

    /* Carrito tienda */
    .cart-btn {
      width: 36px;
      height: 36px;
      background: var(--tienda-muted);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    .cart-btn:hover { background: var(--tienda); color: white; }
    .cart-btn .cart-icon { font-size: 1.1rem; }

    .cart-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background: var(--terracotta);
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Help button */
    .help-btn {
      width: 36px;
      height: 36px;
      background: var(--cream);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      font-size: 1rem;
    }
    .help-btn:hover { background: var(--sage); }
    .help-btn:hover .help-icon { filter: brightness(10); }
    .help-icon { transition: filter 0.2s; }

    /* Home button (brújula) */
    .home-btn {
      width: 36px;
      height: 36px;
      background: var(--cream);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .home-btn:hover { background: var(--sage); }
    .home-btn:hover .home-icon { stroke: white; }

    .home-icon {
      width: 20px;
      height: 20px;
      stroke: var(--text-light);
      stroke-width: 2;
      fill: none;
      transition: stroke 0.2s;
    }

    /* Chat button */
    .chat-btn {
      width: 36px;
      height: 36px;
      background: var(--sage-muted);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    .chat-btn:hover { background: var(--sage); color: white; }
    .chat-btn .chat-icon { font-size: 1.1rem; }

    .chat-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background: var(--terracotta);
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Chat Panel */
    .chat-panel {
      position: fixed;
      top: 0;
      right: -380px;
      width: 380px;
      height: 100vh;
      background: var(--white);
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      z-index: 300;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .chat-panel.active { right: 0; }

    .chat-panel-header {
      padding: 16px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-panel-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-panel-close {
      width: 32px;
      height: 32px;
      background: var(--cream);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .chat-panel-body {
      flex: 1;
      overflow-y: auto;
    }

    .chat-panel-conv {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--cream);
    }

    .chat-panel-conv:hover { background: var(--cream); }
    .chat-panel-conv.unread { background: rgba(193, 119, 87, 0.08); }

    .chat-panel-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--sage-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .chat-panel-avatar.grupo { background: var(--sage); color: white; }

    .chat-panel-info { flex: 1; min-width: 0; }

    .chat-panel-name {
      font-weight: 600;
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-panel-conv.unread .chat-panel-name { font-weight: 700; }

    .chat-panel-preview {
      font-size: 0.75rem;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-panel-time {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .chat-panel-conv.unread .chat-panel-time { color: var(--terracotta); font-weight: 600; }

    .chat-panel-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--cream-dark);
    }

    .chat-panel-footer a {
      display: block;
      text-align: center;
      padding: 10px;
      background: var(--sage);
      color: white;
      text-decoration: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.85rem;
    }

    .chat-panel-footer a:hover { background: var(--sage-dark); }

    .chat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 299;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .chat-overlay.active { opacity: 1; visibility: visible; }

    /* User menu */
    .user-menu {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px 4px 4px;
      background: var(--cream);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-menu:hover { background: var(--cream-dark); }

    .user-avatar {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-light) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.75rem;
    }

    .user-name { font-weight: 600; font-size: 0.8rem; }

    /* Hamburger */
    .hamburger {
      display: none;
      flex-direction: column;
      gap: 4px;
      padding: 8px;
      background: none;
      border: none;
      cursor: pointer;
    }

    .hamburger span {
      width: 20px;
      height: 2px;
      background: var(--text);
      border-radius: 2px;
      transition: all 0.3s;
    }

    .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(4px, 4px); }
    .hamburger.active span:nth-child(2) { opacity: 0; }
    .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(4px, -4px); }

    /* Mobile nav */
    .mobile-nav {
      display: none;
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      background: var(--white);
      box-shadow: var(--shadow-medium);
      padding: 16px;
      z-index: 99;
      transform: translateY(-100%);
      opacity: 0;
      transition: all 0.3s ease;
      max-height: calc(100vh - 56px);
      overflow-y: auto;
    }

    .mobile-nav.active {
      transform: translateY(0);
      opacity: 1;
    }

    /* Stats de rama en el menú móvil */
    .nav-rama-stats {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }
    .nav-rama-nombre {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--sage-dark);
    }
    .nav-rama-badges {
      display: flex;
      gap: 10px;
    }
    .nav-rama-badge {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--sage-dark);
    }

    /* Secciones del menú */
    .nav-section {
      margin-bottom: 16px;
    }
    .nav-section:last-child {
      margin-bottom: 0;
    }
    .nav-section-title {
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding-left: 4px;
    }

    /* Grid 2 columnas */
    .mobile-nav-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .mobile-nav-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 14px 8px;
      background: var(--cream);
      border-radius: var(--radius-md);
      text-decoration: none;
      color: var(--text);
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .mobile-nav-link:hover { 
      background: var(--sage-muted); 
      transform: scale(1.02);
    }
    .mobile-nav-link span:first-child { font-size: 1.4rem; }

    /* Separador del menú */
    .nav-divider {
      height: 1px;
      background: var(--cream-dark);
      margin: 12px 0;
    }

    /* Admin buttons en mobile nav - 2 columnas */
    .mobile-admin-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    /* Links de utilidad */
    .nav-utility-links {
      display: flex;
      gap: 8px;
    }
    .nav-utility-link {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px;
      background: var(--cream);
      border-radius: var(--radius-md);
      text-decoration: none;
      color: var(--text-light);
      font-size: 0.75rem;
      font-weight: 600;
    }
    .nav-utility-link:hover {
      background: var(--sage-muted);
      color: var(--text);
    }

    /* ============ MAIN ============ */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Welcome */
    .welcome {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .welcome-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .welcome-title span { color: var(--sage); }

    /* Admin buttons desktop */
    .admin-buttons { display: flex; gap: 6px; }

    .admin-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: var(--radius-md);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.7rem;
      box-shadow: var(--shadow-soft);
      transition: all 0.2s;
      border: none;
      cursor: pointer;
    }

    .admin-btn:hover { transform: translateY(-1px); }
    .admin-btn.sistema { background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: white; }
    .admin-btn.rama { background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: white; }
    .admin-btn.crear-rama { background: linear-gradient(135deg, var(--sage-dark) 0%, var(--sage) 100%); color: white; }
    .admin-btn.nido { background: linear-gradient(135deg, var(--terracotta) 0%, var(--terracotta-light) 100%); color: white; }
    .admin-btn.mayordomo { background: linear-gradient(135deg, var(--mayordomo) 0%, #A69076 100%); color: white; }
    .admin-btn.comunicado { background: linear-gradient(135deg, #5B7BA3 0%, #7B9BC3 100%); color: white; border: none; cursor: pointer; }

    /* Botón comunicado circular en móvil */
    .mobile-admin-buttons .admin-btn.comunicado {
      width: 48px;
      height: 48px;
      min-width: 48px;
      border-radius: 50%;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      justify-self: end;
      grid-column: 2;
    }
    .mobile-admin-buttons .admin-btn.comunicado .admin-btn-icon {
      font-size: 1.3rem;
    }
    .mobile-admin-buttons .admin-btn.comunicado .admin-btn-text {
      display: none;
    }

    .hidden { display: none !important; }

    /* ============ ACCIONES RÁPIDAS (CTAs) ============ */
    .acciones-rapidas {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .cta-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 18px;
      background: var(--white);
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-soft);
    }

    .cta-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .cta-btn .cta-icon {
      font-size: 1.1rem;
    }

    .cta-averia { border-color: #E57373; }
    .cta-averia:hover { background: #FFEBEE; border-color: #EF5350; }

    .cta-iniciativa { border-color: #FFD54F; }
    .cta-iniciativa:hover { background: #FFFDE7; border-color: #FFCA28; }

    .cta-evento { border-color: #FF9800; }
    .cta-evento:hover { background: #FFF3E0; border-color: #F57C00; }

    .cta-reserva { border-color: #42A5F5; }
    .cta-reserva:hover { background: #E3F2FD; border-color: #1E88E5; }

    .cta-solicitar { border-color: #7E57C2; }
    .cta-solicitar:hover { background: #EDE7F6; border-color: #5E35B1; }


    .cta-queo { border-color: #5B7BA3; }
    .cta-queo:hover { background: rgba(91, 123, 163, 0.15); border-color: #5B7BA3; }

    .cta-asistencia { border-color: #9C27B0; }
    .cta-asistencia:hover { background: rgba(156, 39, 176, 0.1); border-color: #7B1FA2; }

    .cta-encuestar { border-color: #F9A825; }
    .cta-encuestar:hover { background: rgba(249, 168, 37, 0.15); border-color: #F57F17; }
    .cta-convocar { border-color: #00897B; }
    .cta-convocar:hover { background: rgba(0, 137, 123, 0.1); border-color: #00695C; }

    .cta-mercadear { border-color: #8D6E63; }
    .cta-mercadear:hover { background: rgba(141, 110, 99, 0.12); border-color: #6D4C41; }
    .cta-listar { border-color: #26A69A; }
    .cta-listar:hover { background: rgba(38, 166, 154, 0.12); border-color: #00897B; }
    .cta-votar { border-color: #5C6BC0; }
    .cta-votar:hover { background: rgba(92, 107, 192, 0.12); border-color: #3949AB; }

    /* ============ MODALES ============ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      padding: 20px;
    }

    .modal-overlay.active { opacity: 1; pointer-events: auto; }

    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 450px;
      max-height: 90vh;
      overflow: hidden;
      transform: translateY(20px);
      transition: transform 0.2s;
    }

    .modal-overlay.active .modal { transform: translateY(0); }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--cream);
      border-radius: var(--radius-sm);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .modal-body { padding: 20px; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid var(--cream-dark); display: flex; gap: 12px; justify-content: flex-end; }

    .form-group { margin-bottom: 16px; }

    /* Selector de visibilidad */
    .visibilidad-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .visibilidad-option {
      flex: 1;
      min-width: 90px;
      padding: 10px 8px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .visibilidad-option:hover {
      border-color: var(--sage-light);
      background: var(--sage-muted);
    }

    .visibilidad-option.active {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .visibilidad-option input {
      display: none;
    }

    .visibilidad-icon {
      font-size: 1.3rem;
      display: block;
      margin-bottom: 4px;
    }

    .visibilidad-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text);
    }

    .visibilidad-option.active .visibilidad-label {
      color: var(--sage-dark);
    }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    .form-input, .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
    }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--sage); }

    .btn { 
      padding: 10px 18px; 
      border-radius: var(--radius-md); 
      font-family: 'Nunito', sans-serif; 
      font-weight: 600; 
      cursor: pointer; 
      border: none;
      font-size: 0.85rem;
    }
    .btn-primary { background: var(--sage); color: white; }
    .btn-secondary { background: var(--cream); color: var(--text); }

    .urgencia-options { display: flex; gap: 10px; flex-wrap: wrap; }
    .urgencia-option { cursor: pointer; }
    .urgencia-option input { display: none; }
    .urgencia-badge {
      display: inline-block;
      padding: 8px 14px;
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 600;
      border: 2px solid var(--cream-dark);
      transition: all 0.2s;
    }
    .urgencia-option input:checked + .urgencia-badge.baja { background: #E8F5E9; border-color: #4CAF50; }
    .urgencia-option input:checked + .urgencia-badge.media { background: #FFF8E1; border-color: #FFC107; }
    .urgencia-option input:checked + .urgencia-badge.alta { background: #FFEBEE; border-color: #F44336; }

    /* ============ DASHBOARD GRID ============ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 260px 1fr 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 16px;
      max-height: calc(100vh - 180px); /* Header + CTAs + márgenes */
    }
    
    /* Evitar que el contenido expanda las columnas */
    .dashboard-grid > div {
      min-width: 0;
    }

    /* ============ CARDS ============ */
    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .alertas-gestion-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .alertas-gestion-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .card-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-body { padding: 10px 14px; }

    .card-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-action {
      font-size: 0.7rem;
      color: white;
      background: var(--sage);
      text-decoration: none;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-family: 'Nunito', sans-serif;
      transition: all 0.2s;
      display: inline-block;
    }

    .card-action:hover { 
      background: var(--sage-dark);
      transform: translateY(-1px);
    }

    .card-action-btn {
      font-size: 0.7rem;
      color: white;
      background: var(--calendario);
      border: none;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      font-family: 'Nunito', sans-serif;
      transition: all 0.2s;
    }

    .card-action-btn:hover {
      background: #4A6A92;
      transform: translateY(-1px);
    }

    /* ============ MI NIDO ============ */
    .nido-col { grid-column: 1; grid-row: 1; }
    .plan-col { grid-column: 1; grid-row: 2; align-self: start; }
    .calendario-col { grid-column: 2; grid-row: 1 / 3; }
    .reservas-col { grid-column: 3; grid-row: 1; align-self: start; }
    .mensajes-col { grid-column: 3; grid-row: 2; }
    .tablon-col { grid-column: 4; grid-row: 1 / 3; }
    
    /* Limitar altura de cards grandes en desktop */
    .calendario-col .card,
    .mensajes-col .card,
    .tablon-col .card {
      max-height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
    }
    .calendario-col .card-body,
    .mensajes-col .card-body,
    .tablon-col .card-body {
      overflow-y: auto;
      flex: 1;
    }
    
    .nido-card { border-left: 4px solid var(--terracotta); }

    /* Stats de rama (solo visible en móvil, dentro de la card de Nido) */
    .rama-stats-mobile {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: var(--sage-muted);
      border-radius: var(--radius-sm);
      margin-bottom: 10px;
    }
    .rama-stats-nombre {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.8rem;
      color: var(--sage-dark);
    }
    .rama-stats-badges {
      display: flex;
      gap: 8px;
    }
    .rama-stat-badge {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--sage-dark);
    }

    /* Mostrar/Ocultar según dispositivo (por defecto: desktop) */
    .desktop-only { display: inline; }
    .mobile-only { display: none; }

    @media (max-width: 768px) {
      .rama-stats-mobile { display: flex; }
      .desktop-only { display: none !important; }
      .mobile-only { display: inline !important; }
    }

    /* Calendario toggle */
    .calendario-toggle {
      margin-top: 12px;
      text-align: center;
    }
    
    .btn-toggle-calendario {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--cream);
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-toggle-calendario:hover {
      background: var(--sage-muted);
      border-color: var(--sage);
      color: var(--sage-dark);
    }

    .nido-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .nido-icon {
      width: 36px;
      height: 36px;
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .nido-info { flex: 1; }
    .nido-nombre { font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 0.95rem; }
    .nido-desc { font-size: 0.7rem; color: var(--text-muted); }

    .miembros-compact { display: flex; flex-direction: column; gap: 5px; }

    .miembro-mini {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 7px;
      background: var(--cream);
      border-radius: var(--radius-sm);
    }

    .miembro-mini-avatar {
      width: 26px;
      height: 26px;
      background: var(--sage);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.6rem;
    }

    .miembro-mini-avatar.fallecido { background: var(--text-muted); opacity: 0.5; }
    .miembro-mini-info { flex: 1; line-height: 1.2; }
    .miembro-mini-name { font-weight: 600; font-size: 0.75rem; }
    .miembro-mini-rel { font-size: 0.6rem; color: var(--text-muted); }

    /* ============ CALENDARIO ============ */
    .calendario-mini {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      text-align: center;
    }

    .cal-header { font-size: 0.6rem; color: var(--text-muted); font-weight: 600; padding: 3px 0; }

    .cal-day {
      padding: 5px 2px;
      font-size: 0.7rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .cal-day:hover { background: var(--cream); }
    .cal-day.today { background: var(--sage); color: white; font-weight: 700; }
    .cal-day.other-month { color: var(--text-muted); opacity: 0.4; }
    .cal-day.has-events { position: relative; }
    .cal-day-dots { display: flex; gap: 2px; justify-content: center; margin-top: 2px; }
    .cal-dot { width: 4px; height: 4px; border-radius: 50%; }
    .cal-dot.cumple { background: #E91E63; }
    .cal-dot.especial { background: #4CAF50; }
    .cal-dot.evento { background: #FF9800; }
    .cal-dot.cita { background: #2196F3; }
    .cal-dot.reserva { background: #7A9E7E; }
    .cal-dot.reserva-estancia { background: #7A9E7E; }
    .cal-dot.reserva-huespedes { background: #FF7043; }
    .cal-dot.reserva-zafarrancho { background: #66BB6A; }
    .cal-dot.reserva-monteria { background: #8D6E63; }

    .eventos-hoy {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--cream-dark);
    }

    .evento-mini {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      font-size: 0.7rem;
    }

    .evento-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .evento-dot.cumple { background: #E91E63; }
    .evento-dot.especial { background: #4CAF50; }
    .evento-dot.evento { background: #FF9800; }
    .evento-dot.cita { background: #2196F3; }
    .evento-dot.reserva { background: #7A9E7E; }
    .evento-dot.reserva-estancia { background: #7A9E7E; }
    .evento-dot.reserva-huespedes { background: #FF7043; }
    .evento-dot.reserva-zafarrancho { background: #66BB6A; }
    .evento-dot.reserva-monteria { background: #8D6E63; }

    /* ============ CALENDARIO MÓVIL (Próximos 3 días) ============ */
    .proximos-dias { display: flex; flex-direction: column; gap: 12px; }
    
    .dia-grupo {
      background: var(--cream);
      border-radius: var(--radius-md);
      padding: 12px;
    }
    
    .dia-grupo.hoy {
      background: linear-gradient(135deg, rgba(122,158,126,0.15) 0%, rgba(122,158,126,0.05) 100%);
      border-left: 3px solid var(--sage);
    }
    
    .dia-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .dia-label {
      font-weight: 700;
      font-size: 0.8rem;
      color: var(--sage-dark);
      text-transform: uppercase;
    }
    
    .dia-grupo.hoy .dia-label { color: var(--sage); }
    
    .dia-fecha {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .dia-eventos { display: flex; flex-direction: column; gap: 6px; }
    
    .hito-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--white);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .hito-item:hover { transform: translateX(4px); box-shadow: var(--shadow-soft); }
    .hito-item:active { transform: scale(0.98); }
    
    .hito-icono { font-size: 1rem; flex-shrink: 0; }
    
    .hito-info { flex: 1; min-width: 0; }
    
    .hito-titulo {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .hito-meta {
      font-size: 0.65rem;
      color: var(--text-muted);
      display: flex;
      gap: 6px;
    }
    
    .hito-hora { color: var(--sage-dark); font-weight: 600; }
    
    .hito-externo {
      opacity: 0.75;
      border-left: 3px dashed #607D8B;
      background: linear-gradient(90deg, rgba(96,125,139,0.08) 0%, var(--white) 100%);
    }
    
    .dia-vacio {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-style: italic;
      padding: 4px 0;
    }
    
    .dia-mas {
      font-size: 0.7rem;
      color: var(--sage-dark);
      text-align: center;
      padding: 4px;
      cursor: pointer;
    }
    
    .dia-mas:hover { text-decoration: underline; }
    
    .calendario-ver-mas {
      display: flex;
      justify-content: center;
      margin-top: 12px;
    }
    
    .btn-ver-calendario {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: var(--white);
      border: 1px solid var(--sage-light);
      border-radius: var(--radius-full);
      color: var(--sage-dark);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-ver-calendario:hover {
      background: var(--sage);
      color: white;
      border-color: var(--sage);
    }

    /* ============ TABLÓN ============ */
    .tablon-card { border-left: 4px solid var(--sage); }

    .anuncio-item {
      padding: 8px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
    }

    .anuncio-item:last-child { margin-bottom: 0; }

    .anuncio-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .anuncio-tipo {
      font-size: 0.6rem;
      padding: 2px 5px;
      border-radius: 4px;
      font-weight: 600;
    }

    .anuncio-tipo.info { background: var(--sage-muted); color: var(--sage-dark); }
    .anuncio-tipo.convocatoria { background: var(--terracotta-muted); color: var(--terracotta); }

    .anuncio-fecha { font-size: 0.6rem; color: var(--text-muted); margin-left: auto; }
    .anuncio-titulo { font-weight: 600; font-size: 0.8rem; }
    .anuncio-texto { font-size: 0.7rem; color: var(--text-light); }

    /* Notificaciones de herramientas */
    .notif-item {
      padding: 10px;
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .notif-item:hover { transform: translateX(2px); }
    .notif-item:last-child { margin-bottom: 0; }

    .notif-item.accion {
      background: var(--terracotta-muted);
      border-left: 3px solid var(--terracotta);
    }
    .notif-item.info-notif {
      background: rgba(33, 150, 243, 0.1);
      border-left: 3px solid #2196F3;
    }

    .notif-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .notif-badge {
      font-size: 0.55rem;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .notif-badge.accion { background: var(--terracotta); color: white; }
    .notif-badge.info-notif { background: #2196F3; color: white; }

    .notif-tiempo { font-size: 0.6rem; color: var(--text-muted); margin-left: auto; }
    .notif-titulo { font-weight: 600; font-size: 0.8rem; margin-bottom: 2px; }
    .notif-texto { font-size: 0.7rem; color: var(--text-light); }
    .notif-origen { font-size: 0.6rem; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 4px; }
    .notif-remitente { font-size: 0.65rem; color: var(--sage-dark); font-style: italic; margin-top: 2px; }

    .notif-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
    }

    .notif-marcar, .notif-eliminar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--text-muted);
      background: transparent;
      cursor: pointer;
      font-size: 0.65rem;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.6;
      transition: all 0.2s;
    }
    .notif-marcar:hover { opacity: 1; border-color: var(--sage); background: var(--sage); color: white; }
    .notif-eliminar { border-color: var(--terracotta-muted); }
    .notif-eliminar:hover { opacity: 1; border-color: var(--terracotta); background: var(--terracotta); color: white; }

    .tablon-separator {
      font-size: 0.65rem;
      color: var(--text-muted);
      padding: 8px 0 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ============ TAREAS ============ */


    .tarea-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      border-radius: var(--radius-sm);
      margin-bottom: 4px;
      cursor: pointer;
    }

    .tarea-item:hover { background: var(--cream); }

    .tarea-check {
      width: 18px;
      height: 18px;
      border: 2px solid var(--cream-dark);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 0.65rem;
    }

    .tarea-check:hover { border-color: var(--sage); }
    .tarea-check.done { background: var(--sage); border-color: var(--sage); color: white; }

    .tarea-content { flex: 1; }
    .tarea-titulo { font-size: 0.75rem; font-weight: 600; }
    .tarea-titulo.done { text-decoration: line-through; color: var(--text-muted); }
    .tarea-asignado { font-size: 0.6rem; color: var(--text-muted); }

    .tarea-prioridad { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .tarea-prioridad.alta { background: #E53935; }
    .tarea-prioridad.media { background: #FB8C00; }
    .tarea-prioridad.baja { background: var(--sage); }

    /* ============ BUZÓN ============ */
    .tablon-card { border-left: 4px solid var(--tablon); }
    .tablon-card .card-body {
      max-height: 350px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    /* Forzar ancho máximo en tablón */
    .tablon-col {
      min-width: 0;
      max-width: 100%;
    }
    .tablon-col .card {
      overflow: hidden;
    }
    
    /* Ocultar Plan si no es admin */
    .plan-col.hidden-no-admin { display: none; }

    .mensajes-card { border-left: 4px solid var(--sage); }

    .mensaje-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      cursor: pointer;
    }

    .mensaje-item:hover { background: var(--cream-dark); }
    .mensaje-item.no-leido { background: var(--tablon-muted); }
    
    /* Estilos para notificaciones por tipo */
    .mensaje-item.notif-accion {
      border-left: 3px solid var(--terracotta);
      background: rgba(180, 93, 74, 0.08);
    }
    .mensaje-item.notif-accion:hover {
      background: rgba(180, 93, 74, 0.15);
    }
    .mensaje-item.notif-info {
      border-left: 3px solid var(--sage);
    }

    .btn-eliminar-notif {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.4;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .btn-eliminar-notif:hover {
      opacity: 1;
      background: rgba(220, 53, 69, 0.1);
    }

    .mensaje-avatar {
      width: 28px;
      height: 28px;
      background: var(--tablon);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.65rem;
      flex-shrink: 0;
    }
    
    .notif-accion .mensaje-avatar {
      background: var(--terracotta);
      font-size: 0.9rem;
    }
    .notif-info .mensaje-avatar {
      background: var(--sage);
      font-size: 0.9rem;
    }
    
    /* Estilo para items leídos */
    .mensaje-item.notif-leido {
      opacity: 0.6;
      background: var(--cream);
    }
    .aviso.leido {
      opacity: 0.6;
      background: var(--cream);
    }

    .mensaje-content { flex: 1; min-width: 0; overflow: hidden; }
    .mensaje-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
    .mensaje-autor { font-weight: 600; font-size: 0.75rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; }
    .mensaje-fecha { font-size: 0.65rem; color: var(--text-muted); flex-shrink: 0; }
    .mensaje-from { font-weight: 600; font-size: 0.75rem; }
    .mensaje-preview { font-size: 0.7rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mensaje-time { font-size: 0.6rem; color: var(--text-muted); }

    .mensaje-badge {
      width: 6px;
      height: 6px;
      background: var(--terracotta);
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 4px;
    }

    /* ============ BUZÓN UNIFICADO ============ */
    .buzon-card { border-left: 4px solid var(--tablon); }

    .buzon-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--cream-dark);
      padding-bottom: 8px;
    }

    .buzon-tab {
      flex: 1;
      padding: 8px 12px;
      background: var(--cream);
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .buzon-tab:hover { background: var(--sage-muted); color: var(--text); }
    .buzon-tab.active { background: var(--sage); color: white; }

    .buzon-tab-badge {
      background: var(--terracotta);
      color: white;
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    .buzon-tab.active .buzon-tab-badge {
      background: white;
      color: var(--sage-dark);
    }

    .buzon-content { display: none; }
    .buzon-content.active { display: block; }

    .tablon-content { display: none; }
    .tablon-content.active { display: block; }

    /* ============ MIS BIENES ============ */
    .mis-bienes-section {
      margin-top: 16px;
    }

    .mis-bienes-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--text);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bien-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-soft);
      margin-bottom: 10px;
      text-decoration: none;
      color: var(--text);
      transition: all 0.2s;
      border-left: 4px solid var(--sage);
    }

    .bien-card:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-medium);
    }

    .bien-card.mayordomo { border-left-color: var(--mayordomo); }
    .bien-card.gerente { border-left-color: #5B7BA3; }
    .bien-card.capataz { border-left-color: #6B8E23; }

    .bien-icon {
      width: 40px;
      height: 40px;
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    .bien-card.mayordomo .bien-icon { background: rgba(139, 115, 85, 0.15); }
    .bien-card.gerente .bien-icon { background: rgba(91, 123, 163, 0.15); }
    .bien-card.capataz .bien-icon { background: rgba(107, 142, 35, 0.15); }

    .bien-info { flex: 1; }
    .bien-nombre { font-weight: 700; font-size: 0.9rem; }
    .bien-addon { font-size: 0.7rem; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
    .bien-arrow { color: var(--text-muted); font-size: 1.2rem; }

    /* ============ MI PLAN ============ */
    .plan-card { border-left: 4px solid var(--sage); }

    .plan-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .plan-icon {
      width: 36px;
      height: 36px;
      background: var(--sage-muted);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--sage-dark);
    }

    .plan-details {
      flex: 1;
    }

    .plan-nombre {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
    }

    .plan-tipo {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .plan-stats {
      display: flex;
      gap: 12px;
      font-size: 0.75rem;
    }

    .plan-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .plan-stat-label {
      color: var(--text-muted);
      font-size: 0.65rem;
    }

    .plan-stat-value {
      font-weight: 700;
      color: var(--text);
    }

    .plan-upgrade {
      display: block;
      width: 100%;
      padding: 8px;
      background: var(--sage-muted);
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--sage-dark);
      text-decoration: none;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
    }

    .plan-upgrade:hover {
      background: var(--sage);
      color: white;
    }

    /* ============ BTN NUEVO ============ */
    .btn-nuevo {
      width: 100%;
      padding: 6px;
      background: var(--cream);
      border: 2px dashed var(--cream-dark);
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.7rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .btn-nuevo:hover {
      border-color: var(--sage);
      color: var(--sage-dark);
      background: var(--sage-muted);
    }

    /* ============ LOADING ============ */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-mini {
      text-align: center;
      padding: 16px;
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .empty-mini-icon { font-size: 1.3rem; opacity: 0.4; margin-bottom: 4px; }

    /* Dropdown */
    .dropdown { position: relative; }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 6px;
      background: var(--white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-float);
      min-width: 140px;
      padding: 5px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
      z-index: 200;
    }

    .dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-menu a,
    .dropdown-menu button {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: var(--radius-sm);
      text-decoration: none;
      color: var(--text);
      font-size: 0.75rem;
      width: 100%;
      border: none;
      background: none;
      cursor: pointer;
    }

    .dropdown-menu a:hover,
    .dropdown-menu button:hover { background: var(--sage-muted); }

    .dropdown-divider { height: 1px; background: var(--cream-dark); margin: 4px 0; }

    /* ============ TIENDA PANEL ============ */
    .tienda-panel {
      position: fixed;
      top: 0;
      right: -350px;
      width: 350px;
      height: 100vh;
      background: var(--white);
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      z-index: 300;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .tienda-panel.active { right: 0; }

    .tienda-header {
      padding: 16px;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .tienda-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tienda-close {
      width: 32px;
      height: 32px;
      background: var(--cream);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .tienda-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .tienda-categoria {
      margin-bottom: 16px;
    }

    .tienda-cat-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--cream);
      border-radius: var(--radius-md);
      cursor: pointer;
      margin-bottom: 8px;
    }

    .tienda-cat-header:hover { background: var(--cream-dark); }
    .tienda-cat-icon { font-size: 1.1rem; }
    .tienda-cat-name { font-weight: 600; font-size: 0.85rem; flex: 1; }
    .tienda-cat-arrow { font-size: 0.8rem; color: var(--text-muted); transition: transform 0.2s; }
    .tienda-cat-header.open .tienda-cat-arrow { transform: rotate(90deg); }

    .tienda-subcats {
      display: none;
      padding-left: 20px;
    }

    .tienda-subcats.open { display: block; }

    .tienda-subcat {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      margin-bottom: 4px;
      background: var(--white);
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.8rem;
    }

    .tienda-subcat:hover { border-color: var(--sage); background: var(--sage-muted); }

    .tienda-subcat-add {
      width: 24px;
      height: 24px;
      background: var(--sage);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tienda-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 299;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .tienda-overlay.active { opacity: 1; visibility: visible; }

    /* Tienda Tabs */
    .tienda-tabs {
      display: flex;
      border-bottom: 1px solid var(--cream-dark);
    }

    .tienda-tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
      position: relative;
    }

    .tienda-tab.active {
      color: var(--tienda);
    }

    .tienda-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--tienda);
    }

    .tienda-tab-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      background: var(--tienda);
      color: white;
      font-size: 0.65rem;
      border-radius: 9px;
      margin-left: 4px;
    }

    .tienda-tab-content {
      display: none;
    }

    .tienda-tab-content.active {
      display: block;
    }

    /* Input rápido */
    .tienda-input-rapido {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .tienda-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
    }

    .tienda-input:focus {
      outline: none;
      border-color: var(--tienda);
    }

    .tienda-select {
      width: 120px;
      padding: 10px 8px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.75rem;
      background: var(--white);
    }

    .tienda-btn-add {
      width: 40px;
      background: var(--tienda);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .tienda-btn-add:hover {
      background: #7B1FA2;
    }

    /* Categorías rápidas */
    .tienda-cats-rapidas {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .tienda-cat-chip {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--cream);
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.2s;
    }

    .tienda-cat-chip:hover {
      background: var(--tienda-muted);
      transform: scale(1.1);
    }

    /* Items recientes */
    .tienda-recientes {
      border-top: 1px solid var(--cream-dark);
      padding-top: 12px;
    }

    .tienda-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.8rem;
      padding: 24px;
    }

    /* Lista de compra */
    .tienda-lista {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .tienda-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }

    .tienda-item.comprado {
      opacity: 0.5;
    }

    .tienda-item-check {
      width: 20px;
      height: 20px;
      border: 2px solid var(--cream-dark);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      flex-shrink: 0;
    }

    .tienda-item-check:hover {
      border-color: var(--tienda);
    }

    .tienda-item-check.done {
      background: var(--tienda);
      border-color: var(--tienda);
      color: white;
    }

    .tienda-item-info {
      flex: 1;
    }

    .tienda-item-nombre {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .tienda-item.comprado .tienda-item-nombre {
      text-decoration: line-through;
    }

    .tienda-item-cat {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .tienda-item-delete {
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .tienda-item-delete:hover {
      color: var(--error);
    }

    .tienda-lista-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--cream-dark);
    }

    /* Selector de bien */
    .tienda-bien-selector {
      padding: 12px 16px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .tienda-bien-selector select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      background: var(--white);
    }

    .tienda-bien-selector select:focus {
      outline: none;
      border-color: var(--tienda);
    }

    /* Productos grid */
    .tienda-productos {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tienda-producto {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .tienda-producto:hover {
      border-color: var(--tienda);
    }

    .tienda-producto.en-carrito {
      background: var(--tienda-muted);
      border-color: var(--tienda);
    }

    .tienda-producto-icon {
      width: 32px;
      height: 32px;
      background: var(--white);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .tienda-producto-info {
      flex: 1;
    }

    .tienda-producto-nombre {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .tienda-producto-formato {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .tienda-producto-cantidad {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tienda-cantidad-btn {
      width: 24px;
      height: 24px;
      border: 1px solid var(--cream-dark);
      background: var(--white);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .tienda-cantidad-btn:hover {
      background: var(--tienda);
      color: white;
      border-color: var(--tienda);
    }

    .tienda-cantidad-num {
      min-width: 24px;
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
    }

    /* Formulario añadir especial */
    .tienda-add-especial {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .especial-row {
      display: flex;
      gap: 6px;
    }

    .tienda-input-sm {
      max-width: 80px;
    }

    .tienda-input-xs {
      max-width: 50px;
    }

    /* Pedidos */
    .pedidos-filtros {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .pedido-filtro {
      padding: 6px 12px;
      border: 1px solid var(--cream-dark);
      background: var(--white);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pedido-filtro:hover {
      border-color: var(--tienda);
    }

    .pedido-filtro.active {
      background: var(--tienda);
      color: white;
      border-color: var(--tienda);
    }

    .pedidos-lista {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pedido-card {
      background: var(--cream);
      border-radius: var(--radius-md);
      padding: 12px;
      border-left: 4px solid var(--text-muted);
    }

    .pedido-card.pendiente { border-left-color: #FFC107; }
    .pedido-card.en-curso { border-left-color: #2196F3; }
    .pedido-card.realizado { border-left-color: #4CAF50; }

    .pedido-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .pedido-fecha {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .pedido-estado {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .pedido-estado.pendiente { background: #FFF8E1; color: #F9A825; }
    .pedido-estado.en-curso { background: #E3F2FD; color: #1976D2; }
    .pedido-estado.realizado { background: #E8F5E9; color: #388E3C; }

    .pedido-items {
      font-size: 0.8rem;
      color: var(--text);
    }

    .pedido-items-count {
      font-weight: 600;
    }

    .pedido-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    .pedido-actions button {
      flex: 1;
      padding: 6px;
      font-size: 0.75rem;
      border: 1px solid var(--cream-dark);
      background: var(--white);
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .pedido-actions button:hover {
      background: var(--cream);
    }

    /* Footer tienda */
    .tienda-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--cream-dark);
      background: var(--cream);
    }

    .carrito-resumen {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .carrito-items {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .btn-tienda {
      padding: 10px 18px;
      background: var(--tienda);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn-tienda:hover {
      background: #7B1FA2;
    }

    .btn-tienda:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Categoría grupo */
    .tienda-categoria-grupo {
      margin-bottom: 16px;
    }

    .tienda-categoria-titulo {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 8px;
      padding-left: 4px;
    }

    /* ============ FOOTER ============ */
    .app-footer {
      text-align: center;
      padding: 16px 24px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .app-footer a {
      color: var(--sage-dark);
      text-decoration: none;
      margin: 0 8px;
    }

    .app-footer a:hover { text-decoration: underline; }

    /* ============ RESPONSIVE ============ */
    @media (max-width: 1100px) {
      .dashboard-grid {
        grid-template-columns: 1fr 1fr;
        max-height: none;
      }
      /* Reset posiciones desktop */
      .nido-col, .plan-col, .calendario-col, .reservas-col,
      .mensajes-col, .tablon-col, .mis-bienes-col, .buzon-col {
        grid-column: auto;
        grid-row: auto;
      }
      .calendario-col .card,
      .mensajes-col .card,
      .tablon-col .card {
        max-height: none;
      }
    }

    @media (max-width: 768px) {
      .header-nav { display: none; }
      .hamburger { display: flex; }
      .mobile-nav { display: block; }
      .user-name { display: none; }
      .admin-buttons { display: none; }
      .welcome { flex-direction: column; align-items: flex-start; gap: 8px; }
      .welcome-title { font-size: 1.1rem; }

      /* Botones de acción en grid 3x2 */
      .acciones-rapidas {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 16px;
        overflow-x: visible;
        flex-wrap: nowrap;
        padding-bottom: 0;
      }

      .cta-btn {
        flex-direction: column;
        padding: 12px 8px;
        font-size: 0.7rem;
        gap: 4px;
        border-radius: var(--radius-md);
      }

      .cta-btn .cta-label { 
        display: block; 
        font-size: 0.65rem;
        text-align: center;
      }
      .cta-btn .cta-icon { font-size: 1.4rem; }

      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      /* Reset posiciones y forzar columna única */
      .dashboard-grid > div {
        grid-column: 1 !important;
        grid-row: auto !important;
      }

      /* Orden móvil: CTAs (fuera del grid) → Mis Reservas → Calendario → Tablón → Bienes → resto */
      .reservas-col { order: 0; }
      .calendario-col { order: 1; }
      .tablon-col { display: block; order: 2; }
      .mis-bienes-col { order: 3; }
      .nido-col { order: 4; }
      .plan-col { order: 5; }
      .buzon-col { display: none; }
      .mensajes-col { display: none; }

      /* Reducir alturas 25% en móvil */
      .dashboard-grid .card-body {
        max-height: 260px;
        overflow-y: auto;
      }
      .reservas-col .card-body { max-height: 180px; }
      .calendario-col .card-body { max-height: 300px; }
      .tablon-col .card-body { max-height: 260px; }
      .buzon-col .card-body { max-height: 260px; }
      
      /* Header móvil: ocultar elementos que no caben (Ayuda SÍ visible) */
      .familia-badge { display: none; }
      .home-btn { display: none; }

      .tienda-panel { width: 100%; right: -100%; }
      .chat-panel { width: 100%; right: -100%; }

      .card-body { padding: 10px 12px; }

      /* Sección de bienes visible solo en móvil como parte del scroll */
      .mis-bienes-section { display: block; }
    }

    /* En desktop, ocultar la sección de bienes duplicada */
    @media (min-width: 769px) {
      .mis-bienes-col { display: none; }
      .buzon-col { display: none; }
    }

    /* ============ MODAL COMUNICADO ============ */
    .comunicado-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--sage);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .comunicado-btn:hover {
      background: var(--sage-dark);
      transform: translateY(-1px);
    }

    .modal-comunicado {
      max-width: 540px;
    }

    .modal-comunicado .modal-header {
      background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: none;
    }

    .modal-comunicado .modal-logo {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .modal-comunicado .modal-header-info { flex: 1; }

    .modal-comunicado .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      margin-bottom: 2px;
    }

    .modal-comunicado .modal-subtitle {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.85);
    }

    .modal-comunicado .modal-close {
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
    }

    .modal-comunicado .modal-close:hover {
      background: rgba(255,255,255,0.25);
    }

    .modal-comunicado .modal-body {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .modal-comunicado .form-group { margin-bottom: 20px; }

    .modal-comunicado .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .modal-comunicado .form-label-hint {
      font-weight: 400;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    /* Destinatarios grid */
    .destinatarios-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .destinatario-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--cream);
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .destinatario-option:hover {
      border-color: var(--sage-light);
      background: var(--sage-muted);
    }

    .destinatario-option.selected {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .destinatario-option.hidden { display: none; }

    .destinatario-option input { display: none; }

    .destinatario-check {
      width: 20px;
      height: 20px;
      border: 2px solid var(--cream-dark);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--white);
      transition: all 0.2s;
      font-size: 0.7rem;
      color: white;
    }

    .destinatario-option.selected .destinatario-check {
      background: var(--sage);
      border-color: var(--sage);
    }

    .destinatario-info { flex: 1; }
    .destinatario-nombre { font-weight: 600; font-size: 0.85rem; }
    .destinatario-desc { font-size: 0.7rem; color: var(--text-muted); }
    .destinatario-icon { font-size: 1.2rem; }

    /* Textarea contador */
    .char-counter {
      text-align: right;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .char-counter.warning { color: var(--terracotta); }
    .char-counter.limit { color: #D4695A; font-weight: 600; }

    /* Upload área */
    .upload-area {
      border: 2px dashed var(--cream-dark);
      border-radius: var(--radius-md);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--cream);
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: var(--sage);
      background: var(--sage-muted);
    }

    .upload-icon { font-size: 2rem; margin-bottom: 8px; }
    .upload-text { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; }
    .upload-hint { font-size: 0.75rem; color: var(--text-muted); }
    .upload-input { display: none; }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--cream);
    }

    .preview-item img { width: 100%; height: 100%; object-fit: cover; }

    .preview-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 22px;
      height: 22px;
      background: rgba(0,0,0,0.6);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-remove:hover { background: var(--terracotta); }

    /* Tipo selector */
    .tipo-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .tipo-option {
      padding: 16px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .tipo-option:hover { border-color: var(--sage-light); }
    .tipo-option input { display: none; }

    .tipo-option.info.selected {
      border-color: #5B7BA3;
      background: rgba(91, 123, 163, 0.15);
    }

    .tipo-option.accion.selected {
      border-color: #E8B44D;
      background: rgba(232, 180, 77, 0.15);
    }

    .tipo-icon { font-size: 1.8rem; margin-bottom: 8px; }
    .tipo-nombre { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }
    .tipo-desc { font-size: 0.75rem; color: var(--text-muted); }

    .tipo-option.info.selected .tipo-nombre { color: #5B7BA3; }
    .tipo-option.accion.selected .tipo-nombre { color: #B8922E; }

    .modal-comunicado .modal-footer {
      background: var(--cream);
    }

    /* Modal Hito */
    .modal-hito {
      max-width: 500px;
    }

    .modal-hito .modal-header {
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: none;
    }

    .modal-hito .modal-logo {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .modal-hito .modal-header-info { flex: 1; }

    .modal-hito .modal-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      margin-bottom: 2px;
    }

    .modal-hito .modal-subtitle {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.85);
    }

    .modal-hito .modal-close {
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
    }

    .modal-hito .modal-close:hover {
      background: rgba(255,255,255,0.25);
    }

    .modal-hito .modal-body {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .modal-hito .form-group { margin-bottom: 16px; }

    .modal-hito .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 6px;
    }

    .modal-hito .form-label-hint {
      font-weight: 400;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .modal-hito .modal-footer {
      background: var(--cream);
    }

    @media (max-width: 540px) {
      .destinatarios-grid { grid-template-columns: 1fr; }
      .tipo-selector { grid-template-columns: 1fr; }
      .preview-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- ============ HEADER ============ -->
  <header class="header">
    <div class="header-left">
      <button class="hamburger" id="hamburger" onclick="toggleMobileNav()">
        <span></span><span></span><span></span>
      </button>

      <a href="cgi.html" class="logo">
        <img src="logo_familynk.png" alt="FAMILYNK" class="logo-icon">
        <span class="logo-text">FAMILYNK</span>
      </a>

      <div class="familia-badge" id="familia-badge">
        <span id="familia-badge-nombre">Mi Rama</span>
        <div class="familia-badge-stats">
          <span class="familia-badge-stat"><span id="badge-nidos">0</span>🪺</span>
          <span class="familia-badge-stat"><span id="badge-miembros">0</span>👥</span>
        </div>
      </div>

      <!-- Selector de estirpes (oculto por defecto, visible si tiene más de 1) -->
      <div class="estirpe-selector hidden" id="estirpe-selector">
        <button class="estirpe-selector-btn" onclick="toggleEstirpeDropdown()">
          <span id="estirpe-actual-nombre">Mi Rama</span>
          <span class="estirpe-arrow">▼</span>
        </button>
        <div class="estirpe-dropdown hidden" id="estirpe-dropdown">
          <div class="estirpe-dropdown-list" id="estirpe-dropdown-list">
            <!-- Se llena dinámicamente -->
          </div>
          <div class="estirpe-dropdown-divider"></div>
          <a href="mi-perfil.html#crear-rama" class="estirpe-dropdown-action">
            <span>➕</span> Crear/vincular rama
          </a>
        </div>
      </div>

      <nav class="header-nav">
        <a href="mi-nido.html" class="nav-link" id="nav-minido-desktop">Mi Nido</a>
        <a href="arbol.html" class="nav-link" id="nav-arbol-desktop">Árbol</a>
        <a href="lo-comun.html" class="nav-link" id="nav-locomun-desktop">Lo Común</a>
        <a href="legado.html" class="nav-link" id="nav-legado-desktop">Legado</a>
        <a href="cerebro.html" class="nav-link" id="nav-cerebro-desktop">Cerebro</a>
        <a href="activacion.html" class="nav-link" id="nav-activacion-desktop">Activación</a>
        <a href="chat.html" class="nav-link" id="nav-chat-desktop">Chat</a>
      </nav>
    </div>

    <div class="header-right">
      <a href="ayuda.html" class="help-btn" title="Ayuda">
        <span class="help-icon">❓</span>
      </a>

      <a href="index.html" class="home-btn" title="Inicio">
        <svg class="home-icon" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <polygon points="12,2 14,10 12,12 10,10" fill="currentColor" stroke="none"/>
          <polygon points="12,22 10,14 12,12 14,14" fill="var(--terracotta)" stroke="none"/>
          <line x1="12" y1="12" x2="12" y2="5"/>
          <circle cx="12" cy="12" r="2"/>
        </svg>
      </a>

      <button class="chat-btn" onclick="toggleChatPanel()">
        <span class="chat-icon">💬</span>
        <span class="chat-badge hidden" id="chat-badge">0</span>
      </button>

      <button class="cart-btn hidden" id="cart-btn" onclick="toggleTienda()">
        <span class="cart-icon">🛒</span>
        <span class="cart-badge hidden" id="cart-badge">0</span>
      </button>

      <div class="dropdown">
        <div class="user-menu">
          <div class="user-avatar" id="user-avatar">?</div>
          <span class="user-name" id="user-name">...</span>
        </div>
        <div class="dropdown-menu">
          <a href="mi-perfil.html"><span>👤</span> Mi perfil</a>
          <a href="configuracion.html"><span>⚙️</span> Configuración</a>
          <div class="dropdown-divider"></div>
          <button id="logout-btn"><span>🚪</span> Cerrar sesión</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Nav -->
  <nav class="mobile-nav" id="mobile-nav">
    <!-- Stats de la rama -->
    <div class="nav-rama-stats">
      <span class="nav-rama-nombre" id="nav-rama-nombre">Mi Rama</span>
      <div class="nav-rama-badges">
        <span class="nav-rama-badge"><span id="nav-badge-nidos">0</span> 🪺</span>
        <span class="nav-rama-badge"><span id="nav-badge-miembros">0</span> 👥</span>
      </div>
    </div>

    <!-- Sección: Explorar -->
    <div class="nav-section">
      <div class="nav-section-title">📖 Explorar</div>
      <div class="mobile-nav-links">
        <a href="mi-nido.html" class="mobile-nav-link" id="nav-minido-mobile"><span>🪺</span>Mi Nido</a>
        <a href="arbol.html" class="mobile-nav-link" id="nav-arbol-mobile"><span>🌳</span>Árbol</a>
        <a href="lo-comun.html" class="mobile-nav-link" id="nav-locomun-mobile"><span>🏠</span>Lo Común</a>
        <a href="legado.html" class="mobile-nav-link" id="nav-legado-mobile"><span>📜</span>Legado</a>
        <a href="cerebro.html" class="mobile-nav-link" id="nav-cerebro-mobile"><span>🧠</span>Cerebro</a>
        <a href="activacion.html" class="mobile-nav-link" id="nav-activacion-mobile"><span>🎯</span>Activación</a>
        <a href="chat.html" class="mobile-nav-link" id="nav-chat-mobile"><span>💬</span>Chat</a>
      </div>
    </div>

    <!-- Sección: Administrar (condicional) -->
    <div class="nav-section" id="nav-admin-section" style="display: none;">
      <div class="nav-divider"></div>
      <div class="nav-section-title">⚙️ Administrar</div>
      <div class="mobile-admin-buttons" id="mobile-admin-buttons"></div>
    </div>

    <!-- Sección: Utilidades -->
    <div class="nav-section">
      <div class="nav-divider"></div>
      <div class="nav-utility-links">
        <a href="index.html" class="nav-utility-link"><span>🧭</span> Inicio</a>
        <a href="configuracion.html" class="nav-utility-link"><span>⚙️</span> Config</a>
      </div>
    </div>
  </nav>

  <!-- Chat Panel -->
  <div class="chat-overlay" id="chat-overlay" onclick="toggleChatPanel()"></div>
  <div class="chat-panel" id="chat-panel">
    <div class="chat-panel-header">
      <span class="chat-panel-title">💬 Mensajes</span>
      <button class="chat-panel-close" onclick="toggleChatPanel()">×</button>
    </div>
    <div class="chat-panel-body" id="chat-panel-body">
      <div style="padding: 40px; text-align: center; color: var(--text-muted);">
        <div style="font-size: 2rem; margin-bottom: 8px;">💬</div>
        <div>Cargando conversaciones...</div>
      </div>
    </div>
    <div class="chat-panel-footer">
      <a href="chat.html">Abrir chat completo →</a>
    </div>
  </div>

  <!-- Tienda Panel -->
  <div class="tienda-overlay" id="tienda-overlay" onclick="toggleTienda()"></div>
  <div class="tienda-panel" id="tienda-panel">
    <div class="tienda-header">
      <span class="tienda-title">🛒 Tienda</span>
      <button class="tienda-close" onclick="toggleTienda()">×</button>
    </div>
    
    <!-- Selector de Bien -->
    <div class="tienda-bien-selector">
      <select id="tienda-bien-select" onchange="cambiarBienTienda()">
        <option value="">Selecciona un bien...</option>
      </select>
    </div>
    
    <!-- Tabs -->
    <div class="tienda-tabs">
      <button class="tienda-tab active" data-tab="basicos" onclick="cambiarTabTienda('basicos')">📦 Básicos</button>
      <button class="tienda-tab" data-tab="especiales" onclick="cambiarTabTienda('especiales')">⭐ Especiales</button>
      <button class="tienda-tab" data-tab="pedidos" onclick="cambiarTabTienda('pedidos')">📋 Pedidos <span class="tienda-tab-count" id="pedidos-count">0</span></button>
    </div>

    <div class="tienda-body">
      <!-- Tab Básicos -->
      <div class="tienda-tab-content active" id="tab-basicos">
        <div class="tienda-productos" id="productos-basicos">
          <div class="tienda-empty">Selecciona un bien para ver su inventario</div>
        </div>
      </div>

      <!-- Tab Especiales -->
      <div class="tienda-tab-content" id="tab-especiales">
        <!-- Formulario añadir especial -->
        <div class="tienda-add-especial">
          <div class="especial-row">
            <input type="text" id="especial-articulo" placeholder="Artículo" class="tienda-input">
            <input type="text" id="especial-formato" placeholder="Formato" class="tienda-input tienda-input-sm">
            <input type="number" id="especial-unidades" placeholder="Uds" class="tienda-input tienda-input-xs" min="1" value="1">
            <button class="tienda-btn-add" onclick="añadirEspecial()">+</button>
          </div>
        </div>
        <div class="tienda-productos" id="productos-especiales">
          <div class="tienda-empty">Sin artículos especiales</div>
        </div>
      </div>

      <!-- Tab Pedidos -->
      <div class="tienda-tab-content" id="tab-pedidos">
        <div class="pedidos-filtros">
          <button class="pedido-filtro active" data-estado="todos" onclick="filtrarPedidos('todos')">Todos</button>
          <button class="pedido-filtro" data-estado="pendiente" onclick="filtrarPedidos('pendiente')">🟡 Pendiente</button>
          <button class="pedido-filtro" data-estado="en-curso" onclick="filtrarPedidos('en-curso')">🔵 En curso</button>
          <button class="pedido-filtro" data-estado="realizado" onclick="filtrarPedidos('realizado')">🟢 Realizado</button>
        </div>
        <div class="pedidos-lista" id="pedidos-lista">
          <div class="tienda-empty">Sin pedidos</div>
        </div>
      </div>
    </div>

    <!-- Footer con carrito -->
    <div class="tienda-footer" id="tienda-footer">
      <div class="carrito-resumen">
        <span class="carrito-items"><span id="carrito-count">0</span> artículos</span>
        <button class="btn btn-tienda" onclick="crearPedido()">Crear pedido →</button>
      </div>
    </div>
  </div>

  <!-- ============ MAIN ============ -->
  <main class="main">
    <div id="page-loading" class="loading">
      <div class="spinner"></div>
    </div>

    <div id="page-content" class="hidden">
      <div class="welcome">
        <h1 class="welcome-title" id="welcome-title">Buenos días 👋</h1>
        <div class="admin-buttons" id="admin-buttons"></div>
      </div>

      <!-- Acciones Rápidas (CTAs) -->
      <div class="acciones-rapidas" id="ctas-container">
        <button class="cta-btn cta-averia" id="cta-averia" onclick="abrirModalAveria()">
          <span class="cta-icon">🔧</span>
          <span class="cta-label">Avería</span>
        </button>
        <button class="cta-btn cta-iniciativa" id="cta-iniciativa" onclick="abrirModalIniciativa()">
          <span class="cta-icon">💡</span>
          <span class="cta-label">Proponer</span>
        </button>
        <button class="cta-btn cta-solicitar" id="cta-solicitar" onclick="abrirModalSolicitar()">
          <span class="cta-icon">📋</span>
          <span class="cta-label">Solicitar</span>
        </button>
        <button class="cta-btn cta-queo" id="cta-queo" onclick="abrirModalComunicado()">
          <span class="cta-icon">📣</span>
          <span class="cta-label">Decir</span>
        </button>
        <button class="cta-btn cta-convocar" id="cta-convocar" onclick="abrirModalConvocatoria()">
          <span class="cta-icon">✋</span>
          <span class="cta-label">Convocar</span>
        </button>
        <button class="cta-btn cta-encuestar" id="cta-encuestar" onclick="window.location.href='herramienta-encuestas.html'">
          <span class="cta-icon">⭐</span>
          <span class="cta-label">Encuestar</span>
        </button>
        <button class="cta-btn cta-mercadear" id="cta-mercadear" onclick="window.location.href='mercadillo.html'">
          <span class="cta-icon">🏪</span>
          <span class="cta-label">Mercadear</span>
        </button>
        <button class="cta-btn cta-listar" id="cta-listar" onclick="window.location.href='herramienta-listas.html'">
          <span class="cta-icon">✅</span>
          <span class="cta-label">Listar</span>
        </button>
        <button class="cta-btn cta-votar" id="cta-votar" onclick="window.location.href='herramienta-votaciones.html'">
          <span class="cta-icon">🗳️</span>
          <span class="cta-label">Votar</span>
        </button>
      </div>

      <!-- Card Alertas de Gestión (solo admin-rama) -->
      <a href="#" class="card alertas-gestion-card hidden" id="card-alertas-gestion" style="display: none; text-decoration: none; color: inherit; margin: 16px 0; border-left: 4px solid var(--terracotta); padding: 16px 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 1.5rem;">🚨</span>
            <div>
              <div style="font-family: 'Quicksand', sans-serif; font-weight: 700; color: var(--terracotta);">Alertas de Gestión</div>
              <div style="font-size: 0.8rem; color: var(--text-muted);">Seguimiento de cumplimiento en bienes con add-on</div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 16px;">
            <div style="text-align: center;">
              <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-muted);" id="alertas-total-count">-</div>
              <div style="font-size: 0.7rem; color: var(--text-muted);">alertas</div>
            </div>
            <span style="color: var(--terracotta); font-weight: 600;">→</span>
          </div>
        </div>
      </a>

      <div class="dashboard-grid">
        <!-- Mi Nido (con stats de rama integrados) -->
        <div class="nido-col">
          <div class="card nido-card">
            <div class="card-header">
              <span class="card-title">🪺 Mi Nido</span>
              <a href="mi-nido.html" class="card-action">Ver →</a>
            </div>
            <div class="card-body">
              <!-- Stats de la Rama (visible en móvil) -->
              <div class="rama-stats-mobile" id="rama-stats-mobile">
                <span class="rama-stats-nombre" id="rama-nombre-mobile">Mi Rama</span>
                <div class="rama-stats-badges">
                  <span class="rama-stat-badge"><span id="badge-nidos-mobile">0</span> 🪺</span>
                  <span class="rama-stat-badge"><span id="badge-miembros-mobile">0</span> 👥</span>
                </div>
              </div>
              <div class="nido-header">
                <div class="nido-icon">🪺</div>
                <div class="nido-info">
                  <div class="nido-nombre" id="nido-nombre">Cargando...</div>
                  <div class="nido-desc" id="nido-desc"></div>
                </div>
              </div>
              <div class="miembros-compact" id="miembros-compact"></div>
            </div>
          </div>
        </div>

        <!-- Calendario -->
        <div class="calendario-col">
          <div class="card">
            <div class="card-header">
              <span class="card-title">📅 <span id="mes-actual">Próximos días</span></span>
              <div class="card-actions">
                <button class="card-action-btn" onclick="abrirModalHito()" title="Crear cita o evento">+ Nuevo</button>
              </div>
            </div>
            <div class="card-body">
              <!-- Vista compacta: Hoy, Mañana, Pasado (default) -->
              <div class="calendario-compacto" id="calendario-compacto"></div>
              
              <!-- Vista expandida: Cuadrícula del mes (oculta inicialmente) -->
              <div class="calendario-expandido" id="calendario-expandido" style="display: none;">
                <div class="calendario-mini" id="calendario-mini"></div>
                <div class="eventos-hoy" id="eventos-hoy"></div>
              </div>
              
              <!-- Botón para ir al calendario completo -->
              <div class="calendario-toggle">
                <button class="btn-toggle-calendario" onclick="window.location.href='calendario.html'">
                  <span>📆</span> <span>Ver calendario completo</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Mis Reservas -->
        <div class="reservas-col">
          <div class="card">
            <div class="card-header">
              <span class="card-title">📅 Mis Reservas</span>
              <a href="solicitud-preparacion.html" class="card-action">Ver todas →</a>
            </div>
            <div class="card-body">
              <div id="mis-reservas-resumen">
                <div class="empty-mini"><div class="empty-mini-icon">⏳</div>Cargando...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Buzón Unificado (Chat + Notificaciones) - MÓVIL -->
        <div class="buzon-col">
          <div class="card buzon-card">
            <div class="card-header">
              <span class="card-title">📬 Buzón</span>
              <a href="chat.html" class="card-action">Ver todo →</a>
            </div>
            <div class="card-body">
              <!-- Pestañas -->
              <div class="buzon-tabs">
                <button class="buzon-tab active" onclick="cambiarPestanaBuzon('chat')">
                  💬 Chat
                  <span class="buzon-tab-badge" id="badge-chat-count">0</span>
                </button>
                <button class="buzon-tab" onclick="cambiarPestanaBuzon('notificaciones')">
                  🔔 Avisos
                  <span class="buzon-tab-badge" id="badge-notif-count">0</span>
                </button>
                <button class="buzon-tab" onclick="cambiarPestanaBuzon('respondidas')">
                  ✅ Respondidas
                  <span class="buzon-tab-badge" id="badge-respondidas-count">0</span>
                </button>
              </div>
              
              <!-- Contenido Chat -->
              <div class="buzon-content active" id="buzon-chat">
                <div id="buzon-mensajes-list"></div>
                <a href="chat.html" class="btn-nuevo" style="text-decoration: none; display: inline-block;">+ Nuevo chat</a>
              </div>
              
              <!-- Contenido Notificaciones -->
              <div class="buzon-content" id="buzon-notificaciones">
                <div id="buzon-tablon-list"></div>
              </div>
              
              <!-- Contenido Respondidas -->
              <div class="buzon-content" id="buzon-respondidas">
                <div id="buzon-respondidas-list"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensajes (DESKTOP - se oculta en móvil) -->
        <div class="mensajes-col">
          <div class="card mensajes-card">
            <div class="card-header">
              <span class="card-title">💬 Mensajes</span>
              <a href="chat.html" class="card-action">Ver todos →</a>
            </div>
            <div class="card-body">
              <div id="mensajes-list"></div>
              <a href="chat.html" class="btn-nuevo" style="text-decoration: none; display: inline-block;">+ Nuevo chat</a>
            </div>
          </div>
        </div>

        <!-- Tablón (DESKTOP - se oculta en móvil, integrado en buzón) -->
        <div class="tablon-col">
          <div class="card tablon-card">
            <div class="card-header">
              <span class="card-title">📌 Tablón</span>
              <a href="tablon.html" class="card-action">Ver todo →</a>
            </div>
            <div class="card-body">
              <!-- Pestañas del tablón -->
              <div class="buzon-tabs" style="margin-bottom: 12px;">
                <button class="buzon-tab active" onclick="cambiarPestanaTablon('avisos')">
                  🔔 Avisos
                  <span class="buzon-tab-badge" id="badge-tablon-avisos">0</span>
                </button>
                <button class="buzon-tab" onclick="cambiarPestanaTablon('respondidas')">
                  ✅ Respondidas
                  <span class="buzon-tab-badge" id="badge-tablon-respondidas">0</span>
                </button>
              </div>
              
              <!-- Contenido Avisos -->
              <div class="tablon-content active" id="tablon-avisos">
                <div id="tablon-list"></div>
              </div>
              
              <!-- Contenido Respondidas -->
              <div class="tablon-content" id="tablon-respondidas">
                <div id="tablon-respondidas-list"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mis Bienes (MÓVIL - acceso directo a Lo Común) -->
        <div class="mis-bienes-col">
          <div class="mis-bienes-section">
            <div class="mis-bienes-title">🏠 Bienes Compartidos</div>
            <div id="mis-bienes-list">
              <!-- Se llena dinámicamente -->
            </div>
            <a href="lo-comun.html" class="btn-nuevo" style="text-decoration: none; display: block; text-align: center; margin-top: 8px;">
              Ver todos en Lo Común →
            </a>
          </div>
        </div>

        <!-- Mi Plan (oculto si no es admin de rama) -->
        <div class="plan-col" id="plan-col">
          <div class="card plan-card">
            <div class="card-header">
              <span class="card-title">📋 Mi Plan</span>
              <a href="planes.html" class="card-action">Ver planes →</a>
            </div>
            <div class="card-body">
              <div class="plan-info">
                <div class="plan-icon" id="plan-icon">G</div>
                <div class="plan-details">
                  <div class="plan-nombre" id="plan-nombre">Gratuito</div>
                  <div class="plan-tipo" id="plan-tipo">Plan base</div>
                </div>
              </div>
              <div class="plan-stats">
                <div class="plan-stat">
                  <span class="plan-stat-label">Fotos</span>
                  <span class="plan-stat-value" id="plan-fotos">0 / 150</span>
                </div>
                <div class="plan-stat">
                  <span class="plan-stat-label">Generaciones</span>
                  <span class="plan-stat-value" id="plan-generaciones">3</span>
                </div>
              </div>
              <a href="planes.html" class="plan-upgrade" id="plan-upgrade">Mejorar plan</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Avería -->
  <div class="modal-overlay" id="modal-averia">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">🔧 Avería</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-averia">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¿Dónde está el problema? *</label>
            <select class="form-select" id="averia-bien" required>
              <option value="">Selecciona un bien...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Describe la avería *</label>
            <textarea class="form-input" id="averia-descripcion" rows="3" placeholder="Ej: El grifo del baño gotea..." required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Urgencia</label>
            <div class="urgencia-options">
              <label class="urgencia-option">
                <input type="radio" name="averia-urgencia" value="baja" checked>
                <span class="urgencia-badge baja">🟢 Baja</span>
              </label>
              <label class="urgencia-option">
                <input type="radio" name="averia-urgencia" value="media">
                <span class="urgencia-badge media">🟡 Media</span>
              </label>
              <label class="urgencia-option">
                <input type="radio" name="averia-urgencia" value="alta">
                <span class="urgencia-badge alta">🔴 Alta</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién puede verlo?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'averia')">
                <input type="radio" name="averia-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'averia')">
                <input type="radio" name="averia-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'averia')">
                <input type="radio" name="averia-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="abandonarModal('averia')">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar aviso</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Iniciativa -->
  <div class="modal-overlay" id="modal-iniciativa">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">💡 Proponer</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-iniciativa">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Título de la propuesta *</label>
            <input type="text" class="form-input" id="iniciativa-titulo" placeholder="Ej: Organizar barbacoa familiar" required>
          </div>
          <div class="form-group">
            <label class="form-label">Descripción *</label>
            <textarea class="form-input" id="iniciativa-descripcion" rows="3" placeholder="Explica tu idea con más detalle..." required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Categoría</label>
            <select class="form-select" id="iniciativa-categoria">
              <option value="evento">🎉 Evento</option>
              <option value="mejora">🔧 Mejora</option>
              <option value="compra">🛒 Compra</option>
              <option value="viaje">✈️ Viaje</option>
              <option value="otro">📋 Otro</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién puede verlo?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'iniciativa')">
                <input type="radio" name="iniciativa-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'iniciativa')">
                <input type="radio" name="iniciativa-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'iniciativa')">
                <input type="radio" name="iniciativa-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="abandonarModal('iniciativa')">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar propuesta</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Encargo -->
  <div class="modal-overlay" id="modal-encargo">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">🛒 Hacer encargo</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-encargo">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¿Para qué bien? *</label>
            <select class="form-select" id="encargo-bien" required>
              <option value="">Selecciona un bien...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">¿Qué necesitas? *</label>
            <textarea class="form-input" id="encargo-items" rows="3" placeholder="Ej: Papel higiénico, jabón, bombillas..." required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Notas adicionales</label>
            <input type="text" class="form-input" id="encargo-notas" placeholder="Ej: Marca preferida, cantidad...">
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién puede verlo?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'encargo')">
                <input type="radio" name="encargo-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'encargo')">
                <input type="radio" name="encargo-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'encargo')">
                <input type="radio" name="encargo-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="abandonarModal('encargo')">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar encargo</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Solicitar eliminado — redirección directa a solicitud-preparacion.html -->

  <!-- Modal Solicitar Evento -->
  <div class="modal-overlay" id="modal-evento">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">🎉 Solicitar evento</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-evento">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre del evento *</label>
            <input type="text" class="form-input" id="evento-nombre" placeholder="Ej: Cumpleaños de Juan, Barbacoa familiar..." required>
          </div>
          <div class="form-group">
            <label class="form-label">¿Dónde? *</label>
            <select class="form-select" id="evento-bien" required onchange="cargarTiposEvento()">
              <option value="">Selecciona un lugar...</option>
            </select>
          </div>
          <div class="form-group" id="evento-tipo-container" style="display: none;">
            <label class="form-label">Tipo de evento *</label>
            <select class="form-select" id="evento-tipo" required>
              <option value="">Selecciona tipo...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha propuesta *</label>
            <input type="date" class="form-input" id="evento-fecha" required>
          </div>
          <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">Nº Familiares</label>
              <input type="number" class="form-input" id="evento-familiares" min="0" max="50" value="1" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">Nº Invitados</label>
              <input type="number" class="form-input" id="evento-invitados" min="0" max="50" value="0" placeholder="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" style="font-weight: 500; color: var(--sage-dark);">¿Cuántos pases hay que preparar en la casa?</label>
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 8px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" style="font-size: 0.85rem;">🍳 Desayunos</label>
                <input type="number" class="form-input" id="evento-desayunos" min="0" max="100" value="0" placeholder="0">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" style="font-size: 0.85rem;">🍽️ Comidas</label>
                <input type="number" class="form-input" id="evento-comidas" min="0" max="100" value="0" placeholder="0">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" style="font-size: 0.85rem;">🌙 Cenas</label>
                <input type="number" class="form-input" id="evento-cenas" min="0" max="100" value="0" placeholder="0">
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Descripción / Motivo</label>
            <textarea class="form-input" id="evento-descripcion" rows="2" placeholder="Cuéntanos más sobre el evento..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién puede verlo?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'evento')">
                <input type="radio" name="evento-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'evento')">
                <input type="radio" name="evento-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'evento')">
                <input type="radio" name="evento-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="abandonarModal('evento')">Cancelar</button>
          <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #FF9800, #F57C00);">Enviar solicitud</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Solicitar Reserva -->
  <div class="modal-overlay" id="modal-reserva">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">📅 Solicitar reserva</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-reserva">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">¿Qué quieres reservar? *</label>
            <select class="form-select" id="reserva-bien" required onchange="cargarTiposReserva()">
              <option value="">Selecciona un bien...</option>
            </select>
          </div>
          <div class="form-group" id="reserva-tipo-container" style="display: none;">
            <label class="form-label">Tipo de reserva *</label>
            <select class="form-select" id="reserva-tipo" required onchange="mostrarSelectorQuienReserva()">
              <option value="">Selecciona tipo...</option>
            </select>
          </div>
          
          <!-- Selector de quién reserva (solo para tipos familiares) -->
          <div class="form-group" id="reserva-quien-container" style="display: none;">
            <label class="form-label">¿Quién reserva? *</label>
            <select class="form-select" id="reserva-quien" required>
              <option value="">Selecciona...</option>
            </select>
            <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">
              Selecciona el nido o grupo que hace la reserva
            </p>
          </div>
          
          <div class="form-group">
            <label class="form-label">Fecha inicio *</label>
            <input type="date" class="form-input" id="reserva-inicio" required>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha fin *</label>
            <input type="date" class="form-input" id="reserva-fin" required>
          </div>
          <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">Nº Familiares</label>
              <input type="number" class="form-input" id="reserva-familiares" min="0" max="50" value="1" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">Nº Invitados</label>
              <input type="number" class="form-input" id="reserva-invitados" min="0" max="50" value="0" placeholder="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" style="font-weight: 500; color: var(--sage-dark);">¿Cuántos pases hay que preparar en la casa?</label>
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 8px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" style="font-size: 0.85rem;">🍳 Desayunos</label>
                <input type="number" class="form-input" id="reserva-desayunos" min="0" max="100" value="0" placeholder="0">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" style="font-size: 0.85rem;">🍽️ Comidas</label>
                <input type="number" class="form-input" id="reserva-comidas" min="0" max="100" value="0" placeholder="0">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" style="font-size: 0.85rem;">🌙 Cenas</label>
                <input type="number" class="form-input" id="reserva-cenas" min="0" max="100" value="0" placeholder="0">
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Motivo / Notas</label>
            <textarea class="form-input" id="reserva-motivo" rows="2" placeholder="Ej: Fin de semana con amigos..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién puede verlo?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'reserva')">
                <input type="radio" name="reserva-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'reserva')">
                <input type="radio" name="reserva-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'reserva')">
                <input type="radio" name="reserva-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="abandonarModal('reserva')">Cancelar</button>
          <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #42A5F5, #1E88E5);">Enviar solicitud</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Confirmación Finde -->
  <div class="modal-overlay" id="modal-confirmacion-finde">
    <div class="modal" style="max-width: 480px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #26A69A, #00897B);">
        <h3 class="modal-title">🏡 Confirmación de fin de semana</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-confirmacion-finde">
        <div class="modal-body">
          <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px; text-align: center;">
            Confirma los detalles de tu llegada para este fin de semana
          </p>
          
          <div class="form-group">
            <label class="form-label">¿A qué casa vas? *</label>
            <select class="form-select" id="finde-bien" required onchange="cargarHabitacionesBien()">
              <option value="">Selecciona...</option>
            </select>
          </div>
          
          <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">📅 Día de entrada *</label>
              <input type="date" class="form-input" id="finde-fecha-entrada" required>
            </div>
            <div class="form-group">
              <label class="form-label">📅 Día de salida *</label>
              <input type="date" class="form-input" id="finde-fecha-salida" required>
            </div>
          </div>
          
          <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">🕐 Hora de llegada *</label>
              <input type="time" class="form-input" id="finde-hora-llegada" required>
            </div>
            <div class="form-group">
              <label class="form-label">🕐 Hora de salida</label>
              <input type="time" class="form-input" id="finde-hora-salida" placeholder="Estimada">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">👥 Personas *</label>
            <input type="number" class="form-input" id="finde-personas" min="1" max="20" value="1" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">🛏️ Habitaciones</label>
            <div id="finde-habitaciones-container" style="display: none;">
              <select class="form-select" id="finde-habitaciones-select" onchange="addHabitacionFinde()">
                <option value="">+ Añadir habitación...</option>
              </select>
              <div id="finde-habitaciones-chips" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
            </div>
            <p id="finde-habitaciones-empty" style="color: var(--text-muted); font-size: 0.85rem; font-style: italic;">
              Selecciona primero una casa para ver sus habitaciones
            </p>
          </div>
          
          <div class="form-group">
            <label class="form-label">🍽️ ¿Menús nuevos?</label>
            <div class="finde-toggle-group">
              <label class="finde-toggle-option">
                <input type="radio" name="finde-menus-nuevos" value="no" checked onchange="toggleMenusNuevos()">
                <span class="finde-toggle-label">No</span>
              </label>
              <label class="finde-toggle-option">
                <input type="radio" name="finde-menus-nuevos" value="si" onchange="toggleMenusNuevos()">
                <span class="finde-toggle-label">Sí</span>
              </label>
            </div>
          </div>
          
          <div class="form-group" id="finde-menus-detalle" style="display: none;">
            <label class="form-label">¿Cuáles menús?</label>
            <textarea class="form-input" id="finde-menus-cuales" rows="2" placeholder="Ej: Cena del sábado para 6, comida domingo para 8..."></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">🐕 ¿Sujetar perros a la llegada?</label>
            <div class="finde-toggle-group">
              <label class="finde-toggle-option">
                <input type="radio" name="finde-sujetar-perros" value="no" checked>
                <span class="finde-toggle-label">No hace falta</span>
              </label>
              <label class="finde-toggle-option">
                <input type="radio" name="finde-sujetar-perros" value="si">
                <span class="finde-toggle-label">Sí, por favor</span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">📝 Notas adicionales</label>
            <textarea class="form-input" id="finde-notas" rows="2" placeholder="Cualquier cosa que debamos saber..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="abandonarModal('finde')">Cancelar</button>
          <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #26A69A, #00897B);">✅ Confirmar llegada</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .finde-toggle-group {
      display: flex;
      gap: 8px;
    }
    .finde-toggle-option {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      background: var(--cream);
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }
    .finde-toggle-option:has(input:checked) {
      border-color: #26A69A;
      background: #E0F2F1;
    }
    .finde-toggle-option input { display: none; }
    .finde-toggle-label { font-weight: 600; font-size: 0.9rem; color: var(--text); }
    .finde-toggle-option:has(input:checked) .finde-toggle-label { color: #00897B; }
    
    .habitacion-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #E0F2F1;
      border: 1px solid #26A69A;
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      font-weight: 500;
      color: #00897B;
    }
    .habitacion-chip-remove {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.6;
      padding: 0;
      line-height: 1;
    }
    .habitacion-chip-remove:hover { opacity: 1; }
  </style>

  <!-- Modal Convocatoria -->
  <div class="modal-overlay" id="modal-convocatoria">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">✋ Convocar asistencia</h3>
        <button class="modal-close" onclick="cerrarModales()">×</button>
      </div>
      <form id="form-convocatoria" onsubmit="enviarConvocatoria(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Evento o actividad *</label>
            <input type="text" class="form-input" id="convocatoria-titulo" required placeholder="Ej: Comida de Navidad, Excursión al monte...">
          </div>
          <div class="form-group">
            <label class="form-label">Fecha *</label>
            <input type="date" class="form-input" id="convocatoria-fecha" required>
          </div>
          <div class="form-group">
            <label class="form-label">Hora (opcional)</label>
            <input type="time" class="form-input" id="convocatoria-hora">
          </div>
          <div class="form-group">
            <label class="form-label">Lugar (opcional)</label>
            <input type="text" class="form-input" id="convocatoria-lugar" placeholder="Ej: Casa de los abuelos">
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-input" id="convocatoria-notas" rows="2" placeholder="Detalles adicionales..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">¿Quién debe confirmar?</label>
            <div class="visibilidad-selector">
              <label class="visibilidad-option active" onclick="seleccionarVisibilidad(this, 'convocatoria')">
                <input type="radio" name="convocatoria-visibilidad" value="rama" checked>
                <span class="visibilidad-icon">🌳</span>
                <span class="visibilidad-label">Rama</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'convocatoria')">
                <input type="radio" name="convocatoria-visibilidad" value="estirpe">
                <span class="visibilidad-icon">👨‍👩‍👧‍👦</span>
                <span class="visibilidad-label">Estirpe</span>
              </label>
              <label class="visibilidad-option" onclick="seleccionarVisibilidad(this, 'convocatoria')">
                <input type="radio" name="convocatoria-visibilidad" value="nido">
                <span class="visibilidad-icon">🏠</span>
                <span class="visibilidad-label">Nido</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="abandonarModal('convocatoria')">Cancelar</button>
          <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">Enviar convocatoria</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Queo -->
  <div class="modal-overlay" id="modal-comunicado">
    <div class="modal modal-comunicado">
      <!-- Header -->
      <div class="modal-header">
        <div class="modal-logo">📣</div>
        <div class="modal-header-info">
          <h2 class="modal-title">Decir</h2>
          <p class="modal-subtitle">Envía una notificación a los miembros</p>
        </div>
        <button class="modal-close" onclick="track.abandonar('queo'); cerrarModalComunicado()">×</button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <form id="form-comunicado">
          
          <!-- Destinatarios -->
          <div class="form-group">
            <label class="form-label">
              Destinatarios
              <span class="form-label-hint">(selecciona uno o varios)</span>
            </label>
            <div class="destinatarios-grid" id="destinatarios-grid">
              <label class="destinatario-option" data-dest="toda-rama" onclick="toggleDestinatario(this)">
                <input type="checkbox" name="destinatarios" value="toda-rama">
                <span class="destinatario-check">✓</span>
                <div class="destinatario-info">
                  <div class="destinatario-nombre">Toda la Rama</div>
                  <div class="destinatario-desc">Todos los miembros</div>
                </div>
                <span class="destinatario-icon">🌳</span>
              </label>
              <label class="destinatario-option" data-dest="admins" onclick="toggleDestinatario(this)">
                <input type="checkbox" name="destinatarios" value="admins">
                <span class="destinatario-check">✓</span>
                <div class="destinatario-info">
                  <div class="destinatario-nombre">Administradores</div>
                  <div class="destinatario-desc">Admins de rama y nidos</div>
                </div>
                <span class="destinatario-icon">👑</span>
              </label>
              <label class="destinatario-option" data-dest="mi-nido" onclick="toggleDestinatario(this)">
                <input type="checkbox" name="destinatarios" value="mi-nido">
                <span class="destinatario-check">✓</span>
                <div class="destinatario-info">
                  <div class="destinatario-nombre">Mi Nido</div>
                  <div class="destinatario-desc">Solo mi núcleo familiar</div>
                </div>
                <span class="destinatario-icon">🪺</span>
              </label>
              <label class="destinatario-option" data-dest="mi-estirpe" onclick="toggleDestinatario(this)">
                <input type="checkbox" name="destinatarios" value="mi-estirpe">
                <span class="destinatario-check">✓</span>
                <div class="destinatario-info">
                  <div class="destinatario-nombre">Mi Estirpe</div>
                  <div class="destinatario-desc">Ascendientes y descendientes</div>
                </div>
                <span class="destinatario-icon">👨‍👩‍👧‍👦</span>
              </label>
            </div>
          </div>

          <!-- Asunto -->
          <div class="form-group">
            <label class="form-label" for="comunicado-asunto">Asunto</label>
            <input 
              type="text" 
              class="form-input" 
              id="comunicado-asunto" 
              placeholder="Ej: Recordatorio reunión familiar"
              maxlength="100"
              required
              oninput="validarFormularioComunicado()"
            >
          </div>

          <!-- Cuerpo del mensaje -->
          <div class="form-group">
            <label class="form-label" for="comunicado-mensaje">Mensaje</label>
            <textarea 
              class="form-input" 
              id="comunicado-mensaje" 
              placeholder="Escribe el contenido del comunicado..."
              maxlength="600"
              required
              oninput="actualizarContadorComunicado()"
              style="min-height: 120px; resize: vertical;"
            ></textarea>
            <div class="char-counter" id="comunicado-char-counter">0 / 600 caracteres</div>
          </div>

          <!-- Subir imágenes -->
          <div class="form-group">
            <label class="form-label">
              Imágenes
              <span class="form-label-hint">(opcional, máx. 3)</span>
            </label>
            <div class="upload-area" id="comunicado-upload-area" onclick="document.getElementById('comunicado-upload-input').click()">
              <div class="upload-icon">📷</div>
              <div class="upload-text">Haz clic o arrastra imágenes aquí</div>
              <div class="upload-hint">JPG, PNG • Máximo 3 imágenes • 5MB cada una</div>
            </div>
            <input 
              type="file" 
              class="upload-input" 
              id="comunicado-upload-input" 
              accept="image/jpeg,image/png,image/webp"
              multiple
              onchange="handleComunicadoFiles(this.files)"
            >
            <div class="preview-grid" id="comunicado-preview-grid"></div>
          </div>

          <!-- Tipo de queo -->
          <div class="form-group">
            <label class="form-label">Tipo de queo</label>
            <div class="tipo-selector">
              <label class="tipo-option info selected" onclick="selectTipoComunicado(this, 'info')">
                <input type="radio" name="comunicado-tipo" value="info" checked>
                <div class="tipo-icon">ℹ️</div>
                <div class="tipo-nombre">Información</div>
                <div class="tipo-desc">Aviso o noticia general</div>
              </label>
              <label class="tipo-option accion" onclick="selectTipoComunicado(this, 'accion')">
                <input type="radio" name="comunicado-tipo" value="accion">
                <div class="tipo-icon">⚡</div>
                <div class="tipo-nombre">Acción requerida</div>
                <div class="tipo-desc">Requiere respuesta o acción</div>
              </label>
            </div>
          </div>

        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="track.abandonar('queo'); cerrarModalComunicado()">Cancelar</button>
        <button class="btn btn-primary" onclick="enviarComunicado()" id="btn-enviar-comunicado" disabled>
          <span>📤</span> Decir
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Crear Cita/Evento -->
  <div class="modal-overlay" id="modal-hito">
    <div class="modal modal-hito">
      <!-- Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, var(--calendario) 0%, #4A6A92 100%);">
        <div class="modal-logo">📅</div>
        <div class="modal-header-info">
          <h2 class="modal-title">Añadir al Calendario</h2>
          <p class="modal-subtitle">Crea una cita o evento</p>
        </div>
        <button class="modal-close" onclick="track.abandonar('hito'); cerrarModalHito()">×</button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <form id="form-hito">
          
          <!-- 1. Tipo: Cita o Evento -->
          <div class="form-group">
            <label class="form-label">¿Qué quieres crear?</label>
            <select class="form-select" id="hito-tipo" required onchange="cambiarTipoHito()">
              <option value="cita">📋 Cita</option>
              <option value="evento">🎊 Evento</option>
            </select>
          </div>

          <!-- Subtipo según tipo seleccionado -->
          <div class="form-group" id="hito-subtipo-group">
            <label class="form-label">Categoría</label>
            <select class="form-select" id="hito-subtipo">
              <!-- Se carga según tipo -->
            </select>
          </div>

          <!-- Título -->
          <div class="form-group">
            <label class="form-label">Título</label>
            <input type="text" class="form-input" id="hito-titulo" placeholder="Ej: Reunión de comunidad" required>
          </div>

          <!-- 2. Visibilidad -->
          <div class="form-group">
            <label class="form-label">Visibilidad</label>
            <select class="form-select" id="hito-visibilidad" required>
              <option value="rama">🌳 Toda la Rama</option>
              <option value="estirpe">👨‍👩‍👧‍👦 Mi Estirpe</option>
              <option value="nido">🪺 Solo mi Nido</option>
            </select>
          </div>

          <!-- 3. Bien asociado (solo para citas técnicas) -->
          <div class="form-group" id="hito-bien-group">
            <label class="form-label">Bien asociado <span class="form-label-hint">(opcional)</span></label>
            <select class="form-select" id="hito-bien">
              <option value="">Sin asociar a bien</option>
              <!-- Se carga dinámicamente -->
            </select>
          </div>

          <!-- 4. Fechas -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha</label>
              <input type="date" class="form-input" id="hito-fecha-inicio" required>
            </div>
            <div class="form-group" id="hito-fecha-fin-group">
              <label class="form-label">Fecha fin <span class="form-label-hint">(opcional)</span></label>
              <input type="date" class="form-input" id="hito-fecha-fin">
            </div>
          </div>

          <!-- 5. Horas -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Hora <span class="form-label-hint">(opcional)</span></label>
              <input type="time" class="form-input" id="hito-hora-inicio">
            </div>
            <div class="form-group">
              <label class="form-label">Hora fin <span class="form-label-hint">(opcional)</span></label>
              <input type="time" class="form-input" id="hito-hora-fin">
            </div>
          </div>

          <!-- 6. Lugar -->
          <div class="form-group">
            <label class="form-label">Lugar <span class="form-label-hint">(opcional)</span></label>
            <input type="text" class="form-input" id="hito-lugar" placeholder="Ej: Casa de los abuelos">
          </div>

          <!-- 7. Descripción -->
          <div class="form-group">
            <label class="form-label">Descripción <span class="form-label-hint">(opcional)</span></label>
            <textarea class="form-input" id="hito-descripcion" placeholder="Detalles adicionales..." rows="2"></textarea>
          </div>

          <!-- 8. Evento recurrente -->
          <div class="form-group" id="hito-recurrente-group" style="display: none;">
            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="hito-recurrente" style="width: auto;">
              Se repite cada año
            </label>
          </div>

        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="track.abandonar('hito'); cerrarModalHito()">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarHito()" id="btn-guardar-hito" style="background: var(--calendario);">
          <span>💾</span> Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Responder Solicitud (Reserva/Evento) -->
  <div class="modal-overlay" id="modal-respuesta-solicitud">
    <div class="modal" style="display:flex;flex-direction:column;max-height:90vh;">
      <div class="modal-header" style="flex-shrink:0;background: linear-gradient(135deg, var(--terracotta) 0%, #A65D3F 100%);">
        <div class="modal-logo" id="respuesta-icono">📋</div>
        <div class="modal-header-info">
          <h2 class="modal-title" id="respuesta-titulo">Responder solicitud</h2>
          <p class="modal-subtitle" id="respuesta-subtitulo">Solicitud pendiente</p>
        </div>
        <button class="modal-close" onclick="cerrarModalRespuesta()">×</button>
      </div>

      <div class="modal-body" style="flex:1;overflow-y:auto;min-height:0;">
        <!-- Info de la solicitud -->
        <div class="solicitud-info-card" style="background: var(--cream); padding: 16px; border-radius: var(--radius-md); margin-bottom: 20px;">
          <div id="respuesta-detalle"></div>
        </div>

        <!-- Selector de respuesta -->
        <div class="form-group">
          <label class="form-label">Tu respuesta</label>
          <div class="respuesta-opciones" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <label class="respuesta-opcion" style="flex: 1; min-width: 100px;">
              <input type="radio" name="respuesta-estado" value="aprobada" style="display: none;">
              <div class="respuesta-btn aceptada" onclick="seleccionarRespuesta(this, 'aprobada')">
                <span>✅</span> Aprobada
              </div>
            </label>
            <label class="respuesta-opcion" style="flex: 1; min-width: 100px;">
              <input type="radio" name="respuesta-estado" value="rechazada" style="display: none;">
              <div class="respuesta-btn rechazada" onclick="seleccionarRespuesta(this, 'rechazada')">
                <span>❌</span> Rechazada
              </div>
            </label>
            <label class="respuesta-opcion" style="flex: 1; min-width: 100px;">
              <input type="radio" name="respuesta-estado" value="en_estudio" style="display: none;">
              <div class="respuesta-btn en-estudio" onclick="seleccionarRespuesta(this, 'en_estudio')">
                <span>🔍</span> En estudio
              </div>
            </label>
          </div>
        </div>

        <!-- Comentarios -->
        <div class="form-group">
          <label class="form-label">Comentarios <span class="form-label-hint">(máx. 300 caracteres)</span></label>
          <textarea class="form-input" id="respuesta-comentarios" placeholder="Añade un mensaje para el solicitante..." rows="3" maxlength="300"></textarea>
          <div style="text-align: right; font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
            <span id="respuesta-contador">0</span>/300
          </div>
        </div>
      </div>

      <div class="modal-footer" style="flex-shrink:0;">
        <button class="btn btn-secondary" onclick="cerrarModalRespuesta()">Cancelar</button>
        <button class="btn btn-primary" id="btn-enviar-respuesta" onclick="enviarRespuestaSolicitud()" disabled>
          <span>📤</span> Responder
        </button>
      </div>
    </div>
  </div>

  <style>
    .respuesta-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 12px 16px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      font-size: 0.85rem;
      background: var(--white);
    }
    .respuesta-btn:hover { border-color: var(--text-muted); }
    .respuesta-btn.selected.aceptada { border-color: #27ae60; background: rgba(39,174,96,0.1); color: #27ae60; }
    .respuesta-btn.selected.rechazada { border-color: #e74c3c; background: rgba(231,76,60,0.1); color: #e74c3c; }
    .respuesta-btn.selected.en-estudio { border-color: #f39c12; background: rgba(243,156,18,0.1); color: #f39c12; }
    .solicitud-info-card p { margin: 4px 0; font-size: 0.9rem; }
    .solicitud-info-card strong { color: var(--text); }
  </style>

  <footer class="app-footer">
    <a href="planes.html">Planes</a>
    <a href="#">Privacidad</a>
    <a href="#">Términos</a>
    <span>© 2025 FAMILYNK</span>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/seccion-guard.js"></script>
  <script src="js/eventos-tracker.js"></script>

  <script>
    let currentUser = null;
    let userData = null;
    let currentFamilia = null;
    let estirpesUsuario = []; // Array de estirpes a las que pertenece
    let allNidos = [];
    let miNidoPrincipal = null;

    // ============ AUTH ============
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      
      currentUser = user;

      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists || !userDoc.data().familiaId) {
        window.location.href = 'onboarding.html';
        return;
      }

      userData = userDoc.data();

      if (userData.primerAcceso === true) {
        window.location.href = 'cambiar-password.html';
        return;
      }

      // ========================================
      // SINCRONIZACIÓN DE MIEMBRO INVITADO
      // Si el usuario no tiene nidoId, buscar si está en miembrosData de algún nido
      // ========================================
      if (!userData.nidoId) {
        await sincronizarMiembroInvitado();
      }

      // Cargar estirpes del usuario
      const estirpesIds = userData.estirpes || [userData.familiaId];
      const estirpeActiva = userData.estirpeActiva || userData.familiaId;
      
      // Cargar todas las estirpes
      estirpesUsuario = [];
      for (const estirpeId of estirpesIds) {
        const estirpeDoc = await db.collection('familias').doc(estirpeId).get();
        if (estirpeDoc.exists) {
          estirpesUsuario.push({ id: estirpeDoc.id, ...estirpeDoc.data() });
        }
      }
      
      // Establecer estirpe activa
      currentFamilia = estirpesUsuario.find(e => e.id === estirpeActiva) || estirpesUsuario[0];
      
      // Mostrar selector si tiene más de 1 estirpe
      if (estirpesUsuario.length > 1) {
        document.getElementById('familia-badge').classList.add('hidden');
        document.getElementById('estirpe-selector').classList.remove('hidden');
        renderEstirpeSelector();
      }

      await initApp();
    });

    // ============ SINCRONIZACIÓN DE MIEMBRO INVITADO ============
    async function sincronizarMiembroInvitado() {
      try {
        console.log('🔄 Buscando datos pre-registrados para:', currentUser.email);
        
        // Buscar en todos los nidos de la familia del usuario
        const nidosSnapshot = await db.collection('nidos')
          .where('familiaId', '==', userData.familiaId)
          .get();
        
        let nidoEncontrado = null;
        let miembroEncontrado = null;
        let miembroIndex = -1;
        
        // Buscar el miembro por email en miembrosData de cada nido
        for (const doc of nidosSnapshot.docs) {
          const nido = { id: doc.id, ...doc.data() };
          const miembrosData = nido.miembrosData || [];
          
          const idx = miembrosData.findIndex(m => 
            m.email && m.email.toLowerCase() === currentUser.email.toLowerCase()
          );
          
          if (idx !== -1) {
            nidoEncontrado = nido;
            miembroEncontrado = miembrosData[idx];
            miembroIndex = idx;
            console.log('✅ Encontrado en nido:', nido.nombre, 'como:', miembroEncontrado.nombre);
            break;
          }
        }
        
        if (!nidoEncontrado || !miembroEncontrado) {
          console.log('ℹ️ No se encontraron datos pre-registrados');
          return;
        }
        
        // Preparar actualizaciones
        const batch = db.batch();
        
        // 1. Actualizar documento del usuario con datos del nido
        const userRef = db.collection('usuarios').doc(currentUser.uid);
        const userUpdates = {
          nidoId: nidoEncontrado.id,
          nidoNombre: nidoEncontrado.nombre
        };
        
        // Si el usuario no tiene nombre, usar el pre-registrado
        if (!userData.nombre && miembroEncontrado.nombre) {
          userUpdates.nombre = miembroEncontrado.nombre;
        }
        
        // Copiar otros datos pre-registrados si existen
        if (miembroEncontrado.tipo) userUpdates.tipoMiembro = miembroEncontrado.tipo;
        if (miembroEncontrado.telefono && !userData.telefono) userUpdates.telefono = miembroEncontrado.telefono;
        if (miembroEncontrado.fechaNacimiento && !userData.fechaNacimiento) userUpdates.fechaNacimiento = miembroEncontrado.fechaNacimiento;
        
        batch.update(userRef, userUpdates);
        console.log('📝 Actualizando usuario con:', userUpdates);
        
        // 2. Actualizar miembrosData del nido con el uid del usuario
        const nidoRef = db.collection('nidos').doc(nidoEncontrado.id);
        const miembrosActualizados = [...(nidoEncontrado.miembrosData || [])];
        miembrosActualizados[miembroIndex] = {
          ...miembroEncontrado,
          uid: currentUser.uid,
          registrado: true,
          fechaRegistro: new Date().toISOString()
        };
        
        batch.update(nidoRef, { 
          miembrosData: miembrosActualizados,
          miembros: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        console.log('📝 Actualizando nido con uid del usuario');
        
        // Ejecutar batch
        await batch.commit();
        console.log('✅ Sincronización completada');
        
        // Actualizar userData local con los nuevos datos
        Object.assign(userData, userUpdates);
        
      } catch (error) {
        console.error('❌ Error en sincronización:', error);
      }
    }

    // ============ INIT ============
    async function initApp() {
      const nombre = userData.nombre || currentUser.displayName || currentUser.email.split('@')[0];
      const primerNombre = nombre.split(' ')[0];
      
      document.getElementById('user-name').textContent = primerNombre;
      document.getElementById('user-avatar').textContent = primerNombre.charAt(0).toUpperCase();
      
      const hora = new Date().getHours();
      let saludo = 'Buenos días';
      if (hora >= 14 && hora < 21) saludo = 'Buenas tardes';
      else if (hora >= 21 || hora < 6) saludo = 'Buenas noches';
      
      document.getElementById('welcome-title').textContent = `${saludo}, ${primerNombre} 👋`;

      renderAdminButtons();
      await loadNidos();
      await verificarTiendaDisponible();
      
      await cargarEventosCalendario();
      cargarMisReservasResumen(); // Cargar card Mis Reservas (no bloquea)
      renderCalendario();
      await renderMensajes();
      await renderTablon();
      await cargarRespondidasTablon();
      // Renderizar buzón unificado después de mensajes y tablón
      setTimeout(() => renderBuzonUnificado(), 800);
      await renderMisBienes();
      cargarBadgeChat();
      renderPlan();
      
      // Chequear si viene de tablon.html con una solicitud para responder
      checkUrlParams();
    }
    
    async function checkUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const solicitudId = params.get('solicitud');
      
      if (solicitudId) {
        console.log('Abriendo solicitud desde URL:', solicitudId);
        const bienIdParam = params.get('bienId');
        try {
          let doc;
          // DATO ÚNICO: si viene bienId, leer de bienes/{bienId}/reservas/{id}
          if (bienIdParam) {
            doc = await db.collection('bienes').doc(bienIdParam).collection('reservas').doc(solicitudId).get();
          }
          // Fallback: leer de solicitudes
          if (!doc || !doc.exists) {
            doc = await db.collection('solicitudes').doc(solicitudId).get();
          }
          if (doc.exists) {
            const notifData = {
              id: solicitudId,
              notifId: null,
              categoria: doc.data().tipo || 'reserva',
              titulo: getTituloSolicitud(doc.data()),
              origen: { tipo: 'solicitud', id: solicitudId, bienId: bienIdParam || doc.data().bienId },
              ...doc.data()
            };
            setTimeout(() => abrirModalRespuesta(notifData), 500);
          }
        } catch (e) {
          console.error('Error cargando solicitud:', e);
        }
        // Limpiar URL
        window.history.replaceState({}, '', 'cgi.html');
      }
    }

    // ============ MI PLAN ============
    let planesConfig = null;
    
    async function cargarPlanesConfig() {
      if (planesConfig) return planesConfig;
      try {
        const doc = await db.collection('config').doc('planes').get();
        if (doc.exists) {
          planesConfig = doc.data();
        }
      } catch (e) {
        console.warn('Error cargando config planes:', e);
      }
      return planesConfig;
    }

    async function renderPlan() {
      // Cargar config desde Firestore
      await cargarPlanesConfig();
      
      // Datos del plan desde familia o usuario
      const plan = currentFamilia?.plan || userData?.plan || 'gratuito';
      const fotos = currentFamilia?.fotosUsadas || 0;
      
      // Defaults por si no hay config en Firestore
      const planesDefault = {
        'gratuito': { nombre: 'Gratuito', icon: 'G', descripcion: 'Plan base', maxFotos: 100, maxGeneraciones: 3 },
        'plus': { nombre: 'Plus', icon: '+', descripcion: 'Plan familiar', maxFotos: 500, maxGeneraciones: 4 },
        'premium': { nombre: 'Premium', icon: 'P', descripcion: 'Todo incluido', maxFotos: 9999, maxGeneraciones: 99 }
      };
      
      // Usar config de Firestore si existe, sino defaults
      let planData;
      if (planesConfig && planesConfig[plan]) {
        const p = planesConfig[plan];
        planData = {
          nombre: p.nombre || planesDefault[plan].nombre,
          icon: p.icon || planesDefault[plan].icon,
          tipo: p.descripcion || planesDefault[plan].descripcion,
          maxFotos: p.maxFotos || planesDefault[plan].maxFotos,
          generaciones: p.maxGeneraciones || planesDefault[plan].maxGeneraciones
        };
      } else {
        const d = planesDefault[plan] || planesDefault['gratuito'];
        planData = { nombre: d.nombre, icon: d.icon, tipo: d.descripcion, maxFotos: d.maxFotos, generaciones: d.maxGeneraciones };
      }

      document.getElementById('plan-icon').textContent = planData.icon;
      document.getElementById('plan-nombre').textContent = planData.nombre;
      document.getElementById('plan-tipo').textContent = planData.tipo;
      document.getElementById('plan-fotos').textContent = `${fotos} / ${planData.maxFotos === 9999 ? '∞' : planData.maxFotos}`;
      document.getElementById('plan-generaciones').textContent = planData.generaciones >= 99 ? '∞' : planData.generaciones;

      // Ocultar botón mejorar si ya tiene Premium
      if (plan === 'premium') {
        document.getElementById('plan-upgrade').style.display = 'none';
      }
    }

    // ============ SELECTOR DE ESTIRPES ============
    function renderEstirpeSelector() {
      const nombreEstirpe = currentFamilia?.nombre || currentFamilia?.apellidoPrincipal || currentFamilia?.nombreFamilia || 'Mi Estirpe';
      document.getElementById('estirpe-actual-nombre').textContent = nombreEstirpe;
      
      const list = document.getElementById('estirpe-dropdown-list');
      list.innerHTML = estirpesUsuario.map(e => `
        <div class="estirpe-dropdown-item ${e.id === currentFamilia?.id ? 'active' : ''}" onclick="cambiarEstirpe('${e.id}')">
          <span class="estirpe-dropdown-item-icon">🪺</span>
          <span class="estirpe-dropdown-item-name">${e.nombre || e.apellidoPrincipal || e.nombreFamilia || 'Estirpe'}</span>
          ${e.id === currentFamilia?.id ? '<span class="estirpe-dropdown-item-check">✓</span>' : ''}
        </div>
      `).join('');
    }

    function toggleEstirpeDropdown() {
      const selector = document.getElementById('estirpe-selector');
      const dropdown = document.getElementById('estirpe-dropdown');
      selector.classList.toggle('open');
      dropdown.classList.toggle('hidden');
    }

    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', (e) => {
      const selector = document.getElementById('estirpe-selector');
      if (selector && !selector.contains(e.target)) {
        selector.classList.remove('open');
        document.getElementById('estirpe-dropdown')?.classList.add('hidden');
      }
    });

    async function cambiarEstirpe(estirpeId) {
      if (estirpeId === currentFamilia?.id) {
        toggleEstirpeDropdown();
        return;
      }
      
      try {
        // Guardar estirpe activa en Firebase
        await db.collection('usuarios').doc(currentUser.uid).update({
          estirpeActiva: estirpeId
        });
        
        // Recargar página para cargar nueva estirpe
        window.location.reload();
      } catch (error) {
        console.error('Error cambiando estirpe:', error);
        alert('Error al cambiar de estirpe');
      }
    }

    // ============ ADMIN BUTTONS ============
    let esAdminRama = false;
    let esAdminNido = false;
    let rolUsuario = 'adulto'; // Por defecto
    let permisosCVEB = null;

    // Permisos CVEB por defecto (igual que en admin-rama)
    const permisosCVEBDefault = {
      arbol: {
        adminRama: { c: true, v: true, e: true, b: true },
        adminNido: { c: true, v: true, e: true, b: true },
        adulto: { c: false, v: true, e: false, b: false },
        nino: { c: false, v: true, e: false, b: false },
        especial: { c: false, v: true, e: false, b: false },
        alejado: { c: false, v: true, e: false, b: false }
      },
      nidos: {
        adminRama: { c: true, v: true, e: true, b: true },
        adminNido: { c: true, v: true, e: true, b: true },
        adulto: { c: false, v: true, e: false, b: false },
        nino: { c: false, v: false, e: false, b: false },
        especial: { c: false, v: true, e: false, b: false },
        alejado: { c: false, v: false, e: false, b: false }
      },
      bienes: {
        adminRama: { c: true, v: true, e: true, b: true },
        adminNido: { c: true, v: true, e: true, b: false },
        adulto: { c: false, v: true, e: false, b: false },
        nino: { c: false, v: true, e: false, b: false },
        especial: { c: false, v: true, e: false, b: false },
        alejado: { c: false, v: true, e: false, b: false }
      },
      calendario: {
        adminRama: { c: true, v: true, e: true, b: true },
        adminNido: { c: true, v: true, e: true, b: true },
        adulto: { c: true, v: true, e: true, b: false },
        nino: { c: false, v: true, e: false, b: false },
        especial: { c: true, v: true, e: true, b: false },
        alejado: { c: false, v: true, e: false, b: false }
      },
      reservas: {
        adminRama: { c: true, v: true, e: true, b: true },
        adminNido: { c: true, v: true, e: true, b: true },
        adulto: { c: true, v: true, e: false, b: false },
        nino: { c: false, v: true, e: false, b: false },
        especial: { c: true, v: true, e: false, b: false },
        alejado: { c: false, v: false, e: false, b: false }
      },
      legado: {
        adminRama: { c: true, v: true, e: true, b: true },
        adminNido: { c: true, v: true, e: true, b: true },
        adulto: { c: true, v: true, e: true, b: false },
        nino: { c: false, v: true, e: false, b: false },
        especial: { c: true, v: true, e: true, b: false },
        alejado: { c: false, v: true, e: false, b: false }
      },
      tablon: {
        adminRama: { c: true, v: true, e: true, b: true },
        adminNido: { c: true, v: true, e: true, b: true },
        adulto: { c: true, v: true, e: false, b: false },
        nino: { c: false, v: true, e: false, b: false },
        especial: { c: true, v: true, e: false, b: false },
        alejado: { c: false, v: true, e: false, b: false }
      },
      recetas: {
        adminRama: { c: true, v: true, e: true, b: true },
        adminNido: { c: true, v: true, e: true, b: true },
        adulto: { c: true, v: true, e: true, b: false },
        nino: { c: false, v: true, e: false, b: false },
        especial: { c: true, v: true, e: true, b: false },
        alejado: { c: false, v: true, e: false, b: false }
      }
    };

    // Función para determinar el rol del usuario
    function determinarRolUsuario() {
      // SuperAdmin o AdminRama
      if (userData.superAdmin === true) return 'adminRama';
      
      const isAdminRama = userData.rol === 'adminRama' || 
        userData.rol === 'adminSistema' ||
        (currentFamilia?.adminsGenerales?.includes(currentUser.uid)) ||
        (currentFamilia?.fundador === currentUser.uid) ||
        (currentFamilia?.creador === currentUser.uid);
      
      if (isAdminRama) return 'adminRama';
      
      // AdminNido (tiene nidoId y es admin de ese nido)
      const esAdminDeNido = userData.esAdminNido || userData.rol === 'adminNido' || userData.rol === 'AdminNido';
      if (esAdminDeNido) return 'adminNido';
      
      // Roles específicos guardados en userData
      if (userData.credenciales === 'nino' || userData.credenciales === 'niño') return 'nino';
      if (userData.credenciales === 'especial') return 'especial';
      if (userData.credenciales === 'alejado') return 'alejado';
      
      // Por defecto es adulto
      return 'adulto';
    }

    // Función para verificar permisos CVEB
    function tienePermiso(modulo, accion) {
      // Admins siempre tienen permiso total
      if (esAdminRama) return true;
      
      // Cargar permisos de la familia o usar default
      const permisosActuales = permisosCVEB || currentFamilia?.permisosCVEB || permisosCVEBDefault;
      
      // Obtener permisos del módulo
      const moduloPermisos = permisosActuales[modulo];
      if (!moduloPermisos) return accion === 'v'; // Si no existe el módulo, solo VER por defecto
      
      // Obtener permisos del rol
      const rolPermisos = moduloPermisos[rolUsuario];
      if (!rolPermisos) return accion === 'v';
      
      return rolPermisos[accion] === true;
    }

    // Aplicar permisos CVEB a la interfaz
    function aplicarPermisosCVEB() {
      console.log('Aplicando permisos CVEB para rol:', rolUsuario);
      
      // Ocultar botones de acción según permisos
      // CTAs - requieren permiso de CREAR en sus módulos respectivos
      const ctaPermisos = {
        'cta-averia': { modulo: 'bienes', accion: 'c' },
        'cta-iniciativa': { modulo: 'tablon', accion: 'c' },
        'cta-evento': { modulo: 'calendario', accion: 'c' },
        'cta-reserva': { modulo: 'reservas', accion: 'c' },
        'cta-queo': { modulo: 'tablon', accion: 'c' },
        'cta-convocar': { modulo: 'calendario', accion: 'c' }
      };
      
      Object.entries(ctaPermisos).forEach(([ctaId, config]) => {
        const btn = document.getElementById(ctaId);
        if (btn) {
          const tiene = tienePermiso(config.modulo, config.accion);
          btn.style.display = tiene ? '' : 'none';
        }
      });
      
      // Botón de añadir al calendario
      const btnAddCalendario = document.getElementById('btn-add-calendario');
      if (btnAddCalendario) {
        btnAddCalendario.style.display = tienePermiso('calendario', 'c') ? '' : 'none';
      }
      
      console.log('Permisos CVEB aplicados');
    }

    function renderAdminButtons() {
      const container = document.getElementById('admin-buttons');
      const mobileContainer = document.getElementById('mobile-admin-buttons');
      let html = '';

      // Super Admin (Diseñador del sistema) - tiene acceso total
      const isSuperAdmin = userData.superAdmin === true;

      // Admin Rama Familiar (antes "Admin Sistema")
      const isAdminRama = userData.rol === 'adminRama' || 
        userData.rol === 'adminSistema' || // compatibilidad
        (currentFamilia?.adminsGenerales?.includes(currentUser.uid)) ||
        (currentFamilia?.fundador === currentUser.uid) ||
        (currentFamilia?.creador === currentUser.uid);

      const miNidoId = userData.nidoId;
      
      // Guardar en variables globales para el comunicado
      esAdminRama = isAdminRama || isSuperAdmin;
      esAdminNido = !!miNidoId;

      // Mostrar card de Alertas de Gestión solo a admin-rama
      const cardAlertas = document.getElementById('card-alertas-gestion');
      if (cardAlertas && esAdminRama) {
        cardAlertas.style.display = 'block';
        cardAlertas.classList.remove('hidden');
        cardAlertas.href = `alertas-gestion.html?familia=${currentFamilia.id}`;
      }

      // 1. Botón TERRACOTTA - Admin Nido
      if (miNidoId) {
        html += `<a href="admin-nido.html" class="admin-btn nido"><span>⚙️</span> Admin Nido</a>`;
      }

      // 2. Botón MARRÓN - Gestión Activa
      if (isAdminRama || miNidoId) {
        html += `<a href="lo-comun.html" class="admin-btn mayordomo"><span>🎩</span> Gestión Activa</a>`;
      }

      // 3. Botón ROJO - Admin Rama Familiar
      if (isAdminRama) {
        html += `<a href="admin-rama.html" class="admin-btn rama"><span>🔧</span> Admin Rama</a>`;
        html += `<a href="crear-rama.html" class="admin-btn crear-rama"><span>🌳</span> Crear/Fusionar Rama</a>`;
      }

      // 4. Botón NEGRO - Admin Sistema (solo superAdmin/Diseñador)
      if (isSuperAdmin) {
        html += `<a href="admin-sistema.html" class="admin-btn sistema"><span>⚡</span> Admin Sistema</a>`;
      }

      container.innerHTML = html;
      mobileContainer.innerHTML = html;
      
      // Mostrar/ocultar sección de admin en menú móvil
      const adminSection = document.getElementById('nav-admin-section');
      if (adminSection) {
        adminSection.style.display = html ? 'block' : 'none';
      }

      // Determinar rol del usuario y cargar permisos CVEB
      rolUsuario = determinarRolUsuario();
      permisosCVEB = currentFamilia?.permisosCVEB || null;
      console.log('👤 Rol del usuario:', rolUsuario);
      
      // Aplicar configuración de secciones (menú + CTAs)
      aplicarConfigSecciones(isAdminRama || isSuperAdmin);
      
      // Aplicar permisos CVEB (oculta CTAs según permisos del rol)
      aplicarPermisosCVEB();
    }

    // ============ APLICAR CONFIG SECCIONES ============
    function aplicarConfigSecciones(esAdmin) {
      // Si es admin, mostrar todo
      if (esAdmin) {
        console.log('👑 Admin detectado: mostrando todas las secciones');
        return;
      }

      // Obtener configuración (con defaults)
      const config = currentFamilia?.configSecciones || {};
      const seccionesConfig = config.secciones || {
        miNido: true, arbol: false, cerebro: false, locomun: true, 
        legado: false, activacion: true, chat: false
      };
      const ctasConfig = config.ctas || {
        averia: true, iniciativa: true, evento: true, 
        reserva: true, queo: true, convocar: true
      };

      console.log('⚙️ Aplicando configSecciones:', seccionesConfig);
      console.log('⚙️ Aplicando configCTAs:', ctasConfig);

      // Ocultar secciones de navegación
      const seccionesMap = {
        miNido: ['nav-minido-desktop', 'nav-minido-mobile'],
        arbol: ['nav-arbol-desktop', 'nav-arbol-mobile'],
        cerebro: ['nav-cerebro-desktop', 'nav-cerebro-mobile'],
        locomun: ['nav-locomun-desktop', 'nav-locomun-mobile'],
        legado: ['nav-legado-desktop', 'nav-legado-mobile'],
        activacion: ['nav-activacion-desktop', 'nav-activacion-mobile'],
        chat: ['nav-chat-desktop', 'nav-chat-mobile']
      };

      Object.keys(seccionesMap).forEach(seccion => {
        const activa = seccionesConfig[seccion] !== false;
        seccionesMap[seccion].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = activa ? '' : 'none';
        });
      });

      // Ocultar CTAs
      const ctasMap = {
        averia: 'cta-averia',
        iniciativa: 'cta-iniciativa',
        evento: 'cta-evento',
        reserva: 'cta-reserva',
        queo: 'cta-queo',
        convocar: 'cta-convocar'
      };

      Object.keys(ctasMap).forEach(cta => {
        const activo = ctasConfig[cta] !== false;
        const el = document.getElementById(ctasMap[cta]);
        if (el) el.style.display = activo ? '' : 'none';
      });
    }

    // ============ LOAD NIDOS ============
    async function loadNidos() {
      const loadingEl = document.getElementById('page-loading');
      const contentEl = document.getElementById('page-content');

      try {
        const nidosSnapshot = await db.collection('nidos')
          .where('familiaId', '==', currentFamilia.id)
          .get();
        
        allNidos = [];
        let generaciones = new Set();
        
        // Set para contar miembros únicos (evitar duplicidades)
        const miembrosUnicos = new Set();

        nidosSnapshot.forEach(doc => {
          const nido = { id: doc.id, ...doc.data() };
          allNidos.push(nido);
          
          // Contar miembros únicos por email o nombre (evitando duplicidades)
          if (nido.miembrosData) {
            nido.miembrosData.forEach(m => {
              // Usar email como identificador único, o nombre si no hay email
              const identificador = m.email || m.uid || m.nombre;
              if (identificador) {
                miembrosUnicos.add(identificador.toLowerCase().trim());
              }
            });
          }
          
          if (nido.generacion) generaciones.add(nido.generacion);
        });
        
        const totalMiembros = miembrosUnicos.size;

        // ========================================
        // LÓGICA MEJORADA PARA ENCONTRAR MI NIDO
        // ========================================
        // 1. PRIMERO: El nido asignado específicamente al usuario (userData.nidoId)
        // 2. SEGUNDO: Un nido donde el usuario aparezca en miembrosData (por email o uid)
        // 3. TERCERO: Un nido donde aparezca en el array miembros
        // 4. CUARTO: Si es admin de algún nido, mostrar ese
        // 5. ÚLTIMO: El primero disponible (fallback)
        
        miNidoPrincipal = null;
        
        // Opción 1: nidoId directo del usuario
        if (userData.nidoId) {
          miNidoPrincipal = allNidos.find(n => n.id === userData.nidoId);
          console.log('Nido por userData.nidoId:', miNidoPrincipal?.nombre);
        }
        
        // Opción 2: Buscar en miembrosData por email
        if (!miNidoPrincipal) {
          const userEmail = currentUser.email;
          miNidoPrincipal = allNidos.find(n => 
            n.miembrosData?.some(m => m.email === userEmail || m.uid === currentUser.uid)
          );
          console.log('Nido por miembrosData:', miNidoPrincipal?.nombre);
        }
        
        // Opción 3: Buscar en array miembros
        if (!miNidoPrincipal) {
          miNidoPrincipal = allNidos.find(n => n.miembros?.includes(currentUser.uid));
          console.log('Nido por miembros[]:', miNidoPrincipal?.nombre);
        }
        
        // Opción 4: Nido donde sea admin (menos prioridad)
        if (!miNidoPrincipal) {
          miNidoPrincipal = allNidos.find(n => n.admins?.includes(currentUser.uid));
          console.log('Nido por admins[]:', miNidoPrincipal?.nombre);
        }
        
        // Opción 5: Fallback al primero
        if (!miNidoPrincipal && allNidos.length > 0) {
          miNidoPrincipal = allNidos[0];
          console.log('⚠️ Fallback al primer nido:', miNidoPrincipal?.nombre);
        }

        // Stats para badge
        const nombreRama = currentFamilia.nombre || currentFamilia.apellidoPrincipal || currentFamilia.nombreFamilia || 'Mi Rama';
        document.getElementById('familia-badge-nombre').textContent = nombreRama;
        document.getElementById('badge-nidos').textContent = allNidos.length;
        document.getElementById('badge-miembros').textContent = totalMiembros;
        
        // Sincronizar stats en la card de Nido (versión móvil)
        document.getElementById('rama-nombre-mobile').textContent = nombreRama;
        document.getElementById('badge-nidos-mobile').textContent = allNidos.length;
        document.getElementById('badge-miembros-mobile').textContent = totalMiembros;
        
        // Sincronizar stats en el menú hamburguesa
        document.getElementById('nav-rama-nombre').textContent = nombreRama;
        document.getElementById('nav-badge-nidos').textContent = allNidos.length;
        document.getElementById('nav-badge-miembros').textContent = totalMiembros;
        
        // Ocultar Plan si no es admin de rama
        const isAdminRama = userData.rol === 'adminRama' || 
          userData.rol === 'adminSistema' ||
          (currentFamilia?.adminsGenerales?.includes(currentUser.uid)) ||
          (currentFamilia?.fundador === currentUser.uid) ||
          (currentFamilia?.creador === currentUser.uid);
        
        const planCol = document.getElementById('plan-col');
        if (planCol && !isAdminRama) {
          planCol.classList.add('hidden-no-admin');
        }

        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');

        // Mostrar modal de Primeros Pasos si es necesario
        verificarPrimerosPasos();

        if (miNidoPrincipal) {
          renderMiNido(miNidoPrincipal);
        }

      } catch (error) {
        console.error('Error loading nidos:', error);
        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
      }
    }

    // ============ RENDER MI NIDO ============
    function renderMiNido(nido) {
      const genLabels = {
        '1-bisabuelos': 'Bisabuelos',
        '2-abuelos': 'Abuelos',
        '3-padres': 'Padres',
        '4-hijos': 'Hijos'
      };

      document.getElementById('nido-nombre').textContent = nido.nombre || 'Mi Nido';
      document.getElementById('nido-desc').textContent = genLabels[nido.generacion] || '';

      const relacionLabels = {
        'progenitor': 'Prog.', 'descendiente': 'Hijo/a', 'hijo': 'Hijo/a',
        'ascendiente': 'Asc.', 'colateral': 'Col.', 'otros': ''
      };

      const container = document.getElementById('miembros-compact');
      
      if (!nido.miembrosData || nido.miembrosData.length === 0) {
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">👥</div>Sin miembros</div>';
        return;
      }

      container.innerHTML = nido.miembrosData.slice(0, 6).map(m => {
        const fallecido = m.fechaDefuncion ? 'fallecido' : '';
        const rel = relacionLabels[m.relacion || m.rol] || '';
        return `
          <div class="miembro-mini">
            <div class="miembro-mini-avatar ${fallecido}">${m.iniciales || '?'}</div>
            <div class="miembro-mini-info">
              <div class="miembro-mini-name">${m.nombre || m.iniciales}</div>
              <div class="miembro-mini-rel">${rel}</div>
            </div>
          </div>
        `;
      }).join('');

      if (nido.miembrosData.length > 6) {
        container.innerHTML += `<div style="text-align:center;font-size:0.7rem;color:var(--text-muted);padding:4px;">+${nido.miembrosData.length - 6} más</div>`;
      }
    }

    // ============ CALENDARIO ============
    let eventosCalendario = [];
    let configCalendarioCGI = null; // Config de tipos de reserva y colores

    // TIPOS FIJOS - Siempre usar estos, ignorar config de Firebase
    const TIPOS_FIJOS = {
      mayordomo: [
        { id: 'estancia-familiar', nombre: 'Estancias familiares', emoji: '🏠', color: '#7A9E7E', esFamiliar: true },
        { id: 'estancias', nombre: 'Estancias familiares', emoji: '🏠', color: '#7A9E7E', esFamiliar: true },
        { id: 'familiar', nombre: 'Estancias familiares', emoji: '🏠', color: '#7A9E7E', esFamiliar: true },
        { id: 'evento', nombre: 'Eventos', emoji: '🎉', color: '#2196F3', esFamiliar: false },
        { id: 'celebraciones', nombre: 'Eventos', emoji: '🎉', color: '#2196F3', esFamiliar: false },
        { id: 'otros', nombre: 'Otros', emoji: '📋', color: '#FF9800', esFamiliar: false }
      ],
      gerente: [
        { id: 'reserva-familiar', nombre: 'Reservas familiares', emoji: '👨‍👩‍👧‍👦', color: '#FF9800', esFamiliar: true },
        { id: 'reserva-huespedes', nombre: 'Reservas huéspedes', emoji: '🏨', color: '#8D6E63', esFamiliar: false },
        { id: 'actividad', nombre: 'Actividad', emoji: '🎯', color: '#2196F3', esFamiliar: false }
      ],
      capataz: [
        { id: 'caceria', nombre: 'Cacerías', emoji: '🦌', color: '#7A9E7E', esFamiliar: false },
        { id: 'recoleccion', nombre: 'Recolecciones', emoji: '🌾', color: '#FF9800', esFamiliar: false },
        { id: 'otras-actividades', nombre: 'Otras actividades', emoji: '🎯', color: '#2196F3', esFamiliar: false }
      ]
    };

    // Helper para obtener color según tipo
    function getColorPorTipo(tipoId, addonActivo) {
      const tipos = TIPOS_FIJOS[addonActivo] || TIPOS_FIJOS.mayordomo;
      const tipo = tipos.find(t => t.id === tipoId);
      return tipo ? tipo.color : '#7A9E7E';
    }

    // Helper para obtener emoji según tipo
    function getEmojiPorTipo(tipoId, addonActivo) {
      const tipos = TIPOS_FIJOS[addonActivo] || TIPOS_FIJOS.mayordomo;
      const tipo = tipos.find(t => t.id === tipoId);
      return tipo ? tipo.emoji : '🏠';
    }

    // Helper para aclarar color (para borradores)
    function aclararColor(hex, percent = 40) {
      const num = parseInt(hex.replace('#', ''), 16);
      const r = Math.min(255, (num >> 16) + Math.round((255 - (num >> 16)) * percent / 100));
      const g = Math.min(255, ((num >> 8) & 0x00FF) + Math.round((255 - ((num >> 8) & 0x00FF)) * percent / 100));
      const b = Math.min(255, (num & 0x0000FF) + Math.round((255 - (num & 0x0000FF)) * percent / 100));
      return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
    }

    // Helper para verificar visibilidad de un elemento
    function esVisibleParaUsuario(item, nidosMap) {
      // Admin-rama ve TODOS los items
      if (esAdminRama) return true;
      
      const visibilidad = item.visibilidad || 'rama';
      
      // Rama: visible para todos
      if (visibilidad === 'rama') return true;
      
      // Nido: solo visible si es del mismo nido
      if (visibilidad === 'nido') {
        return item.nidoId === miNidoPrincipal?.id;
      }
      
      // Estirpe: visible si mi nido desciende del nido creador
      if (visibilidad === 'estirpe') {
        if (!miNidoPrincipal) return false;
        // Construir cadena de ancestros de mi nido
        const misAncestros = new Set();
        let nidoActual = miNidoPrincipal.id;
        misAncestros.add(nidoActual);
        while (nidoActual && nidosMap[nidoActual]?.nidoOrigen) {
          nidoActual = nidosMap[nidoActual].nidoOrigen;
          misAncestros.add(nidoActual);
        }
        // También incluir mis descendientes
        const misDescendientes = new Set([miNidoPrincipal.id]);
        Object.values(nidosMap).forEach(n => {
          if (n.nidoOrigen === miNidoPrincipal.id) misDescendientes.add(n.id);
        });
        // El item es visible si su nidoId está en mis ancestros o descendientes
        return misAncestros.has(item.nidoId) || misDescendientes.has(item.nidoId);
      }
      
      return true;
    }

    async function cargarEventosCalendario() {
      if (!currentFamilia) return;
      eventosCalendario = [];
      const añoActual = new Date().getFullYear();

      try {
        // Cargar y parsear config del calendario
        try {
          const configDoc = await db.collection('familias').doc(currentFamilia.id)
            .collection('config').doc('calendarioFamiliar').get();
          if (configDoc.exists) {
            const rawConfig = configDoc.data();
            
            // Parsear estructura {tiposAddon: {addon: {tipo: {visibleCGI, color}}}}
            configCalendarioCGI = {
              hitos: {},
              tiposAddon: {},
              externos: {}
            };
            
            if (rawConfig.tiposAddon) {
              // Hitos familiares
              if (rawConfig.tiposAddon.hitos) {
                configCalendarioCGI.hitos = rawConfig.tiposAddon.hitos;
              }
              
              // Add-ons de reserva
              ['mayordomo', 'gerente', 'capataz'].forEach(addon => {
                if (rawConfig.tiposAddon[addon]) {
                  configCalendarioCGI.tiposAddon[addon] = [];
                  Object.entries(rawConfig.tiposAddon[addon]).forEach(([tipoId, tipoData]) => {
                    configCalendarioCGI.tiposAddon[addon].push({
                      id: tipoId,
                      visibleCGI: tipoData.visibleCGI || false,
                      color: tipoData.color || '#7A9E7E',
                      emoji: tipoData.emoji || '📋',
                      nombre: tipoData.nombre || tipoId
                    });
                  });
                }
              });
              
              // Externos
              if (rawConfig.tiposAddon.externos) {
                configCalendarioCGI.externos = {
                  mostrarLibranzas: rawConfig.tiposAddon.externos.libranzas?.visibleCGI || false,
                  mostrarVacaciones: rawConfig.tiposAddon.externos.vacaciones?.visibleCGI || false
                };
              }
            }
          }
        } catch (e) { console.warn('Config calendario no disponible'); }
        
        // Helper para verificar visibilidad de hitos
        const esHitoVisible = (tipoHito) => {
          if (!configCalendarioCGI?.hitos) return true; // Sin config = todo visible
          return configCalendarioCGI.hitos[tipoHito]?.visibleCGI !== false;
        };

        // Cargar mapa de nidos para verificar estirpes
        const nidosSnap = await db.collection('nidos').where('familiaId', '==', currentFamilia.id).get();
        const nidosMap = {};
        nidosSnap.docs.forEach(doc => {
          nidosMap[doc.id] = { id: doc.id, ...doc.data() };
        });

        // CUMPLEAÑOS desde miembros de nidos (solo si visibleCGI)
        if (esHitoVisible('cumpleanos')) {
          const colorCumple = configCalendarioCGI?.hitos?.cumpleanos?.color || '#E91E63';
          nidosSnap.docs.forEach(doc => {
            const nido = { id: doc.id, ...doc.data() };
            const nidoVisible = esVisibleParaUsuario({ visibilidad: 'estirpe', nidoId: nido.id }, nidosMap);
            if (!nidoVisible) return;
            
            (nido.miembrosData || []).forEach(m => {
              if (m.fechaNacimiento) {
                const partes = m.fechaNacimiento.split('-');
                if (partes.length >= 3) {
                  const mes = partes[1], dia = partes[2];
                  [añoActual, añoActual+1].forEach(y => {
                    eventosCalendario.push({ 
                      tipo:'cumple', 
                      color: colorCumple,
                      titulo:`🎂 ${m.nombre || 'Cumpleaños'}`, 
                      fecha:`${y}-${mes}-${dia}` 
                    });
                  });
                }
              }
            });
          });
        }

        // DÍAS ESPECIALES (solo si eventosYCitas visible)
        if (esHitoVisible('eventosYCitas')) {
          const colorEventos = configCalendarioCGI?.hitos?.eventosYCitas?.color || '#FF9800';
          try {
            const diasSnap = await db.collection('diasEspeciales').where('familiaId', '==', currentFamilia.id).get();
            diasSnap.docs.forEach(doc => {
              const d = { id: doc.id, ...doc.data() };
              if (!esVisibleParaUsuario(d, nidosMap)) return;
              
              [añoActual, añoActual+1].forEach(y => {
                eventosCalendario.push({ 
                  tipo: 'especial',
                  color: colorEventos,
                  titulo: `🎉 ${d.nombre}`, 
                  fecha: `${y}-${String(d.mes).padStart(2,'0')}-${String(d.dia).padStart(2,'0')}` 
                });
              });
            });
          } catch (e) {
            console.warn('Error cargando días especiales (ignorado)');
          }

          // EVENTOS
          try {
            const eventosSnap = await db.collection('eventos').where('familiaId', '==', currentFamilia.id).get();
            eventosSnap.docs.forEach(doc => {
              const e = { id: doc.id, ...doc.data() };
              if (!esVisibleParaUsuario(e, nidosMap)) return;
              
              if (e.fecha) eventosCalendario.push({ 
                tipo:'evento', 
                color: colorEventos,
                titulo: `🎊 ${e.nombre}`, 
                fecha: e.fecha, 
                hora: e.hora 
              });
            });
          } catch (e) {
            console.warn('Error cargando eventos (ignorado)');
          }

          // CITAS
          try {
            const citasSnap = await db.collection('citas').where('familiaId', '==', currentFamilia.id).get();
            citasSnap.docs.forEach(doc => {
              const c = { id: doc.id, ...doc.data() };
              if (!esVisibleParaUsuario(c, nidosMap)) return;
              
              if (c.fecha) eventosCalendario.push({ 
                tipo:'cita', 
                color: colorEventos,
                titulo: `📋 ${c.titulo}`, 
                fecha: c.fecha, 
                hora: c.hora 
              });
            });
          } catch (e) {
            console.warn('Error cargando citas (ignorado)');
          }
        }

        // RESERVAS de bienes (con colores dinámicos de config)
        try {
          const bienesSnap = await db.collection('bienes').where('familiaId', '==', currentFamilia.id).get();
          for (const bienDoc of bienesSnap.docs) {
            const bien = bienDoc.data();
            
            // Determinar add-on activo
            let addonActivo = null;
            if (bien.mayordomoActivo) addonActivo = 'mayordomo';
            else if (bien.gerenteActivo) addonActivo = 'gerente';
            else if (bien.capatazActivo) addonActivo = 'capataz';
            
            // Leer de AMBAS colecciones: reservas + estancias
            let allReservaDocs = [];
            
            try {
              const reservasSnap = await db.collection('bienes').doc(bienDoc.id).collection('reservas').get();
              allReservaDocs = allReservaDocs.concat(reservasSnap.docs);
            } catch (e) { console.warn('Error reservas:', e); }
            
            try {
              const estanciasSnap = await db.collection('bienes').doc(bienDoc.id).collection('estancias').get();
              allReservaDocs = allReservaDocs.concat(estanciasSnap.docs);
            } catch (e) { console.warn('Error estancias:', e); }
            
            allReservaDocs.forEach(resDoc => {
              const r = { id: resDoc.id, ...resDoc.data() };
              if (!esVisibleParaUsuario(r, nidosMap)) return;
              
              const fechaEntrada = r.fechaInicio;
              const fechaSalida = r.fechaFin;
              
              if (fechaEntrada) {
                const fechaStr = fechaEntrada.toDate ? 
                  fechaEntrada.toDate().toISOString().split('T')[0] : fechaEntrada;
                const fechaFinStr = fechaSalida ? 
                  (fechaSalida.toDate ? fechaSalida.toDate().toISOString().split('T')[0] : fechaSalida) : null;
                
                // Usar TIPOS_FIJOS para color y emoji
                const tipoId = r.tipoReserva || (r.tipo !== 'solicitud' ? r.tipo : null) || 'estancia-familiar';
                const estado = r.estado || 'borrador';
                
                let colorBase = getColorPorTipo(tipoId, addonActivo || 'mayordomo');
                const emoji = getEmojiPorTipo(tipoId, addonActivo || 'mayordomo');
                
                // Color claro para borrador/pendiente, oscuro para enviado/confirmada
                const esBorrador = estado === 'borrador' || estado === 'pendiente';
                const color = esBorrador ? aclararColor(colorBase, 40) : colorBase;
                
                // Texto descriptivo: priorizar nombre > titulo > quien > etc
                const quienReserva = r.nombre || r.titulo || r.nidoReservaNombre || r.quienesNombre || r.otroGrupoNombre || r.nidoNombre || r.quien || r.motivo || r.solicitadoPorNombre || '';
                
                let descripcion = quienReserva || bien.nombre || 'Reserva';
                
                eventosCalendario.push({ 
                  tipo: 'reserva',
                  subtipo: tipoId,
                  color: color,
                  titulo: `${emoji} ${descripcion}`, 
                  fecha: fechaStr,
                  fechaFin: fechaFinStr,
                  solicitante: r.solicitadoPorNombre || '',
                  estado: estado
                });
              }
            });
            
            // EXTERNOS: Libranzas y Vacaciones (si están habilitados)
            if (configCalendarioCGI?.externos?.mostrarLibranzas || configCalendarioCGI?.externos?.mostrarVacaciones) {
              // Cargar caseros
              try {
                const caserosSnap = await db.collection('bienes').doc(bienDoc.id)
                  .collection('caseros').where('activo', '==', true).get();
                
                caserosSnap.docs.forEach(caseroDoc => {
                  const casero = caseroDoc.data();
                  const nombreCasero = casero.nombre || 'Casero';
                  
                  // Libranzas semanales (próximos 14 días para CGI)
                  if (configCalendarioCGI.externos.mostrarLibranzas && casero.libranzas?.diasSemana?.length > 0) {
                    const diasSemanaMap = { 'L': 1, 'M': 2, 'X': 3, 'J': 4, 'V': 5, 'S': 6, 'D': 0 };
                    
                    casero.libranzas.diasSemana.forEach(dia => {
                      const diaNum = diasSemanaMap[dia];
                      if (diaNum === undefined) return;
                      
                      for (let i = 0; i < 14; i++) {
                        const fechaCheck = new Date();
                        fechaCheck.setDate(fechaCheck.getDate() + i);
                        
                        if (fechaCheck.getDay() === diaNum) {
                          const fechaStr = fechaCheck.toISOString().split('T')[0];
                          eventosCalendario.push({
                            tipo: 'externo',
                            subtipo: 'libranza',
                            color: '#607D8B',
                            titulo: `👤 Libranza: ${nombreCasero}`,
                            fecha: fechaStr,
                            esExterno: true
                          });
                        }
                      }
                    });
                  }
                  
                  // Vacaciones
                  if (configCalendarioCGI.externos.mostrarVacaciones && casero.vacaciones?.bloques?.length > 0) {
                    casero.vacaciones.bloques.forEach(bloque => {
                      if (!bloque.inicio) return;
                      eventosCalendario.push({
                        tipo: 'externo',
                        subtipo: 'vacaciones',
                        color: '#607D8B',
                        titulo: `👤 Vacaciones: ${nombreCasero}`,
                        fecha: bloque.inicio,
                        fechaFin: bloque.fin,
                        esExterno: true
                      });
                    });
                  }
                });
              } catch (e) { console.warn('Error cargando caseros para calendario'); }
              
              // Cargar hosters
              try {
                const hostersSnap = await db.collection('bienes').doc(bienDoc.id)
                  .collection('hosters').where('activo', '==', true).get();
                
                hostersSnap.docs.forEach(hosterDoc => {
                  const hoster = hosterDoc.data();
                  const nombreHoster = hoster.nombre || 'Hoster';
                  
                  if (configCalendarioCGI.externos.mostrarLibranzas && hoster.libranzas?.diasSemana?.length > 0) {
                    const diasSemanaMap = { 'L': 1, 'M': 2, 'X': 3, 'J': 4, 'V': 5, 'S': 6, 'D': 0 };
                    
                    hoster.libranzas.diasSemana.forEach(dia => {
                      const diaNum = diasSemanaMap[dia];
                      if (diaNum === undefined) return;
                      
                      for (let i = 0; i < 14; i++) {
                        const fechaCheck = new Date();
                        fechaCheck.setDate(fechaCheck.getDate() + i);
                        
                        if (fechaCheck.getDay() === diaNum) {
                          const fechaStr = fechaCheck.toISOString().split('T')[0];
                          eventosCalendario.push({
                            tipo: 'externo',
                            subtipo: 'libranza',
                            color: '#607D8B',
                            titulo: `👤 Libranza: ${nombreHoster}`,
                            fecha: fechaStr,
                            esExterno: true
                          });
                        }
                      }
                    });
                  }
                  
                  if (configCalendarioCGI.externos.mostrarVacaciones && hoster.vacaciones?.bloques?.length > 0) {
                    hoster.vacaciones.bloques.forEach(bloque => {
                      if (!bloque.inicio) return;
                      eventosCalendario.push({
                        tipo: 'externo',
                        subtipo: 'vacaciones',
                        color: '#607D8B',
                        titulo: `👤 Vacaciones: ${nombreHoster}`,
                        fecha: bloque.inicio,
                        fechaFin: bloque.fin,
                        esExterno: true
                      });
                    });
                  }
                });
              } catch (e) { console.warn('Error cargando hosters para calendario'); }
            }
          }
        } catch (e) {
          console.warn('Error cargando reservas (ignorado)');
        }
      } catch (error) {
        console.warn('Error cargando calendario (ignorado):', error);
      }
    }

    let calendarioExpandido = false;

    function renderCalendario() {
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const hoy = new Date();
      
      // Actualizar título según vista
      document.getElementById('mes-actual').textContent = calendarioExpandido ? meses[hoy.getMonth()] : 'Próximos días';

      // Renderizar vista compacta (Hoy, Mañana, Pasado)
      renderCalendarioCompacto();
      
      // Renderizar vista expandida (cuadrícula del mes)
      renderCalendarioExpandido();
    }

    function renderCalendarioCompacto() {
      const container = document.getElementById('calendario-compacto');
      if (!container) return;
      
      const hoy = new Date();
      const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
      const meses = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
      
      // Agrupar eventos por fecha (incluir eventos con rango)
      const eventosPorFecha = {};
      eventosCalendario.forEach(e => {
        // Añadir a fecha de inicio
        if (!eventosPorFecha[e.fecha]) eventosPorFecha[e.fecha] = [];
        eventosPorFecha[e.fecha].push(e);
        
        // Si tiene fechaFin, añadir a todos los días del rango
        if (e.fechaFin && e.fechaFin !== e.fecha) {
          let fechaActual = new Date(e.fecha);
          const fechaFinDate = new Date(e.fechaFin);
          fechaActual.setDate(fechaActual.getDate() + 1);
          
          while (fechaActual <= fechaFinDate) {
            const fechaStr = fechaActual.toISOString().split('T')[0];
            if (!eventosPorFecha[fechaStr]) eventosPorFecha[fechaStr] = [];
            eventosPorFecha[fechaStr].push({...e, esContinuacion: true});
            fechaActual.setDate(fechaActual.getDate() + 1);
          }
        }
      });
      
      let html = '<div class="proximos-dias">';
      
      for (let i = 0; i < 3; i++) {
        const fecha = new Date(hoy);
        fecha.setDate(hoy.getDate() + i);
        
        const fechaStr = fecha.getFullYear() + '-' + String(fecha.getMonth()+1).padStart(2,'0') + '-' + String(fecha.getDate()).padStart(2,'0');
        const eventosDelDia = eventosPorFecha[fechaStr] || [];
        
        let label = '';
        if (i === 0) label = 'Hoy';
        else if (i === 1) label = 'Mañana';
        else label = 'Pasado';
        
        const fechaFormateada = diasSemana[fecha.getDay()] + ' ' + fecha.getDate() + ' ' + meses[fecha.getMonth()];
        
        html += '<div class="dia-grupo ' + (i === 0 ? 'hoy' : '') + '">';
        html += '<div class="dia-header">';
        html += '<span class="dia-label">' + label + '</span>';
        html += '<span class="dia-fecha">' + fechaFormateada + '</span>';
        html += '</div>';
        html += '<div class="dia-eventos">';
        
        if (eventosDelDia.length === 0) {
          html += '<div class="dia-vacio">Sin eventos</div>';
        } else {
          const eventosAMostrar = eventosDelDia.slice(0, 4);
          
          eventosAMostrar.forEach(function(evento) {
            var tituloLimpio = evento.titulo || 'Sin título';
            
            // Indicador de color para reservas y externos
            let colorIndicator = '';
            if (evento.color) {
              colorIndicator = '<span class="color-dot" style="background:' + evento.color + '; width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px;"></span>';
            }
            
            // Clase adicional para externos
            let claseExtra = evento.esExterno ? 'hito-externo' : '';
            
            html += '<div class="hito-item ' + claseExtra + '" onclick="verDetalleHito(\'' + (evento.id || '') + '\', \'' + evento.tipo + '\', \'' + fechaStr + '\')" title="' + tituloLimpio + '">';
            html += '<div class="hito-info" style="display:flex; align-items:center;">';
            html += colorIndicator;
            html += '<div class="hito-titulo" style="flex:1;">' + tituloLimpio + '</div>';
            html += '</div>';
            if (evento.hora || evento.lugar) {
              html += '<div class="hito-meta">';
              if (evento.hora) html += '<span class="hito-hora">' + evento.hora + '</span>';
              if (evento.lugar) html += '<span>' + evento.lugar + '</span>';
              html += '</div>';
            }
            html += '</div>';
          });
          
          if (eventosDelDia.length > 4) {
            html += '<div class="dia-mas" onclick="window.location.href=\'calendario.html\'">+' + (eventosDelDia.length - 4) + ' más</div>';
          }
        }
        
        html += '</div>';
        html += '</div>';
      }
      
      html += '</div>';
      container.innerHTML = html;
    }

    function renderCalendarioExpandido() {
      const hoy = new Date();
      const container = document.getElementById('calendario-mini');
      if (!container) return;
      
      const dias = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
      
      let html = dias.map(d => `<div class="cal-header">${d}</div>`).join('');

      const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
      
      let diaInicio = primerDia.getDay();
      if (diaInicio === 0) diaInicio = 7;
      diaInicio--;

      const eventosPorFecha = {};
      eventosCalendario.forEach(e => {
        if (!eventosPorFecha[e.fecha]) eventosPorFecha[e.fecha] = [];
        eventosPorFecha[e.fecha].push(e);
      });

      const diasMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth(), 0).getDate();
      for (let i = diaInicio - 1; i >= 0; i--) {
        html += `<div class="cal-day other-month">${diasMesAnterior - i}</div>`;
      }

      for (let d = 1; d <= ultimoDia.getDate(); d++) {
        const esHoy = d === hoy.getDate();
        const fechaStr = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const eventosDelDia = eventosPorFecha[fechaStr] || [];
        
        const tiposParaDots = eventosDelDia.map(e => {
          if (e.tipo === 'reserva' && e.subtipo) return `reserva-${e.subtipo}`;
          return e.tipo;
        });
        const tiposUnicos = [...new Set(tiposParaDots)];
        const dotsHtml = tiposUnicos.length > 0 
          ? `<div class="cal-day-dots">${tiposUnicos.slice(0,3).map(t => `<div class="cal-dot ${t}"></div>`).join('')}</div>` 
          : '';
        
        html += `<div class="cal-day ${esHoy ? 'today' : ''} ${eventosDelDia.length > 0 ? 'has-events' : ''}">${d}${dotsHtml}</div>`;
      }

      container.innerHTML = html;
      renderEventosHoy(hoy);
    }

    function toggleVistaCalendario() {
      calendarioExpandido = !calendarioExpandido;
      
      const compacto = document.getElementById('calendario-compacto');
      const expandido = document.getElementById('calendario-expandido');
      const toggleIcono = document.getElementById('toggle-icono');
      const toggleTexto = document.getElementById('toggle-texto');
      const mesActual = document.getElementById('mes-actual');
      
      if (calendarioExpandido) {
        compacto.style.display = 'none';
        expandido.style.display = 'block';
        toggleIcono.textContent = '📋';
        toggleTexto.textContent = 'Ver próximos días';
        
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        mesActual.textContent = meses[new Date().getMonth()];
      } else {
        compacto.style.display = 'block';
        expandido.style.display = 'none';
        toggleIcono.textContent = '📆';
        toggleTexto.textContent = 'Ver mes completo';
        mesActual.textContent = 'Próximos días';
      }
    }

    function renderEventosHoy(fecha) {
      const container = document.getElementById('eventos-hoy');
      const fechaStr = `${fecha.getFullYear()}-${String(fecha.getMonth()+1).padStart(2,'0')}-${String(fecha.getDate()).padStart(2,'0')}`;
      
      const eventosHoy = eventosCalendario.filter(e => e.fecha === fechaStr);
      
      if (eventosHoy.length === 0) {
        container.innerHTML = `<div class="evento-mini"><div class="evento-dot cita"></div><span style="color:var(--text-muted);">Sin eventos hoy</span></div>`;
        return;
      }

      container.innerHTML = eventosHoy.slice(0, 3).map(e => {
        const claseColor = e.tipo === 'reserva' && e.subtipo ? `reserva-${e.subtipo}` : e.tipo;
        return `
        <div class="evento-mini" style="margin-bottom:4px;">
          <div class="evento-dot ${claseColor}"></div>
          <span>${e.titulo}${e.hora ? ` · ${e.hora}` : ''}</span>
        </div>
      `}).join('') + (eventosHoy.length > 3 ? `<div style="font-size:0.65rem;color:var(--text-muted);text-align:center;">+${eventosHoy.length - 3} más</div>` : '');
    }

    function renderCalendarioMovil() {
      const container = document.getElementById('calendario-movil');
      if (!container) return;
      
      const hoy = new Date();
      const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
      const meses = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
      
      // Iconos según tipo de evento
      const iconos = {
        'cumple': '🎂',
        'especial': '⭐',
        'evento': '🎉',
        'cita': '📋',
        'reserva': '🏠',
        'mantenimiento': '🔧',
        'default': '📌'
      };
      
      // Agrupar eventos por fecha
      const eventosPorFecha = {};
      eventosCalendario.forEach(e => {
        if (!eventosPorFecha[e.fecha]) eventosPorFecha[e.fecha] = [];
        eventosPorFecha[e.fecha].push(e);
      });
      
      // Generar HTML para HOY, MAÑANA, PASADO
      let html = '<div class="proximos-dias">';
      
      for (let i = 0; i < 3; i++) {
        const fecha = new Date(hoy);
        fecha.setDate(hoy.getDate() + i);
        
        const fechaStr = fecha.getFullYear() + '-' + String(fecha.getMonth()+1).padStart(2,'0') + '-' + String(fecha.getDate()).padStart(2,'0');
        const eventosDelDia = eventosPorFecha[fechaStr] || [];
        
        // Label del día
        let label = '';
        if (i === 0) label = 'Hoy';
        else if (i === 1) label = 'Mañana';
        else label = 'Pasado';
        
        // Fecha formateada
        const fechaFormateada = diasSemana[fecha.getDay()] + ' ' + fecha.getDate() + ' ' + meses[fecha.getMonth()];
        
        html += '<div class="dia-grupo ' + (i === 0 ? 'hoy' : '') + '">';
        html += '<div class="dia-header">';
        html += '<span class="dia-label">' + label + '</span>';
        html += '<span class="dia-fecha">' + fechaFormateada + '</span>';
        html += '</div>';
        html += '<div class="dia-eventos">';
        
        if (eventosDelDia.length === 0) {
          html += '<div class="dia-vacio">Sin eventos</div>';
        } else {
          // Mostrar hasta 3 eventos
          const eventosAMostrar = eventosDelDia.slice(0, 3);
          
          eventosAMostrar.forEach(function(evento) {
            const icono = iconos[evento.tipo] || iconos.default;
            // Usar título tal cual viene (ya formateado)
            var tituloLimpio = evento.titulo || 'Sin título';
            
            html += '<div class="hito-item" onclick="verDetalleHito(\'' + (evento.id || '') + '\', \'' + evento.tipo + '\', \'' + fechaStr + '\')" title="' + tituloLimpio + '">';
            html += '<span class="hito-icono">' + icono + '</span>';
            html += '<div class="hito-info">';
            html += '<div class="hito-titulo">' + tituloLimpio + '</div>';
            html += '<div class="hito-meta">';
            if (evento.hora) {
              html += '<span class="hito-hora">' + evento.hora + '</span>';
            }
            if (evento.lugar) {
              html += '<span>' + evento.lugar + '</span>';
            }
            html += '</div>';
            html += '</div>';
            html += '</div>';
          });
          
          // Si hay más de 3
          if (eventosDelDia.length > 3) {
            html += '<div class="dia-mas" onclick="window.location.href=\'calendario.html\'">+' + (eventosDelDia.length - 3) + ' más</div>';
          }
        }
        
        html += '</div>';
        html += '</div>';
      }
      
      // Botón ver más
      html += '</div>';
      html += '<div class="calendario-ver-mas">';
      html += '<button class="btn-ver-calendario" onclick="window.location.href=\'calendario.html\'">';
      html += '<span>📆</span> Ver semana completa';
      html += '</button>';
      html += '</div>';
      
      container.innerHTML = html;
    }
    
    // Función para ver detalle de un hito (abre modal o navega)
    function verDetalleHito(id, tipo, fecha) {
      // Navegar al calendario con la fecha seleccionada
      window.location.href = 'calendario.html?fecha=' + fecha;
    }

    // ============ TAREAS (REAL) ============
    let tareasData = [];

    async function renderTareas() {
      const container = document.getElementById('tareas-list');
      
      if (!miNidoPrincipal || !currentFamilia || !currentUser) {
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">📋</div>Selecciona un nido</div>';
        return;
      }

      try {
        // Cargar tareas asignadas al usuario actual
        const snap = await db.collection('tareas')
          .where('familiaId', '==', currentFamilia.id)
          .where('completada', '==', false)
          .orderBy('fechaCreacion', 'desc')
          .limit(20)
          .get();

        // Filtrar solo las asignadas a mí (por UID o por nombre/email)
        const userData = (await db.collection('usuarios').doc(currentUser.uid).get()).data() || {};
        const miNombre = userData.nombre || userData.displayName || '';
        const miEmail = currentUser.email || '';

        tareasData = snap.docs
          .map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(t => {
            // Si no tiene asignadoA, no la muestro
            if (!t.asignadoA && !t.asignadoUID) return false;
            // Coincide por UID
            if (t.asignadoUID === currentUser.uid) return true;
            // Coincide por nombre o email
            const asignado = (t.asignadoA || '').toLowerCase();
            return asignado === miNombre.toLowerCase() || 
                   asignado === miEmail.toLowerCase() ||
                   asignado.includes(miNombre.toLowerCase());
          })
          .slice(0, 5);

        if (tareasData.length === 0) {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">✅</div>Sin tareas asignadas</div>';
          return;
        }

        container.innerHTML = tareasData.map(t => `
          <div class="tarea-item" onclick="toggleTarea('${t.id}')">
            <div class="tarea-check ${t.completada ? 'done' : ''}">${t.completada ? '✓' : ''}</div>
            <div class="tarea-content">
              <div class="tarea-titulo ${t.completada ? 'done' : ''}">${t.titulo}</div>
              <div class="tarea-asignado">${t.asignadoA || 'Para mí'}</div>
            </div>
            <div class="tarea-prioridad ${t.prioridad || 'media'}"></div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error cargando tareas:', error);
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">⚠️</div>Error al cargar</div>';
      }
    }

    async function toggleTarea(tareaId) {
      try {
        const tarea = tareasData.find(t => t.id === tareaId);
        if (!tarea) return;

        await db.collection('tareas').doc(tareaId).update({
          completada: !tarea.completada,
          fechaCompletada: !tarea.completada ? firebase.firestore.FieldValue.serverTimestamp() : null
        });

        renderTareas();
      } catch (error) {
        console.error('Error actualizando tarea:', error);
      }
    }

    // ============ BUZÓN (REAL) ============
    let mensajesData = [];

    async function renderMensajes() {
      const container = document.getElementById('mensajes-list');
      
      if (!container) {
        console.warn('renderMensajes: Container no encontrado');
        return;
      }
      
      if (!currentUser || !currentFamilia) {
        console.warn('renderMensajes: No hay usuario o familia');
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">💬</div>Sin conversaciones</div>';
        return;
      }

      try {
        console.log('Cargando conversaciones para:', currentUser.uid);
        // Cargar conversaciones del chat
        const snap = await db.collection('conversaciones')
          .where('participantes', 'array-contains', currentUser.uid)
          .limit(4)
          .get();

        let conversaciones = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        console.log('Conversaciones encontradas:', conversaciones.length);
        
        // Ordenar por último mensaje
        conversaciones.sort((a, b) => {
          const fechaA = a.ultimoMensaje?.fecha?.toDate?.() || new Date(0);
          const fechaB = b.ultimoMensaje?.fecha?.toDate?.() || new Date(0);
          return fechaB - fechaA;
        });

        if (conversaciones.length === 0) {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">💬</div>Sin conversaciones</div>';
          return;
        }

        container.innerHTML = conversaciones.map(c => {
          const tieneNoLeidos = c.noLeidosPor?.includes(currentUser.uid);
          let avatar = '👤';
          if (c.tipo === 'nido') avatar = '🪺';
          else if (c.tipo === 'grupo') avatar = '👥';
          
          const nombre = c.nombre || 'Chat';
          const tiempo = formatearTiempo(c.ultimoMensaje?.fecha);
          const preview = c.ultimoMensaje?.texto || 'Sin mensajes';
          
          return `
            <div class="mensaje-item ${tieneNoLeidos ? 'no-leido' : ''}" onclick="abrirChat('${c.id}')">
              <div class="mensaje-avatar">${avatar}</div>
              <div class="mensaje-content">
                <div class="mensaje-from">${nombre}</div>
                <div class="mensaje-preview">${preview.substring(0, 35)}...</div>
              </div>
              <span class="mensaje-time">${tiempo}</span>
              ${tieneNoLeidos ? '<div class="mensaje-badge"></div>' : ''}
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error cargando conversaciones:', error);
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">💬</div>Sin conversaciones</div>';
      }
    }

    function abrirChat(convId) {
      window.location.href = `chat.html?conv=${convId}`;
    }

    function formatearTiempo(timestamp) {
      if (!timestamp) return '';
      const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const hoy = new Date();
      
      if (fecha.toDateString() === hoy.toDateString()) {
        return fecha.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
      }
      
      const ayer = new Date(hoy);
      ayer.setDate(ayer.getDate() - 1);
      if (fecha.toDateString() === ayer.toDateString()) {
        return 'Ayer';
      }
      
      return fecha.toLocaleDateString('es', { day: 'numeric', month: 'short' });
    }

    // ============ CARD MIS RESERVAS (resumen) ============
    async function cargarMisReservasResumen() {
      const container = document.getElementById('mis-reservas-resumen');
      if (!container) { console.warn('❌ Mis Reservas: container no encontrado'); return; }
      if (!currentUser) { console.warn('❌ Mis Reservas: currentUser no disponible'); return; }
      if (!currentFamilia) { console.warn('❌ Mis Reservas: currentFamilia no disponible'); return; }

      console.log('🔍 Mis Reservas: buscando para uid:', currentUser.uid, 'familia:', currentFamilia.id);

      try {
        // DATO ÚNICO: collectionGroup para mis reservas activas
        const snap = await db.collectionGroup('reservas')
          .where('solicitadoPor', '==', currentUser.uid)
          .where('familiaId', '==', currentFamilia.id)
          .get();

        console.log('✅ Mis Reservas: encontradas', snap.size, 'docs');
        snap.docs.forEach(doc => {
          const d = doc.data();
          console.log('  📄', doc.id, '| estado:', d.estado, '| tipo:', d.tipo, '| tipoReserva:', d.tipoReserva, '| path:', doc.ref.path);
        });

        // Filtrar solo activas (no canceladas)
        const activas = snap.docs
          .map(doc => {
            const data = doc.data();
            const pathParts = doc.ref.path.split('/');
            return { id: doc.id, bienId: pathParts[1] || null, ...data };
          })
          .filter(r => r.estado !== 'cancelada')
          .sort((a, b) => {
            // Futuras primero, luego por fecha
            const fa = a.fechaInicio || '';
            const fb = b.fechaInicio || '';
            return fa > fb ? 1 : -1;
          });

        if (activas.length === 0) {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">📅</div>Sin reservas activas</div>';
          return;
        }

        // Contar por estado
        const pendientes = activas.filter(r => r.estado === 'pendiente').length;
        const aprobadas = activas.filter(r => ['aprobada', 'confirmada'].includes(r.estado)).length;
        const borradores = activas.filter(r => r.estado === 'borrador').length;

        // Mostrar resumen + últimas 3
        let html = '<div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">';
        if (pendientes > 0) html += `<span style="background:#FEF3C7;color:#92400E;padding:2px 10px;border-radius:12px;font-size:0.8rem;font-weight:600;">⏳ ${pendientes} pendiente${pendientes > 1 ? 's' : ''}</span>`;
        if (aprobadas > 0) html += `<span style="background:#D1FAE5;color:#065F46;padding:2px 10px;border-radius:12px;font-size:0.8rem;font-weight:600;">✅ ${aprobadas} aprobada${aprobadas > 1 ? 's' : ''}</span>`;
        if (borradores > 0) html += `<span style="background:#F3F4F6;color:#6B7280;padding:2px 10px;border-radius:12px;font-size:0.8rem;font-weight:600;">📝 ${borradores} borrador${borradores > 1 ? 'es' : ''}</span>`;
        html += '</div>';

        // Últimas 3 reservas
        const ultimas = activas.slice(0, 3);
        ultimas.forEach(r => {
          const estadoColor = r.estado === 'pendiente' ? '#f59e0b' : ['aprobada', 'confirmada'].includes(r.estado) ? '#22c55e' : '#9CA3AF';
          const fechas = r.fechaInicio ? `${r.fechaInicio} → ${r.fechaFin || '?'}` : 'Sin fechas';
          html += `
            <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--cream-dark);">
              <div style="width:4px;height:32px;border-radius:2px;background:${estadoColor};flex-shrink:0;"></div>
              <div style="flex:1;min-width:0;">
                <div style="font-weight:600;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.nombre || r.bienNombre || 'Reserva'}</div>
                <div style="font-size:0.75rem;color:var(--text-muted);">${fechas}</div>
              </div>
            </div>`;
        });

        if (activas.length > 3) {
          html += `<div style="text-align:center;padding-top:6px;font-size:0.8rem;color:var(--sage-dark);">+ ${activas.length - 3} más</div>`;
        }

        container.innerHTML = html;

      } catch (error) {
        console.error('❌ Error cargando resumen reservas:', error);
        if (error.code === 'failed-precondition' || error.message?.includes('index')) {
          // Firebase incluye URL para crear el índice en el mensaje de error
          const urlMatch = error.message?.match(/(https:\/\/console\.firebase\.google\.com[^\s]+)/);
          const enlace = urlMatch ? `<br><a href="${urlMatch[1]}" target="_blank" style="color:var(--sage-dark);font-size:0.7rem;">Crear índice →</a>` : '';
          container.innerHTML = `<div class="empty-mini"><div class="empty-mini-icon">⚠️</div>Índice pendiente${enlace}</div>`;
        } else {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">📅</div>Sin reservas</div>';
        }
      }
    }

    // ============ TABLÓN (REAL) ============
    let notificacionesData = [];

    async function renderTablon() {
      console.log('=== RENDER TABLÓN (consulta directa) ===');
      const container = document.getElementById('tablon-list');
      
      if (!container) {
        console.warn('renderTablon: Container no encontrado');
        return;
      }
      
      if (!currentFamilia) {
        console.warn('renderTablon: No hay familia activa');
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">📢</div>Sin novedades</div>';
        return;
      }

      const familiaId = currentFamilia.id;
      const miUid = currentUser.uid;
      
      // Verificar si soy admin
      const miUsuario = await db.collection('usuarios').doc(miUid).get();
      const misDatos = miUsuario.exists ? miUsuario.data() : {};
      const rolLower = String(misDatos.rol || '').toLowerCase();
      const credencialLower = String(misDatos.credencial || '').toLowerCase();
      // Incluir admin, matriarca y patriarca
      const soyAdmin = rolLower.includes('admin') || credencialLower.includes('admin') || 
                       rolLower === 'matriarca' || rolLower === 'patriarca' ||
                       credencialLower === 'matriarca' || credencialLower === 'patriarca' ||
                       misDatos.esAdmin === true || misDatos.adminRama === true || misDatos.superAdmin === true;
      
      console.log('Soy admin/matriarca/patriarca:', soyAdmin, 'Rol:', misDatos.rol, 'Credencial:', misDatos.credencial);

      try {
        let itemsAccion = [];
        let itemsInfo = [];
        
        // ========== PARA ADMINS: Solicitudes pendientes ==========
        if (soyAdmin) {
          try {
            // Solicitudes genéricas (iniciativas, averías, encargos, eventos)
            const solicitudesSnap = await db.collection('solicitudes')
              .where('familiaId', '==', familiaId)
              .where('estado', '==', 'pendiente')
              .orderBy('fechaCreacion', 'desc')
              .limit(20)
              .get();
            
            console.log('✅ Solicitudes pendientes:', solicitudesSnap.size);
            
            solicitudesSnap.docs.forEach(doc => {
              const data = doc.data();
              const icono = {
                'reserva': '📅',
                'evento': '🎉',
                'iniciativa': '💡',
                'averia': '🔧',
                'encargo': '🛒'
              }[data.tipo] || '📌';
              
              itemsAccion.push({
                id: doc.id,
                source: 'solicitud',
                tipo: 'accion',
                categoria: data.tipo,
                icono: icono,
                titulo: getTituloSolicitud(data),
                mensaje: `${data.solicitadoPorNombre || 'Usuario'} · ${data.solicitadoPorNido || ''}`,
                fecha: data.fechaCreacion,
                enlace: `solicitudes.html?id=${doc.id}`,
                data: data
              });
            });

            // DATO ÚNICO: Reservas pendientes desde bienes (collectionGroup)
            try {
              const reservasPendSnap = await db.collectionGroup('reservas')
                .where('familiaId', '==', familiaId)
                .where('estado', '==', 'pendiente')
                .get();
              
              console.log('✅ Reservas pendientes (collectionGroup):', reservasPendSnap.size);
              
              reservasPendSnap.docs.forEach(doc => {
                const data = doc.data();
                const pathParts = doc.ref.path.split('/');
                const bienId = pathParts.length >= 2 ? pathParts[1] : null;
                
                itemsAccion.push({
                  id: doc.id,
                  source: 'reserva-bien',
                  tipo: 'accion',
                  categoria: 'reserva',
                  icono: '📅',
                  titulo: getTituloSolicitud({ ...data, tipo: 'reserva' }),
                  mensaje: `${data.solicitadoPorNombre || 'Usuario'} · ${data.solicitadoPorNido || ''}`,
                  fecha: data.fechaCreacion,
                  enlace: `reservas-mayordomo.html?id=${bienId}`,
                  data: { ...data, bienId: bienId },
                  bienId: bienId
                });
              });
            } catch (e) {
              console.warn('Error leyendo reservas pendientes (collectionGroup):', e);
            }
          } catch (e) {
            console.error('Error cargando solicitudes:', e);
          }
        }
        
        // ========== PARA TODOS: Mis solicitudes pendientes (las que yo envié) ==========
        try {
          // Solicitudes genéricas (no reservas)
          const misPendientes = await db.collection('solicitudes')
            .where('solicitadoPor', '==', miUid)
            .where('estado', '==', 'pendiente')
            .orderBy('fechaCreacion', 'desc')
            .limit(10)
            .get();
          
          console.log('✅ Mis solicitudes pendientes:', misPendientes.size);
          
          misPendientes.docs.forEach(doc => {
            const data = doc.data();
            
            itemsInfo.push({
              id: doc.id,
              source: 'mi-solicitud',
              tipo: 'info',
              categoria: 'solicitud',
              icono: '⏳',
              titulo: `Pendiente: ${data.nombre || data.bienNombre || 'Solicitud'}`,
              mensaje: `Enviada el ${data.fechaCreacion?.toDate?.().toLocaleDateString('es-ES') || 'recientemente'}`,
              fecha: data.fechaCreacion,
              enlace: data.enlace || '',
              data: data,
              solicitadoPor: miUid
            });
          });

          // DATO ÚNICO: Mis reservas pendientes desde bienes (collectionGroup)
          try {
            const misReservasPend = await db.collectionGroup('reservas')
              .where('solicitadoPor', '==', miUid)
              .where('estado', '==', 'pendiente')
              .get();
            
            misReservasPend.docs.forEach(doc => {
              const data = doc.data();
              const pathParts = doc.ref.path.split('/');
              const bienId = pathParts.length >= 2 ? pathParts[1] : null;
              
              itemsInfo.push({
                id: doc.id,
                source: 'mi-reserva-bien',
                tipo: 'info',
                categoria: 'reserva',
                icono: '⏳',
                titulo: `Pendiente: ${data.nombre || data.bienNombre || 'Reserva'}`,
                mensaje: `Enviada el ${data.fechaCreacion?.toDate?.().toLocaleDateString('es-ES') || 'recientemente'}`,
                fecha: data.fechaCreacion,
                enlace: `reservas-mayordomo.html?id=${bienId}`,
                data: { ...data, bienId: bienId },
                bienId: bienId,
                solicitadoPor: miUid
              });
            });
          } catch (e) { console.warn('Error mis reservas pendientes:', e); }
        } catch (e) {
          console.error('Error cargando mis solicitudes pendientes:', e);
        }
        
        // ========== PARA TODOS: Mis solicitudes respondidas ==========
        try {
          const misRespondidas = await db.collection('solicitudes')
            .where('solicitadoPor', '==', miUid)
            .where('estado', 'in', ['aprobada', 'rechazada', 'en_estudio'])
            .orderBy('fechaRespuesta', 'desc')
            .limit(10)
            .get();
          
          console.log('✅ Mis solicitudes respondidas:', misRespondidas.size);
          
          misRespondidas.docs.forEach(doc => {
            const data = doc.data();
            const esAprobada = data.estado === 'aprobada';
            
            itemsInfo.push({
              id: doc.id,
              source: 'solicitud-respuesta',
              tipo: 'info',
              categoria: data.tipo,
              icono: esAprobada ? '✅' : '❌',
              titulo: `${esAprobada ? 'Aprobada' : 'Rechazada'}: ${getTituloSolicitud(data)}`,
              mensaje: data.respuesta || 'Sin comentarios',
              fecha: data.fechaRespuesta || data.fechaCreacion,
              data: data
            });
          });

          // DATO ÚNICO: Mis reservas respondidas desde bienes (collectionGroup)
          try {
            const misReservasResp = await db.collectionGroup('reservas')
              .where('solicitadoPor', '==', miUid)
              .where('estado', 'in', ['aprobada', 'rechazada', 'confirmada', 'en_estudio'])
              .get();
            
            misReservasResp.docs.forEach(doc => {
              const data = doc.data();
              const esAprobada = ['aprobada', 'confirmada'].includes(data.estado);
              const pathParts = doc.ref.path.split('/');
              const bienId = pathParts.length >= 2 ? pathParts[1] : null;
              
              itemsInfo.push({
                id: doc.id,
                source: 'reserva-respuesta',
                tipo: 'info',
                categoria: 'reserva',
                icono: esAprobada ? '✅' : '❌',
                titulo: `${esAprobada ? 'Aprobada' : 'Rechazada'}: ${data.nombre || data.bienNombre || 'Reserva'}`,
                mensaje: data.respuesta || 'Sin comentarios',
                fecha: data.fechaRespuesta || data.fechaCreacion,
                data: { ...data, bienId: bienId },
                bienId: bienId
              });
            });
          } catch (e) { console.warn('Error mis reservas respondidas:', e); }
        } catch (e) {
          console.error('Error cargando mis solicitudes:', e);
        }
        
        // ========== QUEOS (sistema existente) ==========
        try {
          const queosSnap = await db.collection('queos')
            .where('familiaId', '==', familiaId)
            .where('destinatarios', 'array-contains', miUid)
            .orderBy('fechaCreacion', 'desc')
            .limit(10)
            .get();
          
          console.log('✅ Queos:', queosSnap.size);
          
          queosSnap.docs.forEach(doc => {
            const data = doc.data();
            const leido = data.leidoPor?.includes(miUid);
            
            itemsInfo.push({
              id: doc.id,
              source: 'queo',
              tipo: 'info',
              categoria: 'queo',
              icono: '📢',
              titulo: data.titulo || data.asunto || 'Comunicado',
              mensaje: data.mensaje || '',
              fecha: data.fechaCreacion,
              leido: leido,
              data: data
            });
          });
        } catch (e) {
          console.error('Error cargando queos:', e);
        }

        // ========== NOTIFICACIONES DIRECTAS (respuestas, avisos, etc.) ==========
        try {
          let notifsSnap;
          
          if (soyAdmin) {
            // Admin: ver TODAS las notificaciones de la familia
            notifsSnap = await db.collection('notificaciones')
              .where('familiaId', '==', familiaId)
              .where('estado', '==', 'activa')
              .orderBy('fechaCreacion', 'desc')
              .limit(20)
              .get();
            console.log('✅ Notificaciones (admin - todas):', notifsSnap.size);
          } else {
            // Usuario normal: solo las dirigidas a él
            notifsSnap = await db.collection('notificaciones')
              .where('familiaId', '==', familiaId)
              .where('destinatarios', 'array-contains', miUid)
              .where('estado', '==', 'activa')
              .orderBy('fechaCreacion', 'desc')
              .limit(15)
              .get();
            console.log('✅ Notificaciones directas:', notifsSnap.size);
          }
          
          notifsSnap.docs.forEach(doc => {
            const data = doc.data();
            const leido = data.leidoPor?.includes(miUid);
            
            // Evitar duplicados con solicitudes respondidas
            if (data.origen?.tipo === 'respuesta-solicitud') {
              // Ya se muestran en "Mis solicitudes respondidas"
              return;
            }
            
            const icono = {
              'reserva': '📅',
              'evento': '🎉',
              'solicitud': '📩',
              'info': 'ℹ️',
              'aviso': '⚠️'
            }[data.categoria] || '📬';
            
            // Para admins, mostrar como acción si es solicitud
            const esAccion = soyAdmin && (data.categoria === 'solicitud' || data.tipo === 'accion');
            
            const item = {
              id: doc.id,
              source: 'notificacion',
              tipo: esAccion ? 'accion' : (data.tipo || 'info'),
              categoria: data.categoria || 'general',
              icono: icono,
              titulo: data.titulo || 'Notificación',
              mensaje: data.mensaje || '',
              fecha: data.fechaCreacion,
              enlace: data.enlace || '',
              leido: leido,
              data: data,
              solicitadoPor: data.origen?.solicitadoPor || null
            };
            
            if (esAccion) {
              itemsAccion.push(item);
            } else {
              itemsInfo.push(item);
            }
          });
        } catch (e) {
          console.error('Error cargando notificaciones:', e);
        }

        // ========== RENDERIZAR ==========
        notificacionesData = [...itemsAccion, ...itemsInfo];
        
        // Ordenar por fecha
        notificacionesData.sort((a, b) => {
          const fechaA = a.fecha?.toDate ? a.fecha.toDate() : new Date(a.fecha || 0);
          const fechaB = b.fecha?.toDate ? b.fecha.toDate() : new Date(b.fecha || 0);
          return fechaB - fechaA;
        });

        console.log('Total items para mostrar:', notificacionesData.length);

        let html = '';

        if (itemsAccion.length > 0) {
          html += '<div class="tablon-separator">⚡ Requiere tu acción</div>';
          html += itemsAccion.slice(0, 5).map(n => renderNotificacionDirecta(n)).join('');
        }

        if (itemsInfo.length > 0) {
          html += '<div class="tablon-separator">ℹ️ Información</div>';
          html += itemsInfo.slice(0, 5).map(n => renderNotificacionDirecta(n)).join('');
        }

        if (html === '') {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">✨</div>Sin novedades</div>';
          return;
        }

        container.innerHTML = html;

      } catch (error) {
        console.error('Error cargando tablón:', error);
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">📢</div>Sin novedades</div>';
      }
    }

    function getTituloSolicitud(data) {
      switch(data.tipo) {
        case 'reserva': 
          // Incluir info de quién reserva si es familiar
          let tituloReserva = `Reserva: ${data.bienNombre || 'Bien'}`;
          if (data.tipoReservaNombre) {
            tituloReserva = `${data.tipoReservaNombre}: ${data.bienNombre || 'Bien'}`;
          }
          if (data.nidoReservaNombre) {
            tituloReserva += ` · ${data.nidoReservaNombre}`;
          } else if (data.otroGrupoNombre) {
            tituloReserva += ` · ${data.otroGrupoNombre}`;
          }
          return tituloReserva;
        case 'evento': return `Evento: ${data.nombre || data.titulo || 'Sin nombre'}`;
        case 'iniciativa': return `Propuesta: ${data.titulo || 'Sin título'}`;
        case 'averia': return `Avería: ${data.bienNombre || data.descripcion?.substring(0, 30) || 'Ver detalle'}`;
        case 'encargo': return `Encargo: ${data.bienNombre || 'Bien'}`;
        default: return data.titulo || 'Solicitud';
      }
    }

    function renderNotificacionDirecta(item) {
      const fecha = item.fecha?.toDate ? item.fecha.toDate() : new Date(item.fecha || Date.now());
      const fechaStr = formatearFechaRelativa(fecha);
      
      const esAccion = item.tipo === 'accion';
      const colorClass = esAccion ? 'notif-accion' : 'notif-info';
      const leidoClass = item.leido ? 'notif-leido' : '';
      
      return `
        <div class="mensaje-item ${colorClass} ${leidoClass}" data-id="${item.id}" data-source="${item.source}">
          <div class="mensaje-avatar" onclick="abrirDetalleSolicitud('${item.id}', '${item.source}')">${item.icono}</div>
          <div class="mensaje-content" onclick="abrirDetalleSolicitud('${item.id}', '${item.source}')">
            <div class="mensaje-header">
              <span class="mensaje-autor">${item.titulo}</span>
              <span class="mensaje-fecha">${fechaStr}</span>
            </div>
            <div class="mensaje-preview">${item.mensaje}</div>
          </div>
          <button class="btn-eliminar-notif" onclick="event.stopPropagation(); eliminarNotificacion('${item.id}', '${item.source}')" title="Eliminar">🗑️</button>
        </div>
      `;
    }

    async function abrirDetalleSolicitud(id, source) {
      if (source === 'solicitud') {
        // Buscar la solicitud en los datos cargados
        const solicitud = notificacionesData.find(n => n.id === id && n.source === 'solicitud');
        if (solicitud) {
          // Preparar datos para el modal - viene de solicitud directa, NO de notificación
          const notifData = {
            id: id,
            notifId: null, // No hay notificación asociada
            categoria: solicitud.categoria,
            titulo: solicitud.titulo,
            origen: { tipo: 'solicitud', id: id },
            ...solicitud.data
          };
          abrirModalRespuesta(notifData);
        }
      } else if (source === 'queo') {
        // Marcar como leído y mostrar detalle
        marcarQueoLeido(id);
      } else if (source === 'notificacion' || source === 'solicitud-respuesta') {
        // Notificación directa (respuestas, avisos, etc.)
        const notif = notificacionesData.find(n => n.id === id);
        if (notif) {
          // Marcar como leída
          try {
            await db.collection('notificaciones').doc(id).update({
              leidoPor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
            });
          } catch (e) {
            console.warn('Error marcando notificación como leída:', e);
          }
          
          // Mostrar detalle en modal simple
          mostrarModalNotificacion(notif);
        }
      }
    }

    function mostrarModalNotificacion(notif) {
      // Crear modal dinámico si no existe
      let modal = document.getElementById('modal-notificacion-detalle');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modal-notificacion-detalle';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--sage), var(--sage-dark));">
              <span id="notif-detalle-icono" style="font-size: 1.5rem; margin-right: 8px;"></span>
              <h3 class="modal-title" id="notif-detalle-titulo" style="color: white;"></h3>
              <button class="modal-close" onclick="cerrarModalNotificacion()">×</button>
            </div>
            <div class="modal-body">
              <p id="notif-detalle-mensaje" style="font-size: 1rem; line-height: 1.5;"></p>
              <p id="notif-detalle-fecha" style="font-size: 0.85rem; color: var(--text-muted); margin-top: 12px;"></p>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="cerrarModalNotificacion()">Entendido</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      
      // Rellenar datos
      document.getElementById('notif-detalle-icono').textContent = notif.icono || '📬';
      document.getElementById('notif-detalle-titulo').textContent = notif.titulo || 'Notificación';
      document.getElementById('notif-detalle-mensaje').textContent = notif.mensaje || '';
      
      const fecha = notif.fecha?.toDate ? notif.fecha.toDate() : new Date(notif.fecha || Date.now());
      document.getElementById('notif-detalle-fecha').textContent = fecha.toLocaleString('es-ES', {
        day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
      });
      
      modal.classList.add('active');
      
      // Refrescar tablón para actualizar estado de leído
      renderTablon();
    }

    function cerrarModalNotificacion() {
      const modal = document.getElementById('modal-notificacion-detalle');
      if (modal) modal.classList.remove('active');
    }

    function formatearFechaRelativa(fecha) {
      const ahora = new Date();
      const diff = ahora - fecha;
      const minutos = Math.floor(diff / 60000);
      const horas = Math.floor(diff / 3600000);
      const dias = Math.floor(diff / 86400000);
      
      if (minutos < 1) return 'ahora';
      if (minutos < 60) return `${minutos}m`;
      if (horas < 24) return `${horas}h`;
      if (dias < 7) return `${dias}d`;
      return fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
    }

    async function marcarQueoLeido(queoId) {
      try {
        await db.collection('queos').doc(queoId).update({
          leidoPor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        await renderTablon();
      } catch (e) {
        console.error('Error marcando queo:', e);
      }
    }

    function renderNotificacion(n) {
      const tiempo = formatearTiempo(n.fechaCreacion);
      const iconos = {
        queo: '📣',
        convocatoria: '✋',
        reserva: '📅',
        evento: '🎉',
        iniciativa: '💡',
        averia: '🔧',
        tarea: '📋',
        mercadillo: '🏪',
        votacion: '🗳️',
        encuesta: '📊',
        'amigo-invisible': '🎁',
        'elegir-fecha': '📆',
        turnos: '🔄',
        porra: '🎯',
        solicitud: '📩',
        mantenimiento: '🔧',
        limpieza: '🧹',
        inventario: '📦',
        gastos: '💰',
        general: '📌'
      };
      const icono = iconos[n.categoria] || '📌';
      const tipoClass = n.tipo === 'accion' ? 'accion' : 'info-notif';
      const sourceId = n.source === 'queo' ? n.id : n.id;
      const sourceType = n.source || 'notificacion';

      // Formatear nombre de categoría
      const categoriaNombres = {
        queo: 'Queo',
        convocatoria: 'Convocatoria',
        reserva: 'Reservas',
        evento: 'Eventos',
        iniciativa: 'Ideas',
        averia: 'Averías',
        solicitud: 'Solicitud'
      };
      const categoriaLabel = categoriaNombres[n.categoria] || n.categoria || 'Sistema';

      // Para queos, mostrar también el remitente
      const remitenteInfo = n.source === 'queo' && n.remitenteNombre ? 
        `<div class="notif-remitente">De: ${n.remitenteNombre}</div>` : '';

      // Botón eliminar - siempre visible para admins, o para el creador
      const puedeEliminar = esAdminRama || 
        userData?.credenciales === 'admin-rama' || 
        userData?.credenciales === 'admin-nido' ||
        n.remitente === currentUser.uid || 
        n.creadoPor === currentUser.uid ||
        n.solicitadoPor === currentUser.uid;
      const btnEliminar = puedeEliminar ? 
        `<button class="notif-eliminar" onclick="event.stopPropagation(); eliminarNotificacion('${sourceId}', '${sourceType}')" title="Eliminar">🗑️</button>` : '';

      return `
        <div class="notif-item ${tipoClass}" onclick="abrirNotificacion('${sourceId}', '${n.enlace || ''}', '${sourceType}', '${n.categoria || ''}')">
          <div class="notif-actions">
            <button class="notif-marcar" onclick="event.stopPropagation(); marcarNotificacion('${sourceId}', '${n.tipo}', '${sourceType}')" title="${n.tipo === 'accion' ? 'Marcar como hecho' : 'Descartar'}">✓</button>
            ${btnEliminar}
          </div>
          <div class="notif-header">
            <span class="notif-badge ${tipoClass}">${n.tipo === 'accion' ? '⚡ Acción' : 'ℹ️ Info'}</span>
            <span class="notif-tiempo">${tiempo}</span>
          </div>
          <div class="notif-titulo">${n.titulo || n.asunto || 'Sin título'}</div>
          ${n.mensaje ? `<div class="notif-texto">${n.mensaje.substring(0, 80)}${n.mensaje.length > 80 ? '...' : ''}</div>` : ''}
          ${remitenteInfo}
          <div class="notif-origen">${icono} ${categoriaLabel}</div>
        </div>
      `;
    }

    async function abrirNotificacion(notifId, enlace, sourceType = 'notificacion', categoria = '') {
      // Si es solicitud de reserva o evento y soy admin, abrir modal de respuesta
      const esAdmin = esAdminRama || userData?.rol === 'AdminNido' || userData?.rol === 'admin-nido';
      if (esAdmin && (categoria === 'reserva' || categoria === 'evento')) {
        // Cargar datos de la solicitud
        try {
          const notifDoc = await db.collection('notificaciones').doc(notifId).get();
          if (notifDoc.exists) {
            // notifId se usa para marcar la notificación como respondida
            const notifData = { id: notifDoc.id, notifId: notifDoc.id, ...notifDoc.data() };
            // Si tiene origen.id, es una solicitud que podemos responder
            if (notifData.origen?.id) {
              abrirModalRespuesta(notifData);
              return;
            }
          }
        } catch (e) {
          console.warn('Error cargando solicitud:', e);
        }
      }

      // Marcar como leída
      try {
        const collection = sourceType === 'queo' ? 'queos' : 'notificaciones';
        await db.collection(collection).doc(notifId).update({
          leidoPor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
      } catch(e) {
        console.warn('Error marcando como leída:', e);
      }

      // Navegar si hay enlace
      if (enlace) {
        window.location.href = enlace;
      }
    }

    async function marcarNotificacion(notifId, tipo, sourceType = 'notificacion') {
      try {
        const collection = sourceType === 'queo' ? 'queos' : 'notificaciones';
        
        if (tipo === 'accion') {
          // Marcar como completada
          await db.collection(collection).doc(notifId).update({
            completadoPor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
          });
        } else {
          // Para info, marcar como leída (la ocultará)
          await db.collection(collection).doc(notifId).update({
            leidoPor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
          });
        }
        
        // Refrescar tablón
        await renderTablon();
        // Refrescar buzón móvil
        if (typeof renderBuzonUnificado === 'function') {
          await renderBuzonUnificado();
        }
      } catch (error) {
        console.error('Error marcando notificación:', error);
      }
    }

    async function eliminarNotificacion(notifId, sourceType = 'notificacion') {
      if (!confirm('¿Eliminar este aviso?')) return;
      
      try {
        let deleted = false;
        
        if (sourceType === 'queo') {
          console.log('Eliminando queo:', notifId);
          await db.collection('queos').doc(notifId).delete();
          deleted = true;
        } else if (sourceType === 'solicitud' || sourceType === 'mi-solicitud') {
          // Eliminar de colección solicitudes
          console.log('Eliminando solicitud:', notifId);
          await db.collection('solicitudes').doc(notifId).delete();
          deleted = true;
        } else if (sourceType === 'reserva-bien' || sourceType === 'mi-reserva-bien' || sourceType === 'reserva-respuesta') {
          // DATO ÚNICO: eliminar reserva del bien
          console.log('Eliminando reserva (necesita bienId - se marca como eliminada)');
          // No podemos borrar sin bienId, marcar en notificaciones como completada
          await db.collection('notificaciones').doc(notifId).delete().catch(() => {});
          deleted = true;
        } else {
          // Por defecto, eliminar de notificaciones
          console.log('Eliminando de notificaciones:', notifId);
          await db.collection('notificaciones').doc(notifId).delete();
          deleted = true;
        }
        
        if (deleted) {
          // Refrescar tablón y buzón
          await renderTablon();
          if (typeof renderBuzonUnificado === 'function') {
            await renderBuzonUnificado();
          }
        }
      } catch (error) {
        console.error('Error eliminando:', error);
        alert('Error al eliminar. Verifica permisos.');
      }
    }

    // ============ MODAL RESPUESTA SOLICITUDES ============
    let solicitudActual = null;

    function abrirModalRespuesta(notifData) {
      solicitudActual = notifData;
      
      // Configurar encabezado según categoría
      const cat = notifData.categoria || '';
      const esReserva = cat === 'reserva' || cat === 'reserva-evento';
      document.getElementById('respuesta-icono').textContent = cat === 'reserva-evento' ? '📋' : (esReserva ? '📅' : '🎉');
      document.getElementById('respuesta-titulo').textContent = cat === 'reserva-evento' ? 'Solicitud con Preparación' : (esReserva ? 'Solicitud de Reserva' : 'Solicitud de Evento');
      document.getElementById('respuesta-subtitulo').textContent = `De: ${notifData.mensaje?.split(' ha enviado')[0] || 'Miembro'}`;
      
      // Cargar datos de la solicitud original
      cargarDetalleSolicitud(notifData);
      
      // Resetear formulario
      document.querySelectorAll('.respuesta-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('respuesta-comentarios').value = '';
      document.getElementById('respuesta-contador').textContent = '0';
      document.getElementById('btn-enviar-respuesta').disabled = true;
      
      // Abrir modal
      document.getElementById('modal-respuesta-solicitud').classList.add('active');
    }

    async function cargarDetalleSolicitud(notifData) {
      const container = document.getElementById('respuesta-detalle');
      
      // Verificar que existe origen.id
      const solicitudId = notifData.origen?.id;
      
      if (!solicitudId) {
        // Notificación antigua sin enlace a solicitud
        console.warn('Notificación sin origen.id:', notifData);
        container.innerHTML = '<p>' + (notifData.titulo || 'Solicitud') + '</p>' +
          '<p>' + (notifData.mensaje || '') + '</p>' +
          '<p style="color: var(--terracota); font-size: 0.85rem; margin-top: 8px;">' +
          '⚠️ Esta notificación no tiene enlace a la solicitud original. ' +
          'Puedes marcarla como respondida pero no se actualizará el estado de la solicitud.</p>';
        return;
      }
      
      // Obtener datos de la solicitud original
      try {
        let solicitudDoc;
        const bienIdOrigen = notifData.origen?.bienId;
        
        // DATO ÚNICO: si hay bienId en origen, leer de bienes/{bienId}/reservas/{id}
        if (bienIdOrigen) {
          solicitudDoc = await db.collection('bienes').doc(bienIdOrigen).collection('reservas').doc(solicitudId).get();
          console.log('📦 Leyendo reserva de bien:', bienIdOrigen, solicitudId, 'existe:', solicitudDoc.exists);
        }
        
        // Fallback: leer de solicitudes (para tipos no-reserva o datos legacy)
        if (!solicitudDoc || !solicitudDoc.exists) {
          solicitudDoc = await db.collection('solicitudes').doc(solicitudId).get();
          console.log('📦 Leyendo de solicitudes (fallback):', solicitudId, 'existe:', solicitudDoc.exists);
        }
        
        if (solicitudDoc.exists) {
          const sol = solicitudDoc.data();
          solicitudActual.solicitudData = sol;
          solicitudActual.solicitudId = solicitudId;
          solicitudActual.bienId = bienIdOrigen || sol.bienId || null; // Guardar para aprobación
          
          // --- CABECERA BÁSICA ---
          let html = '<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">';
          if (sol.nombre) html += '<p style="font-weight:700;font-size:1.05rem;margin:0;">📌 ' + sol.nombre + '</p>';
          html += '<p style="margin:0;"><strong>📍 Bien:</strong> ' + (sol.bienNombre || 'No especificado') + '</p>';
          html += '<p style="margin:0;"><strong>👤 Solicitante:</strong> ' + (sol.solicitadoPorNombre || 'Usuario');
          if (sol.solicitadoPorNido) html += ' <span style="color:var(--text-muted);font-size:0.85rem;">(' + sol.solicitadoPorNido + ')</span>';
          html += '</p>';
          
          // Tipo y quién reserva
          if (sol.tipoReservaNombre || sol.tipoReserva) {
            html += '<p style="margin:0;"><strong>📋 Tipo:</strong> ' + (sol.tipoReservaNombre || sol.tipoReserva) + '</p>';
          }
          if (sol.nidoReservaNombre) {
            html += '<p style="margin:0;"><strong>🏠 Reserva para:</strong> ' + sol.nidoReservaNombre + '</p>';
          } else if (sol.otroGrupoNombre) {
            html += '<p style="margin:0;"><strong>👨‍👩‍👧‍👦 Reserva para:</strong> ' + sol.otroGrupoNombre + '</p>';
          }
          
          // Fechas
          html += '<p style="margin:0;"><strong>📅 Fechas:</strong> ' + (sol.fechaInicio || '?') + ' → ' + (sol.fechaFin || '?');
          if (sol.diasSolicitud?.length) html += ' <span style="color:var(--text-muted);font-size:0.85rem;">(' + sol.diasSolicitud.length + ' días)</span>';
          html += '</p>';
          
          // Motivo / descripción
          if (sol.motivo || sol.descripcion) {
            html += '<p style="margin:0;"><strong>📝 Motivo:</strong> ' + (sol.motivo || sol.descripcion) + '</p>';
          }
          html += '</div>';
          
          // --- SECCIONES DE PREPARACIÓN ---
          const prep = sol.preparacion;
          if (prep) {
            html += '<div style="border-top:1px solid var(--cream-dark);padding-top:12px;margin-top:4px;">';
            html += '<p style="font-weight:700;font-size:0.95rem;margin:0 0 10px 0;color:var(--sage-dark);">📦 Detalle de preparación</p>';
            
            // 1. ZONAS
            if (prep.zonas?.length > 0) {
              html += buildSeccionResumen('🏠 Zonas', buildResumenZonas(prep, sol));
            }
            
            // 2. PERSONAS
            if (prep.personas && Object.keys(prep.personas).length > 0) {
              html += buildSeccionResumen('👥 Personas', buildResumenPersonas(prep, sol));
            }
            
            // 3. MENÚS
            if (prep.menus && Object.keys(prep.menus).length > 0) {
              const menusConDatos = Object.entries(prep.menus).filter(([k,v]) => v.especial || v.descripcion);
              if (menusConDatos.length > 0) {
                html += buildSeccionResumen('🍽️ Menús', buildResumenMenus(prep, sol));
              }
            }
            
            // 4. SERVICIO
            if (prep.servicio && Object.keys(prep.servicio).length > 0) {
              const servicioConDatos = Object.entries(prep.servicio).filter(([k,v]) => v?.length > 0);
              if (servicioConDatos.length > 0) {
                html += buildSeccionResumen('👨‍🍳 Servicio', buildResumenServicio(prep, sol));
              }
            }
            
            // 5. MENAJE
            if (prep.menajeEspecial || prep.menajeAjuar?.length > 0 || prep.menaje?.length > 0) {
              html += buildSeccionResumen('🍷 Menaje', buildResumenMenaje(prep));
            }
            
            // 6. PRODUCTO
            if (prep.productosAportados?.length > 0 || prep.productosSolicitados?.length > 0) {
              html += buildSeccionResumen('📦 Producto', buildResumenProducto(prep));
            }
            
            // 7. TAREAS
            if (prep.tareas?.length > 0) {
              html += buildSeccionResumen('✅ Tareas', buildResumenTareas(prep));
            }
            
            // 8. NOTAS
            if (prep.notas) {
              html += buildSeccionResumen('📝 Notas', '<p style="margin:0;white-space:pre-wrap;">' + prep.notas + '</p>');
            }
            
            html += '</div>';
          } else {
            // Solicitud antigua sin preparación — mostrar campos legacy
            if (sol.numFamiliares || sol.numInvitados) {
              html += '<p><strong>👥 Asistentes:</strong> ' + (sol.numFamiliares || 0) + ' familiares';
              if (sol.numInvitados) html += ' + ' + sol.numInvitados + ' invitados';
              html += '</p>';
            }
            if (sol.numDesayunos || sol.numComidas || sol.numCenas) {
              html += '<p><strong>🍽️ Pases:</strong> ';
              let pases = [];
              if (sol.numDesayunos) pases.push(sol.numDesayunos + ' desayunos');
              if (sol.numComidas) pases.push(sol.numComidas + ' comidas');
              if (sol.numCenas) pases.push(sol.numCenas + ' cenas');
              html += pases.join(', ') + '</p>';
            }
          }
          
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p>' + (notifData.titulo || 'Solicitud') + '</p><p>' + (notifData.mensaje || '') + '</p>';
        }
      } catch (e) {
        console.error('Error cargando solicitud:', e);
        container.innerHTML = '<p>' + (notifData.titulo || 'Solicitud') + '</p>';
      }
    }

    // === HELPERS PARA RESUMEN DE PREPARACIÓN ===
    
    function buildSeccionResumen(titulo, contenidoHtml) {
      const id = 'prep-sec-' + titulo.replace(/[^a-z]/gi, '').toLowerCase();
      return '<div style="margin-bottom:8px;border:1px solid var(--cream-dark);border-radius:8px;overflow:hidden;">' +
        '<div onclick="togglePrepSeccion(\'' + id + '\')" style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--cream);cursor:pointer;user-select:none;">' +
        '<span style="font-weight:600;font-size:0.88rem;">' + titulo + '</span>' +
        '<span id="' + id + '-arrow" style="font-size:0.75rem;color:var(--text-muted);transition:transform 0.2s;">▼</span>' +
        '</div>' +
        '<div id="' + id + '" style="display:none;padding:10px 12px;font-size:0.85rem;">' + contenidoHtml + '</div>' +
        '</div>';
    }

    function buildResumenZonas(prep, sol) {
      let h = '';
      prep.zonas.forEach(zonaId => {
        const deps = prep.zonasDesglose?.[zonaId] || [];
        h += '<p style="margin:0 0 4px 0;"><strong>' + zonaId + '</strong>';
        if (deps.length > 0) h += ' — ' + deps.length + ' dependencia' + (deps.length > 1 ? 's' : '');
        h += '</p>';
      });
      return h || '<p style="margin:0;color:var(--text-muted);">Sin zonas seleccionadas</p>';
    }

    function buildResumenPersonas(prep, sol) {
      const dias = sol.diasSolicitud || Object.keys(prep.personas);
      if (dias.length === 0) return '<p style="margin:0;color:var(--text-muted);">Sin datos</p>';
      
      let h = '<table style="width:100%;border-collapse:collapse;font-size:0.82rem;">';
      h += '<tr style="background:var(--cream);"><th style="p:4px;text-align:left;">Día</th><th style="p:4px;text-align:center;">Fam.</th><th style="p:4px;text-align:center;">Desay.</th><th style="p:4px;text-align:center;">Com.</th><th style="p:4px;text-align:center;">Cena</th><th style="p:4px;text-align:center;">Duerm.</th></tr>';
      
      dias.forEach(diaKey => {
        const d = prep.personas[diaKey];
        if (!d) return;
        const label = formatDiaKey(diaKey);
        h += '<tr style="border-bottom:1px solid var(--cream);">';
        h += '<td style="padding:3px 4px;">' + label + '</td>';
        h += '<td style="padding:3px 4px;text-align:center;">' + (d.familiares || 0) + '</td>';
        h += '<td style="padding:3px 4px;text-align:center;">' + (d.desayuno || 0) + '</td>';
        h += '<td style="padding:3px 4px;text-align:center;">' + (d.comida || 0) + '</td>';
        h += '<td style="padding:3px 4px;text-align:center;">' + (d.cena || 0) + '</td>';
        h += '<td style="padding:3px 4px;text-align:center;">' + (d.duermen || 0) + '</td>';
        h += '</tr>';
      });
      h += '</table>';
      return h;
    }

    function buildResumenMenus(prep, sol) {
      const entries = Object.entries(prep.menus).filter(([k,v]) => v.especial || v.descripcion);
      if (entries.length === 0) return '<p style="margin:0;color:var(--text-muted);">Sin menús especiales</p>';
      
      let h = '';
      entries.forEach(([key, val]) => {
        // key format: 'pase-dateKey' e.g. 'desayuno-2025-02-07'
        const parts = key.split('-');
        const pase = parts[0];
        const fecha = parts.slice(1).join('-');
        const label = (pase === 'desayuno' ? '☀️' : pase === 'comida' ? '☀️🍽️' : '🌙') + ' ' + capitalizar(pase) + ' ' + formatDiaKey(fecha);
        h += '<p style="margin:0 0 4px 0;"><strong>' + label + '</strong>';
        if (val.especial) h += ' <span style="background:#FFF3E0;padding:1px 6px;border-radius:4px;font-size:0.78rem;">⭐ Especial</span>';
        if (val.descripcion) h += '<br><span style="color:var(--text-muted);">' + val.descripcion + '</span>';
        h += '</p>';
      });
      return h;
    }

    function buildResumenServicio(prep, sol) {
      const entries = Object.entries(prep.servicio).filter(([k,v]) => {
        if (Array.isArray(v)) return v.length > 0;
        if (typeof v === 'object' && v) return Object.keys(v).length > 0;
        return !!v;
      });
      if (entries.length === 0) return '<p style="margin:0;color:var(--text-muted);">Sin servicio asignado</p>';
      
      const PASE_ICONS = { desayuno:'🍳', aperitivo:'🥂', comida:'🍽️', cena:'🌙' };
      let h = '';
      entries.forEach(([key, roles]) => {
        // key = 'desayuno-2026-02-13' → pase='desayuno', fecha='2026-02-13'
        const dashIdx = key.indexOf('-');
        const pase = dashIdx > 0 ? key.substring(0, dashIdx) : key;
        const fecha = dashIdx > 0 ? key.substring(dashIdx + 1) : '';
        const icon = PASE_ICONS[pase] || '🍽️';
        const label = icon + ' ' + capitalizar(pase) + (fecha ? ' ' + formatDiaKey(fecha) : '');
        const rolesStr = Array.isArray(roles) ? roles.join(', ') : String(roles);
        h += '<p style="margin:0 0 4px 0;"><strong>' + label + ':</strong> ' + rolesStr + '</p>';
      });
      return h;
    }

    function buildResumenMenaje(prep) {
      let h = '';
      if (prep.menajeEspecial) h += '<p style="margin:0 0 4px 0;">⭐ Menaje especial solicitado</p>';
      if (prep.menajeAjuar?.length > 0) h += '<p style="margin:0 0 4px 0;"><strong>Del ajuar:</strong> ' + prep.menajeAjuar.length + ' elemento' + (prep.menajeAjuar.length > 1 ? 's' : '') + '</p>';
      if (prep.menaje?.length > 0) {
        h += '<p style="margin:0;"><strong>Adicional:</strong></p>';
        prep.menaje.forEach(m => {
          const texto = (typeof m === 'string') ? m : (m.articulo || m.nombre || JSON.stringify(m));
          const cant = m.cantidad ? ' ×' + m.cantidad : '';
          const notas = m.notas ? ' <span style="color:var(--text-muted);">— ' + m.notas + '</span>' : '';
          h += '<p style="margin:0 0 2px 8px;">• ' + texto + cant + notas + '</p>';
        });
      }
      return h || '<p style="margin:0;color:var(--text-muted);">Sin menaje especial</p>';
    }

    function buildResumenProducto(prep) {
      let h = '';
      if (prep.productosAportados?.length > 0) {
        h += '<p style="margin:0 0 4px 0;font-weight:600;">🧳 Aportan:</p>';
        prep.productosAportados.forEach(p => {
          const texto = (typeof p === 'string') ? p : (p.descripcion || p.nombre || JSON.stringify(p));
          const cant = p.cantidad ? ' ×' + p.cantidad : '';
          const notas = p.notas ? ' <span style="color:var(--text-muted);">— ' + p.notas + '</span>' : '';
          h += '<p style="margin:0 0 2px 8px;">• ' + texto + cant + notas + '</p>';
        });
      }
      if (prep.productosSolicitados?.length > 0) {
        h += '<p style="margin:4px 0 4px 0;font-weight:600;">🛒 Solicitan:</p>';
        prep.productosSolicitados.forEach(p => {
          const texto = (typeof p === 'string') ? p : (p.descripcion || p.nombre || JSON.stringify(p));
          const cant = p.cantidad ? ' ×' + p.cantidad : '';
          const notas = p.notas ? ' <span style="color:var(--text-muted);">— ' + p.notas + '</span>' : '';
          h += '<p style="margin:0 0 2px 8px;">• ' + texto + cant + notas + '</p>';
        });
      }
      return h || '<p style="margin:0;color:var(--text-muted);">Sin productos</p>';
    }

    function buildResumenTareas(prep) {
      let h = '';
      prep.tareas.forEach(t => {
        const texto = (typeof t === 'string') ? t : (t.descripcion || t.nombre || JSON.stringify(t));
        const notas = (typeof t === 'object' && t.notas) ? ' <span style="color:var(--text-muted);">— ' + t.notas + '</span>' : '';
        h += '<p style="margin:0 0 4px 0;">☐ ' + texto + notas + '</p>';
      });
      return h;
    }

    function formatDiaKey(key) {
      // '2025-02-07' → 'Vie 7 feb'
      if (!key || key.length < 10) return key || '';
      try {
        const d = new Date(key + 'T12:00:00');
        const dias = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
        const meses = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
        return dias[d.getDay()] + ' ' + d.getDate() + ' ' + meses[d.getMonth()];
      } catch(e) { return key; }
    }

    function capitalizar(str) {
      return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    }

    function togglePrepSeccion(id) {
      const el = document.getElementById(id);
      const arrow = document.getElementById(id + '-arrow');
      if (!el) return;
      if (el.style.display === 'none') {
        el.style.display = 'block';
        if (arrow) arrow.style.transform = 'rotate(180deg)';
      } else {
        el.style.display = 'none';
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    }

    function seleccionarRespuesta(elemento, valor) {
      // Quitar selección anterior
      document.querySelectorAll('.respuesta-btn').forEach(btn => btn.classList.remove('selected'));
      // Añadir selección
      elemento.classList.add('selected');
      // Marcar radio
      elemento.closest('label').querySelector('input').checked = true;
      // Habilitar botón
      document.getElementById('btn-enviar-respuesta').disabled = false;
    }

    function cerrarModalRespuesta() {
      document.getElementById('modal-respuesta-solicitud').classList.remove('active');
      solicitudActual = null;
    }

    // Contador de caracteres
    document.getElementById('respuesta-comentarios')?.addEventListener('input', function() {
      document.getElementById('respuesta-contador').textContent = this.value.length;
    });

    async function enviarRespuestaSolicitud() {
      if (!solicitudActual) return;
      
      const estadoSeleccionado = document.querySelector('input[name="respuesta-estado"]:checked')?.value;
      const comentarios = document.getElementById('respuesta-comentarios').value.trim();
      
      if (!estadoSeleccionado) {
        alert('Selecciona una respuesta');
        return;
      }
      
      const btn = document.getElementById('btn-enviar-respuesta');
      btn.disabled = true;
      btn.innerHTML = '<span>⏳</span> Enviando...';
      
      try {
        const fechaActual = firebase.firestore.FieldValue.serverTimestamp();
        // Usar solicitudId guardado o intentar desde origen
        const solicitudId = solicitudActual.solicitudId || solicitudActual.origen?.id;
        const solData = solicitudActual.solicitudData || {};
        
        // 1. Actualizar estado — DATO ÚNICO según tipo
        if (solicitudId) {
          try {
            const updatePayload = {
              estado: estadoSeleccionado,
              respuesta: comentarios,
              respondidoPor: currentUser.uid,
              respondidoPorNombre: userData?.nombre || currentUser.email,
              fechaRespuesta: fechaActual
            };

            const bienIdActual = solicitudActual.bienId || solData.bienId;
            
            if (bienIdActual) {
              // RESERVA: actualizar el doc existente en bienes/{bienId}/reservas/{id}
              // NO crear duplicado — ya está ahí
              if (estadoSeleccionado === 'aprobada') {
                updatePayload.aprobadoPor = currentUser.uid;
                updatePayload.aprobadoPorNombre = userData?.nombre || '';
                updatePayload.fechaAprobacion = fechaActual;
              }
              await db.collection('bienes').doc(bienIdActual).collection('reservas').doc(solicitudId).update(updatePayload);
              console.log('✅ Reserva actualizada en bien:', bienIdActual);
            } else {
              // SOLICITUD GENÉRICA: actualizar en solicitudes (iniciativas, averías, etc.)
              await db.collection('solicitudes').doc(solicitudId).update(updatePayload);
              console.log('✅ Solicitud actualizada en raíz');
            }
          } catch (solError) {
            console.warn('No se pudo actualizar la solicitud:', solError);
          }
        }
        
        // 2. Marcar notificación como completada (solo si viene de una notificación, no de solicitud directa)
        if (solicitudActual.notifId) {
          try {
            await db.collection('notificaciones').doc(solicitudActual.notifId).update({
              completadoPor: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
              estado: 'respondida'
            });
          } catch (notifError) {
            console.warn('No se pudo actualizar notificación:', notifError);
          }
        }
        
        // 3. Notificar al solicitante (solo si tenemos datos)
        const solicitanteUid = solData.solicitadoPor;
        if (solicitanteUid && solicitudId) {
          const estadoEmoji = {
            'aprobada': '✅',
            'rechazada': '❌',
            'en_estudio': '🔍'
          };
          const estadoTexto = {
            'aprobada': 'Aceptada',
            'rechazada': 'Rechazada',
            'en_estudio': 'En estudio'
          };
          
          await db.collection('notificaciones').add({
            tipo: 'info',
            categoria: solicitudActual.categoria,
            titulo: estadoEmoji[estadoSeleccionado] + ' Tu solicitud ha sido ' + estadoTexto[estadoSeleccionado].toLowerCase(),
            mensaje: comentarios || ('Respuesta de ' + (userData?.nombre || 'administrador')),
            familiaId: currentFamilia.id,
            destinatarios: [solicitanteUid],
            leidoPor: [],
            fechaCreacion: fechaActual,
            origen: { tipo: 'respuesta-solicitud', solicitudId: solicitudId },
            estado: 'activa'
          });
        }
        
        // 4. Si es APROBADA, añadir al calendario (solo para tipos sin reserva ya existente)
        if (estadoSeleccionado === 'aprobada' && solicitudId) {
          const bienIdActual = solicitudActual.bienId || solData.bienId;
          
          // Para reservas: ya se actualizó el estado arriba, NO crear duplicado
          // Para solicitudes genéricas de tipo reserva sin bienId (legacy): crear reserva
          if (solicitudActual.categoria === 'reserva' && solData.bienId && !bienIdActual) {
            await db.collection('bienes').doc(solData.bienId).collection('reservas').add({
              tipo: solData.tipoReserva || 'estancia',
              tipoNombre: solData.tipoReservaNombre || 'Estancia',
              nidoReservaId: solData.nidoReservaId || null,
              nidoReservaNombre: solData.nidoReservaNombre || '',
              otroGrupoId: solData.otroGrupoId || null,
              otroGrupoNombre: solData.otroGrupoNombre || '',
              fechaInicio: solData.fechaInicio,
              fechaFin: solData.fechaFin,
              numFamiliares: solData.numFamiliares || 0,
              numInvitados: solData.numInvitados || 0,
              motivo: solData.motivo || '',
              visibilidad: solData.visibilidad || 'rama',
              solicitadoPor: solData.solicitadoPor,
              solicitadoPorNombre: solData.solicitadoPorNombre,
              aprobadoPor: currentUser.uid,
              aprobadoPorNombre: userData?.nombre || '',
              estado: 'confirmada',
              familiaId: currentFamilia.id,
              fechaAprobacion: fechaActual,
              origenSolicitud: solicitudId
            });
          }
          
          // Crear evento en calendario
          const eventoData = {
            tipo: solicitudActual.categoria === 'reserva' ? 'reserva' : 'evento',
            nombre: solicitudActual.categoria === 'reserva' 
              ? ('Reserva: ' + (solData.bienNombre || 'Bien'))
              : (solData.nombre || 'Evento'),
            fecha: solData.fechaInicio || solData.fecha,
            fechaFin: solData.fechaFin || null,
            descripcion: solData.descripcion || solData.motivo || '',
            familiaId: currentFamilia.id,
            nidoId: solData.nidoId || null,
            visibilidad: solData.visibilidad || 'rama',
            creadoPor: currentUser.uid,
            origenSolicitud: solicitudId,
            fechaCreacion: fechaActual
          };
          await db.collection('eventos').add(eventoData);
          
          // 5. Si la solicitud tiene datos de preparación, generar borrador(es) en preparacionSemanal
          if (solData.preparacion && solData.bienId && solData.diasSolicitud && solData.diasSolicitud.length > 0) {
            try {
              const DIAS_ABREV = ['dom', 'lun', 'mar', 'mie', 'jue', 'vie', 'sab'];
              
              // Helper: número de semana ISO
              function _getNumeroSemana(fecha) {
                const inicio = new Date(fecha.getFullYear(), 0, 1);
                const dias = Math.floor((fecha - inicio) / (24 * 60 * 60 * 1000));
                return Math.ceil((fecha.getDay() + 1 + dias) / 7);
              }
              
              // Agrupar fechas por semana ISO
              const semanas = {};
              solData.diasSolicitud.forEach(dateStr => {
                const d = new Date(dateStr + 'T12:00:00');
                const semKey = `${d.getFullYear()}-W${String(_getNumeroSemana(d)).padStart(2, '0')}`;
                if (!semanas[semKey]) semanas[semKey] = [];
                semanas[semKey].push({ dateStr, diaAbrev: DIAS_ABREV[d.getDay()] });
              });
              
              const prep = solData.preparacion;
              
              for (const [semanaKey, diasEnSemana] of Object.entries(semanas)) {
                // Construir personas con claves de día de semana
                const personasBorrador = {};
                const campos = ['familiares', 'desayuno', 'comida', 'cena', 'duermen'];
                campos.forEach(campo => {
                  personasBorrador[campo] = {};
                  diasEnSemana.forEach(dia => {
                    personasBorrador[campo][dia.diaAbrev] = 
                      (prep.personas?.[dia.dateStr]?.[campo]) || 0;
                  });
                });
                
                // Construir menús con claves pase-diaAbrev
                const menusBorrador = {};
                ['desayuno', 'aperitivo', 'comida', 'cena'].forEach(pase => {
                  diasEnSemana.forEach(dia => {
                    const origKey = `${pase}-${dia.dateStr}`;
                    const newKey = `${pase}-${dia.diaAbrev}`;
                    if (prep.menus?.[origKey]) {
                      menusBorrador[newKey] = prep.menus[origKey];
                    }
                  });
                });
                
                // Construir servicio con claves pase-diaAbrev
                const servicioBorrador = {};
                ['desayuno', 'aperitivo', 'comida', 'cena'].forEach(pase => {
                  diasEnSemana.forEach(dia => {
                    const origKey = `${pase}-${dia.dateStr}`;
                    const newKey = `${pase}-${dia.diaAbrev}`;
                    if (prep.servicio?.[origKey]) {
                      servicioBorrador[newKey] = prep.servicio[origKey];
                    }
                  });
                });
                
                // Guardar borrador
                await db.collection('bienes').doc(solData.bienId)
                  .collection('preparacionSemanal').doc(semanaKey).set({
                    zonas: prep.zonas || [],
                    zonasDesglose: prep.zonasDesglose || {},
                    personas: personasBorrador,
                    menus: menusBorrador,
                    servicio: servicioBorrador,
                    menajeEspecial: prep.menajeEspecial || false,
                    menajeAjuar: prep.menajeAjuar || [],
                    menaje: prep.menaje || [],
                    productosAportados: prep.productosAportados || [],
                    productosSolicitados: prep.productosSolicitados || [],
                    tareas: prep.tareas || [],
                    notas: prep.notas || '',
                    estado: 'borrador',
                    diasIncluidos: diasEnSemana.map(d => d.diaAbrev),
                    fechasOriginales: diasEnSemana.map(d => d.dateStr),
                    origenSolicitud: solicitudId,
                    creadoPor: currentUser.uid,
                    fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
                  }, { merge: true });
                
                console.log('📋 Borrador generado:', semanaKey, 'días:', diasEnSemana.map(d => d.diaAbrev).join(','));
              }
            } catch (borradorError) {
              console.warn('⚠️ Error generando borradores de preparación:', borradorError);
              // No interrumpir el flujo principal — la aprobación ya se hizo
            }
          }
        }
        
        cerrarModalRespuesta();
        await renderTablon();
        
        const mensajeExito = estadoSeleccionado === 'aprobada' 
          ? '✅ Solicitud aceptada y añadida al calendario'
          : estadoSeleccionado === 'rechazada'
          ? '❌ Solicitud rechazada'
          : '🔍 Solicitud marcada como "en estudio"';
        
        alert(mensajeExito);
        
      } catch (error) {
        console.error('Error respondiendo solicitud:', error);
        alert('Error al responder: ' + error.message);
      }
      
      btn.disabled = false;
      btn.innerHTML = '<span>📤</span> Responder';
    }

    // ============ OBTENER CASEROS DE UN BIEN ============
    async function obtenerCaserosBien(bienId) {
      // Obtiene los UIDs de usuarios que son caseros de este bien
      try {
        const caserosSnap = await db.collection('bienes').doc(bienId).collection('caseros')
          .where('activo', '==', true)
          .get();
        
        const caseroUIDs = [];
        
        for (const caseroDoc of caserosSnap.docs) {
          const casero = caseroDoc.data();
          if (casero.email) {
            // Buscar usuario por email
            const userSnap = await db.collection('usuarios')
              .where('email', '==', casero.email.toLowerCase())
              .limit(1)
              .get();
            
            if (!userSnap.empty) {
              caseroUIDs.push(userSnap.docs[0].id);
            }
          }
        }
        
        return caseroUIDs;
      } catch (e) {
        console.error('Error obteniendo caseros:', e);
        return [];
      }
    }

    // Función auxiliar para crear notificaciones (usada por herramientas)
    async function crearNotificacion(datos) {
      /*
        datos = {
          tipo: 'accion' | 'info',
          categoria: 'mercadillo' | 'votacion' | etc,
          titulo: string,
          mensaje: string (opcional),
          destinatarios: [uid, uid...],
          enlace: string (opcional),
          origen: { tipo: string, id: string } (opcional)
        }
      */
      const ahora = new Date();
      const expiracion = new Date(ahora);
      
      if (datos.tipo === 'info') {
        expiracion.setDate(expiracion.getDate() + 7); // Info expira en 7 días
      } else {
        expiracion.setFullYear(expiracion.getFullYear() + 1); // Acción no expira (1 año)
      }

      const notif = {
        tipo: datos.tipo,
        categoria: datos.categoria,
        titulo: datos.titulo,
        mensaje: datos.mensaje || null,
        familiaId: currentFamilia?.id || userData?.familiaId,
        destinatarios: datos.destinatarios,
        leidoPor: [],
        completadoPor: [],
        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
        fechaExpiracion: expiracion,
        enlace: datos.enlace || null,
        origen: datos.origen || null,
        estado: 'activa',
        recordatorioEnviado: false
      };

      return await db.collection('notificaciones').add(notif);
    }

    // ============ MENÚS (REAL) ============
    let menusData = [];

    async function renderMenus() {
      const container = document.getElementById('menus-list');
      const dias = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
      
      if (!miNidoPrincipal || !currentFamilia) {
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">🍽️</div>Sin menús</div>';
        return;
      }

      try {
        // Obtener próximos 3 días
        const hoy = new Date();
        const fechas = [];
        for (let i = 0; i < 3; i++) {
          const d = new Date(hoy);
          d.setDate(d.getDate() + i);
          fechas.push(d.toISOString().split('T')[0]);
        }

        const snap = await db.collection('menus')
          .where('familiaId', '==', currentFamilia.id)
          .where('fecha', 'in', fechas)
          .get();

        const menusMap = {};
        snap.docs.forEach(doc => {
          const data = doc.data();
          menusMap[data.fecha] = { id: doc.id, ...data };
        });

        container.innerHTML = fechas.map((fecha, i) => {
          const menu = menusMap[fecha];
          const d = new Date(fecha);
          const esHoy = i === 0;
          const diaLabel = esHoy ? 'HOY' : dias[d.getDay()];
          
          return `
            <div class="menu-dia">
              <div class="menu-dia-label ${esHoy ? 'hoy' : ''}">${diaLabel}</div>
              <div class="menu-comidas">
                <div class="menu-comida"><span class="menu-comida-tipo">🍽️</span> ${menu?.comida || '-'}</div>
                <div class="menu-comida"><span class="menu-comida-tipo">🌙</span> ${menu?.cena || '-'}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error cargando menús:', error);
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">🍽️</div>Sin menús</div>';
      }
    }

    // ============ ACCIONES - MODALES ============
    async function nuevaTarea() {
      const titulo = prompt('📋 Nueva tarea:\n\n¿Qué hay que hacer?');
      if (!titulo) return;

      const prioridad = prompt('Prioridad (alta/media/baja):', 'media') || 'media';
      const asignado = prompt('¿A quién se asigna? (nombre o vacío):', '') || null;

      try {
        await db.collection('tareas').add({
          titulo,
          prioridad: ['alta', 'media', 'baja'].includes(prioridad) ? prioridad : 'media',
          asignadoA: asignado,
          asignadoPor: currentUser.uid,
          nidoId: miNidoPrincipal?.id || null,
          familiaId: currentFamilia.id,
          completada: false,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('✅ Tarea creada');
        renderTareas();
      } catch (error) {
        console.error('Error creando tarea:', error);
        alert('Error al crear tarea');
      }
    }

    async function nuevoMensaje() {
      // Obtener miembros de la estirpe para seleccionar destinatario
      const miembros = [];
      allNidos.forEach(n => {
        (n.miembrosData || []).forEach(m => {
          if (m.email && m.email !== currentUser.email) {
            miembros.push(m);
          }
        });
      });

      if (miembros.length === 0) {
        alert('No hay miembros con email a quienes enviar mensaje');
        return;
      }

      const listaDestinatarios = miembros.map((m, i) => `${i + 1}. ${m.nombre || m.iniciales}`).join('\n');
      const seleccion = prompt(`📬 Nuevo mensaje\n\nSelecciona destinatario (número):\n${listaDestinatarios}`);
      
      if (!seleccion) return;
      const idx = parseInt(seleccion) - 1;
      if (idx < 0 || idx >= miembros.length) {
        alert('Selección inválida');
        return;
      }

      const destinatario = miembros[idx];
      const contenido = prompt(`Mensaje para ${destinatario.nombre || destinatario.iniciales}:`);
      if (!contenido) return;

      try {
        await db.collection('mensajes').add({
          de: currentUser.uid,
          deNombre: userData.nombre || currentUser.email.split('@')[0],
          para: destinatario.email, // Usamos email como ID temporal
          paraNombre: destinatario.nombre || destinatario.iniciales,
          contenido,
          familiaId: currentFamilia.id,
          leido: false,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('✅ Mensaje enviado');
      } catch (error) {
        console.error('Error enviando mensaje:', error);
        alert('Error al enviar mensaje');
      }
    }

    async function nuevoAnuncio() {
      const titulo = prompt('📢 Nuevo anuncio\n\nTítulo:');
      if (!titulo) return;

      const contenido = prompt('Contenido del anuncio:');
      if (!contenido) return;

      const tipoSeleccion = prompt('Tipo (1=Info, 2=Convocatoria, 3=Urgente):', '1');
      const tipos = { '1': 'info', '2': 'convocatoria', '3': 'urgente' };
      const tipo = tipos[tipoSeleccion] || 'info';

      try {
        await db.collection('anuncios').add({
          titulo,
          contenido,
          tipo,
          familiaId: currentFamilia.id,
          nidoId: null, // Visible para toda la estirpe
          autor: currentUser.uid,
          autorNombre: userData.nombre || currentUser.email.split('@')[0],
          activo: true,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('✅ Anuncio publicado');
        renderTablon();
      } catch (error) {
        console.error('Error publicando anuncio:', error);
        alert('Error al publicar anuncio');
      }
    }

    // ============ MOBILE NAV ============
    function toggleMobileNav() {
      const hamburger = document.getElementById('hamburger');
      const nav = document.getElementById('mobile-nav');
      hamburger.classList.toggle('active');
      nav.classList.toggle('active');
    }

    // ============ CHAT PANEL ============
    let conversacionesRecientes = [];

    function toggleChatPanel() {
      const panel = document.getElementById('chat-panel');
      const overlay = document.getElementById('chat-overlay');
      panel.classList.toggle('active');
      overlay.classList.toggle('active');

      if (panel.classList.contains('active') && currentFamilia) {
        cargarConversacionesRecientes();
      }
    }

    async function cargarConversacionesRecientes() {
      const container = document.getElementById('chat-panel-body');

      try {
        const snap = await db.collection('conversaciones')
          .where('participantes', 'array-contains', currentUser.uid)
          .limit(10)
          .get();

        conversacionesRecientes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Ordenar por último mensaje
        conversacionesRecientes.sort((a, b) => {
          const fechaA = a.ultimoMensaje?.fecha?.toDate?.() || new Date(0);
          const fechaB = b.ultimoMensaje?.fecha?.toDate?.() || new Date(0);
          return fechaB - fechaA;
        });

        renderConversacionesPanel();
        actualizarBadgeChat();

      } catch (error) {
        console.error('Error cargando conversaciones:', error);
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--text-muted);">
            <div>Error al cargar</div>
          </div>
        `;
      }
    }

    function renderConversacionesPanel() {
      const container = document.getElementById('chat-panel-body');

      if (conversacionesRecientes.length === 0) {
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--text-muted);">
            <div style="font-size: 2rem; margin-bottom: 8px;">💬</div>
            <div>No hay conversaciones</div>
            <a href="chat.html" style="display: inline-block; margin-top: 12px; color: var(--sage);">Iniciar un chat →</a>
          </div>
        `;
        return;
      }

      container.innerHTML = conversacionesRecientes.map(conv => {
        const tieneNoLeidos = conv.noLeidosPor?.includes(currentUser.uid);
        let avatar = '👤';
        let avatarClass = '';
        if (conv.tipo === 'nido') {
          avatar = '🪺';
          avatarClass = 'grupo';
        } else if (conv.tipo === 'grupo') {
          avatar = '👥';
          avatarClass = 'grupo';
        }

        const nombre = conv.nombre || 'Chat';
        const tiempo = formatearTiempoChat(conv.ultimoMensaje?.fecha);
        const preview = conv.ultimoMensaje?.texto || 'Sin mensajes';

        return `
          <div class="chat-panel-conv ${tieneNoLeidos ? 'unread' : ''}" onclick="abrirChatDesdePanel('${conv.id}')">
            <div class="chat-panel-avatar ${avatarClass}">${avatar}</div>
            <div class="chat-panel-info">
              <div class="chat-panel-name">${nombre}</div>
              <div class="chat-panel-preview">${preview.substring(0, 40)}${preview.length > 40 ? '...' : ''}</div>
            </div>
            <div class="chat-panel-time">${tiempo}</div>
          </div>
        `;
      }).join('');
    }

    function formatearTiempoChat(timestamp) {
      if (!timestamp) return '';
      const fecha = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const hoy = new Date();

      if (fecha.toDateString() === hoy.toDateString()) {
        return fecha.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
      }

      const ayer = new Date(hoy);
      ayer.setDate(ayer.getDate() - 1);
      if (fecha.toDateString() === ayer.toDateString()) {
        return 'Ayer';
      }

      return fecha.toLocaleDateString('es', { day: 'numeric', month: 'short' });
    }

    function abrirChatDesdePanel(convId) {
      window.location.href = `chat.html?conv=${convId}`;
    }

    function actualizarBadgeChat() {
      const badge = document.getElementById('chat-badge');
      const noLeidos = conversacionesRecientes.filter(c => c.noLeidosPor?.includes(currentUser.uid)).length;

      if (noLeidos > 0) {
        badge.textContent = noLeidos;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    // Cargar badge de chat al inicio
    async function cargarBadgeChat() {
      if (!currentUser) return;

      try {
        const snap = await db.collection('conversaciones')
          .where('participantes', 'array-contains', currentUser.uid)
          .where('noLeidosPor', 'array-contains', currentUser.uid)
          .get();

        const badge = document.getElementById('chat-badge');
        if (snap.size > 0) {
          badge.textContent = snap.size;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      } catch (error) {
        // Fallback si no hay índice
        console.warn('No se pudo cargar badge de chat');
      }
    }

    // ============ TIENDA ============
    let tiendaBienActual = null;
    let tiendaInventario = [];
    let tiendaEspeciales = [];
    let tiendaPedidos = [];
    let tiendaCarrito = [];
    let bienesConTienda = [];

    // Verificar si hay bienes con Mayordomo/Gerente activo
    async function verificarTiendaDisponible() {
      if (!currentFamilia) return;
      
      try {
        const snap = await db.collection('bienes')
          .where('familiaId', '==', currentFamilia.id)
          .get();
        
        bienesConTienda = snap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(b => b.mayordomoActivo || b.gerenteActivo);
        
        const cartBtn = document.getElementById('cart-btn');
        if (bienesConTienda.length > 0) {
          cartBtn.classList.remove('hidden');
          popularSelectBienesTienda();
        } else {
          cartBtn.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error verificando tienda:', error);
      }
    }

    function popularSelectBienesTienda() {
      const select = document.getElementById('tienda-bien-select');
      if (!select) return;
      
      select.innerHTML = '<option value="">Selecciona un bien...</option>' +
        bienesConTienda.map(b => `<option value="${b.id}">${b.nombre}</option>`).join('');
    }

    function toggleTienda() {
      const panel = document.getElementById('tienda-panel');
      const overlay = document.getElementById('tienda-overlay');
      panel.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    async function cambiarBienTienda() {
      const bienId = document.getElementById('tienda-bien-select').value;
      if (!bienId) {
        tiendaBienActual = null;
        tiendaInventario = [];
        tiendaEspeciales = [];
        tiendaPedidos = [];
        renderProductosBasicos();
        renderProductosEspeciales();
        renderPedidos();
        return;
      }

      tiendaBienActual = bienesConTienda.find(b => b.id === bienId);
      await cargarInventarioTienda(bienId);
      await cargarEspecialesTienda(bienId);
      await cargarPedidosTienda(bienId);
    }

    async function cargarInventarioTienda(bienId) {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('inventario-config').get();
        
        tiendaInventario = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderProductosBasicos();
      } catch (error) {
        console.error('Error cargando inventario:', error);
        tiendaInventario = [];
        renderProductosBasicos();
      }
    }

    async function cargarEspecialesTienda(bienId) {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('productos-especiales').orderBy('nombre').get();
        
        tiendaEspeciales = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderProductosEspeciales();
      } catch (error) {
        console.error('Error cargando especiales:', error);
        tiendaEspeciales = [];
        renderProductosEspeciales();
      }
    }

    async function cargarPedidosTienda(bienId) {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('pedidos').orderBy('fechaCreacion', 'desc').limit(20).get();
        
        tiendaPedidos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderPedidos();
        actualizarContadorPedidos();
      } catch (error) {
        console.error('Error cargando pedidos:', error);
        tiendaPedidos = [];
        renderPedidos();
      }
    }

    const catIconsTienda = {
      limpieza: '🧹', bano: '🚿', cocina: '🍳', alimentos: '🥫', bebidas: '🍷', otro: '📦'
    };

    function renderProductosBasicos() {
      const container = document.getElementById('productos-basicos');
      
      if (!tiendaBienActual || tiendaInventario.length === 0) {
        container.innerHTML = '<div class="tienda-empty">Selecciona un bien para ver su inventario</div>';
        return;
      }

      // Agrupar por categoría
      const porCategoria = {};
      tiendaInventario.forEach(item => {
        const cat = item.categoria || 'otro';
        if (!porCategoria[cat]) porCategoria[cat] = [];
        porCategoria[cat].push(item);
      });

      let html = '';
      Object.entries(porCategoria).forEach(([cat, items]) => {
        html += `
          <div class="tienda-categoria-grupo">
            <div class="tienda-categoria-titulo">${catIconsTienda[cat] || '📦'} ${cat}</div>
            ${items.map(item => renderProductoItem(item, 'basico')).join('')}
          </div>
        `;
      });

      container.innerHTML = html || '<div class="tienda-empty">Sin productos en inventario</div>';
    }

    function renderProductoItem(item, tipo) {
      const enCarrito = tiendaCarrito.find(c => c.itemId === item.id && c.tipo === tipo);
      const cantidad = enCarrito ? enCarrito.cantidad : 0;

      return `
        <div class="tienda-producto ${cantidad > 0 ? 'en-carrito' : ''}" data-id="${item.id}" data-tipo="${tipo}">
          <div class="tienda-producto-icon">${catIconsTienda[item.categoria] || '📦'}</div>
          <div class="tienda-producto-info">
            <div class="tienda-producto-nombre">${item.nombre || item.articulo}</div>
            <div class="tienda-producto-formato">${item.formato || item.unidad || ''}</div>
          </div>
          <div class="tienda-producto-cantidad">
            <button class="tienda-cantidad-btn" onclick="modificarCarrito('${item.id}', '${tipo}', -1)">−</button>
            <span class="tienda-cantidad-num">${cantidad}</span>
            <button class="tienda-cantidad-btn" onclick="modificarCarrito('${item.id}', '${tipo}', 1)">+</button>
          </div>
        </div>
      `;
    }

    function renderProductosEspeciales() {
      const container = document.getElementById('productos-especiales');
      
      if (!tiendaBienActual) {
        container.innerHTML = '<div class="tienda-empty">Selecciona un bien</div>';
        return;
      }

      if (tiendaEspeciales.length === 0) {
        container.innerHTML = '<div class="tienda-empty">Sin artículos especiales. ¡Añade uno arriba!</div>';
        return;
      }

      container.innerHTML = tiendaEspeciales.map(item => `
        <div class="tienda-producto ${tiendaCarrito.find(c => c.itemId === item.id) ? 'en-carrito' : ''}" data-id="${item.id}" data-tipo="especial">
          <div class="tienda-producto-icon">⭐</div>
          <div class="tienda-producto-info">
            <div class="tienda-producto-nombre">${item.articulo}</div>
            <div class="tienda-producto-formato">${item.formato || ''} ${item.unidades ? `(${item.unidades} uds)` : ''}</div>
          </div>
          <div class="tienda-producto-cantidad">
            <button class="tienda-cantidad-btn" onclick="modificarCarrito('${item.id}', 'especial', -1)">−</button>
            <span class="tienda-cantidad-num">${tiendaCarrito.find(c => c.itemId === item.id)?.cantidad || 0}</span>
            <button class="tienda-cantidad-btn" onclick="modificarCarrito('${item.id}', 'especial', 1)">+</button>
          </div>
        </div>
      `).join('');
    }

    function modificarCarrito(itemId, tipo, delta) {
      let item = tiendaCarrito.find(c => c.itemId === itemId && c.tipo === tipo);
      
      if (!item && delta > 0) {
        // Buscar datos del producto
        let producto;
        if (tipo === 'basico') {
          producto = tiendaInventario.find(p => p.id === itemId);
        } else {
          producto = tiendaEspeciales.find(p => p.id === itemId);
        }
        
        if (producto) {
          tiendaCarrito.push({
            itemId,
            tipo,
            nombre: producto.nombre || producto.articulo,
            formato: producto.formato || producto.unidad || '',
            cantidad: 1
          });
        }
      } else if (item) {
        item.cantidad += delta;
        if (item.cantidad <= 0) {
          tiendaCarrito = tiendaCarrito.filter(c => !(c.itemId === itemId && c.tipo === tipo));
        }
      }

      actualizarContadorCarrito();
      renderProductosBasicos();
      renderProductosEspeciales();
    }

    function actualizarContadorCarrito() {
      const count = tiendaCarrito.reduce((sum, item) => sum + item.cantidad, 0);
      document.getElementById('carrito-count').textContent = count;
      
      const badge = document.getElementById('cart-badge');
      badge.textContent = count;
      badge.classList.toggle('hidden', count === 0);
    }

    async function añadirEspecial() {
      if (!tiendaBienActual) {
        alert('Selecciona primero un bien');
        return;
      }

      const articulo = document.getElementById('especial-articulo').value.trim();
      const formato = document.getElementById('especial-formato').value.trim();
      const unidades = parseInt(document.getElementById('especial-unidades').value) || 1;

      if (!articulo) {
        alert('Escribe el nombre del artículo');
        return;
      }

      try {
        await db.collection('bienes').doc(tiendaBienActual.id)
          .collection('productos-especiales').add({
            articulo,
            formato,
            unidades,
            creadoPor: currentUser.uid,
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
          });

        document.getElementById('especial-articulo').value = '';
        document.getElementById('especial-formato').value = '';
        document.getElementById('especial-unidades').value = '1';

        await cargarEspecialesTienda(tiendaBienActual.id);
      } catch (error) {
        console.error('Error añadiendo especial:', error);
        alert('Error al añadir artículo');
      }
    }

    function cambiarTabTienda(tab) {
      document.querySelectorAll('.tienda-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tienda-tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.tienda-tab[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    let filtroEstadoActual = 'todos';

    function filtrarPedidos(estado) {
      filtroEstadoActual = estado;
      document.querySelectorAll('.pedido-filtro').forEach(f => f.classList.remove('active'));
      document.querySelector(`.pedido-filtro[data-estado="${estado}"]`).classList.add('active');
      renderPedidos();
    }

    function renderPedidos() {
      const container = document.getElementById('pedidos-lista');
      
      if (!tiendaBienActual) {
        container.innerHTML = '<div class="tienda-empty">Selecciona un bien</div>';
        return;
      }

      let pedidosFiltrados = tiendaPedidos;
      if (filtroEstadoActual !== 'todos') {
        pedidosFiltrados = tiendaPedidos.filter(p => p.estado === filtroEstadoActual);
      }

      if (pedidosFiltrados.length === 0) {
        container.innerHTML = '<div class="tienda-empty">Sin pedidos</div>';
        return;
      }

      container.innerHTML = pedidosFiltrados.map(pedido => {
        const fecha = pedido.fechaCreacion?.toDate?.() || new Date(pedido.fechaCreacion);
        const fechaStr = fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        
        return `
          <div class="pedido-card ${pedido.estado}">
            <div class="pedido-header">
              <span class="pedido-fecha">${fechaStr}</span>
              <span class="pedido-estado ${pedido.estado}">${getEstadoLabel(pedido.estado)}</span>
            </div>
            <div class="pedido-items">
              <span class="pedido-items-count">${pedido.items?.length || 0} artículos</span>
              ${pedido.items?.slice(0, 3).map(i => i.nombre).join(', ') || ''}
              ${pedido.items?.length > 3 ? '...' : ''}
            </div>
            <div class="pedido-actions">
              ${pedido.estado === 'pendiente' ? `<button onclick="cambiarEstadoPedido('${pedido.id}', 'en-curso')">🔵 En curso</button>` : ''}
              ${pedido.estado === 'en-curso' ? `<button onclick="cambiarEstadoPedido('${pedido.id}', 'realizado')">🟢 Completar</button>` : ''}
              <button onclick="verDetallePedido('${pedido.id}')">👁️ Ver</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function getEstadoLabel(estado) {
      const labels = {
        'pendiente': '🟡 Pendiente',
        'en-curso': '🔵 En curso',
        'realizado': '🟢 Realizado'
      };
      return labels[estado] || estado;
    }

    async function cambiarEstadoPedido(pedidoId, nuevoEstado) {
      if (!tiendaBienActual) return;

      try {
        await db.collection('bienes').doc(tiendaBienActual.id)
          .collection('pedidos').doc(pedidoId).update({
            estado: nuevoEstado,
            fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
          });

        await cargarPedidosTienda(tiendaBienActual.id);
      } catch (error) {
        console.error('Error actualizando pedido:', error);
      }
    }

    function verDetallePedido(pedidoId) {
      const pedido = tiendaPedidos.find(p => p.id === pedidoId);
      if (!pedido) return;

      const items = pedido.items?.map(i => `• ${i.nombre} x${i.cantidad}`).join('\n') || 'Sin items';
      alert(`📋 Pedido\n\n${items}\n\nEstado: ${getEstadoLabel(pedido.estado)}`);
    }

    function actualizarContadorPedidos() {
      const pendientes = tiendaPedidos.filter(p => p.estado === 'pendiente' || p.estado === 'en-curso').length;
      document.getElementById('pedidos-count').textContent = pendientes;
    }

    async function crearPedido() {
      if (!tiendaBienActual) {
        alert('Selecciona un bien primero');
        return;
      }

      if (tiendaCarrito.length === 0) {
        alert('El carrito está vacío');
        return;
      }

      try {
        await db.collection('bienes').doc(tiendaBienActual.id)
          .collection('pedidos').add({
            items: tiendaCarrito.map(item => ({
              nombre: item.nombre,
              formato: item.formato,
              cantidad: item.cantidad,
              tipo: item.tipo
            })),
            estado: 'pendiente',
            creadoPor: currentUser.uid,
            creadoPorNombre: userData?.nombre || userData?.email,
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
          });

        tiendaCarrito = [];
        actualizarContadorCarrito();
        renderProductosBasicos();
        renderProductosEspeciales();
        
        await cargarPedidosTienda(tiendaBienActual.id);
        cambiarTabTienda('pedidos');
        
        alert('✅ Pedido creado correctamente');
      } catch (error) {
        console.error('Error creando pedido:', error);
        alert('Error al crear pedido');
      }
    }

    // ============ CTAs (ACCIONES RÁPIDAS) ============
    let bienesUsuario = [];
    let bienesConGestion = []; // Solo bienes con add-on activo para reservas
    let adminsEstirpe = [];
    let nidosData = []; // Nidos de la rama
    let otrosGruposData = []; // Otros grupos de reserva
    let configCalendarioData = null; // Configuración del calendario familiar
    let tiposReservaActuales = []; // Tipos cargados para el bien seleccionado

    // Cargar configuración del calendario (tipos de reserva y otros grupos)
    async function cargarConfigCalendario() {
      if (!currentFamilia?.id) return;
      
      try {
        // Cargar config del calendario
        const configDoc = await db.collection('familias').doc(currentFamilia.id)
          .collection('config').doc('calendarioFamiliar').get();
        
        if (configDoc.exists) {
          const rawConfig = configDoc.data();
          
          // Parsear estructura {tiposAddon: {addon: {tipo: {visibleCGI, color}}}}
          configCalendarioData = {
            hitos: {},
            tiposAddon: {},
            externos: {}
          };
          
          if (rawConfig.tiposAddon) {
            // Hitos familiares
            if (rawConfig.tiposAddon.hitos) {
              configCalendarioData.hitos = rawConfig.tiposAddon.hitos;
            }
            
            // Add-ons de reserva
            ['mayordomo', 'gerente', 'capataz'].forEach(addon => {
              if (rawConfig.tiposAddon[addon]) {
                configCalendarioData.tiposAddon[addon] = [];
                Object.entries(rawConfig.tiposAddon[addon]).forEach(([tipoId, tipoData]) => {
                  configCalendarioData.tiposAddon[addon].push({
                    id: tipoId,
                    visibleCGI: tipoData.visibleCGI || false,
                    color: tipoData.color || '#7A9E7E',
                    emoji: tipoData.emoji || '📋',
                    nombre: tipoData.nombre || tipoId,
                    esFamiliar: tipoData.esFamiliar || false
                  });
                });
              }
            });
            
            // Externos
            if (rawConfig.tiposAddon.externos) {
              configCalendarioData.externos = {
                mostrarLibranzas: rawConfig.tiposAddon.externos.libranzas?.visibleCGI || false,
                mostrarVacaciones: rawConfig.tiposAddon.externos.vacaciones?.visibleCGI || false
              };
            }
          }
        } else {
          configCalendarioData = null;
        }
        
        // Cargar otros grupos de reserva
        const otrosSnap = await db.collection('familias').doc(currentFamilia.id)
          .collection('otrosGruposReserva').orderBy('orden', 'asc').get();
        otrosGruposData = otrosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        console.log('✅ Config calendario cargada, otros grupos:', otrosGruposData.length);
      } catch (e) {
        console.warn('Error cargando config calendario:', e);
      }
    }

    // Cargar nidos de la rama
    async function cargarNidosRama() {
      if (!currentFamilia?.id) return;
      
      try {
        const nidosSnap = await db.collection('nidos').where('familiaId', '==', currentFamilia.id).get();
        nidosData = nidosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        console.log('✅ Nidos cargados:', nidosData.length);
      } catch (e) {
        console.warn('Error cargando nidos:', e);
      }
    }

    // Mostrar/ocultar selector de quién reserva
    function mostrarSelectorQuienReserva() {
      const tipoId = document.getElementById('reserva-tipo').value;
      const container = document.getElementById('reserva-quien-container');
      const select = document.getElementById('reserva-quien');
      
      if (!tipoId) {
        container.style.display = 'none';
        return;
      }
      
      // Buscar si el tipo es familiar
      const tipoActual = tiposReservaActuales.find(t => t.id === tipoId);
      
      if (tipoActual?.esFamiliar) {
        // Mostrar selector con nidos + otros grupos
        let options = '<option value="">¿Quién reserva?</option>';
        
        // Añadir nidos
        if (nidosData.length > 0) {
          options += '<optgroup label="🏠 Nidos">';
          nidosData.forEach(nido => {
            const label = nido.nombre || 'Nido sin nombre';
            options += `<option value="nido:${nido.id}" data-tipo="nido">${label}</option>`;
          });
          options += '</optgroup>';
        }
        
        // Añadir otros grupos
        if (otrosGruposData.length > 0) {
          options += '<optgroup label="📋 Otros grupos">';
          otrosGruposData.forEach(grupo => {
            const emoji = grupo.emoji || '📋';
            options += `<option value="otro:${grupo.id}" data-tipo="otro">${emoji} ${grupo.nombre}</option>`;
          });
          options += '</optgroup>';
        }
        
        select.innerHTML = options;
        container.style.display = 'block';
        select.required = true;
      } else {
        container.style.display = 'none';
        select.required = false;
      }
    }

    // Cargar bienes filtrados por visibilidad del usuario
    async function cargarBienesUsuario() {
      if (bienesUsuario.length > 0) return;
      if (!currentFamilia?.id) {
        console.warn('cargarBienesUsuario: No hay familia activa');
        return;
      }
      try {
        console.log('Cargando bienes para familia:', currentFamilia.id);
        const snap = await db.collection('bienes').where('familiaId', '==', currentFamilia.id).get();
        const todosBienes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        console.log('Bienes encontrados:', todosBienes.length);
        
        // Cargar mapa de nidos para verificar visibilidad
        const nidosSnap = await db.collection('nidos').where('familiaId', '==', currentFamilia.id).get();
        const nidosMap = {};
        nidosSnap.docs.forEach(doc => {
          nidosMap[doc.id] = { id: doc.id, ...doc.data() };
        });
        
        // Obtener configuración de tipos activos
        const config = currentFamilia.configSecciones || {};
        const tiposConfig = config.locomun || { inmuebles: true, terrenos: true, vehiculos: true, ajuar: true };
        const tipoMap = { inmueble: 'inmuebles', terreno: 'terrenos', vehiculo: 'vehiculos', ajuar: 'ajuar' };
        
        // Filtrar bienes por visibilidad Y por tipos activos (solo si no es admin)
        bienesUsuario = todosBienes.filter(bien => {
          // 1. Verificar visibilidad
          if (!esVisibleParaUsuario(bien, nidosMap)) return false;
          
          // 2. Si es admin, no filtrar por tipos
          if (esAdminRama) return true;
          
          // 3. Verificar si el tipo está activo
          const tipoConfigKey = tipoMap[bien.tipo] || bien.tipo;
          return tiposConfig[tipoConfigKey] !== false;
        });
        console.log('Bienes visibles para usuario:', bienesUsuario.length);
      } catch (e) { 
        console.error('Error cargando bienes:', e); 
        // Fallback: cargar todos los bienes sin filtro de visibilidad
        try {
          const snap = await db.collection('bienes').where('familiaId', '==', currentFamilia.id).get();
          bienesUsuario = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          console.log('Bienes (fallback):', bienesUsuario.length);
        } catch (e2) {
          console.error('Error fallback bienes:', e2);
        }
      }
    }

    // Cargar bienes que tienen add-on de gestión activo (Mayordomo, Gerente o Capataz)
    async function cargarBienesConGestion() {
      await cargarBienesUsuario(); // Primero cargar bienes visibles
      
      // Filtrar solo los que tienen gestión activa
      bienesConGestion = bienesUsuario.filter(bien => {
        return bien.mayordomoActivo || bien.gerenteActivo || bien.capatazActivo;
      });
      
      return bienesConGestion;
    }

    // Popular select con bienes que tienen gestión (para reservas)
    function popularSelectBienesConGestion(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      
      if (bienesConGestion.length === 0) {
        select.innerHTML = '<option value="">No hay bienes con gestión activa</option>';
        return;
      }
      
      select.innerHTML = '<option value="">Selecciona un bien...</option>' +
        bienesConGestion.map(b => {
          const gestion = b.mayordomoActivo ? '🎩' : b.gerenteActivo ? '💼' : '🚜';
          return `<option value="${b.id}">${gestion} ${b.nombre}</option>`;
        }).join('');
    }

    async function cargarAdminsEstirpe() {
      if (adminsEstirpe.length > 0) return adminsEstirpe;
      
      if (!currentFamilia?.id) {
        console.warn('cargarAdminsEstirpe: No hay familia activa');
        return [];
      }
      
      try {
        const usuariosSnap = await db.collection('usuarios')
          .where('familiaId', '==', currentFamilia.id)
          .get();
        
        console.log('Usuarios en familia:', usuariosSnap.size);
        
        adminsEstirpe = usuariosSnap.docs
          .map(d => ({ uid: d.id, ...d.data() }))
          .filter(u => {
            // Normalizar a minúsculas para comparar
            const rol = String(u.rol || '').toLowerCase();
            const credencial = String(u.credencial || '').toLowerCase();
            
            // Buscar cualquier variante de admin, patriarca o matriarca
            const esAdmin = 
              rol.includes('admin') ||
              credencial.includes('admin') ||
              rol === 'patriarca' ||
              rol === 'matriarca' ||
              credencial === 'patriarca' ||
              credencial === 'matriarca' ||
              u.esAdmin === true ||
              u.adminRama === true ||
              u.adminNido === true ||
              u.superAdmin === true ||
              u.esPatriarca === true ||
              u.esMatriarca === true;
            
            return esAdmin;
          });
        
        console.log('Admins/Patriarcas encontrados:', adminsEstirpe.length, adminsEstirpe.map(a => a.nombre || a.email));
        
        return adminsEstirpe;
      } catch (e) { 
        console.error('Error cargando admins:', e);
        return [];
      }
    }

    async function enviarNotificacionAdmins(tipo, datos) {
      // Verificar que hay familia activa
      if (!currentFamilia?.id) {
        throw new Error('No hay familia activa. Por favor, recarga la página.');
      }
      
      // Verificar usuario autenticado
      if (!currentUser?.uid) {
        throw new Error('Usuario no autenticado. Por favor, inicia sesión de nuevo.');
      }
      
      const admins = await cargarAdminsEstirpe();
      const remitente = userData?.nombre || userData?.email || 'Usuario';
      
      console.log('=== ENVIAR NOTIFICACIÓN ===');
      console.log('Tipo:', tipo);
      console.log('FamiliaId:', currentFamilia.id);
      console.log('Usuario actual:', currentUser.uid);
      console.log('Admins totales:', admins.length);
      
      const solicitud = {
        tipo, // 'iniciativa', 'evento', 'reserva', 'averia'
        ...datos,
        estado: 'pendiente', // pendiente (amarillo) -> respondido (verde)
        solicitadoPor: currentUser.uid,
        solicitadoPorNombre: remitente,
        solicitadoPorNido: miNidoPrincipal?.nombre || '',
        solicitadoPorNidoId: miNidoPrincipal?.id || null,
        familiaId: currentFamilia.id,
        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
        respuesta: null,
        respondidoPor: null,
        fechaRespuesta: null
      };

      // Guardar solicitud en colección central
      let solicitudRef;
      try {
        solicitudRef = await db.collection('solicitudes').add(solicitud);
        console.log('✅ Solicitud creada:', solicitudRef.id);
      } catch (errorSolicitud) {
        console.error('❌ Error creando solicitud:', errorSolicitud);
        throw new Error('Error de permisos al guardar la solicitud. Contacte al administrador.');
      }

      // Obtener UIDs de admins (excluyendo al propio usuario si es admin)
      const destinatarios = admins
        .filter(admin => admin.uid !== currentUser.uid)
        .map(admin => admin.uid);

      console.log('Destinatarios (excluye usuario actual):', destinatarios.length, destinatarios);

      // Si no hay otros admins, incluir al propio usuario si es admin
      let destinatariosFinales = destinatarios;
      if (destinatarios.length === 0 && admins.length > 0) {
        console.log('⚠️ Solo hay un admin (el solicitante), incluyéndolo en destinatarios');
        destinatariosFinales = admins.map(admin => admin.uid);
      }

      // Crear UNA notificación en la colección central (la que lee el tablón)
      if (destinatariosFinales.length > 0) {
        try {
          const notifData = {
            tipo: 'accion',
            categoria: tipo,
            titulo: getTituloNotificacion(tipo, datos),
            mensaje: `${remitente} ha enviado una solicitud`,
            familiaId: currentFamilia.id,
            nidoId: miNidoPrincipal?.id || null,
            destinatarios: destinatariosFinales,
            leidoPor: [],
            completadoPor: [],
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            fechaExpiracion: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 días
            enlace: `solicitudes.html?id=${solicitudRef.id}`,
            origen: { tipo: 'solicitud', subtipo: tipo, id: solicitudRef.id },
            estado: 'activa'
          };
          
          console.log('Creando notificación:', notifData);
          
          const notifRef = await db.collection('notificaciones').add(notifData);
          console.log('✅ Notificación creada:', notifRef.id, 'para', destinatariosFinales.length, 'admins');
        } catch (errorNotif) {
          console.error('❌ Error creando notificación:', errorNotif);
          // No lanzamos error aquí porque la solicitud ya se guardó
        }
      } else {
        console.warn('⚠️ No hay admins para notificar en esta familia');
      }

      return solicitudRef.id;
    }

    function getTituloNotificacion(tipo, datos) {
      switch(tipo) {
        case 'iniciativa': return `💡 Nueva propuesta: ${datos.titulo || 'Sin título'}`;
        case 'evento': return `🎉 Solicitud de evento: ${datos.nombre || 'Sin nombre'}`;
        case 'reserva': return `📅 Solicitud de reserva: ${datos.bienNombre || 'Bien'}`;
        case 'averia': return `🔧 Avería reportada: ${datos.bienNombre || datos.descripcion?.substring(0, 30) || 'Ver detalle'}`;
        case 'encargo': return `🛒 Nuevo encargo: ${datos.bienNombre || 'Bien'}`;
        case 'confirmacion-finde': 
          const fechaCorta = datos.fechaEntrada ? new Date(datos.fechaEntrada).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }) : '';
          return `🏡 Confirmación finde: ${datos.bienNombre || 'Llegada'} ${fechaCorta} (${datos.personas} pers.)`;
        default: return '📌 Nueva solicitud';
      }
    }

    function popularSelectBienes(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = '<option value="">Selecciona un bien...</option>' +
        bienesUsuario.map(b => `<option value="${b.id}">${b.nombre}</option>`).join('');
    }

    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
    }

    function abandonarModal(tipo) {
      track.abandonar(tipo);
      cerrarModales();
    }

    function seleccionarVisibilidad(elemento, formulario) {
      // Quitar active de todas las opciones del mismo formulario
      const contenedor = elemento.closest('.visibilidad-selector');
      contenedor.querySelectorAll('.visibilidad-option').forEach(opt => opt.classList.remove('active'));
      // Activar la seleccionada
      elemento.classList.add('active');
      elemento.querySelector('input').checked = true;
    }

    function obtenerVisibilidad(formulario) {
      const radio = document.querySelector(`input[name="${formulario}-visibilidad"]:checked`);
      return radio ? radio.value : 'rama';
    }

    // Resetear selector de visibilidad a 'rama' en un modal
    function resetVisibilidad(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      modal.querySelectorAll('.visibilidad-option').forEach(opt => {
        opt.classList.remove('active');
        const input = opt.querySelector('input');
        if (input && input.value === 'rama') {
          opt.classList.add('active');
          input.checked = true;
        }
      });
    }

    async function abrirModalAveria() {
      await cargarBienesUsuario();
      popularSelectBienes('averia-bien');
      document.getElementById('form-averia').reset();
      resetVisibilidad('modal-averia');
      document.getElementById('modal-averia').classList.add('active');
      track.iniciar('averia');
    }

    async function abrirModalIniciativa() {
      document.getElementById('form-iniciativa').reset();
      resetVisibilidad('modal-iniciativa');
      document.getElementById('modal-iniciativa').classList.add('active');
      track.iniciar('iniciativa');
    }

    async function abrirModalSolicitarEvento() {
      await cargarBienesUsuario();
      popularSelectBienes('evento-bien');
      document.getElementById('form-evento').reset();
      resetVisibilidad('modal-evento');
      // Ocultar selector de tipo hasta que se elija bien
      document.getElementById('evento-tipo-container').style.display = 'none';
      document.getElementById('evento-fecha').min = new Date().toISOString().split('T')[0];
      document.getElementById('modal-evento').classList.add('active');
      track.iniciar('evento');
    }

    async function abrirModalSolicitarReserva() {
      window.location.href = 'solicitud-preparacion.html';
    }

    // ============ SOLICITAR — REDIRIGIR DIRECTO ============
    function abrirModalSolicitar() {
      window.location.href = 'solicitud-preparacion.html';
    }

    // ============ MODAL CONFIRMACIÓN FINDE ============
    let habitacionesSeleccionadas = [];
    let habitacionesBienActual = [];

    async function abrirModalConfirmacionFinde() {
      await cargarBienesConGestion();
      
      // Verificar si hay bienes con gestión
      if (bienesConGestion.length === 0) {
        alert('No hay bienes con gestión activa.\n\nPara confirmar tu llegada, primero debe activarse Mayordomo, Gerente o Capataz en algún bien.');
        return;
      }
      
      // Popular select de bienes
      const selectBien = document.getElementById('finde-bien');
      selectBien.innerHTML = '<option value="">Selecciona...</option>' + 
        bienesConGestion.map(b => `<option value="${b.id}">${b.nombre}</option>`).join('');
      
      // Reset formulario
      document.getElementById('form-confirmacion-finde').reset();
      document.getElementById('finde-menus-detalle').style.display = 'none';
      
      // Configurar fechas mínimas (hoy)
      const hoy = new Date().toISOString().split('T')[0];
      document.getElementById('finde-fecha-entrada').min = hoy;
      document.getElementById('finde-fecha-salida').min = hoy;
      
      // Reset habitaciones
      habitacionesSeleccionadas = [];
      habitacionesBienActual = [];
      document.getElementById('finde-habitaciones-container').style.display = 'none';
      document.getElementById('finde-habitaciones-empty').style.display = 'block';
      document.getElementById('finde-habitaciones-chips').innerHTML = '';
      
      document.getElementById('modal-confirmacion-finde').classList.add('active');
      track.iniciar('finde');
    }

    async function cargarHabitacionesBien() {
      const bienId = document.getElementById('finde-bien').value;
      const container = document.getElementById('finde-habitaciones-container');
      const emptyMsg = document.getElementById('finde-habitaciones-empty');
      const select = document.getElementById('finde-habitaciones-select');
      
      // Reset
      habitacionesSeleccionadas = [];
      habitacionesBienActual = [];
      document.getElementById('finde-habitaciones-chips').innerHTML = '';
      
      if (!bienId) {
        container.style.display = 'none';
        emptyMsg.style.display = 'block';
        emptyMsg.textContent = 'Selecciona primero una casa para ver sus habitaciones';
        return;
      }
      
      // Buscar el bien y sus habitaciones
      const bien = bienesConGestion.find(b => b.id === bienId);
      if (!bien || !bien.habitaciones || bien.habitaciones.length === 0) {
        container.style.display = 'none';
        emptyMsg.style.display = 'block';
        emptyMsg.textContent = 'Este bien no tiene habitaciones definidas';
        return;
      }
      
      habitacionesBienActual = bien.habitaciones;
      
      // Popular select
      select.innerHTML = '<option value="">+ Añadir habitación...</option>' +
        habitacionesBienActual.map((h, idx) => {
          const nombre = typeof h === 'string' ? h : h.nombre;
          return `<option value="${idx}">${nombre}</option>`;
        }).join('');
      
      container.style.display = 'block';
      emptyMsg.style.display = 'none';
    }

    function addHabitacionFinde() {
      const select = document.getElementById('finde-habitaciones-select');
      const idx = select.value;
      
      if (idx === '') return;
      
      const habitacion = habitacionesBienActual[idx];
      const nombre = typeof habitacion === 'string' ? habitacion : habitacion.nombre;
      
      // Evitar duplicados
      if (habitacionesSeleccionadas.includes(nombre)) {
        select.value = '';
        return;
      }
      
      habitacionesSeleccionadas.push(nombre);
      renderHabitacionesChips();
      select.value = '';
    }

    function removeHabitacionFinde(nombre) {
      habitacionesSeleccionadas = habitacionesSeleccionadas.filter(h => h !== nombre);
      renderHabitacionesChips();
    }

    function renderHabitacionesChips() {
      const container = document.getElementById('finde-habitaciones-chips');
      container.innerHTML = habitacionesSeleccionadas.map(nombre => `
        <span class="habitacion-chip">
          🛏️ ${nombre}
          <button type="button" class="habitacion-chip-remove" onclick="removeHabitacionFinde('${nombre}')">✕</button>
        </span>
      `).join('');
    }

    function toggleMenusNuevos() {
      const valor = document.querySelector('input[name="finde-menus-nuevos"]:checked').value;
      document.getElementById('finde-menus-detalle').style.display = valor === 'si' ? 'block' : 'none';
    }

    // Envío del formulario de Confirmación Finde
    document.getElementById('form-confirmacion-finde')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '⏳ Enviando...';
      
      try {
        const bienId = document.getElementById('finde-bien').value;
        const bien = bienesConGestion.find(b => b.id === bienId);
        
        const datos = {
          bienId: bienId,
          bienNombre: bien?.nombre || '',
          fechaEntrada: document.getElementById('finde-fecha-entrada').value,
          fechaSalida: document.getElementById('finde-fecha-salida').value,
          horaLlegada: document.getElementById('finde-hora-llegada').value,
          horaSalida: document.getElementById('finde-hora-salida').value || null,
          personas: parseInt(document.getElementById('finde-personas').value) || 1,
          habitaciones: habitacionesSeleccionadas,
          menusNuevos: document.querySelector('input[name="finde-menus-nuevos"]:checked').value === 'si',
          menusCuales: document.getElementById('finde-menus-cuales')?.value || '',
          sujetarPerros: document.querySelector('input[name="finde-sujetar-perros"]:checked').value === 'si',
          notas: document.getElementById('finde-notas').value || ''
        };
        
        await enviarSolicitud('confirmacion-finde', datos);
        
        alert('✅ Confirmación de fin de semana enviada');
        track.completar('finde');
        cerrarModales();
        
      } catch (error) {
        console.error('Error enviando confirmación:', error);
        alert('Error al enviar: ' + error.message);
      }
      
      btn.disabled = false;
      btn.innerHTML = '✅ Confirmar llegada';
    });

    // Cargar tipos de reserva según el add-on del bien seleccionado
    async function cargarTiposReserva() {
      const bienId = document.getElementById('reserva-bien').value;
      const container = document.getElementById('reserva-tipo-container');
      const select = document.getElementById('reserva-tipo');
      const quienContainer = document.getElementById('reserva-quien-container');
      
      // Ocultar selector de quién reserva al cambiar bien
      quienContainer.style.display = 'none';
      
      if (!bienId) {
        container.style.display = 'none';
        tiposReservaActuales = [];
        return;
      }
      
      // Buscar el bien en bienesConGestion
      const bien = bienesConGestion.find(b => b.id === bienId);
      if (!bien) {
        container.style.display = 'none';
        tiposReservaActuales = [];
        return;
      }
      
      // Cargar config y nidos si no están cargados
      if (!configCalendarioData) {
        await cargarConfigCalendario();
      }
      if (nidosData.length === 0) {
        await cargarNidosRama();
      }
      
      // Determinar qué add-on tiene activo
      let addon = null;
      if (bien.mayordomoActivo) addon = 'mayordomo';
      else if (bien.gerenteActivo) addon = 'gerente';
      else if (bien.capatazActivo) addon = 'capataz';
      
      let tipos = [];
      
      // Cargar tipos desde la nueva config (ya parseada como array)
      if (addon && configCalendarioData?.tiposAddon?.[addon]) {
        tipos = configCalendarioData.tiposAddon[addon].map(t => ({
          id: t.id,
          nombre: t.nombre,
          icono: t.emoji || '',
          color: t.color || '#7A9E7E',
          esFamiliar: t.esFamiliar || false,
          visibleCGI: t.visibleCGI !== false
        }));
      }
      
      // Si no hay tipos en config, usar tipos por defecto
      if (tipos.length === 0) {
        if (addon === 'mayordomo') {
          tipos = [
            { id: 'estancia-familiar', nombre: 'Estancias Familiares', icono: '👨‍👩‍👧‍👦', esFamiliar: true },
            { id: 'evento', nombre: 'Eventos', icono: '🎉', esFamiliar: false },
            { id: 'otros', nombre: 'Otros', icono: '📋', esFamiliar: false }
          ];
        } else if (addon === 'gerente') {
          tipos = [
            { id: 'reserva-familiar', nombre: 'Reservas familiares', icono: '👨‍👩‍👧‍👦', esFamiliar: true },
            { id: 'reserva-huespedes', nombre: 'Reservas de huéspedes', icono: '👥', esFamiliar: false }
          ];
        } else if (addon === 'capataz') {
          tipos = [
            { id: 'caceria', nombre: 'Cacerías', icono: '🦌', esFamiliar: false },
            { id: 'actividad', nombre: 'Otras actividades', icono: '🎯', esFamiliar: false }
          ];
        }
      }
      
      // Almacenar para usar en mostrarSelectorQuienReserva
      tiposReservaActuales = tipos;
      
      // Popular el select
      if (tipos.length > 0) {
        select.innerHTML = '<option value="">Selecciona tipo...</option>' +
          tipos.map(t => `<option value="${t.id}">${t.icono || '📌'} ${t.nombre}</option>`).join('');
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }

    // Cargar tipos de evento según el bien seleccionado
    async function cargarTiposEvento() {
      const bienId = document.getElementById('evento-bien').value;
      const container = document.getElementById('evento-tipo-container');
      const select = document.getElementById('evento-tipo');
      
      if (!bienId) {
        container.style.display = 'none';
        return;
      }
      
      // Buscar el bien
      const bien = bienesVisibles.find(b => b.id === bienId);
      if (!bien) {
        container.style.display = 'none';
        return;
      }
      
      // Tipos de evento (pueden variar según si tiene add-on o no)
      let tipos = [];
      
      try {
        // Cargar tipos de evento de la familia
        const tiposSnap = await db.collection('familias').doc(currentFamilia.id)
          .collection('tiposEvento').get();
        tipos = tiposSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Si no hay tipos configurados, usar los por defecto
        if (tipos.length === 0) {
          tipos = [
            { id: 'celebracion', nombre: 'Celebración', icono: '🎉' },
            { id: 'reunion', nombre: 'Reunión familiar', icono: '👨‍👩‍👧‍👦' },
            { id: 'comida', nombre: 'Comida/Cena', icono: '🍽️' },
            { id: 'otro', nombre: 'Otro', icono: '📌' }
          ];
        }
      } catch (e) {
        console.warn('Error cargando tipos de evento:', e);
        tipos = [
          { id: 'celebracion', nombre: 'Celebración', icono: '🎉' },
          { id: 'reunion', nombre: 'Reunión familiar', icono: '👨‍👩‍👧‍👦' },
          { id: 'otro', nombre: 'Otro', icono: '📌' }
        ];
      }
      
      // Popular el select
      if (tipos.length > 0) {
        select.innerHTML = '<option value="">Selecciona tipo...</option>' +
          tipos.map(t => '<option value="' + t.id + '">' + (t.icono || '📌') + ' ' + t.nombre + '</option>').join('');
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }

    async function abrirModalEncargo() {
      await cargarBienesUsuario();
      popularSelectBienes('encargo-bien');
      document.getElementById('form-encargo').reset();
      resetVisibilidad('modal-encargo');
      document.getElementById('modal-encargo').classList.add('active');
      track.iniciar('encargo');
    }

    function abrirModalConvocatoria() {
      document.getElementById('form-convocatoria').reset();
      resetVisibilidad('modal-convocatoria');
      document.getElementById('convocatoria-fecha').min = new Date().toISOString().split('T')[0];
      document.getElementById('modal-convocatoria').classList.add('active');
      track.iniciar('convocatoria');
    }

    async function enviarConvocatoria(e) {
      e.preventDefault();
      
      const titulo = document.getElementById('convocatoria-titulo').value.trim();
      const fecha = document.getElementById('convocatoria-fecha').value;
      const hora = document.getElementById('convocatoria-hora').value || null;
      const lugar = document.getElementById('convocatoria-lugar').value.trim() || null;
      const notas = document.getElementById('convocatoria-notas').value.trim() || null;
      const visibilidad = obtenerVisibilidad('convocatoria');

      try {
        // 1. Determinar destinatarios según visibilidad
        let destinatarios = [];
        
        if (visibilidad === 'rama') {
          // Todos los usuarios de la familia
          const usuariosSnap = await db.collection('usuarios')
            .where('familiaId', '==', currentFamilia.id)
            .get();
          destinatarios = usuariosSnap.docs.map(doc => doc.id).filter(uid => uid !== currentUser.uid);
        } else if (visibilidad === 'estirpe') {
          // Usuarios de mi estirpe (mi nido y descendientes)
          const nidosSnap = await db.collection('nidos').where('familiaId', '==', currentFamilia.id).get();
          const nidosMap = {};
          nidosSnap.docs.forEach(doc => { nidosMap[doc.id] = { id: doc.id, ...doc.data() }; });
          
          // Encontrar nidos de mi estirpe
          const nidosEstirpe = new Set([miNidoPrincipal?.id]);
          Object.values(nidosMap).forEach(n => {
            if (n.nidoOrigen === miNidoPrincipal?.id) nidosEstirpe.add(n.id);
          });
          
          // Obtener usuarios de esos nidos
          const usuariosSnap = await db.collection('usuarios')
            .where('familiaId', '==', currentFamilia.id)
            .get();
          destinatarios = usuariosSnap.docs
            .filter(doc => nidosEstirpe.has(doc.data().nidoId) && doc.id !== currentUser.uid)
            .map(doc => doc.id);
        } else {
          // Solo miembros de mi nido
          if (miNidoPrincipal) {
            const miembros = miNidoPrincipal.miembrosData || [];
            for (const m of miembros) {
              if (m.email) {
                const userSnap = await db.collection('usuarios')
                  .where('email', '==', m.email.toLowerCase())
                  .get();
                if (!userSnap.empty && userSnap.docs[0].id !== currentUser.uid) {
                  destinatarios.push(userSnap.docs[0].id);
                }
              }
            }
          }
        }

        // 2. Crear la convocatoria
        const convocatoriaRef = await db.collection('convocatorias').add({
          titulo: titulo,
          fecha: fecha,
          hora: hora,
          lugar: lugar,
          notas: notas,
          visibilidad: visibilidad,
          familiaId: currentFamilia.id,
          nidoId: miNidoPrincipal?.id || null,
          creadoPor: currentUser.uid,
          creadoPorNombre: userData?.nombre || currentUser.email.split('@')[0],
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
          estado: 'activa',
          confirmados: [],
          rechazados: [],
          pendientes: destinatarios
        });

        // 3. Crear notificación de ACCIÓN para cada destinatario
        const miNombre = userData?.nombre || currentUser.email.split('@')[0];
        const fechaEvento = new Date(fecha + 'T23:59:59');

        if (destinatarios.length > 0) {
          await db.collection('notificaciones').add({
            tipo: 'accion',
            categoria: 'convocatoria',
            titulo: `✋ ${miNombre} te convoca: "${titulo}"`,
            mensaje: `${fecha}${hora ? ' a las ' + hora : ''}${lugar ? ' en ' + lugar : ''}`,
            familiaId: currentFamilia.id,
            nidoId: miNidoPrincipal?.id || null,
            visibilidad: visibilidad,
            destinatarios: destinatarios,
            leidoPor: [],
            completadoPor: [],
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            fechaExpiracion: fechaEvento, // Caduca pasada la fecha del evento
            enlace: `herramienta-asistencia.html?id=${convocatoriaRef.id}`,
            origen: { tipo: 'convocatoria', id: convocatoriaRef.id },
            estado: 'activa',
            recordatorioEnviado: false,
            fechaRecordatorio: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000)
          });
        }

        track.completar('convocatoria');
        cerrarModales();
        alert(`✅ Convocatoria enviada a ${destinatarios.length} persona${destinatarios.length !== 1 ? 's' : ''}`);
        
        // Refrescar tablón
        await renderTablon();

      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar la convocatoria');
      }
    }

    // Enviar avería
    document.getElementById('form-averia').addEventListener('submit', async (e) => {
      e.preventDefault();
      const bienId = document.getElementById('averia-bien').value;
      const bien = bienesUsuario.find(b => b.id === bienId);
      const descripcion = document.getElementById('averia-descripcion').value;
      const urgencia = document.querySelector('input[name="averia-urgencia"]:checked').value;
      const visibilidad = obtenerVisibilidad('averia');

      try {
        const fechaActual = firebase.firestore.FieldValue.serverTimestamp();
        const reportadoPorNombre = userData.nombre || userData.email;
        
        // 1. Registrar en Lista de Reparaciones (Mantenimiento)
        // Esta es la colección que se muestra en el módulo de Mantenimiento
        await db.collection('bienes').doc(bienId).collection('reparaciones').add({
          // Datos de la avería
          descripcion,
          urgencia, // 'baja', 'media', 'alta', 'urgente'
          estado: 'pendiente', // pendiente -> en_proceso -> completada
          
          // Quién reportó
          reportadoPor: currentUser.uid,
          reportadoPorNombre: reportadoPorNombre,
          nidoReportador: miNidoPrincipal?.nombre || '',
          
          // Metadata
          tipo: 'averia', // Para distinguir de mantenimientos programados
          origen: 'cgi', // Reportado desde CGI (vs casero, admin, etc)
          visibilidad,
          nidoId: miNidoPrincipal?.id || null,
          bienId: bienId,
          bienNombre: bien?.nombre || '',
          
          // Fechas
          fechaCreacion: fechaActual,
          fechaReporte: fechaActual,
          
          // Campos para seguimiento (se rellenan después)
          asignadoA: null,
          fechaResolucion: null,
          coste: null,
          notasResolucion: null
        });
        
        // 2. Notificar a los admins
        await enviarNotificacionAdmins('averia', {
          titulo: `Avería en ${bien?.nombre || 'bien'}`,
          descripcion,
          urgencia,
          bienId,
          bienNombre: bien?.nombre || '',
          visibilidad,
          nidoId: miNidoPrincipal?.id || null
        });
        
        // 3. Notificar a los Caseros del bien
        const caseroUIDs = await obtenerCaserosBien(bienId);
        if (caseroUIDs.length > 0) {
          await db.collection('notificaciones').add({
            tipo: 'alerta',
            categoria: 'averia',
            titulo: `🔧 Avería reportada: ${bien?.nombre || 'Bien'}`,
            mensaje: `${reportadoPorNombre} ha reportado: ${descripcion.substring(0, 80)}${descripcion.length > 80 ? '...' : ''}`,
            familiaId: currentFamilia.id,
            destinatarios: caseroUIDs,
            leidoPor: [],
            fechaCreacion: fechaActual,
            enlace: `casero.html?id=${bienId}`,
            origen: { tipo: 'averia', bienId: bienId },
            estado: 'activa'
          });
        }
        
        track.completar('averia');
        cerrarModales();
        alert('✅ Avería registrada en Mantenimiento y notificada');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar el aviso');
      }
    });

    // Enviar iniciativa (con notificación a admins)
    document.getElementById('form-iniciativa').addEventListener('submit', async (e) => {
      e.preventDefault();
      const titulo = document.getElementById('iniciativa-titulo').value;
      const descripcion = document.getElementById('iniciativa-descripcion').value;
      const categoria = document.getElementById('iniciativa-categoria').value;
      const visibilidad = obtenerVisibilidad('iniciativa');

      try {
        // Guardar iniciativa y notificar admins
        await enviarNotificacionAdmins('iniciativa', {
          titulo,
          descripcion,
          categoria,
          visibilidad,
          nidoId: miNidoPrincipal?.id || null
        });

        // También guardar en colección de iniciativas para votos
        await db.collection('familias').doc(currentFamilia.id).collection('iniciativas').add({
          titulo,
          descripcion,
          categoria,
          estado: 'pendiente',
          votos: [],
          propuestoPor: currentUser.uid,
          propuestoPorNombre: userData.nombre || userData.email,
          nidoId: miNidoPrincipal?.id || null,
          visibilidad,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        track.completar('iniciativa');
        cerrarModales();
        alert('✅ Propuesta enviada a los administradores');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar la propuesta');
      }
    });

    // Enviar solicitud de evento
    document.getElementById('form-evento').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nombre = document.getElementById('evento-nombre').value;
      const bienId = document.getElementById('evento-bien').value;
      const bien = bienesUsuario.find(b => b.id === bienId);
      const tipoEvento = document.getElementById('evento-tipo').value || 'otro';
      const fecha = document.getElementById('evento-fecha').value;
      const numFamiliares = parseInt(document.getElementById('evento-familiares').value) || 0;
      const numInvitados = parseInt(document.getElementById('evento-invitados').value) || 0;
      const numDesayunos = parseInt(document.getElementById('evento-desayunos').value) || 0;
      const numComidas = parseInt(document.getElementById('evento-comidas').value) || 0;
      const numCenas = parseInt(document.getElementById('evento-cenas').value) || 0;
      const descripcion = document.getElementById('evento-descripcion').value;
      const visibilidad = obtenerVisibilidad('evento');

      try {
        await enviarNotificacionAdmins('evento', {
          nombre,
          bienId,
          bienNombre: bien?.nombre || '',
          tipoEvento,
          fecha,
          numFamiliares,
          numInvitados,
          totalAsistentes: numFamiliares + numInvitados,
          numDesayunos,
          numComidas,
          numCenas,
          descripcion,
          visibilidad,
          nidoId: miNidoPrincipal?.id || null
        });

        track.completar('evento');
        cerrarModales();
        alert('✅ Solicitud de evento enviada a los administradores');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar la solicitud');
      }
    });

    // Enviar solicitud de reserva
    document.getElementById('form-reserva').addEventListener('submit', async (e) => {
      e.preventDefault();
      const bienId = document.getElementById('reserva-bien').value;
      
      if (!bienId) {
        alert('Por favor, selecciona un bien');
        return;
      }
      
      const bien = bienesConGestion.find(b => b.id === bienId) || bienesUsuario.find(b => b.id === bienId);
      const tipoReservaId = document.getElementById('reserva-tipo').value || 'estancia';
      const fechaInicio = document.getElementById('reserva-inicio').value;
      const fechaFin = document.getElementById('reserva-fin').value;
      const numFamiliares = parseInt(document.getElementById('reserva-familiares').value) || 0;
      const numInvitados = parseInt(document.getElementById('reserva-invitados').value) || 0;
      const numDesayunos = parseInt(document.getElementById('reserva-desayunos').value) || 0;
      const numComidas = parseInt(document.getElementById('reserva-comidas').value) || 0;
      const numCenas = parseInt(document.getElementById('reserva-cenas').value) || 0;
      const motivo = document.getElementById('reserva-motivo').value;
      const visibilidad = obtenerVisibilidad('reserva');

      if (!fechaInicio || !fechaFin) {
        alert('Por favor, selecciona las fechas de inicio y fin');
        return;
      }

      if (fechaFin < fechaInicio) {
        alert('La fecha de fin debe ser posterior a la de inicio');
        return;
      }

      // Buscar info del tipo de reserva
      const tipoInfo = tiposReservaActuales.find(t => t.id === tipoReservaId) || {};
      const tipoReservaNombre = tipoInfo.nombre || tipoReservaId;
      const esFamiliar = tipoInfo.esFamiliar || false;
      
      // Si es familiar, obtener quién reserva
      let nidoReservaId = null;
      let nidoReservaNombre = '';
      let otroGrupoId = null;
      let otroGrupoNombre = '';
      
      if (esFamiliar) {
        const quienReserva = document.getElementById('reserva-quien').value;
        if (!quienReserva) {
          alert('Por favor, selecciona quién hace la reserva');
          return;
        }
        
        const [tipoQuien, idQuien] = quienReserva.split(':');
        
        if (tipoQuien === 'nido') {
          nidoReservaId = idQuien;
          const nido = nidosData.find(n => n.id === idQuien);
          nidoReservaNombre = nido?.nombre || 'Nido';
        } else if (tipoQuien === 'otro') {
          otroGrupoId = idQuien;
          const grupo = otrosGruposData.find(g => g.id === idQuien);
          otroGrupoNombre = grupo?.nombre || 'Grupo';
        }
      }

      // Determinar qué add-on tiene activo
      let addonActivo = null;
      if (bien?.mayordomoActivo) addonActivo = 'mayordomo';
      else if (bien?.gerenteActivo) addonActivo = 'gerente';
      else if (bien?.capatazActivo) addonActivo = 'capataz';

      try {
        // DATO ÚNICO: escribir directo en bienes/{bienId}/reservas/{id}
        const remitente = userData?.nombre || userData?.email || 'Usuario';
        const reservaData = {
          tipo: tipoReservaId,
          categoria: 'familiar',
          esReserva: true,
          tipoSolicitud: 'reserva',
          tipoReserva: tipoReservaId,
          tipoReservaNombre: tipoReservaNombre,
          esFamiliar: esFamiliar,
          nidoReservaId, nidoReservaNombre,
          otroGrupoId, otroGrupoNombre,
          bienId,
          bienNombre: bien?.nombre || '',
          addonActivo: addonActivo,
          nombre: tipoReservaNombre + ' — ' + (bien?.nombre || 'Bien'),
          fechaInicio, fechaFin,
          numFamiliares, numInvitados,
          totalAsistentes: numFamiliares + numInvitados,
          numDesayunos, numComidas, numCenas,
          motivo, visibilidad,
          nidoId: miNidoPrincipal?.id || null,
          estado: 'pendiente',
          origen: 'cgi',
          solicitadoPor: currentUser.uid,
          solicitadoPorNombre: remitente,
          solicitadoPorNido: miNidoPrincipal?.nombre || '',
          solicitadoPorNidoId: miNidoPrincipal?.id || null,
          familiaId: currentFamilia.id,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
          respuesta: null, respondidoPor: null, fechaRespuesta: null
        };

        const reservaRef = await db.collection('bienes').doc(bienId).collection('reservas').add(reservaData);
        console.log('✅ Reserva creada en bien:', reservaRef.id);

        // Crear notificación para admins
        const admins = await cargarAdminsEstirpe();
        const destinatarios = admins.filter(a => a.uid !== currentUser.uid).map(a => a.uid);
        const destinatariosFinales = destinatarios.length > 0 ? destinatarios : admins.map(a => a.uid);

        if (destinatariosFinales.length > 0) {
          await db.collection('notificaciones').add({
            tipo: 'accion',
            categoria: 'reserva',
            titulo: getTituloNotificacion('reserva', reservaData),
            mensaje: `${remitente} ha enviado una solicitud de reserva`,
            familiaId: currentFamilia.id,
            nidoId: miNidoPrincipal?.id || null,
            destinatarios: destinatariosFinales,
            leidoPor: [], completadoPor: [],
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            fechaExpiracion: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
            enlace: `reservas-mayordomo.html?id=${bienId}`,
            origen: { tipo: 'solicitud', subtipo: 'reserva', id: reservaRef.id, bienId: bienId, solicitadoPor: currentUser.uid },
            estado: 'activa'
          });
        }

        track.completar('reserva');
        cerrarModales();
        alert('✅ Solicitud de reserva enviada a los administradores');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar la solicitud: ' + (error.message || 'Inténtalo de nuevo'));
      }
    });

    // Enviar encargo
    document.getElementById('form-encargo').addEventListener('submit', async (e) => {
      e.preventDefault();
      const bienId = document.getElementById('encargo-bien').value;
      const bien = bienesUsuario.find(b => b.id === bienId);
      const items = document.getElementById('encargo-items').value;
      const notas = document.getElementById('encargo-notas').value;
      const visibilidad = obtenerVisibilidad('encargo');

      try {
        const fechaActual = firebase.firestore.FieldValue.serverTimestamp();
        const solicitadoPorNombre = userData.nombre || userData.email;
        
        // 1. Guardar en colección de encargos del bien
        await db.collection('bienes').doc(bienId).collection('encargos').add({
          items,
          notas,
          estado: 'pendiente',
          solicitadoPor: currentUser.uid,
          solicitadoPorNombre: solicitadoPorNombre,
          nidoSolicitante: miNidoPrincipal?.nombre || '',
          nidoId: miNidoPrincipal?.id || null,
          visibilidad,
          bienId: bienId,
          bienNombre: bien?.nombre || '',
          fechaCreacion: fechaActual
        });
        
        // 2. Notificar a los admins
        await enviarNotificacionAdmins('encargo', {
          titulo: `Encargo para ${bien?.nombre || 'bien'}`,
          items,
          notas,
          bienId,
          bienNombre: bien?.nombre || '',
          visibilidad,
          nidoId: miNidoPrincipal?.id || null
        });
        
        // 3. Notificar a los Caseros del bien
        const caseroUIDs = await obtenerCaserosBien(bienId);
        if (caseroUIDs.length > 0) {
          await db.collection('notificaciones').add({
            tipo: 'accion',
            categoria: 'encargo',
            titulo: `🛒 Nuevo encargo: ${bien?.nombre || 'Bien'}`,
            mensaje: `${solicitadoPorNombre} solicita: ${items.substring(0, 80)}${items.length > 80 ? '...' : ''}`,
            familiaId: currentFamilia.id,
            destinatarios: caseroUIDs,
            leidoPor: [],
            fechaCreacion: fechaActual,
            enlace: `casero.html?id=${bienId}`,
            origen: { tipo: 'encargo', bienId: bienId },
            estado: 'activa'
          });
        }
        
        track.completar('encargo');
        cerrarModales();
        alert('✅ Encargo registrado y notificado');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar el encargo');
      }
    });

    // Cerrar modales al hacer clic fuera
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) cerrarModales();
      });
    });

    // ============ LOGOUT ============
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await auth.signOut();
      window.location.href = 'login.html';
    });

    // ============ BUZÓN UNIFICADO (MÓVIL) ============
    function cambiarPestanaBuzon(pestaña) {
      // Actualizar pestañas
      document.querySelectorAll('.buzon-col .buzon-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.buzon-col .buzon-tab[onclick*="${pestaña}"]`)?.classList.add('active');
      
      // Actualizar contenido
      document.querySelectorAll('.buzon-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`buzon-${pestaña}`)?.classList.add('active');
      
      // Si cambia a respondidas, cargar datos
      if (pestaña === 'respondidas') {
        cargarRespondidasBuzon();
      }
    }

    // ============ TABLÓN (DESKTOP) ============
    function cambiarPestanaTablon(pestaña) {
      // Actualizar pestañas del tablón
      document.querySelectorAll('.tablon-col .buzon-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.tablon-col .buzon-tab[onclick*="${pestaña}"]`)?.classList.add('active');
      
      // Actualizar contenido
      document.querySelectorAll('.tablon-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`tablon-${pestaña}`)?.classList.add('active');
      
      // Si cambia a respondidas, cargar datos
      if (pestaña === 'respondidas') {
        cargarRespondidasTablon();
      }
    }

    async function cargarRespondidasTablon() {
      const container = document.getElementById('tablon-respondidas-list');
      const badge = document.getElementById('badge-tablon-respondidas');
      
      if (!container) return;
      
      try {
        const esAdmin = userData?.credenciales === 'admin-rama' || userData?.credenciales === 'admin-nido';
        const familiaId = currentFamilia?.id || familiaData?.id;
        
        let allDocs = []; // {id, data, source, bienId}

        // Solicitudes genéricas
        let snap;
        if (esAdmin && familiaId) {
          snap = await db.collection('solicitudes')
            .where('familiaId', '==', familiaId)
            .where('estado', 'in', ['aprobada', 'rechazada', 'en_estudio', 'respondida'])
            .limit(30).get();
        } else {
          snap = await db.collection('solicitudes')
            .where('solicitadoPor', '==', currentUser.uid)
            .where('estado', 'in', ['aprobada', 'rechazada', 'en_estudio', 'respondida'])
            .limit(30).get();
        }
        snap.docs.forEach(doc => allDocs.push({ id: doc.id, data: doc.data(), source: 'solicitudes', bienId: null }));

        // DATO ÚNICO: Reservas respondidas (collectionGroup)
        try {
          let reservasSnap;
          if (esAdmin && familiaId) {
            reservasSnap = await db.collectionGroup('reservas')
              .where('familiaId', '==', familiaId)
              .where('estado', 'in', ['aprobada', 'rechazada', 'confirmada', 'en_estudio'])
              .get();
          } else {
            reservasSnap = await db.collectionGroup('reservas')
              .where('solicitadoPor', '==', currentUser.uid)
              .where('estado', 'in', ['aprobada', 'rechazada', 'confirmada', 'en_estudio'])
              .get();
          }
          reservasSnap.docs.forEach(doc => {
            const pathParts = doc.ref.path.split('/');
            const bienId = pathParts.length >= 2 ? pathParts[1] : null;
            allDocs.push({ id: doc.id, data: doc.data(), source: 'reserva-bien', bienId });
          });
        } catch (e) { console.warn('Error reservas respondidas:', e); }
        
        if (allDocs.length === 0) {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">✅</div>Sin gestiones</div>';
          if (badge) badge.style.display = 'none';
          return;
        }
        
        // Ordenar por fecha más reciente
        allDocs.sort((a, b) => {
          const fechaA = a.data.fechaRespuesta?.toDate?.() || a.data.fechaCreacion?.toDate?.() || new Date(0);
          const fechaB = b.data.fechaRespuesta?.toDate?.() || b.data.fechaCreacion?.toDate?.() || new Date(0);
          return fechaB - fechaA;
        });
        allDocs = allDocs.slice(0, 20);
        
        const iconos = { 'reserva': '📅', 'evento': '🎉', 'iniciativa': '💡', 'averia': '🔧', 'encargo': '🛒' };
        
        container.innerHTML = allDocs.map(item => {
          const data = item.data;
          const tipo = item.source === 'reserva-bien' ? 'reserva' : (data.tipo || 'solicitud');
          const esAceptada = ['aprobada', 'confirmada'].includes(data.estado);
          const esRechazada = data.estado === 'rechazada';
          const fechaResp = data.fechaRespuesta?.toDate?.() || data.fechaCreacion?.toDate?.() || new Date();
          const fechaStr = fechaResp.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
          
          let titulo = '';
          if (item.source === 'reserva-bien') {
            titulo = `Reserva: ${data.nombre || data.bienNombre || 'Bien'}`;
          } else {
            switch(data.tipo) {
              case 'reserva': titulo = `Reserva: ${data.bienNombre || 'Bien'}`; break;
              case 'evento': titulo = `Evento: ${data.nombre || 'Sin nombre'}`; break;
              case 'iniciativa': titulo = `Propuesta: ${data.titulo || 'Sin título'}`; break;
              default: titulo = data.titulo || 'Solicitud';
            }
          }
          
          const estadoColor = esAceptada ? '#22c55e' : esRechazada ? '#ef4444' : '#f59e0b';
          const estadoIcono = esAceptada ? '✅' : esRechazada ? '❌' : '🔄';
          const solicitante = esAdmin && data.solicitadoPorNombre ? `De: ${data.solicitadoPorNombre}` : '';
          
          // onclick: pasar bienId para reservas
          const clickData = item.bienId ? `verDetalleRespuesta('${item.id}','${item.bienId}')` : `verDetalleRespuesta('${item.id}')`;
          
          return `
            <div class="mensaje-item" style="border-left: 3px solid ${estadoColor};" onclick="${clickData}">
              <div class="mensaje-avatar">${iconos[tipo] || '📋'}</div>
              <div class="mensaje-content">
                <div class="mensaje-header">
                  <span class="mensaje-autor">${titulo}</span>
                  <span class="mensaje-fecha">${fechaStr}</span>
                </div>
                <div class="mensaje-preview">
                  <span style="color: ${estadoColor}; font-weight: 600;">${estadoIcono}</span>
                  ${solicitante ? ` ${solicitante}` : ''}
                  ${data.respuesta && !solicitante ? ` ${data.respuesta.substring(0, 35)}...` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        if (badge) {
          badge.textContent = allDocs.length;
          badge.style.display = allDocs.length > 0 ? 'inline-block' : 'none';
        }
        
      } catch (e) {
        console.error('Error cargando respondidas tablón:', e);
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">⚠️</div>Error</div>';
      }
    }

    async function renderBuzonUnificado() {
      console.log('Ejecutando renderBuzonUnificado');
      // Renderizar mensajes en buzón móvil
      const chatContainer = document.getElementById('buzon-mensajes-list');
      const tablonContainer = document.getElementById('buzon-tablon-list');
      
      if (!chatContainer || !tablonContainer) {
        console.warn('renderBuzonUnificado: Contenedores no encontrados');
        return;
      }
      
      // Copiar contenido de mensajes desktop
      const mensajesDesktop = document.getElementById('mensajes-list');
      if (mensajesDesktop && mensajesDesktop.innerHTML) {
        chatContainer.innerHTML = mensajesDesktop.innerHTML;
      } else {
        chatContainer.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">💬</div>Sin conversaciones</div>';
      }
      
      // Copiar contenido de tablón desktop
      const tablonDesktop = document.getElementById('tablon-list');
      if (tablonDesktop && tablonDesktop.innerHTML) {
        tablonContainer.innerHTML = tablonDesktop.innerHTML;
      } else {
        tablonContainer.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">📢</div>Sin novedades</div>';
      }
      
      // Cargar solicitudes respondidas
      await cargarRespondidasBuzon();
      
      // Actualizar badges
      const chatBadge = document.getElementById('badge-chat-count');
      const notifBadge = document.getElementById('badge-notif-count');
      
      // Contar mensajes no leídos
      const mensajesNoLeidos = chatContainer.querySelectorAll('.mensaje-item.no-leido').length;
      if (chatBadge) {
        chatBadge.textContent = mensajesNoLeidos;
        chatBadge.style.display = mensajesNoLeidos > 0 ? 'inline-block' : 'none';
      }
      
      // Contar notificaciones de acción
      const notifAccion = tablonContainer.querySelectorAll('.notif-item.accion').length;
      if (notifBadge) {
        notifBadge.textContent = notifAccion;
        notifBadge.style.display = notifAccion > 0 ? 'inline-block' : 'none';
      }
      
      console.log('Buzón renderizado - Mensajes:', mensajesNoLeidos, 'Notifs:', notifAccion);
    }

    async function cargarRespondidasBuzon() {
      const container = document.getElementById('buzon-respondidas-list');
      const badge = document.getElementById('badge-respondidas-count');
      
      if (!container) return;
      
      try {
        const esAdmin = userData?.credenciales === 'admin-rama' || userData?.credenciales === 'admin-nido';
        const familiaId = currentFamilia?.id || familiaData?.id;
        
        if (!familiaId && !currentUser?.uid) {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">⚠️</div>Error de datos</div>';
          return;
        }
        
        let allDocs = [];

        // Solicitudes genéricas
        let snap;
        if (esAdmin && familiaId) {
          snap = await db.collection('solicitudes')
            .where('familiaId', '==', familiaId)
            .where('estado', 'in', ['aprobada', 'rechazada', 'en_estudio', 'respondida'])
            .limit(30).get();
        } else {
          snap = await db.collection('solicitudes')
            .where('solicitadoPor', '==', currentUser.uid)
            .where('estado', 'in', ['aprobada', 'rechazada', 'en_estudio', 'respondida'])
            .limit(30).get();
        }
        snap.docs.forEach(doc => allDocs.push({ id: doc.id, data: doc.data(), source: 'solicitudes', bienId: null }));

        // DATO ÚNICO: Reservas respondidas (collectionGroup)
        try {
          let reservasSnap;
          if (esAdmin && familiaId) {
            reservasSnap = await db.collectionGroup('reservas')
              .where('familiaId', '==', familiaId)
              .where('estado', 'in', ['aprobada', 'rechazada', 'confirmada', 'en_estudio'])
              .get();
          } else {
            reservasSnap = await db.collectionGroup('reservas')
              .where('solicitadoPor', '==', currentUser.uid)
              .where('estado', 'in', ['aprobada', 'rechazada', 'confirmada', 'en_estudio'])
              .get();
          }
          reservasSnap.docs.forEach(doc => {
            const pathParts = doc.ref.path.split('/');
            const bienId = pathParts.length >= 2 ? pathParts[1] : null;
            allDocs.push({ id: doc.id, data: doc.data(), source: 'reserva-bien', bienId });
          });
        } catch (e) { console.warn('Error reservas respondidas buzón:', e); }
        
        if (allDocs.length === 0) {
          container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">✅</div>Sin gestiones</div>';
          if (badge) badge.style.display = 'none';
          return;
        }
        
        allDocs.sort((a, b) => {
          const fechaA = a.data.fechaRespuesta?.toDate?.() || a.data.fechaCreacion?.toDate?.() || new Date(0);
          const fechaB = b.data.fechaRespuesta?.toDate?.() || b.data.fechaCreacion?.toDate?.() || new Date(0);
          return fechaB - fechaA;
        });
        allDocs = allDocs.slice(0, 20);
        
        const iconos = { 'reserva': '📅', 'evento': '🎉', 'iniciativa': '💡', 'averia': '🔧', 'encargo': '🛒' };
        
        container.innerHTML = allDocs.map(item => {
          const data = item.data;
          const tipo = item.source === 'reserva-bien' ? 'reserva' : (data.tipo || 'solicitud');
          const esAceptada = ['aprobada', 'confirmada'].includes(data.estado);
          const esRechazada = data.estado === 'rechazada';
          const fechaResp = data.fechaRespuesta?.toDate?.() || data.fechaCreacion?.toDate?.() || new Date();
          const fechaStr = fechaResp.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
          
          let titulo = '';
          if (item.source === 'reserva-bien') {
            titulo = `Reserva: ${data.nombre || data.bienNombre || 'Bien'}`;
          } else {
            switch(data.tipo) {
              case 'reserva': titulo = `Reserva: ${data.bienNombre || 'Bien'}`; break;
              case 'evento': titulo = `Evento: ${data.nombre || data.titulo || 'Sin nombre'}`; break;
              case 'iniciativa': titulo = `Propuesta: ${data.titulo || 'Sin título'}`; break;
              case 'averia': titulo = `Avería: ${data.bienNombre || 'Bien'}`; break;
              case 'encargo': titulo = `Encargo: ${data.bienNombre || 'Bien'}`; break;
              default: titulo = data.titulo || 'Solicitud';
            }
          }
          
          const estadoIcono = esAceptada ? '✅' : esRechazada ? '❌' : '🔄';
          const estadoTexto = esAceptada ? 'Aceptada' : esRechazada ? 'Rechazada' : 'En estudio';
          const estadoColor = esAceptada ? '#22c55e' : esRechazada ? '#ef4444' : '#f59e0b';
          const solicitante = esAdmin && data.solicitadoPorNombre ? `De: ${data.solicitadoPorNombre}` : '';
          
          const clickData = item.bienId ? `verDetalleRespuesta('${item.id}','${item.bienId}')` : `verDetalleRespuesta('${item.id}')`;
          
          return `
            <div class="mensaje-item" style="border-left: 3px solid ${estadoColor};" onclick="${clickData}">
              <div class="mensaje-avatar">${iconos[tipo] || '📋'}</div>
              <div class="mensaje-content">
                <div class="mensaje-header">
                  <span class="mensaje-autor">${titulo}</span>
                  <span class="mensaje-fecha">${fechaStr}</span>
                </div>
                <div class="mensaje-preview">
                  <span style="color: ${estadoColor}; font-weight: 600;">${estadoIcono} ${estadoTexto}</span>
                  ${solicitante ? ` · ${solicitante}` : ''}
                  ${data.respuesta && !esAdmin ? ` · ${data.respuesta.substring(0, 40)}...` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        if (badge) {
          badge.textContent = allDocs.length;
          badge.style.display = allDocs.length > 0 ? 'inline-block' : 'none';
        }
        
      } catch (e) {
        console.error('Error cargando respondidas:', e);
        container.innerHTML = '<div class="empty-mini"><div class="empty-mini-icon">⚠️</div>Error al cargar</div>';
      }
    }

    function verDetalleRespuesta(solicitudId, bienId) {
      // DATO ÚNICO: si hay bienId, leer de bienes/{bienId}/reservas/{id}
      const docPromise = bienId
        ? db.collection('bienes').doc(bienId).collection('reservas').doc(solicitudId).get()
        : db.collection('solicitudes').doc(solicitudId).get();
      
      docPromise.then(doc => {
        if (!doc.exists) return;
        
        const data = doc.data();
        const esAceptada = data.estado === 'aprobada';
        const fechaResp = data.fechaRespuesta?.toDate?.() || new Date();
        
        // Crear modal de detalle
        let modal = document.getElementById('modal-detalle-respuesta');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'modal-detalle-respuesta';
          modal.className = 'modal-overlay';
          document.body.appendChild(modal);
        }
        
        const estadoColor = esAceptada ? '#22c55e' : data.estado === 'rechazada' ? '#ef4444' : '#f59e0b';
        const estadoTexto = esAceptada ? '✅ Aceptada' : data.estado === 'rechazada' ? '❌ Rechazada' : '🔄 En estudio';
        
        modal.innerHTML = `
          <div class="modal" style="max-width: 450px;">
            <div class="modal-header" style="background: ${estadoColor};">
              <h3 class="modal-title" style="color: white;">${estadoTexto}</h3>
              <button class="modal-close" onclick="document.getElementById('modal-detalle-respuesta').classList.remove('active')">×</button>
            </div>
            <div class="modal-body">
              <p style="font-weight: 600; margin-bottom: 12px;">${getTituloSolicitud(data)}</p>
              ${data.respuesta ? `<p style="background: var(--cream); padding: 12px; border-radius: 8px; margin-bottom: 12px;"><strong>📝 Comentarios:</strong><br>${data.respuesta}</p>` : ''}
              <p style="font-size: 0.85rem; color: var(--text-muted);">
                📅 Respondido el ${fechaResp.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}
                ${data.respondidoPorNombre ? ` por ${data.respondidoPorNombre}` : ''}
              </p>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="document.getElementById('modal-detalle-respuesta').classList.remove('active')">Entendido</button>
            </div>
          </div>
        `;
        
        modal.classList.add('active');
      }).catch(e => console.error('Error cargando detalle:', e));
    }

    // ============ MIS BIENES (MÓVIL) ============
    async function renderMisBienes() {
      console.log('Ejecutando renderMisBienes');
      const container = document.getElementById('mis-bienes-list');
      if (!container) {
        console.warn('renderMisBienes: Container no encontrado');
        return;
      }
      
      try {
        await cargarBienesUsuario();
        console.log('Bienes cargados:', bienesUsuario.length);
        
        if (bienesUsuario.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
              <div style="font-size: 2rem; margin-bottom: 8px;">🏠</div>
              <div>No tienes bienes asignados</div>
            </div>
          `;
          return;
        }
        
        // Mapeo de iconos para tipos de bienes
        const iconosTipo = {
          'vivienda': '🏠',
          'vehiculo': '🚗',
          'terreno': '🌳',
          'local': '🏪',
          'garaje': '🅿️',
          'trastero': '📦',
          'otro': '📋'
        };
        
        container.innerHTML = bienesUsuario.map(bien => {
          // Determinar el add-on activo y la URL de destino
          let addon = '';
          let addonClass = '';
          let addonLabel = '';
          let urlDestino = `lo-comun.html?bien=${bien.id}`; // Por defecto
          
          if (bien.mayordomoActivo) {
            addon = '🎩';
            addonClass = 'mayordomo';
            addonLabel = 'Mayordomo';
            urlDestino = `mayordomo.html?id=${bien.id}`;
          } else if (bien.gerenteActivo) {
            addon = '💼';
            addonClass = 'gerente';
            addonLabel = 'Gerente';
            urlDestino = `gerente.html?id=${bien.id}`;
          } else if (bien.capatazActivo) {
            addon = '🚜';
            addonClass = 'capataz';
            addonLabel = 'Capataz';
            urlDestino = `capataz.html?id=${bien.id}`;
          }
          
          const iconoBien = iconosTipo[bien.tipo] || '🏠';
          
          return `
            <a href="${urlDestino}" class="bien-card ${addonClass}">
              <div class="bien-icon">${iconoBien}</div>
              <div class="bien-info">
                <div class="bien-nombre">${bien.nombre || 'Sin nombre'}</div>
                ${addon ? `<div class="bien-addon">${addon} ${addonLabel}</div>` : '<div class="bien-addon">Sin gestión activa</div>'}
              </div>
              <span class="bien-arrow">›</span>
            </a>
          `;
        }).join('');
        
        console.log('Mis bienes renderizados');
      } catch (error) {
        console.error('Error en renderMisBienes:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--text-muted);">
            <div style="font-size: 2rem; margin-bottom: 8px;">⚠️</div>
            <div>Error cargando bienes</div>
          </div>
        `;
      }
    }

    // ============ MODAL COMUNICADO ============
    let comunicadoImagenes = [];
    const COMUNICADO_MAX_IMAGENES = 3;
    const COMUNICADO_MAX_SIZE_MB = 5;

    function configurarDestinatariosComunicado(isAdminRama) {
      // Admin Rama: puede enviar a todos
      // Admin Nido: solo puede enviar a Mi Nido y Mi Estirpe
      const opcionesTodas = document.querySelectorAll('.destinatario-option');
      
      opcionesTodas.forEach(opt => {
        const dest = opt.dataset.dest;
        if (!isAdminRama && (dest === 'toda-rama' || dest === 'admins')) {
          opt.classList.add('hidden');
        } else {
          opt.classList.remove('hidden');
        }
      });
    }

    function abrirModalComunicado() {
      // Configurar destinatarios según rol del usuario
      const isAdminRama = esAdminRama;
      configurarDestinatariosComunicado(isAdminRama);
      
      document.getElementById('modal-comunicado').classList.add('active');
      track.iniciar('queo');
      validarFormularioComunicado();
    }

    function cerrarModalComunicado() {
      document.getElementById('modal-comunicado').classList.remove('active');
      // Resetear formulario
      document.getElementById('form-comunicado').reset();
      comunicadoImagenes = [];
      renderComunicadoPreviews();
      document.querySelectorAll('.destinatario-option').forEach(el => el.classList.remove('selected'));
      document.querySelector('.tipo-option.info').classList.add('selected');
      document.querySelector('.tipo-option.accion').classList.remove('selected');
      document.getElementById('comunicado-char-counter').textContent = '0 / 600 caracteres';
      document.getElementById('comunicado-char-counter').classList.remove('warning', 'limit');
      document.getElementById('comunicado-upload-area').style.display = 'block';
    }

    function toggleDestinatario(element) {
      const checkbox = element.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      element.classList.toggle('selected', checkbox.checked);
      validarFormularioComunicado();
    }

    function actualizarContadorComunicado() {
      const textarea = document.getElementById('comunicado-mensaje');
      const counter = document.getElementById('comunicado-char-counter');
      const length = textarea.value.length;
      
      counter.textContent = `${length} / 600 caracteres`;
      
      counter.classList.remove('warning', 'limit');
      if (length >= 600) {
        counter.classList.add('limit');
      } else if (length >= 500) {
        counter.classList.add('warning');
      }
      
      validarFormularioComunicado();
    }

    function selectTipoComunicado(element, tipo) {
      document.querySelectorAll('.tipo-option').forEach(opt => {
        opt.classList.remove('selected');
        opt.querySelector('input').checked = false;
      });
      element.classList.add('selected');
      element.querySelector('input').checked = true;
    }

    // Drag & drop para imágenes
    const comunicadoUploadArea = document.getElementById('comunicado-upload-area');
    if (comunicadoUploadArea) {
      comunicadoUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        comunicadoUploadArea.classList.add('dragover');
      });

      comunicadoUploadArea.addEventListener('dragleave', () => {
        comunicadoUploadArea.classList.remove('dragover');
      });

      comunicadoUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        comunicadoUploadArea.classList.remove('dragover');
        handleComunicadoFiles(e.dataTransfer.files);
      });
    }

    function handleComunicadoFiles(files) {
      const remaining = COMUNICADO_MAX_IMAGENES - comunicadoImagenes.length;
      const filesToProcess = Array.from(files).slice(0, remaining);
      
      filesToProcess.forEach(file => {
        // Validar tipo
        if (!file.type.match(/image\/(jpeg|png|webp)/)) {
          alert(`${file.name} no es un formato válido. Usa JPG, PNG o WebP.`);
          return;
        }
        
        // Validar tamaño
        if (file.size > COMUNICADO_MAX_SIZE_MB * 1024 * 1024) {
          alert(`${file.name} excede el límite de ${COMUNICADO_MAX_SIZE_MB}MB.`);
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          comunicadoImagenes.push({
            nombre: file.name,
            data: e.target.result
          });
          renderComunicadoPreviews();
        };
        reader.readAsDataURL(file);
      });
      
      // Limpiar input
      document.getElementById('comunicado-upload-input').value = '';
    }

    function renderComunicadoPreviews() {
      const grid = document.getElementById('comunicado-preview-grid');
      const uploadArea = document.getElementById('comunicado-upload-area');
      
      if (comunicadoImagenes.length === 0) {
        grid.innerHTML = '';
        uploadArea.style.display = 'block';
        return;
      }
      
      grid.innerHTML = comunicadoImagenes.map((img, idx) => `
        <div class="preview-item">
          <img src="${img.data}" alt="${img.nombre}">
          <button class="preview-remove" onclick="eliminarComunicadoImagen(${idx})" type="button">×</button>
        </div>
      `).join('');
      
      // Ocultar área de upload si ya hay 3
      uploadArea.style.display = comunicadoImagenes.length >= COMUNICADO_MAX_IMAGENES ? 'none' : 'block';
    }

    function eliminarComunicadoImagen(idx) {
      comunicadoImagenes.splice(idx, 1);
      renderComunicadoPreviews();
    }

    function validarFormularioComunicado() {
      const btnEnviar = document.getElementById('btn-enviar-comunicado');
      const destinatarios = document.querySelectorAll('input[name="destinatarios"]:checked');
      const asunto = document.getElementById('comunicado-asunto').value.trim();
      const mensaje = document.getElementById('comunicado-mensaje').value.trim();
      
      const valido = destinatarios.length > 0 && asunto.length > 0 && mensaje.length > 0;
      btnEnviar.disabled = !valido;
    }

    async function enviarComunicado() {
      const btnEnviar = document.getElementById('btn-enviar-comunicado');
      btnEnviar.disabled = true;
      btnEnviar.innerHTML = '<span>⏳</span> Enviando...';

      const destinatariosSeleccionados = Array.from(document.querySelectorAll('input[name="destinatarios"]:checked')).map(el => el.value);
      const asunto = document.getElementById('comunicado-asunto').value.trim();
      const mensaje = document.getElementById('comunicado-mensaje').value.trim();
      const tipoInput = document.querySelector('input[name="comunicado-tipo"]:checked');
      const tipo = tipoInput ? tipoInput.value : 'info';
      
      console.log('=== ENVIANDO QUEO ===');
      console.log('Destinatarios seleccionados:', destinatariosSeleccionados);
      console.log('Asunto:', asunto);
      console.log('Mensaje:', mensaje);
      console.log('Tipo:', tipo);
      
      if (destinatariosSeleccionados.length === 0) {
        alert('Selecciona al menos un destinatario');
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = '<span>📤</span> Enviar queo';
        return;
      }

      if (!asunto || !mensaje) {
        alert('Completa el asunto y el mensaje');
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = '<span>📤</span> Enviar queo';
        return;
      }
      
      try {
        // Resolver destinatarios a UIDs
        let destinatariosUIDs = await resolverDestinatarios(destinatariosSeleccionados);
        console.log('UIDs resueltos:', destinatariosUIDs);
        
        // IMPORTANTE: El remitente también debe poder ver su propio queo
        // Añadirlo al final de la lista si no está ya
        if (!destinatariosUIDs.includes(currentUser.uid)) {
          destinatariosUIDs.push(currentUser.uid);
        }
        
        // Si SOLO está el remitente, avisar pero continuar
        if (destinatariosUIDs.length === 1 && destinatariosUIDs[0] === currentUser.uid) {
          console.warn('⚠️ No se encontraron otros destinatarios. El queo solo será visible para ti.');
        }
        
        // Crear queo en Firestore
        const queoData = {
          asunto,
          mensaje,
          tipo,
          imagenes: comunicadoImagenes.map(img => img.data),
          destinatariosGrupos: destinatariosSeleccionados,
          destinatarios: destinatariosUIDs,
          remitente: currentUser.uid,
          remitenteNombre: userData?.nombre || userData?.email || currentUser.email,
          remitenteNido: miNidoPrincipal?.nombre || '',
          familiaId: currentFamilia?.id || userData?.familiaId,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
          leidoPor: [],
          completadoPor: [],
          estado: 'enviado'
        };
        
        console.log('Guardando queo:', queoData);
        const docRef = await db.collection('queos').add(queoData);
        console.log('✅ Queo guardado con ID:', docRef.id);
        
        // Crear notificación
        try {
          const notifData = {
            tipo: tipo,
            categoria: 'queo',
            titulo: asunto,
            mensaje: mensaje.substring(0, 100) + (mensaje.length > 100 ? '...' : ''),
            destinatarios: destinatariosUIDs,
            familiaId: currentFamilia?.id || userData?.familiaId,
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            leidoPor: [],
            completadoPor: [],
            enlace: null,
            origen: { tipo: 'queo', id: docRef.id },
            estado: 'activa'
          };
          
          await db.collection('notificaciones').add(notifData);
          console.log('✅ Notificación creada');
        } catch (notifError) {
          console.warn('Error creando notificación (no crítico):', notifError);
        }
        
        alert('✅ Queo enviado correctamente');
        track.completar('queo');
        cerrarModalComunicado();
        
        // Actualizar tablón si está visible
        if (typeof renderTablon === 'function') {
          renderTablon();
        }
        
      } catch (error) {
        console.error('❌ Error enviando queo:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        alert('Error al enviar el queo: ' + (error.message || 'Error desconocido'));
      }
      
      btnEnviar.disabled = false;
      btnEnviar.innerHTML = '<span>📤</span> Enviar queo';
    }

    async function resolverDestinatarios(grupos) {
      const uidsSet = new Set();
      
      console.log('=== RESOLVIENDO DESTINATARIOS ===');
      console.log('Grupos seleccionados:', grupos);
      console.log('Familia ID:', currentFamilia?.id);
      console.log('Nido principal:', miNidoPrincipal?.id, miNidoPrincipal?.nombre);
      
      if (!currentFamilia?.id) {
        console.error('No hay familia activa');
        return [];
      }
      
      try {
        // Cargar TODOS los usuarios de la familia una vez (más eficiente)
        const todosUsuariosSnap = await db.collection('usuarios')
          .where('familiaId', '==', currentFamilia.id)
          .get();
        
        // Crear mapas para búsqueda rápida
        const usuariosPorUid = new Map();
        const usuariosPorEmail = new Map();
        const usuariosPorNido = new Map();
        
        todosUsuariosSnap.docs.forEach(doc => {
          const data = doc.data();
          const uid = doc.id;
          
          usuariosPorUid.set(uid, { uid, ...data });
          
          if (data.email) {
            usuariosPorEmail.set(data.email.toLowerCase(), uid);
          }
          
          if (data.nidoId) {
            if (!usuariosPorNido.has(data.nidoId)) {
              usuariosPorNido.set(data.nidoId, []);
            }
            usuariosPorNido.get(data.nidoId).push(uid);
          }
        });
        
        console.log('Usuarios cargados:', todosUsuariosSnap.size);
        console.log('Emails mapeados:', usuariosPorEmail.size);
        
        for (const grupo of grupos) {
          console.log('Procesando grupo:', grupo);
          
          switch (grupo) {
            case 'toda-rama':
              // Todos los usuarios de la familia
              todosUsuariosSnap.docs.forEach(doc => {
                uidsSet.add(doc.id);
              });
              console.log('→ Toda rama:', uidsSet.size, 'usuarios');
              break;
              
            case 'admins':
              // Admins de rama y nidos
              todosUsuariosSnap.docs.forEach(doc => {
                const data = doc.data();
                if (data.rol === 'adminRama' || data.rol === 'adminNido' || data.rol === 'AdminNido' || data.esAdmin) {
                  uidsSet.add(doc.id);
                }
              });
              // También admins explícitos de la familia
              if (currentFamilia.adminsGenerales) {
                currentFamilia.adminsGenerales.forEach(uid => uidsSet.add(uid));
              }
              if (currentFamilia.fundador) uidsSet.add(currentFamilia.fundador);
              if (currentFamilia.creador) uidsSet.add(currentFamilia.creador);
              console.log('→ Admins:', uidsSet.size, 'usuarios');
              break;
              
            case 'mi-nido':
              // Miembros de mi nido (usuarios registrados con nidoId = miNidoPrincipal.id)
              if (miNidoPrincipal?.id) {
                // Método 1: Usuarios con nidoId igual a mi nido
                const miembrosNido = usuariosPorNido.get(miNidoPrincipal.id) || [];
                miembrosNido.forEach(uid => uidsSet.add(uid));
                
                // Método 2: Si hay miembrosData, buscar por email
                if (miNidoPrincipal.miembrosData && Array.isArray(miNidoPrincipal.miembrosData)) {
                  miNidoPrincipal.miembrosData.forEach(m => {
                    // Si tiene uid directo, usarlo
                    if (m.uid) {
                      uidsSet.add(m.uid);
                    }
                    // Si tiene email, buscar el uid del usuario
                    if (m.email) {
                      const uid = usuariosPorEmail.get(m.email.toLowerCase());
                      if (uid) uidsSet.add(uid);
                    }
                  });
                }
                
                // Método 3: Array miembros legacy
                if (miNidoPrincipal.miembros && Array.isArray(miNidoPrincipal.miembros)) {
                  miNidoPrincipal.miembros.forEach(uid => uidsSet.add(uid));
                }
              }
              console.log('→ Mi nido:', uidsSet.size, 'usuarios');
              break;
              
            case 'mi-estirpe':
              // Mi nido + nidos descendientes
              if (miNidoPrincipal?.id) {
                // Primero, añadir mi nido (igual que arriba)
                const miembrosNido = usuariosPorNido.get(miNidoPrincipal.id) || [];
                miembrosNido.forEach(uid => uidsSet.add(uid));
                
                if (miNidoPrincipal.miembrosData && Array.isArray(miNidoPrincipal.miembrosData)) {
                  miNidoPrincipal.miembrosData.forEach(m => {
                    if (m.uid) uidsSet.add(m.uid);
                    if (m.email) {
                      const uid = usuariosPorEmail.get(m.email.toLowerCase());
                      if (uid) uidsSet.add(uid);
                    }
                  });
                }
                
                // Buscar nidos descendientes (donde nidoOrigen = mi nido)
                try {
                  const descendientesSnap = await db.collection('nidos')
                    .where('familiaId', '==', currentFamilia.id)
                    .where('nidoOrigen', '==', miNidoPrincipal.id)
                    .get();
                  
                  descendientesSnap.docs.forEach(docNido => {
                    const nidoDesc = docNido.data();
                    const nidoDescId = docNido.id;
                    
                    // Usuarios con nidoId = nido descendiente
                    const miembrosDesc = usuariosPorNido.get(nidoDescId) || [];
                    miembrosDesc.forEach(uid => uidsSet.add(uid));
                    
                    // También por miembrosData
                    if (nidoDesc.miembrosData && Array.isArray(nidoDesc.miembrosData)) {
                      nidoDesc.miembrosData.forEach(m => {
                        if (m.uid) uidsSet.add(m.uid);
                        if (m.email) {
                          const uid = usuariosPorEmail.get(m.email.toLowerCase());
                          if (uid) uidsSet.add(uid);
                        }
                      });
                    }
                  });
                  console.log('→ Nidos descendientes encontrados:', descendientesSnap.size);
                } catch (e) {
                  console.warn('Error buscando descendientes:', e);
                }
              }
              console.log('→ Mi estirpe:', uidsSet.size, 'usuarios');
              break;
          }
        }
      } catch (error) {
        console.error('Error en resolverDestinatarios:', error);
      }
      
      // Excluir al remitente (para que no se envíe a sí mismo)
      uidsSet.delete(currentUser.uid);
      
      const destinatariosFinales = Array.from(uidsSet);
      console.log('=== DESTINATARIOS FINALES ===');
      console.log('Total:', destinatariosFinales.length);
      console.log('UIDs:', destinatariosFinales);
      
      return destinatariosFinales;
    }

    // ============ MODAL CREAR HITO ============
    const subtiposHito = {
      cita: [
        { value: 'reunion', label: '📋 Reunión' },
        { value: 'asistencia-tecnica', label: '🔧 Asistencia Técnica' },
        { value: 'visita', label: '👥 Visita' }
      ],
      evento: [
        { value: 'fiesta', label: '🎉 Fiesta' },
        { value: 'reunion-familiar', label: '👨‍👩‍👧‍👦 Reunión Familiar' },
        { value: 'torneo', label: '🏆 Torneo' }
      ]
    };

    function abrirModalHito() {
      document.getElementById('modal-hito').classList.add('active');
      track.iniciar('hito');
      cargarBienesParaHito();
      cambiarTipoHito();
      // Fecha por defecto: hoy
      document.getElementById('hito-fecha-inicio').value = new Date().toISOString().split('T')[0];
    }

    function cerrarModalHito() {
      document.getElementById('modal-hito').classList.remove('active');
      document.getElementById('form-hito').reset();
    }

    async function cargarBienesParaHito() {
      const select = document.getElementById('hito-bien');
      select.innerHTML = '<option value="">Sin asociar a bien</option>';
      
      try {
        await cargarBienesUsuario(); // Usar bienes ya filtrados por visibilidad
        
        if (bienesUsuario.length === 0) return;
        
        // Iconos por tipo de bien
        const iconosTipo = {
          'vivienda': '🏠',
          'vehiculo': '🚗',
          'terreno': '🌳',
          'local': '🏪',
          'garaje': '🅿️',
          'trastero': '📦',
          'otro': '📋'
        };
        
        // Iconos de visibilidad
        const iconosVisibilidad = {
          'rama': '🌳',
          'estirpe': '👥',
          'nido': '🪺'
        };
        
        bienesUsuario.forEach(bien => {
          const iconoBien = iconosTipo[bien.tipo] || '🏠';
          const iconoVis = iconosVisibilidad[bien.visibilidad] || '🌳';
          const labelVis = bien.visibilidad === 'rama' ? 'Rama' : bien.visibilidad === 'estirpe' ? 'Estirpe' : 'Nido';
          select.innerHTML += `<option value="${bien.id}">${iconoBien} ${bien.nombre} (${iconoVis} ${labelVis})</option>`;
        });
      } catch (e) {
        console.warn('Error cargando bienes:', e);
      }
    }

    function cambiarTipoHito() {
      const tipo = document.getElementById('hito-tipo').value;
      const subtipoSelect = document.getElementById('hito-subtipo');
      const subtipos = subtiposHito[tipo] || [];
      
      subtipoSelect.innerHTML = subtipos.map(s => 
        `<option value="${s.value}">${s.label}</option>`
      ).join('');

      // Mostrar/ocultar campos según tipo
      const bienGroup = document.getElementById('hito-bien-group');
      const fechaFinGroup = document.getElementById('hito-fecha-fin-group');
      const recurrenteGroup = document.getElementById('hito-recurrente-group');

      if (tipo === 'cita') {
        bienGroup.style.display = 'block'; // Mostrar bien para citas técnicas
        fechaFinGroup.style.display = 'none'; // Las citas suelen ser de un día
        recurrenteGroup.style.display = 'none';
      } else {
        bienGroup.style.display = 'block';
        fechaFinGroup.style.display = 'block'; // Eventos pueden durar varios días
        recurrenteGroup.style.display = 'block'; // Eventos pueden ser recurrentes
      }
    }

    async function guardarHito() {
      const btn = document.getElementById('btn-guardar-hito');
      btn.disabled = true;
      btn.innerHTML = '<span>⏳</span> Guardando...';

      const tipo = document.getElementById('hito-tipo').value;
      const visibilidad = document.getElementById('hito-visibilidad').value;
      const bienId = document.getElementById('hito-bien').value;
      const subtipo = document.getElementById('hito-subtipo').value;
      const titulo = document.getElementById('hito-titulo').value.trim();
      const fechaInicio = document.getElementById('hito-fecha-inicio').value;
      const fechaFin = document.getElementById('hito-fecha-fin').value;
      const horaInicio = document.getElementById('hito-hora-inicio').value;
      const horaFin = document.getElementById('hito-hora-fin').value;
      const lugar = document.getElementById('hito-lugar').value.trim();
      const descripcion = document.getElementById('hito-descripcion').value.trim();
      const recurrente = document.getElementById('hito-recurrente')?.checked || false;

      if (!titulo || !fechaInicio) {
        alert('Completa el título y la fecha');
        btn.disabled = false;
        btn.innerHTML = '<span>💾</span> Guardar';
        return;
      }

      try {
        let coleccion = '';
        let datos = {};

        const datosComunes = {
          familiaId: currentFamilia.id,
          visibilidad,
          bienId: bienId || null,
          nidoId: miNidoPrincipal?.id || null,
          creadoPor: currentUser.uid,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        };

        switch (tipo) {
          case 'cita':
            coleccion = 'citas';
            datos = {
              ...datosComunes,
              titulo,
              subtipo,
              fecha: fechaInicio,
              hora: horaInicio || null,
              horaFin: horaFin || null,
              lugar: lugar || null,
              descripcion: descripcion || null,
              estado: 'pendiente'
            };
            break;

          case 'evento':
            coleccion = 'eventos';
            datos = {
              ...datosComunes,
              nombre: titulo,
              subtipo,
              fecha: fechaInicio,
              fechaFin: fechaFin || null,
              hora: horaInicio || null,
              horaFin: horaFin || null,
              lugar: lugar || null,
              descripcion: descripcion || null,
              recurrente,
              estado: 'programado'
            };
            break;
        }

        console.log('Guardando en', coleccion, ':', datos);
        await db.collection(coleccion).add(datos);

        alert(`✅ ${tipo === 'cita' ? 'Cita' : 'Evento'} creado correctamente`);
        track.completar('hito');
        cerrarModalHito();

        // Refrescar calendario
        await cargarEventosCalendario();
        renderCalendario();

      } catch (error) {
        console.error('Error guardando:', error);
        alert('Error al guardar: ' + error.message);
      }

      btn.disabled = false;
      btn.innerHTML = '<span>💾</span> Guardar';
    }

    // ============ PRIMEROS PASOS ============
    function cerrarPrimerosPasos() {
      document.getElementById('modal-primeros-pasos').classList.remove('active');
    }

    function noMostrarPrimerosPasos() {
      localStorage.setItem('familynk_no_mostrar_primeros_pasos', 'true');
      cerrarPrimerosPasos();
    }

    function verVideoPrimerosPasos() {
      // Abrir video en nueva ventana o modal de video
      window.open('https://www.youtube.com/watch?v=VIDEO_ID', '_blank');
    }

    function mostrarPrimerosPasos() {
      // Detectar si es creador (AdminRama) o invitado
      const esCreador = esAdminRama;
      
      // Ocultar/mostrar secciones según rol
      document.getElementById('pasos-creador').style.display = esCreador ? 'block' : 'none';
      document.getElementById('pasos-invitado').style.display = esCreador ? 'none' : 'block';
      
      // Actualizar título
      document.getElementById('primeros-pasos-titulo').textContent = esCreador 
        ? '👋 ¡Bienvenido, creador!' 
        : '👋 ¡Bienvenido a la familia!';
      
      document.getElementById('modal-primeros-pasos').classList.add('active');
    }

    function verificarPrimerosPasos() {
      const noMostrar = localStorage.getItem('familynk_no_mostrar_primeros_pasos');
      if (noMostrar !== 'true') {
        mostrarPrimerosPasos();
      }
    }
  </script>

  <!-- Modal Primeros Pasos -->
  <div class="modal-overlay" id="modal-primeros-pasos">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);">
        <div class="modal-logo">🏠</div>
        <div class="modal-header-info">
          <h2 class="modal-title" id="primeros-pasos-titulo">👋 ¡Bienvenido!</h2>
          <p class="modal-subtitle">Tu espacio familiar te espera</p>
        </div>
        <button class="modal-close" onclick="cerrarPrimerosPasos()">&times;</button>
      </div>
      
      <div class="modal-body" style="padding: 20px;">
        
        <!-- GUÍA PARA CREADOR -->
        <div id="pasos-creador" style="display: none;">
          <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px;">
            Has creado tu rama familiar. Estos son tus primeros pasos:
          </p>
          
          <div class="pasos-lista">
            <div class="paso-item">
              <div class="paso-numero">1</div>
              <div class="paso-contenido">
                <strong>Configura tu nido</strong>
                <p>Ve a <em>Mi Nido</em> y completa los datos de tu hogar</p>
              </div>
            </div>
            
            <div class="paso-item">
              <div class="paso-numero">2</div>
              <div class="paso-contenido">
                <strong>Invita a tu familia</strong>
                <p>Desde <em>Admin Rama → Herramientas</em> invita a los miembros</p>
              </div>
            </div>
            
            <div class="paso-item">
              <div class="paso-numero">3</div>
              <div class="paso-contenido">
                <strong>Añade bienes compartidos</strong>
                <p>En <em>Lo Común</em> registra casas, vehículos o propiedades</p>
              </div>
            </div>
            
            <div class="paso-item">
              <div class="paso-numero">4</div>
              <div class="paso-contenido">
                <strong>Personaliza secciones</strong>
                <p>En <em>Admin Rama → Secciones</em> activa solo lo que necesites</p>
              </div>
            </div>
          </div>
          
          <div class="paso-tip">
            💡 <strong>Consejo:</strong> Empieza simple. Puedes activar más funciones cuando las necesites.
          </div>
        </div>
        
        <!-- GUÍA PARA INVITADO -->
        <div id="pasos-invitado" style="display: none;">
          <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px;">
            Te han invitado a unirte. Esto es lo que puedes hacer:
          </p>
          
          <div class="pasos-lista">
            <div class="paso-item">
              <div class="paso-numero">1</div>
              <div class="paso-contenido">
                <strong>Completa tu perfil</strong>
                <p>Pulsa en <em>Mi Nido</em> para ver y editar tus datos</p>
              </div>
            </div>
            
            <div class="paso-item">
              <div class="paso-numero">2</div>
              <div class="paso-contenido">
                <strong>Explora el Árbol</strong>
                <p>Descubre a todos los miembros de la familia</p>
              </div>
            </div>
            
            <div class="paso-item">
              <div class="paso-numero">3</div>
              <div class="paso-contenido">
                <strong>Revisa Lo Común</strong>
                <p>Mira los bienes compartidos y haz reservas si lo necesitas</p>
              </div>
            </div>
            
            <div class="paso-item">
              <div class="paso-numero">4</div>
              <div class="paso-contenido">
                <strong>Usa los botones de acción</strong>
                <p>Reporta averías, propón ideas o convoca reuniones</p>
              </div>
            </div>
          </div>
          
          <div class="paso-tip">
            💡 <strong>Consejo:</strong> Consulta el <em>Tablón</em> para ver avisos y notificaciones pendientes.
          </div>
        </div>
        
      </div>
      
      <div class="modal-footer" style="flex-direction: column; gap: 12px;">
        <button class="btn btn-primary" onclick="cerrarPrimerosPasos()" style="width: 100%;">
          ✨ ¡Entendido, empezar!
        </button>
        <label style="display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; font-size: 0.85rem; color: var(--text-muted);">
          <input type="checkbox" onchange="if(this.checked) noMostrarPrimerosPasos()">
          No volver a mostrar
        </label>
      </div>
    </div>
  </div>
  
  <style>
    .pasos-lista { display: flex; flex-direction: column; gap: 16px; margin-bottom: 20px; }
    .paso-item { display: flex; gap: 14px; align-items: flex-start; }
    .paso-numero {
      width: 28px; height: 28px; min-width: 28px;
      background: var(--sage);
      color: white;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.85rem;
    }
    .paso-contenido strong { display: block; margin-bottom: 2px; color: var(--text); }
    .paso-contenido p { margin: 0; font-size: 0.85rem; color: var(--text-muted); }
    .paso-contenido em { color: var(--sage-dark); font-style: normal; font-weight: 600; }
    .paso-tip {
      background: var(--cream);
      padding: 12px 16px;
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .paso-tip strong { color: var(--terracotta); }
  </style>
</body>
</html>
