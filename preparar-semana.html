<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Preparar Semana</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E; --sage-dark: #5C7D5F; --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3; --cream-dark: #F5EDE4;
      --terracotta: #C17757; --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A;
      --white: #FFFFFF; --success: #7DB59A; --warning: #E8B44D; --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06); --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
      --mayordomo: #8B7355; --mayordomo-muted: rgba(139, 115, 85, 0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; padding-bottom: 100px; }

    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      padding: 8px 14px;
      background: var(--cream);
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      color: var(--text-light);
      text-decoration: none;
    }
    .back-btn:hover { background: var(--cream-dark); }
    .page-title { font-family: 'Quicksand', sans-serif; font-size: 1.25rem; font-weight: 600; }
    .header-right { display: flex; gap: 12px; align-items: center; }

    .main { max-width: 800px; margin: 0 auto; padding: 24px; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 80px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--mayordomo); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* Semana Selector */
    .semana-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 16px;
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }
    .semana-nav-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: var(--cream);
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .semana-nav-btn:hover { background: var(--cream-dark); }
    .semana-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .semana-info { text-align: center; }
    .semana-titulo { font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 600; }
    .semana-fechas { font-size: 0.85rem; color: var(--text-muted); }
    .semana-estado {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 6px;
    }
    .estado-pendiente { background: var(--terracotta-muted); color: var(--terracotta); }
    .estado-preparado { background: var(--sage-muted); color: var(--sage-dark); }
    .estado-enviado { background: var(--mayordomo-muted); color: var(--mayordomo); }

    /* Secciones */
    .seccion {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .seccion-header {
      padding: 16px 20px;
      background: var(--cream);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .seccion-titulo {
      font-family: 'Quicksand', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .seccion-count {
      background: var(--sage);
      color: var(--white);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
    }
    .seccion-body { padding: 20px; }

    /* Checkbox habitaciones */
    .habitacion-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }
    .habitacion-check {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--cream);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .habitacion-check:hover { border-color: var(--sage-muted); }
    .habitacion-check.selected { border-color: var(--sage); background: var(--sage-muted); }
    .habitacion-check input { width: 18px; height: 18px; accent-color: var(--sage); }
    .habitacion-check-label { font-weight: 600; font-size: 0.9rem; }
    .habitacion-empty { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; }

    /* Toggle cambiar men√∫ */
    .menu-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      cursor: pointer;
    }
    .menu-toggle input { width: 18px; height: 18px; accent-color: var(--sage); }
    .menu-toggle-label { font-weight: 600; font-size: 0.9rem; }
    .menu-cambio { margin-top: 12px; }
    .menu-cambio.hidden { display: none; }

    /* Items lista (menaje, compras, tareas) */
    .item-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 16px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 10px;
      border-left: 3px solid var(--sage);
    }
    .item-card.compra { border-left-color: var(--terracotta); }
    .item-card.tarea { border-left-color: var(--mayordomo); }
    .item-icon { font-size: 1.2rem; }
    .item-content { flex: 1; }
    .item-titulo { font-weight: 600; font-size: 0.9rem; }
    .item-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .item-descripcion { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }
    .item-actions { display: flex; gap: 4px; }
    .item-btn {
      padding: 6px 10px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    .item-btn:hover { background: var(--cream-dark); color: var(--text); }
    .item-btn.delete:hover { color: var(--error); }

    /* Bot√≥n a√±adir */
    .add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px;
      border: 2px dashed var(--cream-dark);
      background: transparent;
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      color: var(--text-muted);
      cursor: pointer;
    }
    .add-btn:hover { border-color: var(--sage); color: var(--sage); background: var(--sage-muted); }

    /* Notas textarea */
    .notas-textarea {
      width: 100%;
      min-height: 120px;
      padding: 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
      resize: vertical;
    }
    .notas-textarea:focus { outline: none; border-color: var(--sage); }

    .empty-state { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; }

    /* Footer acciones */
    .footer-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      justify-content: center;
      gap: 12px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
    }
    .btn {
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--sage); color: var(--white); }
    .btn-primary:hover { background: var(--sage-dark); }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-mayordomo { background: var(--mayordomo); color: var(--white); }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--white); border-radius: var(--radius-lg); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-family: 'Quicksand', sans-serif; font-size: 1.15rem; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--cream-dark); display: flex; gap: 12px; justify-content: flex-end; }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--sage); }
    .form-textarea { resize: vertical; min-height: 80px; }

    @media (max-width: 600px) {
      .main { padding: 16px; }
      .form-row { grid-template-columns: 1fr; }
      .semana-nav { flex-wrap: wrap; }
      .habitacion-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
      <h1 class="page-title">üìã Preparar Semana</h1>
    </div>
    <div class="header-right">
      <span id="bien-nombre" style="font-size:0.85rem;color:var(--text-muted);">Cargando...</span>
    </div>
  </header>

  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>

    <div id="content" class="hidden">
      <!-- Navegador de semanas -->
      <div class="semana-nav">
        <button class="semana-nav-btn" id="btn-semana-anterior" onclick="cambiarSemana(-1)">‚óÄ</button>
        <div class="semana-info">
          <div class="semana-titulo" id="semana-titulo">Semana 3</div>
          <div class="semana-fechas" id="semana-fechas">Lun 13 Ene ‚Üí Dom 19 Ene</div>
          <span class="semana-estado estado-pendiente" id="semana-estado">Pendiente</span>
        </div>
        <button class="semana-nav-btn" id="btn-semana-siguiente" onclick="cambiarSemana(1)">‚ñ∂</button>
      </div>

      <!-- 1. Zonas a preparar -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('zonas')">
          <div class="seccion-titulo">
            <span>üè†</span> Zonas a preparar
            <span class="seccion-count" id="count-zonas">0</span>
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-zonas">
          <div class="habitacion-grid" id="zonas-grid">
            <!-- Zonas din√°micas desde zonasLimpieza -->
          </div>
        </div>
      </div>

      <!-- 2. Cambiar men√∫ -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('menu')">
          <div class="seccion-titulo">
            <span>üçΩÔ∏è</span> Cambiar men√∫
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-menu">
          <label class="menu-toggle">
            <input type="checkbox" id="menu-cambiar" onchange="toggleCambioMenu()">
            <span class="menu-toggle-label">Quiero cambiar el men√∫ programado</span>
          </label>
          <div class="menu-cambio hidden" id="menu-cambio-container">
            <div class="form-group">
              <label class="form-label">Describe el men√∫ deseado</label>
              <textarea class="form-textarea" id="menu-descripcion" placeholder="Ej: Preferimos pescado en lugar de carne, postre sin lactosa..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. Menaje especial -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('menaje')">
          <div class="seccion-titulo">
            <span>üç∑</span> Menaje especial
            <span class="seccion-count" id="count-menaje">0</span>
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-menaje">
          <div id="lista-menaje"></div>
          <button class="add-btn" onclick="abrirModalMenaje()">+ A√±adir menaje</button>
        </div>
      </div>

      <!-- 4. Compras y encargos especiales -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('compras')">
          <div class="seccion-titulo">
            <span>üõí</span> Compras y encargos especiales
            <span class="seccion-count" id="count-compras">0</span>
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-compras">
          <div id="lista-compras"></div>
          <button class="add-btn" onclick="abrirModalCompra()">+ A√±adir compra/encargo</button>
        </div>
      </div>

      <!-- 5. Otras tareas no programadas -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('tareas')">
          <div class="seccion-titulo">
            <span>‚úÖ</span> Otras tareas no programadas
            <span class="seccion-count" id="count-tareas">0</span>
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-tareas">
          <div id="lista-tareas"></div>
          <button class="add-btn" onclick="abrirModalTarea()">+ A√±adir tarea</button>
        </div>
      </div>

      <!-- 6. Notas -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('notas')">
          <div class="seccion-titulo">
            <span>üìù</span> Notas
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-notas">
          <textarea class="notas-textarea" id="notas-general" placeholder="Cualquier otra informaci√≥n relevante para esta semana..."></textarea>
        </div>
      </div>
    </div>
  </main>

  <div class="footer-actions">
    <button class="btn btn-secondary" onclick="guardarBorrador()">üíæ Guardar borrador</button>
    <button class="btn btn-mayordomo" onclick="enviarPreparacion()">üì§ Enviar al externo</button>
  </div>

  <!-- Modal Menaje -->
  <div class="modal-overlay" id="modal-menaje">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-menaje-titulo">üç∑ A√±adir menaje</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-menaje">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Art√≠culo *</label>
            <input type="text" class="form-input" id="menaje-articulo" placeholder="Ej: Copas de vino, Mantel especial..." required>
          </div>
          <div class="form-group">
            <label class="form-label">Cantidad</label>
            <input type="number" class="form-input" id="menaje-cantidad" value="1" min="1">
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-textarea" id="menaje-notas" placeholder="Detalles adicionales..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Compra -->
  <div class="modal-overlay" id="modal-compra">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-compra-titulo">üõí A√±adir compra/encargo</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-compra">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Art√≠culo o encargo *</label>
            <input type="text" class="form-input" id="compra-articulo" placeholder="Ej: Flores frescas, Vino reserva..." required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Cantidad</label>
              <input type="text" class="form-input" id="compra-cantidad" placeholder="Ej: 2, 1kg...">
            </div>
            <div class="form-group">
              <label class="form-label">Urgencia</label>
              <select class="form-select" id="compra-urgencia">
                <option value="normal">Normal</option>
                <option value="urgente">‚ö†Ô∏è Urgente</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-textarea" id="compra-notas" placeholder="Detalles, d√≥nde comprarlo..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Tarea -->
  <div class="modal-overlay" id="modal-tarea">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-tarea-titulo">‚úÖ Nueva tarea</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-tarea">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Tarea *</label>
            <input type="text" class="form-input" id="tarea-titulo" placeholder="Ej: Revisar caldera, Podar seto..." required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">D√≠a preferente</label>
              <select class="form-select" id="tarea-dia">
                <option value="">Sin preferencia</option>
                <option value="antes">Antes de la llegada</option>
                <option value="durante">Durante la estancia</option>
                <option value="despues">Despu√©s de la salida</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Prioridad</label>
              <select class="form-select" id="tarea-prioridad">
                <option value="normal">Normal</option>
                <option value="alta">‚ö†Ô∏è Alta</option>
                <option value="urgente">üî¥ Urgente</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-textarea" id="tarea-notas" placeholder="Instrucciones adicionales..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let zonasData = [];
    let semanaActual = null;
    let preparacionData = {
      zonas: [],             // IDs de zonas seleccionadas (de zonasLimpieza)
      cambiarMenu: false,
      menuDescripcion: '',
      menaje: [],            // {articulo, cantidad, notas}
      compras: [],           // {articulo, cantidad, urgencia, notas}
      tareas: [],            // {titulo, dia, prioridad, notas}
      notas: '',
      estado: 'pendiente'
    };
    let editingIdx = null;
    let editingType = null;

    // Iconos por tipo de zona/dependencia
    const ZONA_ICONS = {
      dormitorio: 'üõèÔ∏è', servicio: 'üöø', aseo: 'üöΩ', vestuario: 'üëî',
      cocina: 'üç≥', salon: 'üõãÔ∏è', comedor: 'üçΩÔ∏è', almacen: 'üì¶',
      camara: '‚ùÑÔ∏è', taller: 'üîß', instalacion: '‚ö°', porche: 'üåø', otro: 'üè†'
    };

    const mesesCortos = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    document.getElementById('btn-volver').href = `bien.html?id=${bienId}`;

    if (!bienId) window.location.href = 'lo-comun.html';

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarDatos();
    });

    async function cargarDatos() {
      try {
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) { alert('Bien no encontrado'); return; }
        bienData = { id: bienDoc.id, ...bienDoc.data() };
        document.getElementById('bien-nombre').textContent = bienData.nombre || 'Sin nombre';

        // Cargar zonas del bien (de zonasLimpieza)
        await cargarZonas();
        
        inicializarSemana();
        await cargarPreparacion();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
      } catch (e) {
        console.error(e);
        alert('Error cargando datos');
      }
    }

    async function cargarZonas() {
      // Cargar zonas desde zonasLimpieza (la fuente de verdad)
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('zonasLimpieza').get();
        if (!snap.empty) {
          zonasData = snap.docs.map(doc => {
            const data = doc.data();
            // Determinar icono basado en las dependencias principales
            const deps = data.dependencias || {};
            let iconoPrincipal = 'üè†';
            // Buscar el tipo con m√°s dependencias
            let maxDeps = 0;
            for (const [tipo, cantidad] of Object.entries(deps)) {
              if (cantidad > maxDeps) {
                maxDeps = cantidad;
                iconoPrincipal = ZONA_ICONS[tipo] || 'üè†';
              }
            }
            return {
              id: doc.id,
              nombre: data.nombre || 'Sin nombre',
              icono: iconoPrincipal,
              dependencias: deps
            };
          });
        } else {
          // Sin zonas configuradas
          zonasData = [];
        }
      } catch (e) {
        console.error('Error cargando zonas:', e);
        zonasData = [];
      }
    }

    function inicializarSemana() {
      const hoy = new Date();
      const diaHoy = hoy.getDay();
      const lunes = new Date(hoy);
      const diff = diaHoy === 0 ? -6 : 1 - diaHoy;
      lunes.setDate(hoy.getDate() + diff);
      lunes.setHours(0, 0, 0, 0);
      semanaActual = lunes;
      actualizarVisualizacionSemana();
    }

    function actualizarVisualizacionSemana() {
      const domingo = new Date(semanaActual);
      domingo.setDate(domingo.getDate() + 6);
      
      const numSemana = getNumeroSemana(semanaActual);
      document.getElementById('semana-titulo').textContent = `Semana ${numSemana}`;
      document.getElementById('semana-fechas').textContent = 
        `Lun ${semanaActual.getDate()} ${mesesCortos[semanaActual.getMonth()]} ‚Üí Dom ${domingo.getDate()} ${mesesCortos[domingo.getMonth()]}`;
      
      actualizarEstado();
    }

    function getNumeroSemana(fecha) {
      const inicio = new Date(fecha.getFullYear(), 0, 1);
      const dias = Math.floor((fecha - inicio) / (24 * 60 * 60 * 1000));
      return Math.ceil((fecha.getDay() + 1 + dias) / 7);
    }

    function getSemanaKey() {
      return `${semanaActual.getFullYear()}-W${String(getNumeroSemana(semanaActual)).padStart(2, '0')}`;
    }

    async function cargarPreparacion() {
      const semanaKey = getSemanaKey();
      try {
        const doc = await db.collection('bienes').doc(bienId)
          .collection('preparacionSemanal').doc(semanaKey).get();
        
        if (doc.exists) {
          const data = doc.data();
          preparacionData = {
            // Compatibilidad: leer zonas o habitaciones (migraci√≥n)
            zonas: data.zonas || data.habitaciones || [],
            cambiarMenu: data.cambiarMenu || false,
            menuDescripcion: data.menuDescripcion || '',
            menaje: data.menaje || [],
            compras: data.compras || [],
            tareas: data.tareas || [],
            notas: data.notas || '',
            estado: data.estado || 'pendiente'
          };
        } else {
          preparacionData = {
            zonas: [],
            cambiarMenu: false,
            menuDescripcion: '',
            menaje: [],
            compras: [],
            tareas: [],
            notas: '',
            estado: 'pendiente'
          };
        }
      } catch (e) {
        console.error('Error cargando preparaci√≥n:', e);
      }

      renderAll();
    }

    function renderAll() {
      renderZonas();
      renderMenu();
      renderMenaje();
      renderCompras();
      renderTareas();
      renderNotas();
      actualizarEstado();
    }

    // ========== ZONAS ==========
    function renderZonas() {
      const container = document.getElementById('zonas-grid');
      const count = preparacionData.zonas.length;
      document.getElementById('count-zonas').textContent = count;

      if (zonasData.length === 0) {
        container.innerHTML = `
          <div class="habitacion-empty">
            No hay zonas configuradas.<br>
            <a href="zonas-tareas.html?id=${bienId}" style="color:var(--mayordomo);">Configura las zonas en Limpieza</a>
          </div>`;
        return;
      }

      container.innerHTML = zonasData.map(z => {
        const selected = preparacionData.zonas.includes(z.id);
        return `
          <label class="habitacion-check ${selected ? 'selected' : ''}" onclick="toggleZona('${z.id}', event)">
            <input type="checkbox" ${selected ? 'checked' : ''}>
            <span class="habitacion-check-label">${z.icono} ${z.nombre}</span>
          </label>
        `;
      }).join('');
    }

    function toggleZona(id, e) {
      e.preventDefault();
      const idx = preparacionData.zonas.indexOf(id);
      if (idx >= 0) {
        preparacionData.zonas.splice(idx, 1);
      } else {
        preparacionData.zonas.push(id);
      }
      renderZonas();
      actualizarEstado();
    }

    // ========== MEN√ö ==========
    function renderMenu() {
      document.getElementById('menu-cambiar').checked = preparacionData.cambiarMenu;
      document.getElementById('menu-descripcion').value = preparacionData.menuDescripcion;
      toggleCambioMenu();
    }

    function toggleCambioMenu() {
      const cambiar = document.getElementById('menu-cambiar').checked;
      preparacionData.cambiarMenu = cambiar;
      document.getElementById('menu-cambio-container').classList.toggle('hidden', !cambiar);
    }

    // ========== MENAJE ==========
    function renderMenaje() {
      const container = document.getElementById('lista-menaje');
      document.getElementById('count-menaje').textContent = preparacionData.menaje.length;

      if (preparacionData.menaje.length === 0) {
        container.innerHTML = '<div class="empty-state">Sin menaje especial</div>';
        return;
      }

      container.innerHTML = preparacionData.menaje.map((m, idx) => `
        <div class="item-card">
          <span class="item-icon">üç∑</span>
          <div class="item-content">
            <div class="item-titulo">${m.articulo}</div>
            <div class="item-meta">Cantidad: ${m.cantidad || 1}</div>
            ${m.notas ? `<div class="item-descripcion">${m.notas}</div>` : ''}
          </div>
          <div class="item-actions">
            <button class="item-btn" onclick="editarMenaje(${idx})">‚úèÔ∏è</button>
            <button class="item-btn delete" onclick="eliminarMenaje(${idx})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function abrirModalMenaje(idx = null) {
      editingIdx = idx;
      editingType = 'menaje';
      const m = idx !== null ? preparacionData.menaje[idx] : null;
      
      document.getElementById('modal-menaje-titulo').textContent = m ? '‚úèÔ∏è Editar menaje' : 'üç∑ A√±adir menaje';
      document.getElementById('menaje-articulo').value = m?.articulo || '';
      document.getElementById('menaje-cantidad').value = m?.cantidad || 1;
      document.getElementById('menaje-notas').value = m?.notas || '';
      
      document.getElementById('modal-menaje').classList.add('active');
    }

    function editarMenaje(idx) { abrirModalMenaje(idx); }

    function eliminarMenaje(idx) {
      if (!confirm('¬øEliminar este menaje?')) return;
      preparacionData.menaje.splice(idx, 1);
      renderMenaje();
      actualizarEstado();
    }

    document.getElementById('form-menaje').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = {
        articulo: document.getElementById('menaje-articulo').value,
        cantidad: parseInt(document.getElementById('menaje-cantidad').value) || 1,
        notas: document.getElementById('menaje-notas').value
      };

      if (editingIdx !== null) {
        preparacionData.menaje[editingIdx] = data;
      } else {
        preparacionData.menaje.push(data);
      }

      cerrarModales();
      renderMenaje();
      actualizarEstado();
    });

    // ========== COMPRAS ==========
    function renderCompras() {
      const container = document.getElementById('lista-compras');
      document.getElementById('count-compras').textContent = preparacionData.compras.length;

      if (preparacionData.compras.length === 0) {
        container.innerHTML = '<div class="empty-state">Sin compras ni encargos</div>';
        return;
      }

      container.innerHTML = preparacionData.compras.map((c, idx) => `
        <div class="item-card compra">
          <span class="item-icon">${c.urgencia === 'urgente' ? '‚ö†Ô∏è' : 'üõí'}</span>
          <div class="item-content">
            <div class="item-titulo">${c.articulo}</div>
            <div class="item-meta">${c.cantidad ? `Cantidad: ${c.cantidad}` : ''} ${c.urgencia === 'urgente' ? '‚Ä¢ URGENTE' : ''}</div>
            ${c.notas ? `<div class="item-descripcion">${c.notas}</div>` : ''}
          </div>
          <div class="item-actions">
            <button class="item-btn" onclick="editarCompra(${idx})">‚úèÔ∏è</button>
            <button class="item-btn delete" onclick="eliminarCompra(${idx})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function abrirModalCompra(idx = null) {
      editingIdx = idx;
      editingType = 'compra';
      const c = idx !== null ? preparacionData.compras[idx] : null;
      
      document.getElementById('modal-compra-titulo').textContent = c ? '‚úèÔ∏è Editar compra' : 'üõí A√±adir compra/encargo';
      document.getElementById('compra-articulo').value = c?.articulo || '';
      document.getElementById('compra-cantidad').value = c?.cantidad || '';
      document.getElementById('compra-urgencia').value = c?.urgencia || 'normal';
      document.getElementById('compra-notas').value = c?.notas || '';
      
      document.getElementById('modal-compra').classList.add('active');
    }

    function editarCompra(idx) { abrirModalCompra(idx); }

    function eliminarCompra(idx) {
      if (!confirm('¬øEliminar esta compra?')) return;
      preparacionData.compras.splice(idx, 1);
      renderCompras();
      actualizarEstado();
    }

    document.getElementById('form-compra').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = {
        articulo: document.getElementById('compra-articulo').value,
        cantidad: document.getElementById('compra-cantidad').value,
        urgencia: document.getElementById('compra-urgencia').value,
        notas: document.getElementById('compra-notas').value
      };

      if (editingIdx !== null) {
        preparacionData.compras[editingIdx] = data;
      } else {
        preparacionData.compras.push(data);
      }

      cerrarModales();
      renderCompras();
      actualizarEstado();
    });

    // ========== TAREAS ==========
    function renderTareas() {
      const container = document.getElementById('lista-tareas');
      document.getElementById('count-tareas').textContent = preparacionData.tareas.length;

      if (preparacionData.tareas.length === 0) {
        container.innerHTML = '<div class="empty-state">Sin tareas adicionales</div>';
        return;
      }

      const diaLabels = { antes: 'Antes de llegada', durante: 'Durante estancia', despues: 'Despu√©s de salida' };

      container.innerHTML = preparacionData.tareas.map((t, idx) => {
        const prioIcon = t.prioridad === 'urgente' ? 'üî¥ ' : t.prioridad === 'alta' ? '‚ö†Ô∏è ' : '';
        return `
          <div class="item-card tarea">
            <span class="item-icon">‚úÖ</span>
            <div class="item-content">
              <div class="item-titulo">${prioIcon}${t.titulo}</div>
              <div class="item-meta">${t.dia ? diaLabels[t.dia] || t.dia : 'Sin preferencia'}</div>
              ${t.notas ? `<div class="item-descripcion">${t.notas}</div>` : ''}
            </div>
            <div class="item-actions">
              <button class="item-btn" onclick="editarTarea(${idx})">‚úèÔ∏è</button>
              <button class="item-btn delete" onclick="eliminarTarea(${idx})">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function abrirModalTarea(idx = null) {
      editingIdx = idx;
      editingType = 'tarea';
      const t = idx !== null ? preparacionData.tareas[idx] : null;
      
      document.getElementById('modal-tarea-titulo').textContent = t ? '‚úèÔ∏è Editar tarea' : '‚úÖ Nueva tarea';
      document.getElementById('tarea-titulo').value = t?.titulo || '';
      document.getElementById('tarea-dia').value = t?.dia || '';
      document.getElementById('tarea-prioridad').value = t?.prioridad || 'normal';
      document.getElementById('tarea-notas').value = t?.notas || '';
      
      document.getElementById('modal-tarea').classList.add('active');
    }

    function editarTarea(idx) { abrirModalTarea(idx); }

    function eliminarTarea(idx) {
      if (!confirm('¬øEliminar esta tarea?')) return;
      preparacionData.tareas.splice(idx, 1);
      renderTareas();
      actualizarEstado();
    }

    document.getElementById('form-tarea').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = {
        titulo: document.getElementById('tarea-titulo').value,
        dia: document.getElementById('tarea-dia').value,
        prioridad: document.getElementById('tarea-prioridad').value,
        notas: document.getElementById('tarea-notas').value
      };

      if (editingIdx !== null) {
        preparacionData.tareas[editingIdx] = data;
      } else {
        preparacionData.tareas.push(data);
      }

      cerrarModales();
      renderTareas();
      actualizarEstado();
    });

    // ========== NOTAS ==========
    function renderNotas() {
      document.getElementById('notas-general').value = preparacionData.notas || '';
    }

    // ========== ESTADO ==========
    function actualizarEstado() {
      const el = document.getElementById('semana-estado');
      el.className = 'semana-estado';
      
      if (preparacionData.estado === 'enviado') {
        el.classList.add('estado-enviado');
        el.textContent = 'üì§ Enviado';
      } else if (tieneContenido()) {
        el.classList.add('estado-preparado');
        el.textContent = 'üìù Borrador';
      } else {
        el.classList.add('estado-pendiente');
        el.textContent = 'Pendiente';
      }
    }

    function tieneContenido() {
      return preparacionData.zonas.length > 0 ||
             preparacionData.cambiarMenu ||
             preparacionData.menaje.length > 0 ||
             preparacionData.compras.length > 0 ||
             preparacionData.tareas.length > 0 ||
             preparacionData.notas.trim() !== '';
    }

    // ========== NAVEGACI√ìN SEMANA ==========
    function cambiarSemana(dir) {
      semanaActual.setDate(semanaActual.getDate() + (dir * 7));
      actualizarVisualizacionSemana();
      cargarPreparacion();
    }

    // ========== GUARDAR / ENVIAR ==========
    async function guardarBorrador(silencioso = false) {
      // Actualizar datos desde los inputs
      preparacionData.menuDescripcion = document.getElementById('menu-descripcion').value;
      preparacionData.notas = document.getElementById('notas-general').value;

      const semanaKey = getSemanaKey();
      try {
        await db.collection('bienes').doc(bienId)
          .collection('preparacionSemanal').doc(semanaKey).set({
            ...preparacionData,
            estado: preparacionData.estado === 'enviado' ? 'enviado' : 'borrador',
            actualizadoPor: currentUser.uid,
            fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        
        if (!silencioso) {
          alert('‚úÖ Borrador guardado');
        }
        actualizarEstado();
      } catch (e) {
        console.error(e);
        if (!silencioso) alert('Error al guardar');
      }
    }

    async function enviarPreparacion() {
      if (!tieneContenido()) {
        alert('A√±ade al menos algo de informaci√≥n antes de enviar');
        return;
      }

      if (!confirm('¬øEnviar esta preparaci√≥n al externo?')) return;

      // Actualizar datos desde los inputs
      preparacionData.menuDescripcion = document.getElementById('menu-descripcion').value;
      preparacionData.notas = document.getElementById('notas-general').value;

      const semanaKey = getSemanaKey();
      try {
        await db.collection('bienes').doc(bienId)
          .collection('preparacionSemanal').doc(semanaKey).set({
            ...preparacionData,
            estado: 'enviado',
            enviadoPor: currentUser.uid,
            fechaEnvio: firebase.firestore.FieldValue.serverTimestamp()
          });
        
        preparacionData.estado = 'enviado';
        actualizarEstado();
        alert('‚úÖ Preparaci√≥n enviada correctamente');
      } catch (e) {
        console.error(e);
        alert('Error al enviar');
      }
    }

    // ========== UTILS ==========
    function toggleSeccion(id) {
      document.getElementById(`body-${id}`).classList.toggle('hidden');
    }

    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
      editingIdx = null;
      editingType = null;
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) cerrarModales();
      });
    });
  </script>
</body>
</html>
