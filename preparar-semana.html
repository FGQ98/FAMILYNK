<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Preparar Semana</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E; --sage-dark: #5C7D5F; --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3; --cream-dark: #F5EDE4;
      --terracotta: #C17757; --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A;
      --white: #FFFFFF; --success: #7DB59A; --warning: #E8B44D; --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06); --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
      --mayordomo: #8B7355; --mayordomo-muted: rgba(139, 115, 85, 0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; padding-bottom: 100px; }

    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      padding: 8px 14px;
      background: var(--cream);
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      color: var(--text-light);
      text-decoration: none;
    }
    .back-btn:hover { background: var(--cream-dark); }
    .page-title { font-family: 'Quicksand', sans-serif; font-size: 1.25rem; font-weight: 600; }
    .header-right { display: flex; gap: 12px; align-items: center; }

    .main { max-width: 800px; margin: 0 auto; padding: 24px; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 80px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--mayordomo); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* Semana Selector */
    .semana-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 16px;
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }
    .semana-nav-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: var(--cream);
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .semana-nav-btn:hover { background: var(--cream-dark); }
    .semana-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .semana-info { text-align: center; }
    .semana-titulo { font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 600; }
    .semana-fechas { font-size: 0.85rem; color: var(--text-muted); }
    .semana-estado {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 6px;
    }
    .estado-pendiente { background: var(--terracotta-muted); color: var(--terracotta); }
    .estado-preparado { background: var(--sage-muted); color: var(--sage-dark); }
    .estado-enviado { background: var(--mayordomo-muted); color: var(--mayordomo); }

    /* Secciones */
    .seccion {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .seccion-header {
      padding: 16px 20px;
      background: var(--cream);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .seccion-titulo {
      font-family: 'Quicksand', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .seccion-count {
      background: var(--sage);
      color: var(--white);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
    }
    .seccion-body { padding: 20px; }

    /* Checkbox habitaciones */
    .habitacion-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }
    .habitacion-check {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--cream);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .habitacion-check:hover { border-color: var(--sage-muted); }
    .habitacion-check.selected { border-color: var(--sage); background: var(--sage-muted); }
    .habitacion-check input { width: 18px; height: 18px; accent-color: var(--sage); }
    .habitacion-check-label { font-weight: 600; font-size: 0.9rem; }
    .habitacion-empty { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; }

    /* Toggle cambiar men√∫ */
    .menu-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      cursor: pointer;
    }
    .menu-toggle input { width: 18px; height: 18px; accent-color: var(--sage); }
    .menu-toggle-label { font-weight: 600; font-size: 0.9rem; }
    .menu-cambio { margin-top: 12px; }
    .menu-cambio.hidden { display: none; }

    /* Items lista (menaje, compras, tareas) */
    .item-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 16px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 10px;
      border-left: 3px solid var(--sage);
    }
    .item-card.compra { border-left-color: var(--terracotta); }
    .item-card.tarea { border-left-color: var(--mayordomo); }
    .item-icon { font-size: 1.2rem; }
    .item-content { flex: 1; }
    .item-titulo { font-weight: 600; font-size: 0.9rem; }
    .item-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .item-descripcion { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }
    .item-actions { display: flex; gap: 4px; }
    .item-btn {
      padding: 6px 10px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    .item-btn:hover { background: var(--cream-dark); color: var(--text); }
    .item-btn.delete:hover { color: var(--error); }

    /* Bot√≥n a√±adir */
    .add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px;
      border: 2px dashed var(--cream-dark);
      background: transparent;
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      color: var(--text-muted);
      cursor: pointer;
    }
    .add-btn:hover { border-color: var(--sage); color: var(--sage); background: var(--sage-muted); }

    /* Notas textarea */
    .notas-textarea {
      width: 100%;
      min-height: 120px;
      padding: 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
      resize: vertical;
    }
    .notas-textarea:focus { outline: none; border-color: var(--sage); }

    .empty-state { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; }

    /* Subsecciones */
    .subseccion {
      padding: 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }
    .subseccion-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 12px;
      color: var(--text);
    }
    .subseccion-count {
      background: var(--mayordomo);
      color: var(--white);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      margin-left: auto;
    }

    /* Borradores */
    .borradores-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cream);
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .borradores-btn:hover { border-color: var(--mayordomo); background: var(--mayordomo-muted); }
    .borradores-badge {
      background: var(--terracotta);
      color: var(--white);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* Footer acciones */
    .footer-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      justify-content: center;
      gap: 12px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
    }
    .btn {
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--sage); color: var(--white); }
    .btn-primary:hover { background: var(--sage-dark); }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-mayordomo { background: var(--mayordomo); color: var(--white); }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--white); border-radius: var(--radius-lg); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-family: 'Quicksand', sans-serif; font-size: 1.15rem; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--cream-dark); display: flex; gap: 12px; justify-content: flex-end; }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--sage); }
    .form-textarea { resize: vertical; min-height: 80px; }

    @media (max-width: 600px) {
      .main { padding: 16px; }
      .form-row { grid-template-columns: 1fr; }
      .semana-nav { flex-wrap: wrap; }
      .habitacion-grid { grid-template-columns: 1fr 1fr; }
      .matriz { overflow-x: auto; }
      .matriz table { min-width: 400px; }
    }

    /* Matrices */
    .matriz {
      width: 100%;
      margin-top: 12px;
    }
    .matriz table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .matriz th, .matriz td {
      padding: 10px 8px;
      text-align: center;
      border: 1px solid var(--cream-dark);
    }
    .matriz th {
      background: var(--mayordomo);
      color: var(--white);
      font-weight: 600;
      font-size: 0.8rem;
    }
    .matriz th:first-child {
      background: var(--cream-dark);
      color: var(--text);
      text-align: left;
      min-width: 100px;
    }
    .matriz td:first-child {
      background: var(--cream);
      font-weight: 600;
      text-align: left;
    }
    .matriz input[type="number"] {
      width: 50px;
      padding: 6px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      text-align: center;
      font-size: 0.9rem;
    }
    .matriz input[type="number"]:focus {
      outline: none;
      border-color: var(--sage);
    }

    /* Slider toggle */
    .slider-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }
    .slider-toggle input[type="checkbox"] {
      position: relative;
      width: 50px;
      height: 24px;
      appearance: none;
      background: var(--cream-dark);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .slider-toggle input[type="checkbox"]::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: var(--white);
      border-radius: 50%;
      transition: all 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .slider-toggle input[type="checkbox"]:checked {
      background: var(--terracotta);
    }
    .slider-toggle input[type="checkbox"]:checked::before {
      left: 28px;
    }
    .slider-label { font-size: 0.75rem; color: var(--text-muted); }
    .slider-label.active { color: var(--terracotta); font-weight: 600; }

    /* Especial input */
    .especial-input {
      margin-top: 6px;
      display: none;
    }
    .especial-input.visible {
      display: block;
    }
    .especial-input input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
    }

    /* Multi-select chips */
    .roles-select {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
    }

    /* Solicitudes disponibles */
    .solicitudes-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      margin-bottom: 20px;
      border-left: 4px solid var(--terracotta);
    }
    .solicitudes-header {
      padding: 16px 20px;
      background: var(--terracotta-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .solicitudes-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .solicitudes-count {
      background: var(--terracotta);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
    }
    .solicitudes-body { padding: 16px 20px; }
    .solicitud-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 10px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .solicitud-card:hover { border-color: var(--terracotta); }
    .solicitud-card.active { border-color: var(--sage); background: var(--sage-muted); }
    .solicitud-info { flex: 1; }
    .solicitud-nombre { font-weight: 600; font-size: 0.9rem; }
    .solicitud-meta { font-size: 0.8rem; color: var(--text-muted); }
    .solicitud-estado { padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
    .solicitud-estado.pendiente { background: #FFF3E0; color: #E65100; }
    .solicitud-estado.aprobada { background: var(--sage-muted); color: var(--sage-dark); }
    .solicitudes-empty { text-align: center; padding: 20px; color: var(--text-muted); }
    .role-chip {
      padding: 4px 8px;
      background: var(--cream);
      border: 1px solid var(--cream-dark);
      border-radius: 12px;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .role-chip:hover {
      border-color: var(--sage);
    }
    .role-chip.selected {
      background: var(--sage);
      color: var(--white);
      border-color: var(--sage);
    }

    /* Zonas con desglose */
    .zona-group {
      margin-bottom: 16px;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .zona-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--cream);
      cursor: pointer;
    }
    .zona-header input { width: 18px; height: 18px; accent-color: var(--sage); }
    .zona-header-label { font-weight: 600; font-size: 0.9rem; flex: 1; }
    .zona-count {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: var(--cream-dark);
      padding: 2px 8px;
      border-radius: 10px;
    }
    .zona-toggle-deps {
      font-size: 0.75rem;
      color: var(--sage);
      padding: 4px 8px;
      background: var(--sage-muted);
      border-radius: 10px;
      cursor: pointer;
    }
    .zona-toggle-deps:hover { background: var(--sage); color: var(--white); }
    .zona-deps {
      padding: 12px;
      background: var(--white);
      display: none;
    }
    .zona-deps.visible { display: block; }
    .dep-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      margin-bottom: 6px;
      background: var(--cream);
      border-radius: var(--radius-sm);
    }
    .dep-item input { width: 16px; height: 16px; accent-color: var(--sage); }
    .dep-item-label { font-size: 0.85rem; }
    .dep-item-tipo { font-size: 0.7rem; color: var(--text-muted); margin-left: auto; }

    /* Menaje slider */
    .menaje-tipo {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px;
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }
    .menaje-tipo-label { font-weight: 600; }

    /* Ajuar selector */
    .ajuar-selector {
      display: none;
      margin-top: 12px;
    }
    .ajuar-selector.visible { display: block; }
    .ajuar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      padding: 12px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }
    .ajuar-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--white);
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .ajuar-item:hover { border-color: var(--sage-muted); }
    .ajuar-item.selected { border-color: var(--sage); background: var(--sage-muted); }
    .ajuar-item input { width: 14px; height: 14px; accent-color: var(--sage); }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
      <h1 class="page-title">üìã Preparar Semana</h1>
    </div>
    <div class="header-right">
      <span id="bien-nombre" style="font-size:0.85rem;color:var(--text-muted);">Cargando...</span>
    </div>
  </header>

  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>

    <div id="content" class="hidden">
      <!-- Solicitudes disponibles -->
      <div class="solicitudes-section" id="solicitudes-section">
        <div class="solicitudes-header">
          <div class="solicitudes-title">üìã Solicitudes disponibles <span class="solicitudes-count" id="solicitudes-count">0</span></div>
        </div>
        <div class="solicitudes-body" id="solicitudes-body">
          <div class="solicitudes-empty">Cargando...</div>
        </div>
      </div>

      <!-- Navegador de semanas -->
      <div class="semana-nav">
        <button class="semana-nav-btn" id="btn-semana-anterior" onclick="cambiarSemana(-1)">‚óÄ</button>
        <div class="semana-info">
          <div class="semana-titulo" id="semana-titulo">Semana 3</div>
          <div class="semana-fechas" id="semana-fechas">Lun 13 Ene ‚Üí Dom 19 Ene</div>
          <span class="semana-estado estado-pendiente" id="semana-estado">Pendiente</span>
        </div>
        <button class="semana-nav-btn" id="btn-semana-siguiente" onclick="cambiarSemana(1)">‚ñ∂</button>
      </div>

      <!-- Botones borradores e hist√≥rico -->
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-bottom:16px;">
        <button class="borradores-btn" onclick="abrirModalBorradores()">
          üìÅ Borradores <span class="borradores-badge" id="count-borradores">0</span>
        </button>
        <button class="borradores-btn" onclick="abrirModalHistorico()" style="border-color:var(--sage);">
          üìã Hist√≥rico <span class="borradores-badge" id="count-historico" style="background:var(--sage);">0</span>
        </button>
      </div>

      <!-- 1. Zonas a preparar -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('zonas')">
          <div class="seccion-titulo">
            <span>üè†</span> Zonas a preparar
            <span class="seccion-count" id="count-zonas">0</span>
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-zonas">
          <div id="zonas-container">
            <!-- Zonas din√°micas agrupadas -->
          </div>
        </div>
      </div>

      <!-- 2. Personas -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('personas')">
          <div class="seccion-titulo">
            <span>üë•</span> Personas
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-personas">
          <div id="matriz-personas"></div>
        </div>
      </div>

      <!-- 3. Men√∫s -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('menus')">
          <div class="seccion-titulo">
            <span>üçΩÔ∏è</span> Men√∫s
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-menus">
          <div id="matriz-menus"></div>
        </div>
      </div>

      <!-- 4. Servicio -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('servicio')">
          <div class="seccion-titulo">
            <span>üë®‚Äçüç≥</span> Servicio
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-servicio">
          <div id="matriz-servicio"></div>
        </div>
      </div>

      <!-- 5. Menaje -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('menaje')">
          <div class="seccion-titulo">
            <span>üç∑</span> Menaje
            <span class="seccion-count" id="count-menaje">0</span>
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-menaje">
          <div class="menaje-tipo">
            <span class="menaje-tipo-label">Tipo de menaje:</span>
            <div class="slider-toggle">
              <span class="slider-label" id="label-habitual">Habitual</span>
              <input type="checkbox" id="menaje-especial" onchange="toggleMenajeEspecial()">
              <span class="slider-label" id="label-especial">Especial</span>
            </div>
          </div>
          <div class="ajuar-selector" id="ajuar-selector">
            <label class="form-label">Selecciona del Ajuar:</label>
            <div class="ajuar-grid" id="ajuar-grid">
              <!-- Items del ajuar -->
            </div>
          </div>
          <div id="lista-menaje"></div>
          <button class="add-btn" onclick="abrirModalMenaje()">+ A√±adir menaje adicional</button>
        </div>
      </div>

      <!-- 6. Producto -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('producto')">
          <div class="seccion-titulo">
            <span>üì¶</span> Producto
            <span class="seccion-count" id="count-producto">0</span>
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-producto">
          <!-- Producto Aportado -->
          <div class="subseccion">
            <div class="subseccion-header">
              <span>üè†</span> Aportado por la casa
              <span class="subseccion-count" id="count-aportado">0</span>
            </div>
            <div id="lista-producto-aportado"></div>
            <button class="add-btn" onclick="abrirModalProducto('aportado')">+ A√±adir producto aportado</button>
          </div>
          
          <!-- Producto Solicitado -->
          <div class="subseccion" style="margin-top: 20px;">
            <div class="subseccion-header">
              <span>üõí</span> Solicitado (compras/encargos)
              <span class="subseccion-count" id="count-solicitado">0</span>
            </div>
            <div id="lista-producto-solicitado"></div>
            <button class="add-btn" onclick="abrirModalProducto('solicitado')">+ A√±adir producto solicitado</button>
          </div>
        </div>
      </div>

      <!-- 7. Otras tareas no programadas -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('tareas')">
          <div class="seccion-titulo">
            <span>‚úÖ</span> Otras tareas
            <span class="seccion-count" id="count-tareas">0</span>
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-tareas">
          <div id="lista-tareas"></div>
          <button class="add-btn" onclick="abrirModalTarea()">+ A√±adir tarea</button>
        </div>
      </div>

      <!-- 8. Notas -->
      <div class="seccion">
        <div class="seccion-header" onclick="toggleSeccion('notas')">
          <div class="seccion-titulo">
            <span>üìù</span> Notas
          </div>
          <span class="seccion-toggle">‚ñº</span>
        </div>
        <div class="seccion-body" id="body-notas">
          <textarea class="notas-textarea" id="notas-general" placeholder="Cualquier otra informaci√≥n relevante para esta semana..."></textarea>
        </div>
      </div>
    </div>
  </main>

  <div class="footer-actions">
    <button class="btn btn-secondary" onclick="guardarBorrador()">üíæ Guardar borrador</button>
    <button class="btn btn-mayordomo" onclick="enviarPreparacion()">üì§ Enviar al externo</button>
  </div>

  <!-- Modal Menaje -->
  <div class="modal-overlay" id="modal-menaje">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-menaje-titulo">üç∑ A√±adir menaje</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-menaje">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Art√≠culo *</label>
            <input type="text" class="form-input" id="menaje-articulo" placeholder="Ej: Copas de vino, Mantel especial..." required>
          </div>
          <div class="form-group">
            <label class="form-label">Cantidad</label>
            <input type="number" class="form-input" id="menaje-cantidad" value="1" min="1">
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-textarea" id="menaje-notas" placeholder="Detalles adicionales..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Producto -->
  <div class="modal-overlay" id="modal-producto">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-producto-titulo">üì¶ A√±adir producto</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-producto">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Descripci√≥n *</label>
            <input type="text" class="form-input" id="producto-descripcion" placeholder="Ej: Aceite de oliva, Vino tinto reserva..." required>
          </div>
          <div class="form-group">
            <label class="form-label">Cantidad</label>
            <input type="text" class="form-input" id="producto-cantidad" placeholder="Ej: 2 botellas, 1kg...">
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-textarea" id="producto-notas" placeholder="Ubicaci√≥n, observaciones..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Tarea -->
  <div class="modal-overlay" id="modal-tarea">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-tarea-titulo">‚úÖ Nueva tarea</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <form id="form-tarea">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Tarea *</label>
            <input type="text" class="form-input" id="tarea-titulo" placeholder="Ej: Revisar caldera, Podar seto..." required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">D√≠a preferente</label>
              <select class="form-select" id="tarea-dia">
                <option value="">Sin preferencia</option>
                <option value="antes">Antes de la llegada</option>
                <option value="durante">Durante la estancia</option>
                <option value="despues">Despu√©s de la salida</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Prioridad</label>
              <select class="form-select" id="tarea-prioridad">
                <option value="normal">Normal</option>
                <option value="alta">‚ö†Ô∏è Alta</option>
                <option value="urgente">üî¥ Urgente</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-textarea" id="tarea-notas" placeholder="Instrucciones adicionales..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Borradores -->
  <div class="modal-overlay" id="modal-borradores">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">üìÅ Borradores guardados</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body">
        <div id="lista-borradores">
          <div class="empty-state">Cargando...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Hist√≥rico -->
  <div class="modal-overlay" id="modal-historico">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">üìã Hist√≥rico (enviados/cerrados)</h3>
        <button class="modal-close" onclick="cerrarModales()">√ó</button>
      </div>
      <div class="modal-body">
        <div id="lista-historico">
          <div class="empty-state">Cargando...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModales()">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let zonasData = [];        // Zonas agrupadas (ubicaciones)
    let dependenciasData = []; // Todas las dependencias (habitaciones)
    let ajuarData = [];        // Cat√°logo de ajuar
    let borradoresData = [];   // Lista de borradores
    let historicoData = [];    // Lista de enviados/cerrados
    let semanaActual = null;
    let productoTipo = 'aportado'; // 'aportado' o 'solicitado'
    let preparacionData = {
      zonas: [],               // IDs de zonas seleccionadas
      zonasDesglose: {},       // {zonaId: [depId, depId...]} desglose por zona
      personas: {              // Se regenera din√°micamente con crearPersonasVacio()
        familiares: {}, desayuno: {}, comida: {}, cena: {}, duermen: {}
      },
      menus: {},               // {pase-dia: {especial: bool, descripcion: ''}}
      servicio: {},            // {pase-dia: [roles]}
      menajeEspecial: false,
      menajeAjuar: [],         // IDs del ajuar seleccionado
      menaje: [],              // {articulo, cantidad, notas} adicionales
      productosAportados: [],  // {descripcion, cantidad, notas}
      productosSolicitados: [], // {descripcion, cantidad, notas}
      tareas: [],              // {titulo, dia, prioridad, notas}
      notas: '',
      estado: 'pendiente'
    };
    let editingIdx = null;
    let editingType = null;

    // Roles de servicio
    const ROLES_SERVICIO = ['Cocinan', 'Sirven', 'Apoyan', 'Refuerzo'];

    // D√≠as activos: por defecto vie/sab/dom, se actualiza desde diasIncluidos del borrador
    let diasActivos = ['vie', 'sab', 'dom'];
    
    const DIAS_NOMBRES = {
      lun: 'Lunes', mar: 'Martes', mie: 'Mi√©rcoles', jue: 'Jueves',
      vie: 'Viernes', sab: 'S√°bado', dom: 'Domingo'
    };
    
    // Orden can√≥nico para ordenar d√≠as
    const DIAS_ORDEN = ['lun', 'mar', 'mie', 'jue', 'vie', 'sab', 'dom'];

    // Genera las 3 matrices HTML din√°micamente seg√∫n diasActivos
    function renderMatricesHTML() {
      const headers = diasActivos.map(d => `<th>${DIAS_NOMBRES[d] || d}</th>`).join('');
      
      // === PERSONAS ===
      const personasFilas = [
        { campo: 'familiares', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', label: 'Familiares' },
        { campo: 'desayuno', icon: 'üç≥', label: 'Desayunan' },
        { campo: 'comida', icon: 'üçΩÔ∏è', label: 'Comen' },
        { campo: 'cena', icon: 'üåô', label: 'Cenan' },
        { campo: 'duermen', icon: 'üõèÔ∏è', label: 'Duermen' }
      ];
      
      document.getElementById('matriz-personas').innerHTML = `
        <div class="matriz">
          <table>
            <thead><tr><th></th>${headers}</tr></thead>
            <tbody>
              ${personasFilas.map(f => `
                <tr>
                  <td>${f.icon} ${f.label}</td>
                  ${diasActivos.map(d => `<td><input type="number" id="personas-${f.campo}-${d}" min="0" value="0"></td>`).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
      
      // === MEN√öS ===
      const menusPases = [
        { pase: 'desayuno', icon: 'üç≥', label: 'Desayuno' },
        { pase: 'aperitivo', icon: 'ü•Ç', label: 'Aperitivo' },
        { pase: 'comida', icon: 'üçΩÔ∏è', label: 'Comida' },
        { pase: 'cena', icon: 'üåô', label: 'Cena' }
      ];
      
      document.getElementById('matriz-menus').innerHTML = `
        <div class="matriz">
          <table>
            <thead><tr><th></th>${headers}</tr></thead>
            <tbody>
              ${menusPases.map(m => `
                <tr>
                  <td>${m.icon} ${m.label}</td>
                  ${diasActivos.map(d => `
                    <td>
                      <div class="slider-toggle">
                        <span class="slider-label">Previsto</span>
                        <input type="checkbox" id="menu-${m.pase}-${d}" onchange="toggleMenuEspecial('${m.pase}','${d}')">
                        <span class="slider-label">Especial</span>
                      </div>
                      <div class="especial-input" id="especial-${m.pase}-${d}">
                        <input type="text" placeholder="¬øCu√°l?">
                      </div>
                    </td>
                  `).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
      
      // === SERVICIO ===
      const servicioPases = [
        { pase: 'desayuno', icon: 'üç≥', label: 'Desayuno' },
        { pase: 'aperitivo', icon: 'ü•Ç', label: 'Aperitivo' },
        { pase: 'comida', icon: 'üçΩÔ∏è', label: 'Comida' },
        { pase: 'cena', icon: 'üåô', label: 'Cena' }
      ];
      
      document.getElementById('matriz-servicio').innerHTML = `
        <div class="matriz">
          <table>
            <thead><tr><th></th>${headers}</tr></thead>
            <tbody>
              ${servicioPases.map(s => `
                <tr>
                  <td>${s.icon} ${s.label}</td>
                  ${diasActivos.map(d => `<td><div class="roles-select" id="servicio-${s.pase}-${d}"></div></td>`).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
      
      // Inicializar chips de servicio
      inicializarServicioChips();
    }

    // Construye el objeto personas vac√≠o seg√∫n diasActivos
    function crearPersonasVacio() {
      const p = {};
      ['familiares', 'desayuno', 'comida', 'cena', 'duermen'].forEach(campo => {
        p[campo] = {};
        diasActivos.forEach(d => { p[campo][d] = 0; });
      });
      return p;
    }

    // Iconos por tipo de zona/dependencia
    const TIPO_ICONS = {
      dormitorio: 'üõèÔ∏è', aseo: 'üöø', salas: 'üõãÔ∏è', funcional: 'üîß', otros: 'üì¶'
    };

    const mesesCortos = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    document.getElementById('btn-volver').href = `bien.html?id=${bienId}`;

    if (!bienId) window.location.href = 'lo-comun.html';

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarDatos();
    });

    async function cargarDatos() {
      try {
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) { alert('Bien no encontrado'); return; }
        bienData = { id: bienDoc.id, ...bienDoc.data() };
        document.getElementById('bien-nombre').textContent = bienData.nombre || 'Sin nombre';

        // Cargar solicitudes disponibles
        await cargarSolicitudes();

        // Cargar dependencias (zonas) del bien
        await cargarZonas();
        
        // Cargar ajuar
        await cargarAjuar();
        
        // Cargar borradores
        await cargarBorradores();
        
        inicializarSemana();
        renderMatricesHTML();
        await cargarPreparacion();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
      } catch (e) {
        console.error(e);
        alert('Error cargando datos');
      }
    }

    // ========== SOLICITUDES DISPONIBLES ==========
    let solicitudesData = [];
    let solicitudActiva = null;

    async function cargarSolicitudes() {
      try {
        const snap = await db.collection('bienes').doc(bienId)
          .collection('reservas')
          .where('origen', '==', 'solicitud')
          .get();
        
        solicitudesData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        solicitudesData.sort((a, b) => {
          const fa = a.fechaCreacion?.toDate?.() || new Date(0);
          const fb = b.fechaCreacion?.toDate?.() || new Date(0);
          return fb - fa;
        });
        renderSolicitudes();
      } catch (e) {
        console.error('Error cargando solicitudes:', e);
        solicitudesData = [];
        renderSolicitudes();
      }
    }

    function renderSolicitudes() {
      const container = document.getElementById('solicitudes-body');
      document.getElementById('solicitudes-count').textContent = solicitudesData.length;
      
      if (solicitudesData.length === 0) {
        container.innerHTML = '<div class="solicitudes-empty">No hay solicitudes disponibles</div>';
        return;
      }
      
      container.innerHTML = solicitudesData.map(s => {
        const nombre = s.nombre || s.tipoReservaNombre || 'Solicitud';
        const fechas = s.fechaInicio && s.fechaFin ? `${fmtFecha(s.fechaInicio)} ‚Üí ${fmtFecha(s.fechaFin)}` : 'Sin fechas';
        const solicitante = s.solicitadoPorNombre || 'Usuario';
        const estadoClass = s.estado === 'aprobada' ? 'aprobada' : 'pendiente';
        const estadoLabel = s.estado === 'aprobada' ? 'Aprobada' : s.estado === 'rechazada' ? 'Rechazada' : 'Pendiente';
        const isActive = solicitudActiva?.id === s.id;
        
        return `<div class="solicitud-card ${isActive ? 'active' : ''}" onclick="seleccionarSolicitud('${s.id}')">
          <div class="solicitud-info">
            <div class="solicitud-nombre">üìã ${nombre}</div>
            <div class="solicitud-meta">üìÖ ${fechas} ¬∑ üë§ ${solicitante}</div>
          </div>
          <span class="solicitud-estado ${estadoClass}">${estadoLabel}</span>
        </div>`;
      }).join('');
    }

    function fmtFecha(f) {
      if (!f) return '‚Äî';
      const d = typeof f === 'string' ? new Date(f) : f.toDate?.() || new Date(f);
      return `${d.getDate()}/${d.getMonth()+1}`;
    }

    async function seleccionarSolicitud(id) {
      solicitudActiva = solicitudesData.find(s => s.id === id);
      if (!solicitudActiva) return;
      renderSolicitudes();
      
      // Cargar preparaci√≥n de la solicitud si existe
      if (solicitudActiva.preparacion) {
        const p = solicitudActiva.preparacion;
        preparacionData.menaje = p.menaje || [];
        preparacionData.productosAportados = p.productosAportados || p.productos || [];
        preparacionData.productosSolicitados = p.productosSolicitados || [];
        preparacionData.tareas = p.tareas || [];
        preparacionData.notas = p.notas || '';
      }
      
      // Si tiene fechas, calcular d√≠as
      if (solicitudActiva.fechaInicio && solicitudActiva.fechaFin) {
        const inicio = typeof solicitudActiva.fechaInicio === 'string' ? new Date(solicitudActiva.fechaInicio) : solicitudActiva.fechaInicio.toDate?.() || new Date(solicitudActiva.fechaInicio);
        const fin = typeof solicitudActiva.fechaFin === 'string' ? new Date(solicitudActiva.fechaFin) : solicitudActiva.fechaFin.toDate?.() || new Date(solicitudActiva.fechaFin);
        const diasNombres = ['dom', 'lun', 'mar', 'mie', 'jue', 'vie', 'sab'];
        const diasReserva = [];
        for (let d = new Date(inicio); d <= fin; d.setDate(d.getDate() + 1)) {
          diasReserva.push(diasNombres[d.getDay()]);
        }
        if (diasReserva.length > 0) {
          diasActivos = DIAS_ORDEN.filter(d => diasReserva.includes(d));
          if (diasActivos.length === 0) diasActivos = DIAS_ORDEN.slice();
          renderMatricesHTML();
        }
      }
      
      if (!preparacionData.notas && solicitudActiva.motivo) {
        preparacionData.notas = `üìã ${solicitudActiva.nombre || 'Solicitud'}: ${solicitudActiva.motivo}`;
      }
      
      renderAll();
      document.querySelector('.seccion').scrollIntoView({ behavior: 'smooth' });
    }

    async function cargarBorradores() {
      try {
        // Cargar todos y filtrar en cliente (evita problemas de √≠ndice)
        const snap = await db.collection('bienes').doc(bienId)
          .collection('preparacionSemanal')
          .orderBy('fechaActualizacion', 'desc')
          .limit(50)
          .get();
        
        const todos = snap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Separar borradores e hist√≥rico
        borradoresData = todos.filter(d => d.estado === 'borrador' || !d.estado);
        historicoData = todos.filter(d => d.estado === 'enviado' || d.estado === 'cerrado');
        
        document.getElementById('count-borradores').textContent = borradoresData.length;
        document.getElementById('count-historico').textContent = historicoData.length;
      } catch (e) {
        console.error('Error cargando borradores:', e);
        borradoresData = [];
        historicoData = [];
      }
    }

    async function cargarZonas() {
      // Cargar desde colecci√≥n habitaciones (que ahora son zonas/dependencias)
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('habitaciones').get();
        if (!snap.empty) {
          dependenciasData = snap.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          // Agrupar por zona/ubicaci√≥n
          const zonasMap = {};
          dependenciasData.forEach(dep => {
            const ubicacion = dep.zona || 'Sin asignar';
            if (!zonasMap[ubicacion]) {
              zonasMap[ubicacion] = {
                id: ubicacion.replace(/\s+/g, '_').toLowerCase(),
                nombre: ubicacion,
                dependencias: []
              };
            }
            zonasMap[ubicacion].dependencias.push(dep);
          });
          zonasData = Object.values(zonasMap);
        } else {
          zonasData = [];
          dependenciasData = [];
        }
      } catch (e) {
        console.error('Error cargando zonas:', e);
        zonasData = [];
        dependenciasData = [];
      }
    }

    async function cargarAjuar() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('ajuar').get();
        ajuarData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (e) {
        console.error('Error cargando ajuar:', e);
        ajuarData = [];
      }
    }

    function inicializarServicioChips() {
      const pases = ['desayuno', 'aperitivo', 'comida', 'cena'];
      
      pases.forEach(pase => {
        diasActivos.forEach(dia => {
          const container = document.getElementById(`servicio-${pase}-${dia}`);
          if (container) {
            container.innerHTML = ROLES_SERVICIO.map(rol => 
              `<span class="role-chip" data-rol="${rol}" onclick="toggleRol('${pase}','${dia}','${rol}')">${rol}</span>`
            ).join('');
          }
        });
      });
    }

    function inicializarSemana() {
      const hoy = new Date();
      const diaHoy = hoy.getDay();
      const lunes = new Date(hoy);
      const diff = diaHoy === 0 ? -6 : 1 - diaHoy;
      lunes.setDate(hoy.getDate() + diff);
      lunes.setHours(0, 0, 0, 0);
      semanaActual = lunes;
      actualizarVisualizacionSemana();
    }

    function actualizarVisualizacionSemana() {
      const domingo = new Date(semanaActual);
      domingo.setDate(domingo.getDate() + 6);
      
      const numSemana = getNumeroSemana(semanaActual);
      document.getElementById('semana-titulo').textContent = `Semana ${numSemana}`;
      document.getElementById('semana-fechas').textContent = 
        `Lun ${semanaActual.getDate()} ${mesesCortos[semanaActual.getMonth()]} ‚Üí Dom ${domingo.getDate()} ${mesesCortos[domingo.getMonth()]}`;
      
      actualizarEstado();
    }

    function getNumeroSemana(fecha) {
      const inicio = new Date(fecha.getFullYear(), 0, 1);
      const dias = Math.floor((fecha - inicio) / (24 * 60 * 60 * 1000));
      return Math.ceil((fecha.getDay() + 1 + dias) / 7);
    }

    function getSemanaKey() {
      return `${semanaActual.getFullYear()}-W${String(getNumeroSemana(semanaActual)).padStart(2, '0')}`;
    }

    async function cargarPreparacion() {
      const semanaKey = getSemanaKey();
      try {
        const doc = await db.collection('bienes').doc(bienId)
          .collection('preparacionSemanal').doc(semanaKey).get();
        
        if (doc.exists) {
          const data = doc.data();
          
          // Detectar d√≠as incluidos: desde el campo diasIncluidos o inferir de las claves de personas
          if (data.diasIncluidos && data.diasIncluidos.length > 0) {
            diasActivos = DIAS_ORDEN.filter(d => data.diasIncluidos.includes(d));
          } else {
            // Retrocompatibilidad: inferir de las claves existentes en personas
            const clavesPersonas = Object.keys(data.personas?.familiares || {});
            if (clavesPersonas.length > 0) {
              diasActivos = DIAS_ORDEN.filter(d => clavesPersonas.includes(d));
            } else {
              diasActivos = ['vie', 'sab', 'dom'];
            }
          }
          
          // Regenerar matrices con los d√≠as correctos
          renderMatricesHTML();
          
          preparacionData = {
            zonas: data.zonas || [],
            zonasDesglose: data.zonasDesglose || {},
            personas: data.personas || crearPersonasVacio(),
            menus: data.menus || {},
            servicio: data.servicio || {},
            menajeEspecial: data.menajeEspecial || false,
            menajeAjuar: data.menajeAjuar || [],
            menaje: data.menaje || [],
            productosAportados: data.productosAportados || data.productos || [],
            productosSolicitados: data.productosSolicitados || [],
            tareas: data.tareas || [],
            notas: data.notas || '',
            estado: data.estado || 'pendiente'
          };
        } else {
          // Sin datos para esta semana: resetear a d√≠as por defecto
          diasActivos = ['vie', 'sab', 'dom'];
          renderMatricesHTML();
          
          preparacionData = {
            zonas: [],
            zonasDesglose: {},
            personas: crearPersonasVacio(),
            menus: {},
            servicio: {},
            menajeEspecial: false,
            menajeAjuar: [],
            menaje: [],
            productosAportados: [],
            productosSolicitados: [],
            tareas: [],
            notas: '',
            estado: 'pendiente'
          };
        }
      } catch (e) {
        console.error('Error cargando preparaci√≥n:', e);
      }

      // Buscar reservas aprobadas para esta semana (crear borrador si no existe)
      await verificarReservasAprobadas();

      renderAll();
    }

    // Buscar reservas/eventos aprobados para la semana actual y crear borrador si corresponde
    async function verificarReservasAprobadas() {
      console.log('üîç verificarReservasAprobadas() iniciado');
      console.log('üîç bienId:', bienId);
      console.log('üîç currentUser.uid:', currentUser?.uid);
      
      try {
        const lunesSemana = new Date(semanaActual);
        const domingoSemana = new Date(semanaActual);
        domingoSemana.setDate(domingoSemana.getDate() + 6);
        domingoSemana.setHours(23, 59, 59, 999);
        
        console.log('üîç Buscando en semana:', lunesSemana.toISOString(), '-', domingoSemana.toISOString());

        // Buscar reservas aprobadas
        let reservasSemana = [];
        try {
          console.log('üîç Buscando reservas con estado=aprobada...');
          const reservasSnap = await db.collection('bienes').doc(bienId)
            .collection('reservas')
            .where('estado', '==', 'aprobada')
            .get();
          
          console.log('üîç Reservas encontradas:', reservasSnap.size);

          if (!reservasSnap.empty) {
            const todasReservas = reservasSnap.docs.map(doc => ({
              id: doc.id,
              tipo: 'reserva',
              ...doc.data()
            }));
            console.log('üîç Todas las reservas aprobadas:', todasReservas);
            
            reservasSemana = todasReservas.filter(r => {
              const inicio = r.fechaInicio?.toDate?.() || new Date(r.fechaInicio);
              const fin = r.fechaFin?.toDate?.() || new Date(r.fechaFin);
              const enSemana = inicio <= domingoSemana && fin >= lunesSemana;
              console.log('üîç Reserva', r.id, ':', inicio, '-', fin, 'enSemana:', enSemana);
              return enSemana;
            });
          }
        } catch (e) { 
          console.log('üîç Error/Sin colecci√≥n reservas:', e.message); 
        }

        // Buscar eventos aprobados
        try {
          console.log('üîç Buscando eventos con estado=aprobado...');
          const eventosSnap = await db.collection('bienes').doc(bienId)
            .collection('eventos')
            .where('estado', '==', 'aprobado')
            .get();
          
          console.log('üîç Eventos encontrados:', eventosSnap.size);

          if (!eventosSnap.empty) {
            const todosEventos = eventosSnap.docs.map(doc => ({
              id: doc.id,
              tipo: 'evento',
              ...doc.data()
            }));
            console.log('üîç Todos los eventos aprobados:', todosEventos);
            
            const eventosSemana = todosEventos.filter(e => {
              const fecha = e.fecha?.toDate?.() || new Date(e.fecha);
              const enSemana = fecha >= lunesSemana && fecha <= domingoSemana;
              console.log('üîç Evento', e.id, ':', fecha, 'enSemana:', enSemana);
              return enSemana;
            });
            reservasSemana = reservasSemana.concat(eventosSemana);
          }
        } catch (e) { 
          console.log('üîç Error/Sin colecci√≥n eventos:', e.message); 
        }

        console.log('üîç Total reservas/eventos en semana:', reservasSemana.length);
        if (reservasSemana.length === 0) {
          console.log('üîç No hay reservas/eventos para esta semana');
          return;
        }

        // Buscar si el usuario actual es solicitante de alguna reserva
        console.log('üîç Buscando reservas del usuario actual...');
        reservasSemana.forEach(r => {
          console.log('üîç Reserva', r.id, '- solicitante:', r.solicitante, 'solicitanteUid:', r.solicitanteUid, 'creadoPor:', r.creadoPor);
        });
        
        const miReserva = reservasSemana.find(r => 
          r.solicitante === currentUser.uid || 
          r.solicitanteUid === currentUser.uid ||
          r.creadoPor === currentUser.uid
        );

        if (!miReserva) {
          console.log('üîç Usuario no es solicitante de ninguna reserva');
          return;
        }
        
        console.log('üîç Mi reserva encontrada:', miReserva);

        // Si ya tiene borrador con contenido, no sobrescribir
        if (tieneContenido()) {
          console.log('üîç Ya hay contenido, no sobrescribir');
          return;
        }

        // Calcular d√≠as de la reserva/evento que caen en esta semana
        let inicio, fin;
        if (miReserva.tipo === 'evento') {
          // Evento: un solo d√≠a
          const fecha = miReserva.fecha?.toDate?.() || new Date(miReserva.fecha);
          inicio = fecha;
          fin = fecha;
        } else {
          // Reserva: rango de fechas
          inicio = miReserva.fechaInicio?.toDate?.() || new Date(miReserva.fechaInicio);
          fin = miReserva.fechaFin?.toDate?.() || new Date(miReserva.fechaFin);
        }
        
        const diasReserva = [];
        const diasNombres = ['dom', 'lun', 'mar', 'mie', 'jue', 'vie', 'sab'];
        
        for (let d = new Date(Math.max(inicio.getTime(), lunesSemana.getTime())); 
             d <= Math.min(fin.getTime(), domingoSemana.getTime()); 
             d.setDate(d.getDate() + 1)) {
          diasReserva.push(diasNombres[d.getDay()]);
        }

        // Actualizar d√≠as activos con los de la reserva
        if (diasReserva.length > 0) {
          diasActivos = DIAS_ORDEN.filter(d => diasReserva.includes(d));
          renderMatricesHTML();
        }

        // Pre-poblar datos de personas si la reserva tiene info
        if (miReserva.numPersonas || miReserva.personas) {
          const numPersonas = miReserva.numPersonas || miReserva.personas || 0;
          diasActivos.forEach(dia => {
            preparacionData.personas.familiares[dia] = numPersonas;
            preparacionData.personas.duermen[dia] = numPersonas;
          });
        }

        // A√±adir nota con info de la reserva/evento
        const tipoLabel = miReserva.tipo === 'evento' ? 'üéâ Evento' : 'üìÖ Reserva';
        if (miReserva.motivo || miReserva.notas || miReserva.titulo || miReserva.nombre) {
          preparacionData.notas = `${tipoLabel}: ${miReserva.titulo || miReserva.nombre || miReserva.motivo || miReserva.notas || ''}`;
        }

        // Marcar como borrador desde reserva
        preparacionData.reservaOrigen = miReserva.id;

        // Guardar el borrador inicial autom√°ticamente
        await guardarBorrador(true);
        
        console.log('Borrador creado desde reserva aprobada:', miReserva.id);
      } catch (e) {
        console.error('Error verificando reservas:', e);
      }
    }

    function renderAll() {
      renderZonas();
      renderPersonas();
      renderMenus();
      renderServicio();
      renderMenaje();
      renderProductos();
      renderTareas();
      renderNotas();
      actualizarEstado();
    }

    // ========== ZONAS ==========
    function renderZonas() {
      const container = document.getElementById('zonas-container');
      const count = preparacionData.zonas.length;
      document.getElementById('count-zonas').textContent = count;

      if (zonasData.length === 0) {
        container.innerHTML = `
          <div class="habitacion-empty">
            No hay zonas configuradas.<br>
            <a href="zonas.html?id=${bienId}" style="color:var(--mayordomo);">Configura las zonas</a>
          </div>`;
        return;
      }

      container.innerHTML = zonasData.map(z => {
        const selected = preparacionData.zonas.includes(z.id);
        const desglose = preparacionData.zonasDesglose[z.id] || [];
        const showDeps = desglose.length > 0 || selected;
        
        return `
          <div class="zona-group">
            <div class="zona-header" onclick="toggleZona('${z.id}')">
              <input type="checkbox" ${selected ? 'checked' : ''} onclick="event.stopPropagation()">
              <span class="zona-header-label">üè† ${z.nombre}</span>
              <span class="zona-count">${z.dependencias.length} deps</span>
              ${selected ? `<span class="zona-toggle-deps" onclick="event.stopPropagation(); toggleDesglose('${z.id}')">Desglosar</span>` : ''}
            </div>
            <div class="zona-deps ${showDeps && selected ? 'visible' : ''}" id="deps-${z.id}">
              ${z.dependencias.map(dep => {
                const depSelected = desglose.includes(dep.id);
                const tipoIcon = TIPO_ICONS[dep.tipo] || 'üì¶';
                return `
                  <div class="dep-item">
                    <input type="checkbox" ${depSelected ? 'checked' : ''} onchange="toggleDependencia('${z.id}', '${dep.id}')">
                    <span class="dep-item-label">${dep.nombre || dep.numero}</span>
                    <span class="dep-item-tipo">${tipoIcon} ${dep.tipo || ''}</span>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleZona(id) {
      const idx = preparacionData.zonas.indexOf(id);
      if (idx >= 0) {
        preparacionData.zonas.splice(idx, 1);
        delete preparacionData.zonasDesglose[id];
      } else {
        preparacionData.zonas.push(id);
        // Preguntar si quiere desglose
        if (confirm('¬øQuieres desglosar las dependencias de esta zona una a una?')) {
          const zona = zonasData.find(z => z.id === id);
          if (zona) {
            preparacionData.zonasDesglose[id] = zona.dependencias.map(d => d.id);
          }
        }
      }
      renderZonas();
      actualizarEstado();
    }

    function toggleDesglose(zonaId) {
      const deps = document.getElementById(`deps-${zonaId}`);
      deps.classList.toggle('visible');
    }

    function toggleDependencia(zonaId, depId) {
      if (!preparacionData.zonasDesglose[zonaId]) {
        preparacionData.zonasDesglose[zonaId] = [];
      }
      const arr = preparacionData.zonasDesglose[zonaId];
      const idx = arr.indexOf(depId);
      if (idx >= 0) {
        arr.splice(idx, 1);
      } else {
        arr.push(depId);
      }
    }

    // ========== PERSONAS ==========
    function renderPersonas() {
      const p = preparacionData.personas;
      const campos = ['familiares', 'desayuno', 'comida', 'cena', 'duermen'];
      
      campos.forEach(campo => {
        diasActivos.forEach(dia => {
          const input = document.getElementById(`personas-${campo}-${dia}`);
          if (input) input.value = p[campo]?.[dia] || 0;
        });
      });

      // A√±adir listeners
      campos.forEach(campo => {
        diasActivos.forEach(dia => {
          const input = document.getElementById(`personas-${campo}-${dia}`);
          if (input) {
            input.onchange = () => {
              if (!preparacionData.personas[campo]) preparacionData.personas[campo] = {};
              preparacionData.personas[campo][dia] = parseInt(input.value) || 0;
            };
          }
        });
      });
    }

    // ========== MEN√öS ==========
    function renderMenus() {
      const pases = ['desayuno', 'aperitivo', 'comida', 'cena'];
      
      pases.forEach(pase => {
        diasActivos.forEach(dia => {
          const key = `${pase}-${dia}`;
          const menuData = preparacionData.menus[key] || { especial: false, descripcion: '' };
          
          const checkbox = document.getElementById(`menu-${pase}-${dia}`);
          const especial = document.getElementById(`especial-${pase}-${dia}`);
          
          if (checkbox) {
            checkbox.checked = menuData.especial;
            if (especial) {
              especial.classList.toggle('visible', menuData.especial);
              const input = especial.querySelector('input');
              if (input) input.value = menuData.descripcion || '';
            }
          }
        });
      });
    }

    function toggleMenuEspecial(pase, dia) {
      const key = `${pase}-${dia}`;
      const checkbox = document.getElementById(`menu-${pase}-${dia}`);
      const especial = document.getElementById(`especial-${pase}-${dia}`);
      
      if (!preparacionData.menus[key]) {
        preparacionData.menus[key] = { especial: false, descripcion: '' };
      }
      preparacionData.menus[key].especial = checkbox.checked;
      especial.classList.toggle('visible', checkbox.checked);
      
      // Listener para descripci√≥n
      const input = especial.querySelector('input');
      if (input) {
        input.onchange = () => {
          preparacionData.menus[key].descripcion = input.value;
        };
      }
    }

    // ========== SERVICIO ==========
    function renderServicio() {
      const pases = ['desayuno', 'aperitivo', 'comida', 'cena'];
      
      pases.forEach(pase => {
        diasActivos.forEach(dia => {
          const key = `${pase}-${dia}`;
          const roles = preparacionData.servicio[key] || [];
          const container = document.getElementById(`servicio-${pase}-${dia}`);
          
          if (container) {
            container.querySelectorAll('.role-chip').forEach(chip => {
              const rol = chip.dataset.rol;
              chip.classList.toggle('selected', roles.includes(rol));
            });
          }
        });
      });
    }

    async function toggleRol(pase, dia, rol) {
      const key = `${pase}-${dia}`;
      if (!preparacionData.servicio[key]) {
        preparacionData.servicio[key] = [];
      }
      const arr = preparacionData.servicio[key];
      const idx = arr.indexOf(rol);
      if (idx >= 0) {
        arr.splice(idx, 1);
      } else {
        arr.push(rol);
      }
      renderServicio();
      await guardarBorrador(true);
    }

    // ========== MENAJE ==========
    function renderMenaje() {
      const container = document.getElementById('lista-menaje');
      const ajuarGrid = document.getElementById('ajuar-grid');
      const totalMenaje = preparacionData.menaje.length + preparacionData.menajeAjuar.length;
      document.getElementById('count-menaje').textContent = totalMenaje;

      // Slider
      document.getElementById('menaje-especial').checked = preparacionData.menajeEspecial;
      document.getElementById('ajuar-selector').classList.toggle('visible', preparacionData.menajeEspecial);
      document.getElementById('label-habitual').classList.toggle('active', !preparacionData.menajeEspecial);
      document.getElementById('label-especial').classList.toggle('active', preparacionData.menajeEspecial);

      // Renderizar ajuar
      if (ajuarGrid && ajuarData.length > 0) {
        ajuarGrid.innerHTML = ajuarData.map(item => {
          const selected = preparacionData.menajeAjuar.includes(item.id);
          return `
            <label class="ajuar-item ${selected ? 'selected' : ''}" onclick="toggleAjuar('${item.id}')">
              <input type="checkbox" ${selected ? 'checked' : ''}>
              <span>${item.nombre || item.articulo || 'Sin nombre'}</span>
            </label>
          `;
        }).join('');
      } else if (ajuarGrid) {
        ajuarGrid.innerHTML = '<div class="empty-state">Sin art√≠culos en el ajuar</div>';
      }

      // Lista menaje adicional
      if (preparacionData.menaje.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = preparacionData.menaje.map((m, idx) => `
        <div class="item-card">
          <span class="item-icon">üç∑</span>
          <div class="item-content">
            <div class="item-titulo">${m.articulo}</div>
            <div class="item-meta">Cantidad: ${m.cantidad || 1}</div>
            ${m.notas ? `<div class="item-descripcion">${m.notas}</div>` : ''}
          </div>
          <div class="item-actions">
            <button class="item-btn" onclick="editarMenaje(${idx})">‚úèÔ∏è</button>
            <button class="item-btn delete" onclick="eliminarMenaje(${idx})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    async function toggleMenajeEspecial() {
      preparacionData.menajeEspecial = document.getElementById('menaje-especial').checked;
      renderMenaje();
      await guardarBorrador(true);
    }

    async function toggleAjuar(id) {
      const idx = preparacionData.menajeAjuar.indexOf(id);
      if (idx >= 0) {
        preparacionData.menajeAjuar.splice(idx, 1);
      } else {
        preparacionData.menajeAjuar.push(id);
      }
      renderMenaje();
      await guardarBorrador(true);
    }

    // ========== PRODUCTOS ==========
    function renderProductos() {
      const aportados = preparacionData.productosAportados || [];
      const solicitados = preparacionData.productosSolicitados || [];
      const totalProductos = aportados.length + solicitados.length;
      
      document.getElementById('count-producto').textContent = totalProductos;
      document.getElementById('count-aportado').textContent = aportados.length;
      document.getElementById('count-solicitado').textContent = solicitados.length;

      // Renderizar aportados
      const containerAportado = document.getElementById('lista-producto-aportado');
      if (aportados.length === 0) {
        containerAportado.innerHTML = '<div class="empty-state">Sin productos aportados</div>';
      } else {
        containerAportado.innerHTML = aportados.map((p, idx) => `
          <div class="item-card">
            <span class="item-icon">üè†</span>
            <div class="item-content">
              <div class="item-titulo">${p.descripcion}</div>
              ${p.cantidad ? `<div class="item-meta">Cantidad: ${p.cantidad}</div>` : ''}
              ${p.notas ? `<div class="item-descripcion">${p.notas}</div>` : ''}
            </div>
            <div class="item-actions">
              <button class="item-btn" onclick="editarProducto('aportado', ${idx})">‚úèÔ∏è</button>
              <button class="item-btn delete" onclick="eliminarProducto('aportado', ${idx})">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');
      }

      // Renderizar solicitados
      const containerSolicitado = document.getElementById('lista-producto-solicitado');
      if (solicitados.length === 0) {
        containerSolicitado.innerHTML = '<div class="empty-state">Sin productos solicitados</div>';
      } else {
        containerSolicitado.innerHTML = solicitados.map((p, idx) => `
          <div class="item-card compra">
            <span class="item-icon">üõí</span>
            <div class="item-content">
              <div class="item-titulo">${p.descripcion}</div>
              ${p.cantidad ? `<div class="item-meta">Cantidad: ${p.cantidad}</div>` : ''}
              ${p.notas ? `<div class="item-descripcion">${p.notas}</div>` : ''}
            </div>
            <div class="item-actions">
              <button class="item-btn" onclick="editarProducto('solicitado', ${idx})">‚úèÔ∏è</button>
              <button class="item-btn delete" onclick="eliminarProducto('solicitado', ${idx})">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');
      }
    }

    function abrirModalMenaje(idx = null) {
      editingIdx = idx;
      editingType = 'menaje';
      const m = idx !== null ? preparacionData.menaje[idx] : null;
      
      document.getElementById('modal-menaje-titulo').textContent = m ? '‚úèÔ∏è Editar menaje' : 'üç∑ A√±adir menaje';
      document.getElementById('menaje-articulo').value = m?.articulo || '';
      document.getElementById('menaje-cantidad').value = m?.cantidad || 1;
      document.getElementById('menaje-notas').value = m?.notas || '';
      
      document.getElementById('modal-menaje').classList.add('active');
    }

    function editarMenaje(idx) { abrirModalMenaje(idx); }

    async function eliminarMenaje(idx) {
      if (!confirm('¬øEliminar este menaje?')) return;
      preparacionData.menaje.splice(idx, 1);
      renderMenaje();
      actualizarEstado();
      await guardarBorrador(true);
    }

    console.log('üîß Registrando listener form-menaje...');
    const formMenaje = document.getElementById('form-menaje');
    console.log('üîß form-menaje encontrado:', formMenaje);
    
    if (formMenaje) {
      formMenaje.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('üìù Form menaje submit iniciado');
      
      const data = {
        articulo: document.getElementById('menaje-articulo').value,
        cantidad: parseInt(document.getElementById('menaje-cantidad').value) || 1,
        notas: document.getElementById('menaje-notas').value
      };
      console.log('üìù Datos menaje:', data);

      if (editingIdx !== null) {
        preparacionData.menaje[editingIdx] = data;
      } else {
        preparacionData.menaje.push(data);
      }
      console.log('üìù preparacionData.menaje:', preparacionData.menaje);

      cerrarModales();
      renderMenaje();
      actualizarEstado();
      
      try {
        console.log('üìù Llamando guardarBorrador...');
        await guardarBorrador(true);
        console.log('‚úÖ Borrador guardado OK');
      } catch (err) {
        console.error('‚ùå Error guardando borrador:', err);
        alert('Error guardando: ' + err.message);
      }
    });
    } else {
      console.error('‚ùå form-menaje NO encontrado!');
    }

    // ========== FUNCIONES PRODUCTOS ==========
    function abrirModalProducto(tipo, idx = null) {
      productoTipo = tipo;
      editingIdx = idx;
      editingType = 'producto';
      
      const lista = tipo === 'aportado' ? preparacionData.productosAportados : preparacionData.productosSolicitados;
      const p = idx !== null ? lista[idx] : null;
      const icono = tipo === 'aportado' ? 'üè†' : 'üõí';
      const label = tipo === 'aportado' ? 'aportado' : 'solicitado';
      
      document.getElementById('modal-producto-titulo').textContent = p ? `‚úèÔ∏è Editar producto ${label}` : `${icono} A√±adir producto ${label}`;
      document.getElementById('producto-descripcion').value = p?.descripcion || '';
      document.getElementById('producto-cantidad').value = p?.cantidad || '';
      document.getElementById('producto-notas').value = p?.notas || '';
      
      document.getElementById('modal-producto').classList.add('active');
    }

    function editarProducto(tipo, idx) { abrirModalProducto(tipo, idx); }

    async function eliminarProducto(tipo, idx) {
      if (!confirm('¬øEliminar este producto?')) return;
      if (tipo === 'aportado') {
        preparacionData.productosAportados.splice(idx, 1);
      } else {
        preparacionData.productosSolicitados.splice(idx, 1);
      }
      renderProductos();
      actualizarEstado();
      await guardarBorrador(true);
    }

    console.log('üîß Registrando listener form-producto...');
    const formProducto = document.getElementById('form-producto');
    console.log('üîß form-producto encontrado:', formProducto);
    
    if (formProducto) {
      formProducto.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        descripcion: document.getElementById('producto-descripcion').value,
        cantidad: document.getElementById('producto-cantidad').value,
        notas: document.getElementById('producto-notas').value
      };

      const lista = productoTipo === 'aportado' ? preparacionData.productosAportados : preparacionData.productosSolicitados;
      
      if (editingIdx !== null) {
        lista[editingIdx] = data;
      } else {
        lista.push(data);
      }

      cerrarModales();
      renderProductos();
      actualizarEstado();
      await guardarBorrador(true); // Auto-guardar
    });
    } else {
      console.error('‚ùå form-producto NO encontrado!');
    }

    // ========== BORRADORES ==========
    function abrirModalBorradores() {
      renderBorradores();
      document.getElementById('modal-borradores').classList.add('active');
    }

    function renderBorradores() {
      const container = document.getElementById('lista-borradores');
      
      if (borradoresData.length === 0) {
        container.innerHTML = '<div class="empty-state">No hay borradores guardados</div>';
        return;
      }

      container.innerHTML = borradoresData.map(b => {
        const fecha = b.fechaActualizacion?.toDate?.() || new Date();
        const fechaStr = `${fecha.getDate()} ${mesesCortos[fecha.getMonth()]} ${fecha.getFullYear()}`;
        const zonasCant = b.zonas?.length || 0;
        const tareasCant = b.tareas?.length || 0;
        const isCurrentWeek = b.id === getSemanaKey();
        
        return `
          <div class="item-card ${isCurrentWeek ? 'selected' : ''}" style="cursor:pointer;" onclick="cargarBorrador('${b.id}')">
            <span class="item-icon">üìã</span>
            <div class="item-content">
              <div class="item-titulo">${b.id} ${isCurrentWeek ? '(actual)' : ''}</div>
              <div class="item-meta">${fechaStr} ¬∑ ${zonasCant} zonas ¬∑ ${tareasCant} tareas</div>
            </div>
            <div class="item-actions">
              <button class="item-btn delete" onclick="event.stopPropagation(); eliminarBorrador('${b.id}')">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function cargarBorrador(semanaKey) {
      // Parsear semanaKey para obtener fecha
      const match = semanaKey.match(/(\d{4})-W(\d{2})/);
      if (match) {
        const year = parseInt(match[1]);
        const week = parseInt(match[2]);
        // Calcular fecha del lunes de esa semana
        const simple = new Date(year, 0, 1 + (week - 1) * 7);
        const dow = simple.getDay();
        const ISOweekStart = simple;
        if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
        else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
        semanaActual = ISOweekStart;
        actualizarVisualizacionSemana();
      }
      
      cerrarModales();
      await cargarPreparacion();
    }

    async function eliminarBorrador(semanaKey) {
      if (!confirm('¬øEliminar este borrador?')) return;
      
      try {
        await db.collection('bienes').doc(bienId)
          .collection('preparacionSemanal').doc(semanaKey).delete();
        
        borradoresData = borradoresData.filter(b => b.id !== semanaKey);
        document.getElementById('count-borradores').textContent = borradoresData.length;
        renderBorradores();
        
        // Si eliminamos el actual, recargar
        if (semanaKey === getSemanaKey()) {
          await cargarPreparacion();
        }
      } catch (e) {
        console.error(e);
        alert('Error al eliminar');
      }
    }

    // ========== HIST√ìRICO ==========
    function abrirModalHistorico() {
      renderHistorico();
      document.getElementById('modal-historico').classList.add('active');
    }

    function renderHistorico() {
      const container = document.getElementById('lista-historico');
      
      if (historicoData.length === 0) {
        container.innerHTML = '<div class="empty-state">No hay preparaciones enviadas o cerradas</div>';
        return;
      }

      container.innerHTML = historicoData.map(h => {
        const fecha = h.fechaEnvio?.toDate?.() || h.fechaActualizacion?.toDate?.() || new Date();
        const fechaStr = `${fecha.getDate()} ${mesesCortos[fecha.getMonth()]} ${fecha.getFullYear()}`;
        const zonasCant = h.zonas?.length || 0;
        const tareasCant = h.tareas?.length || 0;
        const estadoIcon = h.estado === 'enviado' ? 'üì§' : '‚úÖ';
        const estadoLabel = h.estado === 'enviado' ? 'Enviado' : 'Cerrado';
        
        return `
          <div class="item-card" style="cursor:pointer;border-left-color:var(--sage);" onclick="cargarBorrador('${h.id}')">
            <span class="item-icon">${estadoIcon}</span>
            <div class="item-content">
              <div class="item-titulo">${h.id}</div>
              <div class="item-meta">${fechaStr} ¬∑ ${estadoLabel} ¬∑ ${zonasCant} zonas ¬∑ ${tareasCant} tareas</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========== TAREAS ==========
    function renderTareas() {
      const container = document.getElementById('lista-tareas');
      document.getElementById('count-tareas').textContent = preparacionData.tareas.length;

      if (preparacionData.tareas.length === 0) {
        container.innerHTML = '<div class="empty-state">Sin tareas adicionales</div>';
        return;
      }

      const diaLabels = { antes: 'Antes de llegada', durante: 'Durante estancia', despues: 'Despu√©s de salida' };

      container.innerHTML = preparacionData.tareas.map((t, idx) => {
        const prioIcon = t.prioridad === 'urgente' ? 'üî¥ ' : t.prioridad === 'alta' ? '‚ö†Ô∏è ' : '';
        return `
          <div class="item-card tarea">
            <span class="item-icon">‚úÖ</span>
            <div class="item-content">
              <div class="item-titulo">${prioIcon}${t.titulo}</div>
              <div class="item-meta">${t.dia ? diaLabels[t.dia] || t.dia : 'Sin preferencia'}</div>
              ${t.notas ? `<div class="item-descripcion">${t.notas}</div>` : ''}
            </div>
            <div class="item-actions">
              <button class="item-btn" onclick="editarTarea(${idx})">‚úèÔ∏è</button>
              <button class="item-btn delete" onclick="eliminarTarea(${idx})">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function abrirModalTarea(idx = null) {
      editingIdx = idx;
      editingType = 'tarea';
      const t = idx !== null ? preparacionData.tareas[idx] : null;
      
      document.getElementById('modal-tarea-titulo').textContent = t ? '‚úèÔ∏è Editar tarea' : '‚úÖ Nueva tarea';
      document.getElementById('tarea-titulo').value = t?.titulo || '';
      document.getElementById('tarea-dia').value = t?.dia || '';
      document.getElementById('tarea-prioridad').value = t?.prioridad || 'normal';
      document.getElementById('tarea-notas').value = t?.notas || '';
      
      document.getElementById('modal-tarea').classList.add('active');
    }

    function editarTarea(idx) { abrirModalTarea(idx); }

    async function eliminarTarea(idx) {
      if (!confirm('¬øEliminar esta tarea?')) return;
      preparacionData.tareas.splice(idx, 1);
      renderTareas();
      actualizarEstado();
      await guardarBorrador(true);
    }

    console.log('üîß Registrando listener form-tarea...');
    const formTarea = document.getElementById('form-tarea');
    console.log('üîß form-tarea encontrado:', formTarea);
    
    if (formTarea) {
      formTarea.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('üìù Form tarea submit iniciado');
        
        const data = {
          titulo: document.getElementById('tarea-titulo').value,
          dia: document.getElementById('tarea-dia').value,
          prioridad: document.getElementById('tarea-prioridad').value,
          notas: document.getElementById('tarea-notas').value
        };
        console.log('üìù Datos tarea:', data);

        if (editingIdx !== null) {
          preparacionData.tareas[editingIdx] = data;
        } else {
          preparacionData.tareas.push(data);
        }

        cerrarModales();
        renderTareas();
        actualizarEstado();
        
        try {
          await guardarBorrador(true);
          console.log('‚úÖ Tarea guardada OK');
        } catch (err) {
          console.error('‚ùå Error guardando tarea:', err);
        }
      });
    } else {
      console.error('‚ùå form-tarea NO encontrado!');
    }

    // ========== NOTAS ==========
    function renderNotas() {
      document.getElementById('notas-general').value = preparacionData.notas || '';
    }

    // ========== ESTADO ==========
    function actualizarEstado() {
      const el = document.getElementById('semana-estado');
      el.className = 'semana-estado';
      
      if (preparacionData.estado === 'enviado') {
        el.classList.add('estado-enviado');
        el.textContent = 'üì§ Enviado';
      } else if (tieneContenido()) {
        el.classList.add('estado-preparado');
        el.textContent = 'üìù Borrador';
      } else {
        el.classList.add('estado-pendiente');
        el.textContent = 'Pendiente';
      }
    }

    function tieneContenido() {
      return preparacionData.zonas.length > 0 ||
             preparacionData.menajeEspecial ||
             preparacionData.menaje.length > 0 ||
             (preparacionData.productosAportados || []).length > 0 ||
             (preparacionData.productosSolicitados || []).length > 0 ||
             preparacionData.tareas.length > 0 ||
             Object.keys(preparacionData.menus).length > 0 ||
             Object.keys(preparacionData.servicio).length > 0 ||
             preparacionData.notas.trim() !== '';
    }

    // ========== NAVEGACI√ìN SEMANA ==========
    function cambiarSemana(dir) {
      semanaActual.setDate(semanaActual.getDate() + (dir * 7));
      actualizarVisualizacionSemana();
      cargarPreparacion();
    }

    // ========== GUARDAR / ENVIAR ==========
    async function guardarBorrador(silencioso = false) {
      console.log('üíæ guardarBorrador() iniciado, silencioso:', silencioso);
      console.log('üíæ bienId:', bienId);
      console.log('üíæ currentUser:', currentUser?.uid);
      
      // Actualizar datos desde los inputs
      preparacionData.notas = document.getElementById('notas-general').value;
      
      // Recoger datos de personas
      const campos = ['familiares', 'desayuno', 'comida', 'cena', 'duermen'];
      campos.forEach(campo => {
        if (!preparacionData.personas[campo]) preparacionData.personas[campo] = {};
        diasActivos.forEach(dia => {
          const input = document.getElementById(`personas-${campo}-${dia}`);
          if (input) preparacionData.personas[campo][dia] = parseInt(input.value) || 0;
        });
      });
      
      // Recoger men√∫s especiales
      const pases = ['desayuno', 'aperitivo', 'comida', 'cena'];
      pases.forEach(pase => {
        diasActivos.forEach(dia => {
          const key = `${pase}-${dia}`;
          const checkbox = document.getElementById(`menu-${pase}-${dia}`);
          const especial = document.getElementById(`especial-${pase}-${dia}`);
          if (checkbox && especial) {
            const input = especial.querySelector('input');
            preparacionData.menus[key] = {
              especial: checkbox.checked,
              descripcion: input ? input.value : ''
            };
          }
        });
      });

      const semanaKey = getSemanaKey();
      console.log('üíæ semanaKey:', semanaKey);
      console.log('üíæ preparacionData a guardar:', JSON.stringify(preparacionData, null, 2));
      
      try {
        console.log('üíæ Iniciando escritura en Firebase...');
        await db.collection('bienes').doc(bienId)
          .collection('preparacionSemanal').doc(semanaKey).set({
            ...preparacionData,
            diasIncluidos: diasActivos,
            estado: preparacionData.estado === 'enviado' ? 'enviado' : 'borrador',
            actualizadoPor: currentUser.uid,
            fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        
        console.log('üíæ Escritura Firebase OK');
        
        // Recargar lista de borradores
        await cargarBorradores();
        
        if (!silencioso) {
          alert('‚úÖ Borrador guardado');
        }
        actualizarEstado();
        console.log('üíæ guardarBorrador() completado');
      } catch (e) {
        console.error('‚ùå Error en guardarBorrador:', e);
        if (!silencioso) alert('Error al guardar');
      }
    }

    async function enviarPreparacion() {
      if (!tieneContenido()) {
        alert('A√±ade al menos algo de informaci√≥n antes de enviar');
        return;
      }

      if (!confirm('¬øEnviar esta preparaci√≥n al externo?')) return;

      // Guardar datos primero
      await guardarBorrador(true);

      const semanaKey = getSemanaKey();
      try {
        await db.collection('bienes').doc(bienId)
          .collection('preparacionSemanal').doc(semanaKey).set({
            ...preparacionData,
            estado: 'enviado',
            enviadoPor: currentUser.uid,
            fechaEnvio: firebase.firestore.FieldValue.serverTimestamp()
          });
        
        preparacionData.estado = 'enviado';
        actualizarEstado();
        alert('‚úÖ Preparaci√≥n enviada correctamente');
      } catch (e) {
        console.error(e);
        alert('Error al enviar');
      }
    }

    // ========== UTILS ==========
    function toggleSeccion(id) {
      document.getElementById(`body-${id}`).classList.toggle('hidden');
    }

    function cerrarModales() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
      editingIdx = null;
      editingType = null;
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) cerrarModales();
      });
    });
  </script>
</body>
</html>
