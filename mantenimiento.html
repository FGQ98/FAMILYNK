<!DOCTYPE html>
<html lang="es">
<head>
  <!-- FAMILYNK Icons & PWA -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7A9E7E">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="FAMILYNK">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Mantenimiento</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-dark: #6B5A45;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --mto: #5B8BA0;
      --mto-dark: #4A7285;
      --mto-muted: rgba(91, 139, 160, 0.12);
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-dark) 100%);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: white;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bien-nombre {
      font-size: 0.85rem;
      opacity: 0.85;
      font-weight: 400;
    }

    /* ========== MAIN ========== */
    .main {
      max-width: 900px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .page-intro {
      text-align: center;
      margin-bottom: 32px;
    }

    .page-intro-icon {
      font-size: 3.5rem;
      margin-bottom: 12px;
    }

    .page-intro-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--mayordomo-dark);
      margin-bottom: 8px;
    }

    .page-intro-subtitle {
      color: var(--text-muted);
      font-size: 1rem;
    }

    /* ========== M√ìDULOS GRID ========== */
    .modulos-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    @media (max-width: 600px) {
      .modulos-grid { grid-template-columns: 1fr; }
    }

    .modulo-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      transition: all 0.3s ease;
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      border: 2px solid transparent;
    }

    .modulo-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-float);
      border-color: var(--mayordomo-light);
    }

    .modulo-card-header {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-dark) 100%);
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .modulo-card-icon {
      width: 56px;
      height: 56px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
    }

    .modulo-card-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
    }

    .modulo-card-body {
      padding: 20px 24px;
      flex: 1;
    }

    .modulo-card-desc {
      color: var(--text-light);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .modulo-card-stats {
      display: flex;
      gap: 16px;
    }

    .modulo-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .modulo-stat-value {
      font-weight: 700;
      color: var(--mayordomo);
    }

    .modulo-card-footer {
      padding: 16px 24px;
      background: var(--cream);
      border-top: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modulo-card-action {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--mayordomo);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ========== COLORES POR M√ìDULO ========== */
    .modulo-card.taller .modulo-card-header { background: linear-gradient(135deg, #6B8E23 0%, #556B2F 100%); }
    .modulo-card.taller:hover { border-color: #6B8E23; }
    .modulo-card.taller .modulo-stat-value,
    .modulo-card.taller .modulo-card-action { color: #556B2F; }

    .modulo-card.reparaciones .modulo-card-header { background: linear-gradient(135deg, #CD853F 0%, #A0522D 100%); }
    .modulo-card.reparaciones:hover { border-color: #CD853F; }
    .modulo-card.reparaciones .modulo-stat-value,
    .modulo-card.reparaciones .modulo-card-action { color: #A0522D; }

    .modulo-card.tareas-mto .modulo-card-header { background: linear-gradient(135deg, var(--mto) 0%, var(--mto-dark) 100%); }
    .modulo-card.tareas-mto:hover { border-color: var(--mto); }
    .modulo-card.tareas-mto .modulo-stat-value,
    .modulo-card.tareas-mto .modulo-card-action { color: var(--mto-dark); }

    .modulo-card.manual .modulo-card-header { background: linear-gradient(135deg, #8B7355 0%, #6B5A45 100%); }
    .modulo-card.manual:hover { border-color: #8B7355; }
    .modulo-card.manual .modulo-stat-value,
    .modulo-card.manual .modulo-card-action { color: #6B5A45; }

    /* Card Plan Semanal */
    .modulo-card.plan-semanal .modulo-card-header { background: linear-gradient(135deg, var(--mto) 0%, var(--mto-dark) 100%); }
    .modulo-card.plan-semanal:hover { border-color: var(--mto); }
    .modulo-card.plan-semanal .modulo-stat-value { color: var(--mto-dark); }

    /* Cards interactivas con tareas */
    .plan-card-content { padding: 12px 16px; max-height: 280px; overflow-y: auto; }
    .plan-tarea {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      border-left: 3px solid var(--mayordomo);
      transition: all 0.2s;
    }
    .plan-tarea:hover { background: var(--cream-dark); }
    .plan-tarea.hoy { border-left-color: var(--warning); background: #fffbf5; }
    .plan-tarea.completada { opacity: 0.6; background: #f0f0f0; border-left-color: var(--success); }
    .plan-tarea.completada .plan-tarea-titulo { text-decoration: line-through; color: var(--text-muted); }
    .plan-tarea.reparacion { border-left-color: var(--error); }
    .plan-tarea-check { width: 20px; height: 20px; cursor: pointer; accent-color: var(--mto); }
    .plan-tarea-info { flex: 1; }
    .plan-tarea-titulo { font-weight: 600; font-size: 0.85rem; }
    .plan-tarea-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 10px; margin-top: 2px; flex-wrap: wrap; }
    .plan-tarea-dia { 
      background: var(--mto-muted); 
      color: var(--mto-dark); 
      padding: 2px 6px; 
      border-radius: 4px; 
      font-size: 0.7rem; 
      font-weight: 600; 
    }
    .badge-rep {
      background: rgba(212, 105, 90, 0.15);
      color: var(--error);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
    }
    .plan-tiempo-total {
      text-align: center;
      padding: 8px;
      background: var(--mayordomo-muted);
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--mayordomo);
      margin-bottom: 12px;
    }
    .plan-empty { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; }
    .plan-progreso {
      height: 6px;
      background: var(--cream-dark);
      border-radius: 3px;
      margin: 0 16px 12px;
      overflow: hidden;
    }
    .plan-progreso-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--mto) 0%, var(--success) 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 60px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--mayordomo);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
  <!-- Sistema de permisos CVEB para externos -->
  <script src="permisos-externos.js"></script>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="back-btn">‚Üê Volver</a>
      <div class="header-title">
        üîß Mantenimiento
        <span class="bien-nombre" id="bien-nombre"></span>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="loading" id="loading">
      <div class="spinner"></div>
    </div>

    <div id="content" class="hidden">
      <div class="page-intro">
        <div class="page-intro-icon">üîß</div>
        <h1 class="page-intro-title">Mantenimiento</h1>
        <p class="page-intro-subtitle">Gestiona el mantenimiento y reparaciones del bien</p>
      </div>

      <div class="modulos-grid">
        <!-- Taller -->
        <a href="#" class="modulo-card taller" id="card-taller">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üõ†Ô∏è</div>
            <div class="modulo-card-title">Taller</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Herramientas, materiales y recursos disponibles para el mantenimiento del bien.</p>
            <div class="modulo-card-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-herramientas">0</span>
                <span>herramientas</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-materiales">0</span>
                <span>materiales</span>
              </div>
            </div>
          </div>
          <div class="modulo-card-footer">
            <span class="modulo-card-action">Ver taller ‚Üí</span>
          </div>
        </a>

        <!-- Lista Reparaciones -->
        <a href="#" class="modulo-card reparaciones" id="card-reparaciones">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üìã</div>
            <div class="modulo-card-title">Lista Reparaciones</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Registro de aver√≠as y reparaciones pendientes o completadas.</p>
            <div class="modulo-card-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-pendientes">0</span>
                <span>pendientes</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-completadas">0</span>
                <span>completadas</span>
              </div>
            </div>
          </div>
          <div class="modulo-card-footer">
            <span class="modulo-card-action">Ver reparaciones ‚Üí</span>
          </div>
        </a>

        <!-- Tareas de Mantenimiento -->
        <a href="#" class="modulo-card tareas-mto" id="card-tareas-mto">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üîß</div>
            <div class="modulo-card-title">Tareas de Mant.</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Cat√°logo de tareas de mantenimiento preventivo por tipo de habitaci√≥n.</p>
            <div class="modulo-card-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-tipos-mto">0</span>
                <span>tipos con tareas</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-tareas-mto">0</span>
                <span>tareas definidas</span>
              </div>
            </div>
          </div>
          <div class="modulo-card-footer">
            <span class="modulo-card-action">Gestionar ‚Üí</span>
          </div>
        </a>

        <!-- Plan Semanal de Mantenimiento -->
        <a href="#" class="modulo-card plan-semanal" id="card-plan-semanal" style="text-decoration: none; color: inherit;">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üìã</div>
            <div class="modulo-card-title">Plan Semanal</div>
          </div>
          <div class="plan-progreso">
            <div class="plan-progreso-bar" id="progreso-semanal" style="width: 0%"></div>
          </div>
          <div class="plan-card-content" id="tareas-semanales">
            <div class="plan-empty">Cargando...</div>
          </div>
          <div class="modulo-card-footer" style="padding: 10px 16px; border-top: 1px solid var(--cream-dark);">
            <span class="modulo-card-action">Configurar plan ‚Üí</span>
          </div>
        </a>
      </div>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let origen = 'bien';

    // Obtener par√°metros URL
    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id') || urlParams.get('bien');
    origen = urlParams.get('origen') || 'bien';

    if (!bienId) {
      window.location.href = 'lo-comun.html';
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'registro.html';
        return;
      }
      currentUser = user;
      
      // Verificar si es externo y cargar permisos
      await PermisosExt.init(db, user, bienId);
      
      await cargarDatos();
      
      // Aplicar permisos CVEB si es externo
      if (PermisosExt.esExterno) {
        aplicarPermisosCards();
      }
    });

    // Aplicar permisos a cards seg√∫n acceso
    function aplicarPermisosCards() {
      if (!PermisosExt.puede('mantenimiento_taller', 'v')) {
        const card = document.getElementById('card-taller');
        if (card) card.style.display = 'none';
      }
      if (!PermisosExt.puede('mantenimiento_reparaciones', 'v')) {
        const card = document.getElementById('card-reparaciones');
        if (card) card.style.display = 'none';
      }
      if (!PermisosExt.puede('mantenimiento_tareas', 'v')) {
        const card = document.getElementById('card-tareas-mto');
        if (card) card.style.display = 'none';
      }
      if (!PermisosExt.puede('mantenimiento_planSemanal', 'v')) {
        const card = document.getElementById('card-plan-semanal');
        if (card) card.style.display = 'none';
      } else if (!PermisosExt.puede('mantenimiento_planSemanal', 'e')) {
        document.querySelectorAll('#tareas-semanales input[type="checkbox"]').forEach(cb => {
          cb.disabled = true;
          cb.style.cursor = 'not-allowed';
        });
      }
    }

    async function cargarDatos() {
      try {
        // Cargar datos del bien
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) {
          console.error('Bien no encontrado:', bienId);
          window.location.href = 'lo-comun.html';
          return;
        }

        bienData = { id: bienDoc.id, ...bienDoc.data() };
        
        // Actualizar UI
        document.getElementById('bien-nombre').textContent = `¬∑ ${bienData.nombre}`;
        
        // Configurar bot√≥n volver
        const backBtn = document.getElementById('back-btn');
        if (origen === 'mayordomo') {
          backBtn.href = `mayordomo.html?bien=${bienId}`;
        } else {
          backBtn.href = `bien.html?id=${bienId}`;
        }

        // Configurar enlaces de las cards
        const baseParams = `id=${bienId}&origen=mantenimiento`;
        document.getElementById('card-taller').href = `taller.html?${baseParams}`;
        document.getElementById('card-reparaciones').href = `reparaciones.html?${baseParams}`;
        document.getElementById('card-tareas-mto').href = `tareas-mantenimiento.html?${baseParams}`;
        document.getElementById('card-plan-semanal').href = `plan-semanal-mto.html?${baseParams}`;

        // Mostrar contenido primero, luego cargar estad√≠sticas en background
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

        // Cargar estad√≠sticas (no bloqueante)
        cargarEstadisticas();
        
      } catch (error) {
        console.error('Error cargando datos:', error);
        document.getElementById('loading').innerHTML = '<p style="color: var(--error);">Error al cargar. <a href="lo-comun.html">Volver</a></p>';
      }
    }

    async function cargarEstadisticas() {
      // Cargar estad√≠sticas de forma silenciosa (si falla, mostrar 0)
      
      // Taller - herramientas y materiales
      try {
        const tallerSnap = await db.collection('bienes').doc(bienId).collection('herramientas').get();
        let herramientas = 0, materiales = 0;
        tallerSnap.docs.forEach(doc => {
          const item = doc.data();
          if (item.tipo === 'herramienta') herramientas++;
          else materiales++;
        });
        document.getElementById('count-herramientas').textContent = herramientas;
        document.getElementById('count-materiales').textContent = materiales;
      } catch (e) { console.log('Sin datos de taller'); }

      // Reparaciones
      try {
        const repsSnap = await db.collection('bienes').doc(bienId).collection('reparaciones').get();
        let pendientes = 0, completadas = 0;
        repsSnap.docs.forEach(doc => {
          const rep = doc.data();
          if (rep.estado === 'completada' || rep.estado === 'cerrada') completadas++;
          else pendientes++;
        });
        document.getElementById('count-pendientes').textContent = pendientes;
        document.getElementById('count-completadas').textContent = completadas;
      } catch (e) { console.log('Sin datos de reparaciones'); }

      // Tareas de Mantenimiento - desde configMto/tareasPorTipo
      try {
        const configDoc = await db.collection('bienes').doc(bienId)
          .collection('configMto').doc('tareasPorTipo').get();
        const tareasPorTipo = configDoc.exists ? configDoc.data() : {};

        let tiposConTareas = 0;
        let totalTareas = 0;
        for (const [tipo, tareas] of Object.entries(tareasPorTipo)) {
          const activas = (tareas || []).filter(t => t.activo);
          if (activas.length > 0) {
            tiposConTareas++;
            totalTareas += activas.length;
          }
        }
        document.getElementById('count-tipos-mto').textContent = tiposConTareas;
        document.getElementById('count-tareas-mto').textContent = totalTareas;
      } catch (e) { console.log('Sin datos de tareas mto'); }

      // Plan Semanal de Mantenimiento
      await cargarPlanSemanal();
    }

    // ========== PLAN SEMANAL DE MANTENIMIENTO ==========
    let tareasSemanalesData = [];
    let semanaKeyActual = '';

    const TAREAS_MTO = {
      enchufes:     { nombre: 'Revisar enchufes y tomas',     icon: 'üîå' },
      grifos:       { nombre: 'Comprobar grifos y desag√ºes',  icon: 'üöø' },
      humedades:    { nombre: 'Inspeccionar humedades',       icon: 'üíß' },
      bisagras:     { nombre: 'Engrasar bisagras/cerraduras', icon: 'üî©' },
      persianas:    { nombre: 'Revisar persianas/estores',    icon: 'ü™ü' },
      sellados:     { nombre: 'Comprobar sellados (silicona)',icon: 'üß¥' },
      pintura:      { nombre: 'Revisar pintura/paredes',      icon: 'üñåÔ∏è' },
      filtros:      { nombre: 'Limpiar filtros (AA/campana)', icon: 'üåÄ' },
      descalcificar:{ nombre: 'Descalcificar grifer√≠a',       icon: 'üß™' },
      electrica:    { nombre: 'Revisar instalaci√≥n el√©ctrica',icon: '‚ö°' },
      fontaneria:   { nombre: 'Comprobar fontaner√≠a',         icon: 'üîß' },
      climatizacion:{ nombre: 'Revisar calefacci√≥n/AA',       icon: 'üå°Ô∏è' },
      madera:       { nombre: 'Tratar madera (puertas/muebles)',icon: 'ü™µ' },
      ventilacion:  { nombre: 'Comprobar ventilaci√≥n',        icon: 'üí®' }
    };

    const TIPOS_DEP = {
      dormitorio:   { icon: 'üõèÔ∏è', label: 'Dormitorio' },
      servicio:     { icon: 'üöø', label: 'Servicio' },
      aseo:         { icon: 'üöΩ', label: 'Aseo' },
      vestuario:    { icon: 'üëî', label: 'Vestuario' },
      cocina:       { icon: 'üç≥', label: 'Cocina' },
      salon:        { icon: 'üõãÔ∏è', label: 'Sal√≥n' },
      comedor:      { icon: 'üçΩÔ∏è', label: 'Comedor' },
      lavadero:     { icon: 'üß∫', label: 'Lavadero' },
      almacen:      { icon: 'üì¶', label: 'Almac√©n' },
      camara:       { icon: '‚ùÑÔ∏è', label: 'C√°mara' },
      taller:       { icon: 'üîß', label: 'Taller' },
      instalacion:  { icon: '‚ö°', label: 'Cuarto Instalaci√≥n' },
      porche:       { icon: 'üåø', label: 'Porche' },
      otro:         { icon: 'üè†', label: 'Otro' }
    };

    function calcularSemanaDelMes(fecha = new Date()) {
      const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
      const diaSemana = primerDia.getDay();
      return Math.ceil((fecha.getDate() + diaSemana) / 7);
    }

    function cumpleFrecuencia(inst, mesActual) {
      const mesInicio = inst.mesInicio || 1;
      const frecuencia = inst.frecuencia || 'mensual';
      let diff = mesActual - mesInicio;
      if (diff < 0) diff += 12;
      switch (frecuencia) {
        case 'semanal': return true;
        case 'quincenal': return true;
        case 'mensual': return true;
        case 'bimestral': return diff % 2 === 0;
        case 'trimestral': return diff % 3 === 0;
        case 'semestral': return diff % 6 === 0;
        case 'anual': return mesActual === mesInicio;
        default: return true;
      }
    }

    async function cargarPlanSemanal() {
      const container = document.getElementById('tareas-semanales');
      const progresoBar = document.getElementById('progreso-semanal');
      
      try {
        const hoy = new Date();
        const semanaDelMes = calcularSemanaDelMes(hoy);
        const mesActual = hoy.getMonth() + 1;

        const inicioSemana = new Date(hoy);
        inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1);
        inicioSemana.setHours(0, 0, 0, 0);
        semanaKeyActual = inicioSemana.toISOString().split('T')[0];

        tareasSemanalesData = [];

        // 1. Cargar instrucciones del plan desde planMtoConfig
        const instSnap = await db.collection('bienes').doc(bienId)
          .collection('planMtoConfig').get();
        
        instSnap.docs.forEach(doc => {
          const inst = { id: doc.id, ...doc.data() };
          
          // Filtrar: ¬øtoca esta semana del mes + cumple frecuencia?
          if (!inst.semanas || !inst.semanas.includes(semanaDelMes)) return;
          if (!cumpleFrecuencia(inst, mesActual)) return;

          const tareaInfo = TAREAS_MTO[inst.tareaId] || { nombre: inst.tareaNombre || inst.tareaId, icon: 'üîß' };
          const habIcon = TIPOS_DEP[inst.habitacionTipo]?.icon || 'üè†';

          tareasSemanalesData.push({
            id: `mto_${inst.id}`,
            titulo: tareaInfo.nombre,
            zona: `${habIcon} ${inst.habitacionNombre || 'Habitaci√≥n'}`,
            zonaIcon: tareaInfo.icon,
            tiempo: inst.duracion || 30,
            frecuencia: inst.frecuencia || 'mensual',
            completada: false
          });
        });

        // 2. Cargar reparaciones pendientes (siguen alimentando el plan)
        try {
          const repsSnap = await db.collection('bienes').doc(bienId)
            .collection('reparaciones')
            .where('estado', '==', 'pendiente')
            .get();
          
          repsSnap.docs.forEach(doc => {
            const rep = { id: doc.id, ...doc.data() };
            let urgenciaIcon = 'üü¢';
            if (rep.urgencia === 'alta') urgenciaIcon = 'üî¥';
            else if (rep.urgencia === 'media') urgenciaIcon = 'üü°';

            tareasSemanalesData.push({
              id: `rep_${doc.id}`,
              titulo: `${urgenciaIcon} ${rep.titulo || 'Reparaci√≥n'}`,
              zona: rep.zona || 'General',
              zonaIcon: 'üîß',
              tiempo: rep.tiempoEstimado || 60,
              frecuencia: '',
              esReparacion: true,
              urgencia: rep.urgencia,
              completada: false
            });
          });
        } catch (e) { console.log('Sin reparaciones pendientes'); }

        // 3. Cargar estado de completados de esta semana
        try {
          const completadosDoc = await db.collection('bienes').doc(bienId)
            .collection('planSemanalCompletados').doc(semanaKeyActual).get();
          if (completadosDoc.exists) {
            const completados = completadosDoc.data().tareas || {};
            tareasSemanalesData.forEach(t => {
              if (completados[t.id]) t.completada = true;
            });
          }
        } catch (e) {}

        renderPlanSemanal();
        
      } catch (error) {
        console.log('Error cargando plan semanal:', error);
        container.innerHTML = '<div class="plan-empty">Sin tareas esta semana</div>';
      }
    }

    function renderPlanSemanal() {
      const container = document.getElementById('tareas-semanales');
      const progresoBar = document.getElementById('progreso-semanal');
      const frecLabels = {
        semanal: 'Sem', quincenal: 'Quin', mensual: 'Mens',
        bimestral: 'Bim', trimestral: 'Trim', semestral: 'Semes', anual: 'Anual'
      };

      if (tareasSemanalesData.length === 0) {
        container.innerHTML = `
          <div class="plan-empty">
            üìã Sin tareas programadas esta semana<br>
            <small>Configura en <a href="plan-semanal-mto.html?id=${bienId}" style="color: var(--mto);">Plan Semanal</a></small>
          </div>
        `;
        progresoBar.style.width = '0%';
        return;
      }

      const completadas = tareasSemanalesData.filter(t => t.completada).length;
      const total = tareasSemanalesData.length;
      const progreso = Math.round((completadas / total) * 100);
      progresoBar.style.width = progreso + '%';

      // Calcular tiempo total
      const tiempoTotal = tareasSemanalesData.reduce((sum, t) => sum + (t.tiempo || 30), 0);
      const horasTotal = Math.floor(tiempoTotal / 60);
      const minsTotal = tiempoTotal % 60;

      let html = `<div class="plan-tiempo-total">‚è±Ô∏è ${horasTotal}h ${minsTotal ? minsTotal + 'm' : ''} esta semana</div>`;

      html += tareasSemanalesData.map(t => {
        const completadaClass = t.completada ? 'completada' : '';
        const esReparacion = t.esReparacion;
        const frecTag = frecLabels[t.frecuencia] || '';
        const tiempoStr = t.tiempo >= 60 
          ? `${Math.floor(t.tiempo/60)}h${t.tiempo%60 ? t.tiempo%60+'m' : ''}` 
          : `${t.tiempo}m`;

        return `
          <div class="plan-tarea ${completadaClass} ${esReparacion ? 'reparacion' : ''}">
            <input type="checkbox" class="plan-tarea-check" 
              ${t.completada ? 'checked' : ''} 
              onchange="toggleTareaSemanal('${t.id}', this.checked)">
            <div class="plan-tarea-info">
              <div class="plan-tarea-titulo">${t.zonaIcon} ${t.titulo}</div>
              <div class="plan-tarea-meta">
                ${frecTag ? `<span class="plan-tarea-dia">${frecTag}</span>` : ''}
                ${esReparacion ? '<span class="badge-rep">Reparaci√≥n</span>' : ''}
                <span>${t.zona}</span>
                <span>‚è±Ô∏è ${tiempoStr}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    async function toggleTareaSemanal(tareaId, completada) {
      try {
        const docRef = db.collection('bienes').doc(bienId)
          .collection('planSemanalCompletados').doc(semanaKeyActual);
        
        if (completada) {
          await docRef.set({
            [`tareas.${tareaId}`]: {
              completada: true,
              fechaCompletado: new Date().toISOString(),
              completadoPor: currentUser.uid
            }
          }, { merge: true });
        } else {
          await docRef.set({
            [`tareas.${tareaId}`]: firebase.firestore.FieldValue.delete()
          }, { merge: true });
        }
        
        const tarea = tareasSemanalesData.find(t => t.id === tareaId);
        if (tarea) tarea.completada = completada;
        renderPlanSemanal();
      } catch (error) {
        console.error('Error actualizando tarea:', error);
      }
    }
  </script>
</body>
</html>
