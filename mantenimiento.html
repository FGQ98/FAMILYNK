<!DOCTYPE html>
<html lang="es">
<head>
  <!-- FAMILYNK Icons & PWA -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7A9E7E">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="FAMILYNK">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Mantenimiento</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --cream-medium: #FAF5EF;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --mayordomo: #8B7355;
      --mayordomo-light: #A69076;
      --mayordomo-dark: #6B5A45;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-dark) 100%);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: white;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover { background: rgba(255,255,255,0.25); }

    .header-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bien-nombre {
      font-size: 0.85rem;
      opacity: 0.85;
      font-weight: 400;
    }

    /* ========== MAIN ========== */
    .main {
      max-width: 900px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .page-intro {
      text-align: center;
      margin-bottom: 32px;
    }

    .page-intro-icon {
      font-size: 3.5rem;
      margin-bottom: 12px;
    }

    .page-intro-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--mayordomo-dark);
      margin-bottom: 8px;
    }

    .page-intro-subtitle {
      color: var(--text-muted);
      font-size: 1rem;
    }

    /* ========== M√ìDULOS GRID ========== */
    .modulos-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    @media (max-width: 600px) {
      .modulos-grid { grid-template-columns: 1fr; }
    }

    .modulo-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      transition: all 0.3s ease;
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      border: 2px solid transparent;
    }

    .modulo-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-float);
      border-color: var(--mayordomo-light);
    }

    .modulo-card-header {
      background: linear-gradient(135deg, var(--mayordomo) 0%, var(--mayordomo-dark) 100%);
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .modulo-card-icon {
      width: 56px;
      height: 56px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
    }

    .modulo-card-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
    }

    .modulo-card-body {
      padding: 20px 24px;
      flex: 1;
    }

    .modulo-card-desc {
      color: var(--text-light);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .modulo-card-stats {
      display: flex;
      gap: 16px;
    }

    .modulo-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .modulo-stat-value {
      font-weight: 700;
      color: var(--mayordomo);
    }

    .modulo-card-footer {
      padding: 16px 24px;
      background: var(--cream);
      border-top: 1px solid var(--cream-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modulo-card-action {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--mayordomo);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ========== COLORES POR M√ìDULO ========== */
    .modulo-card.taller .modulo-card-header { background: linear-gradient(135deg, #6B8E23 0%, #556B2F 100%); }
    .modulo-card.taller:hover { border-color: #6B8E23; }
    .modulo-card.taller .modulo-stat-value,
    .modulo-card.taller .modulo-card-action { color: #556B2F; }

    .modulo-card.reparaciones .modulo-card-header { background: linear-gradient(135deg, #CD853F 0%, #A0522D 100%); }
    .modulo-card.reparaciones:hover { border-color: #CD853F; }
    .modulo-card.reparaciones .modulo-stat-value,
    .modulo-card.reparaciones .modulo-card-action { color: #A0522D; }

    .modulo-card.programado .modulo-card-header { background: linear-gradient(135deg, #5B8BA0 0%, #4A7285 100%); }
    .modulo-card.programado:hover { border-color: #5B8BA0; }
    .modulo-card.programado .modulo-stat-value,
    .modulo-card.programado .modulo-card-action { color: #4A7285; }

    .modulo-card.manual .modulo-card-header { background: linear-gradient(135deg, #8B7355 0%, #6B5A45 100%); }
    .modulo-card.manual:hover { border-color: #8B7355; }
    .modulo-card.manual .modulo-stat-value,
    .modulo-card.manual .modulo-card-action { color: #6B5A45; }

    /* Card Plan Semanal */
    .modulo-card.plan-semanal .modulo-card-header { background: linear-gradient(135deg, #5B8BA0 0%, #4A7285 100%); }
    .modulo-card.plan-semanal:hover { border-color: #5B8BA0; }
    .modulo-card.plan-semanal .modulo-stat-value { color: #4A7285; }

    /* Card Plan Limpieza */
    .modulo-card.plan-limpieza .modulo-card-header { background: linear-gradient(135deg, #7A9E7E 0%, #5C7D5F 100%); }
    .modulo-card.plan-limpieza:hover { border-color: #7A9E7E; }
    .modulo-card.plan-limpieza .modulo-stat-value { color: #5C7D5F; }

    /* Cards interactivas con tareas */
    .plan-card-content { padding: 12px 16px; max-height: 280px; overflow-y: auto; }
    .plan-tarea {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      border-left: 3px solid var(--mayordomo);
      transition: all 0.2s;
    }
    .plan-tarea:hover { background: var(--cream-dark); }
    .plan-tarea.hoy { border-left-color: var(--warning); background: #fffbf5; }
    .plan-tarea.completada { opacity: 0.6; background: #f0f0f0; border-left-color: var(--success); }
    .plan-tarea.completada .plan-tarea-titulo { text-decoration: line-through; color: var(--text-muted); }
    .plan-tarea.reparacion { border-left-color: var(--error); }
    .plan-tarea-check { width: 20px; height: 20px; cursor: pointer; accent-color: var(--sage); }
    .plan-tarea-info { flex: 1; }
    .plan-tarea-titulo { font-weight: 600; font-size: 0.85rem; }
    .plan-tarea-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 10px; margin-top: 2px; flex-wrap: wrap; }
    .plan-tarea-dia { 
      background: var(--sage-muted); 
      color: var(--sage-dark); 
      padding: 2px 6px; 
      border-radius: 4px; 
      font-size: 0.7rem; 
      font-weight: 600; 
    }
    .badge-rep {
      background: rgba(212, 105, 90, 0.15);
      color: var(--error);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
    }
    .plan-tiempo-total {
      text-align: center;
      padding: 8px;
      background: var(--mayordomo-muted);
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--mayordomo);
      margin-bottom: 12px;
    }
    .plan-empty { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem; }
    .plan-progreso {
      height: 6px;
      background: var(--cream-dark);
      border-radius: 3px;
      margin: 0 16px 12px;
      overflow: hidden;
    }
    .plan-progreso-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--sage) 0%, var(--success) 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 60px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--cream-dark);
      border-top-color: var(--mayordomo);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="back-btn">‚Üê Volver</a>
      <div class="header-title">
        üîß Mantenimiento
        <span class="bien-nombre" id="bien-nombre"></span>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="loading" id="loading">
      <div class="spinner"></div>
    </div>

    <div id="content" class="hidden">
      <div class="page-intro">
        <div class="page-intro-icon">üîß</div>
        <h1 class="page-intro-title">Mantenimiento</h1>
        <p class="page-intro-subtitle">Gestiona el mantenimiento y reparaciones del bien</p>
      </div>

      <div class="modulos-grid">
        <!-- Taller -->
        <a href="#" class="modulo-card taller" id="card-taller">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üõ†Ô∏è</div>
            <div class="modulo-card-title">Taller</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Herramientas, materiales y recursos disponibles para el mantenimiento del bien.</p>
            <div class="modulo-card-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-herramientas">0</span>
                <span>herramientas</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-materiales">0</span>
                <span>materiales</span>
              </div>
            </div>
          </div>
          <div class="modulo-card-footer">
            <span class="modulo-card-action">Ver taller ‚Üí</span>
          </div>
        </a>

        <!-- Lista Reparaciones -->
        <a href="#" class="modulo-card reparaciones" id="card-reparaciones">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üìã</div>
            <div class="modulo-card-title">Lista Reparaciones</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Registro de aver√≠as y reparaciones pendientes o completadas.</p>
            <div class="modulo-card-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-pendientes">0</span>
                <span>pendientes</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-completadas">0</span>
                <span>completadas</span>
              </div>
            </div>
          </div>
          <div class="modulo-card-footer">
            <span class="modulo-card-action">Ver reparaciones ‚Üí</span>
          </div>
        </a>

        <!-- Mantenimiento Programado -->
        <a href="#" class="modulo-card programado" id="card-programado">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üìÖ</div>
            <div class="modulo-card-title">Mant. Programado</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Tareas de mantenimiento preventivo con calendario y recordatorios.</p>
            <div class="modulo-card-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-proximos">0</span>
                <span>pr√≥ximos</span>
              </div>
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-vencidos">0</span>
                <span>vencidos</span>
              </div>
            </div>
          </div>
          <div class="modulo-card-footer">
            <span class="modulo-card-action">Ver calendario ‚Üí</span>
          </div>
        </a>

        <!-- Manual T√©cnico -->
        <a href="#" class="modulo-card manual" id="card-manual">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üìñ</div>
            <div class="modulo-card-title">Manual T√©cnico</div>
          </div>
          <div class="modulo-card-body">
            <p class="modulo-card-desc">Documentaci√≥n t√©cnica, manuales de equipos e instrucciones de uso.</p>
            <div class="modulo-card-stats">
              <div class="modulo-stat">
                <span class="modulo-stat-value" id="count-manuales">0</span>
                <span>documentos</span>
              </div>
            </div>
          </div>
          <div class="modulo-card-footer">
            <span class="modulo-card-action">Ver manuales ‚Üí</span>
          </div>
        </a>

        <!-- Plan Semanal de Mantenimiento -->
        <div class="modulo-card plan-semanal" id="card-plan-semanal">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üìã</div>
            <div class="modulo-card-title">Plan Semanal</div>
          </div>
          <div class="plan-progreso">
            <div class="plan-progreso-bar" id="progreso-semanal" style="width: 0%"></div>
          </div>
          <div class="plan-card-content" id="tareas-semanales">
            <div class="plan-empty">Cargando...</div>
          </div>
        </div>

        <!-- Plan de Limpieza Semanal -->
        <div class="modulo-card plan-limpieza" id="card-plan-limpieza">
          <div class="modulo-card-header">
            <div class="modulo-card-icon">üßπ</div>
            <div class="modulo-card-title">Plan Limpieza</div>
          </div>
          <div class="plan-progreso">
            <div class="plan-progreso-bar" id="progreso-limpieza" style="width: 0%"></div>
          </div>
          <div class="plan-card-content" id="tareas-limpieza">
            <div class="plan-empty">Cargando...</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null;
    let bienId = null;
    let bienData = null;
    let origen = 'bien';

    // Obtener par√°metros URL
    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id') || urlParams.get('bien');
    origen = urlParams.get('origen') || 'bien';

    if (!bienId) {
      window.location.href = 'lo-comun.html';
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'registro.html';
        return;
      }
      currentUser = user;
      await cargarDatos();
    });

    async function cargarDatos() {
      try {
        // Cargar datos del bien
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) {
          console.error('Bien no encontrado:', bienId);
          window.location.href = 'lo-comun.html';
          return;
        }

        bienData = { id: bienDoc.id, ...bienDoc.data() };
        
        // Actualizar UI
        document.getElementById('bien-nombre').textContent = `¬∑ ${bienData.nombre}`;
        
        // Configurar bot√≥n volver
        const backBtn = document.getElementById('back-btn');
        if (origen === 'mayordomo') {
          backBtn.href = `mayordomo.html?bien=${bienId}`;
        } else {
          backBtn.href = `bien.html?id=${bienId}`;
        }

        // Configurar enlaces de las cards
        const baseParams = `id=${bienId}&origen=mantenimiento`;
        document.getElementById('card-taller').href = `taller.html?${baseParams}`;
        document.getElementById('card-reparaciones').href = `reparaciones.html?${baseParams}`;
        document.getElementById('card-programado').href = `mant-programado.html?${baseParams}`;
        document.getElementById('card-manual').href = `manual-mantenimiento.html?${baseParams}`;

        // Mostrar contenido primero, luego cargar estad√≠sticas en background
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

        // Cargar estad√≠sticas (no bloqueante)
        cargarEstadisticas();
        
      } catch (error) {
        console.error('Error cargando datos:', error);
        document.getElementById('loading').innerHTML = '<p style="color: var(--error);">Error al cargar. <a href="lo-comun.html">Volver</a></p>';
      }
    }

    async function cargarEstadisticas() {
      // Cargar estad√≠sticas de forma silenciosa (si falla, mostrar 0)
      
      // Taller - herramientas y materiales
      try {
        const tallerSnap = await db.collection('bienes').doc(bienId).collection('taller').get();
        let herramientas = 0, materiales = 0;
        tallerSnap.docs.forEach(doc => {
          const item = doc.data();
          if (item.tipo === 'herramienta') herramientas++;
          else materiales++;
        });
        document.getElementById('count-herramientas').textContent = herramientas;
        document.getElementById('count-materiales').textContent = materiales;
      } catch (e) { console.log('Sin datos de taller'); }

      // Reparaciones
      try {
        const repsSnap = await db.collection('bienes').doc(bienId).collection('reparaciones').get();
        let pendientes = 0, completadas = 0;
        repsSnap.docs.forEach(doc => {
          const rep = doc.data();
          if (rep.estado === 'completada' || rep.estado === 'cerrada') completadas++;
          else pendientes++;
        });
        document.getElementById('count-pendientes').textContent = pendientes;
        document.getElementById('count-completadas').textContent = completadas;
      } catch (e) { console.log('Sin datos de reparaciones'); }

      // Mantenimiento programado
      try {
        const mantSnap = await db.collection('bienes').doc(bienId).collection('mantenimientoProgramado').get();
        let proximos = 0, vencidos = 0;
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        mantSnap.docs.forEach(doc => {
          const mant = doc.data();
          if (mant.proximaFecha) {
            const fecha = mant.proximaFecha.toDate ? mant.proximaFecha.toDate() : new Date(mant.proximaFecha);
            if (fecha < hoy) vencidos++;
            else proximos++;
          }
        });
        document.getElementById('count-proximos').textContent = proximos;
        document.getElementById('count-vencidos').textContent = vencidos;
      } catch (e) { console.log('Sin datos de mant programado'); }

      // Manuales
      try {
        const manualesSnap = await db.collection('bienes').doc(bienId).collection('manuales').get();
        document.getElementById('count-manuales').textContent = manualesSnap.size;
      } catch (e) { console.log('Sin datos de manuales'); }

      // Plan Semanal de Mantenimiento
      await cargarPlanSemanal();

      // Plan de Limpieza
      await cargarPlanLimpieza();
    }

    // ========== PLAN SEMANAL DE MANTENIMIENTO ==========
    let tareasSemanalesData = [];
    let semanaKeyActual = '';
    const MAX_MINUTOS_DIA = 420; // 7 horas m√°ximo por d√≠a

    async function cargarPlanSemanal() {
      const container = document.getElementById('tareas-semanales');
      const progresoBar = document.getElementById('progreso-semanal');
      
      try {
        const hoy = new Date();
        const diaHoy = hoy.getDay();
        const inicioSemana = new Date(hoy);
        inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1); // Lunes
        inicioSemana.setHours(0, 0, 0, 0);
        const finSemana = new Date(inicioSemana);
        finSemana.setDate(inicioSemana.getDate() + 6);
        
        semanaKeyActual = inicioSemana.toISOString().split('T')[0];

        // 1. Cargar tareas del Mantenimiento Programado que tocan esta semana
        const mantProgSnap = await db.collection('bienes').doc(bienId)
          .collection('mantenimientoProgramado').get();
        
        let tareasProgramadas = [];
        const diasSemanaFechas = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(inicioSemana);
          d.setDate(inicioSemana.getDate() + i);
          diasSemanaFechas.push(d);
        }

        mantProgSnap.docs.forEach(doc => {
          const mant = { id: doc.id, ...doc.data() };
          const frecuencia = mant.frecuencia || 'mensual';
          const proximaFecha = mant.proximaFecha?.toDate ? mant.proximaFecha.toDate() : 
                              mant.proximaFecha ? new Date(mant.proximaFecha) : null;
          
          if (!proximaFecha) return;
          
          // Verificar si toca esta semana seg√∫n frecuencia
          diasSemanaFechas.forEach((diaFecha, idx) => {
            let tocaEsteDia = false;
            
            if (frecuencia === 'diario') {
              tocaEsteDia = true;
            } else if (frecuencia === 'semanal' && proximaFecha.getDay() === diaFecha.getDay()) {
              tocaEsteDia = true;
            } else if (frecuencia === 'quincenal') {
              const diffDays = Math.floor((diaFecha - proximaFecha) / (1000 * 60 * 60 * 24));
              tocaEsteDia = diffDays % 14 === 0 && diffDays >= 0;
            } else if (frecuencia === 'mensual' && proximaFecha.getDate() === diaFecha.getDate()) {
              tocaEsteDia = true;
            } else if (diaFecha.toISOString().split('T')[0] === proximaFecha.toISOString().split('T')[0]) {
              tocaEsteDia = true;
            }

            if (tocaEsteDia) {
              tareasProgramadas.push({
                id: `prog_${doc.id}_${idx}`,
                titulo: mant.nombre || mant.titulo,
                tipo: 'programado',
                fechaProgramada: diaFecha.toISOString().split('T')[0],
                tiempoEstimado: mant.tiempoEstimado || 60,
                prioridad: 'normal',
                completada: false,
                origen: doc.id
              });
            }
          });
        });

        // 2. Cargar reparaciones pendientes ordenadas por prioridad y antig√ºedad
        const repsSnap = await db.collection('bienes').doc(bienId)
          .collection('mantenimiento')
          .where('estado', '==', 'pendiente')
          .get();
        
        let reparaciones = repsSnap.docs.map(doc => {
          const rep = { id: doc.id, ...doc.data() };
          // Calcular score de prioridad (mayor = m√°s urgente)
          let score = 0;
          if (rep.urgencia === 'alta') score += 1000;
          else if (rep.urgencia === 'media') score += 500;
          // A√±adir antig√ºedad (d√≠as desde reporte)
          const fechaReporte = rep.fecha?.toDate ? rep.fecha.toDate() : new Date();
          const diasDesdeReporte = Math.floor((hoy - fechaReporte) / (1000 * 60 * 60 * 24));
          score += diasDesdeReporte;
          
          return {
            id: `rep_${doc.id}`,
            titulo: `üîß ${rep.titulo}`,
            tipo: 'reparacion',
            tiempoEstimado: rep.tiempoEstimado || 60,
            urgencia: rep.urgencia,
            prioridad: rep.urgencia,
            score: score,
            completada: false,
            origen: doc.id
          };
        }).sort((a, b) => b.score - a.score);

        // 3. Distribuir reparaciones en d√≠as con tiempo disponible
        const tiempoPorDia = [0, 0, 0, 0, 0, 0, 0]; // Lun-Dom
        
        // Primero contar tiempo de tareas programadas
        tareasProgramadas.forEach(t => {
          const fecha = new Date(t.fechaProgramada);
          const diaIdx = (fecha.getDay() + 6) % 7; // Convertir: Dom=6, Lun=0, etc.
          tiempoPorDia[diaIdx] += t.tiempoEstimado || 60;
        });

        // Asignar reparaciones a d√≠as con tiempo disponible
        reparaciones.forEach(rep => {
          // Buscar d√≠a con tiempo disponible
          for (let i = 0; i < 7; i++) {
            if (tiempoPorDia[i] + (rep.tiempoEstimado || 60) <= MAX_MINUTOS_DIA) {
              const diaFecha = new Date(inicioSemana);
              diaFecha.setDate(inicioSemana.getDate() + i);
              rep.fechaProgramada = diaFecha.toISOString().split('T')[0];
              tiempoPorDia[i] += rep.tiempoEstimado || 60;
              tareasProgramadas.push(rep);
              break;
            }
          }
        });

        // 4. Cargar estado de completado de esta semana
        try {
          const completadosDoc = await db.collection('bienes').doc(bienId)
            .collection('planSemanalCompletados').doc(semanaKeyActual).get();
          if (completadosDoc.exists) {
            const completados = completadosDoc.data().tareas || {};
            tareasProgramadas.forEach(t => {
              if (completados[t.id]) {
                t.completada = true;
              }
            });
          }
        } catch (e) {}

        // Ordenar por fecha
        tareasProgramadas.sort((a, b) => new Date(a.fechaProgramada) - new Date(b.fechaProgramada));
        
        tareasSemanalesData = tareasProgramadas;
        renderPlanSemanal();
        
      } catch (error) {
        console.log('Error cargando plan semanal:', error);
        container.innerHTML = '<div class="plan-empty">Sin tareas esta semana</div>';
      }
    }

    function renderPlanSemanal() {
      const container = document.getElementById('tareas-semanales');
      const progresoBar = document.getElementById('progreso-semanal');
      const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      const hoyNum = new Date().getDay();

      if (tareasSemanalesData.length === 0) {
        container.innerHTML = '<div class="plan-empty">üìã Sin tareas programadas esta semana<br><small>Las tareas se generan desde Mant. Programado y Reparaciones</small></div>';
        progresoBar.style.width = '0%';
        return;
      }

      const completadas = tareasSemanalesData.filter(t => t.completada).length;
      const total = tareasSemanalesData.length;
      const progreso = Math.round((completadas / total) * 100);
      progresoBar.style.width = progreso + '%';

      // Calcular tiempo total
      const tiempoTotal = tareasSemanalesData.reduce((sum, t) => sum + (t.tiempoEstimado || 60), 0);
      const horasTotal = Math.floor(tiempoTotal / 60);
      const minsTotal = tiempoTotal % 60;

      let html = tareasSemanalesData.map(t => {
        const fecha = new Date(t.fechaProgramada);
        const diaNum = fecha.getDay();
        const diaStr = diasSemana[diaNum];
        const esHoy = diaNum === hoyNum;
        const completada = t.completada ? 'completada' : '';
        const esReparacion = t.tipo === 'reparacion';
        const tiempo = t.tiempoEstimado || 60;
        const tiempoStr = tiempo >= 60 ? `${Math.floor(tiempo/60)}h${tiempo%60 ? tiempo%60+'m' : ''}` : `${tiempo}m`;
        
        // Icono de urgencia para reparaciones
        let urgenciaIcon = '';
        if (esReparacion) {
          if (t.urgencia === 'alta') urgenciaIcon = 'üî¥';
          else if (t.urgencia === 'media') urgenciaIcon = 'üü°';
          else urgenciaIcon = 'üü¢';
        }

        return `
          <div class="plan-tarea ${completada} ${esHoy ? 'hoy' : ''} ${esReparacion ? 'reparacion' : ''}">
            <input type="checkbox" class="plan-tarea-check" 
              ${t.completada ? 'checked' : ''} 
              onchange="toggleTareaSemanal('${t.id}', this.checked)">
            <div class="plan-tarea-info">
              <div class="plan-tarea-titulo">${urgenciaIcon} ${t.titulo || 'Tarea'}</div>
              <div class="plan-tarea-meta">
                <span class="plan-tarea-dia">${diaStr} ${fecha.getDate()}</span>
                <span>‚è±Ô∏è ${tiempoStr}</span>
                ${esReparacion ? '<span class="badge-rep">Reparaci√≥n</span>' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');

      // A√±adir resumen de tiempo
      html = `<div class="plan-tiempo-total">‚è±Ô∏è ${horasTotal}h ${minsTotal ? minsTotal + 'm' : ''} esta semana</div>` + html;

      container.innerHTML = html;
    }

    async function toggleTareaSemanal(tareaId, completada) {
      try {
        // Guardar estado de completado en colecci√≥n separada por semana
        const docRef = db.collection('bienes').doc(bienId)
          .collection('planSemanalCompletados').doc(semanaKeyActual);
        
        if (completada) {
          await docRef.set({
            [`tareas.${tareaId}`]: {
              completada: true,
              fechaCompletado: new Date().toISOString(),
              completadoPor: currentUser.uid
            }
          }, { merge: true });
        } else {
          await docRef.set({
            [`tareas.${tareaId}`]: firebase.firestore.FieldValue.delete()
          }, { merge: true });
        }
        
        // Actualizar UI
        const tarea = tareasSemanalesData.find(t => t.id === tareaId);
        if (tarea) tarea.completada = completada;
        renderPlanSemanal();
      } catch (error) {
        console.error('Error actualizando tarea:', error);
      }
    }

    // ========== PLAN DE LIMPIEZA ==========
    let planLimpiezaData = [];
    let limpiezaCompletados = {};

    async function cargarPlanLimpieza() {
      const container = document.getElementById('tareas-limpieza');
      const progresoBar = document.getElementById('progreso-limpieza');
      
      try {
        const hoy = new Date();
        const inicioSemana = new Date(hoy);
        inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1);
        inicioSemana.setHours(0, 0, 0, 0);
        const semanaKey = inicioSemana.toISOString().split('T')[0];

        // Cargar plan base de limpieza
        const planSnap = await db.collection('bienes').doc(bienId).collection('planLimpieza').get();
        const planBase = planSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Cargar completados de esta semana
        try {
          const completadosDoc = await db.collection('bienes').doc(bienId)
            .collection('planLimpiezaCompletados').doc(semanaKey).get();
          if (completadosDoc.exists) {
            limpiezaCompletados = completadosDoc.data().tareas || {};
          }
        } catch (e) {}

        // Combinar plan con estado de completados
        planLimpiezaData = planBase.map(tarea => ({
          ...tarea,
          completada: !!limpiezaCompletados[tarea.id],
          semanaKey: semanaKey
        }));

        // Ordenar por d√≠a
        planLimpiezaData.sort((a, b) => {
          const diaA = parseInt(a.dia);
          const diaB = parseInt(b.dia);
          return (diaA === 0 ? 7 : diaA) - (diaB === 0 ? 7 : diaB);
        });

        renderPlanLimpieza();
        
      } catch (error) {
        console.log('Error cargando plan limpieza:', error);
        container.innerHTML = '<div class="plan-empty">Sin plan de limpieza</div>';
      }
    }

    function renderPlanLimpieza() {
      const container = document.getElementById('tareas-limpieza');
      const progresoBar = document.getElementById('progreso-limpieza');
      const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      const hoyNum = new Date().getDay();

      const zonaIcons = {
        cocina: 'üç≥', salon: 'üõãÔ∏è', comedor: 'üçΩÔ∏è', dormitorio: 'üõèÔ∏è',
        bano: 'üöø', terraza: 'üåø', garaje: 'üöó', lavadero: 'üß∫',
        entrada: 'üö™', general: 'üè†'
      };
      const tareaIcons = {
        'barrer-fregar': 'üßπ', 'cambiar-sabanas': 'üõèÔ∏è', 'desinfectar': 'üß¥',
        'revisar-consumibles': 'üì¶', 'planchar': 'üëî', 'lavar-ropa': 'üß∫',
        'limpiar-cristales': 'ü™ü', 'aspirar': 'üîå', 'quitar-polvo': '‚ú®',
        'limpiar-electrodomesticos': 'üîß', 'ordenar': 'üìÇ', 'otra': 'üìã'
      };
      const tareaNombres = {
        'barrer-fregar': 'Barrer y fregar', 'cambiar-sabanas': 'Cambiar s√°banas', 
        'desinfectar': 'Desinfectar', 'revisar-consumibles': 'Revisar consumibles',
        'planchar': 'Planchar', 'lavar-ropa': 'Lavar ropa', 'limpiar-cristales': 'Limpiar cristales',
        'aspirar': 'Aspirar', 'quitar-polvo': 'Quitar polvo', 
        'limpiar-electrodomesticos': 'Limpiar electrodom.', 'ordenar': 'Ordenar', 'otra': 'Otra'
      };

      if (planLimpiezaData.length === 0) {
        container.innerHTML = '<div class="plan-empty">üßπ Sin plan de limpieza configurado<br><small><a href="plan-limpieza.html?id=' + bienId + '">Configurar plan ‚Üí</a></small></div>';
        progresoBar.style.width = '0%';
        return;
      }

      const completadas = planLimpiezaData.filter(t => t.completada).length;
      const total = planLimpiezaData.length;
      const progreso = Math.round((completadas / total) * 100);
      progresoBar.style.width = progreso + '%';

      let html = planLimpiezaData.map(t => {
        const diaNum = parseInt(t.dia);
        const diaStr = diasSemana[diaNum];
        const esHoy = diaNum === hoyNum;
        const completada = t.completada ? 'completada' : '';
        const zonaIcon = zonaIcons[t.zona] || 'üè†';
        const tareaIcon = tareaIcons[t.tipo] || 'üìã';
        const tareaNombre = t.tipo === 'otra' ? (t.otraTarea || 'Tarea') : (tareaNombres[t.tipo] || t.tipo);

        return `
          <div class="plan-tarea ${completada} ${esHoy ? 'hoy' : ''}">
            <input type="checkbox" class="plan-tarea-check" 
              ${t.completada ? 'checked' : ''} 
              onchange="toggleLimpieza('${t.id}', '${t.semanaKey}', this.checked)">
            <div class="plan-tarea-info">
              <div class="plan-tarea-titulo">${tareaIcon} ${tareaNombre}</div>
              <div class="plan-tarea-meta">
                <span class="plan-tarea-dia">${diaStr}</span>
                <span>${zonaIcon} ${t.dependencia || ''}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    async function toggleLimpieza(tareaId, semanaKey, completada) {
      try {
        const docRef = db.collection('bienes').doc(bienId)
          .collection('planLimpiezaCompletados').doc(semanaKey);
        
        if (completada) {
          await docRef.set({
            [`tareas.${tareaId}`]: {
              completada: true,
              fechaCompletado: new Date().toISOString(),
              completadoPor: currentUser.uid
            }
          }, { merge: true });
        } else {
          await docRef.set({
            [`tareas.${tareaId}`]: firebase.firestore.FieldValue.delete()
          }, { merge: true });
        }
        
        const tarea = planLimpiezaData.find(t => t.id === tareaId);
        if (tarea) tarea.completada = completada;
        renderPlanLimpieza();
      } catch (error) {
        console.error('Error actualizando limpieza:', error);
      }
    }
  </script>
</body>
</html>
