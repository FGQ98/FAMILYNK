<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Portal Guarda</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E; --sage-dark: #5C7D5F; --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3; --cream-dark: #F5EDE4;
      --terracotta: #C17757; --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A;
      --white: #FFFFFF; --success: #7DB59A; --warning: #E8B44D; --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
      --mayordomo: #8B7355; --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --guarda: #8B6914; --guarda-dark: #6B5010;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }
    .header { background: var(--guarda); color: var(--white); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
    .header-info h1 { font-family: 'Quicksand', sans-serif; font-size: 1.25rem; }
    .header-info p { font-size: 0.85rem; opacity: 0.9; }
    .btn-header { padding: 8px 16px; background: rgba(255,255,255,0.15); border: none; border-radius: var(--radius-md); color: var(--white); font-family: 'Nunito', sans-serif; cursor: pointer; }
    .btn-header:hover { background: rgba(255,255,255,0.25); }
    .main { max-width: 900px; margin: 0 auto; padding: 24px; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 80px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--guarda); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
    .modulos-grid { display: flex; flex-direction: column; gap: 20px; }
    .modulo-card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); overflow: hidden; }
    .modulo-card-header { padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--cream-dark); }
    .modulo-card-title { font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .modulo-badge { background: var(--terracotta); color: var(--white); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
    .modulo-card-body { padding: 16px 20px; max-height: 350px; overflow-y: auto; }
    .modulo-card-empty { text-align: center; padding: 30px; color: var(--text-muted); }
    .modulo-card-footer { padding: 12px 20px; border-top: 1px solid var(--cream-dark); display: flex; justify-content: flex-end; }
    .btn { padding: 8px 16px; border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-weight: 600; font-size: 0.85rem; cursor: pointer; border: none; }
    .btn-guarda { background: var(--guarda); color: var(--white); }
    .item-card { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--cream); border-radius: var(--radius-sm); margin-bottom: 8px; }
    .item-card.urgente { border-left: 3px solid var(--terracotta); background: var(--terracotta-muted); }
    .item-card.hoy { border-left: 3px solid var(--warning); background: #fffbf5; }
    .item-icon { font-size: 1.3rem; }
    .item-info { flex: 1; }
    .item-title { font-weight: 600; font-size: 0.9rem; }
    .item-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 10px; margin-top: 2px; }
    .item-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .badge-pendiente { background: var(--terracotta-muted); color: var(--terracotta); }
    .plan-progreso { height: 8px; background: var(--cream-dark); border-radius: 4px; margin-bottom: 16px; overflow: hidden; }
    .plan-progreso-bar { height: 100%; background: linear-gradient(90deg, var(--guarda) 0%, var(--success) 100%); }
    .plan-tarea { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--cream); border-radius: var(--radius-sm); margin-bottom: 8px; border-left: 3px solid var(--guarda); }
    .plan-tarea.completada { opacity: 0.6; background: #f0f0f0; border-left-color: var(--success); }
    .plan-tarea.completada .plan-tarea-titulo { text-decoration: line-through; }
    .plan-tarea.hoy { border-left-color: var(--warning); background: #fffbf5; }
    .plan-tarea-check { width: 18px; height: 18px; accent-color: var(--guarda); cursor: pointer; }
    .plan-tarea-info { flex: 1; }
    .plan-tarea-titulo { font-weight: 600; font-size: 0.85rem; }
    .plan-tarea-meta { font-size: 0.7rem; color: var(--text-muted); display: flex; gap: 8px; margin-top: 2px; }
    .plan-tipo { font-size: 0.65rem; padding: 1px 6px; border-radius: 3px; font-weight: 600; }
    .tipo-limpieza { background: var(--sage-muted); color: var(--sage-dark); }
    .tipo-mantenimiento { background: var(--mayordomo-muted); color: var(--mayordomo); }
    .tipo-agricola { background: rgba(139,105,20,0.15); color: var(--guarda); }
    .inventario-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--cream); border-radius: var(--radius-sm); margin-bottom: 6px; }
    .inventario-item.bajo { background: var(--terracotta-muted); }
    .inventario-nombre { font-weight: 600; font-size: 0.9rem; }
    .inventario-stock { font-size: 0.85rem; color: var(--text-muted); }
    .inventario-stock.bajo { color: var(--terracotta); font-weight: 600; }
    .mensaje-card { padding: 12px 16px; background: var(--cream); border-radius: var(--radius-sm); margin-bottom: 8px; border-left: 3px solid var(--sage); }
    .mensaje-card.no-leido { background: var(--sage-muted); border-left-color: var(--guarda); }
    .mensaje-card.notificacion { border-left-color: var(--terracotta); }

    /* Pedidos expandibles */
    .pedido-card { background: var(--cream); border-radius: var(--radius-sm); margin-bottom: 10px; overflow: hidden; }
    .pedido-card.urgente { border-left: 3px solid var(--terracotta); }
    .pedido-card.en-curso { border-left: 3px solid var(--warning); }
    .pedido-card.completado { border-left: 3px solid var(--success); opacity: 0.7; }
    .pedido-header { display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer; }
    .pedido-header:hover { background: var(--cream-dark); }
    .pedido-icon { font-size: 1.2rem; }
    .pedido-info { flex: 1; }
    .pedido-titulo { font-weight: 600; font-size: 0.9rem; }
    .pedido-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 8px; margin-top: 2px; }
    .pedido-progreso { display: flex; align-items: center; gap: 6px; }
    .pedido-progreso-bar { width: 50px; height: 6px; background: var(--cream-dark); border-radius: 3px; overflow: hidden; }
    .pedido-progreso-fill { height: 100%; background: var(--success); }
    .pedido-progreso-text { font-size: 0.7rem; color: var(--text-muted); }
    .pedido-toggle { font-size: 0.8rem; color: var(--text-muted); }
    .pedido-card.expanded .pedido-toggle { transform: rotate(180deg); }
    .pedido-items { display: none; padding: 0 16px 12px; }
    .pedido-card.expanded .pedido-items { display: block; }
    .pedido-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--white); border-radius: var(--radius-sm); margin-bottom: 6px; }
    .pedido-item.comprado { opacity: 0.6; }
    .pedido-item.comprado .pedido-item-nombre { text-decoration: line-through; }
    .pedido-item-check { width: 18px; height: 18px; accent-color: var(--guarda); cursor: pointer; }
    .pedido-item-nombre { flex: 1; font-size: 0.85rem; }
    .pedido-item-cantidad { font-size: 0.8rem; color: var(--text-muted); background: var(--cream); padding: 2px 8px; border-radius: 4px; }
    .pedido-item-tipo { font-size: 0.65rem; padding: 2px 6px; border-radius: 3px; }
    .pedido-item-tipo.reposicion { background: var(--sage-muted); color: var(--sage-dark); }
    .pedido-item-tipo.especial { background: var(--terracotta-muted); color: var(--terracotta); }
    .mensaje-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .mensaje-remitente { font-weight: 600; font-size: 0.9rem; }
    .mensaje-fecha { font-size: 0.75rem; color: var(--text-muted); }
    .mensaje-texto { font-size: 0.85rem; color: var(--text-light); }
    @media (max-width: 768px) { .main { padding: 16px; } .header { flex-direction: column; gap: 12px; text-align: center; } }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-info">
      <h1>üåæ Portal Guarda</h1>
      <p id="nombre-bien">Cargando...</p>
    </div>
    <button class="btn-header" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
  </header>
  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>
    <div id="content" class="hidden">
      <div class="modulos-grid" id="modulos-grid"></div>
    </div>
  </main>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script>
    let currentUser = null, externoData = null, bienData = null, bienId = null, permisosActuales = {};
    let datosModulos = { calendario: [], planSemanal: [], inventario: [], pedidos: [], buzon: [], preparacion: null };
    const diasLabels = { '0': 'Dom', '1': 'Lun', '2': 'Mar', '3': 'Mi√©', '4': 'Jue', '5': 'Vie', '6': 'S√°b' };

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarDatosExterno();
    });

    async function cargarDatosExterno() {
      try {
        // Buscar acceso como guarda usando collectionGroup
        const snap = await db.collectionGroup('guardas')
          .where('email', '==', currentUser.email.toLowerCase())
          .where('activo', '==', true)
          .limit(1).get();
          
        if (snap.empty) { 
          alert('No tienes acceso como guarda'); 
          window.location.href = 'login.html'; 
          return; 
        }
        
        externoData = { id: snap.docs[0].id, ...snap.docs[0].data() };
        bienId = externoData.bienId;
        permisosActuales = externoData.permisos || {};
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) { alert('Bien no encontrado'); return; }
        bienData = { id: bienDoc.id, ...bienDoc.data() };
        document.getElementById('nombre-bien').textContent = bienData.nombre || 'Sin nombre';
        // Primero cargar Plan Semanal (que incluye preparaci√≥n)
        await cargarPlanSemanal();
        // Luego el resto en paralelo
        await Promise.all([cargarCalendario(), cargarInventario(), cargarPedidos(), cargarBuzon()]);
        renderModulos();
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
      } catch (e) { console.error(e); alert('Error cargando datos'); }
    }

    async function cargarCalendario() {
      try {
        const hoy = new Date(), mes = new Date(); mes.setMonth(mes.getMonth() + 1);
        // Tareas agr√≠colas programadas
        const snap = await db.collection('bienes').doc(bienId).collection('tareasAgricolas')
          .where('fechaProgramada', '>=', hoy).where('fechaProgramada', '<=', mes).orderBy('fechaProgramada').limit(10).get();
        datosModulos.calendario = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { datosModulos.calendario = []; }
    }

    async function cargarPlanSemanal() {
      try {
        const hoy = new Date(), hoyNum = hoy.getDay();
        const inicio = new Date(hoy); inicio.setDate(hoy.getDate() - hoy.getDay() + 1); inicio.setHours(0,0,0,0);
        const semanaKey = inicio.toISOString().split('T')[0];
        let tareas = [];
        
        // Tareas de mantenimiento/limpieza
        const limpSnap = await db.collection('bienes').doc(bienId).collection('tareasLimpieza').get();
        limpSnap.docs.forEach(doc => {
          const dep = { id: doc.id, ...doc.data() };
          (dep.tareas || []).forEach((t, idx) => {
            if (t.dia && (t.frecuencia === 'semanal' || t.frecuencia === 'quincenal')) {
              tareas.push({ id: `lim_${dep.id}_${idx}`, tipo: 'limpieza', nombre: t.nombre, ubicacion: dep.nombre, dia: t.dia, tiempo: t.tiempo || 15, prioridad: 'normal' });
            }
          });
        });
        
        // Reparaciones programadas
        const repSnap = await db.collection('bienes').doc(bienId).collection('reparaciones').where('estado', '==', 'pendiente').get();
        repSnap.docs.forEach(doc => {
          const r = { id: doc.id, ...doc.data() };
          if (r.fechaProgramada) {
            const fp = r.fechaProgramada.toDate ? r.fechaProgramada.toDate() : new Date(r.fechaProgramada);
            if (fp >= inicio && fp <= new Date(inicio.getTime() + 7*24*60*60*1000)) {
              tareas.push({ id: `rep_${r.id}`, tipo: 'mantenimiento', nombre: r.descripcion || 'Reparaci√≥n', ubicacion: r.ubicacion || '', dia: fp.getDay().toString(), tiempo: r.tiempoEstimado || 60, prioridad: 'normal' });
            }
          }
        });

        // Tareas agr√≠colas de la semana
        const agricSnap = await db.collection('bienes').doc(bienId).collection('tareasAgricolas')
          .where('fechaProgramada', '>=', inicio)
          .where('fechaProgramada', '<=', new Date(inicio.getTime() + 7*24*60*60*1000)).get();
        agricSnap.docs.forEach(doc => {
          const t = { id: doc.id, ...doc.data() };
          const fp = t.fechaProgramada?.toDate ? t.fechaProgramada.toDate() : new Date();
          tareas.push({ id: `agr_${t.id}`, tipo: 'agricola', nombre: t.nombre || t.descripcion, ubicacion: t.parcela || '', dia: fp.getDay().toString(), tiempo: t.tiempoEstimado || 120, prioridad: 'normal' });
        });

        // PREPARACI√ìN SEMANAL (tareas extra del admin)
        try {
          const prepDoc = await db.collection('bienes').doc(bienId).collection('preparacionSemanal').doc(semanaKey).get();
          if (prepDoc.exists && prepDoc.data().estado === 'enviado') {
            const prep = prepDoc.data();
            (prep.tareas || []).forEach((t, idx) => {
              tareas.push({ id: `prep_${semanaKey}_${idx}`, tipo: 'extra', nombre: t.titulo, ubicacion: '', dia: t.dia || '', tiempo: t.tiempo || 0, prioridad: t.prioridad || 'normal' });
            });
            datosModulos.preparacion = prep;
          }
        } catch (e) {}

        let completados = {};
        try { const c = await db.collection('bienes').doc(bienId).collection('planSemanalCompletados').doc(semanaKey).get(); if (c.exists) completados = c.data().tareas || {}; } catch (e) {}
        datosModulos.planSemanal = tareas.map(t => ({ ...t, completada: !!completados[t.id], semanaKey, esHoy: parseInt(t.dia) === hoyNum }))
          .sort((a, b) => ((parseInt(a.dia) || 7) - (parseInt(b.dia) || 7)));
      } catch (e) { datosModulos.planSemanal = []; }
    }

    async function cargarInventario() {
      try { const snap = await db.collection('bienes').doc(bienId).collection('inventario').orderBy('nombre').get(); datosModulos.inventario = snap.docs.map(d => ({ id: d.id, ...d.data() })); } catch (e) { datosModulos.inventario = []; }
    }

    async function cargarPedidos() {
      try { const snap = await db.collection('bienes').doc(bienId).collection('pedidos').where('estado', 'in', ['pendiente', 'en_proceso']).orderBy('fechaCreacion', 'desc').limit(10).get(); datosModulos.pedidos = snap.docs.map(d => ({ id: d.id, ...d.data() })); } catch (e) { datosModulos.pedidos = []; }
    }

    async function cargarBuzon() {
      try {
        const msgs = await db.collection('bienes').doc(bienId).collection('mensajes').orderBy('fecha', 'desc').limit(5).get();
        const notifs = await db.collection('bienes').doc(bienId).collection('notificaciones').where('paraExterno', '==', true).orderBy('fecha', 'desc').limit(5).get();
        datosModulos.buzon = [...msgs.docs.map(d => ({ id: d.id, tipo: 'mensaje', ...d.data() })), ...notifs.docs.map(d => ({ id: d.id, tipo: 'notificacion', ...d.data() }))]
          .sort((a, b) => (b.fecha?.toDate?.() || 0) - (a.fecha?.toDate?.() || 0)).slice(0, 10);
      } catch (e) { datosModulos.buzon = []; }
    }

    function renderModulos() {
      let html = '';
      html += renderCalendario();
      html += renderPlanSemanal();
      if (permisosActuales.inventario?.ver) html += renderInventario();
      html += renderPedidos();
      html += renderBuzon();
      document.getElementById('modulos-grid').innerHTML = html || '<div class="modulo-card-empty">Sin m√≥dulos</div>';
    }

    function renderCalendario() {
      const items = datosModulos.calendario;
      let body = items.length === 0 ? '<div class="modulo-card-empty">üìÖ Sin tareas agr√≠colas pr√≥ximas</div>' :
        items.map(i => {
          const f = i.fechaProgramada?.toDate ? i.fechaProgramada.toDate() : new Date();
          return `<div class="item-card ${f.toDateString() === new Date().toDateString() ? 'hoy' : ''}"><span class="item-icon">üåæ</span><div class="item-info"><div class="item-title">${i.nombre || i.descripcion || 'Tarea'}</div><div class="item-meta"><span>${f.toLocaleDateString('es-ES', {day:'numeric',month:'short'})}</span>${i.parcela ? `<span>üìç ${i.parcela}</span>` : ''}</div></div></div>`;
        }).join('');
      return `<div class="modulo-card"><div class="modulo-card-header"><div class="modulo-card-title">üìÖ Calendario Agr√≠cola</div></div><div class="modulo-card-body">${body}</div></div>`;
    }

    function renderPlanSemanal() {
      const t = datosModulos.planSemanal, c = t.filter(x => x.completada).length, tot = t.length, prog = tot > 0 ? Math.round(c/tot*100) : 0;
      let body = t.length === 0 ? '<div class="modulo-card-empty">üìã Sin tareas esta semana</div>' :
        `<div class="plan-progreso"><div class="plan-progreso-bar" style="width:${prog}%"></div></div>` +
        t.map(x => {
          const tc = x.tipo === 'limpieza' ? 'tipo-limpieza' : x.tipo === 'agricola' ? 'tipo-agricola' : 'tipo-mantenimiento';
          const icon = x.tipo === 'limpieza' ? 'üßπ' : x.tipo === 'agricola' ? 'üåæ' : 'üîß';
          return `<div class="plan-tarea ${x.completada ? 'completada' : ''} ${x.esHoy ? 'hoy' : ''}"><input type="checkbox" class="plan-tarea-check" ${x.completada ? 'checked' : ''} onchange="toggleTarea('${x.id}','${x.semanaKey}',this.checked)"><div class="plan-tarea-info"><div class="plan-tarea-titulo">${icon} ${x.nombre}</div><div class="plan-tarea-meta"><span class="plan-tipo ${tc}">${x.tipo}</span><span>${diasLabels[x.dia]}</span><span>‚è±Ô∏è${x.tiempo}m</span></div></div></div>`;
        }).join('');
      return `<div class="modulo-card"><div class="modulo-card-header"><div class="modulo-card-title">üìã Plan Semanal ${tot > 0 ? `<span class="modulo-badge">${c}/${tot}</span>` : ''}</div></div><div class="modulo-card-body">${body}</div></div>`;
    }

    function renderInventario() {
      const items = datosModulos.inventario, bajos = items.filter(i => i.cantidad <= (i.minimo || 2));
      let body = items.length === 0 ? '<div class="modulo-card-empty">üì¶ Sin art√≠culos</div>' :
        items.slice(0, 10).map(i => `<div class="inventario-item ${i.cantidad <= (i.minimo || 2) ? 'bajo' : ''}"><span class="inventario-nombre">${i.nombre}</span><span class="inventario-stock ${i.cantidad <= (i.minimo || 2) ? 'bajo' : ''}">${i.cantidad} ${i.unidad || 'uds'}</span></div>`).join('');
      return `<div class="modulo-card"><div class="modulo-card-header"><div class="modulo-card-title">üì¶ Inventario ${bajos.length > 0 ? `<span class="modulo-badge">${bajos.length} bajo</span>` : ''}</div></div><div class="modulo-card-body">${body}</div>${permisosActuales.inventario?.crear ? `<div class="modulo-card-footer"><button class="btn btn-guarda" onclick="tomaInventario()">üìù Toma inventario</button></div>` : ''}</div>`;
    }

    function renderPedidos() {
      const pedidos = datosModulos.pedidos;
      const pendientes = pedidos.filter(p => calcularEstadoPedido(p) === 'pendiente').length;
      let html = '';
      if (pedidos.length === 0) {
        html = '<div class="modulo-card-empty">üõí Sin pedidos</div>';
      } else {
        html = pedidos.map(p => {
          const estado = calcularEstadoPedido(p);
          const { comprados, total } = contarItemsPedido(p);
          const progreso = total > 0 ? Math.round((comprados / total) * 100) : 0;
          const fecha = p.fechaCreacion?.toDate?.().toLocaleDateString('es-ES', {day:'numeric',month:'short'}) || '';
          return `
            <div class="pedido-card ${estado === 'pendiente' ? 'urgente' : estado === 'en_curso' ? 'en-curso' : 'completado'}" id="pedido-${p.id}">
              <div class="pedido-header" onclick="togglePedido('${p.id}')">
                <span class="pedido-icon">üõí</span>
                <div class="pedido-info">
                  <div class="pedido-titulo">${p.nidoNombre || 'Pedido'}</div>
                  <div class="pedido-meta"><span>${fecha}</span><span>${total} productos</span></div>
                </div>
                <div class="pedido-progreso">
                  <div class="pedido-progreso-bar"><div class="pedido-progreso-fill" style="width:${progreso}%"></div></div>
                  <span class="pedido-progreso-text">${comprados}/${total}</span>
                </div>
                <span class="pedido-toggle">‚ñº</span>
              </div>
              <div class="pedido-items">
                ${(p.items || []).map((item, idx) => `
                  <div class="pedido-item ${item.comprado ? 'comprado' : ''}">
                    <input type="checkbox" class="pedido-item-check" ${item.comprado ? 'checked' : ''} onchange="toggleItemPedido('${p.id}', ${idx}, this.checked)">
                    <span class="pedido-item-nombre">${item.nombre || item.id}</span>
                    <span class="pedido-item-cantidad">√ó${item.cantidad || 1}</span>
                    <span class="pedido-item-tipo ${item.tipo}">${item.tipo === 'reposicion' ? 'Repos.' : 'Extra'}</span>
                  </div>
                `).join('')}
              </div>
            </div>`;
        }).join('');
      }
      return `<div class="modulo-card"><div class="modulo-card-header"><div class="modulo-card-title">üõí Pedidos ${pendientes > 0 ? `<span class="modulo-badge">${pendientes}</span>` : ''}</div></div><div class="modulo-card-body">${html}</div></div>`;
    }

    function calcularEstadoPedido(p) {
      const items = p.items || [];
      if (items.length === 0) return 'pendiente';
      const c = items.filter(i => i.comprado).length;
      if (c === 0) return 'pendiente';
      if (c === items.length) return 'completado';
      return 'en_curso';
    }

    function contarItemsPedido(p) {
      const items = p.items || [];
      return { comprados: items.filter(i => i.comprado).length, total: items.length };
    }

    function togglePedido(id) {
      const card = document.getElementById(`pedido-${id}`);
      if (card) card.classList.toggle('expanded');
    }

    async function toggleItemPedido(pedidoId, itemIdx, comprado) {
      try {
        const pedido = datosModulos.pedidos.find(p => p.id === pedidoId);
        if (!pedido || !pedido.items[itemIdx]) return;
        pedido.items[itemIdx].comprado = comprado;
        if (comprado) { pedido.items[itemIdx].compradoPor = currentUser.uid; pedido.items[itemIdx].fechaComprado = new Date().toISOString(); }
        else { delete pedido.items[itemIdx].compradoPor; delete pedido.items[itemIdx].fechaComprado; }
        await db.collection('bienes').doc(bienId).collection('pedidos').doc(pedidoId).update({ items: pedido.items, fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp() });
        renderModulos();
      } catch (e) { console.error(e); alert('Error al actualizar'); }
    }

    function renderBuzon() {
      const items = datosModulos.buzon, nl = items.filter(i => !i.leido).length;
      let body = items.length === 0 ? '<div class="modulo-card-empty">üì¨ Sin mensajes</div>' :
        items.map(i => `<div class="mensaje-card ${!i.leido ? 'no-leido' : ''} ${i.tipo === 'notificacion' ? 'notificacion' : ''}"><div class="mensaje-header"><span class="mensaje-remitente">${i.tipo === 'notificacion' ? 'üîî Notificaci√≥n' : i.remitente || 'Sistema'}</span><span class="mensaje-fecha">${i.fecha?.toDate?.().toLocaleDateString('es-ES', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}) || ''}</span></div><div class="mensaje-texto">${i.texto || i.mensaje || ''}</div></div>`).join('');
      return `<div class="modulo-card"><div class="modulo-card-header"><div class="modulo-card-title">üì¨ Buz√≥n ${nl > 0 ? `<span class="modulo-badge">${nl}</span>` : ''}</div></div><div class="modulo-card-body">${body}</div></div>`;
    }

    async function toggleTarea(id, sk, done) {
      const ref = db.collection('bienes').doc(bienId).collection('planSemanalCompletados').doc(sk);
      if (done) await ref.set({ [`tareas.${id}`]: { completada: true, fecha: new Date().toISOString(), por: currentUser.uid } }, { merge: true });
      else await ref.set({ [`tareas.${id}`]: firebase.firestore.FieldValue.delete() }, { merge: true });
      const t = datosModulos.planSemanal.find(x => x.id === id); if (t) t.completada = done;
      renderModulos();
    }

    function tomaInventario() { alert('Toma de inventario - Por implementar'); }
    function cerrarSesion() { auth.signOut().then(() => window.location.href = 'login.html'); }
  </script>
</body>
</html>
