<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Tareas Limpieza</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
      --mayordomo: #8B7355;
      --mayordomo-muted: rgba(139, 115, 85, 0.15);
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header {
      background: var(--white);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      padding: 8px 14px;
      background: var(--cream);
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      color: var(--text-light);
      text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover { background: var(--cream-dark); color: var(--text); }
    .page-title { font-family: 'Quicksand', sans-serif; font-size: 1.25rem; font-weight: 600; }

    .btn {
      padding: 10px 20px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-secondary { background: var(--cream-dark); color: var(--text); }
    .btn-primary { background: var(--sage); color: var(--white); }
    .btn-primary:hover { background: var(--sage-dark); }
    .btn-danger { background: var(--error); color: var(--white); }
    .btn-small { padding: 6px 12px; font-size: 0.8rem; }

    .main { max-width: 1000px; margin: 0 auto; padding: 24px; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 80px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--sage); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* Filtros */
    .filtros-bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding: 16px;
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
    }
    .filtro-btn {
      padding: 8px 16px;
      border: 2px solid var(--cream-dark);
      background: var(--white);
      border-radius: var(--radius-full);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s;
    }
    .filtro-btn:hover { border-color: var(--sage); color: var(--sage); }
    .filtro-btn.active { background: var(--sage); border-color: var(--sage); color: var(--white); }
    .filtro-btn .count { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 4px; }
    .filtro-btn.active .count { background: rgba(255,255,255,0.3); }

    /* Zonas */
    .zona-section { margin-bottom: 24px; }
    .zona-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: var(--sage);
      color: var(--white);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    .zona-title { display: flex; align-items: center; gap: 10px; font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 600; }
    .zona-count { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.8rem; }
    .zona-content { background: var(--white); border-radius: 0 0 var(--radius-lg) var(--radius-lg); box-shadow: var(--shadow-soft); }

    /* Dependencias */
    .dependencia-card { border-bottom: 1px solid var(--cream-dark); padding: 16px 20px; }
    .dependencia-card:last-child { border-bottom: none; }
    .dependencia-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .dependencia-title { font-weight: 600; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
    .dependencia-toggle { color: var(--text-muted); font-size: 1.2rem; transition: transform 0.3s; }
    .dependencia-card.expanded .dependencia-toggle { transform: rotate(180deg); }
    .dependencia-actions { display: flex; gap: 8px; align-items: center; }
    .dependencia-content { display: none; padding-top: 16px; }
    .dependencia-card.expanded .dependencia-content { display: block; }

    /* Tareas */
    .tarea-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--cream);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }
    .tarea-item:hover { background: var(--cream-dark); }
    .tarea-info { flex: 1; }
    .tarea-nombre { font-weight: 600; font-size: 0.9rem; }
    .tarea-meta { display: flex; gap: 8px; font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; flex-wrap: wrap; }
    .tarea-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .badge-tiempo { background: var(--sage-muted); color: var(--sage-dark); }
    .badge-frecuencia { background: var(--mayordomo-muted); color: var(--mayordomo); }
    .badge-dia { background: var(--terracotta-muted); color: var(--terracotta); }
    .tarea-btn { padding: 6px 10px; background: transparent; border: none; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted); }
    .tarea-btn:hover { background: var(--cream-dark); color: var(--text); }
    .tarea-btn.delete:hover { color: var(--error); }

    .add-item-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      border: 2px dashed var(--cream-dark);
      background: transparent;
      border-radius: var(--radius-sm);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
    }
    .add-item-btn:hover { border-color: var(--sage); color: var(--sage); background: var(--sage-muted); }

    .add-dependencia-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      border: 2px dashed var(--cream-dark);
      background: var(--white);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      color: var(--text-muted);
      cursor: pointer;
      margin: 12px;
    }
    .add-dependencia-btn:hover { border-color: var(--sage); color: var(--sage); }

    .empty-zona { text-align: center; padding: 40px; color: var(--text-muted); }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--white); border-radius: var(--radius-lg); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--cream-dark); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-family: 'Quicksand', sans-serif; font-size: 1.15rem; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--cream-dark); display: flex; gap: 12px; justify-content: flex-end; }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-input, .form-select { width: 100%; padding: 12px 14px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.95rem; }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--sage); }

    @media (max-width: 600px) {
      .filtros-bar { justify-content: center; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
      <h1 class="page-title">üìã Tareas Limpieza</h1>
    </div>
  </header>

  <main class="main">
    <div id="page-loading" class="loading"><div class="spinner"></div></div>

    <div id="page-content" class="hidden">
      <!-- Filtros por zona -->
      <div class="filtros-bar" id="filtros-bar">
        <button class="filtro-btn active" data-zona="todas">Todas</button>
        <button class="filtro-btn" data-zona="dormitorios">üõèÔ∏è Dormitorios <span class="count" id="count-dormitorios">0</span></button>
        <button class="filtro-btn" data-zona="banos">üöø Ba√±os <span class="count" id="count-banos">0</span></button>
        <button class="filtro-btn" data-zona="cocinas">üç≥ Cocinas <span class="count" id="count-cocinas">0</span></button>
        <button class="filtro-btn" data-zona="salones">üõãÔ∏è Salones <span class="count" id="count-salones">0</span></button>
        <button class="filtro-btn" data-zona="comedor">üçΩÔ∏è Comedor <span class="count" id="count-comedor">0</span></button>
        <button class="filtro-btn" data-zona="almacenes">üì¶ Almacenes <span class="count" id="count-almacenes">0</span></button>
        <button class="filtro-btn" data-zona="otros">üè† Otros <span class="count" id="count-otros">0</span></button>
      </div>

      <div id="zonas-container"></div>
    </div>
  </main>

  <!-- Modal Dependencia -->
  <div class="modal-overlay" id="modal-dependencia">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-dep-title">Nueva dependencia</h3>
        <button class="modal-close" onclick="cerrarModal()">√ó</button>
      </div>
      <form id="form-dependencia">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nombre *</label>
            <input type="text" class="form-input" id="dep-nombre" placeholder="Ej: Dormitorio principal, Ba√±o suite..." required>
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-input" id="dep-notas" rows="2" placeholder="Observaciones..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger hidden" id="btn-eliminar-dep" onclick="eliminarDependencia()">Eliminar</button>
          <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Tarea -->
  <div class="modal-overlay" id="modal-tarea">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-tarea-title">Nueva tarea</h3>
        <button class="modal-close" onclick="cerrarModal()">√ó</button>
      </div>
      <form id="form-tarea">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Tarea *</label>
            <input type="text" class="form-input" id="tarea-nombre" placeholder="Ej: Fregar suelo, Limpiar cristales..." required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Tiempo</label>
              <select class="form-select" id="tarea-tiempo">
                <option value="5">5 min</option>
                <option value="10">10 min</option>
                <option value="15" selected>15 min</option>
                <option value="30">30 min</option>
                <option value="45">45 min</option>
                <option value="60">1 hora</option>
                <option value="90">1h 30min</option>
                <option value="120">2 horas</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Periodicidad</label>
              <select class="form-select" id="tarea-frecuencia" onchange="toggleDia()">
                <option value="cada-uso">Cada uso</option>
                <option value="diaria">Diaria</option>
                <option value="semanal">Semanal</option>
                <option value="quincenal">Quincenal</option>
                <option value="mensual">Mensual</option>
              </select>
            </div>
          </div>
          <div class="form-group" id="grupo-dia" style="display:none;">
            <label class="form-label">¬øQu√© d√≠a?</label>
            <select class="form-select" id="tarea-dia">
              <option value="1">Lunes</option>
              <option value="2">Martes</option>
              <option value="3">Mi√©rcoles</option>
              <option value="4">Jueves</option>
              <option value="5">Viernes</option>
              <option value="6">S√°bado</option>
              <option value="0">Domingo</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea class="form-input" id="tarea-notas" rows="2" placeholder="Instrucciones, productos..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger hidden" id="btn-eliminar-tarea" onclick="eliminarTarea()">Eliminar</button>
          <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let bienId = null;
    let currentUser = null;
    let dependenciasData = [];
    let filtroActual = 'todas';
    let editingDepId = null;
    let editingTareaIdx = null;
    let currentZona = null;
    let currentDepId = null;

    const ZONAS = {
      dormitorios: { icon: 'üõèÔ∏è', label: 'Dormitorios' },
      banos: { icon: 'üöø', label: 'Ba√±os' },
      cocinas: { icon: 'üç≥', label: 'Cocinas' },
      salones: { icon: 'üõãÔ∏è', label: 'Salones' },
      comedor: { icon: 'üçΩÔ∏è', label: 'Comedor' },
      almacenes: { icon: 'üì¶', label: 'Almacenes' },
      otros: { icon: 'üè†', label: 'Otros' }
    };

    const frecuenciaLabels = { 'cada-uso': 'Cada uso', 'diaria': 'Diaria', 'semanal': 'Semanal', 'quincenal': 'Quincenal', 'mensual': 'Mensual' };
    const diasLabels = { '0': 'Dom', '1': 'Lun', '2': 'Mar', '3': 'Mi√©', '4': 'Jue', '5': 'Vie', '6': 'S√°b' };

    const urlParams = new URLSearchParams(window.location.search);
    bienId = urlParams.get('id');
    const origen = urlParams.get('origen') || 'limpieza';
    document.getElementById('btn-volver').href = `limpieza.html?id=${bienId}&origen=${origen}`;
    if (!bienId) window.location.href = 'lo-comun.html';

    document.querySelectorAll('.filtro-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filtroActual = btn.dataset.zona;
        render();
      });
    });

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarDatos();
      document.getElementById('page-loading').classList.add('hidden');
      document.getElementById('page-content').classList.remove('hidden');
    });

    async function cargarDatos() {
      try {
        const snap = await db.collection('bienes').doc(bienId).collection('tareasLimpieza').get();
        dependenciasData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { dependenciasData = []; }
      render();
    }

    function contarPorZona(zona) {
      return dependenciasData.filter(d => d.zona === zona).length;
    }

    function actualizarContadores() {
      Object.keys(ZONAS).forEach(zona => {
        const el = document.getElementById(`count-${zona}`);
        if (el) el.textContent = contarPorZona(zona);
      });
    }

    function render() {
      const container = document.getElementById('zonas-container');
      actualizarContadores();
      let html = '';

      if (filtroActual === 'todas') {
        Object.keys(ZONAS).forEach(zonaKey => { html += renderZona(zonaKey); });
      } else {
        html = renderZona(filtroActual);
      }

      container.innerHTML = html;

      document.querySelectorAll('.dependencia-header').forEach(header => {
        header.addEventListener('click', (e) => {
          if (!e.target.closest('button')) header.closest('.dependencia-card').classList.toggle('expanded');
        });
      });
    }

    function renderZona(zonaKey) {
      const zona = ZONAS[zonaKey];
      const deps = dependenciasData.filter(d => d.zona === zonaKey);

      let depsHtml = deps.length === 0 
        ? `<div class="empty-zona">Sin dependencias</div>`
        : deps.map(dep => renderDependencia(dep)).join('');

      return `
        <div class="zona-section">
          <div class="zona-header">
            <div class="zona-title"><span>${zona.icon}</span> ${zona.label}</div>
            <span class="zona-count">${deps.length}</span>
          </div>
          <div class="zona-content">
            ${depsHtml}
            <button class="add-dependencia-btn" onclick="abrirModalDependencia('${zonaKey}')">+ A√±adir dependencia</button>
          </div>
        </div>
      `;
    }

    function renderDependencia(dep) {
      const tareas = dep.tareas || [];
      let tareasHtml = tareas.map((t, idx) => `
        <div class="tarea-item">
          <span>üßπ</span>
          <div class="tarea-info">
            <div class="tarea-nombre">${t.nombre}</div>
            <div class="tarea-meta">
              ${t.tiempo ? `<span class="tarea-badge badge-tiempo">‚è±Ô∏è ${t.tiempo}m</span>` : ''}
              <span class="tarea-badge badge-frecuencia">${frecuenciaLabels[t.frecuencia] || t.frecuencia}</span>
              ${t.dia ? `<span class="tarea-badge badge-dia">${diasLabels[t.dia]}</span>` : ''}
            </div>
          </div>
          <button class="tarea-btn" onclick="editarTarea('${dep.id}', ${idx})">‚úèÔ∏è</button>
          <button class="tarea-btn delete" onclick="confirmarEliminarTarea('${dep.id}', ${idx})">üóëÔ∏è</button>
        </div>
      `).join('');

      return `
        <div class="dependencia-card" data-id="${dep.id}">
          <div class="dependencia-header">
            <div class="dependencia-title">${ZONAS[dep.zona]?.icon || 'üè†'} ${dep.nombre} <span style="color:var(--text-muted);font-size:0.8rem">(${tareas.length})</span></div>
            <div class="dependencia-actions">
              <button class="btn btn-small btn-secondary" onclick="editarDependencia('${dep.id}')">‚úèÔ∏è</button>
              <span class="dependencia-toggle">‚ñº</span>
            </div>
          </div>
          <div class="dependencia-content">
            <div class="tareas-list">${tareasHtml || '<div style="color:var(--text-muted);padding:12px">Sin tareas</div>'}</div>
            <button class="add-item-btn" onclick="abrirModalTarea('${dep.id}')">+ A√±adir tarea</button>
          </div>
        </div>
      `;
    }

    function toggleDia() {
      const f = document.getElementById('tarea-frecuencia').value;
      document.getElementById('grupo-dia').style.display = (f === 'semanal' || f === 'quincenal') ? 'block' : 'none';
    }

    function abrirModalDependencia(zona, dep = null) {
      editingDepId = dep ? dep.id : null;
      currentZona = zona;
      document.getElementById('modal-dep-title').textContent = dep ? '‚úèÔ∏è Editar' : `üè† Nueva en ${ZONAS[zona].label}`;
      document.getElementById('btn-eliminar-dep').classList.toggle('hidden', !dep);
      document.getElementById('dep-nombre').value = dep?.nombre || '';
      document.getElementById('dep-notas').value = dep?.notas || '';
      document.getElementById('modal-dependencia').classList.add('active');
    }

    function editarDependencia(id) {
      const dep = dependenciasData.find(d => d.id === id);
      if (dep) abrirModalDependencia(dep.zona, dep);
    }

    document.getElementById('form-dependencia').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = { nombre: document.getElementById('dep-nombre').value, notas: document.getElementById('dep-notas').value, zona: currentZona };
      try {
        if (editingDepId) {
          const existing = dependenciasData.find(d => d.id === editingDepId);
          data.tareas = existing?.tareas || [];
          await db.collection('bienes').doc(bienId).collection('tareasLimpieza').doc(editingDepId).update(data);
          const idx = dependenciasData.findIndex(d => d.id === editingDepId);
          if (idx !== -1) dependenciasData[idx] = { ...dependenciasData[idx], ...data };
        } else {
          data.tareas = [];
          const ref = await db.collection('bienes').doc(bienId).collection('tareasLimpieza').add(data);
          dependenciasData.push({ id: ref.id, ...data });
        }
        cerrarModal(); render();
      } catch (e) { alert('Error'); }
    });

    async function eliminarDependencia() {
      if (!editingDepId || !confirm('¬øEliminar dependencia?')) return;
      await db.collection('bienes').doc(bienId).collection('tareasLimpieza').doc(editingDepId).delete();
      dependenciasData = dependenciasData.filter(d => d.id !== editingDepId);
      cerrarModal(); render();
    }

    function abrirModalTarea(depId, idx = null) {
      currentDepId = depId;
      editingTareaIdx = idx;
      const dep = dependenciasData.find(d => d.id === depId);
      const t = idx !== null ? dep?.tareas?.[idx] : null;
      document.getElementById('modal-tarea-title').textContent = t ? '‚úèÔ∏è Editar tarea' : 'üßπ Nueva tarea';
      document.getElementById('btn-eliminar-tarea').classList.toggle('hidden', !t);
      document.getElementById('tarea-nombre').value = t?.nombre || '';
      document.getElementById('tarea-tiempo').value = t?.tiempo || '15';
      document.getElementById('tarea-frecuencia').value = t?.frecuencia || 'semanal';
      document.getElementById('tarea-dia').value = t?.dia || '1';
      document.getElementById('tarea-notas').value = t?.notas || '';
      toggleDia();
      document.getElementById('modal-tarea').classList.add('active');
    }

    function editarTarea(depId, idx) { abrirModalTarea(depId, idx); }

    document.getElementById('form-tarea').addEventListener('submit', async (e) => {
      e.preventDefault();
      const dep = dependenciasData.find(d => d.id === currentDepId);
      if (!dep) return;
      const f = document.getElementById('tarea-frecuencia').value;
      const data = {
        nombre: document.getElementById('tarea-nombre').value,
        tiempo: parseInt(document.getElementById('tarea-tiempo').value) || 15,
        frecuencia: f,
        dia: (f === 'semanal' || f === 'quincenal') ? document.getElementById('tarea-dia').value : null,
        notas: document.getElementById('tarea-notas').value
      };
      if (!dep.tareas) dep.tareas = [];
      if (editingTareaIdx !== null) dep.tareas[editingTareaIdx] = data;
      else dep.tareas.push(data);
      await db.collection('bienes').doc(bienId).collection('tareasLimpieza').doc(currentDepId).update({ tareas: dep.tareas });
      cerrarModal(); render();
    });

    function confirmarEliminarTarea(depId, idx) {
      if (confirm('¬øEliminar tarea?')) eliminarTareaDirecto(depId, idx);
    }

    async function eliminarTareaDirecto(depId, idx) {
      const dep = dependenciasData.find(d => d.id === depId);
      if (!dep?.tareas) return;
      dep.tareas.splice(idx, 1);
      await db.collection('bienes').doc(bienId).collection('tareasLimpieza').doc(depId).update({ tareas: dep.tareas });
      render();
    }

    async function eliminarTarea() {
      if (editingTareaIdx !== null && currentDepId) { await eliminarTareaDirecto(currentDepId, editingTareaIdx); cerrarModal(); }
    }

    function cerrarModal() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
      editingDepId = null; editingTareaIdx = null; currentDepId = null; currentZona = null;
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) cerrarModal(); });
    });
  </script>
</body>
</html>
