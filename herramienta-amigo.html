<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Amigo Invisible</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Sistema de notificaciones internas -->
  <style>
    :root {
      --sage: #7A9E7E; --sage-light: #9BB89E; --sage-dark: #5C7D5F; --sage-muted: rgba(122,158,126,0.15);
      --cream: #FDF8F3; --cream-dark: #F5EDE4;
      --terracotta: #C17757; --terracotta-muted: rgba(193,119,87,0.15);
      --text: #3D3D3D; --text-light: #6B6B6B; --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06); --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-full: 50px;
      --success: #7DB59A; --error: #D4695A;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header { background: var(--white); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-soft); position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--cream); border: none; border-radius: var(--radius-md); font-family: 'Nunito', sans-serif; font-size: 0.85rem; color: var(--text-light); cursor: pointer; text-decoration: none; transition: all 0.2s; }
    .back-btn:hover { background: var(--cream-dark); color: var(--text); }
    .page-icon { font-size: 1.5rem; }

    .main { max-width: 800px; margin: 0 auto; padding: 24px; }

    .page-header { margin-bottom: 24px; }
    .page-title { font-family: 'Quicksand', sans-serif; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }
    .page-subtitle { color: var(--text-muted); font-size: 0.9rem; }

    /* Wizard steps */
    .wizard-steps {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }

    .wizard-step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--cream-dark);
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.3s;
    }

    .wizard-step.active {
      background: var(--sage);
      color: white;
    }

    .wizard-step.completed {
      background: var(--sage-muted);
      color: var(--sage-dark);
    }

    .wizard-step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }

    .wizard-step.active .wizard-step-number {
      background: rgba(255,255,255,0.3);
    }

    .wizard-step.completed .wizard-step-number {
      background: var(--sage);
      color: white;
    }

    /* Card */
    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--cream-dark);
    }

    .card-title {
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-body { padding: 24px; }

    .card-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--cream-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Steps content */
    .step-content { display: none; }
    .step-content.active { display: block; }

    /* Selector tipo */
    .tipo-selector {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .tipo-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .tipo-option:hover { border-color: var(--sage-light); }
    .tipo-option.selected { border-color: var(--sage); background: var(--sage-muted); }

    .tipo-option input { display: none; }

    .tipo-radio {
      width: 20px;
      height: 20px;
      border: 2px solid var(--text-muted);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tipo-option.selected .tipo-radio {
      border-color: var(--sage);
    }

    .tipo-option.selected .tipo-radio::after {
      content: '';
      width: 10px;
      height: 10px;
      background: var(--sage);
      border-radius: 50%;
    }

    .tipo-info { flex: 1; }
    .tipo-nombre { font-weight: 700; margin-bottom: 2px; }
    .tipo-desc { font-size: 0.8rem; color: var(--text-muted); }

    /* Lista selecci√≥n */
    .seleccion-lista {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-md);
      margin-top: 16px;
    }

    .seleccion-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--cream-dark);
      cursor: pointer;
      transition: background 0.2s;
    }

    .seleccion-item:last-child { border-bottom: none; }
    .seleccion-item:hover { background: var(--cream); }

    .seleccion-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--sage);
    }

    .seleccion-item-info { flex: 1; }
    .seleccion-item-nombre { font-weight: 600; }
    .seleccion-item-detalle { font-size: 0.8rem; color: var(--text-muted); }

    .seleccion-item-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--sage-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--sage-dark);
      font-size: 0.85rem;
    }

    .seleccion-header {
      padding: 12px 16px;
      background: var(--cream);
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-light);
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Presupuesto */
    .presupuesto-input {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 24px 0;
    }

    .presupuesto-input input {
      width: 150px;
      padding: 14px 18px;
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      border: 2px solid var(--cream-dark);
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
    }

    .presupuesto-input input:focus {
      outline: none;
      border-color: var(--sage);
    }

    .presupuesto-input span {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--sage-dark);
    }

    /* Botones */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-primary { background: var(--sage); color: white; }
    .btn-primary:hover { background: var(--sage-dark); transform: translateY(-2px); }
    .btn-primary:disabled { background: var(--text-muted); cursor: not-allowed; transform: none; }

    .btn-secondary { background: var(--cream); color: var(--text); }
    .btn-secondary:hover { background: var(--cream-dark); }

    .btn-success { background: var(--success); color: white; }
    .btn-lg { padding: 16px 32px; font-size: 1rem; }

    /* Contador */
    .contador {
      background: var(--sage-muted);
      padding: 8px 16px;
      border-radius: var(--radius-full);
      font-weight: 600;
      color: var(--sage-dark);
      font-size: 0.85rem;
    }

    /* Resultado */
    .resultado-exito {
      text-align: center;
      padding: 40px 20px;
    }

    .resultado-icon {
      font-size: 4rem;
      margin-bottom: 16px;
    }

    .resultado-titulo {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--sage-dark);
    }

    .resultado-mensaje {
      color: var(--text-light);
      margin-bottom: 24px;
    }

    /* Tabla asignaciones (solo admin) */
    .asignaciones-admin {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--cream-dark);
    }

    .asignaciones-admin-title {
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .asignacion-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--cream-dark);
      font-size: 0.9rem;
    }

    .asignacion-row:last-child { border-bottom: none; }

    .asignacion-flecha {
      color: var(--sage);
      font-weight: 700;
    }

    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--cream-dark);
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      font-weight: 600;
      color: var(--text-light);
    }

    .hidden { display: none !important; }

    /* Alert */
    .alert {
      padding: 14px 18px;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .alert-error {
      background: rgba(212, 105, 90, 0.15);
      color: #a84a32;
      border: 1px solid var(--error);
    }

    .alert-warning {
      background: rgba(193, 119, 87, 0.15);
      color: var(--terracotta);
      border: 1px solid var(--terracotta);
    }

    /* Historial */
    .historial-item {
      background: var(--cream);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 12px;
    }

    .historial-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .historial-item-nombre {
      font-weight: 700;
      font-family: 'Quicksand', sans-serif;
    }

    .historial-item-fecha {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .historial-item-presupuesto {
      background: var(--sage-muted);
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--sage-dark);
    }

    .historial-item-meta {
      font-size: 0.85rem;
      color: var(--text-light);
      display: flex;
      gap: 16px;
      margin-bottom: 10px;
    }

    .historial-item-participantes {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .historial-item-actions {
      display: flex;
      justify-content: flex-end;
      padding-top: 8px;
      border-top: 1px solid var(--cream-dark);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="activacion.html" class="back-btn">‚Üê Activaci√≥n</a>
      <span class="page-icon">üéÅ</span>
    </div>
  </header>

  <main class="main">
    <div class="page-header">
      <h1 class="page-title">üéÅ Amigo Invisible</h1>
      <p class="page-subtitle">Organiza el sorteo de regalos familiar</p>
    </div>

    <!-- Wizard Steps -->
    <div class="wizard-steps" id="wizard-steps">
      <div class="wizard-step active" data-step="1">
        <span class="wizard-step-number">1</span>
        <span>Participantes</span>
      </div>
      <div class="wizard-step" data-step="2">
        <span class="wizard-step-number">2</span>
        <span>Presupuesto</span>
      </div>
      <div class="wizard-step" data-step="3">
        <span class="wizard-step-number">3</span>
        <span>Sorteo</span>
      </div>
    </div>

    <!-- STEP 1: Participantes -->
    <div class="step-content active" id="step-1">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üë• ¬øQui√©nes participan?</h2>
        </div>
        <div class="card-body">
          <div id="alert-step1" class="alert alert-error hidden"></div>
          
          <div class="tipo-selector">
            <label class="tipo-option selected" onclick="seleccionarTipo('todos')">
              <input type="radio" name="tipo" value="todos" checked>
              <div class="tipo-radio"></div>
              <div class="tipo-info">
                <div class="tipo-nombre">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Todos</div>
                <div class="tipo-desc">Todos los miembros de la familia</div>
              </div>
            </label>
            <label class="tipo-option" onclick="seleccionarTipo('generaciones')">
              <input type="radio" name="tipo" value="generaciones">
              <div class="tipo-radio"></div>
              <div class="tipo-info">
                <div class="tipo-nombre">üë¥üë®üë¶ Por generaci√≥n</div>
                <div class="tipo-desc">Selecciona generaciones espec√≠ficas</div>
              </div>
            </label>
            <label class="tipo-option" onclick="seleccionarTipo('nidos')">
              <input type="radio" name="tipo" value="nidos">
              <div class="tipo-radio"></div>
              <div class="tipo-info">
                <div class="tipo-nombre">üè† Por nido</div>
                <div class="tipo-desc">Selecciona nidos completos</div>
              </div>
            </label>
            <label class="tipo-option" onclick="seleccionarTipo('personas')">
              <input type="radio" name="tipo" value="personas">
              <div class="tipo-radio"></div>
              <div class="tipo-info">
                <div class="tipo-nombre">üë§ Selecci√≥n manual</div>
                <div class="tipo-desc">Elige persona por persona</div>
              </div>
            </label>
          </div>

          <!-- Lista de selecci√≥n (seg√∫n tipo) -->
          <div id="lista-seleccion" class="seleccion-lista hidden"></div>
        </div>
        <div class="card-footer">
          <span class="contador" id="contador-participantes">0 participantes</span>
          <button class="btn btn-primary" onclick="siguientePaso(2)" id="btn-paso1">
            Siguiente ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- STEP 2: Presupuesto y Fecha -->
    <div class="step-content" id="step-2">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üí∂ Configuraci√≥n del sorteo</h2>
        </div>
        <div class="card-body">
          <div class="form-group" style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px;">üéÅ Nombre del sorteo</label>
            <input type="text" id="nombre-sorteo" class="form-input" placeholder="Ej: Navidad 2025, Cumple mam√°..." style="width: 100%; padding: 12px 16px; border: 2px solid var(--cream-dark); border-radius: 12px; font-family: inherit; font-size: 1rem;">
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px;">üí∂ Presupuesto m√°ximo</label>
              <div class="presupuesto-input">
                <input type="number" id="presupuesto" value="30" min="1" max="1000">
                <span>‚Ç¨</span>
              </div>
            </div>
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px;">üìÖ Fecha de entrega</label>
              <input type="date" id="fecha-regalo" class="fecha-input" style="width: 100%; padding: 12px 16px; border: 2px solid var(--cream-dark); border-radius: 12px; font-family: inherit; font-size: 1rem;">
            </div>
          </div>

          <div class="alert alert-warning">
            üí° <strong>Consejo:</strong> Un presupuesto entre 20‚Ç¨ y 50‚Ç¨ suele funcionar bien para regalos significativos sin presi√≥n econ√≥mica.
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" onclick="anteriorPaso(1)">
            ‚Üê Atr√°s
          </button>
          <button class="btn btn-primary" onclick="siguientePaso(3)">
            Siguiente ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- STEP 3: Sorteo -->
    <div class="step-content" id="step-3">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üé≤ Realizar sorteo</h2>
        </div>
        <div class="card-body">
          <div id="resumen-sorteo">
            <p><strong>Nombre:</strong> <span id="resumen-nombre">Sin nombre</span></p>
            <p><strong>Participantes:</strong> <span id="resumen-participantes">0</span> personas</p>
            <p><strong>Presupuesto:</strong> <span id="resumen-presupuesto">0</span>‚Ç¨</p>
            <p><strong>Fecha de entrega:</strong> <span id="resumen-fecha">Sin definir</span></p>
            <p style="margin-top: 16px; color: var(--text-light); font-size: 0.9rem;">
              ‚ö†Ô∏è Los consortes (parejas) nunca se asignan entre s√≠.
            </p>
          </div>
          
          <div id="alert-sorteo" class="alert alert-error hidden" style="margin-top: 16px;"></div>

          <div style="text-align: center; margin-top: 32px;">
            <button class="btn btn-primary btn-lg" onclick="realizarSorteo()" id="btn-sortear">
              üéÅ Realizar Sorteo
            </button>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" onclick="anteriorPaso(2)">
            ‚Üê Atr√°s
          </button>
          <span></span>
        </div>
      </div>
    </div>

    <!-- RESULTADO -->
    <div class="step-content" id="step-resultado">
      <div class="card">
        <div class="card-body">
          <div class="resultado-exito">
            <div class="resultado-icon">üéâ</div>
            <h2 class="resultado-titulo">¬°Sorteo completado!</h2>
            <p class="resultado-mensaje">
              Cada participante puede ver a qui√©n le toc√≥ en sus notificaciones de FAMILYNK.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
              <button class="btn btn-secondary" onclick="repetirSorteo()">
                üîÑ Repetir sorteo
              </button>
              <button class="btn btn-primary" onclick="nuevoSorteo()">
                ‚ú® Nuevo sorteo
              </button>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 12px;">
              Repetir = mismos participantes, nueva fecha/presupuesto
            </p>
          </div>

          <div class="asignaciones-admin">
            <div class="asignaciones-admin-title">üîê Asignaciones (solo visible para ti)</div>
            <div id="lista-asignaciones"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Historial -->
    <div class="card" style="margin-top: 24px;" id="historial-card">
      <div class="card-header">
        <h2 class="card-title">üìú Sorteos anteriores</h2>
      </div>
      <div class="card-body">
        <div id="historial-lista">
          <p style="color: var(--text-muted); text-align: center;">No hay sorteos anteriores</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Loading overlay -->
  <div class="loading-overlay hidden" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">Realizando sorteo...</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    // ============ CONFIG ============
    // Notificaciones internas

    let currentUser = null;
    let userData = null;
    let familiaId = null;
    let familiaData = null;
    let isAdminRama = false; // Solo el admin de rama puede ver los emparejamientos

    let miembrosData = []; // Todos los miembros
    let nidosData = [];
    let generacionesData = {}; // {generacion: [miembros]}

    let tipoSeleccion = 'todos';
    let participantesSeleccionados = []; // Array de {id, nombre, email, consorteId}

    // ============ INIT ============
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;

      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists) return;
      userData = userDoc.data();
      familiaId = userData.familiaId;
      
      // Verificar si es Admin de Rama
      isAdminRama = userData.rol === 'AdminRama' || userData.rol === 'AdminSistema' || userData.superAdmin === true;

      if (familiaId) {
        const familiaDoc = await db.collection('familias').doc(familiaId).get();
        if (familiaDoc.exists) familiaData = familiaDoc.data();
      }

      await cargarMiembros();
      await cargarNidos();
      organizarPorGeneracion();
      actualizarContador();
      cargarHistorial();
    });

    async function cargarMiembros() {
      const participantes = new Map(); // Usar email como clave para evitar duplicados

      // 1. Cargar usuarios con cuenta real
      const usuariosSnap = await db.collection('usuarios')
        .where('familiaId', '==', familiaId)
        .get();

      usuariosSnap.docs.forEach(doc => {
        const u = doc.data();
        if (!u.fechaDefuncion) { // Excluir fallecidos
          const key = (u.email || doc.id).toLowerCase();
          participantes.set(key, {
            id: doc.id,
            nombre: u.nombre || u.email?.split('@')[0] || 'Sin nombre',
            email: u.email,
            generacion: u.generacion || 'Sin asignar',
            nidoId: u.nidoId,
            tieneCuenta: true
          });
        }
      });

      // 2. Cargar miembrosData de todos los nidos
      const nidosSnap = await db.collection('nidos')
        .where('familiaId', '==', familiaId)
        .get();

      nidosSnap.docs.forEach(nidoDoc => {
        const nido = nidoDoc.data();
        const miembrosDelNido = nido.miembrosData || [];
        
        miembrosDelNido.forEach((m, index) => {
          if (!m.fechaDefuncion) { // Excluir fallecidos
            const key = (m.email || `nido_${nidoDoc.id}_${index}`).toLowerCase();
            
            // Solo a√±adir si no existe ya (usuarios con cuenta tienen prioridad)
            if (!participantes.has(key)) {
              participantes.set(key, {
                id: `nido_${nidoDoc.id}_${index}`,
                nombre: m.nombre || 'Sin nombre',
                email: m.email || null,
                generacion: nido.generacion || 'Sin asignar',
                nidoId: nidoDoc.id,
                nidoNombre: nido.nombre,
                tieneCuenta: false,
                relacion: m.relacion
              });
            }
          }
        });
      });

      // Convertir Map a array
      miembrosData = Array.from(participantes.values());
      console.log('Participantes cargados:', miembrosData.length, miembrosData);
    }

    async function cargarNidos() {
      const snap = await db.collection('nidos')
        .where('familiaId', '==', familiaId)
        .get();

      nidosData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    function organizarPorGeneracion() {
      generacionesData = {};
      miembrosData.forEach(m => {
        const gen = m.generacion || 'Sin asignar';
        if (!generacionesData[gen]) generacionesData[gen] = [];
        generacionesData[gen].push(m);
      });
    }

    // ============ SELECCI√ìN TIPO ============
    function seleccionarTipo(tipo) {
      tipoSeleccion = tipo;

      // Actualizar UI
      document.querySelectorAll('.tipo-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.querySelector(`input[value="${tipo}"]`)) {
          opt.classList.add('selected');
        }
      });

      const lista = document.getElementById('lista-seleccion');

      if (tipo === 'todos') {
        lista.classList.add('hidden');
        participantesSeleccionados = miembrosData.map(m => ({
          id: m.id,
          nombre: m.nombre || m.email,
          email: m.email,
          consorteId: m.consorteId || null
        }));
      } else {
        lista.classList.remove('hidden');
        renderListaSeleccion(tipo);
      }

      actualizarContador();
    }

    function renderListaSeleccion(tipo) {
      const lista = document.getElementById('lista-seleccion');
      let html = '';

      if (tipo === 'generaciones') {
        const generaciones = Object.keys(generacionesData).sort();
        html = `
          <div class="seleccion-header">
            <span>Generaciones</span>
            <button class="btn btn-secondary" style="padding:4px 10px;font-size:0.75rem;" onclick="toggleTodos(true)">Todas</button>
          </div>
        `;
        generaciones.forEach(gen => {
          const count = generacionesData[gen].length;
          html += `
            <div class="seleccion-item" onclick="toggleGeneracion('${gen}')">
              <input type="checkbox" id="gen-${gen}" onchange="toggleGeneracion('${gen}')">
              <div class="seleccion-item-info">
                <div class="seleccion-item-nombre">${gen}</div>
                <div class="seleccion-item-detalle">${count} persona${count !== 1 ? 's' : ''}</div>
              </div>
            </div>
          `;
        });
      } else if (tipo === 'nidos') {
        html = `
          <div class="seleccion-header">
            <span>Nidos</span>
            <button class="btn btn-secondary" style="padding:4px 10px;font-size:0.75rem;" onclick="toggleTodos(true)">Todos</button>
          </div>
        `;
        nidosData.forEach(nido => {
          const miembrosNido = miembrosData.filter(m => m.nidoId === nido.id);
          html += `
            <div class="seleccion-item" onclick="toggleNido('${nido.id}')">
              <input type="checkbox" id="nido-${nido.id}" onchange="toggleNido('${nido.id}')">
              <div class="seleccion-item-info">
                <div class="seleccion-item-nombre">${nido.nombre}</div>
                <div class="seleccion-item-detalle">${miembrosNido.length} persona${miembrosNido.length !== 1 ? 's' : ''}</div>
              </div>
            </div>
          `;
        });
      } else if (tipo === 'personas') {
        html = `
          <div class="seleccion-header">
            <span>Personas</span>
            <button class="btn btn-secondary" style="padding:4px 10px;font-size:0.75rem;" onclick="toggleTodos(true)">Todas</button>
          </div>
        `;
        miembrosData.forEach(m => {
          const inicial = (m.nombre || m.email || '?').charAt(0).toUpperCase();
          const detalle = m.email || (m.nidoNombre ? `üìç ${m.nidoNombre}` : 'üë§ Sin cuenta');
          html += `
            <div class="seleccion-item" onclick="togglePersona('${m.id}')">
              <input type="checkbox" id="persona-${m.id}" onchange="togglePersona('${m.id}')">
              <div class="seleccion-item-avatar" style="${!m.tieneCuenta ? 'opacity:0.6;' : ''}">${inicial}</div>
              <div class="seleccion-item-info">
                <div class="seleccion-item-nombre">${m.nombre || 'Sin nombre'}${!m.tieneCuenta ? ' <small style="color:#9A9A9A;">üë§</small>' : ''}</div>
                <div class="seleccion-item-detalle">${detalle}</div>
              </div>
            </div>
          `;
        });
      }

      lista.innerHTML = html;
      participantesSeleccionados = [];
      actualizarContador();
    }

    function toggleGeneracion(gen) {
      const checkbox = document.getElementById(`gen-${gen}`);
      const miembrosGen = generacionesData[gen] || [];

      if (checkbox.checked) {
        // A√±adir todos los de esta generaci√≥n
        miembrosGen.forEach(m => {
          if (!participantesSeleccionados.find(p => p.id === m.id)) {
            participantesSeleccionados.push({
              id: m.id,
              nombre: m.nombre || m.email,
              email: m.email,
              consorteId: m.consorteId || null
            });
          }
        });
      } else {
        // Quitar todos los de esta generaci√≥n
        participantesSeleccionados = participantesSeleccionados.filter(p => 
          !miembrosGen.find(m => m.id === p.id)
        );
      }

      actualizarContador();
    }

    function toggleNido(nidoId) {
      const checkbox = document.getElementById(`nido-${nidoId}`);
      const miembrosNido = miembrosData.filter(m => m.nidoId === nidoId);

      if (checkbox.checked) {
        miembrosNido.forEach(m => {
          if (!participantesSeleccionados.find(p => p.id === m.id)) {
            participantesSeleccionados.push({
              id: m.id,
              nombre: m.nombre || m.email,
              email: m.email,
              consorteId: m.consorteId || null
            });
          }
        });
      } else {
        participantesSeleccionados = participantesSeleccionados.filter(p => 
          !miembrosNido.find(m => m.id === p.id)
        );
      }

      actualizarContador();
    }

    function togglePersona(personaId) {
      const checkbox = document.getElementById(`persona-${personaId}`);
      const miembro = miembrosData.find(m => m.id === personaId);

      if (checkbox.checked) {
        if (!participantesSeleccionados.find(p => p.id === personaId)) {
          participantesSeleccionados.push({
            id: miembro.id,
            nombre: miembro.nombre || miembro.email,
            email: miembro.email,
            consorteId: miembro.consorteId || null
          });
        }
      } else {
        participantesSeleccionados = participantesSeleccionados.filter(p => p.id !== personaId);
      }

      actualizarContador();
    }

    function toggleTodos(seleccionar) {
      if (tipoSeleccion === 'generaciones') {
        Object.keys(generacionesData).forEach(gen => {
          document.getElementById(`gen-${gen}`).checked = seleccionar;
          toggleGeneracion(gen);
        });
      } else if (tipoSeleccion === 'nidos') {
        nidosData.forEach(nido => {
          document.getElementById(`nido-${nido.id}`).checked = seleccionar;
          toggleNido(nido.id);
        });
      } else if (tipoSeleccion === 'personas') {
        miembrosData.forEach(m => {
          document.getElementById(`persona-${m.id}`).checked = seleccionar;
        });
        if (seleccionar) {
          participantesSeleccionados = miembrosData.map(m => ({
            id: m.id,
            nombre: m.nombre || m.email,
            email: m.email,
            consorteId: m.consorteId || null
          }));
        } else {
          participantesSeleccionados = [];
        }
      }
      actualizarContador();
    }

    function actualizarContador() {
      const count = participantesSeleccionados.length;
      document.getElementById('contador-participantes').textContent = `${count} participante${count !== 1 ? 's' : ''}`;
    }

    // ============ WIZARD NAVIGATION ============
    function siguientePaso(paso) {
      // Validaciones
      if (paso === 2) {
        if (participantesSeleccionados.length < 3) {
          document.getElementById('alert-step1').textContent = 'Necesitas al menos 3 participantes para el sorteo';
          document.getElementById('alert-step1').classList.remove('hidden');
          return;
        }
        document.getElementById('alert-step1').classList.add('hidden');
      }

      if (paso === 3) {
        const nombreSorteo = document.getElementById('nombre-sorteo').value.trim();
        document.getElementById('resumen-nombre').textContent = nombreSorteo || 'Sin nombre';
        document.getElementById('resumen-participantes').textContent = participantesSeleccionados.length;
        document.getElementById('resumen-presupuesto').textContent = document.getElementById('presupuesto').value;
        
        const fechaInput = document.getElementById('fecha-regalo').value;
        if (fechaInput) {
          const fecha = new Date(fechaInput);
          document.getElementById('resumen-fecha').textContent = fecha.toLocaleDateString('es', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        } else {
          document.getElementById('resumen-fecha').textContent = 'Sin definir';
        }
      }

      // Cambiar paso
      document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
      document.getElementById(`step-${paso}`).classList.add('active');

      // Actualizar wizard
      document.querySelectorAll('.wizard-step').forEach(s => {
        const stepNum = parseInt(s.dataset.step);
        s.classList.remove('active', 'completed');
        if (stepNum === paso) s.classList.add('active');
        if (stepNum < paso) s.classList.add('completed');
      });
    }

    function anteriorPaso(paso) {
      document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
      document.getElementById(`step-${paso}`).classList.add('active');

      document.querySelectorAll('.wizard-step').forEach(s => {
        const stepNum = parseInt(s.dataset.step);
        s.classList.remove('active', 'completed');
        if (stepNum === paso) s.classList.add('active');
        if (stepNum < paso) s.classList.add('completed');
      });
    }

    // ============ SORTEO ============
    async function realizarSorteo() {
      const nombreSorteo = document.getElementById('nombre-sorteo').value.trim();
      const presupuesto = document.getElementById('presupuesto').value;
      const fechaRegaloInput = document.getElementById('fecha-regalo').value;
      const fechaRegalo = fechaRegaloInput ? new Date(fechaRegaloInput) : null;
      const alertEl = document.getElementById('alert-sorteo');
      alertEl.classList.add('hidden');

      // Validar m√≠nimo de participantes
      if (participantesSeleccionados.length < 3) {
        alertEl.textContent = 'Necesitas al menos 3 participantes';
        alertEl.classList.remove('hidden');
        return;
      }

      // Realizar sorteo con restricci√≥n de consortes
      const asignaciones = sortearConRestricciones(participantesSeleccionados);

      if (!asignaciones) {
        alertEl.textContent = 'No es posible realizar el sorteo con estas restricciones. Prueba con m√°s participantes.';
        alertEl.classList.remove('hidden');
        return;
      }

      // Mostrar loading
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('loading-text').textContent = 'Guardando asignaciones...';

      try {
        // Guardar sorteo en historial
        const sorteoRef = await db.collection('amigo-invisible').add({
          familiaId: familiaId,
          nombre: nombreSorteo || null,
          fecha: firebase.firestore.FieldValue.serverTimestamp(),
          fechaRegalo: fechaRegalo ? firebase.firestore.Timestamp.fromDate(fechaRegalo) : null,
          presupuesto: parseInt(presupuesto),
          participantes: participantesSeleccionados.map(p => p.nombre),
          participantesIds: participantesSeleccionados.map(p => p.id),
          participantesData: participantesSeleccionados, // Guardar datos completos para repetir
          asignaciones: asignaciones.map(a => ({ de: a.de.id, para: a.para.id })),
          creadoPor: currentUser.uid,
          estado: 'activo'
        });

        // Formatear fecha para mensaje
        const fechaTexto = fechaRegalo 
          ? fechaRegalo.toLocaleDateString('es', { day: 'numeric', month: 'long' })
          : '';

        // Crear notificaciones para cada participante (compatible con CGI)
        let creadas = 0;
        for (const asig of asignaciones) {
          document.getElementById('loading-text').textContent = `Notificando ${++creadas}/${asignaciones.length}...`;
          
          // Construir mensaje con presupuesto
          let mensajeNotif = `Te ha tocado regalar a **${asig.para.nombre}**`;
          mensajeNotif += `\nüí∂ Presupuesto: ${presupuesto}‚Ç¨`;
          if (fechaTexto) {
            mensajeNotif += `\nüìÖ Fecha de entrega: ${fechaTexto}`;
          }
          
          // Crear notificaci√≥n interna (formato compatible con CGI)
          await db.collection('notificaciones').add({
            // Campos para el CGI
            destinatarios: [asig.de.id],
            familiaId: familiaId,
            tipo: 'info',
            categoria: 'amigo-invisible',
            titulo: nombreSorteo ? `üéÅ ${nombreSorteo}` : 'üéÅ ¬°Amigo Invisible!',
            mensaje: mensajeNotif,
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            estado: 'activa',
            leidoPor: [],
            completadoPor: [],
            enlace: null,
            origen: { 
              tipo: 'amigo-invisible', 
              id: sorteoRef.id 
            },
            // Datos adicionales
            datos: {
              sorteoId: sorteoRef.id,
              asignadoA: asig.para.nombre,
              asignadoId: asig.para.id,
              presupuesto: parseInt(presupuesto),
              fechaRegalo: fechaRegalo ? fechaRegalo.toISOString() : null
            }
          });
        }

        // Mostrar resultado
        document.getElementById('loading').classList.add('hidden');
        mostrarResultado(asignaciones);

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').classList.add('hidden');
        alertEl.textContent = 'Error al guardar asignaciones: ' + error.message;
        alertEl.classList.remove('hidden');
      }
    }

    function sortearConRestricciones(participantes, intentos = 0) {
      if (intentos > 100) return null; // Evitar bucle infinito

      // Fisher-Yates shuffle
      const mezclados = [...participantes];
      for (let i = mezclados.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [mezclados[i], mezclados[j]] = [mezclados[j], mezclados[i]];
      }

      // Crear asignaciones rotativas (cada uno regala al siguiente)
      const asignaciones = [];
      for (let i = 0; i < mezclados.length; i++) {
        const de = mezclados[i];
        const para = mezclados[(i + 1) % mezclados.length];

        // Verificar restricci√≥n de consortes
        if (de.consorteId && de.consorteId === para.id) {
          // Reintentar con otro shuffle
          return sortearConRestricciones(participantes, intentos + 1);
        }

        // Verificar que no se regale a s√≠ mismo
        if (de.id === para.id) {
          return sortearConRestricciones(participantes, intentos + 1);
        }

        asignaciones.push({ de, para });
      }

      return asignaciones;
    }

    function mostrarResultado(asignaciones) {
      document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
      document.getElementById('step-resultado').classList.add('active');
      document.getElementById('wizard-steps').classList.add('hidden');

      // Mostrar lista de asignaciones SOLO para Admin de Rama
      const seccionAsignaciones = document.querySelector('.asignaciones-admin');
      
      if (isAdminRama) {
        seccionAsignaciones.classList.remove('hidden');
        const lista = document.getElementById('lista-asignaciones');
        lista.innerHTML = asignaciones.map(a => `
          <div class="asignacion-row">
            <span>${a.de.nombre}</span>
            <span class="asignacion-flecha">‚Üí</span>
            <span>${a.para.nombre}</span>
          </div>
        `).join('');
      } else {
        // Ocultar la secci√≥n completa para usuarios no admin
        seccionAsignaciones.classList.add('hidden');
      }

      cargarHistorial();
    }

    function nuevoSorteo() {
      participantesSeleccionados = [];
      tipoSeleccion = 'todos';
      
      document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
      document.getElementById('step-1').classList.add('active');
      document.getElementById('wizard-steps').classList.remove('hidden');

      // Reset wizard steps
      document.querySelectorAll('.wizard-step').forEach(s => {
        s.classList.remove('active', 'completed');
        if (s.dataset.step === '1') s.classList.add('active');
      });

      // Reset tipo selector
      document.querySelectorAll('.tipo-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.querySelector('input[value="todos"]')) opt.classList.add('selected');
      });
      document.getElementById('lista-seleccion').classList.add('hidden');

      // Reset campos paso 2
      document.getElementById('nombre-sorteo').value = '';
      document.getElementById('presupuesto').value = '30';
      document.getElementById('fecha-regalo').value = '';

      // Seleccionar todos por defecto
      participantesSeleccionados = miembrosData.map(m => ({
        id: m.id,
        nombre: m.nombre || m.email,
        email: m.email,
        consorteId: m.consorteId || null
      }));
      actualizarContador();
    }

    // ============ HISTORIAL ============
    async function cargarHistorial() {
      try {
        const snap = await db.collection('amigo-invisible')
          .where('familiaId', '==', familiaId)
          .orderBy('fecha', 'desc')
          .limit(5)
          .get();

        const lista = document.getElementById('historial-lista');

        if (snap.empty) {
          lista.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No hay sorteos anteriores</p>';
          return;
        }

        lista.innerHTML = snap.docs.map(doc => {
          const d = doc.data();
          const fecha = d.fecha?.toDate();
          const fechaStr = fecha ? fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
          const nombre = d.nombre || 'Sorteo sin nombre';
          
          return `
            <div class="historial-item">
              <div class="historial-item-header">
                <span class="historial-item-nombre">üéÅ ${nombre}</span>
                <span class="historial-item-presupuesto">${d.presupuesto}‚Ç¨</span>
              </div>
              <div class="historial-item-meta">
                <span class="historial-item-fecha">üìÖ ${fechaStr}</span>
                <span>üë• ${d.participantes?.length || 0} participantes</span>
              </div>
              <div class="historial-item-actions">
                <button class="btn btn-sm btn-secondary" onclick="repetirDesdeSorteo('${doc.id}')">
                  üîÑ Repetir sorteo
                </button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error cargando historial:', error);
      }
    }

    // Repetir sorteo actual (desde pantalla resultado)
    function repetirSorteo() {
      // Mantiene participantesSeleccionados actuales
      // Va al paso 2 para cambiar fecha/presupuesto
      document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
      document.getElementById('step-2').classList.add('active');
      document.getElementById('wizard-steps').classList.remove('hidden');

      // Actualizar wizard
      document.querySelectorAll('.wizard-step').forEach(s => {
        const stepNum = parseInt(s.dataset.step);
        s.classList.remove('active', 'completed');
        if (stepNum === 2) s.classList.add('active');
        if (stepNum < 2) s.classList.add('completed');
      });

      // Limpiar fecha y poner nombre sugerido
      const nombreActual = document.getElementById('nombre-sorteo').value;
      if (nombreActual) {
        // Incrementar a√±o si tiene uno
        const nuevoNombre = nombreActual.replace(/\d{4}/, (match) => parseInt(match) + 1);
        document.getElementById('nombre-sorteo').value = nuevoNombre !== nombreActual ? nuevoNombre : nombreActual + ' (nuevo)';
      }
      document.getElementById('fecha-regalo').value = '';
    }

    // Repetir desde historial
    async function repetirDesdeSorteo(sorteoId) {
      try {
        const doc = await db.collection('amigo-invisible').doc(sorteoId).get();
        if (!doc.exists) { alert('Sorteo no encontrado'); return; }
        
        const d = doc.data();
        
        // Cargar participantes del sorteo anterior
        if (d.participantesData && d.participantesData.length > 0) {
          participantesSeleccionados = d.participantesData;
        } else {
          // Fallback: buscar por IDs (sorteos antiguos)
          alert('Este sorteo no tiene datos de participantes guardados. Usa "Nuevo sorteo".');
          return;
        }
        
        // Ir al paso 2
        document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
        document.getElementById('step-2').classList.add('active');
        document.getElementById('wizard-steps').classList.remove('hidden');

        // Actualizar wizard
        document.querySelectorAll('.wizard-step').forEach(s => {
          const stepNum = parseInt(s.dataset.step);
          s.classList.remove('active', 'completed');
          if (stepNum === 2) s.classList.add('active');
          if (stepNum < 2) s.classList.add('completed');
        });

        // Poner nombre sugerido (incrementando a√±o)
        const nombreAnterior = d.nombre || '';
        const nuevoNombre = nombreAnterior.replace(/\d{4}/, (match) => parseInt(match) + 1);
        document.getElementById('nombre-sorteo').value = nuevoNombre !== nombreAnterior ? nuevoNombre : (nombreAnterior ? nombreAnterior + ' (nuevo)' : '');
        
        // Poner presupuesto anterior
        document.getElementById('presupuesto').value = d.presupuesto || 30;
        document.getElementById('fecha-regalo').value = '';
        
        actualizarContador();
        
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar el sorteo');
      }
    }
  </script>
</body>
</html>
