<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Plan Semanal Limpieza</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --limpieza: #5B8BD4;
      --limpieza-light: #7BA3E0;
      --limpieza-muted: rgba(91, 139, 212, 0.1);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --success: #7DB59A;
      --warning: #E8B44D;
      --error: #D4695A;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }
    .header { background: var(--white); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-soft); position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn { display: flex; align-items: center; gap: 6px; color: var(--limpieza); text-decoration: none; font-weight: 600; font-size: 0.9rem; }
    .header-title { font-family: 'Quicksand', sans-serif; font-size: 1.2rem; font-weight: 700; color: var(--limpieza); }
    .bien-nombre { font-size: 0.85rem; color: var(--text-muted); }
    .main { max-width: 900px; margin: 0 auto; padding: 24px; }
    .tabs { display: flex; gap: 4px; background: var(--cream-dark); padding: 4px; border-radius: var(--radius-md); margin-bottom: 24px; }
    .tab { flex: 1; padding: 12px 16px; border: none; background: transparent; font-family: 'Quicksand', sans-serif; font-size: 0.95rem; font-weight: 600; color: var(--text-light); cursor: pointer; border-radius: var(--radius-sm); transition: all 0.2s; }
    .tab:hover { background: rgba(255,255,255,0.5); }
    .tab.active { background: var(--white); color: var(--limpieza); box-shadow: var(--shadow-soft); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .loading { display: flex; justify-content: center; align-items: center; min-height: 200px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--cream-dark); border-top-color: var(--limpieza); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
    .empty-state { text-align: center; padding: 48px 24px; background: var(--white); border-radius: var(--radius-lg); }
    .empty-state-icon { font-size: 3rem; margin-bottom: 16px; }

    /* Vista Semana */
    .semana-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .semana-nav { display: flex; align-items: center; gap: 12px; }
    .semana-nav button { background: var(--white); border: 1px solid var(--cream-dark); padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; }
    .semana-nav button:hover { background: var(--limpieza-muted); }
    .semana-titulo { font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--limpieza); }
    .semana-stats { display: flex; gap: 16px; }
    .semana-stat { text-align: center; padding: 8px 16px; background: var(--white); border-radius: var(--radius-sm); box-shadow: var(--shadow-soft); }
    .semana-stat-value { font-size: 1.2rem; font-weight: 700; color: var(--limpieza); }
    .semana-stat-label { font-size: 0.75rem; color: var(--text-muted); }
    .dias-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    @media (max-width: 768px) { .dias-grid { grid-template-columns: repeat(2, 1fr); } }
    .dia-card { background: var(--white); border-radius: var(--radius-md); padding: 12px; box-shadow: var(--shadow-soft); min-height: 120px; }
    .dia-card.hoy { border: 2px solid var(--limpieza); }
    .dia-header { font-weight: 700; color: var(--text); margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed var(--cream-dark); font-size: 0.85rem; }
    .dia-tareas { display: flex; flex-direction: column; gap: 6px; }
    .tarea-item { font-size: 0.8rem; padding: 6px 8px; background: var(--limpieza-muted); border-radius: 4px; display: flex; justify-content: space-between; }
    .tarea-titulo { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }
    .tarea-tiempo { color: var(--text-muted); font-size: 0.7rem; }
    .dia-vacio { font-size: 0.8rem; color: var(--text-muted); font-style: italic; }

    /* Vista Mes */
    .mes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .mes-nav { display: flex; align-items: center; gap: 12px; }
    .mes-nav button { background: var(--white); border: 1px solid var(--cream-dark); padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; }
    .mes-titulo { font-family: 'Quicksand', sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--limpieza); }
    .mes-stats { display: flex; gap: 16px; }
    .semanas-mes-grid { display: flex; flex-direction: column; gap: 12px; }
    .semana-mes-card { background: var(--white); border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-soft); }
    .semana-mes-header { background: var(--limpieza); color: var(--white); padding: 10px 16px; font-weight: 600; display: flex; justify-content: space-between; }
    .semana-mes-body { padding: 12px 16px; display: flex; flex-wrap: wrap; gap: 8px; }
    .semana-mes-tarea { font-size: 0.85rem; padding: 6px 10px; background: var(--limpieza-muted); border-radius: 4px; }
    .semana-mes-vacia { font-size: 0.85rem; color: var(--text-muted); font-style: italic; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="#" class="back-btn" id="btn-volver">‚Üê Volver</a>
      <div>
        <h1 class="header-title">üßπ Plan Semanal Limpieza</h1>
        <span class="bien-nombre" id="bien-nombre"></span>
      </div>
    </div>
  </header>
  <main class="main">
    <div id="loading" class="loading"><div class="spinner"></div></div>
    <div id="content" class="hidden">
      <div class="tabs">
        <button class="tab active" onclick="cambiarTab('semana')">üìÖ Semana</button>
        <button class="tab" onclick="cambiarTab('mes')">üóìÔ∏è Mes</button>
      </div>
      <!-- Tab Semana -->
      <div id="tab-semana" class="tab-content active">
        <div class="semana-header">
          <div class="semana-nav">
            <button onclick="cambiarSemana(-1)">‚Üê Anterior</button>
            <span class="semana-titulo" id="semana-titulo">Semana 5 ¬∑ Enero 2026</span>
            <button onclick="cambiarSemana(1)">Siguiente ‚Üí</button>
          </div>
          <div class="semana-stats">
            <div class="semana-stat"><div class="semana-stat-value" id="stat-tareas">0</div><div class="semana-stat-label">Tareas</div></div>
            <div class="semana-stat"><div class="semana-stat-value" id="stat-horas">0h</div><div class="semana-stat-label">Tiempo</div></div>
          </div>
        </div>
        <div class="dias-grid" id="dias-grid"></div>
      </div>
      <!-- Tab Mes -->
      <div id="tab-mes" class="tab-content">
        <div class="mes-header">
          <div class="mes-nav">
            <button onclick="cambiarMes(-1)">‚Üê Anterior</button>
            <span class="mes-titulo" id="mes-titulo">Enero 2026</span>
            <button onclick="cambiarMes(1)">Siguiente ‚Üí</button>
          </div>
          <div class="mes-stats">
            <div class="semana-stat"><div class="semana-stat-value" id="stat-mes-tareas">0</div><div class="semana-stat-label">Tareas</div></div>
            <div class="semana-stat"><div class="semana-stat-value" id="stat-mes-horas">0h</div><div class="semana-stat-label">Tiempo</div></div>
          </div>
        </div>
        <div class="semanas-mes-grid" id="semanas-mes-grid"></div>
      </div>
    </div>
    <div id="empty-state" class="empty-state hidden">
      <div class="empty-state-icon">üßπ</div>
      <h3>No hay tareas programadas</h3>
      <p>Configura tareas en Limpieza Programada.</p>
    </div>
  </main>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = { apiKey: "AIzaSyA5GtzPbvLJwJI9DWoWClf5k4lQ8MLGxJA", authDomain: "familynk-app.firebaseapp.com", projectId: "familynk-app", storageBucket: "familynk-app.firebasestorage.app", messagingSenderId: "143638140027", appId: "1:143638140027:web:8b0f77966deff28bb9ae55" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const bienId = urlParams.get('id');
    const origen = urlParams.get('origen') || 'limpieza';
    document.getElementById('btn-volver').href = `${origen}.html?id=${bienId}`;

    let currentUser = null, bienData = null, tareasData = [], planConfig = {};
    let semanaActual = getNumeroSemana(new Date());
    let mesActual = new Date().getMonth();
    let anoActual = new Date().getFullYear();

    const diasNombres = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
    const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    if (!bienId) { alert('No se especific√≥ el bien'); window.location.href = 'cgi.html'; }

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      await cargarDatos();
    });

    async function cargarDatos() {
      try {
        const bienDoc = await db.collection('bienes').doc(bienId).get();
        if (!bienDoc.exists) { alert('Bien no encontrado'); window.location.href = `${origen}.html`; return; }
        bienData = bienDoc.data();
        document.getElementById('bien-nombre').textContent = bienData.nombre || 'Sin nombre';

        let tareasSnap;
        try { tareasSnap = await db.collection('bienes').doc(bienId).collection('limpiezaProgramada').get(); }
        catch (e) { tareasSnap = { docs: [] }; }
        tareasData = tareasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const configDoc = await db.collection('bienes').doc(bienId).collection('configLimpieza').doc('planSemanal').get();
        planConfig = configDoc.exists ? configDoc.data() : {};

        document.getElementById('loading').classList.add('hidden');
        if (tareasData.length === 0) { document.getElementById('empty-state').classList.remove('hidden'); }
        else { document.getElementById('content').classList.remove('hidden'); renderSemana(); }
      } catch (error) { console.error('Error:', error); alert('Error al cargar'); }
    }

    function getNumeroSemana(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function getFechasDeSemana(semana, ano) {
      const simple = new Date(ano, 0, 1 + (semana - 1) * 7);
      const dow = simple.getDay();
      const ISOweekStart = simple;
      if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
      else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
      const fechas = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(ISOweekStart);
        d.setDate(ISOweekStart.getDate() + i);
        fechas.push(d);
      }
      return fechas;
    }

    function getTareasParaDia(diaSemana) {
      // diaSemana: 0=Dom, 1=Lun, ..., 6=Sab
      const tareas = [];
      tareasData.forEach(tarea => {
        if (tarea.dia === diaSemana || tarea.dia === undefined) {
          const config = planConfig[tarea.id] || {};
          tareas.push({ 
            titulo: tarea.titulo, 
            duracion: config.duracion || tarea.duracion || 30, 
            unidad: config.unidadDuracion || 'min',
            zona: tarea.zona 
          });
        }
      });
      return tareas;
    }

    function getTareasParaSemana() {
      const tareas = [];
      tareasData.forEach(tarea => {
        const config = planConfig[tarea.id];
        if (!config || config.activo === false) {
          // Si no tiene config, mostrar igual
          tareas.push({ titulo: tarea.titulo, duracion: tarea.duracion || 30, unidad: 'min', zona: tarea.zona, dia: tarea.dia });
        } else {
          tareas.push({ titulo: tarea.titulo, duracion: config.duracion || 30, unidad: config.unidadDuracion || 'min', zona: tarea.zona, dia: tarea.dia });
        }
      });
      return tareas;
    }

    function renderSemana() {
      const fechas = getFechasDeSemana(semanaActual, anoActual);
      const hoy = new Date();
      const todasTareas = getTareasParaSemana();
      
      document.getElementById('semana-titulo').textContent = `Semana ${semanaActual} ¬∑ ${mesesNombres[fechas[0].getMonth()]} ${anoActual}`;
      document.getElementById('stat-tareas').textContent = todasTareas.length;
      document.getElementById('stat-horas').textContent = formatearTiempo(todasTareas.reduce((sum, t) => sum + convertirAMinutos(t.duracion, t.unidad), 0));

      const grid = document.getElementById('dias-grid');
      grid.innerHTML = fechas.map((fecha, i) => {
        const esHoy = fecha.toDateString() === hoy.toDateString();
        const diaSemana = fecha.getDay();
        const tareasDelDia = todasTareas.filter(t => t.dia === diaSemana || t.dia === undefined);
        return `
          <div class="dia-card ${esHoy ? 'hoy' : ''}">
            <div class="dia-header">${diasNombres[diaSemana]} ${fecha.getDate()}</div>
            <div class="dia-tareas">
              ${tareasDelDia.length > 0 ? tareasDelDia.slice(0, 4).map(t => `
                <div class="tarea-item">
                  <span class="tarea-titulo" title="${t.titulo}">${t.titulo}</span>
                  <span class="tarea-tiempo">${t.duracion}${t.unidad}</span>
                </div>
              `).join('') + (tareasDelDia.length > 4 ? `<div class="tarea-item">+${tareasDelDia.length - 4} m√°s</div>` : '') : '<div class="dia-vacio">Sin tareas</div>'}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderMes() {
      document.getElementById('mes-titulo').textContent = `${mesesNombres[mesActual]} ${anoActual}`;
      
      const primerDia = new Date(anoActual, mesActual, 1);
      const ultimoDia = new Date(anoActual, mesActual + 1, 0);
      const semanaInicio = getNumeroSemana(primerDia);
      const semanaFin = getNumeroSemana(ultimoDia);
      
      const todasTareas = getTareasParaSemana();
      let totalTareas = 0, totalMinutos = 0;
      const semanasHtml = [];
      
      for (let sem = semanaInicio; sem <= semanaFin; sem++) {
        totalTareas += todasTareas.length;
        totalMinutos += todasTareas.reduce((sum, t) => sum + convertirAMinutos(t.duracion, t.unidad), 0);
        
        semanasHtml.push(`
          <div class="semana-mes-card">
            <div class="semana-mes-header">
              <span>Semana ${sem}</span>
              <span>${todasTareas.length} tareas ¬∑ ${formatearTiempo(todasTareas.reduce((s, t) => s + convertirAMinutos(t.duracion, t.unidad), 0))}</span>
            </div>
            <div class="semana-mes-body">
              ${todasTareas.length > 0 ? todasTareas.slice(0, 8).map(t => `<span class="semana-mes-tarea">${t.titulo} (${t.duracion}${t.unidad})</span>`).join('') + (todasTareas.length > 8 ? `<span class="semana-mes-tarea">+${todasTareas.length - 8} m√°s</span>` : '') : '<span class="semana-mes-vacia">Sin tareas programadas</span>'}
            </div>
          </div>
        `);
      }
      
      document.getElementById('stat-mes-tareas').textContent = totalTareas;
      document.getElementById('stat-mes-horas').textContent = formatearTiempo(totalMinutos);
      document.getElementById('semanas-mes-grid').innerHTML = semanasHtml.join('');
    }

    function cambiarSemana(delta) { semanaActual += delta; if (semanaActual < 1) { semanaActual = 52; anoActual--; } if (semanaActual > 52) { semanaActual = 1; anoActual++; } renderSemana(); }
    function cambiarMes(delta) { mesActual += delta; if (mesActual < 0) { mesActual = 11; anoActual--; } if (mesActual > 11) { mesActual = 0; anoActual++; } renderMes(); }
    function cambiarTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab:nth-child(${tab === 'semana' ? 1 : 2})`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
      if (tab === 'mes') renderMes();
    }
    function convertirAMinutos(d, u) { d = parseInt(d) || 0; return u === 'h' ? d * 60 : u === 'd' ? d * 480 : d; }
    function formatearTiempo(m) { if (m < 60) return `${m}min`; const h = Math.floor(m / 60); const min = m % 60; return min > 0 ? `${h}h ${min}min` : `${h}h`; }
  </script>
</body>
</html>
