<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK ‚Äî Admin Rama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --negro: #1a1a1a;
      --rojo: #c0392b;
      --rojo-dark: #a5281b;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header {
      background: var(--rojo);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .btn-volver {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: var(--radius-md);
      color: white;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .btn-volver:hover { background: rgba(255,255,255,0.2); }

    .header-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .estirpe-badge {
      padding: 4px 12px;
      background: var(--sage);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .main { max-width: 1200px; margin: 0 auto; padding: 24px; }

    .admin-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      background: var(--white);
      padding: 8px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
    }

    .admin-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-light);
      transition: all 0.2s;
    }

    .admin-tab:hover { background: var(--cream); }
    .admin-tab.active { background: var(--rojo); color: white; }

    .badge-pendientes {
      background: var(--warning);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 6px;
      animation: pulse 2s infinite;
    }
    .admin-tab.active .badge-pendientes { background: white; color: var(--rojo); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

    /* Buz√≥n solicitudes */
    .solicitud-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--white);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      border-left: 4px solid var(--warning);
      box-shadow: var(--shadow-soft);
      transition: all 0.2s;
    }
    .solicitud-item:hover { transform: translateX(4px); }
    .solicitud-item.aprobada { border-left-color: var(--success); opacity: 0.7; }
    .solicitud-item.rechazada { border-left-color: var(--error); opacity: 0.5; text-decoration: line-through; }
    .solicitud-icono { font-size: 2rem; min-width: 50px; text-align: center; }
    .solicitud-info { flex: 1; min-width: 0; }
    .solicitud-tipo { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: var(--text-muted); margin-bottom: 2px; }
    .solicitud-titulo { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
    .solicitud-detalle { font-size: 0.85rem; color: var(--text-muted); }
    .solicitud-meta { display: flex; gap: 16px; margin-top: 6px; font-size: 0.75rem; color: var(--text-muted); }
    .solicitud-actions { display: flex; gap: 8px; flex-shrink: 0; }
    .solicitud-empty { 
      text-align: center; 
      padding: 40px; 
      color: var(--text-muted); 
      background: var(--cream-medium);
      border-radius: var(--radius-md);
    }
    .btn-aprobar { background: var(--success); color: white; }
    .btn-rechazar { background: var(--error); color: white; }

    .admin-section { display: none; animation: fadeIn 0.3s ease; }
    .admin-section.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .section-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
    }

    .card.subseccion-card {
      margin-left: 24px;
      border-left: 3px solid var(--sage-light);
      background: linear-gradient(135deg, var(--white) 0%, rgba(122,158,126,0.03) 100%);
    }

    .card-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary { background: var(--rojo); color: white; }
    .btn-primary:hover { background: #333; }
    .btn-secondary { background: var(--cream); color: var(--text); }
    .btn-secondary:hover { background: var(--cream-dark); }
    .btn-danger { background: #dc3545; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

    /* Estilos para plantillas de normas */
    .plantilla-tipo-btn { flex: 1; min-width: 150px; }
    .plantilla-tipo-btn.active { background: var(--sage); color: white; }
    .plantilla-bien-btn { flex: 1; min-width: 120px; }
    .plantilla-bien-btn.active { background: var(--terracotta); color: white; }
    .plantilla-cat-btn { flex: 1; min-width: 140px; }
    .plantilla-cat-btn.active { background: var(--text); color: white; }
    
    .capitulo-card {
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
      overflow: hidden;
    }
    
    .capitulo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--sage-muted);
      cursor: pointer;
    }
    
    .capitulo-header:hover { background: var(--sage-light); }
    
    .capitulo-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }
    
    .capitulo-numero {
      background: var(--sage);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }
    
    .capitulo-actions { display: flex; gap: 6px; }
    .capitulo-actions button {
      background: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .capitulo-actions button:hover { background: var(--cream-dark); }
    
    .capitulo-body { padding: 12px 16px; }
    
    .precepto-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px dashed var(--cream-dark);
    }
    .precepto-item:last-child { border-bottom: none; }
    
    .precepto-num {
      color: var(--text-muted);
      font-weight: 600;
      min-width: 35px;
      font-size: 0.85rem;
    }
    
    .precepto-texto { font-size: 0.9rem; line-height: 1.5; }

    .users-table { width: 100%; border-collapse: collapse; }
    .users-table th, .users-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--cream-dark); }
    .users-table th { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
    .user-row { transition: background 0.2s; }
    .user-row:hover { background: var(--cream); }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--sage), var(--sage-light));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-name { font-weight: 600; }
    .user-email { font-size: 0.8rem; color: var(--text-muted); }

    .role-badge { padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 600; }
    .role-badge.admin { background: var(--rojo); color: white; }
    .role-badge.miembro { background: var(--sage-muted); color: var(--sage-dark); }
    .role-badge.invitado { background: #F6E05E; color: #744210; }
    .role-badge.especial { background: #E9D8FD; color: #553C9A; }

    .user-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 8px; margin-top: 2px; }
    .user-meta-item { display: flex; align-items: center; gap: 3px; }
    .user-nidos { display: flex; gap: 4px; flex-wrap: wrap; }
    .nido-badge { padding: 2px 8px; background: var(--cream); border-radius: 4px; font-size: 0.7rem; color: var(--text-light); }

    .config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }

    .config-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }

    .config-item-info { display: flex; align-items: center; gap: 12px; }
    .config-item-icon { font-size: 1.5rem; }
    .config-item-name { font-weight: 600; }
    .config-item-desc { font-size: 0.8rem; color: var(--text-muted); }

    .toggle-switch { position: relative; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: var(--text-muted); transition: 0.3s; border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
      background-color: white; transition: 0.3s; border-radius: 50%;
    }
    input:checked + .toggle-slider { background-color: var(--sage); }
    input:checked + .toggle-slider:before { transform: translateX(24px); }

    .permisos-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .permisos-table th, .permisos-table td { padding: 10px; text-align: center; border-bottom: 1px solid var(--cream-dark); }
    .permisos-table th:first-child, .permisos-table td:first-child { text-align: left; }
    .permisos-table th { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); }
    .permiso-check { width: 18px; height: 18px; accent-color: var(--sage); }

    /* Matriz CVEB */
    .cveb-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 16px; }
    .cveb-table th, .cveb-table td { padding: 8px 6px; text-align: center; border-bottom: 1px solid var(--cream-dark); }
    .cveb-table th { font-size: 0.65rem; text-transform: uppercase; color: var(--text-muted); background: var(--cream); }
    .cveb-table td:first-child { text-align: left; font-weight: 600; min-width: 120px; }
    .cveb-table .rol-header { background: var(--cream-dark); font-weight: 700; color: var(--text); }
    .cveb-table .cveb-group { border-left: 2px solid var(--cream-dark); }
    .cveb-check { width: 16px; height: 16px; accent-color: var(--sage); cursor: pointer; }
    .cveb-check:disabled { opacity: 0.5; cursor: not-allowed; }
    .cveb-letter { 
      display: inline-block; 
      width: 20px; 
      height: 20px; 
      line-height: 20px;
      font-size: 0.65rem; 
      font-weight: 700; 
      border-radius: 4px;
      margin: 0 1px;
    }
    .cveb-letter.c { background: var(--sage-muted); color: var(--sage-dark); }
    .cveb-letter.v { background: #e3f2fd; color: #1976d2; }
    .cveb-letter.e { background: var(--terracotta-muted); color: var(--terracotta); }
    .cveb-letter.b { background: #ffebee; color: #c62828; }
    .cveb-legend {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .cveb-legend span { display: flex; align-items: center; gap: 4px; }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-light); }
    .form-input {
      width: 100%; padding: 12px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.9rem; transition: border-color 0.2s;
    }
    .form-input:focus { outline: none; border-color: var(--sage); }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }

    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--white); border-radius: var(--radius-lg); padding: 20px; text-align: center; box-shadow: var(--shadow-soft); }
    .stat-value { font-family: 'Quicksand', sans-serif; font-size: 2rem; font-weight: 700; color: var(--rojo); }
    .stat-label { font-size: 0.8rem; color: var(--text-muted); }

    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center; z-index: 1000;
      opacity: 0; visibility: hidden; transition: all 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: var(--white); border-radius: var(--radius-lg); padding: 24px;
      width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
      transform: translateY(20px); transition: transform 0.3s;
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .modal-title { font-family: 'Quicksand', sans-serif; font-size: 1.2rem; font-weight: 700; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }

    @media (max-width: 768px) {
      .admin-tabs { flex-direction: column; }
      .admin-tab { justify-content: flex-start; }
      .users-table { font-size: 0.8rem; }
      .users-table th:nth-child(3), .users-table td:nth-child(3) { display: none; }
    }
    /* Mayordomo */
    .bien-config-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }
    .bien-info { display: flex; align-items: center; gap: 12px; }
    .bien-icono { font-size: 2rem; }
    .bien-nombre { font-weight: 700; font-size: 1.1rem; }
    .bien-tipo { font-size: 0.8rem; color: var(--text-muted); }
    
    .toggle-switch-large { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .toggle-switch-large input { display: none; }
    .toggle-slider-large {
      width: 56px; height: 28px; background: var(--text-muted); border-radius: 28px;
      position: relative; transition: 0.3s;
    }
    .toggle-slider-large:before {
      content: ""; position: absolute; width: 22px; height: 22px; left: 3px; top: 3px;
      background: white; border-radius: 50%; transition: 0.3s;
    }
    .toggle-switch-large input:checked + .toggle-slider-large { background: #8B7355; }
    .toggle-switch-large input:checked + .toggle-slider-large:before { transform: translateX(28px); }
    .toggle-label { font-weight: 600; color: var(--text-light); }
    .toggle-switch-large input:checked ~ .toggle-label { color: #8B7355; }
    
    .submodulos-title { font-weight: 600; margin-bottom: 12px; color: var(--text); }
    .submodulos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
    .submodulo-item {
      display: flex; align-items: center; gap: 10px; padding: 12px 16px;
      background: var(--white); border: 2px solid var(--cream-dark); border-radius: var(--radius-md);
      cursor: pointer; transition: all 0.2s;
    }
    .submodulo-item:hover { border-color: #8B7355; }
    .submodulo-item input { display: none; }
    .submodulo-item input:checked + .submodulo-icono { transform: scale(1.1); }
    .submodulo-item:has(input:checked) { border-color: #8B7355; background: rgba(139, 115, 85, 0.1); }
    .submodulo-icono { font-size: 1.3rem; }
    .submodulo-nombre { font-weight: 600; font-size: 0.85rem; }
    
    .bienes-resumen { display: flex; flex-direction: column; gap: 8px; }
    .bien-resumen-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; background: var(--cream); border-radius: var(--radius-md);
    }
    .bien-resumen-info { display: flex; align-items: center; gap: 10px; }
    .bien-resumen-nombre { font-weight: 600; }
    .bien-resumen-estado { font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; }
    .bien-resumen-estado.activo { background: rgba(139, 115, 85, 0.15); color: #8B7355; }
    .bien-resumen-estado.inactivo { background: var(--cream-dark); color: var(--text-muted); }

    .hidden { display: none !important; }

    /* Tipos de Reserva */
    .tipos-reserva-list { display: flex; flex-direction: column; gap: 12px; }
    .tipo-reserva-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
      transition: all 0.2s;
    }
    .tipo-reserva-item:hover { background: var(--cream-dark); }
    .tipo-reserva-color {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      flex-shrink: 0;
    }
    .tipo-reserva-info { flex: 1; }
    .tipo-reserva-nombre { font-weight: 700; font-size: 1rem; }
    .tipo-reserva-id { font-size: 0.75rem; color: var(--text-muted); }
    .tipo-reserva-actions { display: flex; gap: 8px; }
    
    .preview-calendario {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }
    .preview-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--white);
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      font-weight: 600;
    }
    .preview-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }
    
    /* Selector de color */
    .color-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-top: 8px;
    }
    .color-option {
      width: 100%;
      aspect-ratio: 1;
      border-radius: var(--radius-sm);
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    .color-option:hover { transform: scale(1.1); }
    .color-option.selected { border-color: var(--text); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--text); }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="cgi.html" class="btn-volver">‚Üê Volver</a>
      <div class="header-title">
        <span>üîß</span>
        <span>Admin Rama</span>
        <span class="estirpe-badge" id="estirpe-nombre">Mi Rama</span>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-value" id="stat-usuarios">0</div><div class="stat-label">Usuarios</div></div>
      <div class="stat-card"><div class="stat-value" id="stat-invitaciones" style="color:var(--terracotta)">0</div><div class="stat-label">Invitaciones</div></div>
      <div class="stat-card"><div class="stat-value" id="stat-nidos">0</div><div class="stat-label">Nidos</div></div>
      <div class="stat-card"><div class="stat-value" id="stat-estirpes">0</div><div class="stat-label">Estirpes</div></div>
      <div class="stat-card"><div class="stat-value" id="stat-bienes">0</div><div class="stat-label">Bienes</div></div>
      <div class="stat-card"><div class="stat-value" id="stat-generaciones">0</div><div class="stat-label">Generaciones</div></div>
    </div>

    <div class="admin-tabs">
      <button class="admin-tab active" data-section="usuarios" onclick="cambiarSeccion('usuarios')"><span>üë•</span> Usuarios</button>
      <button class="admin-tab" data-section="buzon" onclick="cambiarSeccion('buzon')"><span>üì¨</span> Buz√≥n <span class="badge-pendientes" id="badge-buzon" style="display:none">0</span></button>
      <button class="admin-tab" data-section="reservas" onclick="cambiarSeccion('reservas')"><span>üìÖ</span> Reservas</button>
      <button class="admin-tab" data-section="gestion" onclick="cambiarSeccion('gestion')"><span>üé©</span> Gesti√≥n Activa</button>
      <button class="admin-tab" data-section="externos" onclick="cambiarSeccion('externos')"><span>üîë</span> Externos</button>
      <button class="admin-tab" data-section="plantillas" onclick="cambiarSeccion('plantillas')"><span>üìã</span> Plantillas</button>
      <button class="admin-tab" data-section="planes" onclick="cambiarSeccion('planes')"><span>üí≥</span> Planes</button>
      <button class="admin-tab" data-section="secciones" onclick="cambiarSeccion('secciones')"><span>üìÇ</span> Secciones</button>
      <button class="admin-tab" data-section="permisos" onclick="cambiarSeccion('permisos')"><span>üîê</span> Permisos</button>
      <button class="admin-tab" data-section="estirpe" onclick="cambiarSeccion('estirpe')"><span>‚öôÔ∏è</span> Configuraci√≥n</button>
    </div>

    <section class="admin-section active" id="section-usuarios">
      <div class="section-header">
        <h2 class="section-title">üë• Usuarios</h2>
        <button class="btn btn-primary" onclick="abrirModalInvitar()"><span>‚ûï</span> Invitar usuario</button>
      </div>
      <div class="card">
        <table class="users-table">
          <thead><tr><th>N¬∫</th><th>Usuario</th><th>Nidos</th><th>Rol</th><th>Acciones</th></tr></thead>
          <tbody id="usuarios-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- SECCI√ìN BUZ√ìN -->
    <section class="admin-section" id="section-buzon">
      <div class="section-header">
        <h2 class="section-title">üì¨ Buz√≥n de Solicitudes</h2>
        <div class="section-actions">
          <select class="form-input" id="filtro-buzon" onchange="renderSolicitudes()" style="width:auto;padding:8px 12px;">
            <option value="pendiente">üïê Pendientes</option>
            <option value="todas">üìã Todas</option>
            <option value="aprobada">‚úÖ Aprobadas</option>
            <option value="rechazada">‚ùå Rechazadas</option>
          </select>
        </div>
      </div>
      
      <div class="card">
        <div id="solicitudes-list">
          <div class="solicitud-empty">
            <p style="font-size:2rem;margin-bottom:8px;">üì≠</p>
            <p>No hay solicitudes pendientes</p>
          </div>
        </div>
      </div>
    </section>

    <!-- SECCI√ìN RESERVAS -->
    <section class="admin-section" id="section-reservas">
      <div class="section-header">
        <h2 class="section-title">üìÖ Tipos de Reserva</h2>
        <button class="btn btn-primary" onclick="abrirModalTipoReserva()"><span>‚ûï</span> Nuevo tipo</button>
      </div>
      
      <div class="card">
        <div class="card-title">Configura qui√©n puede reservar</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
          Define los tipos de reserva que aparecer√°n en el calendario de tus bienes. Cada tipo tiene un nombre y color √∫nico.
        </p>
        
        <div class="tipos-reserva-list" id="tipos-reserva-list">
          <!-- Se carga din√°micamente -->
        </div>
      </div>
      
      <div class="card">
        <div class="card-title">üé® Vista previa</div>
        <div class="preview-calendario" id="preview-colores">
          <!-- Muestra los colores -->
        </div>
      </div>
    </section>

    <section class="admin-section" id="section-gestion">
      <div class="section-header">
        <h2 class="section-title">üé© Gesti√≥n Activa</h2>
      </div>
      
      <!-- Resumen de bienes con gesti√≥n activa -->
      <div class="card">
        <div class="card-title">üìä Resumen de gesti√≥n activa</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
          Vista general de bienes con Mayordomo activo y sus m√≥dulos configurados
        </p>
        <div id="gestion-resumen-tabla" style="overflow-x: auto;">
          <!-- Se genera din√°micamente -->
        </div>
      </div>
      
      <!-- Configurador individual -->
      <div class="card">
        <div class="card-title">‚öôÔ∏è Configurar bien</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
          Activa la gesti√≥n y configura los subm√≥dulos para cada bien de la rama
        </p>
        
        <div class="form-group">
          <label class="form-label">Selecciona un bien</label>
          <select class="form-input" id="select-bien" onchange="cargarConfigBien()">
            <option value="">-- Selecciona un bien --</option>
          </select>
        </div>
        
        <div id="config-bien-container" class="hidden">
          <div class="bien-config-header">
            <div class="bien-info">
              <span class="bien-icono" id="bien-icono">üè†</span>
              <div>
                <div class="bien-nombre" id="bien-nombre">...</div>
                <div class="bien-tipo" id="bien-tipo">...</div>
              </div>
            </div>
            <label class="toggle-switch-large">
              <input type="checkbox" id="toggle-mayordomo-activo" onchange="toggleMayordomoBien()">
              <span class="toggle-slider-large"></span>
              <span class="toggle-label" id="mayordomo-estado">Desactivado</span>
            </label>
          </div>
          
          <div id="submodulos-config" class="hidden">
            <div class="submodulos-title">Subm√≥dulos activos</div>
            <div class="submodulos-grid">
              <label class="submodulo-item">
                <input type="checkbox" id="mod-reservas" onchange="guardarSubmodulos()">
                <span class="submodulo-icono">üìÖ</span>
                <span class="submodulo-nombre">Reservas</span>
              </label>
              <label class="submodulo-item">
                <input type="checkbox" id="mod-inventario" onchange="guardarSubmodulos()">
                <span class="submodulo-icono">üì¶</span>
                <span class="submodulo-nombre">Inventario</span>
              </label>
              <label class="submodulo-item">
                <input type="checkbox" id="mod-gastos" onchange="guardarSubmodulos()">
                <span class="submodulo-icono">üí∞</span>
                <span class="submodulo-nombre">Gastos</span>
              </label>
              <label class="submodulo-item">
                <input type="checkbox" id="mod-mantenimiento" onchange="guardarSubmodulos()">
                <span class="submodulo-icono">üîß</span>
                <span class="submodulo-nombre">Mantenimiento</span>
              </label>
              <label class="submodulo-item">
                <input type="checkbox" id="mod-limpieza" onchange="guardarSubmodulos()">
                <span class="submodulo-icono">üßπ</span>
                <span class="submodulo-nombre">Limpieza</span>
              </label>
              <label class="submodulo-item">
                <input type="checkbox" id="mod-eventos" onchange="guardarSubmodulos()">
                <span class="submodulo-icono">üéâ</span>
                <span class="submodulo-nombre">Eventos</span>
              </label>
              <label class="submodulo-item">
                <input type="checkbox" id="mod-otros" onchange="guardarSubmodulos()">
                <span class="submodulo-icono">üìã</span>
                <span class="submodulo-nombre">Otros Servicios</span>
              </label>
            </div>
            
            <a href="#" id="enlace-ver-bien" class="btn btn-secondary" style="margin-top: 16px;">
              üëÅÔ∏è Ver ficha del bien
            </a>
          </div>
        </div>
      </div>
      
      <!-- Lista resumen legacy -->
      <div class="card">
        <div class="card-title">Lista de bienes</div>
        <div class="bienes-resumen" id="bienes-resumen">
          <!-- Se carga din√°micamente -->
        </div>
      </div>
    </section>

    <!-- SECCI√ìN EXTERNOS -->
    <section class="admin-section" id="section-externos">
      <div class="section-header">
        <h2 class="section-title">üîë Colaboradores Externos</h2>
      </div>
      
      <div class="card">
        <div class="card-title">Matriz de accesos</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
          Vista general de los colaboradores externos y sus accesos a bienes con gesti√≥n activa
        </p>
        
        <div id="externos-matriz-container" style="overflow-x: auto;">
          <p style="text-align: center; color: var(--text-muted); padding: 20px;">Cargando...</p>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title">Resumen por tipo</div>
        <div id="externos-resumen" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          <div style="padding: 16px; background: var(--cream); border-radius: 8px; text-align: center;">
            <span style="font-size: 2rem;">üè†</span>
            <div style="font-weight: 700; margin-top: 8px;" id="count-caseros">0</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">Caseros</div>
          </div>
          <div style="padding: 16px; background: var(--cream); border-radius: 8px; text-align: center;">
            <span style="font-size: 2rem;">üè®</span>
            <div style="font-weight: 700; margin-top: 8px;" id="count-hosters">0</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">Hosters</div>
          </div>
          <div style="padding: 16px; background: var(--cream); border-radius: 8px; text-align: center;">
            <span style="font-size: 2rem;">üõ°Ô∏è</span>
            <div style="font-weight: 700; margin-top: 8px;" id="count-guardas">0</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">Guardas</div>
          </div>
        </div>
      </div>
    </section>

    <!-- SECCI√ìN PLANTILLAS DE NORMAS -->
    <section class="admin-section" id="section-plantillas">
      <div class="section-header">
        <h2 class="section-title">üìã Plantillas de Normas</h2>
      </div>
      
      <!-- Selector de categor√≠a -->
      <div class="card">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-secondary plantilla-cat-btn active" data-cat="externos" onclick="seleccionarCategoriaPlantilla('externos')">
            üîë Para Externos
          </button>
          <button class="btn btn-secondary plantilla-cat-btn" data-cat="miembros" onclick="seleccionarCategoriaPlantilla('miembros')">
            üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Para Miembros
          </button>
        </div>
      </div>
      
      <!-- ===== PLANTILLAS PARA EXTERNOS ===== -->
      <div id="plantillas-externos-section">
        <div class="card">
          <div class="card-title">Plantillas base por tipo de colaborador</div>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
            Define las normas est√°ndar para cada tipo de externo. Estas plantillas se pueden copiar a cada bien.
          </p>
          
          <!-- Selector de tipo -->
          <div class="form-group">
            <label class="form-label">Tipo de colaborador</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-secondary plantilla-tipo-btn active" data-tipo="mayordomo" onclick="seleccionarTipoPlantilla('mayordomo')">
                üè† Casero (Mayordomo)
              </button>
              <button class="btn btn-secondary plantilla-tipo-btn" data-tipo="gerente" onclick="seleccionarTipoPlantilla('gerente')">
                üè® Hoster (Gerente)
              </button>
              <button class="btn btn-secondary plantilla-tipo-btn" data-tipo="capataz" onclick="seleccionarTipoPlantilla('capataz')">
                üåæ Guarda (Capataz)
              </button>
            </div>
          </div>
        </div>
        
        <!-- Editor de plantilla externos -->
        <div class="card" id="plantilla-editor">
          <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span id="plantilla-editor-titulo">üìã Normas para Casero (Mayordomo)</span>
            <button class="btn btn-primary btn-sm" onclick="abrirModalCapitulo()">‚ûï A√±adir cap√≠tulo</button>
          </div>
          
          <div id="plantilla-capitulos-container">
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
              <span style="font-size: 2.5rem; opacity: 0.5;">üìù</span>
              <p style="margin-top: 12px;">No hay cap√≠tulos definidos</p>
              <p style="font-size: 0.85rem;">A√±ade cap√≠tulos con sus preceptos para crear la plantilla</p>
            </div>
          </div>
        </div>
        
        <!-- Bienes que usan esta plantilla -->
        <div class="card">
          <div class="card-title">Bienes usando esta plantilla</div>
          <div id="plantilla-bienes-usando" style="font-size: 0.9rem; color: var(--text-muted);">
            <p>Cargando...</p>
          </div>
        </div>
      </div>
      
      <!-- ===== PLANTILLAS PARA MIEMBROS ===== -->
      <div id="plantillas-miembros-section" style="display: none;">
        <div class="card">
          <div class="card-title">Plantillas de normas de uso por tipo de bien</div>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
            Define las normas de uso est√°ndar para cada tipo de bien. Los miembros de la familia las ver√°n al consultar el bien.
          </p>
          
          <!-- Selector de tipo de bien -->
          <div class="form-group">
            <label class="form-label">Tipo de bien</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-secondary plantilla-bien-btn active" data-tipo="inmueble" onclick="seleccionarTipoBienPlantilla('inmueble')">
                üè† Inmuebles
              </button>
              <button class="btn btn-secondary plantilla-bien-btn" data-tipo="vehiculo" onclick="seleccionarTipoBienPlantilla('vehiculo')">
                üöó Veh√≠culos
              </button>
              <button class="btn btn-secondary plantilla-bien-btn" data-tipo="terreno" onclick="seleccionarTipoBienPlantilla('terreno')">
                üå≥ Terrenos
              </button>
            </div>
          </div>
        </div>
        
        <!-- Editor de plantilla miembros -->
        <div class="card" id="plantilla-miembros-editor">
          <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span id="plantilla-miembros-titulo">üìã Normas de uso para Inmuebles</span>
            <button class="btn btn-primary btn-sm" onclick="abrirModalCapituloMiembros()">‚ûï A√±adir cap√≠tulo</button>
          </div>
          
          <div id="plantilla-miembros-capitulos">
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
              <span style="font-size: 2.5rem; opacity: 0.5;">üìù</span>
              <p style="margin-top: 12px;">No hay cap√≠tulos definidos</p>
              <p style="font-size: 0.85rem;">A√±ade cap√≠tulos con sus preceptos para crear la plantilla</p>
            </div>
          </div>
        </div>
        
        <!-- Bienes que usan esta plantilla -->
        <div class="card">
          <div class="card-title">Bienes usando esta plantilla</div>
          <div id="plantilla-miembros-bienes" style="font-size: 0.9rem; color: var(--text-muted);">
            <p>Cargando...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- MODAL: A√±adir/Editar Cap√≠tulo (Externos) -->
    <div class="modal" id="modal-capitulo">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3 id="modal-capitulo-titulo">‚ûï Nuevo cap√≠tulo</h3>
          <button class="modal-close" onclick="cerrarModal('modal-capitulo')">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">T√≠tulo del cap√≠tulo *</label>
            <input type="text" class="form-input" id="capitulo-titulo" placeholder="Ej: Acceso y seguridad">
          </div>
          <div class="form-group">
            <label class="form-label">Preceptos</label>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">Un precepto por l√≠nea</p>
            <textarea class="form-input" id="capitulo-preceptos" rows="6" placeholder="Mantener puertas cerradas con llave&#10;No facilitar c√≥digos a terceros&#10;Revisar cerraduras semanalmente"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modal-capitulo')">Cancelar</button>
          <button class="btn btn-primary" onclick="guardarCapitulo()">üíæ Guardar</button>
        </div>
      </div>
    </div>

    <!-- MODAL: A√±adir/Editar Cap√≠tulo (Miembros) -->
    <div class="modal" id="modal-capitulo-miembros">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3 id="modal-capitulo-miembros-titulo">‚ûï Nuevo cap√≠tulo</h3>
          <button class="modal-close" onclick="cerrarModal('modal-capitulo-miembros')">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">T√≠tulo del cap√≠tulo *</label>
            <input type="text" class="form-input" id="capitulo-miembros-titulo" placeholder="Ej: Normas de convivencia">
          </div>
          <div class="form-group">
            <label class="form-label">Preceptos</label>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">Un precepto por l√≠nea</p>
            <textarea class="form-input" id="capitulo-miembros-preceptos" rows="6" placeholder="Apagar luces al salir&#10;No dejar comida fuera de la nevera&#10;Respetar horarios de descanso"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModal('modal-capitulo-miembros')">Cancelar</button>
          <button class="btn btn-primary" onclick="guardarCapituloMiembros()">üíæ Guardar</button>
        </div>
      </div>
    </div>
    </div>

    <section class="admin-section" id="section-planes">
      <div class="section-header"><h2 class="section-title">üìã Planes activos</h2></div>
      
      <!-- Plan de la rama -->
      <div class="card">
        <div class="card-title">Plan actual de la rama</div>
        <div id="plan-actual-info" style="padding: 16px; background: var(--cream); border-radius: 8px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 2rem;" id="plan-icono">üå±</span>
            <div>
              <div style="font-weight: 700; font-size: 1.1rem;" id="plan-nombre">Free</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);" id="plan-descripcion">Plan b√°sico gratuito</div>
            </div>
            <div style="margin-left: auto; text-align: right;">
              <div style="font-size: 1.5rem; font-weight: 700; color: var(--sage);" id="plan-precio">0‚Ç¨</div>
              <div style="font-size: 0.75rem; color: var(--text-muted);">/mes</div>
            </div>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="window.location.href='tienda.html'">üõí Ver planes disponibles</button>
      </div>
      
      <!-- Add-ons de la rama -->
      <div class="card">
        <div class="card-title">Add-ons de la rama</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Extensiones contratadas a nivel de rama (aplican a todos)</p>
        <div id="addons-rama-list">
          <div style="padding: 20px; text-align: center; color: var(--text-muted);">
            <span style="font-size: 2rem; opacity: 0.5;">üì¶</span>
            <p style="margin-top: 8px;">No hay add-ons a nivel de rama</p>
          </div>
        </div>
      </div>
      
      <!-- Resumen de facturaci√≥n -->
      <div class="card">
        <div class="card-title">üí≥ Resumen de facturaci√≥n mensual</div>
        <div id="resumen-facturacion">
          <!-- Se genera din√°micamente -->
        </div>
      </div>
      
      <!-- Desglose por nido -->
      <div class="card">
        <div class="card-title">Planes y add-ons por nido</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Desglose de contrataciones individuales por cada nido</p>
        <div id="planes-por-nido-list">
          <!-- Se genera din√°micamente -->
        </div>
      </div>
      
      <!-- Uso actual -->
      <div class="card">
        <div class="card-title">Uso actual</div>
        <div class="config-grid" style="gap: 12px;">
          <div style="padding: 16px; background: var(--cream); border-radius: 8px; text-align: center;">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Usuarios</div>
            <div style="font-weight: 700;"><span id="uso-usuarios">0</span> / <span id="limite-usuarios">10</span></div>
          </div>
          <div style="padding: 16px; background: var(--cream); border-radius: 8px; text-align: center;">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Bienes</div>
            <div style="font-weight: 700;"><span id="uso-bienes">0</span> / <span id="limite-bienes">5</span></div>
          </div>
          <div style="padding: 16px; background: var(--cream); border-radius: 8px; text-align: center;">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Almacenamiento</div>
            <div style="font-weight: 700;"><span id="uso-storage">0</span> / <span id="limite-storage">1</span> GB</div>
          </div>
        </div>
      </div>
    </section>

    <section class="admin-section" id="section-secciones">
      <div class="section-header">
        <h2 class="section-title">üìÇ Secciones</h2>
        <span class="auto-save-badge" style="font-size: 0.8rem; color: var(--sage); background: var(--sage-muted); padding: 4px 12px; border-radius: 20px;">üíæ Guardado autom√°tico</span>
      </div>
      
      <!-- Card: Secciones Principales -->
      <div class="card">
        <div class="card-title">üóÇÔ∏è Secciones principales</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Activa o desactiva secciones completas para toda la rama. Los miembros no ver√°n las secciones desactivadas.</p>
        <div class="config-grid" id="secciones-principales-grid"></div>
      </div>

      <!-- Card: Cerebro -->
      <div class="card subseccion-card" id="card-cerebro">
        <div class="card-title">üß† M√≥dulos del Cerebro</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Configura qu√© m√≥dulos del Cerebro est√°n disponibles</p>
        <div class="config-grid" id="cerebro-modulos-grid"></div>
      </div>

      <!-- Card: Lo Com√∫n -->
      <div class="card subseccion-card" id="card-locomun">
        <div class="card-title">üè† Tipos de bienes en Lo Com√∫n</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Elige qu√© tipos de bienes se pueden gestionar</p>
        <div class="config-grid" id="locomun-tipos-grid"></div>
      </div>

      <!-- Card: Legado -->
      <div class="card subseccion-card" id="card-legado">
        <div class="card-title">üìú Secciones del Legado</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Activa las secciones de legado familiar que quieras usar</p>
        <div class="config-grid" id="legado-secciones-grid"></div>
      </div>

      <!-- Card: Activaci√≥n -->
      <div class="card subseccion-card" id="card-activacion">
        <div class="card-title">üéØ Herramientas de Activaci√≥n</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Elige qu√© herramientas est√°n disponibles para los miembros</p>
        <div class="config-grid" id="activacion-herramientas-grid"></div>
      </div>

      <!-- Card: CTAs -->
      <div class="card">
        <div class="card-title">üé¨ Acciones r√°pidas (CTAs)</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Configura qu√© botones de acci√≥n aparecen en el panel principal</p>
        <div class="config-grid" id="ctas-grid"></div>
      </div>
    </section>

    <section class="admin-section" id="section-permisos">
      <div class="section-header"><h2 class="section-title">üîê Permisos por rol</h2></div>
      
      <!-- Tabla de Acceso a Zonas -->
      <div class="card">
        <div class="card-title">üìç Acceso a zonas</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Define qu√© zonas puede ver cada tipo de miembro</p>
        <div style="overflow-x: auto;">
          <table class="permisos-table">
            <thead><tr><th>Secci√≥n</th><th>Admin Rama</th><th>Patriarca</th><th>Matriarca</th><th>Admin Nido</th><th>Adulto</th><th>Ni√±o</th><th>Especial</th><th>Alejado</th></tr></thead>
            <tbody id="permisos-tbody"></tbody>
          </table>
        </div>
        <button class="btn btn-primary" style="margin-top: 16px;" onclick="guardarPermisos()">üíæ Guardar accesos</button>
      </div>

      <!-- Tabla de Acciones CVEB -->
      <div class="card">
        <div class="card-title">‚öôÔ∏è Permisos de acciones (CVEB)</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">Define qu√© acciones puede realizar cada rol en cada zona</p>
        
        <div class="cveb-legend">
          <span><span class="cveb-letter c">C</span> Crear</span>
          <span><span class="cveb-letter v">V</span> Ver</span>
          <span><span class="cveb-letter e">E</span> Editar</span>
          <span><span class="cveb-letter b">B</span> Borrar</span>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="cveb-table">
            <thead>
              <tr>
                <th rowspan="2">M√≥dulo</th>
                <th colspan="4" class="rol-header" style="background: var(--rojo); color: white;">Admin Rama</th>
                <th colspan="4" class="rol-header cveb-group" style="background: #8B7355; color: white;">Patriarca</th>
                <th colspan="4" class="rol-header cveb-group" style="background: #9B7EB8; color: white;">Matriarca</th>
                <th colspan="4" class="rol-header cveb-group">Admin Nido</th>
                <th colspan="4" class="rol-header cveb-group">Adulto</th>
                <th colspan="4" class="rol-header cveb-group">Ni√±o</th>
                <th colspan="4" class="rol-header cveb-group">Especial</th>
                <th colspan="4" class="rol-header cveb-group">Alejado</th>
              </tr>
              <tr>
                <!-- Admin Rama -->
                <th><span class="cveb-letter c">C</span></th>
                <th><span class="cveb-letter v">V</span></th>
                <th><span class="cveb-letter e">E</span></th>
                <th><span class="cveb-letter b">B</span></th>
                <!-- Patriarca -->
                <th class="cveb-group"><span class="cveb-letter c">C</span></th>
                <th><span class="cveb-letter v">V</span></th>
                <th><span class="cveb-letter e">E</span></th>
                <th><span class="cveb-letter b">B</span></th>
                <!-- Matriarca -->
                <th class="cveb-group"><span class="cveb-letter c">C</span></th>
                <th><span class="cveb-letter v">V</span></th>
                <th><span class="cveb-letter e">E</span></th>
                <th><span class="cveb-letter b">B</span></th>
                <!-- Admin Nido -->
                <th class="cveb-group"><span class="cveb-letter c">C</span></th>
                <th><span class="cveb-letter v">V</span></th>
                <th><span class="cveb-letter e">E</span></th>
                <th><span class="cveb-letter b">B</span></th>
                <!-- Adulto -->
                <th class="cveb-group"><span class="cveb-letter c">C</span></th>
                <th><span class="cveb-letter v">V</span></th>
                <th><span class="cveb-letter e">E</span></th>
                <th><span class="cveb-letter b">B</span></th>
                <!-- Ni√±o -->
                <th class="cveb-group"><span class="cveb-letter c">C</span></th>
                <th><span class="cveb-letter v">V</span></th>
                <th><span class="cveb-letter e">E</span></th>
                <th><span class="cveb-letter b">B</span></th>
                <!-- Especial -->
                <th class="cveb-group"><span class="cveb-letter c">C</span></th>
                <th><span class="cveb-letter v">V</span></th>
                <th><span class="cveb-letter e">E</span></th>
                <th><span class="cveb-letter b">B</span></th>
                <!-- Alejado -->
                <th class="cveb-group"><span class="cveb-letter c">C</span></th>
                <th><span class="cveb-letter v">V</span></th>
                <th><span class="cveb-letter e">E</span></th>
                <th><span class="cveb-letter b">B</span></th>
              </tr>
            </thead>
            <tbody id="cveb-tbody"></tbody>
          </table>
        </div>
        <button class="btn btn-primary" style="margin-top: 16px;" onclick="guardarPermisosCVEB()">üíæ Guardar permisos CVEB</button>
      </div>
    </section>

    <section class="admin-section" id="section-estirpe">
      <div class="section-header"><h2 class="section-title">‚öôÔ∏è Configuraci√≥n de la Rama</h2></div>
      <div class="card">
        <div class="card-title">Datos b√°sicos</div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Nombre de la estirpe</label><input type="text" class="form-input" id="config-nombre" placeholder="Familia Garc√≠a"></div>
          <div class="form-group"><label class="form-label">Descripci√≥n</label><input type="text" class="form-input" id="config-descripcion" placeholder="Breve descripci√≥n..."></div>
        </div>
        <div class="form-group"><label class="form-label">Lema familiar (opcional)</label><input type="text" class="form-input" id="config-lema" placeholder="Unidos somos m√°s fuertes"></div>
        <button class="btn btn-primary" onclick="guardarConfigRama()">üíæ Guardar cambios</button>
      </div>

      <div class="card">
        <div class="card-title">üå≥ √Årbol geneal√≥gico</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
          Configura cu√°ntas generaciones quieres registrar en tu √°rbol familiar
        </p>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">N√∫mero de generaciones</label>
            <select class="form-input" id="config-generaciones" onchange="actualizarGeneraciones()">
              <option value="4">4 generaciones (Bisabuelos ‚Üí Hijos)</option>
              <option value="6">6 generaciones (+ Tatarabuelos)</option>
              <option value="8">8 generaciones (+ Pentabuelos)</option>
            </select>
          </div>
        </div>
        <div id="generaciones-preview" style="margin-top: 12px; padding: 12px; background: var(--cream); border-radius: 8px; font-size: 0.85rem;">
          <!-- Se llena din√°micamente -->
        </div>
      </div>

      <div class="card">
        <div class="card-title">üë§ Miembros fallecidos</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
          Los miembros con fecha de defunci√≥n aparecer√°n en gris y solo tendr√°n acceso a:
        </p>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
          <span style="padding: 4px 12px; background: var(--sage-muted); border-radius: 20px; font-size: 0.8rem;">üå≥ √Årbol</span>
          <span style="padding: 4px 12px; background: var(--sage-muted); border-radius: 20px; font-size: 0.8rem;">üìã Ficha personal</span>
          <span style="padding: 4px 12px; background: var(--sage-muted); border-radius: 20px; font-size: 0.8rem;">üìú Legado</span>
          <span style="padding: 4px 12px; background: var(--sage-muted); border-radius: 20px; font-size: 0.8rem;">üìÖ Fechas</span>
        </div>
        <p style="font-size: 0.8rem; color: var(--text-light);">
          ‚ö†Ô∏è Solo los administradores de sistema pueden editar la informaci√≥n de miembros fallecidos.
        </p>
      </div>

      <div class="card">
        <div class="card-title">üö® Zona de peligro</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Estas acciones son irreversibles</p>
        <button class="btn btn-danger" onclick="exportarDatos()">üì• Exportar todos los datos</button>
      </div>
    </section>
  </main>

  <div class="modal-overlay" id="modal-invitar">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">‚ûï Invitar usuario</h3><button class="modal-close" onclick="cerrarModal('modal-invitar')">√ó</button></div>
      <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="invitar-email" placeholder="email@ejemplo.com"></div>
      <div class="form-group"><label class="form-label">Nido</label><select class="form-input" id="invitar-nido"><option value="">Sin asignar</option></select></div>
      <div class="form-group"><label class="form-label">Credenciales</label><select class="form-input" id="invitar-rol"><option value="adulto">üë§ Adulto</option><option value="nino">üë∂ Ni√±o</option><option value="especial">‚≠ê Especial</option><option value="alejado">üö™ Alejado</option><option value="adminNido">üè† Admin Nido</option><option value="patriarca">üßî Patriarca</option><option value="matriarca">üëµ Matriarca</option><option value="adminRama">üëë Admin Rama</option></select></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modal-invitar')">Cancelar</button><button class="btn btn-primary" onclick="enviarInvitacion()">Enviar invitaci√≥n</button></div>
    </div>
  </div>

  <!-- Modal Editar Usuario -->
  <div class="modal-overlay" id="modal-editar-usuario">
    <div class="modal" style="max-width:550px;">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Editar Perfil</h3>
        <button class="modal-close" onclick="cerrarModal('modal-editar-usuario')">√ó</button>
      </div>
      <div style="padding:20px;max-height:70vh;overflow-y:auto;">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nombre *</label>
            <input type="text" class="form-input" id="editar-usuario-nombre" placeholder="Nombre completo">
          </div>
          <div class="form-group">
            <label class="form-label">Apodo</label>
            <input type="text" class="form-input" id="editar-usuario-apodo" placeholder="C√≥mo le llaman">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="editar-usuario-email" disabled style="background:var(--cream)">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Tel√©fono</label>
            <input type="tel" class="form-input" id="editar-usuario-telefono" placeholder="+34 600 000 000">
          </div>
          <div class="form-group">
            <label class="form-label">Fecha nacimiento</label>
            <input type="date" class="form-input" id="editar-usuario-nacimiento">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Credenciales</label>
            <select class="form-input" id="editar-usuario-rol">
              <option value="adminRama">üëë Admin Rama</option>
              <option value="patriarca">üßî Patriarca</option>
              <option value="matriarca">üëµ Matriarca</option>
              <option value="adminNido">üè† Admin Nido</option>
              <option value="adulto">üë§ Adulto</option>
              <option value="nino">üë∂ Ni√±o</option>
              <option value="especial">‚≠ê Especial</option>
              <option value="alejado">üö™ Alejado</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Nido asignado</label>
            <select class="form-input" id="editar-usuario-nido"></select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Relaci√≥n en su nido</label>
          <select class="form-input" id="editar-usuario-relacion">
            <option value="progenitor">Progenitor (padre/madre)</option>
            <option value="descendiente">Descendiente (hijo/a)</option>
            <option value="ascendiente">Ascendiente (abuelo/a)</option>
            <option value="otro">Otro</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Notas internas</label>
          <textarea class="form-input" id="editar-usuario-notas" rows="2" placeholder="Notas privadas del administrador..."></textarea>
        </div>
        <div style="border-top:1px solid var(--cream-dark);padding-top:16px;margin-top:8px;">
          <label class="form-label" style="color:var(--text-muted)">üïäÔ∏è Fecha de defunci√≥n (si aplica)</label>
          <input type="date" class="form-input" id="editar-usuario-defuncion" style="max-width:200px;">
          <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Los miembros fallecidos aparecer√°n en gris en el √°rbol.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cerrarModal('modal-editar-usuario')">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarPerfilUsuario()">üíæ Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Tipo Reserva -->
  <div class="modal-overlay" id="modal-tipo-reserva">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-tipo-titulo">‚ûï Nuevo tipo de reserva</h3>
        <button class="modal-close" onclick="cerrarModal('modal-tipo-reserva')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Nombre</label>
        <input type="text" class="form-input" id="tipo-nombre" placeholder="Ej: Familia Garc√≠a, Cazadores...">
      </div>
      <div class="form-group">
        <label class="form-label">Emoji (opcional)</label>
        <input type="text" class="form-input" id="tipo-emoji" placeholder="Ej: üë®‚Äçüë©‚Äçüëß‚Äçüë¶, ü¶å, üë©" maxlength="2">
      </div>
      <div class="form-group">
        <label class="form-label">Color</label>
        <div class="color-grid" id="color-grid">
          <div class="color-option" style="background:#7A9E7E" data-color="#7A9E7E" onclick="seleccionarColor('#7A9E7E')"></div>
          <div class="color-option" style="background:#C17757" data-color="#C17757" onclick="seleccionarColor('#C17757')"></div>
          <div class="color-option" style="background:#6B8E9F" data-color="#6B8E9F" onclick="seleccionarColor('#6B8E9F')"></div>
          <div class="color-option" style="background:#E8A0B5" data-color="#E8A0B5" onclick="seleccionarColor('#E8A0B5')"></div>
          <div class="color-option" style="background:#D4A574" data-color="#D4A574" onclick="seleccionarColor('#D4A574')"></div>
          <div class="color-option" style="background:#7EAAA6" data-color="#7EAAA6" onclick="seleccionarColor('#7EAAA6')"></div>
          <div class="color-option" style="background:#9B7EB8" data-color="#9B7EB8" onclick="seleccionarColor('#9B7EB8')"></div>
          <div class="color-option" style="background:#8B7355" data-color="#8B7355" onclick="seleccionarColor('#8B7355')"></div>
          <div class="color-option" style="background:#B8860B" data-color="#B8860B" onclick="seleccionarColor('#B8860B')"></div>
          <div class="color-option" style="background:#9A9A9A" data-color="#9A9A9A" onclick="seleccionarColor('#9A9A9A')"></div>
        </div>
        <input type="hidden" id="tipo-color" value="#7A9E7E">
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm hidden" id="btn-eliminar-tipo" onclick="eliminarTipoReserva()">üóëÔ∏è Eliminar</button>
        <div style="display:flex;gap:12px;">
          <button class="btn btn-secondary" onclick="cerrarModal('modal-tipo-reserva')">Cancelar</button>
          <button class="btn btn-primary" onclick="guardarTipoReserva()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <script>
    let currentUser = null, userData = null, familiaData = null, usuariosData = [], nidosData = [], bienesData = [], invitacionesData = [], solicitudesData = [];
    let nidosNumerados = {}; // Cache de numeraci√≥n de nidos
    let bienSeleccionado = null;
    let tiposReservaData = [];
    let editandoTipoId = null;

    // ============ CONFIGURACI√ìN DE SECCIONES ============
    const seccionesPrincipales = [
      { id: 'miNido', nombre: 'Mi Nido', icono: 'ü™∫', desc: 'Panel personal del nido' },
      { id: 'arbol', nombre: '√Årbol', icono: 'üå≥', desc: '√Årbol geneal√≥gico' },
      { id: 'cerebro', nombre: 'Cerebro', icono: 'üß†', desc: 'Centro de conocimiento' },
      { id: 'locomun', nombre: 'Lo Com√∫n', icono: 'üè†', desc: 'Bienes compartidos' },
      { id: 'legado', nombre: 'Legado', icono: 'üìú', desc: 'Historia y tradiciones' },
      { id: 'activacion', nombre: 'Activaci√≥n', icono: 'üéØ', desc: 'Herramientas y din√°micas' },
      { id: 'chat', nombre: 'Chat', icono: 'üí¨', desc: 'Mensajer√≠a familiar' }
    ];

    const cerebroModulos = [
      { id: 'analisis', nombre: 'An√°lisis', icono: 'üìä', desc: 'Estad√≠sticas de uso' },
      { id: 'intuicion', nombre: 'Intuici√≥n', icono: 'üí°', desc: 'Propuestas y sugerencias' },
      { id: 'memoria', nombre: 'Memoria', icono: 'üóÑÔ∏è', desc: 'Repositorio de documentos' },
      { id: 'razonamiento', nombre: 'Razonamiento', icono: 'üìê', desc: 'Instrucciones y pautas' }
    ];

    const locomunTipos = [
      { id: 'inmuebles', nombre: 'Inmuebles', icono: 'üè°', desc: 'Casas, pisos, locales' },
      { id: 'terrenos', nombre: 'Terrenos', icono: 'üåæ', desc: 'Fincas, parcelas, campos' },
      { id: 'vehiculos', nombre: 'Veh√≠culos', icono: 'üöó', desc: 'Coches, motos, embarcaciones' }
    ];

    const legadoSecciones = [
      { id: 'recetas', nombre: 'Recetas', icono: 'üë®‚Äçüç≥', desc: 'Recetario familiar' },
      { id: 'fotos', nombre: 'Fotos', icono: 'üì∑', desc: '√Ålbum fotogr√°fico' },
      { id: 'historias', nombre: 'Historias', icono: '‚úçÔ∏è', desc: 'Relatos y memorias' },
      { id: 'valores', nombre: 'Valores', icono: 'üíé', desc: 'Principios familiares' },
      { id: 'tradiciones', nombre: 'Tradiciones', icono: 'üéÑ', desc: 'Costumbres y rituales' },
      { id: 'anecdotas', nombre: 'An√©cdotas', icono: 'üòÑ', desc: 'Momentos divertidos' },
      { id: 'sabiduria', nombre: 'Sabidur√≠a', icono: 'üßì', desc: 'Consejos y ense√±anzas' }
    ];

    const activacionHerramientas = [
      { id: 'fechas', nombre: 'Fechas', icono: 'üìÖ', desc: 'Acordar fechas' },
      { id: 'amigo', nombre: 'Amigo Invisible', icono: 'üéÅ', desc: 'Sorteo de regalos' },
      { id: 'listas', nombre: 'Listas', icono: 'üìù', desc: 'Listas colaborativas' },
      { id: 'porras', nombre: 'Porras', icono: 'üé≤', desc: 'Apuestas amistosas' },
      { id: 'mercadillo', nombre: 'Mercadillo', icono: 'üè∑Ô∏è', desc: 'Compra-venta familiar' },
      { id: 'votaciones', nombre: 'Votaciones', icono: 'üó≥Ô∏è', desc: 'Decisiones colectivas' },
      { id: 'encuestas', nombre: 'Encuestas', icono: 'üìä', desc: 'Sondeos de opini√≥n' },
      { id: 'turnos', nombre: 'Turnos', icono: 'üîÑ', desc: 'Rotaci√≥n de tareas' },
      { id: 'asistencia', nombre: 'Asistencia', icono: '‚úã', desc: 'Confirmar asistencia' },
      { id: 'mesas', nombre: 'Colocar mesas', icono: 'ü™ë', desc: 'Distribuci√≥n de invitados' },
      { id: 'escaleta', nombre: 'Escaleta', icono: 'üìã', desc: 'Programa de eventos' }
    ];

    const ctasDisponibles = [
      { id: 'averia', nombre: 'Avisar aver√≠a', icono: 'üîß', desc: 'Reportar problemas' },
      { id: 'iniciativa', nombre: 'Proponer idea', icono: 'üí°', desc: 'Sugerir iniciativas' },
      { id: 'evento', nombre: 'Solicitar evento', icono: 'üéâ', desc: 'Pedir celebraciones' },
      { id: 'reserva', nombre: 'Solicitar reserva', icono: 'üìÖ', desc: 'Reservar bienes' },
      { id: 'queo', nombre: 'Enviar queo', icono: 'üì£', desc: 'Comunicados r√°pidos' },
      { id: 'convocar', nombre: 'Convocar', icono: '‚úã', desc: 'Llamar a reuni√≥n' }
    ];

    const permisosBase = [
      { seccion: '√Årbol', permisos: { adminRama: true, patriarca: true, matriarca: true, adminNido: true, adulto: true, nino: true, especial: true, alejado: false } },
      { seccion: 'Cerebro', permisos: { adminRama: true, patriarca: true, matriarca: true, adminNido: true, adulto: true, nino: false, especial: true, alejado: false } },
      { seccion: 'Lo Com√∫n', permisos: { adminRama: true, patriarca: true, matriarca: true, adminNido: true, adulto: true, nino: false, especial: true, alejado: false } },
      { seccion: 'Legado', permisos: { adminRama: true, patriarca: true, matriarca: true, adminNido: true, adulto: true, nino: true, especial: true, alejado: true } },
      { seccion: 'Invitar usuarios', permisos: { adminRama: true, patriarca: true, matriarca: true, adminNido: true, adulto: false, nino: false, especial: false, alejado: false } },
      { seccion: 'Editar nidos', permisos: { adminRama: true, patriarca: true, matriarca: true, adminNido: true, adulto: false, nino: false, especial: false, alejado: false } },
      { seccion: 'Gestionar bienes', permisos: { adminRama: true, patriarca: true, matriarca: true, adminNido: false, adulto: false, nino: false, especial: false, alejado: false } }
    ];

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;

      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists || !userDoc.data().familiaId) { alert('No tienes acceso'); window.location.href = 'cgi.html'; return; }
      userData = userDoc.data();

      const familiaDoc = await db.collection('familias').doc(userData.familiaId).get();
      if (!familiaDoc.exists) { window.location.href = 'cgi.html'; return; }
      familiaData = { id: familiaDoc.id, ...familiaDoc.data() };

      const isAdmin = userData.rol === 'adminRama' || familiaData.adminsGenerales?.includes(user.uid) || familiaData.fundador === user.uid || familiaData.creador === user.uid;
      if (!isAdmin) { alert('No tienes permisos de administrador'); window.location.href = 'cgi.html'; return; }

      document.getElementById('estirpe-nombre').textContent = familiaData.nombre || 'Mi Rama';
      await cargarDatos();
    });

    async function cargarDatos() {
      const nidosSnap = await db.collection('nidos').where('familiaId', '==', familiaData.id).get();
      nidosData = nidosSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      const usuariosSnap = await db.collection('usuarios').where('familiaId', '==', familiaData.id).get();
      usuariosData = usuariosSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      const bienesSnap = await db.collection('bienes').where('familiaId', '==', familiaData.id).get();
      bienesData = bienesSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      // Cargar invitaciones pendientes (try-catch por si no hay permisos o √≠ndice)
      try {
        const invitacionesSnap = await db.collection('invitaciones')
          .where('familiaId', '==', familiaData.id)
          .where('estado', '==', 'pendiente')
          .get();
        invitacionesData = invitacionesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        console.log('‚úÖ Invitaciones cargadas:', invitacionesData.length);
      } catch (e) {
        console.error('‚ùå Error cargando invitaciones:', e);
        // Si el error menciona "index", es que falta el √≠ndice compuesto
        if (e.message && e.message.includes('index')) {
          console.error('‚ö†Ô∏è FALTA √çNDICE EN FIRESTORE. Haz clic en el enlace del error de arriba para crearlo.');
        }
        invitacionesData = [];
      }

      // Cargar solicitudes de todos los bienes de la familia
      try {
        solicitudesData = [];
        for (const bien of bienesData) {
          const solSnap = await db.collection('bienes').doc(bien.id).collection('solicitudes')
            .orderBy('fechaCreacion', 'desc')
            .limit(50)
            .get();
          solSnap.docs.forEach(d => {
            solicitudesData.push({ 
              id: d.id, 
              bienId: bien.id, 
              bienNombre: bien.nombre,
              bienTipo: bien.tipo,
              ...d.data() 
            });
          });
        }
        // Ordenar por fecha m√°s reciente
        solicitudesData.sort((a, b) => {
          const fa = a.fechaCreacion?.toDate?.() || new Date(0);
          const fb = b.fechaCreacion?.toDate?.() || new Date(0);
          return fb - fa;
        });
      } catch (e) {
        console.log('No se pudieron cargar solicitudes:', e.message);
        solicitudesData = [];
      }

      document.getElementById('stat-usuarios').textContent = usuariosData.length;
      document.getElementById('stat-invitaciones').textContent = invitacionesData.length;
      document.getElementById('stat-nidos').textContent = nidosData.length;
      document.getElementById('stat-bienes').textContent = bienesData.length;
      
      // Estirpes: nidos de generaci√≥n 2 que tienen descendientes con nidos
      const estirpes = calcularEstirpes();
      document.getElementById('stat-estirpes').textContent = estirpes.length || 0;
      
      // Generaciones: contar reales incluyendo HIJOS si hay bisnietos
      let numGeneraciones = 0;
      if (nidosData.length > 0) {
        const generacionesSet = new Set();
        nidosData.forEach(n => {
          const genNum = getGenNum(n.generacion);
          if (genNum > 0) generacionesSet.add(genNum);
        });
        
        // Si hay hijos en nidos de gen3, a√±adir generaci√≥n 4
        const gen3Nidos = nidosData.filter(n => getGenNum(n.generacion) === 3);
        const hayBisnietos = gen3Nidos.some(n => {
          const miembros = n.miembrosData || [];
          return miembros.some(m => m.relacion === 'hijo' || m.relacion === 'descendiente');
        });
        if (hayBisnietos) generacionesSet.add(4);
        
        numGeneraciones = generacionesSet.size;
      }
      document.getElementById('stat-generaciones').textContent = numGeneraciones;

      // Calcular numeraci√≥n jer√°rquica de nidos ANTES de renderizar
      calcularNumeracionNidos();

      renderUsuarios();
      renderGestion();
      renderSecciones();
      renderPermisos();
      renderCVEB();
      renderConfigRama();
      renderPlanes();
      renderSolicitudes();
      await cargarTiposReserva();
      await cargarExternos();
      await cargarPlantillas();
      await cargarPlantillasMiembros();

      document.getElementById('invitar-nido').innerHTML = '<option value="">Sin asignar</option>' + nidosData.map(n => `<option value="${n.id}">${nidosNumerados[n.id] || ''} ${n.nombre}</option>`).join('');
    }

    // ============ NUMERACI√ìN JER√ÅRQUICA DE NIDOS ============
    function getGenNum(gen) {
      const match = String(gen || '1').match(/^(\d+)/);
      return match ? parseInt(match[1]) : 1;
    }

    function calcularEstirpes() {
      // Una estirpe es un nido de gen2 que tiene descendientes con nidos
      const porGeneracion = {};
      nidosData.forEach(n => {
        const genNum = getGenNum(n.generacion);
        if (!porGeneracion[genNum]) porGeneracion[genNum] = [];
        porGeneracion[genNum].push(n);
      });

      const gen2 = porGeneracion[2] || [];
      const gen3 = porGeneracion[3] || [];

      return gen2.filter(nido => {
        // Verificar si tiene hijos directos en gen3
        return gen3.some(n => n.nidoOrigen === nido.id);
      });
    }

    function calcularNumeracionNidos() {
      nidosNumerados = {};
      
      // Agrupar por generaci√≥n
      const porGeneracion = {};
      nidosData.forEach(n => {
        const genNum = getGenNum(n.generacion);
        if (!porGeneracion[genNum]) porGeneracion[genNum] = [];
        porGeneracion[genNum].push(n);
      });

      // Ordenar cada generaci√≥n por fechaFormacion o fechaCreacion
      Object.keys(porGeneracion).forEach(gen => {
        porGeneracion[gen].sort((a, b) => {
          const fechaA = a.fechaFormacion || a.fechaCreacion?.seconds || 9999999999;
          const fechaB = b.fechaFormacion || b.fechaCreacion?.seconds || 9999999999;
          const dateA = typeof fechaA === 'number' ? fechaA : new Date(fechaA).getTime();
          const dateB = typeof fechaB === 'number' ? fechaB : new Date(fechaB).getTime();
          return dateA - dateB;
        });
      });

      // Gen 1: Bisabuelos = "1"
      if (porGeneracion[1]) {
        porGeneracion[1].forEach((nido, idx) => {
          nidosNumerados[nido.id] = '1';
        });
      }

      // Gen 2: Abuelos = 2.1, 2.2, 2.3...
      if (porGeneracion[2]) {
        porGeneracion[2].forEach((nido, idx) => {
          nidosNumerados[nido.id] = `2.${idx + 1}`;
        });
      }

      // Gen 3: Padres = prefijo del padre + orden
      if (porGeneracion[3]) {
        const porPadre = {};
        porGeneracion[3].forEach(nido => {
          const padreId = nido.nidoOrigen || 'root';
          if (!porPadre[padreId]) porPadre[padreId] = [];
          porPadre[padreId].push(nido);
        });

        Object.keys(porPadre).forEach(padreId => {
          const hijos = porPadre[padreId];
          const prefijo = nidosNumerados[padreId] || '?';
          hijos.forEach((nido, idx) => {
            nidosNumerados[nido.id] = `${prefijo}.${idx + 1}`;
          });
        });
      }

      // Gen 4: Hijos = prefijo del padre + orden
      if (porGeneracion[4]) {
        const porPadre = {};
        porGeneracion[4].forEach(nido => {
          const padreId = nido.nidoOrigen || 'root';
          if (!porPadre[padreId]) porPadre[padreId] = [];
          porPadre[padreId].push(nido);
        });

        Object.keys(porPadre).forEach(padreId => {
          const hijos = porPadre[padreId];
          const prefijo = nidosNumerados[padreId] || '?';
          hijos.forEach((nido, idx) => {
            nidosNumerados[nido.id] = `${prefijo}.${idx + 1}`;
          });
        });
      }
    }

    function cambiarSeccion(seccion) {
      document.querySelectorAll('.admin-tab').forEach(t => { t.classList.remove('active'); if (t.dataset.section === seccion) t.classList.add('active'); });
      document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
      document.getElementById(`section-${seccion}`).classList.add('active');
    }

    const ROLES_LABELS = {
      'adminRama': 'üëë Admin Rama',
      'patriarca': 'üßî Patriarca',
      'matriarca': 'üëµ Matriarca',
      'adminNido': 'üè† Admin Nido', 
      'adulto': 'üë§ Adulto',
      'nino': 'üë∂ Ni√±o',
      'especial': '‚≠ê Especial',
      'alejado': 'üö™ Alejado'
    };

    function renderUsuarios() {
      // Ordenar usuarios por nombre alfab√©tico (TODO: a√±adir fechaNacimiento para ordenar por edad)
      const usuariosOrdenados = [...usuariosData].sort((a, b) => {
        const nombreA = (a.nombre || a.email || '').toLowerCase();
        const nombreB = (b.nombre || b.email || '').toLowerCase();
        return nombreA.localeCompare(nombreB);
      });

      // Funci√≥n para obtener TODOS los nidos donde aparece un usuario
      // Esto permite identificar qui√©n est√° en 2 nidos (ej: hijo en uno, progenitor en otro)
      function getNidosUsuario(userId, email, userNidoId) {
        let nidosDelUsuario = [];
        
        // Buscar en TODOS los nidos donde aparece este usuario
        nidosData.forEach(nido => {
          const miembrosNido = nido.miembrosData || [];
          const miembro = miembrosNido.find(m => 
            (m.email && email && m.email.toLowerCase() === email.toLowerCase()) ||
            (m.uid && m.uid === userId)
          );
          
          if (miembro) {
            const esProgenitor = miembro.relacion === 'progenitor' || miembro.relacion === 'consorte';
            nidosDelUsuario.push({ 
              nido: nido, 
              esProgenitor: esProgenitor,
              relacion: miembro.relacion
            });
          }
        });
        
        // Ordenar: primero donde es progenitor, luego descendiente
        nidosDelUsuario.sort((a, b) => {
          if (a.esProgenitor && !b.esProgenitor) return -1;
          if (!a.esProgenitor && b.esProgenitor) return 1;
          return 0;
        });

        return nidosDelUsuario;
      }

      // Renderizar usuarios activos ordenados por fechaCreacion (m√°s antiguos primero = mayor edad)
      let html = usuariosOrdenados.map((u, idx) => {
        const inicial = (u.nombre || u.email || '?').charAt(0).toUpperCase();
        const nidosDelUsuario = getNidosUsuario(u.id, u.email, u.nidoId);
        const numMiembro = `M${String(idx + 1).padStart(3, '0')}`;
        const rolClass = (u.rol === 'adminRama' || u.rol === 'adminNido') ? 'admin' : 
                        (['novio','prometido','separado','divorciado'].includes(u.rol)) ? 'especial' : 'miembro';
        const rolLabel = ROLES_LABELS[u.rol] || u.rol || 'Adulto';
        
        // Mostrar c√≥digos de nido (todos los que tenga)
        let nidosHtml = '';
        if (nidosDelUsuario.length > 0) {
          nidosHtml = nidosDelUsuario.slice(0, 3).map(item => {
            const codigo = nidosNumerados[item.nido.id] || '?';
            const icono = item.esProgenitor ? 'üë®‚Äçüë©‚Äçüëß' : 'üë∂';
            return `<span class="nido-badge" title="${item.nido.nombre || 'Nido'} (${item.relacion || 'miembro'})">${icono} ${codigo}</span>`;
          }).join('');
          if (nidosDelUsuario.length > 3) {
            nidosHtml += `<span class="nido-badge" style="background:var(--text-muted);color:white">+${nidosDelUsuario.length - 3}</span>`;
          }
        } else {
          nidosHtml = '<span style="color:var(--text-muted)">‚Äî</span>';
        }

        return `<tr class="user-row">
          <td><strong style="font-family:'Quicksand',sans-serif;color:var(--text-muted)">${numMiembro}</strong></td>
          <td><div class="user-info"><div class="user-avatar">${inicial}</div><div><div class="user-name">${u.nombre || 'Sin nombre'}</div><div class="user-email">${u.email}</div></div></div></td>
          <td><div class="user-nidos">${nidosHtml}</div></td>
          <td><span class="role-badge ${rolClass}">${rolLabel}</span></td>
          <td><button class="btn btn-secondary btn-sm" onclick="abrirModalEditarUsuario('${u.id}')">‚úèÔ∏è</button></td>
        </tr>`;
      }).join('');

      // A√±adir invitaciones pendientes
      if (invitacionesData.length > 0) {
        html += invitacionesData.map((inv, idx) => {
          const nido = nidosData.find(n => n.id === inv.nidoId);
          return `<tr class="user-row" style="opacity:0.7">
            <td><strong style="font-family:'Quicksand',sans-serif;color:var(--warning)">INV${String(idx + 1).padStart(2, '0')}</strong></td>
            <td><div class="user-info"><div class="user-avatar" style="background:#F6E05E;color:#744210">‚úâÔ∏è</div><div><div class="user-name" style="color:var(--text-muted)">${inv.email}</div><div class="user-email">Pendiente de aceptar</div></div></div></td>
            <td>${nido ? `<span class="nido-badge">${nido.nombre}</span>` : '‚Äî'}</td>
            <td><span class="role-badge invitado">üì© Invitado</span></td>
            <td><button class="btn btn-secondary btn-sm" onclick="reenviarInvitacion('${inv.id}')">üì§</button><button class="btn btn-secondary btn-sm" onclick="cancelarInvitacion('${inv.id}')" style="margin-left:4px">‚ùå</button></td>
          </tr>`;
        }).join('');
      }

      document.getElementById('usuarios-tbody').innerHTML = html;
    }

    let editandoUsuarioId = null;

    function abrirModalEditarUsuario(userId) {
      const user = usuariosData.find(u => u.id === userId);
      if (!user) return;
      editandoUsuarioId = userId;
      
      // Cargar datos en el formulario
      document.getElementById('editar-usuario-nombre').value = user.nombre || '';
      document.getElementById('editar-usuario-apodo').value = user.apodo || '';
      document.getElementById('editar-usuario-email').value = user.email || '';
      document.getElementById('editar-usuario-telefono').value = user.telefono || '';
      document.getElementById('editar-usuario-nacimiento').value = user.fechaNacimiento || '';
      document.getElementById('editar-usuario-rol').value = user.rol || 'adulto';
      document.getElementById('editar-usuario-relacion').value = user.relacion || 'progenitor';
      document.getElementById('editar-usuario-notas').value = user.notasAdmin || '';
      document.getElementById('editar-usuario-defuncion').value = user.fechaDefuncion || '';
      
      // Popular selector de nidos
      const selectNido = document.getElementById('editar-usuario-nido');
      selectNido.innerHTML = '<option value="">Sin asignar</option>' + 
        nidosData.map(n => {
          const codigo = nidosNumerados[n.id] || '';
          return `<option value="${n.id}" ${user.nidoId === n.id ? 'selected' : ''}>${codigo} ${n.nombre || 'Nido'}</option>`;
        }).join('');
      
      document.getElementById('modal-editar-usuario').classList.add('active');
    }

    async function guardarPerfilUsuario() {
      if (!editandoUsuarioId) return;
      
      const data = {
        nombre: document.getElementById('editar-usuario-nombre').value.trim(),
        apodo: document.getElementById('editar-usuario-apodo').value.trim(),
        telefono: document.getElementById('editar-usuario-telefono').value.trim(),
        fechaNacimiento: document.getElementById('editar-usuario-nacimiento').value || null,
        rol: document.getElementById('editar-usuario-rol').value,
        nidoId: document.getElementById('editar-usuario-nido').value || null,
        relacion: document.getElementById('editar-usuario-relacion').value,
        notasAdmin: document.getElementById('editar-usuario-notas').value.trim(),
        fechaDefuncion: document.getElementById('editar-usuario-defuncion').value || null,
        fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (!data.nombre) {
        alert('El nombre es obligatorio');
        return;
      }

      try {
        await db.collection('usuarios').doc(editandoUsuarioId).update(data);
        cerrarModal('modal-editar-usuario');
        await cargarDatos();
        alert('‚úÖ Perfil actualizado');
      } catch (err) {
        console.error(err);
        alert('Error: ' + err.message);
      }
    }

    // Mantener compatibilidad con funci√≥n antigua
    async function guardarRolUsuario() {
      await guardarPerfilUsuario();
    }

    async function cancelarInvitacion(invId) {
      if (!confirm('¬øCancelar esta invitaci√≥n?')) return;
      try {
        await db.collection('invitaciones').doc(invId).delete();
        await cargarDatos();
        alert('‚úÖ Invitaci√≥n cancelada');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ============ MAYORDOMO ============
    const tipoIconos = {
      'inmueble': 'üè†', 'vehiculo': 'üöó', 'electrodomestico': 'üì∫',
      'mueble': 'üõãÔ∏è', 'otro': 'üì¶'
    };

    function renderGestion() {
      // Llenar selector de bienes
      const select = document.getElementById('select-bien');
      select.innerHTML = '<option value="">-- Selecciona un bien --</option>' + 
        bienesData.map(b => `<option value="${b.id}">${tipoIconos[b.tipo] || 'üì¶'} ${b.nombre}</option>`).join('');
      
      // Resumen de bienes con gesti√≥n activa (tabla)
      const tablaResumen = document.getElementById('gestion-resumen-tabla');
      const bienesConAddon = bienesData.filter(b => b.mayordomoActivo);
      
      if (bienesConAddon.length === 0) {
        tablaResumen.innerHTML = `
          <div style="text-align: center; padding: 30px; color: var(--text-muted);">
            <span style="font-size: 2.5rem; opacity: 0.5;">üé©</span>
            <p style="margin-top: 12px;">No hay bienes con gesti√≥n activa</p>
            <p style="font-size: 0.85rem;">Selecciona un bien arriba y activa el Mayordomo</p>
          </div>
        `;
      } else {
        const modulosIconos = {
          reservas: 'üìÖ',
          inventario: 'üì¶',
          gastos: 'üí∞',
          mantenimiento: 'üîß',
          limpieza: 'üßπ',
          eventos: 'üéâ',
          otros: 'üìã'
        };
        
        let html = `<table class="users-table" style="font-size: 0.85rem;">
          <thead>
            <tr>
              <th>Bien</th>
              <th>M√≥dulos activos</th>
              <th>Qui√©n ve</th>
              <th>Qui√©n edita</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>`;
        
        bienesConAddon.forEach(b => {
          const modulos = b.mayordomoModulos || {};
          const modulosActivos = Object.entries(modulos)
            .filter(([k, v]) => v)
            .map(([k]) => `<span title="${k}" style="margin: 0 2px;">${modulosIconos[k] || 'üìã'}</span>`)
            .join('') || '<span style="color: var(--text-muted);">Ninguno</span>';
          
          // Permisos del bien (si est√°n configurados)
          const permisosVer = b.permisosVer || ['Todos'];
          const permisosEditar = b.permisosEditar || ['Admin Rama', 'Admin Nido'];
          
          html += `<tr>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.2rem;">${tipoIconos[b.tipo] || 'üì¶'}</span>
                <strong>${b.nombre}</strong>
              </div>
            </td>
            <td>${modulosActivos}</td>
            <td><span style="font-size: 0.8rem; color: var(--text-light);">${Array.isArray(permisosVer) ? permisosVer.join(', ') : permisosVer}</span></td>
            <td><span style="font-size: 0.8rem; color: var(--text-light);">${Array.isArray(permisosEditar) ? permisosEditar.join(', ') : permisosEditar}</span></td>
            <td>
              <a href="bien.html?id=${b.id}" class="btn btn-sm btn-secondary">üëÅÔ∏è Ver</a>
            </td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        tablaResumen.innerHTML = html;
      }
      
      // Resumen de bienes (lista legacy)
      const resumen = document.getElementById('bienes-resumen');
      if (bienesData.length === 0) {
        resumen.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No hay bienes registrados. Cr√©alos en "Lo Com√∫n".</p>';
        return;
      }
      
      resumen.innerHTML = bienesData.map(b => {
        const activo = b.mayordomoActivo;
        const modulos = b.mayordomoModulos || {};
        const modulosActivos = Object.values(modulos).filter(v => v).length;
        
        return `
          <div class="bien-resumen-item">
            <div class="bien-resumen-info">
              <span>${tipoIconos[b.tipo] || 'üì¶'}</span>
              <span class="bien-resumen-nombre">${b.nombre}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              ${activo ? `<span style="font-size: 0.75rem; color: var(--text-muted);">${modulosActivos} m√≥dulos</span>` : ''}
              <span class="bien-resumen-estado ${activo ? 'activo' : 'inactivo'}">
                ${activo ? 'üé© Activo' : 'Inactivo'}
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    function cargarConfigBien() {
      const bienId = document.getElementById('select-bien').value;
      const container = document.getElementById('config-bien-container');
      const submodulosConfig = document.getElementById('submodulos-config');
      
      if (!bienId) {
        container.classList.add('hidden');
        bienSeleccionado = null;
        return;
      }
      
      bienSeleccionado = bienesData.find(b => b.id === bienId);
      if (!bienSeleccionado) return;
      
      container.classList.remove('hidden');
      
      // Info del bien
      document.getElementById('bien-icono').textContent = tipoIconos[bienSeleccionado.tipo] || 'üì¶';
      document.getElementById('bien-nombre').textContent = bienSeleccionado.nombre;
      document.getElementById('bien-tipo').textContent = bienSeleccionado.subtipo || bienSeleccionado.tipo;
      document.getElementById('enlace-ver-bien').href = `bien.html?id=${bienId}`;
      
      // Estado del Mayordomo
      const toggle = document.getElementById('toggle-mayordomo-activo');
      toggle.checked = bienSeleccionado.mayordomoActivo || false;
      document.getElementById('mayordomo-estado').textContent = toggle.checked ? 'Activado' : 'Desactivado';
      
      // Mostrar/ocultar subm√≥dulos
      if (toggle.checked) {
        submodulosConfig.classList.remove('hidden');
        cargarSubmodulos();
      } else {
        submodulosConfig.classList.add('hidden');
      }
    }

    function cargarSubmodulos() {
      const modulos = bienSeleccionado.mayordomoModulos || {};
      document.getElementById('mod-reservas').checked = modulos.reservas || false;
      document.getElementById('mod-inventario').checked = modulos.inventario || false;
      document.getElementById('mod-gastos').checked = modulos.gastos || false;
      document.getElementById('mod-mantenimiento').checked = modulos.mantenimiento || false;
      document.getElementById('mod-limpieza').checked = modulos.limpieza || false;
      document.getElementById('mod-eventos').checked = modulos.eventos || false;
      document.getElementById('mod-otros').checked = modulos.otros || false;
    }

    async function toggleMayordomoBien() {
      if (!bienSeleccionado) return;
      
      const activo = document.getElementById('toggle-mayordomo-activo').checked;
      document.getElementById('mayordomo-estado').textContent = activo ? 'Activado' : 'Desactivado';
      
      const submodulosConfig = document.getElementById('submodulos-config');
      if (activo) {
        submodulosConfig.classList.remove('hidden');
        cargarSubmodulos();
      } else {
        submodulosConfig.classList.add('hidden');
      }
      
      try {
        await db.collection('bienes').doc(bienSeleccionado.id).update({
          mayordomoActivo: activo
        });
        bienSeleccionado.mayordomoActivo = activo;
        renderGestion(); // Actualizar resumen
      } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar');
      }
    }

    async function guardarSubmodulos() {
      if (!bienSeleccionado) return;
      
      const modulos = {
        reservas: document.getElementById('mod-reservas').checked,
        inventario: document.getElementById('mod-inventario').checked,
        gastos: document.getElementById('mod-gastos').checked,
        mantenimiento: document.getElementById('mod-mantenimiento').checked,
        limpieza: document.getElementById('mod-limpieza').checked,
        eventos: document.getElementById('mod-eventos').checked,
        otros: document.getElementById('mod-otros').checked
      };
      
      try {
        await db.collection('bienes').doc(bienSeleccionado.id).update({
          mayordomoModulos: modulos
        });
        bienSeleccionado.mayordomoModulos = modulos;
        renderGestion(); // Actualizar resumen
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar subm√≥dulos');
      }
    }

    // ============ EXTERNOS (Caseros, Hosters, Guardas) ============
    let externosData = { caseros: [], hosters: [], guardas: [] };

    async function cargarExternos() {
      const bienesConAddon = bienesData.filter(b => b.mayordomoActivo);
      
      externosData = { caseros: [], hosters: [], guardas: [] };
      
      for (const bien of bienesConAddon) {
        // Cargar caseros
        try {
          const caserosSnap = await db.collection('bienes').doc(bien.id).collection('caseros').get();
          caserosSnap.docs.forEach(d => {
            const data = { id: d.id, bienId: bien.id, bienNombre: bien.nombre, tipo: 'casero', ...d.data() };
            // Evitar duplicados por email
            if (!externosData.caseros.find(c => c.email === data.email)) {
              externosData.caseros.push(data);
            } else {
              // A√±adir el bien a los bienes del externo existente
              const existing = externosData.caseros.find(c => c.email === data.email);
              if (!existing.bienes) existing.bienes = [{ id: existing.bienId, nombre: existing.bienNombre }];
              existing.bienes.push({ id: bien.id, nombre: bien.nombre });
            }
          });
        } catch (e) { console.log('Sin caseros en', bien.nombre); }

        // Cargar hosters
        try {
          const hostersSnap = await db.collection('bienes').doc(bien.id).collection('hosters').get();
          hostersSnap.docs.forEach(d => {
            const data = { id: d.id, bienId: bien.id, bienNombre: bien.nombre, tipo: 'hoster', ...d.data() };
            if (!externosData.hosters.find(h => h.email === data.email)) {
              externosData.hosters.push(data);
            } else {
              const existing = externosData.hosters.find(h => h.email === data.email);
              if (!existing.bienes) existing.bienes = [{ id: existing.bienId, nombre: existing.bienNombre }];
              existing.bienes.push({ id: bien.id, nombre: bien.nombre });
            }
          });
        } catch (e) { console.log('Sin hosters en', bien.nombre); }

        // Cargar guardas
        try {
          const guardasSnap = await db.collection('bienes').doc(bien.id).collection('guardas').get();
          guardasSnap.docs.forEach(d => {
            const data = { id: d.id, bienId: bien.id, bienNombre: bien.nombre, tipo: 'guarda', ...d.data() };
            if (!externosData.guardas.find(g => g.email === data.email)) {
              externosData.guardas.push(data);
            } else {
              const existing = externosData.guardas.find(g => g.email === data.email);
              if (!existing.bienes) existing.bienes = [{ id: existing.bienId, nombre: existing.bienNombre }];
              existing.bienes.push({ id: bien.id, nombre: bien.nombre });
            }
          });
        } catch (e) { console.log('Sin guardas en', bien.nombre); }
      }
      
      renderExternos();
    }

    function renderExternos() {
      const bienesConAddon = bienesData.filter(b => b.mayordomoActivo);
      const todosExternos = [
        ...externosData.caseros.map(e => ({ ...e, tipoLabel: 'üè† Casero' })),
        ...externosData.hosters.map(e => ({ ...e, tipoLabel: 'üè® Hoster' })),
        ...externosData.guardas.map(e => ({ ...e, tipoLabel: 'üõ°Ô∏è Guarda' }))
      ];
      
      // Actualizar contadores
      document.getElementById('count-caseros').textContent = externosData.caseros.length;
      document.getElementById('count-hosters').textContent = externosData.hosters.length;
      document.getElementById('count-guardas').textContent = externosData.guardas.length;
      
      const container = document.getElementById('externos-matriz-container');
      
      if (todosExternos.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <span style="font-size: 3rem; opacity: 0.5;">üîë</span>
            <p style="margin-top: 12px;">No hay colaboradores externos registrados</p>
            <p style="font-size: 0.85rem;">Los externos se a√±aden desde la ficha de cada bien con gesti√≥n activa</p>
          </div>
        `;
        return;
      }
      
      if (bienesConAddon.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <span style="font-size: 3rem; opacity: 0.5;">üé©</span>
            <p style="margin-top: 12px;">No hay bienes con gesti√≥n activa</p>
            <p style="font-size: 0.85rem;">Activa la gesti√≥n en alg√∫n bien para ver los externos</p>
          </div>
        `;
        return;
      }
      
      // Construir tabla matriz
      let html = `<table class="users-table" style="font-size: 0.85rem;">
        <thead>
          <tr>
            <th>Externo</th>
            <th>Tipo</th>
            ${bienesConAddon.map(b => `<th style="text-align:center;">${tipoIconos[b.tipo] || 'üì¶'} ${b.nombre}</th>`).join('')}
          </tr>
        </thead>
        <tbody>`;
      
      todosExternos.forEach(ext => {
        const bienesDelExterno = ext.bienes || [{ id: ext.bienId, nombre: ext.bienNombre }];
        const bienesIds = bienesDelExterno.map(b => b.id);
        
        html += `<tr>
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 32px; height: 32px; background: var(--sage-muted); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; color: var(--sage-dark);">
                ${(ext.nombre || ext.email || '?').charAt(0).toUpperCase()}
              </div>
              <div>
                <div style="font-weight: 600;">${ext.nombre || 'Sin nombre'}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">${ext.email || ''}</div>
              </div>
            </div>
          </td>
          <td><span style="font-size: 0.8rem; padding: 2px 8px; background: var(--cream); border-radius: 4px;">${ext.tipoLabel}</span></td>
          ${bienesConAddon.map(b => {
            const tieneAcceso = bienesIds.includes(b.id);
            return `<td style="text-align:center;">
              ${tieneAcceso 
                ? `<a href="bien.html?id=${b.id}&tab=externos" class="btn btn-sm btn-secondary" style="padding: 4px 8px;">üîó</a>` 
                : '<span style="color: var(--text-muted);">‚Äî</span>'}
            </td>`;
          }).join('')}
        </tr>`;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ============ PLANTILLAS DE NORMAS ============
    let plantillasData = {};
    let tipoPlantillaActual = 'mayordomo';
    let capituloEditando = null;

    const tiposPlantilla = {
      mayordomo: { nombre: 'Casero (Mayordomo)', icono: 'üè†', color: 'var(--sage)' },
      gerente: { nombre: 'Hoster (Gerente)', icono: 'üè®', color: '#4A5568' },
      capataz: { nombre: 'Guarda (Capataz)', icono: 'üåæ', color: '#6B8E23' }
    };

    async function cargarPlantillas() {
      try {
        const snap = await db.collection('familias').doc(familiaData.id)
          .collection('plantillasNormas').get();
        
        plantillasData = {};
        snap.docs.forEach(doc => {
          plantillasData[doc.id] = { id: doc.id, ...doc.data() };
        });
        
        renderPlantilla();
      } catch (e) {
        console.error('Error cargando plantillas:', e);
      }
    }

    function seleccionarTipoPlantilla(tipo) {
      tipoPlantillaActual = tipo;
      
      // Actualizar botones activos
      document.querySelectorAll('.plantilla-tipo-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tipo === tipo);
      });
      
      renderPlantilla();
    }

    function renderPlantilla() {
      const tipo = tiposPlantilla[tipoPlantillaActual];
      const plantilla = plantillasData[tipoPlantillaActual] || { capitulos: [] };
      const capitulos = plantilla.capitulos || [];
      
      // T√≠tulo
      document.getElementById('plantilla-editor-titulo').innerHTML = 
        `${tipo.icono} Normas para ${tipo.nombre}`;
      
      // Contenedor de cap√≠tulos
      const container = document.getElementById('plantilla-capitulos-container');
      
      if (capitulos.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <span style="font-size: 2.5rem; opacity: 0.5;">üìù</span>
            <p style="margin-top: 12px;">No hay cap√≠tulos definidos</p>
            <p style="font-size: 0.85rem;">A√±ade cap√≠tulos con sus preceptos para crear la plantilla</p>
          </div>
        `;
      } else {
        container.innerHTML = capitulos.map((cap, idx) => `
          <div class="capitulo-card">
            <div class="capitulo-header" onclick="toggleCapitulo(${idx})">
              <div class="capitulo-titulo">
                <span class="capitulo-numero">${idx + 1}</span>
                <span>${cap.titulo}</span>
                <span style="font-size: 0.8rem; color: var(--text-muted);">(${cap.preceptos?.length || 0} preceptos)</span>
              </div>
              <div class="capitulo-actions" onclick="event.stopPropagation()">
                <button onclick="editarCapitulo(${idx})" title="Editar">‚úèÔ∏è</button>
                <button onclick="moverCapitulo(${idx}, -1)" title="Subir" ${idx === 0 ? 'disabled style="opacity:0.3"' : ''}>‚¨ÜÔ∏è</button>
                <button onclick="moverCapitulo(${idx}, 1)" title="Bajar" ${idx === capitulos.length - 1 ? 'disabled style="opacity:0.3"' : ''}>‚¨áÔ∏è</button>
                <button onclick="eliminarCapitulo(${idx})" title="Eliminar" style="color:#dc3545;">üóëÔ∏è</button>
              </div>
            </div>
            <div class="capitulo-body" id="capitulo-body-${idx}" style="display:none;">
              ${(cap.preceptos || []).map((prec, pIdx) => `
                <div class="precepto-item">
                  <span class="precepto-num">${idx + 1}.${pIdx + 1}</span>
                  <span class="precepto-texto">${typeof prec === 'string' ? prec : prec.texto}</span>
                </div>
              `).join('') || '<p style="color:var(--text-muted);font-size:0.9rem;">Sin preceptos</p>'}
            </div>
          </div>
        `).join('');
      }
      
      // Bienes que usan esta plantilla
      renderBienesUsandoPlantilla();
    }

    function toggleCapitulo(idx) {
      const body = document.getElementById(`capitulo-body-${idx}`);
      body.style.display = body.style.display === 'none' ? 'block' : 'none';
    }

    function abrirModalCapitulo() {
      capituloEditando = null;
      document.getElementById('modal-capitulo-titulo').textContent = '‚ûï Nuevo cap√≠tulo';
      document.getElementById('capitulo-titulo').value = '';
      document.getElementById('capitulo-preceptos').value = '';
      document.getElementById('modal-capitulo').classList.add('active');
    }

    function editarCapitulo(idx) {
      const plantilla = plantillasData[tipoPlantillaActual] || { capitulos: [] };
      const cap = plantilla.capitulos[idx];
      if (!cap) return;
      
      capituloEditando = idx;
      document.getElementById('modal-capitulo-titulo').textContent = '‚úèÔ∏è Editar cap√≠tulo';
      document.getElementById('capitulo-titulo').value = cap.titulo || '';
      
      // Convertir preceptos a texto (uno por l√≠nea)
      const preceptosTexto = (cap.preceptos || [])
        .map(p => typeof p === 'string' ? p : p.texto)
        .join('\n');
      document.getElementById('capitulo-preceptos').value = preceptosTexto;
      
      document.getElementById('modal-capitulo').classList.add('active');
    }

    async function guardarCapitulo() {
      const titulo = document.getElementById('capitulo-titulo').value.trim();
      const preceptosTexto = document.getElementById('capitulo-preceptos').value.trim();
      
      if (!titulo) {
        alert('El t√≠tulo es obligatorio');
        return;
      }
      
      // Convertir texto a array de preceptos
      const preceptos = preceptosTexto
        .split('\n')
        .map(l => l.trim())
        .filter(l => l.length > 0)
        .map((texto, idx) => ({ orden: idx + 1, texto }));
      
      // Obtener o crear plantilla
      let plantilla = plantillasData[tipoPlantillaActual] || { capitulos: [] };
      let capitulos = [...(plantilla.capitulos || [])];
      
      const nuevoCapitulo = {
        titulo,
        orden: capituloEditando !== null ? capitulos[capituloEditando].orden : capitulos.length + 1,
        preceptos
      };
      
      if (capituloEditando !== null) {
        // Editar existente
        capitulos[capituloEditando] = nuevoCapitulo;
      } else {
        // A√±adir nuevo
        capitulos.push(nuevoCapitulo);
      }
      
      try {
        await db.collection('familias').doc(familiaData.id)
          .collection('plantillasNormas').doc(tipoPlantillaActual)
          .set({
            tipo: tipoPlantillaActual,
            capitulos,
            actualizadoPor: currentUser.uid,
            actualizadoEn: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        
        plantillasData[tipoPlantillaActual] = { 
          id: tipoPlantillaActual, 
          tipo: tipoPlantillaActual, 
          capitulos 
        };
        
        cerrarModal('modal-capitulo');
        renderPlantilla();
        
      } catch (e) {
        console.error('Error guardando cap√≠tulo:', e);
        alert('Error al guardar: ' + e.message);
      }
    }

    async function eliminarCapitulo(idx) {
      if (!confirm('¬øEliminar este cap√≠tulo y todos sus preceptos?')) return;
      
      let plantilla = plantillasData[tipoPlantillaActual];
      if (!plantilla) return;
      
      let capitulos = [...plantilla.capitulos];
      capitulos.splice(idx, 1);
      
      // Reordenar
      capitulos = capitulos.map((c, i) => ({ ...c, orden: i + 1 }));
      
      try {
        await db.collection('familias').doc(familiaData.id)
          .collection('plantillasNormas').doc(tipoPlantillaActual)
          .update({ capitulos });
        
        plantillasData[tipoPlantillaActual].capitulos = capitulos;
        renderPlantilla();
        
      } catch (e) {
        console.error('Error eliminando cap√≠tulo:', e);
        alert('Error al eliminar');
      }
    }

    async function moverCapitulo(idx, direccion) {
      let plantilla = plantillasData[tipoPlantillaActual];
      if (!plantilla) return;
      
      let capitulos = [...plantilla.capitulos];
      const nuevoIdx = idx + direccion;
      
      if (nuevoIdx < 0 || nuevoIdx >= capitulos.length) return;
      
      // Intercambiar
      [capitulos[idx], capitulos[nuevoIdx]] = [capitulos[nuevoIdx], capitulos[idx]];
      
      // Reordenar
      capitulos = capitulos.map((c, i) => ({ ...c, orden: i + 1 }));
      
      try {
        await db.collection('familias').doc(familiaData.id)
          .collection('plantillasNormas').doc(tipoPlantillaActual)
          .update({ capitulos });
        
        plantillasData[tipoPlantillaActual].capitulos = capitulos;
        renderPlantilla();
        
      } catch (e) {
        console.error('Error moviendo cap√≠tulo:', e);
      }
    }

    function renderBienesUsandoPlantilla() {
      const container = document.getElementById('plantilla-bienes-usando');
      
      // Mapear tipo de plantilla a tipo de externo
      const tipoExternoMap = {
        mayordomo: 'casero',
        gerente: 'hoster',
        capataz: 'guarda'
      };
      
      // Filtrar bienes que tienen este tipo de externo y normas copiadas de plantilla
      const bienesConPlantilla = bienesData.filter(b => 
        b.mayordomoActivo && b.normasUsanPlantilla === tipoPlantillaActual
      );
      
      if (bienesConPlantilla.length === 0) {
        container.innerHTML = `
          <p style="color: var(--text-muted);">
            Ning√∫n bien est√° usando esta plantilla actualmente.
          </p>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
            Cuando copies esta plantilla a un bien, aparecer√° aqu√≠.
          </p>
        `;
      } else {
        container.innerHTML = bienesConPlantilla.map(b => `
          <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--cream); border-radius: 6px; margin-bottom: 6px;">
            <span>${tipoIconos[b.tipo] || 'üì¶'}</span>
            <span style="font-weight: 600;">${b.nombre}</span>
            <a href="bien.html?id=${b.id}&tab=normas" class="btn btn-sm btn-secondary" style="margin-left: auto;">Ver normas</a>
          </div>
        `).join('');
      }
    }

    // ============ PLANTILLAS DE NORMAS PARA MIEMBROS ============
    let plantillasMiembrosData = {};
    let tipoBienPlantillaActual = 'inmueble';
    let capituloMiembrosEditando = null;
    let categoriaPlantillaActual = 'externos';

    const tiposBienPlantilla = {
      inmueble: { nombre: 'Inmuebles', icono: 'üè†', color: 'var(--sage)' },
      vehiculo: { nombre: 'Veh√≠culos', icono: 'üöó', color: 'var(--terracotta)' },
      terreno: { nombre: 'Terrenos', icono: 'üå≥', color: 'var(--capataz)' }
    };

    function seleccionarCategoriaPlantilla(cat) {
      categoriaPlantillaActual = cat;
      
      // Actualizar botones
      document.querySelectorAll('.plantilla-cat-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.cat === cat);
      });
      
      // Mostrar/ocultar secciones
      document.getElementById('plantillas-externos-section').style.display = cat === 'externos' ? 'block' : 'none';
      document.getElementById('plantillas-miembros-section').style.display = cat === 'miembros' ? 'block' : 'none';
      
      // Cargar datos si es miembros
      if (cat === 'miembros') {
        renderPlantillaMiembros();
      }
    }

    async function cargarPlantillasMiembros() {
      try {
        const snap = await db.collection('familias').doc(familiaData.id)
          .collection('plantillasNormasMiembros').get();
        
        plantillasMiembrosData = {};
        snap.docs.forEach(doc => {
          plantillasMiembrosData[doc.id] = { id: doc.id, ...doc.data() };
        });
      } catch (e) {
        console.error('Error cargando plantillas miembros:', e);
      }
    }

    function seleccionarTipoBienPlantilla(tipo) {
      tipoBienPlantillaActual = tipo;
      
      // Actualizar botones
      document.querySelectorAll('.plantilla-bien-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tipo === tipo);
      });
      
      renderPlantillaMiembros();
    }

    function renderPlantillaMiembros() {
      const tipo = tiposBienPlantilla[tipoBienPlantillaActual];
      const plantilla = plantillasMiembrosData[tipoBienPlantillaActual] || { capitulos: [] };
      const capitulos = plantilla.capitulos || [];
      
      // T√≠tulo
      document.getElementById('plantilla-miembros-titulo').innerHTML = 
        `${tipo.icono} Normas de uso para ${tipo.nombre}`;
      
      // Contenedor de cap√≠tulos
      const container = document.getElementById('plantilla-miembros-capitulos');
      
      if (capitulos.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <span style="font-size: 2.5rem; opacity: 0.5;">üìù</span>
            <p style="margin-top: 12px;">No hay cap√≠tulos definidos</p>
            <p style="font-size: 0.85rem;">A√±ade cap√≠tulos con sus preceptos para crear la plantilla</p>
          </div>
        `;
      } else {
        container.innerHTML = capitulos.map((cap, idx) => `
          <div class="capitulo-card">
            <div class="capitulo-header" onclick="toggleCapituloMiembros(${idx})">
              <div class="capitulo-titulo">
                <span class="capitulo-numero" style="background: var(--terracotta);">${idx + 1}</span>
                <span>${cap.titulo}</span>
                <span style="font-size: 0.8rem; color: var(--text-muted);">(${cap.preceptos?.length || 0} preceptos)</span>
              </div>
              <div class="capitulo-actions" onclick="event.stopPropagation()">
                <button onclick="editarCapituloMiembros(${idx})" title="Editar">‚úèÔ∏è</button>
                <button onclick="moverCapituloMiembros(${idx}, -1)" title="Subir" ${idx === 0 ? 'disabled style="opacity:0.3"' : ''}>‚¨ÜÔ∏è</button>
                <button onclick="moverCapituloMiembros(${idx}, 1)" title="Bajar" ${idx === capitulos.length - 1 ? 'disabled style="opacity:0.3"' : ''}>‚¨áÔ∏è</button>
                <button onclick="eliminarCapituloMiembros(${idx})" title="Eliminar" style="color:#dc3545;">üóëÔ∏è</button>
              </div>
            </div>
            <div class="capitulo-body" id="capitulo-miembros-body-${idx}" style="display:none;">
              ${(cap.preceptos || []).map((prec, pIdx) => `
                <div class="precepto-item">
                  <span class="precepto-num">${idx + 1}.${pIdx + 1}</span>
                  <span class="precepto-texto">${typeof prec === 'string' ? prec : prec.texto}</span>
                </div>
              `).join('') || '<p style="color:var(--text-muted);font-size:0.9rem;">Sin preceptos</p>'}
            </div>
          </div>
        `).join('');
      }
      
      // Bienes que usan esta plantilla
      renderBienesUsandoPlantillaMiembros();
    }

    function toggleCapituloMiembros(idx) {
      const body = document.getElementById(`capitulo-miembros-body-${idx}`);
      body.style.display = body.style.display === 'none' ? 'block' : 'none';
    }

    function abrirModalCapituloMiembros() {
      capituloMiembrosEditando = null;
      document.getElementById('modal-capitulo-miembros-titulo').textContent = '‚ûï Nuevo cap√≠tulo';
      document.getElementById('capitulo-miembros-titulo').value = '';
      document.getElementById('capitulo-miembros-preceptos').value = '';
      document.getElementById('modal-capitulo-miembros').classList.add('active');
    }

    function editarCapituloMiembros(idx) {
      const plantilla = plantillasMiembrosData[tipoBienPlantillaActual] || { capitulos: [] };
      const cap = plantilla.capitulos[idx];
      if (!cap) return;
      
      capituloMiembrosEditando = idx;
      document.getElementById('modal-capitulo-miembros-titulo').textContent = '‚úèÔ∏è Editar cap√≠tulo';
      document.getElementById('capitulo-miembros-titulo').value = cap.titulo || '';
      
      const preceptosTexto = (cap.preceptos || [])
        .map(p => typeof p === 'string' ? p : p.texto)
        .join('\n');
      document.getElementById('capitulo-miembros-preceptos').value = preceptosTexto;
      
      document.getElementById('modal-capitulo-miembros').classList.add('active');
    }

    async function guardarCapituloMiembros() {
      const titulo = document.getElementById('capitulo-miembros-titulo').value.trim();
      const preceptosTexto = document.getElementById('capitulo-miembros-preceptos').value.trim();
      
      if (!titulo) {
        alert('El t√≠tulo es obligatorio');
        return;
      }
      
      const preceptos = preceptosTexto
        .split('\n')
        .map(l => l.trim())
        .filter(l => l.length > 0)
        .map((texto, idx) => ({ orden: idx + 1, texto }));
      
      let plantilla = plantillasMiembrosData[tipoBienPlantillaActual] || { capitulos: [] };
      let capitulos = [...(plantilla.capitulos || [])];
      
      const nuevoCapitulo = {
        titulo,
        orden: capituloMiembrosEditando !== null ? capitulos[capituloMiembrosEditando].orden : capitulos.length + 1,
        preceptos
      };
      
      if (capituloMiembrosEditando !== null) {
        capitulos[capituloMiembrosEditando] = nuevoCapitulo;
      } else {
        capitulos.push(nuevoCapitulo);
      }
      
      try {
        await db.collection('familias').doc(familiaData.id)
          .collection('plantillasNormasMiembros').doc(tipoBienPlantillaActual)
          .set({
            tipo: tipoBienPlantillaActual,
            capitulos,
            actualizadoPor: currentUser.uid,
            actualizadoEn: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        
        plantillasMiembrosData[tipoBienPlantillaActual] = { 
          id: tipoBienPlantillaActual, 
          tipo: tipoBienPlantillaActual, 
          capitulos 
        };
        
        cerrarModal('modal-capitulo-miembros');
        renderPlantillaMiembros();
        
      } catch (e) {
        console.error('Error guardando cap√≠tulo miembros:', e);
        alert('Error al guardar: ' + e.message);
      }
    }

    async function eliminarCapituloMiembros(idx) {
      if (!confirm('¬øEliminar este cap√≠tulo y todos sus preceptos?')) return;
      
      let plantilla = plantillasMiembrosData[tipoBienPlantillaActual];
      if (!plantilla) return;
      
      let capitulos = [...plantilla.capitulos];
      capitulos.splice(idx, 1);
      capitulos = capitulos.map((c, i) => ({ ...c, orden: i + 1 }));
      
      try {
        await db.collection('familias').doc(familiaData.id)
          .collection('plantillasNormasMiembros').doc(tipoBienPlantillaActual)
          .update({ capitulos });
        
        plantillasMiembrosData[tipoBienPlantillaActual].capitulos = capitulos;
        renderPlantillaMiembros();
        
      } catch (e) {
        console.error('Error eliminando cap√≠tulo:', e);
        alert('Error al eliminar');
      }
    }

    async function moverCapituloMiembros(idx, direccion) {
      let plantilla = plantillasMiembrosData[tipoBienPlantillaActual];
      if (!plantilla) return;
      
      let capitulos = [...plantilla.capitulos];
      const nuevoIdx = idx + direccion;
      
      if (nuevoIdx < 0 || nuevoIdx >= capitulos.length) return;
      
      [capitulos[idx], capitulos[nuevoIdx]] = [capitulos[nuevoIdx], capitulos[idx]];
      capitulos = capitulos.map((c, i) => ({ ...c, orden: i + 1 }));
      
      try {
        await db.collection('familias').doc(familiaData.id)
          .collection('plantillasNormasMiembros').doc(tipoBienPlantillaActual)
          .update({ capitulos });
        
        plantillasMiembrosData[tipoBienPlantillaActual].capitulos = capitulos;
        renderPlantillaMiembros();
        
      } catch (e) {
        console.error('Error moviendo cap√≠tulo:', e);
      }
    }

    function renderBienesUsandoPlantillaMiembros() {
      const container = document.getElementById('plantilla-miembros-bienes');
      
      // Mapear tipo de plantilla a tipos de bien
      const tiposBienMap = {
        inmueble: ['casa', 'piso', 'apartamento', 'chalet', 'inmueble'],
        vehiculo: ['coche', 'moto', 'barco', 'vehiculo'],
        terreno: ['finca', 'parcela', 'terreno', 'solar']
      };
      
      const tiposValidos = tiposBienMap[tipoBienPlantillaActual] || [];
      
      const bienesConPlantilla = bienesData.filter(b => 
        tiposValidos.some(t => (b.tipo || '').toLowerCase().includes(t)) &&
        b.normasMiembrosUsanPlantilla === tipoBienPlantillaActual
      );
      
      if (bienesConPlantilla.length === 0) {
        container.innerHTML = `
          <p style="color: var(--text-muted);">
            Ning√∫n bien est√° usando esta plantilla actualmente.
          </p>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
            Cuando copies esta plantilla a un bien, aparecer√° aqu√≠.
          </p>
        `;
      } else {
        container.innerHTML = bienesConPlantilla.map(b => `
          <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--cream); border-radius: 6px; margin-bottom: 6px;">
            <span>${tipoIconos[b.tipo] || 'üì¶'}</span>
            <span style="font-weight: 600;">${b.nombre}</span>
            <a href="bien.html?id=${b.id}" class="btn btn-sm btn-secondary" style="margin-left: auto;">Ver bien</a>
          </div>
        `).join('');
      }
    }

    function renderSecciones() {
      const config = familiaData.configSecciones || {};
      
      // Valores por defecto
      const defaultConfig = {
        secciones: { miNido: true, arbol: false, cerebro: false, locomun: true, legado: false, activacion: true, chat: false },
        cerebro: { analisis: false, intuicion: false, memoria: false, razonamiento: false },
        locomun: { inmuebles: true, terrenos: true, vehiculos: true },
        legado: { recetas: true, fotos: false, historias: false, valores: false, tradiciones: false, anecdotas: false, sabiduria: false },
        activacion: { fechas: true, amigo: true, listas: true, porras: true, mercadillo: true, votaciones: false, encuestas: false, turnos: false, asistencia: false, mesas: false, escaleta: false },
        ctas: { averia: true, iniciativa: true, evento: true, reserva: true, queo: true, convocar: true }
      };

      const seccionesConfig = config.secciones || defaultConfig.secciones;
      const cerebroConfig = config.cerebro || defaultConfig.cerebro;
      const locomunConfig = config.locomun || defaultConfig.locomun;
      const legadoConfig = config.legado || defaultConfig.legado;
      const activacionConfig = config.activacion || defaultConfig.activacion;
      const ctasConfig = config.ctas || defaultConfig.ctas;

      // Render: Secciones principales
      document.getElementById('secciones-principales-grid').innerHTML = seccionesPrincipales.map(sec => 
        renderToggleItem(sec, seccionesConfig[sec.id] !== false, 'secciones', sec.id)
      ).join('');

      // Render: Cerebro
      document.getElementById('cerebro-modulos-grid').innerHTML = cerebroModulos.map(mod => 
        renderToggleItem(mod, cerebroConfig[mod.id] === true, 'cerebro', mod.id)
      ).join('');

      // Render: Lo Com√∫n
      document.getElementById('locomun-tipos-grid').innerHTML = locomunTipos.map(tipo => 
        renderToggleItem(tipo, locomunConfig[tipo.id] !== false, 'locomun', tipo.id)
      ).join('');

      // Render: Legado
      document.getElementById('legado-secciones-grid').innerHTML = legadoSecciones.map(sec => 
        renderToggleItem(sec, legadoConfig[sec.id] === true, 'legado', sec.id)
      ).join('');

      // Render: Activaci√≥n
      document.getElementById('activacion-herramientas-grid').innerHTML = activacionHerramientas.map(her => 
        renderToggleItem(her, activacionConfig[her.id] === true, 'activacion', her.id)
      ).join('');

      // Render: CTAs
      document.getElementById('ctas-grid').innerHTML = ctasDisponibles.map(cta => 
        renderToggleItem(cta, ctasConfig[cta.id] !== false, 'ctas', cta.id)
      ).join('');

      // Mostrar/ocultar cards de subsecciones seg√∫n secci√≥n principal
      actualizarVisibilidadCards(seccionesConfig);
    }

    function renderToggleItem(item, activo, grupo, id) {
      return `
        <div class="config-item">
          <div class="config-item-info">
            <span class="config-item-icon">${item.icono}</span>
            <div>
              <div class="config-item-name">${item.nombre}</div>
              <div class="config-item-desc">${item.desc}</div>
            </div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" ${activo ? 'checked' : ''} onchange="toggleConfigItem('${grupo}', '${id}', this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      `;
    }

    function actualizarVisibilidadCards(seccionesConfig) {
      // En admin-rama SIEMPRE mostramos las cards de subsecciones
      // para que el admin pueda configurarlas aunque la secci√≥n est√© apagada
      // Solo a√±adimos un indicador visual de "secci√≥n desactivada"
      
      const cardCerebro = document.getElementById('card-cerebro');
      const cardLocomun = document.getElementById('card-locomun');
      const cardLegado = document.getElementById('card-legado');
      const cardActivacion = document.getElementById('card-activacion');

      // Mostrar todas las cards pero con estilo diferente si la secci√≥n est√° apagada
      if (cardCerebro) {
        cardCerebro.style.display = 'block';
        cardCerebro.style.opacity = seccionesConfig.cerebro !== false ? '1' : '0.6';
      }
      if (cardLocomun) {
        cardLocomun.style.display = 'block';
        cardLocomun.style.opacity = seccionesConfig.locomun !== false ? '1' : '0.6';
      }
      if (cardLegado) {
        cardLegado.style.display = 'block';
        cardLegado.style.opacity = seccionesConfig.legado !== false ? '1' : '0.6';
      }
      if (cardActivacion) {
        cardActivacion.style.display = 'block';
        cardActivacion.style.opacity = seccionesConfig.activacion !== false ? '1' : '0.6';
      }
    }

    async function toggleConfigItem(grupo, id, activo) {
      try {
        // Actualizar en Firestore
        await db.collection('familias').doc(familiaData.id).update({ 
          [`configSecciones.${grupo}.${id}`]: activo 
        });
        
        // Actualizar local
        if (!familiaData.configSecciones) familiaData.configSecciones = {};
        if (!familiaData.configSecciones[grupo]) familiaData.configSecciones[grupo] = {};
        familiaData.configSecciones[grupo][id] = activo;

        // Si es una secci√≥n principal, actualizar visibilidad de cards
        if (grupo === 'secciones') {
          const seccionesConfig = familiaData.configSecciones.secciones || {};
          actualizarVisibilidadCards(seccionesConfig);
        }

        console.log(`‚úÖ ${grupo}.${id} = ${activo}`);
      } catch (error) {
        console.error('Error guardando configuraci√≥n:', error);
        alert('Error al guardar: ' + error.message);
      }
    }

    // Funciones legacy para compatibilidad
    async function toggleSeccion(id, activo) {
      await toggleConfigItem('secciones', id, activo);
    }

    async function toggleCerebroModulo(id, activo) {
      await toggleConfigItem('cerebro', id, activo);
    }

    function renderPermisos() {
      const permisos = familiaData.permisos || permisosBase;
      document.getElementById('permisos-tbody').innerHTML = permisos.map((p, idx) => `<tr><td><strong>${p.seccion}</strong></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="adminRama" ${p.permisos.adminRama ? 'checked' : ''} disabled></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="patriarca" ${p.permisos.patriarca ? 'checked' : ''}></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="matriarca" ${p.permisos.matriarca ? 'checked' : ''}></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="adminNido" ${p.permisos.adminNido ? 'checked' : ''}></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="adulto" ${p.permisos.adulto ? 'checked' : ''}></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="nino" ${p.permisos.nino ? 'checked' : ''}></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="especial" ${p.permisos.especial ? 'checked' : ''}></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="alejado" ${p.permisos.alejado ? 'checked' : ''}></td></tr>`).join('');
    }

    async function guardarPermisos() {
      const checks = document.querySelectorAll('.permiso-check');
      const permisos = [...permisosBase];
      checks.forEach(c => { permisos[parseInt(c.dataset.idx)].permisos[c.dataset.rol] = c.checked; });
      await db.collection('familias').doc(familiaData.id).update({ permisos });
      alert('‚úÖ Accesos a zonas guardados');
    }

    // ============ PERMISOS CVEB ============
    const modulosCVEB = [
      { id: 'arbol', nombre: 'üå≥ √Årbol', desc: '√Årbol geneal√≥gico' },
      { id: 'nidos', nombre: 'üè† Nidos', desc: 'Gesti√≥n de nidos' },
      { id: 'miembros', nombre: 'üë• Miembros', desc: 'Fichas de miembros' },
      { id: 'bienes', nombre: 'üèõÔ∏è Lo Com√∫n', desc: 'Bienes compartidos' },
      { id: 'documentos', nombre: 'üìÑ Documentos', desc: 'Archivos y docs' },
      { id: 'calendario', nombre: 'üìÖ Calendario', desc: 'Eventos y fechas' },
      { id: 'reservas', nombre: 'üóìÔ∏è Reservas', desc: 'Reservas de bienes' },
      { id: 'legado', nombre: 'üìú Legado', desc: 'Historia y valores' },
      { id: 'tabl√≥n', nombre: 'üìå Tabl√≥n', desc: 'Anuncios' },
      { id: 'recetas', nombre: 'üç≥ Recetas', desc: 'Recetario familiar' }
    ];

    // Permisos CVEB por defecto: Admin Rama tiene todo, otros van degradando
    const permisosCVEBBase = modulosCVEB.reduce((acc, mod) => {
      acc[mod.id] = {
        adminRama: { c: true, v: true, e: true, b: true },
        patriarca: { c: true, v: true, e: true, b: mod.id !== 'nidos' },
        matriarca: { c: true, v: true, e: true, b: mod.id !== 'nidos' },
        adminNido: { c: true, v: true, e: true, b: mod.id !== 'bienes' },
        adulto: { c: mod.id !== 'nidos', v: true, e: mod.id !== 'nidos' && mod.id !== 'bienes', b: false },
        nino: { c: false, v: ['arbol', 'legado', 'calendario', 'tabl√≥n', 'recetas'].includes(mod.id), e: false, b: false },
        especial: { c: mod.id !== 'nidos', v: true, e: mod.id !== 'nidos' && mod.id !== 'bienes', b: false },
        alejado: { c: false, v: ['arbol', 'legado'].includes(mod.id), e: false, b: false }
      };
      return acc;
    }, {});

    function renderCVEB() {
      const permisosCVEB = familiaData.permisosCVEB || permisosCVEBBase;
      const roles = ['adminRama', 'patriarca', 'matriarca', 'adminNido', 'adulto', 'nino', 'especial', 'alejado'];
      const acciones = ['c', 'v', 'e', 'b'];

      document.getElementById('cveb-tbody').innerHTML = modulosCVEB.map(mod => {
        const modPermisos = permisosCVEB[mod.id] || permisosCVEBBase[mod.id];
        
        let celdas = `<td>${mod.nombre}</td>`;
        
        roles.forEach((rol, rolIdx) => {
          const rolPermisos = modPermisos[rol] || { c: false, v: false, e: false, b: false };
          const esAdminRama = rol === 'adminRama';
          const esPrimeroGrupo = rolIdx > 0;
          
          acciones.forEach((accion, accIdx) => {
            const checked = rolPermisos[accion] ? 'checked' : '';
            const disabled = esAdminRama ? 'disabled' : '';
            const groupClass = accIdx === 0 && esPrimeroGrupo ? 'cveb-group' : '';
            celdas += `<td class="${groupClass}"><input type="checkbox" class="cveb-check" data-mod="${mod.id}" data-rol="${rol}" data-acc="${accion}" ${checked} ${disabled}></td>`;
          });
        });
        
        return `<tr>${celdas}</tr>`;
      }).join('');
    }

    async function guardarPermisosCVEB() {
      const checks = document.querySelectorAll('.cveb-check');
      const permisosCVEB = JSON.parse(JSON.stringify(permisosCVEBBase)); // Copia profunda
      
      checks.forEach(c => {
        const mod = c.dataset.mod;
        const rol = c.dataset.rol;
        const acc = c.dataset.acc;
        if (!permisosCVEB[mod]) permisosCVEB[mod] = {};
        if (!permisosCVEB[mod][rol]) permisosCVEB[mod][rol] = { c: false, v: false, e: false, b: false };
        permisosCVEB[mod][rol][acc] = c.checked;
      });
      
      try {
        await db.collection('familias').doc(familiaData.id).update({ permisosCVEB });
        familiaData.permisosCVEB = permisosCVEB;
        alert('‚úÖ Permisos CVEB guardados');
      } catch (error) {
        console.error('Error guardando CVEB:', error);
        alert('Error al guardar: ' + error.message);
      }
    }

    const generacionesLabels = {
      1: 'Pentabuelos',
      2: 'Tatarabuelos', 
      3: 'Bisabuelos',
      4: 'Abuelos',
      5: 'Padres',
      6: 'Hijos',
      7: 'Nietos',
      8: 'Bisnietos'
    };

    function getGeneracionesParaConfig(num) {
      // Con 4 generaciones: Bisabuelos (3), Abuelos (4), Padres (5), Hijos (6)
      // Con 6 generaciones: Tatarabuelos (2), Bisabuelos (3), Abuelos (4), Padres (5), Hijos (6), Nietos (7)
      // Con 8 generaciones: Pentabuelos (1), Tatarabuelos (2), Bisabuelos (3), Abuelos (4), Padres (5), Hijos (6), Nietos (7), Bisnietos (8)
      const configs = {
        4: [3, 4, 5, 6],
        6: [2, 3, 4, 5, 6, 7],
        8: [1, 2, 3, 4, 5, 6, 7, 8]
      };
      return configs[num] || configs[4];
    }

    function actualizarGeneraciones() {
      const num = parseInt(document.getElementById('config-generaciones').value);
      const gens = getGeneracionesParaConfig(num);
      
      let html = '<strong>Generaciones disponibles:</strong><br>';
      html += gens.map((g, i) => `Gen ${i + 1}: ${generacionesLabels[g]}`).join(' ‚Üí ');
      
      document.getElementById('generaciones-preview').innerHTML = html;
    }

    function renderPlanes() {
      // Plan actual de la rama
      const plan = familiaData.plan || 'free';
      const planesInfo = {
        free: { nombre: 'Free', icono: 'üå±', descripcion: 'Plan b√°sico gratuito', precio: 0, usuarios: 10, bienes: 5, storage: 1 },
        plus: { nombre: 'Plus', icono: 'üåø', descripcion: 'Para familias en crecimiento', precio: 4.99, usuarios: 25, bienes: 15, storage: 5 },
        premium: { nombre: 'Premium', icono: 'üå≥', descripcion: 'Sin l√≠mites para tu familia', precio: 9.99, usuarios: 999, bienes: 999, storage: 50 }
      };
      
      // Descuentos aplicados (desde admin-sistema)
      const descuentoPlan = familiaData.descuentoPlan || 0;
      const descuentoAddon = familiaData.descuentoAddon || 0;
      
      const planInfo = planesInfo[plan] || planesInfo.free;
      const precioPlanOriginal = planInfo.precio;
      const precioPlanFinal = precioPlanOriginal * (1 - descuentoPlan / 100);
      
      document.getElementById('plan-icono').textContent = planInfo.icono;
      document.getElementById('plan-nombre').textContent = planInfo.nombre;
      document.getElementById('plan-descripcion').textContent = planInfo.descripcion;
      
      // Mostrar precio con descuento si aplica
      if (descuentoPlan > 0 && precioPlanOriginal > 0) {
        document.getElementById('plan-precio').innerHTML = `
          <span style="text-decoration: line-through; color: var(--text-muted); font-size: 1rem;">${precioPlanOriginal.toFixed(2)}‚Ç¨</span>
          <span style="color: var(--success);">${precioPlanFinal.toFixed(2)}‚Ç¨</span>
          <span style="font-size: 0.7rem; background: var(--success); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">-${descuentoPlan}%</span>
        `;
      } else {
        document.getElementById('plan-precio').textContent = precioPlanOriginal + '‚Ç¨';
      }
      
      // Uso actual
      document.getElementById('uso-usuarios').textContent = usuariosData.length;
      document.getElementById('limite-usuarios').textContent = planInfo.usuarios === 999 ? '‚àû' : planInfo.usuarios;
      document.getElementById('uso-bienes').textContent = bienesData.length;
      document.getElementById('limite-bienes').textContent = planInfo.bienes === 999 ? '‚àû' : planInfo.bienes;
      document.getElementById('uso-storage').textContent = familiaData.storageUsado || 0;
      document.getElementById('limite-storage').textContent = planInfo.storage;
      
      // Add-ons a nivel de rama
      const addonsRama = familiaData.addons || [];
      const addonsRamaContainer = document.getElementById('addons-rama-list');
      
      const addonsInfo = {
        mayordomo: { icono: 'üé©', nombre: 'Mayordomo', precio: 4.99 },
        gerente: { icono: 'üè®', nombre: 'Gerente', precio: 9.99 },
        capataz: { icono: 'üåæ', nombre: 'Capataz', precio: 9.99 },
        crearRama: { icono: 'üå≥', nombre: 'Crear Rama', precio: 9.99 }
      };
      
      if (addonsRama.length === 0) {
        addonsRamaContainer.innerHTML = `
          <div style="padding: 20px; text-align: center; color: var(--text-muted);">
            <span style="font-size: 2rem; opacity: 0.5;">üì¶</span>
            <p style="margin-top: 8px;">No hay add-ons a nivel de rama</p>
          </div>
        `;
      } else {
        addonsRamaContainer.innerHTML = addonsRama.map(addon => {
          const info = addonsInfo[addon] || { icono: 'üì¶', nombre: addon, precio: 0 };
          const precioOriginal = info.precio;
          const precioFinal = precioOriginal * (1 - descuentoAddon / 100);
          
          let precioHtml = `${precioOriginal.toFixed(2)}‚Ç¨/mes`;
          if (descuentoAddon > 0) {
            precioHtml = `
              <span style="text-decoration: line-through; color: var(--text-muted);">${precioOriginal.toFixed(2)}‚Ç¨</span>
              <span style="color: var(--success); font-weight: 600;">${precioFinal.toFixed(2)}‚Ç¨/mes</span>
              <span style="font-size: 0.65rem; background: var(--success); color: white; padding: 1px 4px; border-radius: 3px;">-${descuentoAddon}%</span>
            `;
          }
          
          return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--cream); border-radius: 8px; margin-bottom: 8px;">
              <span style="font-size: 1.5rem;">${info.icono}</span>
              <div style="flex: 1;">
                <div style="font-weight: 600;">${info.nombre}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${precioHtml}</div>
              </div>
              <span style="color: var(--success);">‚úì Activo</span>
            </div>
          `;
        }).join('');
      }
      
      // ========== RESUMEN DE FACTURACI√ìN ==========
      const resumenContainer = document.getElementById('resumen-facturacion');
      let lineas = [];
      let totalOriginal = 0;
      let totalFinal = 0;
      
      // Plan base
      if (precioPlanOriginal > 0) {
        totalOriginal += precioPlanOriginal;
        totalFinal += precioPlanFinal;
        
        if (descuentoPlan > 0) {
          lineas.push({
            concepto: `${planInfo.icono} Plan ${planInfo.nombre}`,
            original: precioPlanOriginal,
            final: precioPlanFinal,
            descuento: descuentoPlan
          });
        } else {
          lineas.push({
            concepto: `${planInfo.icono} Plan ${planInfo.nombre}`,
            original: precioPlanOriginal,
            final: precioPlanOriginal,
            descuento: 0
          });
        }
      }
      
      // Add-ons
      addonsRama.forEach(addon => {
        const info = addonsInfo[addon] || { icono: 'üì¶', nombre: addon, precio: 0 };
        const precioOriginal = info.precio;
        const precioFinal = precioOriginal * (1 - descuentoAddon / 100);
        
        totalOriginal += precioOriginal;
        totalFinal += precioFinal;
        
        lineas.push({
          concepto: `${info.icono} ${info.nombre}`,
          original: precioOriginal,
          final: precioFinal,
          descuento: descuentoAddon
        });
      });
      
      // Generar HTML del resumen
      if (lineas.length === 0) {
        resumenContainer.innerHTML = `
          <div style="padding: 20px; text-align: center; color: var(--text-muted);">
            <span style="font-size: 2rem;">üÜì</span>
            <p style="margin-top: 8px;">Plan gratuito activo - Sin cargos</p>
          </div>
        `;
      } else {
        let html = '<div style="font-family: monospace; font-size: 0.85rem;">';
        
        lineas.forEach(l => {
          const descuentoBadge = l.descuento > 0 
            ? `<span style="font-size: 0.7rem; background: var(--success); color: white; padding: 1px 5px; border-radius: 3px; margin-left: 4px;">-${l.descuento}%</span>`
            : '';
          
          if (l.descuento > 0) {
            html += `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--cream-dark);">
                <span>${l.concepto}${descuentoBadge}</span>
                <span>
                  <span style="text-decoration: line-through; color: var(--text-muted);">${l.original.toFixed(2)}‚Ç¨</span>
                  <span style="color: var(--success); font-weight: 600; margin-left: 6px;">${l.final.toFixed(2)}‚Ç¨</span>
                </span>
              </div>
            `;
          } else {
            html += `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--cream-dark);">
                <span>${l.concepto}</span>
                <span>${l.original.toFixed(2)}‚Ç¨</span>
              </div>
            `;
          }
        });
        
        // Total
        const ahorro = totalOriginal - totalFinal;
        html += `
          <div style="display: flex; justify-content: space-between; padding: 12px 0; margin-top: 8px; border-top: 2px solid var(--sage); font-weight: 700;">
            <span>TOTAL MENSUAL</span>
            <span style="font-size: 1.1rem; color: var(--sage);">${totalFinal.toFixed(2)}‚Ç¨</span>
          </div>
        `;
        
        if (ahorro > 0) {
          html += `
            <div style="text-align: right; padding: 8px 12px; background: rgba(72, 187, 120, 0.1); border-radius: 6px; margin-top: 8px;">
              <span style="color: var(--success); font-weight: 600;">üí∞ Ahorras ${ahorro.toFixed(2)}‚Ç¨/mes</span>
              <span style="font-size: 0.75rem; color: var(--text-muted); display: block;">Gracias a tus descuentos aplicados</span>
            </div>
          `;
        }
        
        html += '</div>';
        resumenContainer.innerHTML = html;
      }
      
      // Desglose por nido
      const planesPorNidoContainer = document.getElementById('planes-por-nido-list');
      const nidosConPlanes = nidosData.filter(n => n.plan || (n.addons && n.addons.length > 0) || n.recargas);
      
      if (nidosConPlanes.length === 0) {
        planesPorNidoContainer.innerHTML = `
          <div style="padding: 20px; text-align: center; color: var(--text-muted);">
            <span style="font-size: 2rem; opacity: 0.5;">ü™∫</span>
            <p style="margin-top: 8px;">Ning√∫n nido tiene planes o add-ons individuales</p>
            <p style="font-size: 0.8rem;">Los nidos pueden contratar mejoras adicionales desde su panel</p>
          </div>
        `;
      } else {
        planesPorNidoContainer.innerHTML = nidosConPlanes.map(nido => {
          let items = [];
          
          // Plan del nido
          if (nido.plan && nido.plan !== 'free') {
            const pInfo = planesInfo[nido.plan] || {};
            items.push(`<span style="background: var(--sage); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${pInfo.icono || 'üìã'} ${pInfo.nombre || nido.plan}</span>`);
          }
          
          // Add-ons del nido
          if (nido.addons && nido.addons.length > 0) {
            nido.addons.forEach(addon => {
              const aInfo = addonsInfo[addon] || { icono: 'üì¶', nombre: addon };
              items.push(`<span style="background: var(--terracota); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${aInfo.icono} ${aInfo.nombre}</span>`);
            });
          }
          
          // Recargas del nido
          if (nido.recargas) {
            Object.keys(nido.recargas).forEach(tipo => {
              const cant = nido.recargas[tipo];
              if (cant > 0) {
                items.push(`<span style="background: #4A90A4; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">+${cant} ${tipo}</span>`);
              }
            });
          }
          
          return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--cream); border-radius: 8px; margin-bottom: 8px;">
              <span style="font-size: 1.3rem;">ü™∫</span>
              <div style="flex: 1;">
                <div style="font-weight: 600;">${nido.nombre || 'Sin nombre'}</div>
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;">
                  ${items.join('')}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function renderConfigRama() {
      document.getElementById('config-nombre').value = familiaData.nombre || '';
      document.getElementById('config-descripcion').value = familiaData.descripcion || '';
      document.getElementById('config-lema').value = familiaData.lema || '';
      document.getElementById('config-generaciones').value = familiaData.numGeneraciones || 4;
      actualizarGeneraciones();
    }

    async function guardarConfigRama() {
      const nombre = document.getElementById('config-nombre').value.trim();
      const descripcion = document.getElementById('config-descripcion').value.trim();
      const lema = document.getElementById('config-lema').value.trim();
      const numGeneraciones = parseInt(document.getElementById('config-generaciones').value);
      
      if (!nombre) { alert('El nombre es obligatorio'); return; }
      
      await db.collection('familias').doc(familiaData.id).update({ 
        nombre, 
        descripcion, 
        lema,
        numGeneraciones 
      });
      
      familiaData.nombre = nombre;
      familiaData.numGeneraciones = numGeneraciones;
      document.getElementById('estirpe-nombre').textContent = nombre;
      alert('‚úÖ Configuraci√≥n guardada');
    }

    function abrirModalInvitar() { document.getElementById('modal-invitar').classList.add('active'); }
    function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }

    async function enviarInvitacion() {
      const email = document.getElementById('invitar-email').value.trim();
      const nidoId = document.getElementById('invitar-nido').value;
      const rol = document.getElementById('invitar-rol').value;
      if (!email) { alert('Introduce un email'); return; }

      // Generar contrase√±a temporal
      const tempPassword = 'FLK' + Math.random().toString(36).substring(2, 8).toUpperCase();

      try {
        // 1. Guardar invitaci√≥n en Firebase
        const invRef = await db.collection('invitaciones').add({ 
          email, 
          familiaId: familiaData.id, 
          nidoId: nidoId || null, 
          rol, 
          invitadoPor: currentUser.uid, 
          tempPassword,
          fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(), 
          estado: 'pendiente' 
        });
        console.log('‚úÖ Invitaci√≥n guardada con ID:', invRef.id, 'familiaId:', familiaData.id);

        // 2. Enviar email con EmailJS
        emailjs.init('eWMtiJpUqrLsA5Nel');
        
        const nidoNombre = nidoId ? (nidosData.find(n => n.id === nidoId)?.nombre || 'tu nido') : 'la familia';
        
        await emailjs.send('service_fcfx5od', 'template_my2n26t', {
          to_email: email,
          to_name: email.split('@')[0],
          familia_nombre: familiaData.nombre || 'tu familia',
          nido_nombre: nidoNombre,
          temp_password: tempPassword,
          invitado_por: userData.nombre || userData.email || 'Un administrador',
          link_acceso: 'https://www.familynk.es/login.html'
        });

        alert(`‚úÖ Invitaci√≥n enviada a ${email}\n\nContrase√±a temporal: ${tempPassword}\n\n(Tambi√©n se ha enviado por email)`);
        cerrarModal('modal-invitar');
        document.getElementById('invitar-email').value = '';
        await cargarDatos();

      } catch (error) {
        console.error('Error enviando invitaci√≥n:', error);
        alert('‚ö†Ô∏è La invitaci√≥n se guard√≥ pero hubo un problema enviando el email.\n\nError: ' + error.message + '\n\nPuedes reenviarla desde la lista de invitaciones.');
      }
    }

    async function reenviarInvitacion(invId) {
      const inv = invitacionesData.find(i => i.id === invId);
      if (!inv) return;

      try {
        // Generar nueva contrase√±a si no tiene
        const tempPassword = inv.tempPassword || 'FLK' + Math.random().toString(36).substring(2, 8).toUpperCase();
        
        // Actualizar en Firebase
        await db.collection('invitaciones').doc(invId).update({ tempPassword });

        // Enviar email
        emailjs.init('eWMtiJpUqrLsA5Nel');
        
        const nidoNombre = inv.nidoId ? (nidosData.find(n => n.id === inv.nidoId)?.nombre || 'tu nido') : 'la familia';
        
        await emailjs.send('service_fcfx5od', 'template_my2n26t', {
          to_email: inv.email,
          to_name: inv.email.split('@')[0],
          familia_nombre: familiaData.nombre || 'tu familia',
          nido_nombre: nidoNombre,
          temp_password: tempPassword,
          invitado_por: userData.nombre || userData.email || 'Un administrador',
          link_acceso: 'https://www.familynk.es/login.html'
        });

        alert(`üì§ Invitaci√≥n reenviada a ${inv.email}\n\nContrase√±a temporal: ${tempPassword}`);

      } catch (error) {
        console.error('Error reenviando:', error);
        alert('Error al reenviar: ' + error.message);
      }
    }

    function exportarDatos() { alert('Pr√≥ximamente: Exportar todos los datos de la estirpe'); }

    // ============ TIPOS DE RESERVA ============
    async function cargarTiposReserva() {
      try {
        const snap = await db.collection('familias').doc(familiaData.id).collection('tiposReserva').orderBy('orden', 'asc').get();
        tiposReservaData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Si no hay tipos, crear los por defecto
        if (tiposReservaData.length === 0) {
          await crearTiposPorDefecto();
        }
        
        renderTiposReserva();
      } catch (error) {
        console.error('Error cargando tipos de reserva:', error);
      }
    }

    async function crearTiposPorDefecto() {
      const tiposPorDefecto = [
        { id: 'toda-familia', nombre: 'Toda la familia', emoji: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', color: '#7A9E7E', orden: 1 },
        { id: 'gq-h', nombre: 'Familia GQ-H', emoji: '', color: '#C17757', orden: 2 },
        { id: 'gq-b', nombre: 'Familia GQ-B', emoji: '', color: '#6B8E9F', orden: 3 },
        { id: 'g-gq', nombre: 'Familia G-GQ', emoji: '', color: '#E8A0B5', orden: 4 },
        { id: 'gq-gc', nombre: 'Familia GQ-GC', emoji: '', color: '#D4A574', orden: 5 },
        { id: 'gq-n', nombre: 'Familia GQ-N', emoji: '', color: '#7EAAA6', orden: 6 },
        { id: 'mama', nombre: 'Mam√°', emoji: 'üë©', color: '#9B7EB8', orden: 7 },
        { id: 'cazadores', nombre: 'Cazadores', emoji: 'ü¶å', color: '#8B7355', orden: 8 },
        { id: 'otros', nombre: 'Otros', emoji: 'üìã', color: '#9A9A9A', orden: 9 }
      ];

      const batch = db.batch();
      tiposPorDefecto.forEach(tipo => {
        const ref = db.collection('familias').doc(familiaData.id).collection('tiposReserva').doc(tipo.id);
        batch.set(ref, { nombre: tipo.nombre, emoji: tipo.emoji, color: tipo.color, orden: tipo.orden });
      });
      await batch.commit();
      
      tiposReservaData = tiposPorDefecto;
    }

    function renderTiposReserva() {
      const container = document.getElementById('tipos-reserva-list');
      const preview = document.getElementById('preview-colores');
      
      if (tiposReservaData.length === 0) {
        container.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;">No hay tipos de reserva configurados</p>';
        preview.innerHTML = '';
        return;
      }

      container.innerHTML = tiposReservaData.map(tipo => `
        <div class="tipo-reserva-item">
          <div class="tipo-reserva-color" style="background:${tipo.color}"></div>
          <div class="tipo-reserva-info">
            <div class="tipo-reserva-nombre">${tipo.emoji ? tipo.emoji + ' ' : ''}${tipo.nombre}</div>
            <div class="tipo-reserva-id">ID: ${tipo.id}</div>
          </div>
          <div class="tipo-reserva-actions">
            <button class="btn btn-secondary btn-sm" onclick="editarTipoReserva('${tipo.id}')">‚úèÔ∏è</button>
          </div>
        </div>
      `).join('');

      preview.innerHTML = tiposReservaData.map(tipo => `
        <div class="preview-item">
          <div class="preview-color" style="background:${tipo.color}"></div>
          <span>${tipo.emoji ? tipo.emoji + ' ' : ''}${tipo.nombre}</span>
        </div>
      `).join('');
    }

    function abrirModalTipoReserva() {
      editandoTipoId = null;
      document.getElementById('modal-tipo-titulo').textContent = '‚ûï Nuevo tipo de reserva';
      document.getElementById('tipo-nombre').value = '';
      document.getElementById('tipo-emoji').value = '';
      document.getElementById('tipo-color').value = '#7A9E7E';
      document.getElementById('btn-eliminar-tipo').classList.add('hidden');
      
      // Reset color selection
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelector('.color-option[data-color="#7A9E7E"]').classList.add('selected');
      
      document.getElementById('modal-tipo-reserva').classList.add('active');
    }

    function editarTipoReserva(id) {
      const tipo = tiposReservaData.find(t => t.id === id);
      if (!tipo) return;

      editandoTipoId = id;
      document.getElementById('modal-tipo-titulo').textContent = '‚úèÔ∏è Editar tipo de reserva';
      document.getElementById('tipo-nombre').value = tipo.nombre;
      document.getElementById('tipo-emoji').value = tipo.emoji || '';
      document.getElementById('tipo-color').value = tipo.color;
      document.getElementById('btn-eliminar-tipo').classList.remove('hidden');
      
      // Set color selection
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.color === tipo.color);
      });
      
      document.getElementById('modal-tipo-reserva').classList.add('active');
    }

    function seleccionarColor(color) {
      document.getElementById('tipo-color').value = color;
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.color === color);
      });
    }

    async function guardarTipoReserva() {
      const nombre = document.getElementById('tipo-nombre').value.trim();
      const emoji = document.getElementById('tipo-emoji').value.trim();
      const color = document.getElementById('tipo-color').value;

      if (!nombre) { alert('El nombre es obligatorio'); return; }

      try {
        const data = { nombre, emoji, color };
        
        if (editandoTipoId) {
          await db.collection('familias').doc(familiaData.id).collection('tiposReserva').doc(editandoTipoId).update(data);
        } else {
          // Generar ID desde el nombre
          const id = nombre.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
          
          data.orden = tiposReservaData.length + 1;
          await db.collection('familias').doc(familiaData.id).collection('tiposReserva').doc(id).set(data);
        }

        cerrarModal('modal-tipo-reserva');
        await cargarTiposReserva();
        alert('‚úÖ Tipo de reserva guardado');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar');
      }
    }

    async function eliminarTipoReserva() {
      if (!editandoTipoId) return;
      if (!confirm('¬øEliminar este tipo de reserva?')) return;

      try {
        await db.collection('familias').doc(familiaData.id).collection('tiposReserva').doc(editandoTipoId).delete();
        cerrarModal('modal-tipo-reserva');
        await cargarTiposReserva();
        alert('‚úÖ Tipo eliminado');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar');
      }
    }

    // ============ BUZ√ìN DE SOLICITUDES ============
    const tipoSolicitudIconos = {
      'estancia': 'üè†',
      'reserva': 'üìÖ',
      'actividad': 'üéØ',
      'default': 'üìã'
    };

    const tipoSolicitudLabels = {
      'estancia': 'Estancia (Mayordomo)',
      'reserva': 'Reserva (Gerente)',
      'actividad': 'Actividad (Capataz)'
    };

    function renderSolicitudes() {
      const filtro = document.getElementById('filtro-buzon')?.value || 'pendiente';
      const container = document.getElementById('solicitudes-list');
      
      let solicitudesFiltradas = solicitudesData;
      if (filtro !== 'todas') {
        solicitudesFiltradas = solicitudesData.filter(s => s.estado === filtro);
      }

      // Actualizar badge
      const pendientes = solicitudesData.filter(s => s.estado === 'pendiente').length;
      const badge = document.getElementById('badge-buzon');
      if (pendientes > 0) {
        badge.textContent = pendientes;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }

      if (solicitudesFiltradas.length === 0) {
        const mensajes = {
          'pendiente': 'No hay solicitudes pendientes',
          'aprobada': 'No hay solicitudes aprobadas',
          'rechazada': 'No hay solicitudes rechazadas',
          'todas': 'No hay solicitudes'
        };
        container.innerHTML = `
          <div class="solicitud-empty">
            <p style="font-size:2rem;margin-bottom:8px;">üì≠</p>
            <p>${mensajes[filtro]}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = solicitudesFiltradas.map(sol => {
        const icono = tipoSolicitudIconos[sol.tipoSolicitud] || tipoSolicitudIconos.default;
        const tipoLabel = tipoSolicitudLabels[sol.tipoSolicitud] || sol.tipoSolicitud;
        
        // Formatear fechas
        const fechaInicio = sol.fechaInicio?.toDate?.() || new Date(sol.fechaInicio);
        const fechaFin = sol.fechaFin?.toDate?.() || new Date(sol.fechaFin);
        const fechaCreacion = sol.fechaCreacion?.toDate?.() || new Date();
        
        const formatFecha = (d) => d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        const formatFechaCompleta = (d) => d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });

        // Buscar quien solicit√≥
        const solicitante = usuariosData.find(u => u.id === sol.creadoPor);
        const nombreSolicitante = solicitante?.nombre || solicitante?.email || 'Usuario';

        const estadoClass = sol.estado || 'pendiente';
        const acciones = sol.estado === 'pendiente' ? `
          <button class="btn btn-sm btn-aprobar" onclick="aprobarSolicitud('${sol.bienId}', '${sol.id}')">‚úì Aprobar</button>
          <button class="btn btn-sm btn-rechazar" onclick="rechazarSolicitud('${sol.bienId}', '${sol.id}')">‚úó Rechazar</button>
        ` : `<span style="font-size:0.8rem;color:var(--text-muted)">${sol.estado === 'aprobada' ? '‚úÖ Aprobada' : '‚ùå Rechazada'}</span>`;

        return `
          <div class="solicitud-item ${estadoClass}">
            <div class="solicitud-icono">${icono}</div>
            <div class="solicitud-info">
              <div class="solicitud-tipo">${tipoLabel}</div>
              <div class="solicitud-titulo">${sol.bienNombre} ¬∑ ${sol.tipoNombre || sol.descripcion || 'Solicitud'}</div>
              <div class="solicitud-detalle">
                üìÖ ${formatFecha(fechaInicio)} - ${formatFecha(fechaFin)}
                ${sol.notas ? ` ¬∑ "${sol.notas}"` : ''}
              </div>
              <div class="solicitud-meta">
                <span>üë§ ${nombreSolicitante}</span>
                <span>üïê ${formatFechaCompleta(fechaCreacion)}</span>
              </div>
            </div>
            <div class="solicitud-actions">
              ${acciones}
            </div>
          </div>
        `;
      }).join('');
    }

    async function aprobarSolicitud(bienId, solicitudId) {
      if (!confirm('¬øAprobar esta solicitud?')) return;

      try {
        const solRef = db.collection('bienes').doc(bienId).collection('solicitudes').doc(solicitudId);
        const solDoc = await solRef.get();
        
        if (!solDoc.exists) {
          alert('Solicitud no encontrada');
          return;
        }

        const solData = solDoc.data();

        // Crear la reserva real en la colecci√≥n correspondiente
        const reservaData = {
          tipo: solData.tipo,
          tipoNombre: solData.tipoNombre,
          fechaInicio: solData.fechaInicio,
          fechaFin: solData.fechaFin,
          notas: solData.notas || '',
          creadoPor: solData.creadoPor,
          aprobadoPor: currentUser.uid,
          fechaCreacion: solData.fechaCreacion,
          fechaAprobacion: firebase.firestore.FieldValue.serverTimestamp(),
          origenSolicitud: solicitudId
        };

        // Guardar en la colecci√≥n de reservas del bien
        await db.collection('bienes').doc(bienId).collection('reservas').add(reservaData);

        // Actualizar estado de la solicitud
        await solRef.update({ 
          estado: 'aprobada',
          aprobadoPor: currentUser.uid,
          fechaAprobacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        await cargarDatos();
        alert('‚úÖ Solicitud aprobada. La reserva est√° activa.');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al aprobar: ' + error.message);
      }
    }

    async function rechazarSolicitud(bienId, solicitudId) {
      const motivo = prompt('Motivo del rechazo (opcional):');
      if (motivo === null) return; // Cancel√≥ el prompt

      try {
        await db.collection('bienes').doc(bienId).collection('solicitudes').doc(solicitudId).update({
          estado: 'rechazada',
          rechazadoPor: currentUser.uid,
          motivoRechazo: motivo,
          fechaRechazo: firebase.firestore.FieldValue.serverTimestamp()
        });

        await cargarDatos();
        alert('‚ùå Solicitud rechazada');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al rechazar: ' + error.message);
      }
    }
  </script>
</body>
</html>
