<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAMILYNK â€” Admin Rama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sage: #7A9E7E;
      --sage-light: #9BB89E;
      --sage-dark: #5C7D5F;
      --sage-muted: rgba(122, 158, 126, 0.15);
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C17757;
      --terracotta-muted: rgba(193, 119, 87, 0.15);
      --text: #3D3D3D;
      --text-light: #6B6B6B;
      --text-muted: #9A9A9A;
      --white: #FFFFFF;
      --negro: #1a1a1a;
      --rojo: #c0392b;
      --rojo-dark: #a5281b;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    .header {
      background: var(--rojo);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .btn-volver {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: var(--radius-md);
      color: white;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .btn-volver:hover { background: rgba(255,255,255,0.2); }

    .header-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .estirpe-badge {
      padding: 4px 12px;
      background: var(--sage);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .main { max-width: 1200px; margin: 0 auto; padding: 24px; }

    .admin-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      background: var(--white);
      padding: 8px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
    }

    .admin-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-family: 'Nunito', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-light);
      transition: all 0.2s;
    }

    .admin-tab:hover { background: var(--cream); }
    .admin-tab.active { background: var(--rojo); color: white; }

    .admin-section { display: none; animation: fadeIn 0.3s ease; }
    .admin-section.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .section-title {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
    }

    .card-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary { background: var(--rojo); color: white; }
    .btn-primary:hover { background: #333; }
    .btn-secondary { background: var(--cream); color: var(--text); }
    .btn-secondary:hover { background: var(--cream-dark); }
    .btn-danger { background: #dc3545; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

    .users-table { width: 100%; border-collapse: collapse; }
    .users-table th, .users-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--cream-dark); }
    .users-table th { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
    .user-row { transition: background 0.2s; }
    .user-row:hover { background: var(--cream); }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--sage), var(--sage-light));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-name { font-weight: 600; }
    .user-email { font-size: 0.8rem; color: var(--text-muted); }

    .role-badge { padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 600; }
    .role-badge.admin { background: var(--rojo); color: white; }
    .role-badge.miembro { background: var(--sage-muted); color: var(--sage-dark); }

    .tipo-badge { padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 600; }
    .tipo-badge.casero { background: rgba(139, 115, 85, 0.15); color: #8B7355; }
    .tipo-badge.hoster { background: rgba(74, 85, 104, 0.15); color: #4A5568; }
    .tipo-badge.guarda { background: rgba(107, 142, 35, 0.15); color: #6B8E23; }
    
    .estado-badge { padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 600; }
    .estado-badge.activo { background: rgba(72, 187, 120, 0.15); color: #38A169; }
    .estado-badge.inactivo { background: var(--cream-dark); color: var(--text-muted); }
    
    .bienes-tags { display: flex; flex-wrap: wrap; gap: 4px; }
    .bien-tag { padding: 2px 8px; background: var(--cream); border-radius: var(--radius-sm); font-size: 0.7rem; color: var(--text-light); }

    .config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }

    .config-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }

    .config-item-info { display: flex; align-items: center; gap: 12px; }
    .config-item-icon { font-size: 1.5rem; }
    .config-item-name { font-weight: 600; }
    .config-item-desc { font-size: 0.8rem; color: var(--text-muted); }

    .toggle-switch { position: relative; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: var(--text-muted); transition: 0.3s; border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
      background-color: white; transition: 0.3s; border-radius: 50%;
    }
    input:checked + .toggle-slider { background-color: var(--sage); }
    input:checked + .toggle-slider:before { transform: translateX(24px); }

    .permisos-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .permisos-table th, .permisos-table td { padding: 10px; text-align: center; border-bottom: 1px solid var(--cream-dark); }
    .permisos-table th:first-child, .permisos-table td:first-child { text-align: left; }
    .permisos-table th { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); }
    .permiso-check { width: 18px; height: 18px; accent-color: var(--sage); }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-light); }
    .form-input {
      width: 100%; padding: 12px; border: 2px solid var(--cream-dark); border-radius: var(--radius-md);
      font-family: 'Nunito', sans-serif; font-size: 0.9rem; transition: border-color 0.2s;
    }
    .form-input:focus { outline: none; border-color: var(--sage); }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }

    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--white); border-radius: var(--radius-lg); padding: 20px; text-align: center; box-shadow: var(--shadow-soft); }
    .stat-value { font-family: 'Quicksand', sans-serif; font-size: 2rem; font-weight: 700; color: var(--rojo); }
    .stat-label { font-size: 0.8rem; color: var(--text-muted); }

    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center; z-index: 1000;
      opacity: 0; visibility: hidden; transition: all 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: var(--white); border-radius: var(--radius-lg); padding: 24px;
      width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
      transform: translateY(20px); transition: transform 0.3s;
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .modal-title { font-family: 'Quicksand', sans-serif; font-size: 1.2rem; font-weight: 700; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }

    @media (max-width: 768px) {
      .admin-tabs { flex-direction: column; }
      .admin-tab { justify-content: flex-start; }
      .users-table { font-size: 0.8rem; }
      .users-table th:nth-child(3), .users-table td:nth-child(3) { display: none; }
    }
    /* Mayordomo */
    .bien-config-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }
    .bien-info { display: flex; align-items: center; gap: 12px; }
    .bien-icono { font-size: 2rem; }
    .bien-nombre { font-weight: 700; font-size: 1.1rem; }
    .bien-tipo { font-size: 0.8rem; color: var(--text-muted); }
    
    .toggle-switch-large { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .toggle-switch-large input { display: none; }
    .toggle-slider-large {
      width: 56px; height: 28px; background: var(--text-muted); border-radius: 28px;
      position: relative; transition: 0.3s;
    }
    .toggle-slider-large:before {
      content: ""; position: absolute; width: 22px; height: 22px; left: 3px; top: 3px;
      background: white; border-radius: 50%; transition: 0.3s;
    }
    .toggle-switch-large input:checked + .toggle-slider-large { background: #8B7355; }
    .toggle-switch-large input:checked + .toggle-slider-large:before { transform: translateX(28px); }
    .toggle-label { font-weight: 600; color: var(--text-light); }
    .toggle-switch-large input:checked ~ .toggle-label { color: #8B7355; }
    
    .submodulos-title { font-weight: 600; margin-bottom: 12px; color: var(--text); }
    .submodulos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
    .submodulo-item {
      display: flex; align-items: center; gap: 10px; padding: 12px 16px;
      background: var(--white); border: 2px solid var(--cream-dark); border-radius: var(--radius-md);
      cursor: pointer; transition: all 0.2s;
    }
    .submodulo-item:hover { border-color: #8B7355; }
    .submodulo-item input { display: none; }
    .submodulo-item input:checked + .submodulo-icono { transform: scale(1.1); }
    .submodulo-item:has(input:checked) { border-color: #8B7355; background: rgba(139, 115, 85, 0.1); }
    .submodulo-icono { font-size: 1.3rem; }
    .submodulo-nombre { font-weight: 600; font-size: 0.85rem; }
    
    .bienes-resumen { display: flex; flex-direction: column; gap: 8px; }
    .bien-resumen-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; background: var(--cream); border-radius: var(--radius-md);
    }
    .bien-resumen-info { display: flex; align-items: center; gap: 10px; }
    .bien-resumen-nombre { font-weight: 600; }
    .bien-resumen-estado { font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; }
    .bien-resumen-estado.activo { background: rgba(139, 115, 85, 0.15); color: #8B7355; }
    .bien-resumen-estado.inactivo { background: var(--cream-dark); color: var(--text-muted); }

    .hidden { display: none !important; }

    .gestion-panel { display: none; }
    .gestion-panel.active { display: block; }
    .gestion-tab.active[data-gestion="mayordomo"] { background: #8B7355 !important; color: white !important; }
    .gestion-tab.active[data-gestion="gerente"] { background: #4A5568 !important; color: white !important; }
    .gestion-tab.active[data-gestion="capataz"] { background: #6B8E23 !important; color: white !important; }
    
    .toggle-slider-large.mayordomo { background: #8B7355 !important; }
    .toggle-slider-large.gerente { background: #4A5568 !important; }
    .toggle-slider-large.capataz { background: #6B8E23 !important; }

    /* Tipos de Reserva */
    .tipos-reserva-list { display: flex; flex-direction: column; gap: 12px; }
    .tipo-reserva-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
      transition: all 0.2s;
    }
    .tipo-reserva-item:hover { background: var(--cream-dark); }
    .tipo-reserva-color {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      flex-shrink: 0;
    }
    .tipo-reserva-info { flex: 1; }
    .tipo-reserva-nombre { font-weight: 700; font-size: 1rem; }
    .tipo-reserva-id { font-size: 0.75rem; color: var(--text-muted); }
    .tipo-reserva-actions { display: flex; gap: 8px; }
    
    .preview-calendario {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 16px;
      background: var(--cream);
      border-radius: var(--radius-md);
    }
    .preview-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--white);
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      font-weight: 600;
    }
    .preview-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }
    
    /* Selector de color */
    .color-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-top: 8px;
    }
    .color-option {
      width: 100%;
      aspect-ratio: 1;
      border-radius: var(--radius-sm);
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    .color-option:hover { transform: scale(1.1); }
    .color-option.selected { border-color: var(--text); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--text); }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="cgi.html" class="btn-volver">â† Volver</a>
      <div class="header-title">
        <span>ğŸ”§</span>
        <span>Admin Rama</span>
        <span class="estirpe-badge" id="estirpe-nombre">Mi Rama</span>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-value" id="stat-usuarios">0</div><div class="stat-label">Usuarios</div></div>
      <div class="stat-card"><div class="stat-value" id="stat-nidos">0</div><div class="stat-label">Nidos</div></div>
      <div class="stat-card"><div class="stat-value" id="stat-bienes">0</div><div class="stat-label">Bienes</div></div>
      <div class="stat-card"><div class="stat-value" id="stat-generaciones">0</div><div class="stat-label">Generaciones</div></div>
    </div>

    <div class="admin-tabs">
      <button class="admin-tab active" data-section="usuarios" onclick="cambiarSeccion('usuarios')"><span>ğŸ‘¥</span> Usuarios</button>
      <button class="admin-tab" data-section="externos" onclick="cambiarSeccion('externos')"><span>ğŸ‘·</span> Externos</button>
      <button class="admin-tab" data-section="reservas" onclick="cambiarSeccion('reservas')"><span>ğŸ“…</span> Reservas</button>
      <button class="admin-tab" data-section="gestiones" onclick="cambiarSeccion('gestiones')"><span>âš™ï¸</span> Gestiones</button>
      <button class="admin-tab" data-section="secciones" onclick="cambiarSeccion('secciones')"><span>ğŸ“‚</span> Secciones</button>
      <button class="admin-tab" data-section="permisos" onclick="cambiarSeccion('permisos')"><span>ğŸ”</span> Permisos</button>
      <button class="admin-tab" data-section="estirpe" onclick="cambiarSeccion('estirpe')"><span>âš™ï¸</span> ConfiguraciÃ³n</button>
    </div>

    <section class="admin-section active" id="section-usuarios">
      <div class="section-header">
        <h2 class="section-title">ğŸ‘¥ Usuarios</h2>
        <button class="btn btn-primary" onclick="abrirModalInvitar()"><span>â•</span> Invitar usuario</button>
      </div>
      <div class="card">
        <table class="users-table">
          <thead><tr><th>Usuario</th><th>Nido</th><th>Rol</th><th>Acciones</th></tr></thead>
          <tbody id="usuarios-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- SECCIÃ“N EXTERNOS -->
    <section class="admin-section" id="section-externos">
      <div class="section-header">
        <h2 class="section-title">ğŸ‘· Externos</h2>
        <div style="display:flex;gap:8px;">
          <select class="form-input" id="filtro-tipo-externo" onchange="filtrarExternos()" style="width:auto;padding:8px 12px;">
            <option value="">Todos los tipos</option>
            <option value="casero">ğŸ  Caseros</option>
            <option value="hoster">ğŸ¨ Hosters</option>
            <option value="guarda">ğŸŒ¾ Guardas</option>
          </select>
        </div>
      </div>
      
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-value" id="stat-externos-total">0</div>
          <div class="stat-label">Total externos</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-caseros">0</div>
          <div class="stat-label">ğŸ  Caseros</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-hosters">0</div>
          <div class="stat-label">ğŸ¨ Hosters</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-guardas">0</div>
          <div class="stat-label">ğŸŒ¾ Guardas</div>
        </div>
      </div>
      
      <div class="card">
        <table class="users-table">
          <thead>
            <tr>
              <th>Externo</th>
              <th>Tipo</th>
              <th>Bienes asignados</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="externos-tbody">
            <tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted);">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="card" style="background:var(--cream);">
        <p style="font-size:0.85rem;color:var(--text-muted);">
          ğŸ’¡ <strong>Nota:</strong> Los externos se crean desde la ficha de cada bien (secciÃ³n Caseros/Hosters/Guardas). 
          AquÃ­ puedes ver todos los externos de la rama y gestionar sus accesos.
        </p>
      </div>
    </section>

    <!-- SECCIÃ“N RESERVAS -->
    <section class="admin-section" id="section-reservas">
      <div class="section-header">
        <h2 class="section-title">ğŸ“… Tipos de Reserva</h2>
        <button class="btn btn-primary" onclick="abrirModalTipoReserva()"><span>â•</span> Nuevo tipo</button>
      </div>
      
      <div class="card">
        <div class="card-title">Configura quiÃ©n puede reservar</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
          Define los tipos de reserva que aparecerÃ¡n en el calendario de tus bienes. Cada tipo tiene un nombre y color Ãºnico.
        </p>
        
        <div class="tipos-reserva-list" id="tipos-reserva-list">
          <!-- Se carga dinÃ¡micamente -->
        </div>
      </div>
      
      <div class="card">
        <div class="card-title">ğŸ¨ Vista previa</div>
        <div class="preview-calendario" id="preview-colores">
          <!-- Muestra los colores -->
        </div>
      </div>
    </section>

    <section class="admin-section" id="section-gestiones">
      <div class="section-header">
        <h2 class="section-title">âš™ï¸ Gestiones de Bienes</h2>
      </div>
      
      <!-- Subtabs para los 3 tipos de gestiÃ³n -->
      <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;">
        <button class="btn btn-secondary gestion-tab active" data-gestion="mayordomo" onclick="cambiarGestion('mayordomo')" style="background:#8B7355;color:white;">ğŸ© Mayordomo</button>
        <button class="btn btn-secondary gestion-tab" data-gestion="gerente" onclick="cambiarGestion('gerente')">ğŸ¨ Gerente</button>
        <button class="btn btn-secondary gestion-tab" data-gestion="capataz" onclick="cambiarGestion('capataz')">ğŸŒ¾ Capataz</button>
      </div>
      
      <!-- MAYORDOMO -->
      <div class="gestion-panel active" id="panel-mayordomo">
        <div class="card" style="border-left:4px solid #8B7355;">
          <div class="card-title">ğŸ© Mayordomo - GestiÃ³n domÃ©stica</div>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
            Para viviendas y propiedades de uso familiar. Activa submÃ³dulos: estancias, inventario, gastos, mantenimiento, limpieza, instalaciones.
          </p>
          
          <div class="form-group">
            <label class="form-label">Selecciona un bien</label>
            <select class="form-input" id="select-bien-mayordomo" onchange="cargarConfigBien('mayordomo')">
              <option value="">-- Selecciona un bien --</option>
            </select>
          </div>
          
          <div id="config-mayordomo-container" class="hidden">
            <div class="bien-config-header">
              <div class="bien-info">
                <span class="bien-icono" id="bien-icono-mayordomo">ğŸ </span>
                <div>
                  <div class="bien-nombre" id="bien-nombre-mayordomo">...</div>
                  <div class="bien-tipo" id="bien-tipo-mayordomo">...</div>
                </div>
              </div>
              <label class="toggle-switch-large">
                <input type="checkbox" id="toggle-mayordomo-activo" onchange="toggleGestionBien('mayordomo')">
                <span class="toggle-slider-large" style="background:var(--text-muted);"></span>
                <span class="toggle-label" id="mayordomo-estado">Desactivado</span>
              </label>
            </div>
            
            <div id="submodulos-mayordomo" class="hidden">
              <div class="submodulos-title">SubmÃ³dulos activos</div>
              <div class="submodulos-grid">
                <label class="submodulo-item"><input type="checkbox" id="mod-may-reservas" onchange="guardarSubmodulosGestion('mayordomo')"><span class="submodulo-icono">ğŸ“…</span><span class="submodulo-nombre">Estancias</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-may-inventario" onchange="guardarSubmodulosGestion('mayordomo')"><span class="submodulo-icono">ğŸ“¦</span><span class="submodulo-nombre">Inventario</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-may-gastos" onchange="guardarSubmodulosGestion('mayordomo')"><span class="submodulo-icono">ğŸ’°</span><span class="submodulo-nombre">Gastos</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-may-mantenimiento" onchange="guardarSubmodulosGestion('mayordomo')"><span class="submodulo-icono">ğŸ”§</span><span class="submodulo-nombre">Mantenimiento</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-may-limpieza" onchange="guardarSubmodulosGestion('mayordomo')"><span class="submodulo-icono">ğŸ§¹</span><span class="submodulo-nombre">Limpieza</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-may-instalaciones" onchange="guardarSubmodulosGestion('mayordomo')"><span class="submodulo-icono">ğŸ—ï¸</span><span class="submodulo-nombre">Instalaciones</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- GERENTE -->
      <div class="gestion-panel hidden" id="panel-gerente">
        <div class="card" style="border-left:4px solid #4A5568;">
          <div class="card-title">ğŸ¨ Gerente - Alquiler turÃ­stico/comercial</div>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
            Para propiedades en alquiler. Gestiona huÃ©spedes, tarifas, ocupaciÃ³n y facturaciÃ³n.
          </p>
          
          <div class="form-group">
            <label class="form-label">Selecciona un bien</label>
            <select class="form-input" id="select-bien-gerente" onchange="cargarConfigBien('gerente')">
              <option value="">-- Selecciona un bien --</option>
            </select>
          </div>
          
          <div id="config-gerente-container" class="hidden">
            <div class="bien-config-header">
              <div class="bien-info">
                <span class="bien-icono" id="bien-icono-gerente">ğŸ </span>
                <div>
                  <div class="bien-nombre" id="bien-nombre-gerente">...</div>
                  <div class="bien-tipo" id="bien-tipo-gerente">...</div>
                </div>
              </div>
              <label class="toggle-switch-large">
                <input type="checkbox" id="toggle-gerente-activo" onchange="toggleGestionBien('gerente')">
                <span class="toggle-slider-large" style="background:var(--text-muted);"></span>
                <span class="toggle-label" id="gerente-estado">Desactivado</span>
              </label>
            </div>
            
            <div id="submodulos-gerente" class="hidden">
              <div class="submodulos-title">SubmÃ³dulos activos</div>
              <div class="submodulos-grid">
                <label class="submodulo-item"><input type="checkbox" id="mod-ger-reservas" onchange="guardarSubmodulosGestion('gerente')"><span class="submodulo-icono">ğŸ“…</span><span class="submodulo-nombre">Reservas</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-ger-habitaciones" onchange="guardarSubmodulosGestion('gerente')"><span class="submodulo-icono">ğŸ›ï¸</span><span class="submodulo-nombre">Habitaciones</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-ger-huespedes" onchange="guardarSubmodulosGestion('gerente')"><span class="submodulo-icono">ğŸ‘¥</span><span class="submodulo-nombre">HuÃ©spedes</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-ger-tarifas" onchange="guardarSubmodulosGestion('gerente')"><span class="submodulo-icono">ğŸ’¶</span><span class="submodulo-nombre">Tarifas</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-ger-facturacion" onchange="guardarSubmodulosGestion('gerente')"><span class="submodulo-icono">ğŸ§¾</span><span class="submodulo-nombre">FacturaciÃ³n</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-ger-instalaciones" onchange="guardarSubmodulosGestion('gerente')"><span class="submodulo-icono">ğŸ—ï¸</span><span class="submodulo-nombre">Instalaciones</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- CAPATAZ -->
      <div class="gestion-panel hidden" id="panel-capataz">
        <div class="card" style="border-left:4px solid #6B8E23;">
          <div class="card-title">ğŸŒ¾ Capataz - Fincas rurales</div>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
            Para terrenos y fincas. Gestiona labores, aperos, parcelas, ganado e incidencias.
          </p>
          
          <div class="form-group">
            <label class="form-label">Selecciona un bien</label>
            <select class="form-input" id="select-bien-capataz" onchange="cargarConfigBien('capataz')">
              <option value="">-- Selecciona un bien --</option>
            </select>
          </div>
          
          <div id="config-capataz-container" class="hidden">
            <div class="bien-config-header">
              <div class="bien-info">
                <span class="bien-icono" id="bien-icono-capataz">ğŸŒ³</span>
                <div>
                  <div class="bien-nombre" id="bien-nombre-capataz">...</div>
                  <div class="bien-tipo" id="bien-tipo-capataz">...</div>
                </div>
              </div>
              <label class="toggle-switch-large">
                <input type="checkbox" id="toggle-capataz-activo" onchange="toggleGestionBien('capataz')">
                <span class="toggle-slider-large" style="background:var(--text-muted);"></span>
                <span class="toggle-label" id="capataz-estado">Desactivado</span>
              </label>
            </div>
            
            <div id="submodulos-capataz" class="hidden">
              <div class="submodulos-title">SubmÃ³dulos activos</div>
              <div class="submodulos-grid">
                <label class="submodulo-item"><input type="checkbox" id="mod-cap-actividad" onchange="guardarSubmodulosGestion('capataz')"><span class="submodulo-icono">ğŸ“…</span><span class="submodulo-nombre">Actividad</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-cap-labores" onchange="guardarSubmodulosGestion('capataz')"><span class="submodulo-icono">ğŸ“‹</span><span class="submodulo-nombre">Labores</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-cap-aperos" onchange="guardarSubmodulosGestion('capataz')"><span class="submodulo-icono">ğŸšœ</span><span class="submodulo-nombre">Aperos</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-cap-parcelas" onchange="guardarSubmodulosGestion('capataz')"><span class="submodulo-icono">ğŸ—ºï¸</span><span class="submodulo-nombre">Parcelas</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-cap-instalaciones" onchange="guardarSubmodulosGestion('capataz')"><span class="submodulo-icono">ğŸ—ï¸</span><span class="submodulo-nombre">Instalaciones</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-cap-inventario" onchange="guardarSubmodulosGestion('capataz')"><span class="submodulo-icono">ğŸ“¦</span><span class="submodulo-nombre">Inventario</span></label>
                <label class="submodulo-item"><input type="checkbox" id="mod-cap-incidencias" onchange="guardarSubmodulosGestion('capataz')"><span class="submodulo-icono">ğŸ”§</span><span class="submodulo-nombre">Incidencias</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Resumen de todos los bienes -->
      <div class="card">
        <div class="card-title">ğŸ“Š Resumen de bienes</div>
        <div class="bienes-resumen" id="bienes-resumen">
          <!-- Se carga dinÃ¡micamente -->
        </div>
      </div>
    </section>

    <section class="admin-section" id="section-secciones">
      <div class="section-header"><h2 class="section-title">ğŸ“‚ Secciones</h2></div>
      <div class="card">
        <div class="card-title">Secciones principales</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Activa o desactiva secciones para toda la estirpe</p>
        <div class="config-grid" id="secciones-grid"></div>
      </div>
      <div class="card">
        <div class="card-title">MÃ³dulos del Cerebro</div>
        <div class="config-grid" id="cerebro-modulos-grid"></div>
      </div>
    </section>

    <section class="admin-section" id="section-permisos">
      <div class="section-header"><h2 class="section-title">ğŸ” Permisos por rol</h2></div>
      <div class="card">
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Define quÃ© puede hacer cada rol</p>
        <div style="overflow-x: auto;">
          <table class="permisos-table">
            <thead><tr><th>SecciÃ³n</th><th>Admin Rama</th><th>Admin Nido</th><th>Adulto</th><th>Joven</th></tr></thead>
            <tbody id="permisos-tbody"></tbody>
          </table>
        </div>
        <button class="btn btn-primary" style="margin-top: 16px;" onclick="guardarPermisos()">ğŸ’¾ Guardar permisos</button>
      </div>
    </section>

    <section class="admin-section" id="section-estirpe">
      <div class="section-header"><h2 class="section-title">âš™ï¸ ConfiguraciÃ³n de la Rama</h2></div>
      <div class="card">
        <div class="card-title">Datos bÃ¡sicos</div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Nombre de la estirpe</label><input type="text" class="form-input" id="config-nombre" placeholder="Familia GarcÃ­a"></div>
          <div class="form-group"><label class="form-label">DescripciÃ³n</label><input type="text" class="form-input" id="config-descripcion" placeholder="Breve descripciÃ³n..."></div>
        </div>
        <div class="form-group"><label class="form-label">Lema familiar (opcional)</label><input type="text" class="form-input" id="config-lema" placeholder="Unidos somos mÃ¡s fuertes"></div>
        <button class="btn btn-primary" onclick="guardarConfigRama()">ğŸ’¾ Guardar cambios</button>
      </div>

      <div class="card">
        <div class="card-title">ğŸŒ³ Ãrbol genealÃ³gico</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
          Configura cuÃ¡ntas generaciones quieres registrar en tu Ã¡rbol familiar
        </p>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">NÃºmero de generaciones</label>
            <select class="form-input" id="config-generaciones" onchange="actualizarGeneraciones()">
              <option value="4">4 generaciones (Bisabuelos â†’ Hijos)</option>
              <option value="6">6 generaciones (+ Tatarabuelos)</option>
              <option value="8">8 generaciones (+ Pentabuelos)</option>
            </select>
          </div>
        </div>
        <div id="generaciones-preview" style="margin-top: 12px; padding: 12px; background: var(--cream); border-radius: 8px; font-size: 0.85rem;">
          <!-- Se llena dinÃ¡micamente -->
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ‘¤ Miembros fallecidos</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
          Los miembros con fecha de defunciÃ³n aparecerÃ¡n en gris y solo tendrÃ¡n acceso a:
        </p>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
          <span style="padding: 4px 12px; background: var(--sage-muted); border-radius: 20px; font-size: 0.8rem;">ğŸŒ³ Ãrbol</span>
          <span style="padding: 4px 12px; background: var(--sage-muted); border-radius: 20px; font-size: 0.8rem;">ğŸ“‹ Ficha personal</span>
          <span style="padding: 4px 12px; background: var(--sage-muted); border-radius: 20px; font-size: 0.8rem;">ğŸ“œ Legado</span>
          <span style="padding: 4px 12px; background: var(--sage-muted); border-radius: 20px; font-size: 0.8rem;">ğŸ“… Fechas</span>
        </div>
        <p style="font-size: 0.8rem; color: var(--text-light);">
          âš ï¸ Solo los administradores de sistema pueden editar la informaciÃ³n de miembros fallecidos.
        </p>
      </div>

      <div class="card">
        <div class="card-title">ğŸš¨ Zona de peligro</div>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Estas acciones son irreversibles</p>
        <button class="btn btn-danger" onclick="exportarDatos()">ğŸ“¥ Exportar todos los datos</button>
      </div>
    </section>
  </main>

  <div class="modal-overlay" id="modal-invitar">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">â• Invitar usuario</h3><button class="modal-close" onclick="cerrarModal('modal-invitar')">Ã—</button></div>
      <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="invitar-email" placeholder="email@ejemplo.com"></div>
      <div class="form-group"><label class="form-label">Nido</label><select class="form-input" id="invitar-nido"><option value="">Sin asignar</option></select></div>
      <div class="form-group"><label class="form-label">Rol</label><select class="form-input" id="invitar-rol"><option value="adulto">Adulto</option><option value="joven">Joven</option><option value="adminNido">Admin Nido</option><option value="adminRama">Admin Rama</option></select></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modal-invitar')">Cancelar</button><button class="btn btn-primary" onclick="enviarInvitacion()">Enviar invitaciÃ³n</button></div>
    </div>
  </div>

  <!-- Modal Tipo Reserva -->
  <div class="modal-overlay" id="modal-tipo-reserva">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-tipo-titulo">â• Nuevo tipo de reserva</h3>
        <button class="modal-close" onclick="cerrarModal('modal-tipo-reserva')">Ã—</button>
      </div>
      <div class="form-group">
        <label class="form-label">Nombre</label>
        <input type="text" class="form-input" id="tipo-nombre" placeholder="Ej: Familia GarcÃ­a, Cazadores...">
      </div>
      <div class="form-group">
        <label class="form-label">Emoji (opcional)</label>
        <input type="text" class="form-input" id="tipo-emoji" placeholder="Ej: ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦, ğŸ¦Œ, ğŸ‘©" maxlength="2">
      </div>
      <div class="form-group">
        <label class="form-label">Color</label>
        <div class="color-grid" id="color-grid">
          <div class="color-option" style="background:#7A9E7E" data-color="#7A9E7E" onclick="seleccionarColor('#7A9E7E')"></div>
          <div class="color-option" style="background:#C17757" data-color="#C17757" onclick="seleccionarColor('#C17757')"></div>
          <div class="color-option" style="background:#6B8E9F" data-color="#6B8E9F" onclick="seleccionarColor('#6B8E9F')"></div>
          <div class="color-option" style="background:#E8A0B5" data-color="#E8A0B5" onclick="seleccionarColor('#E8A0B5')"></div>
          <div class="color-option" style="background:#D4A574" data-color="#D4A574" onclick="seleccionarColor('#D4A574')"></div>
          <div class="color-option" style="background:#7EAAA6" data-color="#7EAAA6" onclick="seleccionarColor('#7EAAA6')"></div>
          <div class="color-option" style="background:#9B7EB8" data-color="#9B7EB8" onclick="seleccionarColor('#9B7EB8')"></div>
          <div class="color-option" style="background:#8B7355" data-color="#8B7355" onclick="seleccionarColor('#8B7355')"></div>
          <div class="color-option" style="background:#B8860B" data-color="#B8860B" onclick="seleccionarColor('#B8860B')"></div>
          <div class="color-option" style="background:#9A9A9A" data-color="#9A9A9A" onclick="seleccionarColor('#9A9A9A')"></div>
        </div>
        <input type="hidden" id="tipo-color" value="#7A9E7E">
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm hidden" id="btn-eliminar-tipo" onclick="eliminarTipoReserva()">ğŸ—‘ï¸ Eliminar</button>
        <div style="display:flex;gap:12px;">
          <button class="btn btn-secondary" onclick="cerrarModal('modal-tipo-reserva')">Cancelar</button>
          <button class="btn btn-primary" onclick="guardarTipoReserva()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal editar externo -->
  <div class="modal-overlay" id="modal-externo">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header"><h3 class="modal-title" id="modal-externo-titulo">ğŸ‘· Editar externo</h3><button class="modal-close" onclick="cerrarModal('modal-externo')">Ã—</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label class="form-label">Nombre</label><input type="text" class="form-input" id="ext-nombre"></div>
          <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="ext-email" disabled></div>
        </div>
        <div class="form-group"><label class="form-label">TelÃ©fono</label><input type="tel" class="form-input" id="ext-telefono"></div>
        
        <div class="form-group">
          <label class="form-label">Bienes y permisos</label>
          <div id="ext-bienes-permisos" style="max-height:300px;overflow-y:auto;">
            <!-- Se llena dinÃ¡micamente -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm" id="btn-desactivar-externo" onclick="desactivarExterno()">â¸ï¸ Desactivar</button>
        <div style="display:flex;gap:12px;">
          <button class="btn btn-secondary" onclick="cerrarModal('modal-externo')">Cancelar</button>
          <button class="btn btn-primary" onclick="guardarExterno()">ğŸ’¾ Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    let currentUser = null, userData = null, familiaData = null, usuariosData = [], nidosData = [], bienesData = [], externosData = [];
    let bienSeleccionado = null;
    let bienSeleccionadoGestion = { mayordomo: null, gerente: null, capataz: null };
    let tiposReservaData = [];
    let editandoTipoId = null;
    let editandoExternoId = null;

    const seccionesDisponibles = [
      { id: 'arbol', nombre: 'Ãrbol', icono: 'ğŸŒ³', desc: 'Ãrbol genealÃ³gico' },
      { id: 'cerebro', nombre: 'Cerebro', icono: 'ğŸ§ ', desc: 'Centro de conocimiento' },
      { id: 'locomun', nombre: 'Lo ComÃºn', icono: 'ğŸ ', desc: 'Bienes compartidos' },
      { id: 'legado', nombre: 'Legado', icono: 'ğŸ“œ', desc: 'Historia y tradiciones' },
      { id: 'activacion', nombre: 'ActivaciÃ³n', icono: 'ğŸ“…', desc: 'Calendario y eventos' }
    ];

    const cerebroModulos = [
      { id: 'memoria', nombre: 'Memoria', icono: 'ğŸ—„ï¸', desc: 'Repositorio de documentos' },
      { id: 'razonamiento', nombre: 'Razonamiento', icono: 'ğŸ“', desc: 'Instrucciones y pautas' },
      { id: 'intuicion', nombre: 'IntuiciÃ³n', icono: 'ğŸ’¡', desc: 'Propuestas y sugerencias' },
      { id: 'analisis', nombre: 'AnÃ¡lisis', icono: 'ğŸ“Š', desc: 'EstadÃ­sticas' }
    ];

    const permisosBase = [
      { seccion: 'Ãrbol', permisos: { adminSistema: true, adminNido: true, adulto: true, joven: true } },
      { seccion: 'Cerebro', permisos: { adminSistema: true, adminNido: true, adulto: true, joven: false } },
      { seccion: 'Lo ComÃºn', permisos: { adminSistema: true, adminNido: true, adulto: true, joven: false } },
      { seccion: 'Legado', permisos: { adminSistema: true, adminNido: true, adulto: true, joven: true } },
      { seccion: 'Invitar usuarios', permisos: { adminSistema: true, adminNido: true, adulto: false, joven: false } },
      { seccion: 'Editar nidos', permisos: { adminSistema: true, adminNido: true, adulto: false, joven: false } },
      { seccion: 'Gestionar bienes', permisos: { adminSistema: true, adminNido: false, adulto: false, joven: false } }
    ];

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;

      const userDoc = await db.collection('usuarios').doc(user.uid).get();
      if (!userDoc.exists || !userDoc.data().familiaId) { alert('No tienes acceso'); window.location.href = 'cgi.html'; return; }
      userData = userDoc.data();

      const familiaDoc = await db.collection('familias').doc(userData.familiaId).get();
      if (!familiaDoc.exists) { window.location.href = 'cgi.html'; return; }
      familiaData = { id: familiaDoc.id, ...familiaDoc.data() };

      const isAdmin = userData.rol === 'adminSistema' || familiaData.adminsGenerales?.includes(user.uid) || familiaData.fundador === user.uid || familiaData.creador === user.uid;
      if (!isAdmin) { alert('No tienes permisos de administrador'); window.location.href = 'cgi.html'; return; }

      document.getElementById('estirpe-nombre').textContent = familiaData.nombre || 'Mi Rama';
      await cargarDatos();
    });

    async function cargarDatos() {
      console.log('ğŸ”„ Cargando datos para familia:', familiaData.id);
      
      const nidosSnap = await db.collection('nidos').where('familiaId', '==', familiaData.id).get();
      nidosData = nidosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      console.log('ğŸ“¦ Nidos:', nidosData.length);

      const usuariosSnap = await db.collection('usuarios').where('familiaId', '==', familiaData.id).get();
      usuariosData = usuariosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      console.log('ğŸ‘¤ Usuarios:', usuariosData.length);

      const bienesSnap = await db.collection('bienes').where('familiaId', '==', familiaData.id).get();
      bienesData = bienesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      console.log('ğŸ  Bienes:', bienesData.length);

      // Cargar externos - primero de colecciÃ³n 'externos'
      externosData = [];
      try {
        const externosSnap = await db.collection('externos').where('familiaId', '==', familiaData.id).get();
        externosData = externosSnap.docs.map(d => ({ id: d.id, esNuevo: true, ...d.data() }));
        console.log('ğŸ‘· Externos (colecciÃ³n):', externosData.length);
      } catch (e) {
        console.warn('Error cargando externos:', e);
      }
      
      // TambiÃ©n cargar de subcolecciones legacy (caseros/hosters dentro de cada bien)
      for (const bien of bienesData) {
        try {
          // Caseros legacy
          const caserosSnap = await db.collection('bienes').doc(bien.id).collection('caseros').get();
          caserosSnap.docs.forEach(doc => {
            const data = doc.data();
            if (data.migradoA === 'externos') return; // Ya migrado
            const yaExiste = externosData.some(e => e.email?.toLowerCase() === data.email?.toLowerCase());
            if (!yaExiste && data.email) {
              externosData.push({
                id: doc.id,
                visibleId: `${bien.id}_casero_${doc.id}`,
                esLegacy: true,
                legacyBienId: bien.id,
                tipo: 'casero',
                activo: data.activo !== false,
                bienesAsignados: [{
                  bienId: bien.id,
                  bienNombre: bien.nombre,
                  permisos: data.permisos || {}
                }],
                ...data
              });
            }
          });
          
          // Hosters legacy
          const hostersSnap = await db.collection('bienes').doc(bien.id).collection('hosters').get();
          hostersSnap.docs.forEach(doc => {
            const data = doc.data();
            if (data.migradoA === 'externos') return;
            const yaExiste = externosData.some(e => e.email?.toLowerCase() === data.email?.toLowerCase());
            if (!yaExiste && data.email) {
              externosData.push({
                id: doc.id,
                visibleId: `${bien.id}_hoster_${doc.id}`,
                esLegacy: true,
                legacyBienId: bien.id,
                tipo: 'hoster',
                activo: data.activo !== false,
                bienesAsignados: [{
                  bienId: bien.id,
                  bienNombre: bien.nombre,
                  permisos: data.permisos || {},
                  rol: data.rol
                }],
                ...data
              });
            }
          });
        } catch (e) {
          console.warn('Error cargando legacy de bien', bien.id, e);
        }
      }

      document.getElementById('stat-usuarios').textContent = usuariosData.length;
      document.getElementById('stat-nidos').textContent = nidosData.length;
      document.getElementById('stat-bienes').textContent = bienesData.length;
      document.getElementById('stat-generaciones').textContent = new Set(nidosData.map(n => n.generacion)).size;

      renderUsuarios();
      renderExternos();
      renderMayordomo();
      renderSecciones();
      renderPermisos();
      renderConfigRama();
      await cargarTiposReserva();

      document.getElementById('invitar-nido').innerHTML = '<option value="">Sin asignar</option>' + nidosData.map(n => `<option value="${n.id}">${n.nombre}</option>`).join('');
    }

    function cambiarSeccion(seccion) {
      document.querySelectorAll('.admin-tab').forEach(t => { t.classList.remove('active'); if (t.dataset.section === seccion) t.classList.add('active'); });
      document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
      document.getElementById(`section-${seccion}`).classList.add('active');
    }

    function renderUsuarios() {
      document.getElementById('usuarios-tbody').innerHTML = usuariosData.map(u => {
        const inicial = (u.nombre || u.email || '?').charAt(0).toUpperCase();
        const nido = nidosData.find(n => n.id === u.nidoId);
        const rolClass = u.rol === 'adminSistema' || u.rol === 'adminNido' ? 'admin' : 'miembro';
        return `<tr class="user-row"><td><div class="user-info"><div class="user-avatar">${inicial}</div><div><div class="user-name">${u.nombre || 'Sin nombre'}</div><div class="user-email">${u.email}</div></div></div></td><td>${nido?.nombre || 'â€”'}</td><td><span class="role-badge ${rolClass}">${u.rol || 'miembro'}</span></td><td><button class="btn btn-secondary btn-sm" onclick="editarUsuario('${u.id}')">âœï¸</button></td></tr>`;
      }).join('');
    }

    function editarUsuario(userId) {
      const user = usuariosData.find(u => u.id === userId);
      if (!user) return;
      const nuevoRol = prompt(`Rol actual: ${user.rol || 'miembro'}\n\nNuevo rol (adminSistema, adminNido, adulto, joven):`, user.rol || 'adulto');
      if (!nuevoRol) return;
      db.collection('usuarios').doc(userId).update({ rol: nuevoRol }).then(() => { alert('âœ… Rol actualizado'); cargarDatos(); }).catch(err => alert('Error: ' + err.message));
    }

    // ============ EXTERNOS ============
    function renderExternos(filtroTipo = '') {
      const tbody = document.getElementById('externos-tbody');
      
      // Filtrar por tipo si hay filtro
      let externosFiltrados = externosData;
      if (filtroTipo) {
        externosFiltrados = externosData.filter(e => e.tipo === filtroTipo);
      }
      
      // Actualizar estadÃ­sticas
      const caseros = externosData.filter(e => e.tipo === 'casero');
      const hosters = externosData.filter(e => e.tipo === 'hoster');
      const guardas = externosData.filter(e => e.tipo === 'guarda');
      
      document.getElementById('stat-externos-total').textContent = externosData.length;
      document.getElementById('stat-caseros').textContent = caseros.length;
      document.getElementById('stat-hosters').textContent = hosters.length;
      document.getElementById('stat-guardas').textContent = guardas.length;
      
      if (externosFiltrados.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted);">
          ${externosData.length === 0 ? 'No hay externos registrados. Se crean desde cada bien.' : 'No hay externos de este tipo.'}
        </td></tr>`;
        return;
      }
      
      const tipoIconos = { casero: 'ğŸ ', hoster: 'ğŸ¨', guarda: 'ğŸŒ¾' };
      const tipoLabels = { casero: 'Casero', hoster: 'Hoster', guarda: 'Guarda' };
      
      tbody.innerHTML = externosFiltrados.map(ext => {
        const iniciales = ext.nombre ? ext.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
        const bienes = ext.bienesAsignados || [];
        const extId = ext.visibleId || ext.id;
        
        // Obtener nombres de bienes
        const bienesHtml = bienes.map(b => {
          const bien = bienesData.find(bd => bd.id === b.bienId);
          return `<span class="bien-tag">${bien?.nombre || b.bienNombre || b.bienId}</span>`;
        }).join('');
        
        // Badge de legacy
        const legacyBadge = ext.esLegacy ? '<span style="background:#FCD34D;color:#92400E;padding:1px 6px;border-radius:8px;font-size:0.6rem;margin-left:4px;">legacy</span>' : '';
        
        return `
          <tr class="user-row">
            <td>
              <div class="user-info">
                <div class="user-avatar" style="background:${ext.tipo === 'casero' ? '#8B7355' : ext.tipo === 'hoster' ? '#4A5568' : '#6B8E23'}">${iniciales}</div>
                <div>
                  <div class="user-name">${ext.nombre || 'Sin nombre'}${legacyBadge}</div>
                  <div class="user-email">${ext.email}</div>
                </div>
              </div>
            </td>
            <td><span class="tipo-badge ${ext.tipo}">${tipoIconos[ext.tipo]} ${tipoLabels[ext.tipo]}</span></td>
            <td><div class="bienes-tags">${bienesHtml || '<span style="color:var(--text-muted)">Ninguno</span>'}</div></td>
            <td><span class="estado-badge ${ext.activo ? 'activo' : 'inactivo'}">${ext.activo ? 'Activo' : 'Inactivo'}</span></td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="abrirModalExterno('${extId}')">âœï¸ Editar</button>
              ${ext.activo ? 
                `<button class="btn btn-sm" style="background:#dc3545;color:white;margin-left:4px;" onclick="toggleExterno('${extId}', false)">â¸ï¸</button>` :
                `<button class="btn btn-sm" style="background:#38A169;color:white;margin-left:4px;" onclick="toggleExterno('${extId}', true)">â–¶ï¸</button>`
              }
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function filtrarExternos() {
      const filtro = document.getElementById('filtro-tipo-externo').value;
      renderExternos(filtro);
    }
    
    function abrirModalExterno(externoId) {
      const ext = externosData.find(e => e.id === externoId || e.visibleId === externoId);
      if (!ext) return;
      
      editandoExternoId = ext.visibleId || ext.id;
      
      const tipoIconos = { casero: 'ğŸ ', hoster: 'ğŸ¨', guarda: 'ğŸŒ¾' };
      const tipoLabels = { casero: 'Casero', hoster: 'Hoster', guarda: 'Guarda' };
      
      document.getElementById('modal-externo-titulo').textContent = `${tipoIconos[ext.tipo]} Editar ${tipoLabels[ext.tipo]}`;
      document.getElementById('ext-nombre').value = ext.nombre || '';
      document.getElementById('ext-email').value = ext.email || '';
      document.getElementById('ext-telefono').value = ext.telefono || '';
      document.getElementById('btn-desactivar-externo').textContent = ext.activo ? 'â¸ï¸ Desactivar' : 'â–¶ï¸ Activar';
      
      // Renderizar bienes y permisos
      const bienesContainer = document.getElementById('ext-bienes-permisos');
      const bienes = ext.bienesAsignados || [];
      
      if (bienes.length === 0) {
        bienesContainer.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:16px;">Sin bienes asignados</p>';
      } else {
        // Determinar secciones segÃºn tipo
        let secciones = [];
        if (ext.tipo === 'casero') {
          secciones = ['reservas', 'inventario', 'ajuar', 'mantenimiento', 'limpieza', 'gastos', 'instalaciones', 'documentos'];
        } else if (ext.tipo === 'hoster') {
          secciones = ['reservas', 'habitaciones', 'huespedes', 'tarifas', 'ventas', 'inventario', 'ajuar', 'instalaciones', 'servicios'];
        } else if (ext.tipo === 'guarda') {
          secciones = ['actividad', 'labores', 'aperos', 'parcelas', 'instalaciones', 'inventario', 'incidencias'];
        }
        
        bienesContainer.innerHTML = bienes.map((b, idx) => {
          const bien = bienesData.find(bd => bd.id === b.bienId);
          const permisos = b.permisos || {};
          
          return `
            <div style="background:var(--cream);border-radius:8px;padding:12px;margin-bottom:12px;">
              <div style="font-weight:600;margin-bottom:8px;">${bien?.nombre || b.bienNombre}</div>
              <table style="width:100%;font-size:0.75rem;">
                <tr style="background:var(--cream-dark);">
                  <th style="padding:4px;text-align:left;">MÃ³dulo</th>
                  <th style="padding:4px;text-align:center;">Ver</th>
                  <th style="padding:4px;text-align:center;">Crear</th>
                  <th style="padding:4px;text-align:center;">Editar</th>
                  <th style="padding:4px;text-align:center;">Borrar</th>
                </tr>
                ${secciones.map(sec => {
                  const p = permisos[sec] || {};
                  return `<tr>
                    <td style="padding:4px;">${sec}</td>
                    <td style="text-align:center;"><input type="checkbox" data-bien="${idx}" data-sec="${sec}" data-perm="ver" ${p.ver ? 'checked' : ''}></td>
                    <td style="text-align:center;"><input type="checkbox" data-bien="${idx}" data-sec="${sec}" data-perm="crear" ${p.crear ? 'checked' : ''}></td>
                    <td style="text-align:center;"><input type="checkbox" data-bien="${idx}" data-sec="${sec}" data-perm="editar" ${p.editar ? 'checked' : ''}></td>
                    <td style="text-align:center;"><input type="checkbox" data-bien="${idx}" data-sec="${sec}" data-perm="borrar" ${p.borrar ? 'checked' : ''}></td>
                  </tr>`;
                }).join('')}
              </table>
            </div>
          `;
        }).join('');
      }
      
      document.getElementById('modal-externo').classList.add('active');
    }
    
    async function guardarExterno() {
      if (!editandoExternoId) return;
      
      const ext = externosData.find(e => e.id === editandoExternoId || e.visibleId === editandoExternoId);
      if (!ext) return;
      
      try {
        const nombre = document.getElementById('ext-nombre').value.trim();
        const telefono = document.getElementById('ext-telefono').value.trim();
        
        // Recoger permisos de la tabla
        const bienesAsignados = [...(ext.bienesAsignados || [])];
        
        document.querySelectorAll('#ext-bienes-permisos input[type="checkbox"]').forEach(cb => {
          const bienIdx = parseInt(cb.dataset.bien);
          const sec = cb.dataset.sec;
          const perm = cb.dataset.perm;
          
          if (!bienesAsignados[bienIdx].permisos) bienesAsignados[bienIdx].permisos = {};
          if (!bienesAsignados[bienIdx].permisos[sec]) bienesAsignados[bienIdx].permisos[sec] = {};
          bienesAsignados[bienIdx].permisos[sec][perm] = cb.checked;
        });
        
        if (ext.esLegacy) {
          // Guardar en legacy Y migrar a externos
          const legacyPath = ext.tipo === 'casero' ? 'caseros' : 'hosters';
          
          // Actualizar en legacy
          await db.collection('bienes').doc(ext.legacyBienId).collection(legacyPath).doc(ext.id).update({
            nombre,
            telefono,
            permisos: bienesAsignados[0]?.permisos || {}
          });
          
          // TambiÃ©n crear/actualizar en externos para migraciÃ³n gradual
          const existeEnExternos = await db.collection('externos').where('email', '==', ext.email).limit(1).get();
          if (existeEnExternos.empty) {
            await db.collection('externos').add({
              email: ext.email,
              nombre,
              telefono,
              tipo: ext.tipo,
              activo: ext.activo !== false,
              bienesAsignados,
              familiaId: familiaData.id,
              creadoPor: currentUser.uid,
              fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
              fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp(),
              migradoDesde: 'legacy-' + legacyPath
            });
            
            // Marcar legacy como migrado
            await db.collection('bienes').doc(ext.legacyBienId).collection(legacyPath).doc(ext.id).update({
              migradoA: 'externos',
              fechaMigracion: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        } else {
          // Guardar en colecciÃ³n externos
          await db.collection('externos').doc(ext.id).update({
            nombre,
            telefono,
            bienesAsignados,
            fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        cerrarModal('modal-externo');
        await cargarDatos(); // Recargar todo
        alert('âœ… Externo actualizado' + (ext.esLegacy ? ' y migrado a nueva estructura' : ''));
      } catch (error) {
        console.error(error);
        alert('Error al guardar: ' + error.message);
      }
    }
    
    async function desactivarExterno() {
      if (!editandoExternoId) return;
      
      const ext = externosData.find(e => e.id === editandoExternoId || e.visibleId === editandoExternoId);
      if (!ext) return;
      
      const nuevoEstado = !ext.activo;
      
      if (!confirm(`Â¿${nuevoEstado ? 'Activar' : 'Desactivar'} este externo?`)) return;
      
      try {
        if (ext.esLegacy) {
          const legacyPath = ext.tipo === 'casero' ? 'caseros' : 'hosters';
          await db.collection('bienes').doc(ext.legacyBienId).collection(legacyPath).doc(ext.id).update({
            activo: nuevoEstado
          });
        } else {
          await db.collection('externos').doc(ext.id).update({
            activo: nuevoEstado,
            fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        cerrarModal('modal-externo');
        await cargarDatos();
        alert(`âœ… Externo ${nuevoEstado ? 'activado' : 'desactivado'}`);
      } catch (error) {
        console.error(error);
        alert('Error: ' + error.message);
      }
    }
    
    async function toggleExterno(externoId, activar) {
      if (!confirm(`Â¿${activar ? 'Activar' : 'Desactivar'} este externo?`)) return;
      
      const ext = externosData.find(e => e.id === externoId || e.visibleId === externoId);
      if (!ext) return;
      
      try {
        if (ext.esLegacy) {
          const legacyPath = ext.tipo === 'casero' ? 'caseros' : 'hosters';
          await db.collection('bienes').doc(ext.legacyBienId).collection(legacyPath).doc(ext.id).update({
            activo: activar
          });
        } else {
          await db.collection('externos').doc(ext.id).update({
            activo: activar,
            fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        await cargarDatos();
        alert(`âœ… Externo ${activar ? 'activado' : 'desactivado'}`);
      } catch (error) {
        console.error(error);
        alert('Error al actualizar');
      }
    }

    // ============ MAYORDOMO ============
    const tipoIconos = {
      'inmueble': 'ğŸ ', 'vehiculo': 'ğŸš—', 'electrodomestico': 'ğŸ“º',
      'mueble': 'ğŸ›‹ï¸', 'otro': 'ğŸ“¦'
    };

    // ============ GESTIONES (Mayordomo, Gerente, Capataz) ============
    function cambiarGestion(gestion) {
      document.querySelectorAll('.gestion-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.gestion-tab[data-gestion="${gestion}"]`).classList.add('active');
      
      document.querySelectorAll('.gestion-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`panel-${gestion}`).classList.add('active');
    }
    
    function renderGestiones() {
      // Llenar selectores de bienes para cada gestiÃ³n
      const bienesOptions = '<option value="">-- Selecciona un bien --</option>' + 
        bienesData.map(b => `<option value="${b.id}">${tipoIconos[b.tipo] || 'ğŸ“¦'} ${b.nombre}</option>`).join('');
      
      document.getElementById('select-bien-mayordomo').innerHTML = bienesOptions;
      document.getElementById('select-bien-gerente').innerHTML = bienesOptions;
      document.getElementById('select-bien-capataz').innerHTML = bienesOptions;
      
      // Resumen de bienes con todas las gestiones
      const resumen = document.getElementById('bienes-resumen');
      if (bienesData.length === 0) {
        resumen.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No hay bienes registrados. CrÃ©alos en "Lo ComÃºn".</p>';
        return;
      }
      
      resumen.innerHTML = bienesData.map(b => {
        const badges = [];
        if (b.mayordomoActivo) badges.push('<span style="background:#8B7355;color:white;padding:2px 8px;border-radius:12px;font-size:0.7rem;">ğŸ© Mayordomo</span>');
        if (b.gerenteActivo) badges.push('<span style="background:#4A5568;color:white;padding:2px 8px;border-radius:12px;font-size:0.7rem;">ğŸ¨ Gerente</span>');
        if (b.capatazActivo) badges.push('<span style="background:#6B8E23;color:white;padding:2px 8px;border-radius:12px;font-size:0.7rem;">ğŸŒ¾ Capataz</span>');
        
        return `
          <div class="bien-resumen-item">
            <div class="bien-resumen-info">
              <span>${tipoIconos[b.tipo] || 'ğŸ“¦'}</span>
              <span class="bien-resumen-nombre">${b.nombre}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
              ${badges.length > 0 ? badges.join('') : '<span style="color:var(--text-muted);font-size:0.75rem;">Sin gestiones</span>'}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function cargarConfigBien(gestion) {
      const bienId = document.getElementById(`select-bien-${gestion}`).value;
      const container = document.getElementById(`config-${gestion}-container`);
      const submodulosDiv = document.getElementById(`submodulos-${gestion}`);
      
      if (!bienId) {
        container.classList.add('hidden');
        bienSeleccionadoGestion[gestion] = null;
        return;
      }
      
      const bien = bienesData.find(b => b.id === bienId);
      if (!bien) return;
      
      bienSeleccionadoGestion[gestion] = bien;
      container.classList.remove('hidden');
      
      // Info del bien
      document.getElementById(`bien-icono-${gestion}`).textContent = tipoIconos[bien.tipo] || 'ğŸ“¦';
      document.getElementById(`bien-nombre-${gestion}`).textContent = bien.nombre;
      document.getElementById(`bien-tipo-${gestion}`).textContent = bien.subtipo || bien.tipo;
      
      // Estado de la gestiÃ³n
      const campoActivo = `${gestion}Activo`;
      const campoModulos = `${gestion}Modulos`;
      
      const toggle = document.getElementById(`toggle-${gestion}-activo`);
      toggle.checked = bien[campoActivo] || false;
      document.getElementById(`${gestion}-estado`).textContent = toggle.checked ? 'Activado' : 'Desactivado';
      
      // Color del toggle segÃºn gestiÃ³n
      const slider = toggle.nextElementSibling;
      if (toggle.checked) {
        slider.classList.add(gestion);
      } else {
        slider.classList.remove(gestion);
      }
      
      // Mostrar/ocultar submÃ³dulos
      if (toggle.checked) {
        submodulosDiv.classList.remove('hidden');
        cargarSubmodulosGestion(gestion, bien[campoModulos] || {});
      } else {
        submodulosDiv.classList.add('hidden');
      }
    }
    
    function cargarSubmodulosGestion(gestion, modulos) {
      const prefijos = { mayordomo: 'may', gerente: 'ger', capataz: 'cap' };
      const prefix = prefijos[gestion];
      
      const modulosPorGestion = {
        mayordomo: ['reservas', 'inventario', 'gastos', 'mantenimiento', 'limpieza', 'instalaciones'],
        gerente: ['reservas', 'habitaciones', 'huespedes', 'tarifas', 'facturacion', 'instalaciones'],
        capataz: ['actividad', 'labores', 'aperos', 'parcelas', 'instalaciones', 'inventario', 'incidencias']
      };
      
      modulosPorGestion[gestion].forEach(mod => {
        const cb = document.getElementById(`mod-${prefix}-${mod}`);
        if (cb) cb.checked = modulos[mod] || false;
      });
    }
    
    async function toggleGestionBien(gestion) {
      const bien = bienSeleccionadoGestion[gestion];
      if (!bien) return;
      
      const toggle = document.getElementById(`toggle-${gestion}-activo`);
      const activo = toggle.checked;
      const slider = toggle.nextElementSibling;
      
      document.getElementById(`${gestion}-estado`).textContent = activo ? 'Activado' : 'Desactivado';
      
      // Color del toggle
      if (activo) {
        slider.classList.add(gestion);
      } else {
        slider.classList.remove(gestion);
      }
      
      const submodulosDiv = document.getElementById(`submodulos-${gestion}`);
      if (activo) {
        submodulosDiv.classList.remove('hidden');
        const campoModulos = `${gestion}Modulos`;
        cargarSubmodulosGestion(gestion, bien[campoModulos] || {});
      } else {
        submodulosDiv.classList.add('hidden');
      }
      
      try {
        const campoActivo = `${gestion}Activo`;
        await db.collection('bienes').doc(bien.id).update({
          [campoActivo]: activo
        });
        bien[campoActivo] = activo;
        renderGestiones();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar');
      }
    }
    
    async function guardarSubmodulosGestion(gestion) {
      const bien = bienSeleccionadoGestion[gestion];
      if (!bien) return;
      
      const prefijos = { mayordomo: 'may', gerente: 'ger', capataz: 'cap' };
      const prefix = prefijos[gestion];
      
      const modulosPorGestion = {
        mayordomo: ['reservas', 'inventario', 'gastos', 'mantenimiento', 'limpieza', 'instalaciones'],
        gerente: ['reservas', 'habitaciones', 'huespedes', 'tarifas', 'facturacion', 'instalaciones'],
        capataz: ['actividad', 'labores', 'aperos', 'parcelas', 'instalaciones', 'inventario', 'incidencias']
      };
      
      const modulos = {};
      modulosPorGestion[gestion].forEach(mod => {
        const cb = document.getElementById(`mod-${prefix}-${mod}`);
        if (cb) modulos[mod] = cb.checked;
      });
      
      try {
        const campoModulos = `${gestion}Modulos`;
        await db.collection('bienes').doc(bien.id).update({
          [campoModulos]: modulos
        });
        bien[campoModulos] = modulos;
        renderGestiones();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar submÃ³dulos');
      }
    }
    
    // Alias para compatibilidad
    function renderMayordomo() { renderGestiones(); }

    function renderSecciones() {
      const config = familiaData.seccionesActivas || {};
      document.getElementById('secciones-grid').innerHTML = seccionesDisponibles.map(sec => `<div class="config-item"><div class="config-item-info"><span class="config-item-icon">${sec.icono}</span><div><div class="config-item-name">${sec.nombre}</div><div class="config-item-desc">${sec.desc}</div></div></div><label class="toggle-switch"><input type="checkbox" ${config[sec.id] !== false ? 'checked' : ''} onchange="toggleSeccion('${sec.id}', this.checked)"><span class="toggle-slider"></span></label></div>`).join('');

      const cerebroConfig = familiaData.cerebroModulos || {};
      document.getElementById('cerebro-modulos-grid').innerHTML = cerebroModulos.map(mod => `<div class="config-item"><div class="config-item-info"><span class="config-item-icon">${mod.icono}</span><div><div class="config-item-name">${mod.nombre}</div><div class="config-item-desc">${mod.desc}</div></div></div><label class="toggle-switch"><input type="checkbox" ${cerebroConfig[mod.id] !== false ? 'checked' : ''} onchange="toggleCerebroModulo('${mod.id}', this.checked)"><span class="toggle-slider"></span></label></div>`).join('');
    }

    async function toggleSeccion(id, activo) {
      await db.collection('familias').doc(familiaData.id).update({ [`seccionesActivas.${id}`]: activo });
      if (!familiaData.seccionesActivas) familiaData.seccionesActivas = {};
      familiaData.seccionesActivas[id] = activo;
    }

    async function toggleCerebroModulo(id, activo) {
      await db.collection('familias').doc(familiaData.id).update({ [`cerebroModulos.${id}`]: activo });
      if (!familiaData.cerebroModulos) familiaData.cerebroModulos = {};
      familiaData.cerebroModulos[id] = activo;
    }

    function renderPermisos() {
      const permisos = familiaData.permisos || permisosBase;
      document.getElementById('permisos-tbody').innerHTML = permisos.map((p, idx) => `<tr><td><strong>${p.seccion}</strong></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="adminSistema" ${p.permisos.adminSistema ? 'checked' : ''} disabled></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="adminNido" ${p.permisos.adminNido ? 'checked' : ''}></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="adulto" ${p.permisos.adulto ? 'checked' : ''}></td><td><input type="checkbox" class="permiso-check" data-idx="${idx}" data-rol="joven" ${p.permisos.joven ? 'checked' : ''}></td></tr>`).join('');
    }

    async function guardarPermisos() {
      const checks = document.querySelectorAll('.permiso-check');
      const permisos = [...permisosBase];
      checks.forEach(c => { permisos[parseInt(c.dataset.idx)].permisos[c.dataset.rol] = c.checked; });
      await db.collection('familias').doc(familiaData.id).update({ permisos });
      alert('âœ… Permisos guardados');
    }

    const generacionesLabels = {
      1: 'Pentabuelos',
      2: 'Tatarabuelos', 
      3: 'Bisabuelos',
      4: 'Abuelos',
      5: 'Padres',
      6: 'Hijos',
      7: 'Nietos',
      8: 'Bisnietos'
    };

    function getGeneracionesParaConfig(num) {
      // Con 4 generaciones: Bisabuelos (3), Abuelos (4), Padres (5), Hijos (6)
      // Con 6 generaciones: Tatarabuelos (2), Bisabuelos (3), Abuelos (4), Padres (5), Hijos (6), Nietos (7)
      // Con 8 generaciones: Pentabuelos (1), Tatarabuelos (2), Bisabuelos (3), Abuelos (4), Padres (5), Hijos (6), Nietos (7), Bisnietos (8)
      const configs = {
        4: [3, 4, 5, 6],
        6: [2, 3, 4, 5, 6, 7],
        8: [1, 2, 3, 4, 5, 6, 7, 8]
      };
      return configs[num] || configs[4];
    }

    function actualizarGeneraciones() {
      const num = parseInt(document.getElementById('config-generaciones').value);
      const gens = getGeneracionesParaConfig(num);
      
      let html = '<strong>Generaciones disponibles:</strong><br>';
      html += gens.map((g, i) => `Gen ${i + 1}: ${generacionesLabels[g]}`).join(' â†’ ');
      
      document.getElementById('generaciones-preview').innerHTML = html;
    }

    function renderConfigRama() {
      document.getElementById('config-nombre').value = familiaData.nombre || '';
      document.getElementById('config-descripcion').value = familiaData.descripcion || '';
      document.getElementById('config-lema').value = familiaData.lema || '';
      document.getElementById('config-generaciones').value = familiaData.numGeneraciones || 4;
      actualizarGeneraciones();
    }

    async function guardarConfigRama() {
      const nombre = document.getElementById('config-nombre').value.trim();
      const descripcion = document.getElementById('config-descripcion').value.trim();
      const lema = document.getElementById('config-lema').value.trim();
      const numGeneraciones = parseInt(document.getElementById('config-generaciones').value);
      
      if (!nombre) { alert('El nombre es obligatorio'); return; }
      
      await db.collection('familias').doc(familiaData.id).update({ 
        nombre, 
        descripcion, 
        lema,
        numGeneraciones 
      });
      
      familiaData.nombre = nombre;
      familiaData.numGeneraciones = numGeneraciones;
      document.getElementById('estirpe-nombre').textContent = nombre;
      alert('âœ… ConfiguraciÃ³n guardada');
    }

    function abrirModalInvitar() { document.getElementById('modal-invitar').classList.add('active'); }
    function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }

    async function enviarInvitacion() {
      const email = document.getElementById('invitar-email').value.trim();
      const nidoId = document.getElementById('invitar-nido').value;
      const rol = document.getElementById('invitar-rol').value;
      if (!email) { alert('Introduce un email'); return; }
      await db.collection('invitaciones').add({ email, familiaId: familiaData.id, nidoId: nidoId || null, rol, invitadoPor: currentUser.uid, fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(), estado: 'pendiente' });
      alert(`âœ… InvitaciÃ³n enviada a ${email}`);
      cerrarModal('modal-invitar');
      document.getElementById('invitar-email').value = '';
    }

    function exportarDatos() { alert('PrÃ³ximamente: Exportar todos los datos de la estirpe'); }

    // ============ TIPOS DE RESERVA ============
    async function cargarTiposReserva() {
      try {
        const snap = await db.collection('familias').doc(familiaData.id).collection('tiposReserva').orderBy('orden', 'asc').get();
        tiposReservaData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Si no hay tipos, crear los por defecto
        if (tiposReservaData.length === 0) {
          await crearTiposPorDefecto();
        }
        
        renderTiposReserva();
      } catch (error) {
        console.error('Error cargando tipos de reserva:', error);
      }
    }

    async function crearTiposPorDefecto() {
      const tiposPorDefecto = [
        { id: 'toda-familia', nombre: 'Toda la familia', emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', color: '#7A9E7E', orden: 1 },
        { id: 'gq-h', nombre: 'Familia GQ-H', emoji: '', color: '#C17757', orden: 2 },
        { id: 'gq-b', nombre: 'Familia GQ-B', emoji: '', color: '#6B8E9F', orden: 3 },
        { id: 'g-gq', nombre: 'Familia G-GQ', emoji: '', color: '#E8A0B5', orden: 4 },
        { id: 'gq-gc', nombre: 'Familia GQ-GC', emoji: '', color: '#D4A574', orden: 5 },
        { id: 'gq-n', nombre: 'Familia GQ-N', emoji: '', color: '#7EAAA6', orden: 6 },
        { id: 'mama', nombre: 'MamÃ¡', emoji: 'ğŸ‘©', color: '#9B7EB8', orden: 7 },
        { id: 'cazadores', nombre: 'Cazadores', emoji: 'ğŸ¦Œ', color: '#8B7355', orden: 8 },
        { id: 'otros', nombre: 'Otros', emoji: 'ğŸ“‹', color: '#9A9A9A', orden: 9 }
      ];

      const batch = db.batch();
      tiposPorDefecto.forEach(tipo => {
        const ref = db.collection('familias').doc(familiaData.id).collection('tiposReserva').doc(tipo.id);
        batch.set(ref, { nombre: tipo.nombre, emoji: tipo.emoji, color: tipo.color, orden: tipo.orden });
      });
      await batch.commit();
      
      tiposReservaData = tiposPorDefecto;
    }

    function renderTiposReserva() {
      const container = document.getElementById('tipos-reserva-list');
      const preview = document.getElementById('preview-colores');
      
      if (tiposReservaData.length === 0) {
        container.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;">No hay tipos de reserva configurados</p>';
        preview.innerHTML = '';
        return;
      }

      container.innerHTML = tiposReservaData.map(tipo => `
        <div class="tipo-reserva-item">
          <div class="tipo-reserva-color" style="background:${tipo.color}"></div>
          <div class="tipo-reserva-info">
            <div class="tipo-reserva-nombre">${tipo.emoji ? tipo.emoji + ' ' : ''}${tipo.nombre}</div>
            <div class="tipo-reserva-id">ID: ${tipo.id}</div>
          </div>
          <div class="tipo-reserva-actions">
            <button class="btn btn-secondary btn-sm" onclick="editarTipoReserva('${tipo.id}')">âœï¸</button>
          </div>
        </div>
      `).join('');

      preview.innerHTML = tiposReservaData.map(tipo => `
        <div class="preview-item">
          <div class="preview-color" style="background:${tipo.color}"></div>
          <span>${tipo.emoji ? tipo.emoji + ' ' : ''}${tipo.nombre}</span>
        </div>
      `).join('');
    }

    function abrirModalTipoReserva() {
      editandoTipoId = null;
      document.getElementById('modal-tipo-titulo').textContent = 'â• Nuevo tipo de reserva';
      document.getElementById('tipo-nombre').value = '';
      document.getElementById('tipo-emoji').value = '';
      document.getElementById('tipo-color').value = '#7A9E7E';
      document.getElementById('btn-eliminar-tipo').classList.add('hidden');
      
      // Reset color selection
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelector('.color-option[data-color="#7A9E7E"]').classList.add('selected');
      
      document.getElementById('modal-tipo-reserva').classList.add('active');
    }

    function editarTipoReserva(id) {
      const tipo = tiposReservaData.find(t => t.id === id);
      if (!tipo) return;

      editandoTipoId = id;
      document.getElementById('modal-tipo-titulo').textContent = 'âœï¸ Editar tipo de reserva';
      document.getElementById('tipo-nombre').value = tipo.nombre;
      document.getElementById('tipo-emoji').value = tipo.emoji || '';
      document.getElementById('tipo-color').value = tipo.color;
      document.getElementById('btn-eliminar-tipo').classList.remove('hidden');
      
      // Set color selection
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.color === tipo.color);
      });
      
      document.getElementById('modal-tipo-reserva').classList.add('active');
    }

    function seleccionarColor(color) {
      document.getElementById('tipo-color').value = color;
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.color === color);
      });
    }

    async function guardarTipoReserva() {
      const nombre = document.getElementById('tipo-nombre').value.trim();
      const emoji = document.getElementById('tipo-emoji').value.trim();
      const color = document.getElementById('tipo-color').value;

      if (!nombre) { alert('El nombre es obligatorio'); return; }

      try {
        const data = { nombre, emoji, color };
        
        if (editandoTipoId) {
          await db.collection('familias').doc(familiaData.id).collection('tiposReserva').doc(editandoTipoId).update(data);
        } else {
          // Generar ID desde el nombre
          const id = nombre.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
          
          data.orden = tiposReservaData.length + 1;
          await db.collection('familias').doc(familiaData.id).collection('tiposReserva').doc(id).set(data);
        }

        cerrarModal('modal-tipo-reserva');
        await cargarTiposReserva();
        alert('âœ… Tipo de reserva guardado');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar');
      }
    }

    async function eliminarTipoReserva() {
      if (!editandoTipoId) return;
      if (!confirm('Â¿Eliminar este tipo de reserva?')) return;

      try {
        await db.collection('familias').doc(familiaData.id).collection('tiposReserva').doc(editandoTipoId).delete();
        cerrarModal('modal-tipo-reserva');
        await cargarTiposReserva();
        alert('âœ… Tipo eliminado');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar');
      }
    }
  </script>
</body>
</html>
